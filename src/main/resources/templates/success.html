<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thanh toán thành công</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    window.onload = async function () {
      const pending = sessionStorage.getItem("pendingOrder");
      if (!pending) {
        document.getElementById("orderCode").textContent = "Không tìm thấy đơn hàng.";
        return;
      }

      const { orderData, tabId } = JSON.parse(pending);

      // Đảm bảo soTienKhachDua là 0 nếu thanh toán chuyển khoản
      if (orderData.phuongThucThanhToan === '550E8400-E29B-41D4-A716-446655440018') {
        orderData.soTienKhachDua = 0;
      }

      console.log('orderData before sending to /create-order:', JSON.stringify(orderData, null, 2));

      try {
        const res = await fetch("http://localhost:8080/acvstore/ban-hang/create-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(orderData)
        });

        const result = await res.json();
        if (!res.ok) {
          document.getElementById("orderCode").textContent = "Lỗi khi tạo đơn hàng!";
          console.error("❌ Lỗi khi tạo đơn hàng:", result.error);
          return;
        }

        document.getElementById("orderCode").textContent = result.maDonHang;
        sessionStorage.removeItem("pendingOrder");

        // Xóa tab đã thanh toán
        let tabs = JSON.parse(localStorage.getItem('orderTabs') || '[]');
        console.log('Tabs before filtering:', JSON.stringify(tabs, null, 2));
        tabs = tabs.filter(t => String(t.id) !== String(tabId));

        // Nếu không còn tab nào, tạo lại tab mặc định Đơn 1
        if (tabs.length === 0) {
          const newTabId = 1;
          const newTab = {
            id: newTabId,
            tenTab: "Đơn 1",
            sanPhams: [],
            subTotal: 0,
            discount: 0,
            shippingFee: 0,
            total: 0,
            voucherId: null,
            phieuGiamGia: null,
            soTienKhachDua: 0,
            tienThua: 0,
            khachHangDaChon: null,
            phuongThucThanhToan: "550e8400-e29b-41d4-a716-446655440017",
            customerPhone: '',
            customerName: '',
            customerEmail: '',
            saleMethod: 'Tại quầy',
            cart: [],
            addresses: [],
            selectedAddress: ''
          };
          tabs.push(newTab);
          localStorage.setItem('currentTabId', newTabId);
          console.log('New tab created:', JSON.stringify(newTab, null, 2));
        }

        localStorage.setItem('orderTabs', JSON.stringify(tabs));
        console.log('Tabs saved to localStorage:', JSON.stringify(tabs, null, 2));

        // Chuyển hướng sau 2 giây
        setTimeout(() => {
          window.location.href = "/acvstore/ban-hang";
        }, 2000);

      } catch (err) {
        document.getElementById("orderCode").textContent = "Gặp lỗi khi xử lý!";
        console.error("❌ Gọi API thất bại:", err);
      }
    };
  </script>
  <style>
    body {
      text-align: center;
      margin-top: 100px;
      font-family: sans-serif;
      background-color: #f9fafb;
    }
    .success-box {
      background: white;
      display: inline-block;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
    }
    .success-title {
      color: green;
      font-size: 24px;
      font-weight: bold;
    }
    .btn {
      padding: 10px 20px;
      background-color: #4f46e5;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      display: inline-block;
      margin-top: 20px;
    }
    .btn:hover {
      background-color: #4338ca;
    }
  </style>
</head>
<body>
<div class="success-box">
  <h2 class="success-title">✅ Thanh toán thành công!</h2>
  <p>Mã đơn hàng: <strong id="orderCode">Đang xử lý...</strong></p>
  <p>Đang quay lại trang bán hàng...</p>
  <a href="/acvstore/ban-hang" class="btn">Quay lại ngay</a>
</div>
</body>
</html>