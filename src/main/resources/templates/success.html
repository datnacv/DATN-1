<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thanh to√°n th√†nh c√¥ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    window.onload = async function () {
      const pending = sessionStorage.getItem("pendingOrder");
      if (!pending) {
        document.getElementById("orderCode").textContent = "Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng.";
        return;
      }

      const { orderData, tabId } = JSON.parse(pending);

      try {
        const res = await fetch("http://localhost:8080/acvstore/ban-hang/create-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(orderData)
        });

        const result = await res.json();
        if (!res.ok) {
          document.getElementById("orderCode").textContent = "L·ªói khi t·∫°o ƒë∆°n h√†ng!";
          console.error("‚ùå L·ªói khi t·∫°o ƒë∆°n h√†ng:", result.error);
          return;
        }

        document.getElementById("orderCode").textContent = result.maDonHang;
        sessionStorage.removeItem("pendingOrder");

        // üëâ Xo√° tab ƒë√£ thanh to√°n
        let tabs = JSON.parse(localStorage.getItem('orderTabs') || '[]');
        tabs = tabs.filter(t => String(t.id) !== String(tabId));

        // üëâ N·∫øu kh√¥ng c√≤n tab n√†o, t·∫°o l·∫°i tab m·∫∑c ƒë·ªãnh ƒê∆°n 1
        if (tabs.length === 0) {
          const newTab = {
            id: 1,
            tenTab: "ƒê∆°n 1",
            sanPhams: [],
            subTotal: 0,
            discount: 0,
            shippingFee: 0,
            total: 0,
            voucherId: null,
            phieuGiamGia: null,
            soTienKhachDua: 0,
            tienThua: 0,
            khachHangDaChon: null,
            phuongThucThanhToan: null,
            customerPhone: '',
            customerName: '',
            customerEmail: '',
            saleMethod: 'T·∫°i qu·∫ßy',
            cart: [],
            addresses: [],
            selectedAddress: ''
          };
          tabs.push(newTab);
          localStorage.setItem('currentTabId', 1);
        }

        localStorage.setItem('orderTabs', JSON.stringify(tabs));

        // ‚è≥ Chuy·ªÉn h∆∞·ªõng sau 2 gi√¢y
        setTimeout(() => {
          window.location.href = "/acvstore/ban-hang";
        }, 2000);

      } catch (err) {
        document.getElementById("orderCode").textContent = "G·∫∑p l·ªói khi x·ª≠ l√Ω!";
        console.error("‚ùå G·ªçi API th·∫•t b·∫°i:", err);
      }
    };
  </script>
  <style>
    body {
      text-align: center;
      margin-top: 100px;
      font-family: sans-serif;
      background-color: #f9fafb;
    }

    .success-box {
      background: white;
      display: inline-block;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
    }

    .success-title {
      color: green;
      font-size: 24px;
      font-weight: bold;
    }

    .btn {
      padding: 10px 20px;
      background-color: #4f46e5;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      display: inline-block;
      margin-top: 20px;
    }

    .btn:hover {
      background-color: #4338ca;
    }
  </style>
</head>
<body>
<div class="success-box">
  <h2 class="success-title">‚úÖ Thanh to√°n th√†nh c√¥ng!</h2>
  <p>M√£ ƒë∆°n h√†ng: <strong id="orderCode">ƒêang x·ª≠ l√Ω...</strong></p>
  <p>ƒêang quay l·∫°i trang b√°n h√†ng...</p>
  <a href="/acvstore/ban-hang" class="btn">Quay l·∫°i ngay</a>
</div>
</body>
</html>
