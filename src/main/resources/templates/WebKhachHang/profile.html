<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACV Store - H·ªì s∆° c√° nh√¢n</title>
  <meta name="_csrf" th:content="${_csrf?.token}"/>
  <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
  <style>
    /* Enhanced navbar */
    .navbar {
      background: linear-gradient(135deg, #153054 0%, #1e4066 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .navbar { position: fixed; top: 40px; left: 0; width: 100%; z-index: 1040; }

    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .search-suggestions.active {
      opacity: 1;
      visibility: visible;
    }
    .suggestion-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    .suggestion-item:hover {
      background-color: #f1f5f9;
    }
    .suggestion-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      margin-right: 10px;
      border-radius: 4px;
    }
    .history-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
      background-color: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .history-item:hover {
      background-color: #e2e8f0;
    }
    .history-item .highlight {
      background-color: #9FD5F7;
      padding: 2px 4px;
      border-radius: 4px;
    }
    .history-item .delete-btn {
      color: #ef4444;
      font-size: 14px;
      cursor: pointer;
      padding: 5px;
      transition: color 0.2s;
    }
    .history-item .delete-btn:hover {
      color: #b91c1c;
    }

    /* Enhanced dropdown */
    .dropdown-menu {
      display: none;
      position: absolute;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      min-width: 200px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      z-index: 1000;
      padding: 8px;
    }

    .dropdown:hover .dropdown-menu {
      display: block;
      animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown-menu a {
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .dropdown-menu a:hover {
      background: linear-gradient(135deg, #e0ebf5 0%, #f1f8ff 100%);
      transform: translateX(4px);
    }

    /* Enhanced search bar */
    .search-container input {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .search-container input:focus {
      border-color: #9FD5F7;
      box-shadow: 0 0 0 4px rgba(159, 213, 247, 0.2);
    }

    /* Enhanced page title */
    .page-title {
      background: linear-gradient(135deg, #153054 0%, #1e4066 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
      letter-spacing: -0.02em;
      margin-bottom: 2rem;
    }

    /* Enhanced tabs */
    .nav-tabs {
      border: none;
      background: white;
      border-radius: 16px;
      padding: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 2rem;
      overflow-x: auto;
      white-space: nowrap;
    }

    .nav-tabs .nav-item {
      margin: 0 4px;
    }

    .nav-tabs .nav-link {
      color: #64748b;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-tabs .nav-link:hover {
      color: #153054;
      background: rgba(159, 213, 247, 0.1);
      transform: translateY(-2px);
    }

    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #153054 0%, #1e4066 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(21, 48, 84, 0.3);
      transform: translateY(-2px);
    }

    .nav-tabs .nav-link.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
      pointer-events: none;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding-top: 118px;
      line-height: 1.6;
    }
    .page-title { font-size: 1.8rem; font-weight: 700; color: #153054; margin-bottom: 20px; }
    .card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .form-label { font-weight: 600; }
    .form-control, .form-select {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.95rem;
    }
    .ticker { background-color: #9FD5F7; color: #153054; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1050; }
    .form-control:focus, .form-select:focus {
      border-color: #153054;
      box-shadow: 0 0 0 3px rgba(21, 48, 84, 0.1);
    }
    .btn-primary { background-color: #153054; border: none; }
    .btn-primary:hover { background-color: #1e4066; }
    .btn-secondary { background-color: #e2e6ea; border: none; color: #153054; }
    .btn-secondary:hover { background-color: #d6dade; }
    .btn-success { background-color: #28a745; border: none; }
    .btn-success:hover { background-color: #218838; }
    .address-cell { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .avatar { width: 80px; height: 80px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #888; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
  </style>
</head>
<body>

<div class="ticker py-2 overflow-hidden fixed top-0 w-full z-50">
  <marquee behavior="scroll" direction="left" scrollamount="5">
    üéâ Khuy·∫øn m√£i ƒë·∫∑c bi·ªát: Gi·∫£m gi√° l√™n ƒë·∫øn 50% cho t·∫•t c·∫£ s·∫£n ph·∫©m h√¥m nay! üéâ - Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n t·ª´ 500k!
  </marquee>
</div>

<div th:replace="~{fragments/kh_navbar :: navbar(user=${user}, keyword=${keyword}, cartCount=${cartCount})}"></div>

<!-- Toast Container -->
<div class="toast-container"></div>

<div class="container py-5">
  <h1 class="page-title"><i class="fas fa-user-circle me-2"></i> H·ªì s∆° c√° nh√¢n</h1>

  <!-- Alert t·ª´ backend -->
  <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <!-- Th√¥ng tin c√° nh√¢n -->
  <div class="card mb-4">
    <div class="card-header fw-bold"><i class="fas fa-id-card me-1"></i> Th√¥ng tin c√° nh√¢n</div>
    <div class="card-body">
      <div class="d-flex align-items-center mb-4">
        <div class="avatar me-3"><i class="fas fa-user"></i></div>
        <div>
          <div class="fw-bold" th:text="${user.hoTen}">Nguy·ªÖn VƒÉn A</div>
          <small class="text-muted" th:text="${user.email}">example@email.com</small>
        </div>
      </div>

      <!-- Form c·∫≠p nh·∫≠t th√¥ng tin -->
      <form id="profileForm" th:action="@{/profile}" method="post">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">H·ªç t√™n</label>
            <input type="text" class="form-control" name="hoTen" th:value="${user.hoTen}" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" th:value="${user.email}" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="text" class="form-control" name="soDienThoai" th:value="${user.soDienThoai}" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
            <input type="password" class="form-control" name="matKhau" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi">
          </div>
        </div>
        <button type="submit" class="btn btn-primary" id="updateProfileBtn"><i class="fas fa-save me-1"></i> C·∫≠p nh·∫≠t</button>
      </form>

      <!-- Form x√≥a t√†i kho·∫£n -->
      <form th:action="@{/profile/delete}" method="post" class="mt-3"
            onsubmit="return confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n n√†y?')">
        <button type="submit" class="btn btn-danger"><i class="fas fa-trash me-1"></i> X√≥a t√†i kho·∫£n</button>
      </form>
    </div>
  </div>

  <!-- Danh s√°ch ƒë·ªãa ch·ªâ -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold"><i class="fas fa-map-marker-alt me-1"></i> ƒê·ªãa ch·ªâ c·ªßa t√¥i</span>
      <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">
        <i class="fas fa-plus me-1"></i> Th√™m ƒë·ªãa ch·ªâ
      </button>
    </div>
    <div class="card-body">
      <table class="table align-middle">
        <thead>
        <tr>
          <th>Ng∆∞·ªùi nh·∫≠n</th>
          <th>S·ªë ƒëi·ªán tho·∫°i</th>
          <th>ƒê·ªãa ch·ªâ</th>
          <th>M·∫∑c ƒë·ªãnh</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody id="addressTableBody">
        <tr th:each="addr : ${addresses}" th:attr="data-id=${addr.id}">
          <td th:text="${addr.nguoiNhan != null ? addr.nguoiNhan : addr.nguoiDung.hoTen}"></td>
          <td th:text="${addr.soDienThoaiNguoiNhan != null ? addr.soDienThoaiNguoiNhan : addr.nguoiDung.soDienThoai}"></td>
          <td class="address-cell"
              th:title="${addr.tinhThanhPho + ', ' + addr.quanHuyen + ', ' + addr.phuongXa + ', ' + addr.chiTietDiaChi}"
              th:text="${addr.tinhThanhPho + ', ' + addr.quanHuyen + ', ' + addr.phuongXa + ', ' + addr.chiTietDiaChi}">
          </td>
          <td>
            <span th:if="${addr.macDinh}" class="badge bg-success">M·∫∑c ƒë·ªãnh</span>
          </td>
          <td>
            <button class="btn btn-primary btn-sm edit-address-btn" th:data-id="${addr.id}" th:data-bs-target="'#editAddressModal' + ${addr.id}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-danger btn-sm delete-address-btn" th:data-id="${addr.id}">
              <i class="fas fa-trash"></i>
            </button>
            <button th:if="${!addr.macDinh}" type="button" class="btn btn-secondary btn-sm set-default-btn"
                    th:data-id="${addr.id}">
              ƒê·∫∑t m·∫∑c ƒë·ªãnh
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Th√™m ƒê·ªãa ch·ªâ -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addAddressModalLabel">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addAddressForm">
          <div class="mb-3">
            <label for="addNguoiNhan" class="form-label">T√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="addNguoiNhan" name="nguoiNhan" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n" required>
          </div>
          <div class="mb-3">
            <label for="addSoDienThoaiNguoiNhan" class="form-label">S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="addSoDienThoaiNguoiNhan" name="soDienThoaiNguoiNhan" placeholder="Nh·∫≠p SƒêT ng∆∞·ªùi nh·∫≠n" required>
          </div>
          <div class="mb-3">
            <label for="addTinhThanhPho" class="form-label">T·ªânh/Th√†nh ph·ªë <span class="text-danger">*</span></label>
            <select class="form-select" id="addTinhThanhPho" name="tinhThanhPho" required>
              <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addQuanHuyen" class="form-label">Qu·∫≠n/Huy·ªán <span class="text-danger">*</span></label>
            <select class="form-select" id="addQuanHuyen" name="quanHuyen" required>
              <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addPhuongXa" class="form-label">Ph∆∞·ªùng/X√£ <span class="text-danger">*</span></label>
            <select class="form-select" id="addPhuongXa" name="phuongXa" required>
              <option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addChiTietDiaChi" class="form-label">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
            <input type="text" class="form-control" id="addChiTietDiaChi" name="chiTietDiaChi" required>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="addMacDinh" name="macDinh">
            <label class="form-check-label" for="addMacDinh">ƒê·∫∑t l√†m m·∫∑c ƒë·ªãnh</label>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="submit" class="btn btn-primary" id="addAddressBtn">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal S·ª≠a ƒê·ªãa ch·ªâ -->
<th:block th:each="addr : ${addresses}">
  <div class="modal fade" th:id="'editAddressModal' + ${addr.id}" tabindex="-1" th:aria-labelledby="'editAddressModalLabel' + ${addr.id}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" th:id="'editAddressModalLabel' + ${addr.id}">S·ª≠a ƒë·ªãa ch·ªâ</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form th:id="'editAddressForm' + ${addr.id}">
            <input type="hidden" th:value="${addr.id}" th:id="'editId' + ${addr.id}" name="id">

            <div class="mb-3">
              <label th:for="'editNguoiNhan' + ${addr.id}" class="form-label">T√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
              <input type="text" class="form-control"
                     th:id="'editNguoiNhan' + ${addr.id}"
                     name="nguoiNhan"
                     th:value="${addr.nguoiNhan != null ? addr.nguoiNhan : addr.nguoiDung.hoTen}"
                     placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n" required>
            </div>

            <div class="mb-3">
              <label th:for="'editSoDienThoaiNguoiNhan' + ${addr.id}" class="form-label">S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
              <input type="text" class="form-control"
                     th:id="'editSoDienThoaiNguoiNhan' + ${addr.id}"
                     name="soDienThoaiNguoiNhan"
                     th:value="${addr.soDienThoaiNguoiNhan != null ? addr.soDienThoaiNguoiNhan : addr.nguoiDung.soDienThoai}"
                     placeholder="Nh·∫≠p SƒêT ng∆∞·ªùi nh·∫≠n" required>
            </div>

            <div class="mb-3">
              <label th:for="'editTinhThanhPho' + ${addr.id}" class="form-label">T·ªânh/Th√†nh ph·ªë <span class="text-danger">*</span></label>
              <select class="form-select" th:id="'editTinhThanhPho' + ${addr.id}" name="tinhThanhPho" required
                      th:data-current-value="${addr.tinhThanhPho}">
                <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
              </select>
            </div>
            <div class="mb-3">
              <label th:for="'editQuanHuyen' + ${addr.id}" class="form-label">Qu·∫≠n/Huy·ªán <span class="text-danger">*</span></label>
              <select class="form-select" th:id="'editQuanHuyen' + ${addr.id}" name="quanHuyen" required
                      th:data-current-value="${addr.quanHuyen}">
                <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
              </select>
            </div>
            <div class="mb-3">
              <label th:for="'editPhuongXa' + ${addr.id}" class="form-label">Ph∆∞·ªùng/X√£ <span class="text-danger">*</span></label>
              <select class="form-select" th:id="'editPhuongXa' + ${addr.id}" name="phuongXa" required
                      th:data-current-value="${addr.phuongXa}">
                <option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>
              </select>
            </div>
            <div class="mb-3">
              <label th:for="'editChiTietDiaChi' + ${addr.id}" class="form-label">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
              <input type="text" class="form-control" th:id="'editChiTietDiaChi' + ${addr.id}" name="chiTietDiaChi"
                     th:value="${addr.chiTietDiaChi}" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" th:id="'editMacDinh' + ${addr.id}" name="macDinh"
                     th:checked="${addr.macDinh}">
              <label class="form-check-label" th:for="'editMacDinh' + ${addr.id}">ƒê·∫∑t l√†m m·∫∑c ƒë·ªãnh</label>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="submit" class="btn btn-primary update-address-btn" th:data-id="${addr.id}">C·∫≠p nh·∫≠t</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</th:block>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/navbar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // H√†m hi·ªÉn th·ªã toast notification
  function showToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container');
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    setTimeout(() => toast.remove(), 3000);
  }

  // H√†m th√™m d√≤ng m·ªõi v√†o b·∫£ng
  function appendAddressToTable(address) {
    const tableBody = document.getElementById('addressTableBody');
    const row = document.createElement('tr');
    row.setAttribute('data-id', address.id);
    row.innerHTML = `
      <td>${address.nguoiNhan || address.nguoiDung.hoTen}</td>
      <td>${address.soDienThoaiNguoiNhan || address.nguoiDung.soDienThoai}</td>

      <td class="address-cell" title="${address.tinhThanhPho}, ${address.quanHuyen}, ${address.phuongXa}, ${address.chiTietDiaChi}">
        ${address.tinhThanhPho}, ${address.quanHuyen}, ${address.phuongXa}, ${address.chiTietDiaChi}
      </td>
      <td>${address.macDinh ? '<span class="badge bg-success">M·∫∑c ƒë·ªãnh</span>' : ''}</td>
      <td>
        <button class="btn btn-primary btn-sm edit-address-btn" data-id="${address.id}" data-bs-target="#editAddressModal${address.id}">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-danger btn-sm delete-address-btn" data-id="${address.id}">
          <i class="fas fa-trash"></i>
        </button>
        ${!address.macDinh ? `<button class="btn btn-secondary btn-sm set-default-btn" data-id="${address.id}">ƒê·∫∑t m·∫∑c ƒë·ªãnh</button>` : ''}
      </td>
    `;
    tableBody.appendChild(row);
    bindAddressEventListeners();
  }

  // H√†m c·∫≠p nh·∫≠t d√≤ng trong b·∫£ng
  function updateAddressInTable(address) {
    const row = document.querySelector(`tr[data-id="${address.id}"]`);
    if (row) {
      row.innerHTML = `
        <td>${address.nguoiDung.hoTen}</td>
        <td>${address.nguoiDung.soDienThoai}</td>
        <td class="address-cell" title="${address.tinhThanhPho}, ${address.quanHuyen}, ${address.phuongXa}, ${address.chiTietDiaChi}">
          ${address.tinhThanhPho}, ${address.quanHuyen}, ${address.phuongXa}, ${address.chiTietDiaChi}
        </td>
        <td>${address.macDinh ? '<span class="badge bg-success">M·∫∑c ƒë·ªãnh</span>' : ''}</td>
        <td>
          <button class="btn btn-primary btn-sm edit-address-btn" data-id="${address.id}" data-bs-target="#editAddressModal${address.id}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-danger btn-sm delete-address-btn" data-id="${address.id}">
            <i class="fas fa-trash"></i>
          </button>
          ${!address.macDinh ? `<button class="btn btn-secondary btn-sm set-default-btn" data-id="${address.id}">ƒê·∫∑t m·∫∑c ƒë·ªãnh</button>` : ''}
        </td>
      `;
      bindAddressEventListeners();
    }
  }

  // H√†m x√≥a d√≤ng kh·ªèi b·∫£ng
  function removeAddressFromTable(addressId) {
    const row = document.querySelector(`tr[data-id="${addressId}"]`);
    if (row) row.remove();
  }

  // L·∫•y CSRF token
  const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

  // H√†m t·∫£i t·ªânh/th√†nh ph·ªë
  async function fetchProvinces() {
    try {
      let response = await fetch("https://provinces.open-api.vn/api/p/");
      let provinces = await response.json();
      const provinceSelects = document.querySelectorAll('select[id^="addTinhThanhPho"], select[id^="editTinhThanhPho"]');
      provinceSelects.forEach(select => {
        select.innerHTML = '<option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>';
        provinces.forEach(province => {
          const option = document.createElement("option");
          option.value = province.name;
          option.textContent = province.name;
          option.setAttribute("data-code", province.code);
          select.appendChild(option);
        });
      });
      return provinces;
    } catch (error) {
      console.error("L·ªói t·∫£i t·ªânh/th√†nh ph·ªë", error);
      showToast("L·ªói t·∫£i d·ªØ li·ªáu t·ªânh/th√†nh ph·ªë", 'danger');
      return [];
    }
  }

  // H√†m t·∫£i qu·∫≠n/huy·ªán
  async function fetchDistricts(provinceCode, districtSelect, wardSelect) {
    try {
      let response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
      let data = await response.json();
      districtSelect.innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
      wardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';

      data.districts.forEach(district => {
        const option = document.createElement("option");
        option.value = district.name;
        option.textContent = district.name;
        option.setAttribute("data-code", district.code);
        districtSelect.appendChild(option);
      });
    } catch (error) {
      console.error("L·ªói t·∫£i qu·∫≠n/huy·ªán", error);
      showToast("L·ªói t·∫£i d·ªØ li·ªáu qu·∫≠n/huy·ªán", 'danger');
    }
  }

  // H√†m t·∫£i ph∆∞·ªùng/x√£
  async function fetchWards(districtCode, wardSelect) {
    try {
      let response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
      let data = await response.json();
      wardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';

      data.wards.forEach(ward => {
        const option = document.createElement("option");
        option.value = ward.name;
        option.textContent = ward.name;
        option.setAttribute("data-code", ward.code);
        wardSelect.appendChild(option);
      });
    } catch (error) {
      console.error("L·ªói t·∫£i ph∆∞·ªùng/x√£", error);
      showToast("L·ªói t·∫£i d·ªØ li·ªáu ph∆∞·ªùng/x√£", 'danger');
    }
  }

  // H√†m thi·∫øt l·∫≠p gi√° tr·ªã hi·ªán t·∫°i cho select
  function setSelectValue(selectElement, value) {
    if (value && selectElement) {
      const options = selectElement.querySelectorAll('option');
      for (let option of options) {
        if (option.value === value) {
          option.selected = true;
          break;
        }
      }
    }
  }

  // H√†m thi·∫øt l·∫≠p ƒë·ªãa ch·ªâ cho form edit khi modal ƒë∆∞·ª£c m·ªü
  function setupEditForm(addressId, currentProvince, currentDistrict, currentWard) {
    const provinceSelect = document.getElementById(`editTinhThanhPho${addressId}`);
    const districtSelect = document.getElementById(`editQuanHuyen${addressId}`);
    const wardSelect = document.getElementById(`editPhuongXa${addressId}`);

    if (!provinceSelect || !districtSelect || !wardSelect) return;

    // Thi·∫øt l·∫≠p t·ªânh/th√†nh ph·ªë
    setSelectValue(provinceSelect, currentProvince);

    // T√¨m m√£ t·ªânh
    const selectedProvinceOption = provinceSelect.querySelector(`option[value="${currentProvince}"]`);
    if (selectedProvinceOption) {
      const provinceCode = selectedProvinceOption.getAttribute('data-code');
      fetchDistricts(provinceCode, districtSelect, wardSelect).then(() => {
        // Thi·∫øt l·∫≠p qu·∫≠n/huy·ªán
        setSelectValue(districtSelect, currentDistrict);

        // T√¨m m√£ qu·∫≠n
        const selectedDistrictOption = districtSelect.querySelector(`option[value="${currentDistrict}"]`);
        if (selectedDistrictOption) {
          const districtCode = selectedDistrictOption.getAttribute('data-code');
          fetchWards(districtCode, wardSelect).then(() => {
            // Thi·∫øt l·∫≠p ph∆∞·ªùng/x√£
            setSelectValue(wardSelect, currentWard);
          });
        }
      });
    }
  }

  // H√†m bind s·ª± ki·ªán cho c√°c n√∫t
  function bindAddressEventListeners() {
    document.querySelectorAll('.edit-address-btn').forEach(btn => {
      btn.removeEventListener('click', editAddressHandler);
      btn.addEventListener('click', editAddressHandler);
    });

    document.querySelectorAll('.delete-address-btn').forEach(btn => {
      btn.removeEventListener('click', deleteAddressHandler);
      btn.addEventListener('click', deleteAddressHandler);
    });

    document.querySelectorAll('.set-default-btn').forEach(btn => {
      btn.removeEventListener('click', setDefaultHandler);
      btn.addEventListener('click', setDefaultHandler);
    });

    document.querySelectorAll('.update-address-btn').forEach(btn => {
      btn.removeEventListener('click', updateAddressHandler);
      btn.addEventListener('click', updateAddressHandler);
    });
  }

  function editAddressHandler() {
    const modalId = this.getAttribute('data-bs-target');
    const modal = document.querySelector(modalId);
    if (modal) {
      bootstrap.Modal.getOrCreateInstance(modal).show();
    } else {
      console.error(`Modal ${modalId} not found`);
      showToast('Kh√¥ng t√¨m th·∫•y modal ch·ªânh s·ª≠a', 'danger');
    }
  }

  function deleteAddressHandler() {
    if (!confirm('X√≥a ƒë·ªãa ch·ªâ n√†y?')) return;
    const addressId = this.dataset.id;
    const headers = { 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
    fetch(`/profile/address/${addressId}/delete-ajax`, {
      method: 'POST',
      headers
    })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(data => {
              if (data.status === 'success') {
                removeAddressFromTable(addressId);
                showToast(data.message);
              } else {
                showToast(data.message, 'danger');
              }
            })
            .catch(err => showToast('C√≥ l·ªói x·∫£y ra: ' + err.message, 'danger'));
  }

  function setDefaultHandler() {
    const addressId = this.dataset.id;
    const button = this;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ƒêang x·ª≠ l√Ω...';
    const headers = { 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
    fetch(`/profile/address/${addressId}/set-default-ajax`, {
      method: 'POST',
      headers
    })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(data => {
              if (data.status === 'success') {
                showToast(data.message);
                if (data.logout) {
                  // Backend ƒë√£ x√≥a session, chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p
                  setTimeout(() => {
                    window.location.href = data.redirect || '/login'; // s·ª≠a URL n·∫øu kh√°c
                  }, 600);
                } else {
                  setTimeout(() => location.reload(), 1000);
                }
              } else {
                showToast(data.message, 'danger');
              }
            })
            .catch(err => {
              showToast('C√≥ l·ªói x·∫£y ra: ' + err.message, 'danger');
              button.disabled = false;
              button.innerHTML = 'ƒê·∫∑t m·∫∑c ƒë·ªãnh';
            });
  }

  function updateAddressHandler() {
    const addressId = this.dataset.id;
    const form = document.getElementById(`editAddressForm${addressId}`);
    const data = {
      id: document.getElementById(`editId${addressId}`).value,
      nguoiNhan: document.getElementById(`editNguoiNhan${addressId}`).value,
      soDienThoaiNguoiNhan: document.getElementById(`editSoDienThoaiNguoiNhan${addressId}`).value,
      tinhThanhPho: document.getElementById(`editTinhThanhPho${addressId}`).value,
      quanHuyen: document.getElementById(`editQuanHuyen${addressId}`).value,
      phuongXa: document.getElementById(`editPhuongXa${addressId}`).value,
      chiTietDiaChi: document.getElementById(`editChiTietDiaChi${addressId}`).value,
      macDinh: document.getElementById(`editMacDinh${addressId}`).checked
    };

    if (!data.tinhThanhPho || !data.quanHuyen || !data.phuongXa || !data.chiTietDiaChi) {
      showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng ƒë·ªãa ch·ªâ', 'danger');
      return;
    }
    const headers = { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
    fetch(`/profile/address/${addressId}/update-ajax`, {
      method: 'POST',
      headers,
      body: JSON.stringify(data)
    })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(data => {
              if (data.status === 'success') {
                updateAddressInTable(data.address);
                bootstrap.Modal.getInstance(document.getElementById(`editAddressModal${addressId}`)).hide();
                showToast(data.message);
              } else {
                showToast(data.message, 'danger');
              }
            })
            .catch(err => showToast('C√≥ l·ªói x·∫£y ra: ' + err.message, 'danger'));
  }

  // Th√™m ƒë·ªãa ch·ªâ
  document.getElementById('addAddressForm')?.addEventListener('submit', function (e) {
    e.preventDefault();
    const data = {
      nguoiNhan: document.getElementById('addNguoiNhan').value,
      soDienThoaiNguoiNhan: document.getElementById('addSoDienThoaiNguoiNhan').value,
      tinhThanhPho: document.getElementById('addTinhThanhPho').value,
      quanHuyen: document.getElementById('addQuanHuyen').value,
      phuongXa: document.getElementById('addPhuongXa').value,
      chiTietDiaChi: document.getElementById('addChiTietDiaChi').value,
      macDinh: document.getElementById('addMacDinh').checked
    };

    if (!data.tinhThanhPho || !data.quanHuyen || !data.phuongXa || !data.chiTietDiaChi) {
      showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng ƒë·ªãa ch·ªâ', 'danger');
      return;
    }
    const headers = { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
    fetch('/profile/address/add-ajax', {
      method: 'POST',
      headers,
      body: JSON.stringify(data)
    })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(data => {
              if (data.status === 'success') {
                const modalEl = document.getElementById('addAddressModal');
                const modal = bootstrap.Modal.getInstance(modalEl);

                // Hi·ªán toast tr∆∞·ªõc khi reload
                showToast(data.message || 'Th√™m ƒë·ªãa ch·ªâ th√†nh c√¥ng');

                // Khi modal ƒë√≥ng xong th√¨ reload trang
                modalEl.addEventListener('hidden.bs.modal', () => {
                  if (data.redirect) {
                    window.location.href = data.redirect; // n·∫øu backend tr·∫£ redirect
                  } else {
                    window.location.reload(); // reload ƒë·ªÉ ƒë·ªìng b·ªô danh s√°ch ƒë·ªãa ch·ªâ
                  }
                }, { once: true });

                // ƒê√≥ng modal + reset form
                modal?.hide();
                document.getElementById('addAddressForm').reset();
              } else {
                showToast(data.message || 'Kh√¥ng th·ªÉ th√™m ƒë·ªãa ch·ªâ', 'danger');
              }
            })
            .catch(err => showToast('C√≥ l·ªói x·∫£y ra: ' + err.message, 'danger'));
  });

  // ===== SweetAlert2 toast gi·ªëng trang thanh to√°n =====
  function swToast(message, type = 'success') {
    return Swal.fire({
      toast: true,
      position: 'top-end',
      icon: type,                 // 'success' | 'error' | 'info' | 'warning' | 'question'
      title: message,
      showConfirmButton: false,
      timer: 1800,
      timerProgressBar: true
    });
  }

  // ===== X√°c nh·∫≠n tr∆∞·ªõc khi c·∫≠p nh·∫≠t h·ªì s∆° (AJAX) =====
  let initialProfile = {};
  document.addEventListener('DOMContentLoaded', function () {
    initialProfile = {
      hoTen: document.querySelector('input[name="hoTen"]')?.value || '',
      email: document.querySelector('input[name="email"]')?.value || '',
      soDienThoai: document.querySelector('input[name="soDienThoai"]')?.value || ''
    };
  });

  // Danh s√°ch thay ƒë·ªïi (gi·ªØ nguy√™n ho·∫∑c n√¢ng c·∫•p format)
  function buildChangesList(current) {
    const changes = [];
    if (current.hoTen !== initialProfile.hoTen)
      changes.push(`H·ªç t√™n: "<b>${initialProfile.hoTen}</b>" ‚Üí "<b>${current.hoTen}</b>"`);
    if (current.email !== initialProfile.email)
      changes.push(`Email: "<b>${initialProfile.email}</b>" ‚Üí "<b>${current.email}</b>"`);
    if (current.soDienThoai !== initialProfile.soDienThoai)
      changes.push(`SƒêT: "<b>${initialProfile.soDienThoai}</b>" ‚Üí "<b>${current.soDienThoai}</b>"`);
    if (current.matKhau)
      changes.push('M·∫≠t kh·∫©u: <i>(s·∫Ω thay ƒë·ªïi)</i>');
    return changes;
  }

  // Handler submit: confirm b·∫±ng SweetAlert2 (KH√îNG d√πng modal Bootstrap)
  document.getElementById('profileForm')?.addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = this;

    const current = {
      hoTen: form.querySelector('input[name="hoTen"]').value.trim(),
      email: form.querySelector('input[name="email"]').value.trim(),
      soDienThoai: form.querySelector('input[name="soDienThoai"]').value.trim(),
      matKhau: form.querySelector('input[name="matKhau"]').value
    };

    const changes = buildChangesList(current);

    if (!changes.length) {
      return swToast('B·∫°n ch∆∞a thay ƒë·ªïi th√¥ng tin n√†o', 'info');
    }

    const htmlList = `
    <div class="text-start">
      <p>B·∫°n s·∫Øp thay ƒë·ªïi c√°c th√¥ng tin sau:</p>
      <ul style="margin-left:1rem">${changes.map(c => `<li>${c}</li>`).join('')}</ul>
      <div class="alert alert-info mt-3 mb-0">
        Sau khi c·∫≠p nh·∫≠t, h·ªá th·ªëng s·∫Ω ƒëƒÉng xu·∫•t b·∫°n ƒë·ªÉ b·∫£o m·∫≠t.
      </div>
    </div>`;

    const { isConfirmed } = await Swal.fire({
      icon: 'question',
      title: 'X√°c nh·∫≠n c·∫≠p nh·∫≠t',
      html: htmlList,
      showCancelButton: true,
      confirmButtonText: 'X√°c nh·∫≠n',
      cancelButtonText: 'H·ªßy',
      confirmButtonColor: '#153054',  // ƒë·ªìng b·ªô m√†u v·ªõi checkout
      cancelButtonColor: '#d33',
      reverseButtons: true
    });

    if (isConfirmed) performUpdateProfile(form);
  });

  function performUpdateProfile(formEl) {
    const formData = new FormData(formEl);
    const button = document.getElementById('updateProfileBtn');

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ƒêang c·∫≠p nh·∫≠t...';

    const headers = { 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

    fetch('/profile', { method: 'POST', headers, body: formData })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(async data => {
              if (data.status === 'success') {
                await swToast(data.message || 'C·∫≠p nh·∫≠t th√†nh c√¥ng', 'success');
                // ƒêƒÉng xu·∫•t / chuy·ªÉn h∆∞·ªõng sau khi c·∫≠p nh·∫≠t
                window.location.href = data.redirect || '/logout';
              } else {
                swToast(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t', 'error');
              }
            })
            .catch(err => swToast('C√≥ l·ªói x·∫£y ra: ' + err.message, 'error'))
            .finally(() => {
              button.disabled = false;
              button.innerHTML = '<i class="fas fa-save me-1"></i> C·∫≠p nh·∫≠t';
            });
  }

  // Kh·ªüi t·∫°o t·∫£i d·ªØ li·ªáu t·ªânh/th√†nh ph·ªë
  document.addEventListener('DOMContentLoaded', function () {
    bindAddressEventListeners();

    // Thi·∫øt l·∫≠p d·ªØ li·ªáu cho form th√™m
    const addProvinceSelect = document.getElementById('addTinhThanhPho');
    const addDistrictSelect = document.getElementById('addQuanHuyen');
    const addWardSelect = document.getElementById('addPhuongXa');

    if (addProvinceSelect && addDistrictSelect && addWardSelect) {
      addProvinceSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const provinceCode = selectedOption.getAttribute('data-code');
        if (provinceCode) {
          fetchDistricts(provinceCode, addDistrictSelect, addWardSelect);
        } else {
          addDistrictSelect.innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
          addWardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
        }
      });

      addDistrictSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const districtCode = selectedOption.getAttribute('data-code');
        if (districtCode) {
          fetchWards(districtCode, addWardSelect);
        } else {
          addWardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
        }
      });
    }

    // Thi·∫øt l·∫≠p d·ªØ li·ªáu cho c√°c form edit khi modal ƒë∆∞·ª£c m·ªü
    const editModals = document.querySelectorAll('[id^="editAddressModal"]');
    editModals.forEach(modal => {
      modal.addEventListener('show.bs.modal', function (event) {
        const addressId = modal.id.replace('editAddressModal', '');
        const provinceSelect = document.getElementById(`editTinhThanhPho${addressId}`);
        const districtSelect = document.getElementById(`editQuanHuyen${addressId}`);
        const wardSelect = document.getElementById(`editPhuongXa${addressId}`);

        if (provinceSelect && districtSelect && wardSelect) {
          const currentProvince = provinceSelect.getAttribute('data-current-value');
          const currentDistrict = districtSelect.getAttribute('data-current-value');
          const currentWard = wardSelect.getAttribute('data-current-value');

          setupEditForm(addressId, currentProvince, currentDistrict, currentWard);
        }
      });
    });

    // T·∫£i danh s√°ch t·ªânh/th√†nh ph·ªë
    fetchProvinces();
  });

  // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi t·ªânh/th√†nh ph·ªë v√† qu·∫≠n/huy·ªán cho c√°c form edit
  document.addEventListener('change', function(e) {
    if (e.target.matches('select[id^="editTinhThanhPho"]')) {
      const addressId = e.target.id.replace('editTinhThanhPho', '');
      const districtSelect = document.getElementById(`editQuanHuyen${addressId}`);
      const wardSelect = document.getElementById(`editPhuongXa${addressId}`);

      const selectedOption = e.target.options[e.target.selectedIndex];
      const provinceCode = selectedOption.getAttribute('data-code');

      if (provinceCode && districtSelect && wardSelect) {
        fetchDistricts(provinceCode, districtSelect, wardSelect);
      } else if (districtSelect && wardSelect) {
        districtSelect.innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
        wardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
      }
    }

    if (e.target.matches('select[id^="editQuanHuyen"]')) {
      const addressId = e.target.id.replace('editQuanHuyen', '');
      const wardSelect = document.getElementById(`editPhuongXa${addressId}`);

      const selectedOption = e.target.options[e.target.selectedIndex];
      const districtCode = selectedOption.getAttribute('data-code');

      if (districtCode && wardSelect) {
        fetchWards(districtCode, wardSelect);
      } else if (wardSelect) {
        wardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
      }
    }
  });
</script>
</body>
</html>