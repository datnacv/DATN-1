<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACV Store - H·ªì s∆° c√° nh√¢n</title>
  <meta name="_csrf" th:content="${_csrf?.token}"/>
  <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
  <style>
    .navbar {  background: linear-gradient(135deg, #153054 0%, #1e4066 100%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1); }
    .navbar { position: fixed; top: 40px; left: 0; width: 100%; z-index: 1040; }

    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .search-suggestions.active {
      opacity: 1;
      visibility: visible;
    }
    .suggestion-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    .suggestion-item:hover {
      background-color: #f1f5f9;
    }
    .suggestion-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      margin-right: 10px;
      border-radius: 4px;
    }
    .history-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
      background-color: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .history-item:hover {
      background-color: #e2e8f0;
    }
    .history-item .highlight {
      background-color: #9FD5F7;
      padding: 2px 4px;
      border-radius: 4px;
    }
    .history-item .delete-btn {
      color: #ef4444;
      font-size: 14px;
      cursor: pointer;
      padding: 5px;
      transition: color 0.2s;
    }
    .history-item .delete-btn:hover {
      color: #b91c1c;
    }

    /* Enhanced dropdown */
    .dropdown-menu {
      display: none;
      position: absolute;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      min-width: 200px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      z-index: 1000;
      padding: 8px;
    }

    .dropdown:hover .dropdown-menu {
      display: block;
      animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown-menu a {
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .dropdown-menu a:hover {
      background: linear-gradient(135deg, #e0ebf5 0%, #f1f8ff 100%);
      transform: translateX(4px);
    }

    /* Enhanced search bar */
    .search-container input {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .search-container input:focus {
      border-color: #9FD5F7;
      box-shadow: 0 0 0 4px rgba(159, 213, 247, 0.2);
    }

    /* Enhanced page title */
    .page-title {
      background: linear-gradient(135deg, #153054 0%, #1e4066 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
      letter-spacing: -0.02em;
      margin-bottom: 2rem;
    }

    /* Enhanced tabs */
    .nav-tabs {
      border: none;
      background: white;
      border-radius: 16px;
      padding: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 2rem;
      overflow-x: auto;
      white-space: nowrap;
    }

    .nav-tabs .nav-item {
      margin: 0 4px;
    }

    .nav-tabs .nav-link {
      color: #64748b;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .nav-tabs .nav-link:hover {
      color: #153054;
      background: rgba(159, 213, 247, 0.1);
      transform: translateY(-2px);
    }

    .nav-tabs .nav-link.active {
      background: linear-gradient(135deg, #153054 0%, #1e4066 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(21, 48, 84, 0.3);
      transform: translateY(-2px);
    }

    .nav-tabs .nav-link.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
      pointer-events: none;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      padding-top: 118px;
      line-height: 1.6;
    }
    .page-title { font-size: 1.8rem; font-weight: 700; color: #153054; margin-bottom: 20px; }
    .card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .form-label { font-weight: 600; }
    .form-control, .form-select {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.95rem;
    }
    .ticker { background-color: #9FD5F7; color: #153054; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1050; }
    .form-control:focus, .form-select:focus {
      border-color: #153054;
      box-shadow: 0 0 0 3px rgba(21, 48, 84, 0.1);
    }
    .btn-primary { background-color: #153054; border: none; }
    .btn-primary:hover { background-color: #1e4066; }
    .btn-secondary { background-color: #e2e6ea; border: none; color: #153054; }
    .btn-secondary:hover { background-color: #d6dade; }
    .btn-success { background-color: #28a745; border: none; }
    .btn-success:hover { background-color: #218838; }
    .address-cell { max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .avatar { width: 80px; height: 80px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #888; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 20000; }
  </style>
</head>
<body>

<div class="ticker py-1 overflow-hidden" style="height: 40px;">
  <marquee behavior="scroll" direction="left" scrollamount="5">
    üéâ Khuy·∫øn m√£i ƒë·∫∑c bi·ªát: Gi·∫£m gi√° l√™n ƒë·∫øn 50% cho t·∫•t c·∫£ s·∫£n ph·∫©m h√¥m nay! üéâ - Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n t·ª´ 500k!
  </marquee>
</div>

<div th:replace="~{fragments/kh_navbar :: navbar(user=${user}, keyword=${keyword}, cartCount=${cartCount})}"></div>

<!-- Toast Container -->
<div class="toast-container"></div>

<div class="container py-5">
  <h1 class="page-title"><i class="fas fa-user-circle me-2"></i> H·ªì s∆° c√° nh√¢n</h1>

  <!-- Alert t·ª´ backend -->
  <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

  <!-- Th√¥ng tin c√° nh√¢n -->
  <div class="card mb-4">
    <div class="card-header fw-bold"><i class="fas fa-id-card me-1"></i> Th√¥ng tin c√° nh√¢n</div>
    <div class="card-body">
      <div class="d-flex align-items-center mb-4">
        <div class="avatar me-3"><i class="fas fa-user"></i></div>
        <div>
          <div class="fw-bold" th:text="${user.hoTen}">Nguy·ªÖn VƒÉn A</div>
          <small class="text-muted" th:text="${user.email}">example@email.com</small>
        </div>
      </div>

      <!-- Form c·∫≠p nh·∫≠t th√¥ng tin -->
      <form id="profileForm" th:action="@{/profile}" method="post">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">H·ªç t√™n</label>
            <input type="text" class="form-control" name="hoTen" th:value="${user.hoTen}" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Email</label>
            <input type="text" class="form-control" name="email" th:value="${user.email}" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="text" class="form-control" name="soDienThoai" th:value="${user.soDienThoai}" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
            <input type="password" class="form-control" name="matKhau" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi" required>
          </div>
        </div>
        <button type="submit" class="btn btn-primary" id="updateProfileBtn"><i class="fas fa-save me-1"></i> C·∫≠p nh·∫≠t</button>
      </form>
    </div>
  </div>

  <!-- Danh s√°ch ƒë·ªãa ch·ªâ -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold"><i class="fas fa-map-marker-alt me-1"></i> ƒê·ªãa ch·ªâ c·ªßa t√¥i</span>
      <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">
        <i class="fas fa-plus me-1"></i> Th√™m ƒë·ªãa ch·ªâ
      </button>
    </div>
    <div class="card-body">
      <table class="table align-middle">
        <thead>
        <tr>
          <th>Ng∆∞·ªùi nh·∫≠n</th>
          <th>S·ªë ƒëi·ªán tho·∫°i</th>
          <th>ƒê·ªãa ch·ªâ</th>
          <th>M·∫∑c ƒë·ªãnh</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody id="addressTableBody">
        <tr th:each="addr : ${addresses}" th:attr="data-id=${addr.id}">
          <td th:text="${addr.nguoiNhan != null ? addr.nguoiNhan : addr.nguoiDung.hoTen}"></td>
          <td th:text="${addr.soDienThoaiNguoiNhan != null ? addr.soDienThoaiNguoiNhan : addr.nguoiDung.soDienThoai}"></td>
          <td class="address-cell"
              th:title="${addr.tinhThanhPho + ', ' + addr.quanHuyen + ', ' + addr.phuongXa + ', ' + addr.chiTietDiaChi}"
              th:text="${addr.tinhThanhPho + ', ' + addr.quanHuyen + ', ' + addr.phuongXa + ', ' + addr.chiTietDiaChi}">
          </td>
          <td>
            <span th:if="${addr.macDinh}" class="badge bg-success">M·∫∑c ƒë·ªãnh</span>
          </td>
          <td>
            <button class="btn btn-primary btn-sm edit-address-btn" th:data-id="${addr.id}" th:data-bs-target="'#editAddressModal' + ${addr.id}">
              <i class="fas fa-edit"></i>
            </button>
<!--            <button class="btn btn-danger btn-sm delete-address-btn" th:data-id="${addr.id}">-->
<!--              <i class="fas fa-trash"></i>-->
<!--            </button>-->
            <button th:if="${!addr.macDinh}" type="button" class="btn btn-secondary btn-sm set-default-btn"
                    th:data-id="${addr.id}">
              ƒê·∫∑t m·∫∑c ƒë·ªãnh
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Th√™m ƒê·ªãa ch·ªâ -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addAddressModalLabel">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addAddressForm">
          <div class="mb-3">
            <label for="addNguoiNhan" class="form-label">T√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="addNguoiNhan" name="nguoiNhan"
                   required maxlength="50"
                   pattern="(?! )(?!.* {2})[A-Za-z√Ä-·ªø\u0110\u0111]+(?: [A-Za-z√Ä-·ªø\u0110\u0111]+)*"
                   title="Ch·ªâ ch·ªØ v√† kho·∫£ng tr·∫Øng, kh√¥ng d∆∞ kho·∫£ng tr·∫Øng">
          </div>
          <div class="mb-3">
            <label for="addSoDienThoaiNguoiNhan" class="form-label">S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="addSoDienThoaiNguoiNhan" name="soDienThoaiNguoiNhan"
                   required inputmode="tel"
                   pattern="(0(3|5|7|8|9)\d{8}|02\d{9})"
                   title="Di ƒë·ªông: 03/05/07/08/09 + 8 s·ªë; C·ªë ƒë·ªãnh: 02 + 9 s·ªë">
          </div>
          <div class="mb-3">
            <label for="addTinhThanhPho" class="form-label">T·ªânh/Th√†nh ph·ªë <span class="text-danger">*</span></label>
            <select class="form-select" id="addTinhThanhPho" name="tinhThanhPho" required>
              <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addQuanHuyen" class="form-label">Qu·∫≠n/Huy·ªán <span class="text-danger">*</span></label>
            <select class="form-select" id="addQuanHuyen" name="quanHuyen" required>
              <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addPhuongXa" class="form-label">Ph∆∞·ªùng/X√£ <span class="text-danger">*</span></label>
            <select class="form-select" id="addPhuongXa" name="phuongXa" required>
              <option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addChiTietDiaChi" class="form-label">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
            <input type="text" class="form-control" id="addChiTietDiaChi" name="chiTietDiaChi"
                   required maxlength="200"
                   pattern="^(?! )(?!.* {2})(?!.*[<>\'\\|?*%$!~^=&{}\[\];])[0-9A-Za-z√Ä-·ªø.,:/#()\-\s]{3,200}$"
            title="3‚Äì200 k√Ω t·ª±. Kh√¥ng ch·ª©a: < > &quot; ' \ | ? * % $ ! ~ ^ = & { } [ ] ; . Kh√¥ng c√≥ kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi hay 2 kho·∫£ng tr·∫Øng li√™n ti·∫øp.">
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="addMacDinh" name="macDinh">
            <label class="form-check-label" for="addMacDinh">ƒê·∫∑t l√†m m·∫∑c ƒë·ªãnh</label>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="submit" class="btn btn-primary" id="addAddressBtn">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal S·ª≠a ƒê·ªãa ch·ªâ -->
<th:block th:each="addr : ${addresses}">
  <div class="modal fade" th:id="'editAddressModal' + ${addr.id}" tabindex="-1" th:aria-labelledby="'editAddressModalLabel' + ${addr.id}" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" th:id="'editAddressModalLabel' + ${addr.id}">S·ª≠a ƒë·ªãa ch·ªâ</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form th:id="'editAddressForm' + ${addr.id}">
            <input type="hidden" th:value="${addr.id}" th:id="'editId' + ${addr.id}" name="id">

            <div class="mb-3">
              <label th:for="'editNguoiNhan' + ${addr.id}" class="form-label">T√™n ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
              <input type="text" class="form-control" th:id="'editNguoiNhan' + ${addr.id}" name="nguoiNhan"
                     required maxlength="50"
                     pattern="(?! )(?!.* {2})[A-Za-z√Ä-·ªø\u0110\u0111]+(?: [A-Za-z√Ä-·ªø\u0110\u0111]+)*"
                     title="Ch·ªâ ch·ªØ v√† kho·∫£ng tr·∫Øng, kh√¥ng d∆∞ kho·∫£ng tr·∫Øng">
            </div>

            <div class="mb-3">
              <label th:for="'editSoDienThoaiNguoiNhan' + ${addr.id}" class="form-label">S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span></label>
              <input type="text" class="form-control" th:id="'editSoDienThoaiNguoiNhan' + ${addr.id}" name="soDienThoaiNguoiNhan"
                     required inputmode="tel"
                     pattern="(0(3|5|7|8|9)\d{8}|02\d{9})"
                     title="Di ƒë·ªông: 03/05/07/08/09 + 8 s·ªë; C·ªë ƒë·ªãnh: 02 + 9 s·ªë">
            </div>

            <div class="mb-3">
              <label th:for="'editTinhThanhPho' + ${addr.id}" class="form-label">T·ªânh/Th√†nh ph·ªë <span class="text-danger">*</span></label>
              <select class="form-select" th:id="'editTinhThanhPho' + ${addr.id}" name="tinhThanhPho" required
                      th:data-current-value="${addr.tinhThanhPho}">
                <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
              </select>
            </div>
            <div class="mb-3">
              <label th:for="'editQuanHuyen' + ${addr.id}" class="form-label">Qu·∫≠n/Huy·ªán <span class="text-danger">*</span></label>
              <select class="form-select" th:id="'editQuanHuyen' + ${addr.id}" name="quanHuyen" required
                      th:data-current-value="${addr.quanHuyen}">
                <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
              </select>
            </div>
            <div class="mb-3">
              <label th:for="'editPhuongXa' + ${addr.id}" class="form-label">Ph∆∞·ªùng/X√£ <span class="text-danger">*</span></label>
              <select class="form-select" th:id="'editPhuongXa' + ${addr.id}" name="phuongXa" required
                      th:data-current-value="${addr.phuongXa}">
                <option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>
              </select>
            </div>
            <div class="mb-3">
              <label th:for="'editChiTietDiaChi' + ${addr.id}" class="form-label">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
              <input type="text" class="form-control" th:id="'editChiTietDiaChi' + ${addr.id}" name="chiTietDiaChi"
                     th:value="${addr.chiTietDiaChi}" required maxlength="200"
                     pattern="^(?! )(?!.* {2})(?!.*[<>\'\\|?*%$!~^=&{}\[\];])[0-9A-Za-z√Ä-·ªø.,:/#()\-\s]{3,200}$"
              title="3‚Äì200 k√Ω t·ª±. Kh√¥ng ch·ª©a: < > &quot; ' \ | ? * % $ ! ~ ^ = & { } [ ] ; . Kh√¥ng c√≥ kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi hay 2 kho·∫£ng tr·∫Øng li√™n ti·∫øp.">
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" th:id="'editMacDinh' + ${addr.id}" name="macDinh"
                     th:checked="${addr.macDinh}">
              <label class="form-check-label" th:for="'editMacDinh' + ${addr.id}">ƒê·∫∑t l√†m m·∫∑c ƒë·ªãnh</label>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
              <button type="submit" class="btn btn-primary update-address-btn" th:data-id="${addr.id}">C·∫≠p nh·∫≠t</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</th:block>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/navbar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function cleanAddressDetail(s) {
    return (s || '').trim().replace(/\s+/g, ' ');
  }

  const FORBIDDEN_ADDR_CHARS = /[<>\"'\\|?*%$!~^=&{}\[\];]/;

  function isValidAddressDetail(s) {
    if (!s) return false;
    if (s.length < 3 || s.length > 200) return false;
    if (s.startsWith(' ') || s.endsWith(' ') || /\s{2,}/.test(s)) return false;
    if (FORBIDDEN_ADDR_CHARS.test(s)) return false;
    // Allow-list an to√†n cho ƒë·ªãa ch·ªâ (ch·ªØ c√≥ d·∫•u, s·ªë, kho·∫£ng tr·∫Øng v√† v√†i k√Ω t·ª± th∆∞·ªùng d√πng)
    return /^[0-9A-Za-z√Ä-·ªø.,:/#()\-\s]+$/.test(s);
  }

  // (tu·ª≥ ch·ªçn) Ch·∫∑n ngay khi g√µ c√°c k√Ω t·ª± b·ªã c·∫•m
  document.addEventListener('input', function(e) {
    if (e.target.matches('#addChiTietDiaChi, [id^="editChiTietDiaChi"]')) {
      e.target.value = e.target.value.replace(FORBIDDEN_ADDR_CHARS, '');
    }
  });

  function normalizeName(str) {
    return str.trim().replace(/\s+/g, ' ');
  }
  function cleanPersonName(str) {
    // Trim 2 ƒë·∫ßu + gom nhi·ªÅu kho·∫£ng tr·∫Øng th√†nh 1
    return str.trim().replace(/\s+/g, ' ');
  }

  // Ch·ªâ ch·ªØ c√°i (k·ªÉ c·∫£ ti·∫øng Vi·ªát) v√† kho·∫£ng tr·∫Øng, kh√¥ng cho space ƒë·∫ßu/cu·ªëi hay 2 space li√™n ti·∫øp
  function isValidPersonName(name) {
    const re = /^(?! )(?!.* {2})[A-Za-z√Ä-·ªø\u0110\u0111]+(?: [A-Za-z√Ä-·ªø\u0110\u0111]+)*$/;
    return re.test(name) && name.length >= 2 && name.length <= 50;
  }

  // Chu·∫©n ho√° s·ªë: b·ªè k√Ω t·ª± ph√¢n c√°ch, ƒë·ªïi +84 / 84 v·ªÅ 0
  function normalizeVNPhone(raw) {
    let s = (raw || '').replace(/[^\d+]/g, '');
    if (s.startsWith('+84')) s = '0' + s.slice(3);
    else if (s.startsWith('84')) s = '0' + s.slice(2);
    return s;
  }

  // Di ƒë·ªông: 03/05/07/08/09 + 8 s·ªë (10 s·ªë)
  // C·ªë ƒë·ªãnh: 02 + 9 s·ªë (t·ªïng 11 s·ªë, v√≠ d·ª• 024/028 + 8 s·ªë)
  function isValidVNPhone(phone) {
    return /^(0(3|5|7|8|9)\d{8}|02\d{9})$/.test(phone);
  }

  // H√†m hi·ªÉn th·ªã toast notification
  function showToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container');
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    setTimeout(() => toast.remove(), 3000);
  }

  // H√†m th√™m d√≤ng m·ªõi v√†o b·∫£ng
  function appendAddressToTable(address) {
    const tableBody = document.getElementById('addressTableBody');
    const row = document.createElement('tr');
    row.setAttribute('data-id', address.id);
    row.innerHTML = `
      <td>${address.nguoiNhan || address.nguoiDung.hoTen}</td>
      <td>${address.soDienThoaiNguoiNhan || address.nguoiDung.soDienThoai}</td>

      <td class="address-cell" title="${address.tinhThanhPho}, ${address.quanHuyen}, ${address.phuongXa}, ${address.chiTietDiaChi}">
        ${address.tinhThanhPho}, ${address.quanHuyen}, ${address.phuongXa}, ${address.chiTietDiaChi}
      </td>
      <td>${address.macDinh ? '<span class="badge bg-success">M·∫∑c ƒë·ªãnh</span>' : ''}</td>
      <td>
        <button class="btn btn-primary btn-sm edit-address-btn" data-id="${address.id}" data-bs-target="#editAddressModal${address.id}">
          <i class="fas fa-edit"></i>
        </button>
        ${!address.macDinh ? `<button class="btn btn-secondary btn-sm set-default-btn" data-id="${address.id}">ƒê·∫∑t m·∫∑c ƒë·ªãnh</button>` : ''}
      </td>
    `;
    tableBody.appendChild(row);
    bindAddressEventListeners();
  }

  // H√†m c·∫≠p nh·∫≠t d√≤ng trong b·∫£ng
  function updateAddressInTable(address) {
    const row = document.querySelector(`tr[data-id="${address.id}"]`);
    if (row) {
      row.innerHTML = `
        <td>${address.nguoiDung.hoTen}</td>
        <td>${address.nguoiDung.soDienThoai}</td>
        <td class="address-cell" title="${address.tinhThanhPho}, ${address.quanHuyen}, ${address.phuongXa}, ${address.chiTietDiaChi}">
          ${address.tinhThanhPho}, ${address.quanHuyen}, ${address.phuongXa}, ${address.chiTietDiaChi}
        </td>
        <td>${address.macDinh ? '<span class="badge bg-success">M·∫∑c ƒë·ªãnh</span>' : ''}</td>
        <td>
          <button class="btn btn-primary btn-sm edit-address-btn" data-id="${address.id}" data-bs-target="#editAddressModal${address.id}">
            <i class="fas fa-edit"></i>
          </button>
          ${!address.macDinh ? `<button class="btn btn-secondary btn-sm set-default-btn" data-id="${address.id}">ƒê·∫∑t m·∫∑c ƒë·ªãnh</button>` : ''}
        </td>
      `;
      bindAddressEventListeners();
    }
  }

  // H√†m x√≥a d√≤ng kh·ªèi b·∫£ng
  function removeAddressFromTable(addressId) {
    const row = document.querySelector(`tr[data-id="${addressId}"]`);
    if (row) row.remove();
  }

  // L·∫•y CSRF token
  const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

  // ===== GHN: Provinces/Districts/Wards (REPLACE) =====
  async function fetchProvinces() {
    try {
      const res  = await fetch('/api/ghn/provinces');
      const json = await res.json();
      const list = JSON.parse(json.data)?.data || [];

      const provinceSelects = document.querySelectorAll(
              'select[id^="addTinhThanhPho"], select[id^="editTinhThanhPho"]'
      );
      provinceSelects.forEach(select => {
        select.innerHTML = '<option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>';
        list.forEach(p => {
          const opt = document.createElement('option');
          opt.value       = p.ProvinceName; // gi·ªØ value l√† t√™n
          opt.textContent = p.ProvinceName;
          opt.dataset.id  = p.ProvinceID;   // GHN ProvinceID
          select.appendChild(opt);
        });
      });
      return list;
    } catch (e) { console.error(e); showToast('L·ªói t·∫£i t·ªânh/th√†nh ph·ªë', 'danger'); return []; }
  }

  async function fetchDistricts(provinceId, districtSelect, wardSelect) {
    try {
      const res  = await fetch(`/api/ghn/districts?provinceId=${provinceId}`);
      const json = await res.json();
      const list = JSON.parse(json.data)?.data || [];

      districtSelect.innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
      wardSelect.innerHTML     = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';

      list.forEach(d => {
        const opt = document.createElement('option');
        opt.value       = d.DistrictName; // t√™n
        opt.textContent = d.DistrictName;
        opt.dataset.id  = d.DistrictID;   // GHN DistrictID
        districtSelect.appendChild(opt);
      });
    } catch (e) { console.error(e); showToast('L·ªói t·∫£i qu·∫≠n/huy·ªán', 'danger'); }
  }

  async function fetchWards(districtId, wardSelect) {
    try {
      const res  = await fetch(`/api/ghn/wards?districtId=${districtId}`);
      const json = await res.json();
      const list = JSON.parse(json.data)?.data || [];

      wardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
      list.forEach(w => {
        const opt = document.createElement('option');
        opt.value        = w.WardName; // t√™n
        opt.textContent  = w.WardName;
        opt.dataset.code = w.WardCode; // GHN WardCode
        wardSelect.appendChild(opt);
      });
    } catch (e) { console.error(e); showToast('L·ªói t·∫£i ph∆∞·ªùng/x√£', 'danger'); }
  }

  // H√†m thi·∫øt l·∫≠p gi√° tr·ªã hi·ªán t·∫°i cho select
  function setSelectValue(selectElement, value) {
    if (value && selectElement) {
      const options = selectElement.querySelectorAll('option');
      for (let option of options) {
        if (option.value === value) {
          option.selected = true;
          break;
        }
      }
    }
  }

  // H√†m thi·∫øt l·∫≠p ƒë·ªãa ch·ªâ cho form edit khi modal ƒë∆∞·ª£c m·ªü
  // ===== GHN: setup form Edit (REPLACE) =====
  function setupEditForm(addressId, currentProvince, currentDistrict, currentWard) {
    const provinceSelect = document.getElementById(`editTinhThanhPho${addressId}`);
    const districtSelect = document.getElementById(`editQuanHuyen${addressId}`);
    const wardSelect     = document.getElementById(`editPhuongXa${addressId}`);
    if (!provinceSelect || !districtSelect || !wardSelect) return;

    setSelectValue(provinceSelect, currentProvince);
    const pId = Number(provinceSelect.selectedOptions[0]?.dataset.id);
    if (!pId) return;

    fetchDistricts(pId, districtSelect, wardSelect).then(() => {
      setSelectValue(districtSelect, currentDistrict);
      const dId = Number(districtSelect.selectedOptions[0]?.dataset.id);
      if (!dId) return;

      fetchWards(dId, wardSelect).then(() => {
        setSelectValue(wardSelect, currentWard);
      });
    });
  }

  // H√†m x·ª≠ l√Ω khi nh·∫•n n√∫t ch·ªânh s·ª≠a ƒë·ªãa ch·ªâ
  document.querySelectorAll('.edit-address-btn').forEach(button => {
    button.addEventListener('click', function () {
      const addressId = this.getAttribute('data-id'); // L·∫•y ID c·ªßa ƒë·ªãa ch·ªâ
      const modal = document.getElementById('editAddressModal' + addressId); // T√¨m modal t∆∞∆°ng ·ª©ng v·ªõi ID
      const nguoiNhan = this.closest('tr').querySelector('td:nth-child(1)').innerText; // L·∫•y t√™n ng∆∞·ªùi nh·∫≠n
      const soDienThoai = this.closest('tr').querySelector('td:nth-child(2)').innerText; // L·∫•y s·ªë ƒëi·ªán tho·∫°i

      // ƒêi·ªÅn th√¥ng tin v√†o modal
      modal.querySelector('input[name="nguoiNhan"]').value = nguoiNhan;
      modal.querySelector('input[name="soDienThoaiNguoiNhan"]').value = soDienThoai;

      // Hi·ªÉn th·ªã modal
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
    });
  });


  // H√†m bind s·ª± ki·ªán cho c√°c n√∫t
  function bindAddressEventListeners() {
    document.querySelectorAll('.edit-address-btn').forEach(btn => {
      btn.removeEventListener('click', editAddressHandler);
      btn.addEventListener('click', editAddressHandler);
    });

    document.querySelectorAll('.delete-address-btn').forEach(btn => {
      btn.removeEventListener('click', deleteAddressHandler);
      btn.addEventListener('click', deleteAddressHandler);
    });

    document.querySelectorAll('.set-default-btn').forEach(btn => {
      btn.removeEventListener('click', setDefaultHandler);
      btn.addEventListener('click', setDefaultHandler);
    });

    document.querySelectorAll('.update-address-btn').forEach(btn => {
      btn.removeEventListener('click', updateAddressHandler);
      btn.addEventListener('click', updateAddressHandler);
    });
  }

  function editAddressHandler() {
    const modalId = this.getAttribute('data-bs-target');
    const modal = document.querySelector(modalId);
    if (modal) {
      bootstrap.Modal.getOrCreateInstance(modal).show();
    } else {
      console.error(`Modal ${modalId} not found`);
      showToast('Kh√¥ng t√¨m th·∫•y modal ch·ªânh s·ª≠a', 'danger');
    }
  }

  function deleteAddressHandler() {
    if (!confirm('X√≥a ƒë·ªãa ch·ªâ n√†y?')) return;
    const addressId = this.dataset.id;
    const headers = { 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
    fetch(`/profile/address/${addressId}/delete-ajax`, {
      method: 'POST',
      headers
    })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(data => {
              if (data.status === 'success') {
                removeAddressFromTable(addressId);
                showToast(data.message);
              } else {
                showToast(data.message, 'danger');
              }
            })
            .catch(err => showToast('C√≥ l·ªói x·∫£y ra: ' + err.message, 'danger'));
  }

  function setDefaultHandler() {
    const addressId = this.dataset.id;
    const button = this;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ƒêang x·ª≠ l√Ω...';
    const headers = { 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
    fetch(`/profile/address/${addressId}/set-default-ajax`, {
      method: 'POST',
      headers
    })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(data => {
              if (data.status === 'success') {
                showToast(data.message);
                if (data.logout) {
                  // Backend ƒë√£ x√≥a session, chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p
                  setTimeout(() => {
                    window.location.href = data.redirect || '/login'; // s·ª≠a URL n·∫øu kh√°c
                  }, 600);
                } else {
                  setTimeout(() => location.reload(), 1000);
                }
              } else {
                showToast(data.message, 'danger');
              }
            })
            .catch(err => {
              showToast('C√≥ l·ªói x·∫£y ra: ' + err.message, 'danger');
              button.disabled = false;
              button.innerHTML = 'ƒê·∫∑t m·∫∑c ƒë·ªãnh';
            });
  }

  function phoneCharError(raw) {
    if (/[^0-9\s().\-+]/.test(raw)) return 'invalid_char';
    if (/\+/.test(raw) && !raw.trim().startsWith('+')) return 'plus_not_at_start';
    return null; // ok
  }

  function runUpdateAddress(addressId) {
    const nameInput  = document.getElementById(`editNguoiNhan${addressId}`);
    const phoneInput = document.getElementById(`editSoDienThoaiNguoiNhan${addressId}`);

    // validate t√™n
    let nguoiNhan = cleanPersonName(nameInput.value);
    if (!isValidPersonName(nguoiNhan)) {
      showToast('T√™n ng∆∞·ªùi nh·∫≠n kh√¥ng h·ª£p l·ªá. Ch·ªâ ch·ª©a ch·ªØ v√† kho·∫£ng tr·∫Øng, kh√¥ng d∆∞ kho·∫£ng tr·∫Øng.', 'danger');
      nameInput.focus();
      return;
    }

    // validate SƒêT
    const rawPhone = phoneInput.value;
    const charErr = phoneCharError(rawPhone);
    if (charErr) {
      showToast('S·ªë ƒëi·ªán tho·∫°i ch·ªâ ƒë∆∞·ª£c ch·ª©a s·ªë, kho·∫£ng tr·∫Øng, ., -, (, ) v√† c√≥ th·ªÉ b·∫Øt ƒë·∫ßu b·∫±ng +84.', 'danger');
      phoneInput.focus();
      return;
    }
    let soDienThoaiNguoiNhan = normalizeVNPhone(rawPhone);
    if (!isValidVNPhone(soDienThoaiNguoiNhan)) {
      showToast('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. V√≠ d·ª• di ƒë·ªông: 09xxxxxxxx; c·ªë ƒë·ªãnh: 024/028 + 8 s·ªë.', 'danger');
      phoneInput.focus();
      return;
    }

    // validate ƒë·ªãa ch·ªâ chi ti·∫øt
    const chiTietEl = document.getElementById(`editChiTietDiaChi${addressId}`);
    let chiTietDiaChi = cleanAddressDetail(chiTietEl.value);
    if (!isValidAddressDetail(chiTietDiaChi)) {
      showToast('ƒê·ªãa ch·ªâ chi ti·∫øt kh√¥ng h·ª£p l·ªá. Kh√¥ng ch·ª©a c√°c k√Ω t·ª±: < > " \\ | ? * % $ ! ~ ^ = & { } [ ] ; v√† kh√¥ng c√≥ kho·∫£ng tr·∫Øng d∆∞ th·ª´a (3‚Äì200 k√Ω t·ª±).', 'danger');
      chiTietEl.focus();
      return;
    }

    const pSel = document.getElementById(`editTinhThanhPho${addressId}`);
    const dSel = document.getElementById(`editQuanHuyen${addressId}`);
    const wSel = document.getElementById(`editPhuongXa${addressId}`);

    const provinceId = Number(pSel?.selectedOptions[0]?.dataset.id) || null;
    const districtId = Number(dSel?.selectedOptions[0]?.dataset.id) || null;
    const wardCode   =        wSel?.selectedOptions[0]?.dataset.code || null;

    const data = {
      id: document.getElementById(`editId${addressId}`).value,
      nguoiNhan,
      soDienThoaiNguoiNhan,
      tinhThanhPho: document.getElementById(`editTinhThanhPho${addressId}`).value,
      quanHuyen: document.getElementById(`editQuanHuyen${addressId}`).value,
      phuongXa: document.getElementById(`editPhuongXa${addressId}`).value,
      chiTietDiaChi: chiTietDiaChi,
      macDinh: document.getElementById(`editMacDinh${addressId}`).checked,
      provinceId,
      districtId,
      wardCode
    };

    if (!data.tinhThanhPho || !data.quanHuyen || !data.phuongXa || !data.chiTietDiaChi) {
      showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng ƒë·ªãa ch·ªâ', 'danger');
      return;
    }

    const headers = { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

    fetch(`/profile/address/${addressId}/update-ajax`, {
      method: 'POST', headers, body: JSON.stringify(data)
    })
            .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`); return res.json(); })
            .then(data => {
              if (data.status === 'success') {
                updateAddressInTable(data.address);
                bootstrap.Modal.getInstance(document.getElementById(`editAddressModal${addressId}`)).hide();
                showToast(data.message);
              } else {
                showToast(data.message, 'danger');
              }
            })
            .catch(err => showToast('C√≥ l·ªói x·∫£y ra: ' + err.message, 'danger'));
  }

  function updateAddressHandler(e) {
    e.preventDefault();           // ‚¨ÖÔ∏è quan tr·ªçng
    const addressId = this.dataset.id;
    runUpdateAddress(addressId);
  }

  // Th√™m ƒë·ªãa ch·ªâ
  document.getElementById('addAddressForm')?.addEventListener('submit', function (e) {
    e.preventDefault();

    const nameInput  = document.getElementById('addNguoiNhan');
    const phoneInput = document.getElementById('addSoDienThoaiNguoiNhan');

    // --- Validate t√™n ---
    let nguoiNhan = cleanPersonName(nameInput.value);
    if (!isValidPersonName(nguoiNhan)) {
      showToast('T√™n ng∆∞·ªùi nh·∫≠n kh√¥ng h·ª£p l·ªá. Ch·ªâ ch·ª©a ch·ªØ v√† kho·∫£ng tr·∫Øng, kh√¥ng d∆∞ kho·∫£ng tr·∫Øng.', 'danger');
      nameInput.focus();
      return;
    }

    // --- Validate SƒêT ---
    let soDienThoaiNguoiNhan = normalizeVNPhone(phoneInput.value);
    if (!isValidVNPhone(soDienThoaiNguoiNhan)) {
      showToast('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. V√≠ d·ª• di ƒë·ªông: 09xxxxxxxx; c·ªë ƒë·ªãnh: 024/028 + 8 s·ªë.', 'danger');
      phoneInput.focus();
      return;
    }

    let chiTietDiaChi = cleanAddressDetail(document.getElementById('addChiTietDiaChi').value);
    if (!isValidAddressDetail(chiTietDiaChi)) {
      showToast('ƒê·ªãa ch·ªâ chi ti·∫øt kh√¥ng h·ª£p l·ªá. Kh√¥ng ch·ª©a c√°c k√Ω t·ª±: < > " \' \\ | ? * % $ ! ~ ^ = & { } [ ] ; v√† kh√¥ng c√≥ kho·∫£ng tr·∫Øng d∆∞ th·ª´a (3‚Äì200 k√Ω t·ª±).', 'danger');
      document.getElementById('addChiTietDiaChi').focus();
      return;
    }

    // GHN: l·∫•y m√£ t·ª´ option ƒë∆∞·ª£c ch·ªçn
    const pSel = document.getElementById('addTinhThanhPho');
    const dSel = document.getElementById('addQuanHuyen');
    const wSel = document.getElementById('addPhuongXa');

    const provinceId = Number(pSel?.selectedOptions[0]?.dataset.id) || null;
    const districtId = Number(dSel?.selectedOptions[0]?.dataset.id) || null;
    const wardCode   =        wSel?.selectedOptions[0]?.dataset.code || null;

    const data = {
      nguoiNhan,
      soDienThoaiNguoiNhan,
      tinhThanhPho: document.getElementById('addTinhThanhPho').value,
      quanHuyen: document.getElementById('addQuanHuyen').value,
      phuongXa: document.getElementById('addPhuongXa').value,
      chiTietDiaChi: chiTietDiaChi,
      macDinh: document.getElementById('addMacDinh').checked,
      provinceId,
      districtId,
      wardCode
    };

    if (!data.tinhThanhPho || !data.quanHuyen || !data.phuongXa || !data.chiTietDiaChi) {
      showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng ƒë·ªãa ch·ªâ', 'danger');
      return;
    }

    const headers = { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

    fetch('/profile/address/add-ajax', {
      method: 'POST',
      headers,
      body: JSON.stringify(data)
    })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(data => {
              if (data.status === 'success') {
                const modalEl = document.getElementById('addAddressModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                showToast(data.message || 'Th√™m ƒë·ªãa ch·ªâ th√†nh c√¥ng');
                modalEl.addEventListener('hidden.bs.modal', () => {
                  if (data.redirect) window.location.href = data.redirect;
                  else window.location.reload();
                }, { once: true });
                modal?.hide();
                document.getElementById('addAddressForm').reset();
              } else {
                showToast(data.message || 'Kh√¥ng th·ªÉ th√™m ƒë·ªãa ch·ªâ', 'danger');
              }
            })
            .catch(err => showToast('C√≥ l·ªói x·∫£y ra: ' + err.message, 'danger'));
  });

  // ===== SweetAlert2 toast gi·ªëng trang thanh to√°n =====
  function swToast(message, type = 'success') {
    return Swal.fire({
      toast: true,
      position: 'top-end',
      icon: type,
      title: message,
      showConfirmButton: false,
      timer: 1800,
      timerProgressBar: true,
      zIndex: 20000
    });
  }

  // ===== X√°c nh·∫≠n tr∆∞·ªõc khi c·∫≠p nh·∫≠t h·ªì s∆° (AJAX) =====
  let initialProfile = {};
  document.addEventListener('DOMContentLoaded', function () {
    initialProfile = {
      hoTen: document.querySelector('input[name="hoTen"]')?.value || '',
      email: document.querySelector('input[name="email"]')?.value || '',
      soDienThoai: document.querySelector('input[name="soDienThoai"]')?.value || ''
    };
  });

  // Danh s√°ch thay ƒë·ªïi (gi·ªØ nguy√™n ho·∫∑c n√¢ng c·∫•p format)
  function buildChangesList(current) {
    const changes = [];
    if (current.hoTen !== initialProfile.hoTen)
      changes.push(`H·ªç t√™n: "<b>${initialProfile.hoTen}</b>" ‚Üí "<b>${current.hoTen}</b>"`);
    if (current.email !== initialProfile.email)
      changes.push(`Email: "<b>${initialProfile.email}</b>" ‚Üí "<b>${current.email}</b>"`);
    if (current.soDienThoai !== initialProfile.soDienThoai)
      changes.push(`SƒêT: "<b>${initialProfile.soDienThoai}</b>" ‚Üí "<b>${current.soDienThoai}</b>"`);
    if (current.matKhau)
      changes.push('M·∫≠t kh·∫©u: <i>(s·∫Ω thay ƒë·ªïi)</i>');
    return changes;
  }

  // Handler submit: confirm b·∫±ng SweetAlert2 (KH√îNG d√πng modal Bootstrap)
  document.getElementById('profileForm')?.addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = this;
    let hoTen = document.querySelector('input[name="hoTen"]').value.trim();

    // Ki·ªÉm tra n·∫øu h·ªç t√™n c√≥ d·∫•u c√°ch d∆∞ th·ª´a ·ªü ƒë·∫ßu v√† cu·ªëi chu·ªói
    if (hoTen !== document.querySelector('input[name="hoTen"]').value) {
      // N·∫øu c√≥ d·∫•u c√°ch th·ª´a ·ªü ƒë·∫ßu ho·∫∑c cu·ªëi, hi·ªÉn th·ªã th√¥ng b√°o l·ªói
      showToast('H·ªç t√™n kh√¥ng ƒë∆∞·ª£c c√≥ kho·∫£ng tr·∫Øng d∆∞ th·ª´a ·ªü ƒë·∫ßu v√† cu·ªëi.', 'danger');
      return;
    }

    // Lo·∫°i b·ªè t·∫•t c·∫£ kho·∫£ng tr·∫Øng d∆∞ th·ª´a gi·ªØa c√°c t·ª´ (n·∫øu c√≥)
    hoTen = hoTen.replace(/\s+/g, ' '); // Thay th·∫ø t·∫•t c·∫£ d·∫•u c√°ch d∆∞ th·ª´a b·∫±ng m·ªôt d·∫•u c√°ch duy nh·∫•t

    // Ki·ªÉm tra xem h·ªç t√™n c√≥ ph·∫£i l√† chu·ªói r·ªóng sau khi lo·∫°i b·ªè d·∫•u c√°ch kh√¥ng h·ª£p l·ªá
    if (hoTen === "") {
      showToast('H·ªç t√™n kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p h·ªç t√™n h·ª£p l·ªá.', 'danger');
      return;
    }

    // Bi·ªÉu th·ª©c ch√≠nh quy ki·ªÉm tra h·ªç t√™n (ch·ªâ ch·ª©a ch·ªØ c√°i v√† d·∫•u c√°ch h·ª£p l·ªá)
    const regex = /^[A-Za-z√Ä-·ªπ√†-·ªπ\s]+$/;

    // Ki·ªÉm tra n·∫øu h·ªç t√™n c√≥ k√Ω t·ª± kh√¥ng h·ª£p l·ªá ho·∫∑c c√≥ d·∫•u c√°ch d∆∞ th·ª´a
    if (!regex.test(hoTen)) {
      // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói n·∫øu h·ªç t√™n kh√¥ng h·ª£p l·ªá
      showToast('H·ªç t√™n kh√¥ng h·ª£p l·ªá. Vui l√≤ng ch·ªâ nh·∫≠p ch·ªØ c√°i v√† m·ªôt kho·∫£ng c√°ch gi·ªØa c√°c ph·∫ßn c·ªßa t√™n.', 'danger');
      return;
    }

    let soDienThoai = document.querySelector('input[name="soDienThoai"]').value.trim();

    // C·∫≠p nh·∫≠t l·∫°i bi·ªÉu th·ª©c ch√≠nh quy ƒë·ªÉ ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam (10 v√† 11 s·ªë)
    const regexSDT = /^(0(3|5|7|8|9)[0-9]{8}|02[0-9]{8})$/;

    // Ki·ªÉm tra n·∫øu s·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá
    if (!regexSDT.test(soDienThoai)) {
      showToast('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam h·ª£p l·ªá.', 'danger');
      return;
    }

    let email = document.querySelector('input[name="email"]').value.trim();

    if (email !== document.querySelector('input[name="email"]').value) {
      showToast('Email kh√¥ng ƒë∆∞·ª£c c√≥ kho·∫£ng tr·∫Øng d∆∞ th·ª´a ·ªü ƒë·∫ßu v√† cu·ªëi.', 'danger');
      return;
    }

    const regexEmail = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;

    if (!regexEmail.test(email)) {
      showToast('Email kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p email h·ª£p l·ªá.', 'danger');
      return;
    }

    let matKhau = document.querySelector('input[name="matKhau"]').value.trim();

    if (matKhau !== document.querySelector('input[name="matKhau"]').value) {
      showToast('M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c c√≥ kho·∫£ng tr·∫Øng d∆∞ th·ª´a ·ªü ƒë·∫ßu v√† cu·ªëi.', 'danger');
      return;
    }

    const regexMatKhau = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/;

    if (!regexMatKhau.test(matKhau)) {
      showToast('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±, bao g·ªìm c·∫£ ch·ªØ v√† s·ªë.', 'danger');
      return;
    }

    const current = {
      hoTen: form.querySelector('input[name="hoTen"]').value.trim(),
      email: form.querySelector('input[name="email"]').value.trim(),
      soDienThoai: form.querySelector('input[name="soDienThoai"]').value.trim(),
      matKhau: form.querySelector('input[name="matKhau"]').value
    };

    const changes = buildChangesList(current);

    if (!changes.length) {
      return swToast('B·∫°n ch∆∞a thay ƒë·ªïi th√¥ng tin n√†o', 'info');
    }

    const htmlList = `
    <div class="text-start">
      <p>B·∫°n s·∫Øp thay ƒë·ªïi c√°c th√¥ng tin sau:</p>
      <ul style="margin-left:1rem">${changes.map(c => `<li>${c}</li>`).join('')}</ul>
      <div class="alert alert-info mt-3 mb-0">
        Sau khi c·∫≠p nh·∫≠t, h·ªá th·ªëng s·∫Ω ƒëƒÉng xu·∫•t b·∫°n ƒë·ªÉ b·∫£o m·∫≠t.
      </div>
    </div>`;

    const { isConfirmed } = await Swal.fire({
      icon: 'question',
      title: 'X√°c nh·∫≠n c·∫≠p nh·∫≠t',
      html: htmlList,
      showCancelButton: true,
      confirmButtonText: 'X√°c nh·∫≠n',
      cancelButtonText: 'H·ªßy',
      confirmButtonColor: '#153054',  // ƒë·ªìng b·ªô m√†u v·ªõi checkout
      cancelButtonColor: '#d33',
      reverseButtons: true
    });

    if (isConfirmed) performUpdateProfile(form);
  });

  function performUpdateProfile(formEl) {
    const formData = new FormData(formEl);
    const button = document.getElementById('updateProfileBtn');

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> ƒêang c·∫≠p nh·∫≠t...';

    const headers = { 'X-Requested-With': 'XMLHttpRequest' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

    fetch('/profile', { method: 'POST', headers, body: formData })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(async data => {
              if (data.status === 'success') {
                await swToast(data.message || 'C·∫≠p nh·∫≠t th√†nh c√¥ng', 'success');
                // ƒêƒÉng xu·∫•t / chuy·ªÉn h∆∞·ªõng sau khi c·∫≠p nh·∫≠t
                window.location.href = data.redirect || '/logout';
              } else {
                swToast(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t', 'error');
              }
            })
            .catch(err => swToast('Vui l√≤ng nh·∫≠p ƒë√∫ng th√¥ng tin', 'error'))
            .finally(() => {
              button.disabled = false;
              button.innerHTML = '<i class="fas fa-save me-1"></i> C·∫≠p nh·∫≠t';
            });
  }

  // Kh·ªüi t·∫°o t·∫£i d·ªØ li·ªáu t·ªânh/th√†nh ph·ªë
  document.addEventListener('DOMContentLoaded', function () {
    bindAddressEventListeners();

    document.querySelectorAll('form[id^="editAddressForm"]').forEach(form => {
      form.addEventListener('submit', function(e){
        e.preventDefault();
        const addressId = this.id.replace('editAddressForm','');
        runUpdateAddress(addressId);
      });
    });

    // Thi·∫øt l·∫≠p d·ªØ li·ªáu cho form th√™m
    const addProvinceSelect = document.getElementById('addTinhThanhPho');
    const addDistrictSelect = document.getElementById('addQuanHuyen');
    const addWardSelect = document.getElementById('addPhuongXa');

    if (addProvinceSelect && addDistrictSelect && addWardSelect) {
      addProvinceSelect.addEventListener('change', function () {
        const provinceId = Number(this.selectedOptions[0]?.dataset.id);
        if (provinceId) fetchDistricts(provinceId, addDistrictSelect, addWardSelect);
        else {
          addDistrictSelect.innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
          addWardSelect.innerHTML     = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
        }
      });

      addDistrictSelect.addEventListener('change', function () {
        const districtId = Number(this.selectedOptions[0]?.dataset.id);
        if (districtId) fetchWards(districtId, addWardSelect);
        else addWardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
      });
    }

    // Thi·∫øt l·∫≠p d·ªØ li·ªáu cho c√°c form edit khi modal ƒë∆∞·ª£c m·ªü
    const editModals = document.querySelectorAll('[id^="editAddressModal"]');
    editModals.forEach(modal => {
      modal.addEventListener('show.bs.modal', function (event) {
        const addressId = modal.id.replace('editAddressModal', '');
        const provinceSelect = document.getElementById(`editTinhThanhPho${addressId}`);
        const districtSelect = document.getElementById(`editQuanHuyen${addressId}`);
        const wardSelect = document.getElementById(`editPhuongXa${addressId}`);

        if (provinceSelect && districtSelect && wardSelect) {
          const currentProvince = provinceSelect.getAttribute('data-current-value');
          const currentDistrict = districtSelect.getAttribute('data-current-value');
          const currentWard = wardSelect.getAttribute('data-current-value');

          setupEditForm(addressId, currentProvince, currentDistrict, currentWard);
        }
      });
    });

    // T·∫£i danh s√°ch t·ªânh/th√†nh ph·ªë
    fetchProvinces();
  });

  // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi t·ªânh/th√†nh ph·ªë v√† qu·∫≠n/huy·ªán cho c√°c form edit
  document.addEventListener('change', function(e) {
    // ===== GHN: handler EDIT (REPLACE these two branches) =====
    if (e.target.matches('select[id^="editTinhThanhPho"]')) {
      const addressId      = e.target.id.replace('editTinhThanhPho','');
      const districtSelect = document.getElementById(`editQuanHuyen${addressId}`);
      const wardSelect     = document.getElementById(`editPhuongXa${addressId}`);
      const provinceId     = Number(e.target.selectedOptions[0]?.dataset.id);

      if (provinceId) fetchDistricts(provinceId, districtSelect, wardSelect);
      else {
        districtSelect.innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
        wardSelect.innerHTML     = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
      }
    }

    if (e.target.matches('select[id^="editQuanHuyen"]')) {
      const addressId  = e.target.id.replace('editQuanHuyen','');
      const wardSelect = document.getElementById(`editPhuongXa${addressId}`);
      const districtId = Number(e.target.selectedOptions[0]?.dataset.id);

      if (districtId) fetchWards(districtId, wardSelect);
      else wardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
    }
  });
</script>
</body>
</html>