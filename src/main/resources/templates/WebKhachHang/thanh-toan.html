<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ACV Store - Thanh to√°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        button[disabled] {
            pointer-events: none;
            opacity: 0.5;
            cursor: not-allowed;
        }
        .navbar { background: linear-gradient(to right, #153054, #1e4066); }
        .ticker { background-color: #9FD5F7; color: #153054; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1050; }
        .dropdown-menu { display: none; position: absolute; background-color: white; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; }
        .dropdown:hover .dropdown-menu { display: block; }
        body { padding-top: 100px; }
        @media (max-width: 640px) {
            .dropdown-menu { width: 100%; left: 0; }
            body { padding-top: 80px; }
            .order-item-img { width: 60px; height: 60px; }
            .section-box { padding: 16px; }
            .container { padding: 0 16px; }
        }
        .section-box { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .section-box:hover { transform: translateY(-4px); box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .section-title { font-size: 20px; font-weight: 700; color: #153054; display: flex; align-items: center; }
        .order-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .form-control { border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px 14px; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .form-control:focus { border-color: #153054; box-shadow: 0 0 0 3px rgba(21, 48, 84, 0.1); outline: none; }
        .btn-primary { background: #153054; border: none; border-radius: 8px; padding: 12px; font-weight: 600; color: white; transition: background 0.3s ease, transform 0.2s ease; }
        .btn-primary:hover { background: #1e4066; transform: translateY(-2px); }
        .payment-method { padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s ease; }
        .payment-method:hover { border-color: #153054; background: #e0ebf5; }
        .payment-method.active { border-color: #153054; background: #e0ebf5; }
        .order-item { border-bottom: 1px solid #e5e7eb; padding-bottom: 16px; }
        .submit-btn { position: sticky; bottom: 20px; }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100">
<div class="ticker py-1 overflow-hidden fixed top-0 w-full z-50">
    <marquee behavior="scroll" direction="left" scrollamount="5">
        üéâ Khuy·∫øn m√£i ƒë·∫∑c bi·ªát: Gi·∫£m gi√° l√™n ƒë·∫øn 50% cho t·∫•t c·∫£ s·∫£n ph·∫©m h√¥m nay! üéâ - Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n t·ª´ 500k!
    </marquee>
</div>

<nav class="navbar fixed-top shadow-lg mt-10 z-40">
    <div class="container mx-auto flex items-center justify-between py-2 px-4">
        <a href="/" class="text-2xl font-bold text-white">ACV Store</a>
        <div class="relative dropdown">
            <button class="text-white font-semibold hover:text-[#9FD5F7] focus:outline-none">
                Danh m·ª•c <i class="fas fa-caret-down"></i>
            </button>
            <div class="dropdown-menu bg-white text-gray-800 rounded-md p-2 mt-2">
                <a href="/category/nam" class="block px-4 py-2 hover:bg-[#e0ebf5]">Th·ªùi trang Nam</a>
                <a href="/category/nu" class="block px-4 py-2 hover:bg-[#e0ebf5]">Th·ªùi trang N·ªØ</a>
                <a href="/category/phu-kien" class="block px-4 py-2 hover:bg-[#e0ebf5]">Ph·ª• ki·ªán</a>
                <a href="/category/gia-dung" class="block px-4 py-2 hover:bg-[#e0ebf5]">Gia d·ª•ng</a>
            </div>
        </div>
        <div class="flex-1 mx-4 max-w-2xl">
            <div class="relative">
                <input type="text" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." class="w-full py-2 px-4 rounded-full border-none focus:outline-none"/>
                <button class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white bg-[#153054] px-3 py-1 rounded-full">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <a href="/cart" class="text-white text-xl relative">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2 py-1">0</span>
            </a>
            <div th:if="${user != null}" class="dropdown">
                <button class="text-white font-semibold hover:text-[#9FD5F7] focus:outline-none dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-user-circle me-1"></i> <span th:text="${user.hoTen}">T√™n ng∆∞·ªùi d√πng</span>
                </button>
                <div class="dropdown-menu bg-white text-gray-800 rounded-md p-2 mt-2">
                    <a href="/account/profile" class="block px-4 py-2 hover:bg-[#e0ebf5]">T√†i kho·∫£n c·ªßa t√¥i</a>
                    <a href="/dsdon-mua" class="block px-4 py-2 hover:bg-[#e0ebf5]">ƒê∆°n mua</a>
                    <a href="/vi" class="block px-4 py-2 hover:bg-[#e0ebf5]">V√≠ thanh to√°n</a>
                    <a href="/customers/logout" class="block px-4 py-2 hover:bg-[#e0ebf5] text-danger">ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
            <a th:if="${user == null}" href="/customers/login" class="text-white font-semibold hover:text-[#9FD5F7] focus:outline-none">ƒêƒÉng nh·∫≠p</a>
        </div>
    </div>
</nav>

<section class="container mx-auto py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Thanh to√°n</h1>
    <div th:if="${error}" class="bg-red-100 text-red-700 p-4 rounded mb-4" th:text="${error}"></div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-user mr-2"></i> Th√¥ng tin kh√°ch h√†ng</h2>
                <form id="checkout-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n</label>
                            <input type="text" id="fullName" name="fullName" class="form-control w-full" th:value="${loggedInUser?.hoTen}" required/>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="phone" name="phone" class="form-control w-full" th:value="${loggedInUser?.soDienThoai}" required/>
                        </div>
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</label>
                        <input type="text" id="address" name="address" class="form-control w-full" th:value="${loggedInUser?.chiTietDiaChi}" required/>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 mt-4">
                        <select id="province" class="form-control" required>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>
                        </select>
                        <select id="district" class="form-control" required>
                            <option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>
                        </select>
                        <select id="ward" class="form-control" required>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="section-box" hidden>
                <h2 class="section-title mb-4"><i class="fas fa-truck mr-2"></i> Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn</h2>
                <select id="shippingMethod" name="shippingMethod" class="form-control w-full" required>
                    <option value="53321">Giao h√†ng nhanh (H√†ng nh·∫π)</option>
                    <option value="100039">Giao h√†ng ch·∫≠m (H√†ng n·∫∑ng)</option>
                </select>
            </div>

            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-credit-card mr-2"></i> Ph∆∞∆°ng th·ª©c thanh to√°n</h2>
                <div class="payment-method active" data-value="550E8400-E29B-41D4-A716-446655440017">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440017" checked>
                    <span class="ml-2 font-medium">Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
                </div>
                <div class="payment-method" data-value="550E8400-E29B-41D4-A716-446655440018">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440018">
                    <span class="ml-2 font-medium">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                </div>
                <div class="payment-method" data-value="550E8400-E29B-41D4-A716-446655440019">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440019">
                    <span class="ml-2 font-medium">V√≠ ƒëi·ªán t·ª≠</span>
                    <span id="wallet-balance" class="ml-2 text-sm text-gray-600">(ƒêang t·∫£i...)</span>
                </div>
            </div>

            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-sticky-note mr-2"></i> Ghi ch√∫</h2>
                <textarea id="note" name="note" class="form-control w-full" rows="4" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (t√πy ch·ªçn)"></textarea>
            </div>
        </div>

        <div class="section-box">
            <h2 class="section-title mb-4"><i class="fas fa-shopping-bag mr-2"></i> ƒê∆°n h√†ng</h2>
            <div id="order-items" class="space-y-4 mb-6"></div>
            <div class="border-t pt-4">
                <div class="flex justify-between mb-2 text-sm">
                    <span>T·∫°m t√≠nh:</span>
                    <span id="subtotal" class="font-semibold">0 VNƒê</span>
                </div>
                <div class="flex justify-between mb-2 text-sm">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                    <span id="shipping-fee" class="font-semibold">15,000 VNƒê</span>
                </div>
                <div class="flex justify-between mb-2 text-sm">
                    <span>Gi·∫£m gi√°:</span>
                    <span id="discount" class="font-semibold">0 VNƒê</span>
                </div>
                <div class="flex justify-between text-lg font-bold">
                    <span>T·ªïng ti·ªÅn:</span>
                    <span id="total" class="text-[#153054]">15,000 VNƒê</span>
                </div>
            </div>
            <div class="mt-6">
                <label for="voucher" class="block text-sm font-medium text-gray-700 mb-1">M√£ gi·∫£m gi√°</label>
                <select id="voucher" name="voucher" class="form-control w-full">
                    <option value="">-- Ch·ªçn m√£ gi·∫£m gi√° --</option>
                    <th:block th:each="voucher : ${vouchers}">
                        <option th:value="${voucher.ma}" th:text="${voucher.ten} + ' (T·ªëi thi·ªÉu: ' + ${#numbers.formatDecimal(voucher.giaTriGiamToiThieu, 0, 'COMMA', 0, 'POINT')} + ' VNƒê)'"></option>
                    </th:block>
                </select>
            </div>
            <button id="submit-order" class="btn btn-primary w-full mt-6 submit-btn">
                <i class="fas fa-check-circle mr-2"></i> ƒê·∫∑t h√†ng
            </button>
        </div>
    </div>
</section>

<!-- Floating Chatbot Icon -->
<div id="chatbot-toggle" style="position: fixed; bottom: 20px; right: 20px; background-color: #153054; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10000; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
    <i class="fas fa-robot fa-lg text-white"></i>
</div>

<!-- Chatbot Box -->
<div id="chatbot-box" style="
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 420px;
    max-height: 620px;
    background: #fff;
    border-radius: 7px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    display: none;
    flex-direction: column;
    overflow: hidden;
    z-index: 10000;
    font-family: 'Segoe UI', sans-serif;
  ">
    <div style="background-color: #153054; color: white; padding: 12px 16px; display: flex; align-items: center; gap: 10px;">
        <img src="https://img.icons8.com/emoji/48/robot-emoji.png" style="width: 32px; height: 32px;">
        <div style="font-weight: bold;">ACV Bot</div>
        <span id="chatbot-close" style="margin-left: auto; cursor: pointer;">√ó</span>
    </div>
    <div id="chat-messages" style="padding: 12px; height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.4; background: #f9fafb;">
        <div id="typing-indicator" class="chatbot-msg-bot hidden">ƒêang g√µ...</div>
    </div>
    <div id="quick-replies" class="flex flex-wrap gap-2 p-4">
        <button class="quick-reply px-3 py-1 bg-blue-100 rounded-full text-sm">S·∫£n ph·∫©m m·ªõi nh·∫•t</button>
        <button class="quick-reply px-3 py-1 bg-blue-100 rounded-full text-sm">Ki·ªÉm tra ƒë∆°n h√†ng</button>
        <button class="quick-reply px-3 py-1 bg-blue-100 rounded-full text-sm">Ch√≠nh s√°ch ƒë·ªïi tr·∫£</button>
    </div>
    <div style="padding: 10px; border-top: 1px solid #eee;">
        <input id="chat-input" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi..." style="
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #ccc;
        border-radius: 24px;
        font-size: 15px;
        outline: none;
        transition: border 0.2s ease-in-out;
      ">
    </div>
</div>

<footer style="background: linear-gradient(to right, #153054, #1e4066); color: white; padding-top: 30px; padding-bottom: 20px">
    <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
            <h3 class="text-lg font-bold mb-4">ACV Store</h3>
            <p class="text-sm">C·ª≠a h√†ng th·ªùi trang h√†ng ƒë·∫ßu v·ªõi c√°c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng v√† gi√° c·∫£ h·ª£p l√Ω.</p>
            <div class="mt-4">
                <h4 class="text-sm font-semibold">ƒêƒÉng k√Ω nh·∫≠n tin</h4>
                <form class="flex gap-2 mt-2">
                    <input type="email" class="w-full p-2 rounded border" placeholder="Nh·∫≠p email c·ªßa b·∫°n" aria-label="Email ƒëƒÉng k√Ω nh·∫≠n tin">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">ƒêƒÉng k√Ω</button>
                </form>
            </div>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Li√™n k·∫øt nhanh</h3>
            <ul class="space-y-2">
                <li><a href="/new" class="hover:text-blue-300">S·∫£n ph·∫©m m·ªõi</a></li>
                <li><a href="/all" class="hover:text-blue-300">T·ªß ƒë·ªì m√πa h√®</a></li>
                <li><a href="/bestsellers" class="hover:text-blue-300">S·∫£n ph·∫©m b√°n ch·∫°y</a></li>
            </ul>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Li√™n h·ªá</h3>
            <p class="text-sm">Email: datn.acv@gmail.com</p>
            <p class="text-sm">Hotline: 1900 8686</p>
            <div class="flex space-x-4 mt-4">
                <a href="#" class="text-white hover:text-blue-300" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="text-white hover:text-blue-300" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" class="text-white hover:text-blue-300" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </div>
    <div class="text-center mt-8 text-sm">¬© 2025 ACV Store. All rights reserved.</div>
</footer>

<button id="back-to-top" class="fixed bottom-20 right-20 bg-blue-600 text-white p-3 rounded-full shadow-lg hidden" aria-label="Quay l·∫°i ƒë·∫ßu trang">
    <i class="fas fa-arrow-up"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let provinceList = [];
    let districtList = [];

    // Format number to VND
    function formatVND(number) {
        return new Intl.NumberFormat('vi-VN', { style: 'decimal', minimumFractionDigits: 0 }).format(number) + ' VNƒê';
    }

    // Check if the checkout is from cart
    function isFromCart() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('from') === 'cart';
    }

    // Load t·ªânh/th√†nh ph·ªë t·ª´ GHN API
    async function loadProvinces() {
        try {
            const response = await fetch('/api/ghn/provinces');
            const json = await response.json();
            if (!json || !json.data) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu t·ªânh/th√†nh");

            const result = JSON.parse(json.data);
            provinceList = result.data;

            const provinceSelect = document.getElementById('province');
            provinceList.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.ProvinceID;
                opt.textContent = p.ProvinceName;
                provinceSelect.appendChild(opt);
            });
        } catch (err) {
            console.error('L·ªói t·∫£i t·ªânh/th√†nh:', err);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói t·∫£i t·ªânh/th√†nh',
                text: err.message
            });
        }
    }

    // Load s·ªë d∆∞ v√≠
    async function loadWalletBalance() {
        const walletBalanceElement = document.getElementById('wallet-balance');
        walletBalanceElement.textContent = '(ƒêang t·∫£i...)';
        walletBalanceElement.classList.add('loading');
        try {
            const response = await fetch('/api/wallet/balance', { credentials: 'include' });
            const data = await response.json();
            if (response.ok && data.success) {
                const balance = data.data || 0;
                walletBalanceElement.textContent = `(S·ªë d∆∞: ${formatVND(balance)})`;
            } else {
                walletBalanceElement.textContent = '(Kh√¥ng c√≥ v√≠)';
                Swal.fire({
                    icon: 'warning',
                    title: 'C·∫£nh b√°o',
                    text: data.message || 'Kh√¥ng th·ªÉ t·∫£i s·ªë d∆∞ v√≠. Vui l√≤ng th·ª≠ l·∫°i!',
                });
            }
        } catch (err) {
            console.error('L·ªói t·∫£i s·ªë d∆∞ v√≠:', err);
            walletBalanceElement.textContent = '(L·ªói t·∫£i s·ªë d∆∞)';
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'Kh√¥ng th·ªÉ t·∫£i s·ªë d∆∞ v√≠. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi!',
            });
        } finally {
            walletBalanceElement.classList.remove('loading');
        }
    }

    // Load qu·∫≠n/huy·ªán d·ª±a v√†o t·ªânh ƒë∆∞·ª£c ch·ªçn
    async function loadDistricts(provinceId) {
        try {
            const response = await fetch(`/api/ghn/districts?provinceId=${provinceId}`);
            const json = await response.json();
            if (!json || !json.data) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu qu·∫≠n/huy·ªán");

            const result = JSON.parse(json.data);
            districtList = result.data;

            const select = document.getElementById('district');
            select.innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
            districtList.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.DistrictID;
                opt.textContent = d.DistrictName;
                select.appendChild(opt);
            });

            document.getElementById('ward').innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
        } catch (err) {
            console.error('L·ªói t·∫£i qu·∫≠n/huy·ªán:', err);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói t·∫£i qu·∫≠n/huy·ªán',
                text: err.message
            });
        }
    }

    // Load ph∆∞·ªùng/x√£ d·ª±a v√†o qu·∫≠n ƒë∆∞·ª£c ch·ªçn
    async function loadWards(districtId) {
        try {
            const response = await fetch(`/api/ghn/wards?districtId=${districtId}`);
            const json = await response.json();
            if (!json || !json.data) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu ph∆∞·ªùng/x√£");

            const result = JSON.parse(json.data);
            const wards = result.data;

            const select = document.getElementById('ward');
            select.innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
            wards.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.WardCode;
                opt.textContent = w.WardName;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error('L·ªói t·∫£i ph∆∞·ªùng/x√£:', err);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói t·∫£i ph∆∞·ªùng/x√£',
                text: err.message
            });
        }
    }

    // Load d·ªãch v·ª• v·∫≠n chuy·ªÉn
    async function loadShippingServices(toDistrictId) {
        const fromDistrictId = 1542;
        try {
            const res = await fetch(`/api/ghn/available-services?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}`);
            const json = await res.json();
            const services = JSON.parse(json.data).data;

            const select = document.getElementById('shippingMethod');
            select.innerHTML = '';

            services.forEach(service => {
                const opt = document.createElement('option');
                opt.value = service.service_id;
                opt.textContent = service.short_name + ` (${service.service_type_id})`;
                select.appendChild(opt);
            });

            if (services.length > 0) {
                select.value = services[0].service_id;
                await calculateShipping();
            }
        } catch (err) {
            console.error("L·ªói t·∫£i d·ªãch v·ª• v·∫≠n chuy·ªÉn:", err);
            Swal.fire({ icon: 'error', title: 'L·ªói', text: 'Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªãch v·ª• v·∫≠n chuy·ªÉn: ' + err.message });
        }
    }

    // T√≠nh ph√≠ v·∫≠n chuy·ªÉn
    async function calculateShipping() {
        const toDistrictId = document.getElementById('district').value;
        const toWardCode = document.getElementById('ward').value;
        const serviceId = document.getElementById('shippingMethod').value;
        const fromDistrictId = 1542;

        if (!toDistrictId || !toWardCode || !serviceId) return;

        try {
            const response = await fetch(`/api/ghn/shipping-fee?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}&toWardCode=${toWardCode}&weight=500&length=20&width=15&height=10&serviceId=${serviceId}&insuranceValue=100000`);
            const json = await response.json();
            const fee = JSON.parse(json.data).data.total;

            document.getElementById('shipping-fee').textContent = formatVND(fee);
            updateTotal();
        } catch (err) {
            console.error('L·ªói t√≠nh ph√≠ v·∫≠n chuy·ªÉn:', err);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói t√≠nh ph√≠ v·∫≠n chuy·ªÉn',
                text: err.message
            });
        }
    }

    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
    function updateTotal() {
        const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace(/[^\d]/g, '')) || 0;
        const shipping = parseFloat(document.getElementById('shipping-fee').textContent.replace(/[^\d]/g, '')) || 0;
        const discount = parseFloat(document.getElementById('discount').textContent.replace(/[^\d]/g, '')) || 0;
        document.getElementById('total').textContent = formatVND(subtotal + shipping - discount);
    }

    // Load ƒë·ªãa ch·ªâ ƒë√£ l∆∞u
    async function loadSavedAddress() {
        try {
            const res = await fetch("/api/checkout/addresses");
            const data = await res.json();

            const normalize = str =>
                str
                    ?.toLowerCase()
                    .replace(/(t·ªânh|th√†nh ph·ªë)/gi, "")
                    .replace(/[\s\.\-]/g, "")
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "");

            const provinceRes = await fetch("/api/ghn/provinces");
            const provinceJson = await provinceRes.json();
            const provinceList = JSON.parse(provinceJson.data).data;

            const province = provinceList.find(p =>
                normalize(p.ProvinceName).includes(normalize(data.tinhThanhPho))
            );

            if (!province) throw new Error("Kh√¥ng t√¨m th·∫•y t·ªânh t∆∞∆°ng ·ª©ng");

            document.querySelector("#province").value = province.ProvinceID;

            await loadDistricts(province.ProvinceID);
            const districtRes = await fetch(`/api/ghn/districts?provinceId=${province.ProvinceID}`);
            const districtJson = await districtRes.json();
            const districtList = JSON.parse(districtJson.data).data;

            const district = districtList.find(d =>
                normalize(d.DistrictName).includes(normalize(data.quanHuyen))
            );
            if (!district) throw new Error("Kh√¥ng t√¨m th·∫•y qu·∫≠n/huy·ªán t∆∞∆°ng ·ª©ng");
            document.querySelector("#district").value = district.DistrictID;

            await loadWards(district.DistrictID);
            const wardRes = await fetch(`/api/ghn/wards?districtId=${district.DistrictID}`);
            const wardJson = await wardRes.json();
            const wardList = JSON.parse(wardJson.data).data;

            const ward = wardList.find(w =>
                normalize(w.WardName).includes(normalize(data.phuongXa))
            );
            if (!ward) throw new Error("Kh√¥ng t√¨m th·∫•y ph∆∞·ªùng/x√£ t∆∞∆°ng ·ª©ng");
            document.querySelector("#ward").value = ward.WardCode;

            document.querySelector("#address").value = data.chiTietDiaChi || "";
            await loadShippingServices(district.DistrictID);
            await calculateShipping();
        } catch (err) {
            console.error("L·ªói khi t·∫£i ƒë·ªãa ch·ªâ:", err);
            Swal.fire({
                icon: "error",
                title: "L·ªói ƒë·ªãa ch·ªâ",
                text: err.message
            });
        }
    }

    // Load danh s√°ch s·∫£n ph·∫©m trong ƒë∆°n h√†ng
    async function loadOrderItems() {
        const orderItemsContainer = document.getElementById('order-items');
        let subtotal = 0;
        let items = [];
        let source = '';

        if (isFromCart()) {
            try {
                const response = await fetch('/api/cart', { credentials: 'include' });
                if (response.ok) {
                    const cartData = await response.json();
                    items = cartData.chiTietGioHang.map(item => ({
                        chiTietSanPhamId: item.chiTietSanPham.id,
                        tenSanPham: item.chiTietSanPham.sanPham.tenSanPham,
                        soLuong: item.soLuong,
                        gia: item.gia,
                        urlHinhAnh: item.chiTietSanPham.urlHinhAnh || '/images/default-product.jpg',
                        sizeName: item.chiTietSanPham.kichCo.ten,
                        colorName: item.chiTietSanPham.mauSac.tenMau
                    }));
                    subtotal = items.reduce((sum, item) => sum + item.gia * item.soLuong, 0);
                    source = 'Gi·ªè h√†ng (API /cart)';
                    console.log('Ngu·ªìn d·ªØ li·ªáu:', source, items);
                } else {
                    console.log('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng t·ª´ API /cart. Tr·∫°ng th√°i:', response.status);
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói',
                        text: 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!',
                    });
                }
            } catch (error) {
                console.error('L·ªói khi t·∫£i gi·ªè h√†ng:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!',
                });
            }
        } else {
            const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
            if (checkoutItem) {
                items = [checkoutItem];
                subtotal = checkoutItem.gia * checkoutItem.soLuong;
                source = 'Mua ngay (localStorage.checkoutItem)';
                console.log('Ngu·ªìn d·ªØ li·ªáu:', source, items);
            }
        }

        if (items.length === 0) {
            orderItemsContainer.innerHTML = `<p class="text-gray-600">Kh√¥ng c√≥ s·∫£n ph·∫©m trong ${isFromCart() ? 'gi·ªè h√†ng' : 'ƒë∆°n h√†ng'}.</p>`;
            document.getElementById('submit-order').disabled = true;
            return;
        }

        orderItemsContainer.innerHTML = items.map(item => `
            <div class="order-item flex items-center space-x-4">
                <img src="${item.urlHinhAnh}" alt="${item.tenSanPham}" class="order-item-img"/>
                <div class="flex-1">
                    <h6 class="font-semibold text-gray-800">${item.tenSanPham}</h6>
                    <p class="text-gray-600 text-sm">K√≠ch c·ª°: ${item.sizeName || 'N/A'}</p>
                    <p class="text-gray-600 text-sm">M√†u s·∫Øc: ${item.colorName || 'N/A'}</p>
                    <p class="text-gray-600 text-sm">S·ªë l∆∞·ª£ng: ${item.soLuong}</p>
                    <p class="text-gray-600 text-sm">ƒê∆°n gi√°: ${formatVND(item.gia)}</p>
                    <p class="text-[#153054] font-bold">Th√†nh ti·ªÅn: ${formatVND(item.gia * item.soLuong)}</p>
                </div>
            </div>
        `).join('');

        const shippingFee = parseFloat(document.getElementById('shipping-fee').textContent.replace(/[^\d]/g, '')) || 0;
        const discount = parseFloat(document.getElementById('discount').textContent.replace(/[^\d]/g, '')) || 0;
        document.getElementById('subtotal').textContent = formatVND(subtotal);
        document.getElementById('shipping-fee').textContent = formatVND(shippingFee);
        document.getElementById('total').textContent = formatVND(subtotal + shippingFee - discount);
    }

    // √Åp d·ª•ng m√£ gi·∫£m gi√° khi ch·ªçn t·ª´ select
    document.getElementById('voucher').addEventListener('change', async () => {
        const voucherCode = document.getElementById('voucher').value.trim();
        if (!voucherCode) {
            document.getElementById('discount').textContent = formatVND(0);
            updateTotal();
            return;
        }

        try {
            const response = await fetch(`/api/checkout/apply-voucher?voucher=${voucherCode}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });
            const data = await response.json();

            if (response.ok) {
                const discount = data.data;
                document.getElementById('discount').textContent = formatVND(discount);
                updateTotal();
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng',
                    text: data.message,
                    timer: 1500
                });
            } else {
                document.getElementById('discount').textContent = formatVND(0);
                updateTotal();
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: data.message,
                });
            }
        } catch (error) {
            console.error('L·ªói √°p d·ª•ng m√£ gi·∫£m gi√°:', error);
            document.getElementById('discount').textContent = formatVND(0);
            updateTotal();
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'ƒê√£ x·∫£y ra l·ªói khi √°p d·ª•ng m√£ gi·∫£m gi√°!',
            });
        }
    });

    // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn
    document.getElementById('shippingMethod').addEventListener('change', calculateShipping);

    // X·ª≠ l√Ω s·ª± ki·ªán ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            method.classList.add('active');
            method.querySelector('input').checked = true;
        });
    });

    // X·ª≠ l√Ω submit ƒë∆°n h√†ng
    document.getElementById('submit-order').addEventListener('click', async (e) => {
        e.preventDefault();
        const submitButton = document.getElementById('submit-order');
        submitButton.classList.add('loading');
        submitButton.disabled = true;

        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        if (!fullName || !phone || !address) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng!',
            });
            submitButton.classList.remove('loading');
            submitButton.disabled = false;
            return;
        }

        let items = [];
        let source = '';
        if (isFromCart()) {
            try {
                const response = await fetch('/api/cart', { credentials: 'include' });
                if (response.ok) {
                    const cartData = await response.json();
                    items = cartData.chiTietGioHang.map(item => ({
                        chiTietSanPhamId: item.chiTietSanPham.id,
                        tenSanPham: item.chiTietSanPham.sanPham.tenSanPham,
                        soLuong: item.soLuong,
                        gia: item.gia
                    }));
                    source = 'Gi·ªè h√†ng (API /cart)';
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói',
                        text: 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!',
                    });
                    submitButton.classList.remove('loading');
                    submitButton.disabled = false;
                    return;
                }
            } catch (error) {
                console.error('L·ªói khi t·∫£i gi·ªè h√†ng:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!',
                });
                submitButton.classList.remove('loading');
                submitButton.disabled = false;
                return;
            }
        } else {
            const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
            if (checkoutItem) {
                items = [checkoutItem];
                source = 'Mua ngay (localStorage.checkoutItem)';
            }
        }

        if (items.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: `Kh√¥ng c√≥ s·∫£n ph·∫©m trong ${isFromCart() ? 'gi·ªè h√†ng' : 'ƒë∆°n h√†ng'}!`,
            });
            submitButton.classList.remove('loading');
            submitButton.disabled = false;
            return;
        }

        const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        const shippingFee = parseFloat(document.getElementById('shipping-fee').textContent.replace(/[^\d]/g, '')) || 0;
        const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace(/[^\d]/g, '')) || 0;
        const discount = parseFloat(document.getElementById('discount').textContent.replace(/[^\d]/g, '')) || 0;
        const totalAmount = subtotal + shippingFee - discount;

        const orderData = {
            fullName: fullName,
            phone: phone,
            address: address,
            shippingMethod: document.getElementById('shippingMethod').value,
            paymentMethodId: selectedMethod,
            notes: document.getElementById('note').value,
            voucher: document.getElementById('voucher').value,
            shippingFee: shippingFee,
            orderItems: items.map(item => ({
                chiTietSanPhamId: item.chiTietSanPhamId,
                soLuong: item.soLuong
            })),
            source: source
        };

        // Ki·ªÉm tra s·ªë d∆∞ v√≠ cho ph∆∞∆°ng th·ª©c thanh to√°n v√≠ ƒëi·ªán t·ª≠
        if (selectedMethod === '550E8400-E29B-41D4-A716-446655440019') {
            try {
                const response = await fetch('/api/wallet/balance', { credentials: 'include' });
                const data = await response.json();
                if (!response.ok || !data.success || data.data < totalAmount) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'S·ªë d∆∞ kh√¥ng ƒë·ªß',
                        html: `
            <p>B·∫°n c·∫ßn <strong>${formatVND(totalAmount)}</strong> nh∆∞ng s·ªë d∆∞ hi·ªán t·∫°i l√† <strong>${formatVND(data.data || 0)}</strong>.</p>
            <p>Vui l√≤ng n·∫°p th√™m ti·ªÅn v√†o v√≠ ƒë·ªÉ ti·∫øp t·ª•c.</p>
        `,
                        showCancelButton: true,
                        confirmButtonText: 'N·∫°p ti·ªÅn ngay',
                        cancelButtonText: 'Quay l·∫°i',
                        confirmButtonColor: '#153054',
                        cancelButtonColor: '#d33',
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '/vi?redirect=/thanh-toan';
                        }
                    });
                    submitButton.classList.remove('loading');
                    submitButton.disabled = false;
                    return;
                }

            } catch (error) {
                console.error('L·ªói ki·ªÉm tra s·ªë d∆∞ v√≠:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: 'Kh√¥ng th·ªÉ ki·ªÉm tra s·ªë d∆∞ v√≠. Vui l√≤ng th·ª≠ l·∫°i!',
                });
                submitButton.classList.remove('loading');
                submitButton.disabled = false;
                return;
            }
        }

        const confirmResult = await Swal.fire({
            icon: 'question',
            title: 'X√°c nh·∫≠n thanh to√°n',
            html: `
                <p><strong>T·ªïng ti·ªÅn:</strong> ${formatVND(totalAmount)}</p>
                <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${
                selectedMethod === '550E8400-E29B-41D4-A716-446655440017' ? 'Thanh to√°n khi nh·∫≠n h√†ng (COD)' :
                    selectedMethod === '550E8400-E29B-41D4-A716-446655440018' ? 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng' :
                        'V√≠ ƒëi·ªán t·ª≠'
            }</p>
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c thanh to√°n?</p>
            `,
            showCancelButton: true,
            confirmButtonText: 'X√°c nh·∫≠n',
            cancelButtonText: 'H·ªßy',
            confirmButtonColor: '#153054',
            cancelButtonColor: '#d33',
        });

        if (!confirmResult.isConfirmed) {
            submitButton.classList.remove('loading');
            submitButton.disabled = false;
            return;
        }

        try {
            if (selectedMethod === '550E8400-E29B-41D4-A716-446655440018') {
                if (totalAmount <= 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'L·ªói',
                        text: 'T·ªïng ti·ªÅn ph·∫£i l·ªõn h∆°n 0.',
                    });
                    submitButton.classList.remove('loading');
                    submitButton.disabled = false;
                    return;
                }

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/kh-payment/kh-create-payment-link';
                form.style.display = 'none';

                const productNameInput = document.createElement('input');
                productNameInput.type = 'hidden';
                productNameInput.name = 'productName';
                productNameInput.value = items.map(item => item.tenSanPham).join(', ');
                form.appendChild(productNameInput);

                const priceInput = document.createElement('input');
                priceInput.type = 'hidden';
                priceInput.name = 'price';
                priceInput.value = totalAmount.toString();
                form.appendChild(priceInput);

                const descriptionInput = document.createElement('input');
                descriptionInput.type = 'hidden';
                descriptionInput.name = 'description';
                descriptionInput.value = `Thanh to√°n ƒë∆°n h√†ng`;
                form.appendChild(descriptionInput);

                sessionStorage.setItem('pendingOrder', JSON.stringify({ orderData }));

                document.body.appendChild(form);
                form.submit();
            } else {
                const response = await fetch('/api/checkout/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    if (source === 'Mua ngay (localStorage.checkoutItem)') {
                        localStorage.removeItem('checkoutItem');
                    } else {
                        localStorage.removeItem('cartItems');
                    }
                    Swal.fire({
                        icon: 'success',
                        title: 'Th√†nh c√¥ng',
                        text: `ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${data.data}`,
                        confirmButtonText: 'Quay l·∫°i trang ch·ªß',
                    }).then(() => {
                        window.location.href = '/';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói',
                        text: data.message || 'Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng! Vui l√≤ng th·ª≠ l·∫°i.',
                    });
                }
            }
        } catch (error) {
            console.error("L·ªói g·ª≠i ƒë∆°n h√†ng:", error);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'ƒê√£ x·∫£y ra l·ªói khi g·ª≠i ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!',
            });
        } finally {
            submitButton.classList.remove('loading');
            submitButton.disabled = false;
        }
    });

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng
    async function updateCartCount() {
        try {
            const response = await fetch('/api/cart', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                const cartCount = data.chiTietGioHang ? data.chiTietGioHang.length : 0;
                document.getElementById('cart-count').textContent = cartCount;
            } else if (response.status === 401) {
                document.getElementById('cart-count').textContent = 0;
            }
        } catch (error) {
            console.error('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng:', error);
        }
    }

    // Kh·ªüi t·∫°o trang
    document.addEventListener('DOMContentLoaded', () => {
        loadProvinces();
        loadOrderItems();
        updateCartCount();
        loadSavedAddress();
        loadWalletBalance();
        document.querySelector('.payment-method[data-value="550E8400-E29B-41D4-A716-446655440017"]').classList.add('active');

        document.getElementById('province').addEventListener('change', (e) => {
            const provinceId = parseInt(e.target.value);
            if (provinceId) loadDistricts(provinceId);
        });

        document.getElementById('district').addEventListener('change', async (e) => {
            const districtId = parseInt(e.target.value);
            if (!districtId) return;
            await loadWards(districtId);
            await loadShippingServices(districtId);
        });

        document.getElementById('ward').addEventListener('change', calculateShipping);
    });
</script>
</body>
</html>