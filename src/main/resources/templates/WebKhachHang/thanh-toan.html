<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ACV Store - Thanh toán</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom, #f8fafc, #e2e8f0); }
        .navbar { background: linear-gradient(90deg, #f97316, #ef4444); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .container { max-width: 1280px; }
        .section-box { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .section-box:hover { transform: translateY(-4px); box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .section-title { font-size: 20px; font-weight: 700; color: #f97316; display: flex; align-items: center; }
        .order-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .form-control { border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px 14px; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .form-control:focus { border-color: #f97316; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1); outline: none; }
        .btn-primary { background: linear-gradient(90deg, #f97316, #ef4444); border: none; border-radius: 8px; padding: 12px; font-weight: 600; transition: background 0.3s ease, transform 0.2s ease; }
        .btn-primary:hover { background: linear-gradient(90deg, #ef4444, #f97316); transform: translateY(-2px); }
        .voucher-btn { background: white; border: 1px solid #f97316; color: #f97316; border-radius: 8px; padding: 10px 16px; font-weight: 600; transition: all 0.3s ease; }
        .voucher-btn:hover { background: #f97316; color: white; }
        .payment-method { padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s ease; }
        .payment-method:hover { border-color: #f97316; background: #fff7ed; }
        .payment-method.active { border-color: #f97316; background: #fff7ed; }
        .order-item { border-bottom: 1px solid #e5e7eb; padding-bottom: 16px; }
        .submit-btn { position: sticky; bottom: 20px; }
        @media (max-width: 768px) {
            .order-item-img { width: 60px; height: 60px; }
            .section-box { padding: 16px; }
            .container { padding: 0 16px; }
        }
    </style>
</head>
<body>
<!-- Header -->
<nav class="navbar fixed-top">
    <div class="container mx-auto flex items-center justify-between py-4 px-6">
        <a href="/" class="text-2xl font-bold text-white">ACV Store</a>
        <div class="flex items-center space-x-6">
            <a href="/cart" class="text-white text-xl relative">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2 py-1">0</span>
            </a>
        </div>
    </div>
</nav>

<!-- Checkout Section -->
<section class="container mx-auto py-24">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Thanh toán</h1>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Customer Info, Shipping, Payment, Note -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Customer Information -->
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-user mr-2"></i> Thông tin khách hàng</h2>
                <form id="checkout-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Họ và tên</label>
                            <input type="text" id="fullName" name="fullName" class="form-control w-full" required/>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Số điện thoại</label>
                            <input type="tel" id="phone" name="phone" class="form-control w-full" required/>
                        </div>
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ nhận hàng</label>
                        <input type="text" id="address" name="address" class="form-control w-full" required/>
                    </div>
                </form>
            </div>

            <!-- Shipping Method -->
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-truck mr-2"></i> Phương thức vận chuyển</h2>
                <select id="shippingMethod" name="shippingMethod" class="form-control w-full" required>
                    <option value="STANDARD">Giao hàng tiêu chuẩn (3-5 ngày) - 15,000 VNĐ</option>
                    <option value="EXPRESS">Giao hàng nhanh (1-2 ngày) - 30,000 VNĐ</option>
                </select>
            </div>

            <!-- Payment Method -->
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-credit-card mr-2"></i> Phương thức thanh toán</h2>
                <div class="payment-method active" data-value="COD">
                    <input type="radio" name="paymentMethod" value="COD" checked>
                    <span class="ml-2 font-medium">Thanh toán khi nhận hàng (COD)</span>
                </div>
                <div class="payment-method" data-value="BANK">
                    <input type="radio" name="paymentMethod" value="BANK">
                    <span class="ml-2 font-medium">Chuyển khoản ngân hàng</span>
                </div>
                <div class="payment-method" data-value="ONLINE">
                    <input type="radio" name="paymentMethod" value="ONLINE">
                    <span class="ml-2 font-medium">Thanh toán trực tuyến</span>
                </div>
            </div>

            <!-- Note -->
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-sticky-note mr-2"></i> Ghi chú</h2>
                <textarea id="note" name="note" class="form-control w-full" rows="4" placeholder="Ghi chú cho đơn hàng (tùy chọn)"></textarea>
            </div>
        </div>

        <!-- Right Column: Order Summary -->
        <div class="section-box">
            <h2 class="section-title mb-4"><i class="fas fa-shopping-bag mr-2"></i> Đơn hàng</h2>
            <div id="order-items" class="space-y-4 mb-6"></div>
            <div class="border-t pt-4">
                <div class="flex justify-between mb-2 text-sm">
                    <span>Tạm tính:</span>
                    <span id="subtotal" class="font-semibold">0 VNĐ</span>
                </div>
                <div class="flex justify-between mb-2 text-sm">
                    <span>Phí vận chuyển:</span>
                    <span id="shipping-fee" class="font-semibold">15,000 VNĐ</span>
                </div>
                <div class="flex justify-between mb-2 text-sm">
                    <span>Giảm giá:</span>
                    <span id="discount" class="font-semibold">0 VNĐ</span>
                </div>
                <div class="flex justify-between text-lg font-bold">
                    <span>Tổng tiền:</span>
                    <span id="total" class="text-orange-600">15,000 VNĐ</span>
                </div>
            </div>
            <div class="mt-6">
                <label for="voucher" class="block text-sm font-medium text-gray-700 mb-1">Mã giảm giá</label>
                <div class="flex space-x-3">
                    <input type="text" id="voucher" class="form-control w-full" placeholder="Nhập mã giảm giá"/>
                    <button id="apply-voucher" class="voucher-btn">Áp dụng</button>
                </div>
            </div>
            <button id="submit-order" class="btn btn-primary w-full mt-6 submit-btn">
                <i class="fas fa-check-circle mr-2"></i> Đặt hàng
            </button>
        </div>
    </div>
</section>

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Format number to VND
    function formatVND(number) {
        return new Intl.NumberFormat('vi-VN', { style: 'decimal', minimumFractionDigits: 0 }).format(number) + ' VNĐ';
    }

    // Load order items from localStorage or cart API
    async function loadOrderItems() {
        const orderItemsContainer = document.getElementById('order-items');
        let subtotal = 0;
        let items = [];

        // Check if there's a checkout item from "Mua ngay"
        const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
        if (checkoutItem) {
            console.log('Sản phẩm từ "Mua ngay" (localStorage):', checkoutItem); // Log sản phẩm từ localStorage
            items.push(checkoutItem);
            subtotal += checkoutItem.gia * checkoutItem.soLuong;
        } else {
            console.log('Không có sản phẩm từ "Mua ngay" trong localStorage');
            // Load from cart API if no checkout item
            try {
                const response = await fetch('/api/cart');
                if (response.ok) {
                    const cartData = await response.json();
                    items = cartData.chiTietGioHang || [];
                    console.log('Sản phẩm từ giỏ hàng (API /cart):', items); // Log sản phẩm từ giỏ hàng
                    subtotal = items.reduce((sum, item) => sum + item.gia * item.soLuong, 0);
                } else {
                    console.log('Không thể tải giỏ hàng từ API /cart. Trạng thái:', response.status);
                }
            } catch (error) {
                console.error('Lỗi khi tải giỏ hàng:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể tải giỏ hàng!',
                });
            }
        }

        // Kiểm tra xem có sản phẩm nào hay không
        if (items.length === 0) {
            console.log('Không có sản phẩm nào trong đơn hàng.');
        } else {
            console.log(`Tổng cộng ${items.length} sản phẩm trong đơn hàng.`);
        }

        // Render order items
        orderItemsContainer.innerHTML = items.map(item => `
        <div class="order-item flex items-center space-x-4">
            <img src="${item.urlHinhAnh}" alt="${item.tenSanPham}" class="order-item-img"/>
            <div class="flex-1">
                <h6 class="font-semibold text-gray-800">${item.tenSanPham}</h6>
                <p class="text-gray-600 text-sm">Số lượng: ${item.soLuong}</p>
                <p class="text-gray-600 text-sm">Đơn giá: ${formatVND(item.gia)}</p>
                <p class="text-orange-600 font-bold">Thành tiền: ${formatVND(item.gia * item.soLuong)}</p>
            </div>
        </div>
    `).join('');

        // Update subtotal, shipping fee, and total
        const shippingFee = document.getElementById('shippingMethod').value === 'EXPRESS' ? 30000 : 15000;
        document.getElementById('subtotal').textContent = formatVND(subtotal);
        document.getElementById('shipping-fee').textContent = formatVND(shippingFee);
        document.getElementById('total').textContent = formatVND(subtotal + shippingFee);
    }

    // Apply voucher
    document.getElementById('apply-voucher').addEventListener('click', async () => {
        const voucherCode = document.getElementById('voucher').value.trim();
        if (!voucherCode) {
            Swal.fire({
                icon: 'warning',
                title: 'Lỗi',
                text: 'Vui lòng nhập mã giảm giá!',
            });
            return;
        }

        try {
            const response = await fetch(`/api/checkout/apply-voucher?voucher=${voucherCode}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (response.ok) {
                const discount = data.data;
                document.getElementById('discount').textContent = formatVND(discount);
                const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace(/[^\d]/g, '')) || 0;
                const shippingFee = parseFloat(document.getElementById('shipping-fee').textContent.replace(/[^\d]/g, '')) || 0;
                document.getElementById('total').textContent = formatVND(subtotal + shippingFee - discount);
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công',
                    text: data.message,
                    timer: 1500
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: data.message,
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Đã xảy ra lỗi khi áp dụng mã giảm giá!',
            });
        }
    });

    // Update total when shipping method changes
    document.getElementById('shippingMethod').addEventListener('change', () => {
        loadOrderItems();
    });

    // Handle payment method selection
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            method.classList.add('active');
            method.querySelector('input').checked = true;
        });
    });

    // Load user information
    async function loadUserInfo() {
        try {
            const response = await fetch('/api/checkout/get-user');
            if (response.ok) {
                const data = await response.json();
                const user = data.data;
                document.getElementById('fullName').value = user.hoTen || '';
                document.getElementById('phone').value = user.soDienThoai || '';
                document.getElementById('address').value = user.diaChi || '';
            } else if (response.status === 401) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Chưa đăng nhập',
                    text: 'Vui lòng đăng nhập để tiếp tục!',
                    confirmButtonText: 'Đăng nhập',
                }).then(() => {
                    window.location.href = '/login';
                });
            }
        } catch (error) {
            console.error('Error loading user info:', error);
        }
    }

    // Handle checkout form submission
    document.getElementById('submit-order').addEventListener('click', async (e) => {
        e.preventDefault();

        // ✅ Bước 1: Lấy sản phẩm từ localStorage hoặc từ giỏ hàng
        const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
        const itemsRaw = checkoutItem ? [checkoutItem] : (await (await fetch('/api/cart')).json()).chiTietGioHang;

        // ✅ Bước 2: Map đúng format cho backend
        const orderItems = itemsRaw.map(item => ({
            chiTietSanPhamId: item.chiTietSanPhamId,
            soLuong: item.soLuong
        }));

        // ✅ Bước 3: Map phương thức thanh toán (chuỗi → UUID)
        const paymentMethodMap = {
            COD: "550e8400-e29b-41d4-a716-446655440017",    // Tiền mặt
            BANK: "550e8400-e29b-41d4-a716-446655440018",   // Chuyển khoản
            ONLINE: "550e8400-e29b-41d4-a716-446655440019"  // Nếu có ONLINE, thêm vào DB và sửa UUID
        };

        const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'COD';
        const paymentMethodId = paymentMethodMap[selectedMethod];

        // ✅ Bước 4: Tạo payload request
        const request = {
            fullName: document.getElementById('fullName').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            shippingMethod: document.getElementById('shippingMethod').value,
            paymentMethodId: paymentMethodId,
            notes: document.getElementById('note').value,
            voucher: document.getElementById('voucher').value,
            orderItems: orderItems
        };

        console.log("📦 Payload gửi đi:", request); // debug

        // ✅ Bước 5: Gửi request
        try {
            const response = await fetch('/api/checkout/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.removeItem('checkoutItem');
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công',
                    text: `Đặt hàng thành công! Mã đơn hàng: ${data.data}`,
                    confirmButtonText: 'Quay lại trang chủ',
                }).then(() => {
                    window.location.href = '/';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: data.message || 'Không thể đặt hàng',
                });
            }
        } catch (error) {
            console.error("❌ Lỗi gửi đơn hàng:", error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Đã xảy ra lỗi khi gửi đơn hàng. Vui lòng thử lại!',
            });
        }
    });

    // Update cart count
    async function updateCartCount() {
        try {
            const response = await fetch('/api/cart');
            if (response.ok) {
                const data = await response.json();
                const cartCount = data.chiTietGioHang ? data.chiTietGioHang.length : 0;
                document.getElementById('cart-count').textContent = cartCount;
            } else if (response.status === 401) {
                document.getElementById('cart-count').textContent = 0;
            }
        } catch (error) {
            console.error('Error updating cart count:', error);
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        loadOrderItems();
        loadUserInfo();
        updateCartCount();
        document.querySelector('.payment-method[data-value="COD"]').classList.add('active');
    });
</script>
</body>
</html>