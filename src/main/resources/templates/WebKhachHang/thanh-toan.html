<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ACV Store - Thanh to√°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        button[disabled]{pointer-events:none;opacity:.5;cursor:not-allowed}
        .navbar{background:linear-gradient(to right,#153054,#1e4066)}
        .ticker{background-color:#9FD5F7;color:#153054;font-weight:700;position:fixed;top:0;left:0;width:100%;z-index:1050}
        .dropdown-menu{display:none;position:absolute;background-color:#fff;min-width:160px;box-shadow:0 8px 16px rgba(0,0,0,.2);z-index:1000}
        .dropdown:hover .dropdown-menu{display:block}
        body{padding-top:100px}
        @media (max-width:640px){
            .dropdown-menu{width:100%;left:0}
            body{padding-top:80px}
            .order-item-img{width:60px;height:60px}
            .section-box{padding:16px}
            .container{padding:0 16px}
        }
        .section-box{background:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 4px 20px rgba(0,0,0,.05);transition:transform .3s ease,box-shadow .3s ease}
        .section-box:hover{transform:translateY(-4px);box-shadow:0 6px 24px rgba(0,0,0,.1)}
        .section-title{font-size:20px;font-weight:700;color:#153054;display:flex;align-items:center}
        .order-item-img{width:80px;height:80px;object-fit:cover;border-radius:8px}
        .form-control{border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;transition:border-color .3s ease,box-shadow .3s ease}
        .form-control:focus{border-color:#153054;box-shadow:0 0 0 3px rgba(21,48,84,.1);outline:none}
        .btn-primary{background:#153054;border:none;border-radius:8px;padding:12px;font-weight:600;color:#fff;transition:background .3s ease,transform .2s ease}
        .btn-primary:hover{background:#1e4066;transform:translateY(-2px)}
        .payment-method{padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:12px;cursor:pointer;transition:all .3s ease}
        .payment-method:hover{border-color:#153054;background:#e0ebf5}
        .payment-method.active{border-color:#153054;background:#e0ebf5}
        .order-item{border-bottom:1px solid #e5e7eb;padding-bottom:16px}
        .submit-btn{position:sticky;bottom:20px}
        .loading{opacity:.6;pointer-events:none}
        .address-card{cursor:pointer;transition:all .3s ease}
        .address-card:hover{background:#e0ebf5}
        .address-card.active{border-color:#153054;background:#e0ebf5}
        .swal-cancel-button{color:#153054!important}
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:9999;opacity:0;visibility:hidden;transition:opacity .3s ease,visibility .3s ease}
        .loading-overlay.active{opacity:1;visibility:visible}
        .loading-spinner{border:8px solid #f3f3f3;border-top:8px solid #153054;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .loading-text{color:#fff;font-size:18px;margin-top:16px;font-weight:700;text-align:center}
        .loading-content{display:flex;flex-direction:column;align-items:center;justify-content:center}
        /* Voucher kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán (disabled) */
        .voucher-disabled { opacity: .55; }
        .voucher-disabled .form-check-input { pointer-events: none; }
        #voucherModal .modal-dialog{ max-width: 620px; }
        #voucherModal .modal-content{ border-radius: 14px; }
        #voucherModal .modal-body{ max-height: 70vh; overflow-y: auto; }
        #voucherModal .modal-header{
            position: sticky; top: 0; background:#fff; z-index: 2; border-bottom: 1px solid #eee;
        }
        #voucherModal .modal-footer{
            position: sticky; bottom: 0; background:#fff; z-index: 2; border-top: 1px solid #eee;
        }

        /* Card phi·∫øu g·ªçn */
        #voucherModal .voucher-card{ padding:12px; }
        #voucherModal .voucher-card .fw-semibold{ font-size:14px; }
        #voucherModal .voucher-card .small{ font-size:12px; }
        #voucherModal .voucher-search {
            position: sticky;
            top: 0;
            z-index: 3;
            background: #fff;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body class="bg-gray-100">
<!-- Loading Overlay -->
<div class="loading-overlay active" id="loading-overlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <p class="loading-text">ƒêang t·∫£i trang thanh to√°n...</p>
    </div>
</div>

<div class="ticker py-1 overflow-hidden fixed top-0 w-full z-50">
    <marquee behavior="scroll" direction="left" scrollamount="5">
        üéâ Khuy·∫øn m√£i ƒë·∫∑c bi·ªát: Gi·∫£m gi√° l√™n ƒë·∫øn 50% cho t·∫•t c·∫£ s·∫£n ph·∫©m h√¥m nay! üéâ - Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n t·ª´ 500k!
    </marquee>
</div>

<div th:replace="~{fragments/kh_navbar :: navbar(user=${user}, keyword=${keyword}, cartCount=${cartCount})}"></div>

<section class="container mx-auto py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Thanh to√°n</h1>
    <div th:if="${error}" class="bg-red-100 text-red-700 p-4 rounded mb-4" th:text="${error}"></div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- LEFT -->
        <div class="lg:col-span-2 space-y-6">
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-user mr-2"></i> Th√¥ng tin kh√°ch h√†ng</h2>
                <form id="checkout-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ giao h√†ng</label>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addressModal">
                            Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng
                        </button>
                        <input type="hidden" id="addressId" name="addressId"/>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n</label>
                            <input type="text" id="fullName" name="fullName" class="form-control w-full" th:value="${nguoiNhan}" required disabled/>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="phone" name="phone" class="form-control w-full" th:value="${soDienThoaiNguoiNhan}" required disabled/>
                        </div>
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</label>
                        <input type="text" id="address" name="address" class="form-control w-full" th:value="${loggedInUser?.chiTietDiaChi}" required disabled/>
                    </div>

                    <!-- hidden region selects for shipping calc -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 mt-4" hidden>
                        <select id="province" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>
                        </select>
                        <select id="district" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>
                        </select>
                        <select id="ward" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="section-box" hidden>
                <h2 class="section-title mb-4"><i class="fas fa-truck mr-2"></i> Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn</h2>
                <select id="shippingMethod" name="shippingMethod" class="form-control w-full" required>
                    <option value="53321">Giao h√†ng nhanh (H√†ng nh·∫π)</option>
                    <option value="100039">Giao h√†ng ch·∫≠m (H√†ng n·∫∑ng)</option>
                </select>
            </div>

            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-credit-card mr-2"></i> Ph∆∞∆°ng th·ª©c thanh to√°n</h2>
                <div class="payment-method active" data-value="550E8400-E29B-41D4-A716-446655440017">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440017" checked>
                    <span class="ml-2 font-medium">Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
                </div>
                <div class="payment-method" data-value="550E8400-E29B-41D4-A716-446655440018">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440018">
                    <span class="ml-2 font-medium">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                </div>
                <div class="payment-method" data-value="550E8400-E29B-41D4-A716-446655440019">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440019">
                    <span class="ml-2 font-medium">V√≠ ƒëi·ªán t·ª≠</span>
                    <span id="wallet-balance" class="ml-2 text-sm text-gray-600">(ƒêang t·∫£i...)</span>
                </div>
            </div>

            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-sticky-note mr-2"></i> Ghi ch√∫</h2>
                <textarea id="note" name="note" class="form-control w-full" rows="4" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (t√πy ch·ªçn)"></textarea>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="section-box">
            <h2 class="section-title mb-4"><i class="fas fa-shopping-bag mr-2"></i> ƒê∆°n h√†ng</h2>
            <div id="order-items" class="space-y-4 mb-6"></div>

            <div class="border-top pt-3">
                <div class="d-flex justify-content-between mb-2 small">
                    <span>T·∫°m t√≠nh:</span><span id="subtotal" class="fw-semibold">0 VNƒê</span>
                </div>
                <div class="d-flex justify-content-between mb-2 small">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span><span id="shipping-fee" class="fw-semibold">0 VNƒê</span>
                </div>
                <div class="d-flex justify-content-between mb-1 small">
                    <span>Gi·∫£m gi√° ƒë∆°n (ORDER):</span><span id="discount-order" class="fw-semibold">0 VNƒê</span>
                </div>
                <div class="d-flex justify-content-between mb-2 small">
                    <span>Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn (FREESHIP):</span><span id="discount-ship" class="fw-semibold">0 VNƒê</span>
                </div>
                <div class="d-flex justify-content-between fs-5 fw-bold">
                    <span>T·ªïng ti·ªÅn:</span><span id="total" class="text-[#153054]">0 VNƒê</span>
                </div>
            </div>

            <!-- ========== CH·ªåN M√É GI·∫¢M GI√Å (NEW) ========== -->
            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas fa-ticket-alt fs-3 text-primary"></i>
                        <h3 class="fs-5 fw-bold mb-0">Ch·ªçn m√£ gi·∫£m gi√°</h3>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="openVoucherModal()">Ch·ªçn</button>
                </div>
                <!-- t√≥m t·∫Øt m√£ ƒëang ch·ªçn -->
                <div id="voucher-summary" class="small text-muted">Ch∆∞a ch·ªçn</div>

                <!-- Gi·ªØ 2 select ·∫®N ƒë·ªÉ d√πng l·∫°i applyOrderVoucher/applyShipVoucher -->
                <select id="order-voucher" hidden>
                    <option value=""></option>
                    <th:block th:each="voucher : ${vouchers}">
                        <option th:if="${voucher.phamViApDung != 'SHIPPING'}"
                                th:value="${voucher.ma}"
                                th:text="${voucher.ten} + ' (T·ªëi thi·ªÉu: ' + ${#numbers.formatDecimal(voucher.giaTriGiamToiThieu, 0, 'COMMA', 0, 'POINT')} + ' VNƒê)'">
                        </option>
                    </th:block>
                </select>

                <select id="ship-voucher" hidden>
                    <option value=""></option>
                    <th:block th:each="voucher : ${vouchers}">
                        <option th:if="${voucher.phamViApDung == 'SHIPPING'}"
                                th:value="${voucher.ma}"
                                th:text="${voucher.ten}">
                        </option>
                    </th:block>
                </select>
            </div>


            <button id="submit-order" class="btn btn-primary w-100 mt-4 submit-btn">
                <i class="fas fa-check-circle me-2"></i> ƒê·∫∑t h√†ng
            </button>
        </div>
    </div>
</section>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="addressModalLabel">Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div id="address-list" class="mb-4"></div>
            <button type="button" class="btn btn-outline-primary w-100 mb-3" onclick="showAddAddressForm()">Th√™m ƒë·ªãa ch·ªâ m·ªõi</button>

            <div id="add-address-form" class="d-none">
                <h6 class="mb-3">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h6>
                <form id="new-address-form">
                    <div class="mb-3">
                        <label for="new-fullName" class="form-label">H·ªç v√† t√™n</label>
                        <input type="text" id="new-fullName" class="form-control" required/>
                    </div>
                    <div class="mb-3">
                        <label for="new-phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="new-phone" class="form-control" required/>
                    </div>
                    <div class="mb-3">
                        <label for="new-address" class="form-label">ƒê·ªãa ch·ªâ</label>
                        <input type="text" id="new-address" class="form-control" required/>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="new-province" class="form-label">T·ªânh/Th√†nh ph·ªë</label>
                            <select id="new-province" class="form-control" required>
                                <option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="new-district" class="form-label">Qu·∫≠n/Huy·ªán</label>
                            <select id="new-district" class="form-control" required>
                                <option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="new-ward" class="form-label">Ph∆∞·ªùng/X√£</label>
                            <select id="new-ward" class="form-control" required>
                                <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="saveNewAddress()">L∆∞u ƒë·ªãa ch·ªâ</button>
                    <button type="button" class="btn btn-secondary" onclick="hideAddAddressForm()">H·ªßy</button>
                </form>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
    </div></div>
</div>

<footer style="background:linear-gradient(to right,#153054,#1e4066);color:#fff;padding-top:30px;padding-bottom:20px">
    <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
            <h3 class="text-lg font-bold mb-4">ACV Store</h3>
            <p class="text-sm">C·ª≠a h√†ng th·ªùi trang h√†ng ƒë·∫ßu v·ªõi c√°c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng v√† gi√° c·∫£ h·ª£p l√Ω.</p>
            <div class="mt-4">
                <h4 class="text-sm font-semibold">ƒêƒÉng k√Ω nh·∫≠n tin</h4>
                <form class="flex gap-2 mt-2">
                    <input type="email" class="w-full p-2 rounded border" placeholder="Nh·∫≠p email c·ªßa b·∫°n" aria-label="Email ƒëƒÉng k√Ω nh·∫≠n tin">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">ƒêƒÉng k√Ω</button>
                </form>
            </div>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Li√™n k·∫øt nhanh</h3>
            <ul class="space-y-2">
                <li><a href="/new" class="hover:text-blue-300">S·∫£n ph·∫©m m·ªõi</a></li>
                <li><a href="/all" class="hover:text-blue-300">T·∫•t c·∫£ s·∫£n ph·∫©m</a></li>
                <li><a href="/bestsellers" class="hover:text-blue-300">S·∫£n ph·∫©m b√°n ch·∫°y</a></li>
            </ul>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Li√™n h·ªá</h3>
            <p class="text-sm">Email: datn.acv@gmail.com</p>
            <p class="text-sm">Hotline: 0911 006 045</p>
            <div class="flex space-x-4 mt-4">
                <a href="#" class="text-white hover:text-blue-300" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="text-white hover:text-blue-300" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" class="text-white hover:text-blue-300" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </div>
    <div class="text-center mt-8 text-sm">¬© 2025 ACV Store. All rights reserved.</div>
</footer>
<!-- ========== MODAL CH·ªåN VOUCHER (compact, centered, scrollable) ========== -->
<!-- ========== MODAL CH·ªåN VOUCHER (compact, centered, scrollable) ========== -->
<!-- ========== MODAL CH·ªåN VOUCHER (compact, centered, scrollable) ========== -->
<div class="modal fade" id="voucherModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header border-0">
                <div class="d-flex align-items-center gap-3">
                    <i class="fas fa-ticket-alt fs-3 text-primary"></i>
                    <h3 class="fs-4 fw-bold mb-0">Ch·ªçn m√£ gi·∫£m gi√°</h3>
                </div>
                <button type="button" class="btn-close" aria-label="Close" onclick="closeVoucherModal()"></button>
            </div>

            <!-- BODY cu·ªôn d·ªçc -->
            <div class="modal-body pt-0" style="max-height: 60vh; overflow-y: auto;">

                <!-- Thanh t√¨m ki·∫øm (STICKY) -->
                <div class="voucher-search">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input id="voucher-search" type="text" class="form-control"
                               placeholder="T√¨m theo t√™n m√£, code, m√¥ t·∫£...">
                        <button id="voucher-search-clear" class="btn btn-outline-secondary" type="button" title="X√≥a">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- SHIPPING -->
                <div class="mb-3">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fas fa-truck"></i>
                        <span class="fw-bold">Freeship (SHIPPING)</span>
                    </div>

                    <th:block th:each="v : ${vouchers}">
                        <th:block th:if="${v.phamViApDung == 'SHIPPING'}">
                            <label class="voucher-card d-flex align-items-start gap-3 border rounded mb-2 w-100"
                                   style="cursor:pointer;"
                                   th:attr="data-scope=${'SHIPPING'},
                              data-code=${v.ma},
                              data-min-order=${v.giaTriGiamToiThieu}">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold" th:text="${v.ten}">T√™n phi·∫øu</div>
                                    <div class="text-muted small">
                    <span th:text="${
                      v.loai == 'FREESHIP_FULL' ? 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn'
                      : (v.loai == 'FREESHIP_CAP'
                          ? 'Gi·∫£m ' + #numbers.formatDecimal(v.giaTriGiamToiDa, 0, 'POINT', 0, 'COMMA') + ' VND'
                          : 'Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn')
                    }">M√¥ t·∫£ freeship</span>
                                        ‚Ä¢ ƒêH t·ªëi thi·ªÉu:
                                        <span th:text="${#numbers.formatDecimal(v.giaTriGiamToiThieu, 0, 'POINT', 0, 'COMMA')}">0</span> VND
                                        ‚Ä¢ HSD:
                                        <span th:text="${#temporals.format(v.ngayKetThuc,'d/M/yyyy')}"></span>
                                    </div>
                                </div>
                                <input class="form-check-input mt-1" type="radio" name="rb-ship" th:value="${v.ma}">
                            </label>
                        </th:block>
                    </th:block>
                </div>

                <!-- ORDER -->
                <div class="mt-4">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fas fa-receipt"></i>
                        <span class="fw-bold">M√£ gi·∫£m gi√° ƒë∆°n h√†ng (ORDER)</span>
                    </div>

                    <th:block th:each="v : ${vouchers}">
                        <th:block th:if="${v.phamViApDung != 'SHIPPING'}">
                            <label class="voucher-card d-flex align-items-start gap-3 border rounded mb-2 w-100"
                                   style="cursor:pointer;"
                                   th:attr="data-scope=${'ORDER'},
                              data-code=${v.ma},
                              data-min-order=${v.giaTriGiamToiThieu}">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold" th:text="${v.ten}">T√™n phi·∫øu</div>
                                    <div class="text-muted small">
                                        Gi·∫£m
                                        <span th:text="${#numbers.formatDecimal(v.giaTriGiam, 0, 'POINT', 0, 'COMMA')}">0</span>
                                        <span th:text="${v.loai=='PERCENT' ? '%' : 'VND'}"></span>
                                        ‚Ä¢ ƒêH t·ªëi thi·ªÉu:
                                        <span th:text="${#numbers.formatDecimal(v.giaTriGiamToiThieu, 0, 'POINT', 0, 'COMMA')}">0</span> VND
                                        ‚Ä¢ HSD:
                                        <span th:text="${#temporals.format(v.ngayKetThuc,'d/M/yyyy')}"></span>
                                    </div>
                                </div>
                                <input class="form-check-input mt-1" type="radio" name="rb-order" th:value="${v.ma}">
                            </label>
                        </th:block>
                    </th:block>
                </div>

                <!-- Kh√¥ng c√≥ k·∫øt qu·∫£ -->
                <div id="voucher-no-result" class="text-center text-muted py-3 d-none">
                    Kh√¥ng t√¨m th·∫•y m√£ ph√π h·ª£p
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" id="btn-clear-vouchers" class="btn btn-outline-secondary">B·ªè ch·ªçn t·∫•t c·∫£</button>
                <button type="button" id="btn-apply-vouchers" class="btn btn-primary">√Åp d·ª•ng</button>
            </div>
        </div>
    </div>
</div>






<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/navbar.js"></script>
<script>
    // ===== SEARCH HELPERS =====
    function vnNormalize(str = '') {
        return String(str)
            .toLowerCase()
            .normalize('NFD')                // t√°ch d·∫•u
            .replace(/[\u0300-\u036f]/g, '') // b·ªè d·∫•u
            .replace(/[.,]/g, '')            // lo·∫°i d·∫•u ph√¢n c√°ch s·ªë ƒë·ªÉ t√¨m 23000 ~ 23.000
            .trim();
    }

    function filterVouchersInModal(termRaw = '') {
        const modal = document.getElementById('voucherModal');
        if (!modal) return;

        const term = vnNormalize(termRaw);
        const cards = modal.querySelectorAll('label.voucher-card');
        let anyShown = false;

        cards.forEach(card => {
            const code = card.dataset.code || '';
            const text = card.innerText || '';
            const hay  = vnNormalize(code + ' ' + text);

            const matched = term === '' || hay.includes(term);
            card.classList.toggle('d-none', !matched);
            if (matched) anyShown = true;
        });

        const noRes = document.getElementById('voucher-no-result');
        if (noRes) noRes.classList.toggle('d-none', anyShown);
    }

    function debounce(fn, wait = 150) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(null, args), wait);
        };
    }

    // ================== STATE & HELPERS ==================
    const loadingState = {
        provinces: false,
        addresses: false,
        orderItems: false,
        walletBalance: false,
        shippingServices: false,
    };

    function checkLoadingComplete() {
        const allLoaded = Object.values(loadingState).every(s => s === true);
        if (allLoaded) document.getElementById('loading-overlay').classList.remove('active');
    }

    function formatVND(number) {
        return new Intl.NumberFormat('vi-VN', { style: 'decimal', minimumFractionDigits: 0 }).format(Number(number||0)) + ' VNƒê';
    }

    function onlyDigits(s) { return Number((s || '').toString().replace(/[^\d]/g, '')) || 0; }

    function getCheckoutMode() {
        const from = new URLSearchParams(location.search).get('from');
        if (from === 'cart') return 'cart';
        if (from === 'cart-selected') return 'cart-selected';
        return 'buy-now';
    }

    // ================== GHN LOCATION & SHIPPING ==================
    let provinceList = [];
    let districtList = [];

    async function loadProvinces(target = "province") {
        try {
            const res = await fetch('/api/ghn/provinces');
            const json = await res.json();
            if (!json || !json.data) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu t·ªânh/th√†nh');
            const result = JSON.parse(json.data);
            provinceList = result.data || [];

            const select = document.getElementById(target);
            select.innerHTML = '<option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>';
            provinceList.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.ProvinceID;
                opt.textContent = p.ProvinceName;
                select.appendChild(opt);
            });

            loadingState.provinces = true;
            checkLoadingComplete();
        } catch (err) {
            console.error('L·ªói t·∫£i t·ªânh/th√†nh:', err);
            Swal.fire({ icon: 'error', title: 'L·ªói t·∫£i t·ªânh/th√†nh', text: err.message });
            loadingState.provinces = true;
            checkLoadingComplete();
        }
    }
    function markVoucherEligibility() {
        const subtotal = onlyDigits(document.getElementById('subtotal').textContent);
        const shipping = onlyDigits(document.getElementById('shipping-fee').textContent);
        const selOrder = document.getElementById('order-voucher');
        const selShip  = document.getElementById('ship-voucher');

        // ƒê√°nh d·∫•u kh·∫£ d·ª•ng / kh√¥ng kh·∫£ d·ª•ng
        document.querySelectorAll('#voucherModal label[data-scope]').forEach(label => {
            const scope    = label.dataset.scope;              // 'ORDER' | 'SHIPPING'
            const minOrder = Number(label.dataset.minOrder||0);
            const radio    = label.querySelector('input[type="radio"]');

            const okByOrder = subtotal >= minOrder;
            const okByShip  = (scope !== 'SHIPPING') || (shipping > 0);
            const eligible  = okByOrder && okByShip;

            if (eligible) {
                label.classList.remove('voucher-disabled');
                radio.disabled = false;
                label.removeAttribute('title');
            } else {
                label.classList.add('voucher-disabled');
                radio.checked = false;
                radio.disabled = true;
                const reason = !okByOrder
                    ? `Ch∆∞a ƒë·∫°t ƒêH t·ªëi thi·ªÉu ${formatVND(minOrder)}`
                    : `Ch∆∞a c√≥ ph√≠ v·∫≠n chuy·ªÉn (h√£y ch·ªçn ƒë·ªãa ch·ªâ)`;
                label.setAttribute('title', reason);
            }
        });

        // N·∫øu hidden select ƒëang gi·ªØ 1 m√£ nh∆∞ng m√£ ƒë√≥ v·ª´a b·ªã disable -> clear
        const clearIfDisabled = (scope, code, selEl, discountId) => {
            if (!code) return;
            const selector = `#voucherModal label[data-scope="${scope}"][data-code="${CSS.escape(code)}"]`;
            const lab = document.querySelector(selector);
            if (lab && lab.classList.contains('voucher-disabled')) {
                selEl.value = '';
                document.getElementById(discountId).textContent = formatVND(0);
            }
        };
        clearIfDisabled('ORDER',    selOrder.value, selOrder, 'discount-order');
        clearIfDisabled('SHIPPING', selShip.value,  selShip,  'discount-ship');

        // C·∫≠p nh·∫≠t t√≥m t·∫Øt
        const parts = [];
        if (selOrder.value) {
            const t = selOrder.querySelector(`option[value="${selOrder.value}"]`)?.textContent || selOrder.value;
            parts.push('ORDER: ' + t);
        }
        if (selShip.value) {
            const t = selShip.querySelector(`option[value="${selShip.value}"]`)?.textContent || selShip.value;
            parts.push('SHIP: ' + t);
        }
        document.getElementById('voucher-summary').textContent = parts.length ? parts.join(' | ') : 'Ch∆∞a ch·ªçn';
    }

    async function loadDistricts(provinceId, target = "district") {
        try {
            const res = await fetch(`/api/ghn/districts?provinceId=${provinceId}`);
            const json = await res.json();
            if (!json || !json.data) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu qu·∫≠n/huy·ªán');

            const result = JSON.parse(json.data);
            districtList = result.data || [];

            const select = document.getElementById(target);
            select.innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
            districtList.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.DistrictID;
                opt.textContent = d.DistrictName;
                select.appendChild(opt);
            });

            document.getElementById(target === 'district' ? 'ward' : 'new-ward').innerHTML =
                '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
        } catch (err) {
            console.error('L·ªói t·∫£i qu·∫≠n/huy·ªán:', err);
            Swal.fire({ icon: 'error', title: 'L·ªói t·∫£i qu·∫≠n/huy·ªán', text: err.message });
        }
    }

    async function loadWards(districtId, target = "ward") {
        try {
            const res = await fetch(`/api/ghn/wards?districtId=${districtId}`);
            const json = await res.json();
            if (!json || !json.data) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu ph∆∞·ªùng/x√£');

            const result = JSON.parse(json.data);
            const wards = result.data || [];

            const select = document.getElementById(target);
            select.innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
            wards.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.WardCode;
                opt.textContent = w.WardName;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error('L·ªói t·∫£i ph∆∞·ªùng/x√£:', err);
            Swal.fire({ icon: 'error', title: 'L·ªói t·∫£i ph∆∞·ªùng/x√£', text: err.message });
        }
    }

    async function loadShippingServices(toDistrictId) {
        const fromDistrictId = 1542;
        try {
            const res = await fetch(`/api/ghn/available-services?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}`);
            const json = await res.json();
            const services = JSON.parse(json.data).data || [];

            const select = document.getElementById('shippingMethod');
            select.innerHTML = '';
            services.forEach(srv => {
                const opt = document.createElement('option');
                opt.value = srv.service_id;
                opt.textContent = srv.short_name + ` (${srv.service_type_id})`;
                select.appendChild(opt);
            });

            if (services.length) {
                select.value = services[0].service_id;
                await calculateShipping();
            }

            loadingState.shippingServices = true;
            checkLoadingComplete();
        } catch (err) {
            console.error('L·ªói t·∫£i d·ªãch v·ª• v·∫≠n chuy·ªÉn:', err);
            Swal.fire({ icon: 'error', title: 'L·ªói', text: 'Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªãch v·ª• v·∫≠n chuy·ªÉn: ' + err.message });
            loadingState.shippingServices = true;
            checkLoadingComplete();
        }
    }

    async function calculateShipping() {
        const toDistrictId = document.getElementById('district').value;
        const toWardCode = document.getElementById('ward').value;
        const serviceId = document.getElementById('shippingMethod').value;
        const fromDistrictId = 1542;
        if (!toDistrictId || !toWardCode || !serviceId) return;

        try {
            const res = await fetch(`/api/ghn/shipping-fee?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}&toWardCode=${toWardCode}&weight=500&length=20&width=15&height=10&serviceId=${serviceId}&insuranceValue=100000`);
            const json = await res.json();
            const fee = JSON.parse(json.data).data.total || 0;

            document.getElementById('shipping-fee').textContent = formatVND(fee);

            if (document.getElementById('ship-voucher').value) {
                await applyShipVoucher(); // re-apply freeship v·ªõi ph√≠ m·ªõi
            } else {
                document.getElementById('discount-ship').textContent = formatVND(0);
            }
            updateTotal();

            // >>> th√™m d√≤ng n√†y
            markVoucherEligibility();
        } catch (err) {
            console.error('L·ªói t√≠nh ph√≠ v·∫≠n chuy·ªÉn:', err);
            Swal.fire({ icon: 'error', title: 'L·ªói t√≠nh ph√≠ v·∫≠n chuy·ªÉn', text: err.message });
        }
    }


    // ================== TOTAL & UI FNs ==================
    function updateTotal() {
        const subtotal = onlyDigits(document.getElementById('subtotal').textContent);
        const shipping = onlyDigits(document.getElementById('shipping-fee').textContent);
        const discountOrder = onlyDigits(document.getElementById('discount-order').textContent);
        const discountShip = onlyDigits(document.getElementById('discount-ship').textContent);
        const total = Math.max(0, subtotal + shipping - discountOrder - discountShip);
        document.getElementById('total').textContent = formatVND(total);
    }

    // ================== ADDRESS BOOK ==================
    async function loadSavedAddresses() {
        try {
            if (!provinceList.length) await loadProvinces();

            const res = await fetch('/api/checkout/addresses', { credentials: 'include' });
            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·ªãa ch·ªâ');

            const listEl = document.getElementById('address-list');
            listEl.innerHTML = data.data.length ? '' : '<p>Kh√¥ng c√≥ ƒë·ªãa ch·ªâ n√†o ƒë∆∞·ª£c l∆∞u.</p>';

            data.data.forEach(address => {
                const card = document.createElement('div');
                card.className = 'address-card card mb-2 p-3';
                card.setAttribute('data-id', address.id);
                card.setAttribute('data-nguoi-nhan', address.nguoiNhan || '');
                card.setAttribute('data-sdt', address.soDienThoaiNguoiNhan || '');
                card.setAttribute('data-chi-tiet', address.chiTietDiaChi || '');
                card.setAttribute('data-phuong-xa', address.phuongXa || '');
                card.setAttribute('data-quan-huyen', address.quanHuyen || '');
                card.setAttribute('data-tinh-thanh-pho', address.tinhThanhPho || '');
                card.innerHTML = `
              <div class="card-body">
                <h6 class="card-title">${address.nguoiNhan} ${address.macDinh ? '<span class="badge bg-primary ms-2">M·∫∑c ƒë·ªãnh</span>' : ''}</h6>
                <p class="card-text">${address.chiTietDiaChi}, ${address.phuongXa}, ${address.quanHuyen}, ${address.tinhThanhPho}</p>
                <p class="card-text">SƒêT: ${address.soDienThoaiNguoiNhan}</p>
                <button type="button" class="btn btn-primary btn-sm" onclick="selectAddress(this)">Ch·ªçn</button>
              </div>`;
                listEl.appendChild(card);
            });

            const defaultAddress = data.data.find(a => a.macDinh);
            if (defaultAddress) {
                const fullNameInput = document.getElementById('fullName');
                const phoneInput = document.getElementById('phone');
                const addressInput = document.getElementById('address');
                const addressIdInput = document.getElementById('addressId');
                const provinceSelect = document.getElementById('province');
                const districtSelect = document.getElementById('district');
                const wardSelect = document.getElementById('ward');

                addressIdInput.value = defaultAddress.id;
                fullNameInput.value = defaultAddress.nguoiNhan || fullNameInput.value;
                phoneInput.value = defaultAddress.soDienThoaiNguoiNhan || phoneInput.value;
                addressInput.value = `${defaultAddress.chiTietDiaChi || ''}, ${defaultAddress.phuongXa || ''}, ${defaultAddress.quanHuyen || ''}, ${defaultAddress.tinhThanhPho || ''}`
                    .replace(/, ,/g, '').replace(/^,|,$/g, '');

                const normalize = (str) => str?.toLowerCase().replace(/(t·ªânh|th√†nh ph·ªë)/gi,'').replace(/[\s.\-]/g,'')
                    .normalize('NFD').replace(/[\u0300-\u036f]/g,'');

                const provinceMatch = provinceList.find(p => normalize(p.ProvinceName).includes(normalize(defaultAddress.tinhThanhPho)));
                if (provinceMatch) {
                    provinceSelect.value = provinceMatch.ProvinceID;
                    await loadDistricts(provinceMatch.ProvinceID);

                    const districtMatch = districtList.find(d => normalize(d.DistrictName).includes(normalize(defaultAddress.quanHuyen)));
                    if (districtMatch) {
                        districtSelect.value = districtMatch.DistrictID;
                        await loadWards(districtMatch.DistrictID);

                        const wardRes = await fetch(`/api/ghn/wards?districtId=${districtMatch.DistrictID}`);
                        const wardJson = await wardRes.json();
                        const wards = JSON.parse(wardJson.data).data || [];
                        const wardMatch = wards.find(w => normalize(w.WardName).includes(normalize(defaultAddress.phuongXa)));
                        if (wardMatch) {
                            wardSelect.value = wardMatch.WardCode;
                            await loadShippingServices(districtMatch.DistrictID);
                        }
                    }
                }

                const defaultCard = listEl.querySelector(`[data-id="${defaultAddress.id}"]`);
                if (defaultCard) {
                    document.querySelectorAll('.address-card').forEach(c => c.classList.remove('active'));
                    defaultCard.classList.add('active');
                }
            } else {
                // Kh√¥ng c√≥ ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh -> tr√°nh k·∫πt overlay
                loadingState.shippingServices = true;
                checkLoadingComplete();
            }

            loadingState.addresses = true;
            checkLoadingComplete();
        } catch (err) {
            console.error('L·ªói t·∫£i danh s√°ch ƒë·ªãa ch·ªâ:', err);
            Swal.fire({ icon: 'error', title: 'L·ªói t·∫£i ƒë·ªãa ch·ªâ', text: err.message });
            loadingState.addresses = true;
            loadingState.shippingServices = true; // tr√°nh k·∫πt overlay
            checkLoadingComplete();
        }
    }

    window.selectAddress = function (button) {
        const card = button.closest('.address-card');
        const fullNameInput = document.getElementById('fullName');
        const phoneInput = document.getElementById('phone');
        const addressInput = document.getElementById('address');
        const addressIdInput = document.getElementById('addressId');
        const provinceSelect = document.getElementById('province');
        const districtSelect = document.getElementById('district');
        const wardSelect = document.getElementById('ward');

        addressIdInput.value = card.dataset.id;
        fullNameInput.value = card.dataset.nguoiNhan || fullNameInput.value;
        phoneInput.value = card.dataset.sdt || phoneInput.value;
        addressInput.value = `${card.dataset.chiTiet}, ${card.dataset.phuongXa}, ${card.dataset.quanHuyen}, ${card.dataset.tinhThanhPho}`;

        const normalize = (str)=>str?.toLowerCase().replace(/(t·ªânh|th√†nh ph·ªë)/gi,'').replace(/[\s.\-]/g,'')
            .normalize('NFD').replace(/[\u0300-\u036f]/g,'');

        (async function updateAddressDetails() {
            try {
                if (!provinceList.length) await loadProvinces();
                const province = provinceList.find(p => normalize(p.ProvinceName).includes(normalize(card.dataset.tinhThanhPho)));
                if (province) {
                    provinceSelect.value = province.ProvinceID;
                    await loadDistricts(province.ProvinceID);

                    const district = districtList.find(d => normalize(d.DistrictName).includes(normalize(card.dataset.quanHuyen)));
                    if (district) {
                        districtSelect.value = district.DistrictID;
                        await loadWards(district.DistrictID);

                        const wardRes = await fetch(`/api/ghn/wards?districtId=${district.DistrictID}`);
                        const wardJson = await wardRes.json();
                        const wards = JSON.parse(wardJson.data).data || [];
                        const ward = wards.find(w => normalize(w.WardName).includes(normalize(card.dataset.phuongXa)));
                        if (ward) {
                            wardSelect.value = ward.WardCode;
                            await loadShippingServices(district.DistrictID);
                        }
                    }
                }
            } catch (err) {
                console.error('L·ªói khi c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ:', err);
                Swal.fire({ icon: 'error', title: 'L·ªói c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ', text: err.message });
            }
        })();

        document.querySelectorAll('.address-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
    };

    window.showAddAddressForm = function () {
        document.getElementById('add-address-form').classList.remove('d-none');
        document.getElementById('new-fullName').value = '';
        document.getElementById('new-phone').value = '';
        document.getElementById('new-address').value = '';
        document.getElementById('new-province').value = '';
        document.getElementById('new-district').innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
        document.getElementById('new-ward').innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
        loadProvinces('new-province');
    };

    window.hideAddAddressForm = function () {
        document.getElementById('add-address-form').classList.add('d-none');
    };

    window.saveNewAddress = async function () {
        const fullName = document.getElementById('new-fullName').value.trim();
        const phone    = document.getElementById('new-phone').value.trim();
        const address  = document.getElementById('new-address').value.trim();
        const pSel = document.getElementById('new-province');
        const dSel = document.getElementById('new-district');
        const wSel = document.getElementById('new-ward');

        const provinceId = pSel.value;
        const districtId = dSel.value;
        const wardCode   = wSel.value;

        const province = pSel.options[pSel.selectedIndex]?.text || '';
        const district = dSel.options[dSel.selectedIndex]?.text || '';
        const ward     = wSel.options[wSel.selectedIndex]?.text || '';

        if (!fullName || !phone || !address || !provinceId || !districtId || !wardCode) {
            Swal.fire({icon:'warning',title:'L·ªói',text:'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!'});
            return;
        }

        try {
            // 1) L∆∞u ƒë·ªãa ch·ªâ v√†o server (ƒë·ªïi URL/field cho kh·ªõp backend c·ªßa b·∫°n)
            const res = await fetch('/api/checkout/addresses', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    nguoiNhan: fullName,
                    soDienThoaiNguoiNhan: phone,
                    chiTietDiaChi: address,
                    phuongXa: ward,
                    quanHuyen: district,
                    tinhThanhPho: province,
                    wardCode: wardCode,             // n·∫øu backend c·∫ßn m√£
                    districtId: Number(districtId), // n·∫øu backend c·∫ßn id
                    provinceId: Number(provinceId), // n·∫øu backend c·∫ßn id
                    macDinh: false
                })
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                throw new Error(data.message || 'Kh√¥ng th·ªÉ l∆∞u ƒë·ªãa ch·ªâ.');
            }

            // id ƒë·ªãa ch·ªâ m·ªõi (t√πy backend tr·∫£ g√¨)
            const newId = data.data?.id || data.data;

            // 2) ƒê·ªï th√¥ng tin v√†o form ch√≠nh ƒë·ªÉ d√πng cho ƒë∆°n hi·ªán t·∫°i
            document.getElementById('fullName').value = fullName;
            document.getElementById('phone').value    = phone;
            document.getElementById('address').value  = `${address}, ${ward}, ${district}, ${province}`;
            document.getElementById('addressId').value = newId || ''; // c√≥ id th√¨ g√°n ƒë·ªÉ submit ƒë∆°n h√†ng d√πng id

            // ƒë·ªìng b·ªô c√°c select ·∫©n ƒë·ªÉ t√≠nh ship
            document.getElementById('province').value = provinceId;
            document.getElementById('district').value = districtId;
            document.getElementById('ward').value     = wardCode;

            // 3) Refresh danh s√°ch + auto highlight ƒë·ªãa ch·ªâ m·ªõi
            await loadSavedAddresses();
            if (newId) {
                const newCard = document.querySelector(`.address-card[data-id="${CSS.escape(newId)}"]`);
                if (newCard) {
                    newCard.classList.add('active');
                }
            }

            // 4) T√≠nh l·∫°i ship
            await loadShippingServices(districtId);
            await calculateShipping();

            // 5) ƒê√≥ng modal + th√¥ng b√°o
            bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
            document.getElementById('add-address-form').classList.add('d-none');
            Swal.fire({icon:'success',title:'ƒê√£ th√™m ƒë·ªãa ch·ªâ',timer:1200,showConfirmButton:false});
        } catch (err) {
            console.error(err);
            Swal.fire({icon:'error',title:'L·ªói',text: err.message || 'Kh√¥ng th·ªÉ th√™m ƒë·ªãa ch·ªâ.'});
        }
    };

    // ================== WALLET ==================
    async function loadWalletBalance() {
        const el = document.getElementById('wallet-balance');
        el.textContent = '(ƒêang t·∫£i...)';
        el.classList.add('loading');
        try {
            const res = await fetch('/api/wallet/balance', { credentials: 'include' });
            const data = await res.json();
            if (res.ok && data.success) el.textContent = `(S·ªë d∆∞: ${formatVND(data.data || 0)})`;
            else {
                el.textContent = '(Kh√¥ng c√≥ v√≠)';
                Swal.fire({ icon:'warning', title:'C·∫£nh b√°o', text: data.message || 'Kh√¥ng th·ªÉ t·∫£i s·ªë d∆∞ v√≠.' });
            }
            loadingState.walletBalance = true;
            checkLoadingComplete();
        } catch (err) {
            console.error('L·ªói t·∫£i s·ªë d∆∞ v√≠:', err);
            el.textContent = '(L·ªói t·∫£i s·ªë d∆∞)';
            Swal.fire({ icon:'error', title:'L·ªói', text:'Kh√¥ng th·ªÉ t·∫£i s·ªë d∆∞ v√≠. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi!' });
            loadingState.walletBalance = true;
            checkLoadingComplete();
        } finally {
            el.classList.remove('loading');
        }
    }

    // ================== ORDER ITEMS ==================
    async function loadOrderItems() {
        const container = document.getElementById('order-items');
        const mode = getCheckoutMode();
        let items = [];
        let subtotal = 0;

        if (mode === 'cart') {
            try {
                const response = await fetch('/api/cart', { credentials: 'include' });
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng');
                const cartData = await response.json();
                items = (cartData.chiTietGioHang || []).map(item => ({
                    chiTietSanPhamId: item.chiTietSanPham.id,
                    tenSanPham: item.chiTietSanPham.sanPham.tenSanPham,
                    soLuong: item.soLuong,
                    gia: item.gia,
                    urlHinhAnh: (item.chiTietSanPhams?.[0]?.urlHinhAnh)
                        || (item.chiTietSanPham.hinhAnhSanPhams?.[0]?.urlHinhAnh)
                        || item.chiTietSanPham.sanPham.urlHinhAnh
                        || '/images/default-product.jpg',
                    sizeName: item.chiTietSanPham.kichCo?.ten || 'N/A',
                    colorName: item.chiTietSanPham.mauSac?.tenMau || 'N/A',
                }));
            } catch (e) {
                Swal.fire({ icon:'error', title:'L·ªói', text: e.message || 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!' });
            }
        } else if (mode === 'cart-selected') {
            const ls = localStorage.getItem('cartSelectedItems');
            items = ls ? JSON.parse(ls) : [];
            if (!items.length) {
                container.innerHTML = `<p class="text-gray-600">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ thanh to√°n.</p>`;
                document.getElementById('submit-order').disabled = true;
            }
        } else {
            const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
            items = checkoutItem ? [checkoutItem] : [];
            if (!items.length) {
                container.innerHTML = `<p class="text-gray-600">Kh√¥ng c√≥ s·∫£n ph·∫©m trong ƒë∆°n h√†ng.</p>`;
                document.getElementById('submit-order').disabled = true;
            }
        }

        subtotal = items.reduce((sum, it) => sum + Number(it.gia || 0) * Number(it.soLuong || 0), 0);

        if (items.length) {
            container.innerHTML = items.map(item => `
      <div class="order-item d-flex align-items-center gap-3">
        <img src="${item.urlHinhAnh}" alt="${item.tenSanPham}" class="order-item-img" onerror="this.src='/images/default-product.jpg'"/>
        <div class="flex-1">
          <h6 class="fw-semibold text-gray-800 mb-1">${item.tenSanPham}</h6>
          <p class="text-gray-600 small mb-0">K√≠ch c·ª°: ${item.sizeName}</p>
          <p class="text-gray-600 small mb-0">M√†u s·∫Øc: ${item.colorName}</p>
          <p class="text-gray-600 small mb-0">S·ªë l∆∞·ª£ng: ${item.soLuong}</p>
          <p class="text-gray-600 small mb-0">ƒê∆°n gi√°: ${formatVND(item.gia)}</p>
          <p class="text-[#153054] fw-bold mb-0">Th√†nh ti·ªÅn: ${formatVND(Number(item.gia)*Number(item.soLuong))}</p>
        </div>
      </div>
    `).join('');
        }

        document.getElementById('subtotal').textContent = formatVND(subtotal);
        if (!document.getElementById('shipping-fee').textContent.trim()) {
            document.getElementById('shipping-fee').textContent = formatVND(0);
        }
        document.getElementById('discount-order').textContent = formatVND(0);
        document.getElementById('discount-ship').textContent = formatVND(0);
        updateTotal();

        loadingState.orderItems = true;
        checkLoadingComplete();

        // >>> th√™m d√≤ng n√†y
        markVoucherEligibility();
    }


    // Build body for voucher APIs (for buy-now & cart-selected)
    function buildVoucherBodyForCurrentMode() {
        const mode = getCheckoutMode();
        if (mode === 'cart') return []; // server d√πng to√†n b·ªô gi·ªè
        if (mode === 'cart-selected') {
            const items = JSON.parse(localStorage.getItem('cartSelectedItems') || '[]');
            return items.map(i => ({
                chiTietSanPhamId: i.chiTietSanPhamId,
                gia: Number(i.gia || 0),
                soLuong: Number(i.soLuong || 0),
            }));
        }
        const it = JSON.parse(localStorage.getItem('checkoutItem') || 'null');
        return it ? [{ chiTietSanPhamId: it.chiTietSanPhamId, gia: Number(it.gia||0), soLuong: Number(it.soLuong||0) }] : [];
    }

    // ================== VOUCHERS ==================
    async function applyOrderVoucher({ silent = false } = {}) {
        const voucherCode = document.getElementById('order-voucher').value.trim();
        const discountEl = document.getElementById('discount-order');

        // kh√¥ng ch·ªçn m√£ -> coi nh∆∞ ok, ch·ªâ clear
        if (!voucherCode) {
            discountEl.textContent = formatVND(0);
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
            return { ok: true, discount: 0, message: 'Kh√¥ng ch·ªçn m√£ ORDER' };
        }

        const mode = getCheckoutMode();
        const source = mode; // 'cart' | 'cart-selected' | 'buy-now'
        const subtotal = onlyDigits(document.getElementById('subtotal').textContent);
        const checkoutItems = buildVoucherBodyForCurrentMode();

        try {
            const url = `/api/checkout/apply-voucher?voucher=${encodeURIComponent(voucherCode)}&source=${source}&type=ORDER&subtotal=${subtotal}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(checkoutItems)
            });
            const data = await res.json();

            if (res.ok && (data.success || data.isSuccess)) {
                const discount = Number(data.data || 0);
                discountEl.textContent = formatVND(discount);
                if (!silent) {
                    Swal.fire({ icon:'success', title:'√Åp d·ª•ng m√£ ORDER th√†nh c√¥ng', text:`Gi·∫£m ${formatVND(discount)}`, timer:1200, showConfirmButton:false });
                }
                return { ok: true, discount, message: data.message || '' };
            } else {
                discountEl.textContent = formatVND(0);
                if (!silent) Swal.fire({ icon:'error', title:'ORDER th·∫•t b·∫°i', text: data.message || '√Åp d·ª•ng m√£ th·∫•t b·∫°i' });
                return { ok: false, discount: 0, message: data.message || '√Åp d·ª•ng m√£ th·∫•t b·∫°i' };
            }
        } catch (err) {
            console.error('L·ªói ORDER voucher:', err);
            discountEl.textContent = formatVND(0);
            if (!silent) Swal.fire({ icon:'error', title:'L·ªói', text:'ƒê√£ x·∫£y ra l·ªói khi √°p d·ª•ng m√£ ORDER!' });
            return { ok: false, discount: 0, message: 'L·ªói √°p d·ª•ng m√£ ORDER' };
        } finally {
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        }
    }



    async function applyShipVoucher({ silent = false } = {}) {
        const code = document.getElementById('ship-voucher').value.trim();
        const elDiscountShip = document.getElementById('discount-ship');

        if (!code) {
            elDiscountShip.textContent = formatVND(0);
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
            return { ok: true, discount: 0, message: 'Kh√¥ng ch·ªçn m√£ FREESHIP' };
        }

        const shippingFee = onlyDigits(document.getElementById('shipping-fee').textContent);
        const subtotal = onlyDigits(document.getElementById('subtotal').textContent);
        const mode = getCheckoutMode();
        const source = mode;
        const body = buildVoucherBodyForCurrentMode();

        if (shippingFee <= 0) {
            if (!silent) Swal.fire({ icon:'warning', title:'Ch∆∞a c√≥ ph√≠ v·∫≠n chuy·ªÉn', text:'Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ ƒë·ªÉ t√≠nh ph√≠ ship tr∆∞·ªõc.' });
            elDiscountShip.textContent = formatVND(0);
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
            return { ok: false, discount: 0, message: 'Ch∆∞a c√≥ ph√≠ v·∫≠n chuy·ªÉn' };
        }

        const url = `/api/checkout/apply-voucher?voucher=${encodeURIComponent(code)}&source=${source}&type=SHIPPING&shippingFee=${shippingFee}&subtotal=${subtotal}`;

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(body)
            });
            const data = await res.json();

            if (res.ok && (data.success || data.isSuccess)) {
                const currentShip = onlyDigits(document.getElementById('shipping-fee').textContent);
                const discount = Math.min(Number(data.data || 0), currentShip);
                elDiscountShip.textContent = formatVND(discount);
                if (!silent) {
                    Swal.fire({ icon:'success', title:'√Åp d·ª•ng FREESHIP th√†nh c√¥ng', text:`Gi·∫£m ${formatVND(discount)} ph√≠ v·∫≠n chuy·ªÉn`, timer:1200, showConfirmButton:false });
                }
                return { ok: true, discount, message: data.message || '' };
            } else {
                elDiscountShip.textContent = formatVND(0);
                if (!silent) Swal.fire({ icon:'error', title:'FREESHIP th·∫•t b·∫°i', text: data.message || '√Åp d·ª•ng m√£ freeship th·∫•t b·∫°i' });
                return { ok: false, discount: 0, message: data.message || '√Åp d·ª•ng m√£ freeship th·∫•t b·∫°i' };
            }
        } catch (e) {
            console.error('L·ªói FREESHIP:', e);
            elDiscountShip.textContent = formatVND(0);
            if (!silent) Swal.fire({ icon:'error', title:'L·ªói', text:'ƒê√£ x·∫£y ra l·ªói khi √°p d·ª•ng m√£ freeship!' });
            return { ok: false, discount: 0, message: 'L·ªói √°p d·ª•ng m√£ FREESHIP' };
        } finally {
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        }
    }



    // ================== SUBMIT ORDER ==================
    async function submitOrder(e) {
        e.preventDefault();
        const btn = document.getElementById('submit-order');
        btn.classList.add('loading');
        btn.disabled = true;

        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const addressId = document.getElementById('addressId').value.trim();

        const province = document.getElementById('province').options[document.getElementById('province').selectedIndex]?.text || '';
        const district = document.getElementById('district').options[document.getElementById('district').selectedIndex]?.text || '';
        const ward = document.getElementById('ward').options[document.getElementById('ward').selectedIndex]?.text || '';

        if (!fullName || !phone || !address) {
            Swal.fire({ icon:'warning', title:'L·ªói', text:'Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!' });
            btn.classList.remove('loading'); btn.disabled = false; return;
        }

        const mode = getCheckoutMode();
        let items = [];
        let source = '';

        try {
            if (mode === 'cart') {
                const response = await fetch('/api/cart', { credentials: 'include' });
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng');
                const cartData = await response.json();
                items = (cartData.chiTietGioHang || []).map(i => ({
                    chiTietSanPhamId: i.chiTietSanPham.id,
                    soLuong: i.soLuong,
                    tenSanPham: i.chiTietSanPham.sanPham.tenSanPham,
                    gia: i.gia
                }));
                source = 'Gi·ªè h√†ng (API /cart)';
            } else if (mode === 'cart-selected') {
                items = JSON.parse(localStorage.getItem('cartSelectedItems') || '[]')
                    .map(i => ({ chiTietSanPhamId: i.chiTietSanPhamId, soLuong: i.soLuong, tenSanPham: i.tenSanPham, gia: i.gia }));
                source = 'Gi·ªè h√†ng (ƒë√£ ch·ªçn)';
            } else {
                const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem') || 'null');
                if (checkoutItem) {
                    items = [{ chiTietSanPhamId: checkoutItem.chiTietSanPhamId, soLuong: checkoutItem.soLuong, tenSanPham: checkoutItem.tenSanPham, gia: checkoutItem.gia }];
                    source = 'Mua ngay (localStorage.checkoutItem)';
                }
            }
        } catch (err) {
            Swal.fire({ icon:'error', title:'L·ªói', text: err.message || 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!' });
            btn.classList.remove('loading'); btn.disabled = false; return;
        }

        if (!items.length) {
            Swal.fire({ icon:'warning', title:'L·ªói', text:`Kh√¥ng c√≥ s·∫£n ph·∫©m trong ${mode==='cart'?'gi·ªè h√†ng':(mode==='cart-selected'?'danh s√°ch ƒë√£ ch·ªçn':'ƒë∆°n h√†ng')}!` });
            btn.classList.remove('loading'); btn.disabled = false; return;
        }

        const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        const shippingFee = onlyDigits(document.getElementById('shipping-fee').textContent);
        const subtotal = onlyDigits(document.getElementById('subtotal').textContent);
        const discountOrder = onlyDigits(document.getElementById('discount-order').textContent);
        const discountShip = onlyDigits(document.getElementById('discount-ship').textContent);
        const totalAmount = subtotal + shippingFee - discountOrder - discountShip;

        const orderVoucher = document.getElementById('order-voucher').value.trim();
        const shipVoucher = document.getElementById('ship-voucher').value.trim();

        const orderData = {
            addressId: addressId,
            fullName: fullName,
            phone: phone,
            address: addressId ? '' : `${address}, ${ward}, ${district}, ${province}`,
            shippingMethod: document.getElementById('shippingMethod').value,
            paymentMethodId: selectedMethod,
            notes: document.getElementById('note').value,
            voucherOrder: orderVoucher || '',
            voucherShipping: shipVoucher || '',
            shippingFee: shippingFee,
            orderItems: items.map(i => ({ chiTietSanPhamId: i.chiTietSanPhamId, soLuong: i.soLuong })),
            source: source
        };

        // V√≠ ƒëi·ªán t·ª≠ ‚Äì ki·ªÉm tra s·ªë d∆∞
        if (selectedMethod === '550E8400-E29B-41D4-A716-446655440019') {
            try {
                const res = await fetch('/api/wallet/balance', { credentials: 'include' });
                const data = await res.json();
                if (!res.ok || !data.success || (data.data || 0) < totalAmount) {
                    Swal.fire({
                        icon:'warning',
                        title:'S·ªë d∆∞ kh√¥ng ƒë·ªß',
                        html:`<p>B·∫°n c·∫ßn <strong>${formatVND(totalAmount)}</strong> nh∆∞ng s·ªë d∆∞ hi·ªán t·∫°i l√† <strong>${formatVND(data.data || 0)}</strong>.</p><p>Vui l√≤ng n·∫°p th√™m ti·ªÅn v√†o v√≠ ƒë·ªÉ ti·∫øp t·ª•c.</p>`,
                        showCancelButton:true,
                        confirmButtonText:'N·∫°p ti·ªÅn ngay',
                        cancelButtonText:'Quay l·∫°i',
                        confirmButtonColor:'#153054',
                        cancelButtonColor:'#d33',
                    }).then(r => { if (r.isConfirmed) location.href = '/vi?redirect=/thanh-toan'; });
                    btn.classList.remove('loading'); btn.disabled = false; return;
                }
            } catch (err) {
                console.error('L·ªói ki·ªÉm tra s·ªë d∆∞ v√≠:', err);
                Swal.fire({ icon:'error', title:'L·ªói', text:'Kh√¥ng th·ªÉ ki·ªÉm tra s·ªë d∆∞ v√≠. Vui l√≤ng th·ª≠ l·∫°i!' });
                btn.classList.remove('loading'); btn.disabled = false; return;
            }
        }

        const confirmResult = await Swal.fire({
            icon:'question',
            title:'X√°c nh·∫≠n thanh to√°n',
            html: `
            <p><strong>T·ªïng ti·ªÅn:</strong> ${formatVND(totalAmount)}</p>
            <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${
                selectedMethod === '550E8400-E29B-41D4-A716-446655440017' ? 'Thanh to√°n khi nh·∫≠n h√†ng (COD)'
                    : selectedMethod === '550E8400-E29B-41D4-A716-446655440018' ? 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng' : 'V√≠ ƒëi·ªán t·ª≠'
            }</p>
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c thanh to√°n?</p>
          `,
            showCancelButton:true,
            confirmButtonText:'X√°c nh·∫≠n',
            cancelButtonText:'H·ªßy',
            confirmButtonColor:'#153054',
            cancelButtonColor:'#d33'
        });

        if (!confirmResult.isConfirmed) { btn.classList.remove('loading'); btn.disabled = false; return; }

        try {
            if (selectedMethod === '550E8400-E29B-41D4-A716-446655440018') {
                if (totalAmount <= 0) {
                    Swal.fire({ icon:'warning', title:'L·ªói', text:'T·ªïng ti·ªÅn ph·∫£i l·ªõn h∆°n 0.' });
                    btn.classList.remove('loading'); btn.disabled = false; return;
                }
                const form = document.createElement('form');
                form.method = 'POST'; form.action = '/kh-payment/kh-create-payment-link'; form.style.display = 'none';

                const productNameInput = document.createElement('input');
                productNameInput.type = 'hidden'; productNameInput.name = 'productName';
                productNameInput.value = items.map(i => i.tenSanPham).join(', '); form.appendChild(productNameInput);

                const priceInput = document.createElement('input');
                priceInput.type = 'hidden'; priceInput.name = 'price';
                priceInput.value = totalAmount.toString(); form.appendChild(priceInput);

                const descriptionInput = document.createElement('input');
                descriptionInput.type = 'hidden'; descriptionInput.name = 'description';
                descriptionInput.value = 'Thanh to√°n ƒë∆°n h√†ng'; form.appendChild(descriptionInput);

                sessionStorage.setItem('pendingOrder', JSON.stringify({ orderData }));
                document.body.appendChild(form); form.submit();
            } else {
                const response = await fetch('/api/checkout/submit', {
                    method:'POST',
                    headers:{ 'Content-Type':'application/json' },
                    body: JSON.stringify(orderData),
                    credentials:'include'
                });
                const data = await response.json();
                if (response.ok) {
                    if (mode === 'buy-now') localStorage.removeItem('checkoutItem');
                    if (mode === 'cart-selected') localStorage.removeItem('cartSelectedItems');
                    Swal.fire({
                        icon:'success', title:'Th√†nh c√¥ng',
                        text:`ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${data.data}`,
                        showCancelButton:true, confirmButtonText:'Trang ch·ªß', cancelButtonText:'ƒê∆°n mua',
                        confirmButtonColor:'#153054', cancelButtonColor:'#9fd5f7',
                        customClass:{ cancelButton:'swal-cancel-button' }
                    }).then(r => {
                        if (r.isConfirmed) location.href = '/';
                        else if (r.isDismissed) location.href = '/dsdon-mua';
                    });
                } else {
                    Swal.fire({ icon:'error', title:'L·ªói', text: data.message || 'Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng! Vui l√≤ng th·ª≠ l·∫°i.' });
                }
            }
        } catch (err) {
            console.error('L·ªói g·ª≠i ƒë∆°n h√†ng:', err);
            Swal.fire({ icon:'error', title:'L·ªói', text:'ƒê√£ x·∫£y ra l·ªói khi g·ª≠i ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!' });
        } finally {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }

    // ================== CART COUNT ==================
    async function updateCartCount() {
        try {
            const res = await fetch('/api/cart', { credentials: 'include' });
            if (res.ok) {
                const data = await res.json();
                const count = data.chiTietGioHang ? data.chiTietGioHang.length : 0;
                document.getElementById('cart-count').textContent = count;
            } else if (res.status === 401) {
                document.getElementById('cart-count').textContent = 0;
            }
        } catch (err) {
            console.error('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng:', err);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // ===== INIT =====
        loadProvinces();
        loadOrderItems();
        updateCartCount();
        loadSavedAddresses();
        loadWalletBalance();

        document
            .querySelector('.payment-method[data-value="550E8400-E29B-41D4-A716-446655440017"]')
            ?.classList.add('active');

        // ===== ADDRESS / SHIPPING EVENTS =====
        document.getElementById('province')?.addEventListener('change', (e) => {
            const provinceId = parseInt(e.target.value);
            if (provinceId) loadDistricts(provinceId);
        });

        document.getElementById('district')?.addEventListener('change', async (e) => {
            const districtId = parseInt(e.target.value);
            if (districtId) await loadWards(districtId);
            await loadShippingServices(districtId);
        });

        document.getElementById('ward')?.addEventListener('change', calculateShipping);

        document.getElementById('new-province')?.addEventListener('change', (e) => {
            const provinceId = parseInt(e.target.value);
            if (provinceId) loadDistricts(provinceId, 'new-district');
        });

        document.getElementById('new-district')?.addEventListener('change', async (e) => {
            const districtId = parseInt(e.target.value);
            if (districtId) await loadWards(districtId, 'new-ward');
        });

        // ===== PAYMENT CARD SELECT =====
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', () => {
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
                method.classList.add('active');
                method.querySelector('input').checked = true;
            });
        });

        // ===== VOUCHER HIDDEN SELECTS =====
        document.getElementById('order-voucher')?.addEventListener('change', async () => {
            await applyOrderVoucher();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        });

        document.getElementById('ship-voucher')?.addEventListener('change', async () => {
            await applyShipVoucher();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        });

        document.getElementById('shippingMethod')?.addEventListener('change', calculateShipping);
        document.getElementById('submit-order')?.addEventListener('click', submitOrder);

        // ===== VOUCHER MODAL HANDLERS =====
        const modalEl   = document.getElementById('voucherModal');
        const btnClear  = document.getElementById('btn-clear-vouchers');
        const btnApply  = document.getElementById('btn-apply-vouchers');
        const searchInput = document.getElementById('voucher-search');
        const searchClear = document.getElementById('voucher-search-clear');

        if (modalEl) {
            // Khi m·ªü modal -> ƒë√°nh gi√° ƒëi·ªÅu ki·ªán & focus √¥ t√¨m ki·∫øm
            modalEl.addEventListener('shown.bs.modal', () => {
                if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
                if (searchInput) {
                    searchInput.focus({ preventScroll: true });
                    if (typeof filterVouchersInModal === 'function') {
                        filterVouchersInModal(searchInput.value || '');
                    }
                }
            });

            // Cho ph√©p click l·∫ßn 2 ƒë·ªÉ b·ªè ch·ªçn radio (b·ªè qua radio b·ªã disabled)
            let lastShip = null, lastOrder = null;
            modalEl.addEventListener('click', (e) => {
                if (e.target.matches('input[name="rb-ship"]') && !e.target.disabled) {
                    if (lastShip === e.target) { e.target.checked = false; lastShip = null; }
                    else { lastShip = e.target; }
                }
                if (e.target.matches('input[name="rb-order"]') && !e.target.disabled) {
                    if (lastOrder === e.target) { e.target.checked = false; lastOrder = null; }
                    else { lastOrder = e.target; }
                }
            });

            // B·ªè ch·ªçn t·∫•t c·∫£ trong modal
            btnClear?.addEventListener('click', () => {
                modalEl.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
                lastShip = null; lastOrder = null;
            });

            // √Åp d·ª•ng: ƒë·ªï v√†o 2 select ·∫©n, g·ªçi logic √°p m√£, c·∫≠p nh·∫≠t summary, ƒë√≥ng modal
            btnApply?.addEventListener('click', async () => {
                const ship  = modalEl.querySelector('input[name="rb-ship"]:checked')?.value || '';
                const order = modalEl.querySelector('input[name="rb-order"]:checked')?.value || '';

                const selShip  = document.getElementById('ship-voucher');
                const selOrder = document.getElementById('order-voucher');
                selShip.value  = ship;
                selOrder.value = order;

                // G·ªçi 2 h√†m √°p m√£ ·ªü ch·∫ø ƒë·ªô silent ƒë·ªÉ KH√îNG b·∫≠t Swal ri√™ng l·∫ª
                const orderResult = await applyOrderVoucher({ silent: true });
                const shipResult  = await applyShipVoucher({ silent: true });

                if (typeof markVoucherEligibility === 'function') markVoucherEligibility();

                // C·∫≠p nh·∫≠t t√≥m t·∫Øt
                const parts = [];
                if (order) {
                    const t = selOrder.querySelector(`option[value="${CSS.escape(order)}"]`)?.textContent || order;
                    parts.push('ORDER: ' + t);
                }
                if (ship) {
                    const t = selShip.querySelector(`option[value="${CSS.escape(ship)}"]`)?.textContent || ship;
                    parts.push('SHIP: ' + t);
                }
                document.getElementById('voucher-summary').textContent =
                    parts.length ? parts.join(' | ') : 'Ch∆∞a ch·ªçn';

                // T·∫°o th√¥ng b√°o t·ªïng h·ª£p
                const lines = [];
                if (order) {
                    lines.push(orderResult.ok
                        ? `ORDER: gi·∫£m <b>${formatVND(orderResult.discount)}</b>`
                        : `ORDER: <span style="color:#c00">${orderResult.message || 'Kh√¥ng √°p d·ª•ng ƒë∆∞·ª£c'}</span>`);
                }
                if (ship) {
                    lines.push(shipResult.ok
                        ? `FREESHIP: gi·∫£m <b>${formatVND(shipResult.discount)}</b>`
                        : `FREESHIP: <span style="color:#c00">${shipResult.message || 'Kh√¥ng √°p d·ª•ng ƒë∆∞·ª£c'}</span>`);
                }

                // Ch·ªçn icon ph√π h·ª£p
                const overallOk =
                    (order ? orderResult.ok : true) &&
                    (ship ? shipResult.ok : true);

                Swal.fire({
                    icon: overallOk ? 'success' : (orderResult.ok || shipResult.ok ? 'info' : 'error'),
                    title: 'K·∫øt qu·∫£ √°p m√£',
                    html: lines.join('<br>'),
                    timer: 1600,
                    showConfirmButton: false
                });

                // ƒê√≥ng modal
                (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl)).hide();
            });


            // ====== T√åM KI·∫æM TRONG MODAL =====
            if (searchInput) {
                const doFilter = debounce(() => {
                    if (typeof filterVouchersInModal === 'function') {
                        filterVouchersInModal(searchInput.value);
                    }
                }, 150);
                searchInput.addEventListener('input', doFilter);

                // (Tu·ª≥ ch·ªçn) reset khi ƒë√≥ng modal
                // modalEl.addEventListener('hidden.bs.modal', () => {
                //   searchInput.value = '';
                //   if (typeof filterVouchersInModal === 'function') filterVouchersInModal('');
                // });
            }

            if (searchClear) {
                searchClear.addEventListener('click', () => {
                    if (!searchInput) return;
                    searchInput.value = '';
                    if (typeof filterVouchersInModal === 'function') filterVouchersInModal('');
                    searchInput.focus({ preventScroll: true });
                });
            }
        }
    });

    // === M·ªû/ƒê√ìNG MODAL (g·ªçi ·ªü n√∫t "Ch·ªçn") ===
    function openVoucherModal() {
        const el = document.getElementById('voucherModal');
        if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        new bootstrap.Modal(el).show();
    }
    function closeVoucherModal() {
        const m = bootstrap.Modal.getInstance(document.getElementById('voucherModal'));
        if (m) m.hide();
    }

</script>
</body>
</html>
