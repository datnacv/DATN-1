<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ACV Store - Thanh to√°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom, #f8fafc, #e2e8f0); }
        .navbar { background: linear-gradient(90deg, #f97316, #ef4444); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .container { max-width: 1280px; }
        .section-box { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .section-box:hover { transform: translateY(-4px); box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .section-title { font-size: 20px; font-weight: 700; color: #f97316; display: flex; align-items: center; }
        .order-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .form-control { border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px 14px; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .form-control:focus { border-color: #f97316; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1); outline: none; }
        .btn-primary { background: linear-gradient(90deg, #f97316, #ef4444); border: none; border-radius: 8px; padding: 12px; font-weight: 600; transition: background 0.3s ease, transform 0.2s ease; }
        .btn-primary:hover { background: linear-gradient(90deg, #ef4444, #f97316); transform: translateY(-2px); }
        .voucher-btn { background: white; border: 1px solid #f97316; color: #f97316; border-radius: 8px; padding: 10px 16px; font-weight: 600; transition: all 0.3s ease; }
        .voucher-btn:hover { background: #f97316; color: white; }
        .payment-method { padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s ease; }
        .payment-method:hover { border-color: #f97316; background: #fff7ed; }
        .payment-method.active { border-color: #f97316; background: #fff7ed; }
        .order-item { border-bottom: 1px solid #e5e7eb; padding-bottom: 16px; }
        .submit-btn { position: sticky; bottom: 20px; }
        @media (max-width: 768px) {
            .order-item-img { width: 60px; height: 60px; }
            .section-box { padding: 16px; }
            .container { padding: 0 16px; }
        }
    </style>
</head>
<body>
<nav class="navbar fixed-top">
    <div class="container mx-auto flex items-center justify-between py-4 px-6">
        <a href="/" class="text-2xl font-bold text-white">ACV Store</a>
        <div class="flex items-center space-x-6">
            <a href="/cart" class="text-white text-xl relative">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2 py-1">0</span>
            </a>
        </div>
    </div>
</nav>

<section class="container mx-auto py-24">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Thanh to√°n</h1>
    <div th:if="${error}" class="bg-red-100 text-red-700 p-4 rounded mb-4" th:text="${error}"></div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-user mr-2"></i> Th√¥ng tin kh√°ch h√†ng</h2>
                <form id="checkout-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n</label>
                            <input type="text" id="fullName" name="fullName" class="form-control w-full" th:value="${loggedInUser?.hoTen}" required/>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="phone" name="phone" class="form-control w-full" th:value="${loggedInUser?.soDienThoai}" required/>
                        </div>
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</label>
                        <input type="text" id="address" name="address" class="form-control w-full" th:value="${loggedInUser?.diaChi}" required/>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 mt-4">
                        <select id="province" class="form-control" required>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>
                        </select>
                        <select id="district" class="form-control" required>
                            <option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>
                        </select>
                        <select id="ward" class="form-control" required>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="section-box" hidden>
                <h2 class="section-title mb-4"><i class="fas fa-truck mr-2"></i> Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn</h2>
                <select id="shippingMethod" name="shippingMethod" class="form-control w-full" required>
                    <option value="53321">Giao h√†ng nhanh (H√†ng nh·∫π)</option>
                    <option value="100039">Giao h√†ng ch·∫≠m (H√†ng n·∫∑ng)</option>
                </select>
            </div>

            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-credit-card mr-2"></i> Ph∆∞∆°ng th·ª©c thanh to√°n</h2>
                <div class="payment-method active" data-value="550E8400-E29B-41D4-A716-446655440017">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440017" checked>
                    <span class="ml-2 font-medium">Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
                </div>
                <div class="payment-method" data-value="550E8400-E29B-41D4-A716-446655440018">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440018">
                    <span class="ml-2 font-medium">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                </div>
            </div>

            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-sticky-note mr-2"></i> Ghi ch√∫</h2>
                <textarea id="note" name="note" class="form-control w-full" rows="4" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (t√πy ch·ªçn)"></textarea>
            </div>
        </div>

        <div class="section-box">
            <h2 class="section-title mb-4"><i class="fas fa-shopping-bag mr-2"></i> ƒê∆°n h√†ng</h2>
            <div id="order-items" class="space-y-4 mb-6"></div>
            <div class="border-t pt-4">
                <div class="flex justify-between mb-2 text-sm">
                    <span>T·∫°m t√≠nh:</span>
                    <span id="subtotal" class="font-semibold">0 VNƒê</span>
                </div>
                <div class="flex justify-between mb-2 text-sm">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                    <span id="shipping-fee" class="font-semibold">15,000 VNƒê</span>
                </div>
                <div class="flex justify-between mb-2 text-sm">
                    <span>Gi·∫£m gi√°:</span>
                    <span id="discount" class="font-semibold">0 VNƒê</span>
                </div>
                <div class="flex justify-between text-lg font-bold">
                    <span>T·ªïng ti·ªÅn:</span>
                    <span id="total" class="text-orange-600">15,000 VNƒê</span>
                </div>
            </div>
            <div class="mt-6">
                <label for="voucher" class="block text-sm font-medium text-gray-700 mb-1">M√£ gi·∫£m gi√°</label>
                <div class="flex space-x-3">
                    <input type="text" id="voucher" class="form-control w-full" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°"/>
                    <button id="apply-voucher" class="voucher-btn">√Åp d·ª•ng</button>
                </div>
            </div>
            <button id="submit-order" class="btn btn-primary w-full mt-6 submit-btn">
                <i class="fas fa-check-circle mr-2"></i> ƒê·∫∑t h√†ng
            </button>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let provinceList = [];
    let districtList = [];

    // Format number to VND
    function formatVND(number) {
        return new Intl.NumberFormat('vi-VN', { style: 'decimal', minimumFractionDigits: 0 }).format(number) + ' VNƒê';
    }

    // Check if the checkout is from cart
    function isFromCart() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('from') === 'cart';
    }

    // Load t·ªânh/th√†nh ph·ªë t·ª´ GHN API
    async function loadProvinces() {
        try {
            const response = await fetch('/api/ghn/provinces');
            const json = await response.json();
            if (!json || !json.data) throw new Error("No data field in response");

            const result = JSON.parse(json.data);
            const provinces = result.data;
            provinceList = provinces;

            const provinceSelect = document.getElementById('province');
            provinces.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.ProvinceID;
                opt.textContent = p.ProvinceName;
                provinceSelect.appendChild(opt);
            });
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói t·∫£i t·ªânh/th√†nh',
                text: err.message
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadProvinces();
    });

    // Load qu·∫≠n/huy·ªán d·ª±a v√†o t·ªânh ƒë∆∞·ª£c ch·ªçn
    async function loadDistricts(provinceId) {
        try {
            const response = await fetch(`/api/ghn/districts?provinceId=${provinceId}`);
            const json = await response.json();
            if (!json || !json.data) throw new Error("No data field in district response");

            const result = JSON.parse(json.data);
            const districts = result.data;
            districtList = districts;

            const select = document.getElementById('district');
            select.innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
            districts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.DistrictID;
                opt.textContent = d.DistrictName;
                select.appendChild(opt);
            });

            document.getElementById('ward').innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói t·∫£i qu·∫≠n/huy·ªán',
                text: err.message
            });
        }
    }

    // Load ph∆∞·ªùng/x√£ d·ª±a v√†o qu·∫≠n ƒë∆∞·ª£c ch·ªçn
    async function loadWards(districtId) {
        try {
            const response = await fetch(`/api/ghn/wards?districtId=${districtId}`);
            const json = await response.json();
            if (!json || !json.data) throw new Error("No data field in ward response");

            const result = JSON.parse(json.data);
            const wards = result.data;

            const select = document.getElementById('ward');
            select.innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
            wards.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.WardCode;
                opt.textContent = w.WardName;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói t·∫£i ph∆∞·ªùng/x√£',
                text: err.message
            });
        }
    }

    document.getElementById('province').addEventListener('change', (e) => {
        const provinceId = parseInt(e.target.value);
        if (provinceId) loadDistricts(provinceId);
    });

    document.getElementById('district').addEventListener('change', async (e) => {
        const districtId = parseInt(e.target.value);
        if (!districtId) return;

        await loadWards(districtId);
        await loadShippingServices(districtId);
    });

    async function loadShippingServices(toDistrictId) {
        const fromDistrictId = 1542;

        try {
            const res = await fetch(`/api/ghn/available-services?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}`);
            const json = await res.json();
            const services = JSON.parse(json.data).data;

            const select = document.getElementById('shippingMethod');
            select.innerHTML = '';

            services.forEach(service => {
                const opt = document.createElement('option');
                opt.value = service.service_id;
                opt.textContent = service.short_name + ` (${service.service_type_id})`;
                select.appendChild(opt);
            });

            if (services.length > 0) {
                select.value = services[0].service_id;
                await calculateShipping();
            }
        } catch (err) {
            console.error("L·ªói load serviceId:", err);
            Swal.fire({ icon: 'error', title: 'Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªãch v·ª• v·∫≠n chuy·ªÉn', text: err.message });
        }
    }

    async function calculateShipping() {
        const toDistrictId = document.getElementById('district').value;
        const toWardCode = document.getElementById('ward').value;
        const serviceId = document.getElementById('shippingMethod').value;
        const fromDistrictId = 1542;

        if (!toDistrictId || !toWardCode || !serviceId) return;

        try {
            const response = await fetch(`/api/ghn/shipping-fee?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}&toWardCode=${toWardCode}&weight=500&length=20&width=15&height=10&serviceId=${serviceId}&insuranceValue=100000`);
            const json = await response.json();
            const fee = JSON.parse(json.data).data.total;

            document.getElementById('shipping-fee').textContent = formatVND(fee);
            updateTotal();
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói t√≠nh ph√≠ v·∫≠n chuy·ªÉn',
                text: err.message
            });
        }
    }

    document.getElementById('ward').addEventListener('change', () => {
        calculateShipping();
    });

    function updateTotal() {
        const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace(/[^\d]/g, '')) || 0;
        const shipping = parseFloat(document.getElementById('shipping-fee').textContent.replace(/[^\d]/g, '')) || 0;
        const discount = parseFloat(document.getElementById('discount').textContent.replace(/[^\d]/g, '')) || 0;
        document.getElementById('total').textContent = formatVND(subtotal + shipping - discount);
    }

    async function loadSavedAddress() {
        try {
            const res = await fetch("/api/checkout/addresses");
            const data = await res.json();

            const normalize = str =>
                str
                    ?.toLowerCase()
                    .replace(/(t·ªânh|th√†nh ph·ªë)/gi, "")
                    .replace(/[\s\.\-]/g, "")
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "");

            const provinceRes = await fetch("/api/ghn/provinces");
            const provinceJson = await provinceRes.json();
            const provinceList = JSON.parse(provinceJson.data).data;

            const province = provinceList.find(p =>
                normalize(p.ProvinceName).includes(normalize(data.tinhThanhPho))
            );

            if (!province) throw new Error("Kh√¥ng t√¨m th·∫•y t·ªânh t∆∞∆°ng ·ª©ng");

            document.querySelector("#province").value = province.ProvinceID;

            await loadDistricts(province.ProvinceID);
            const districtRes = await fetch(`/api/ghn/districts?provinceId=${province.ProvinceID}`);
            const districtJson = await districtRes.json();
            const districtList = JSON.parse(districtJson.data).data;

            const district = districtList.find(d =>
                normalize(d.DistrictName).includes(normalize(data.quanHuyen))
            );
            if (!district) throw new Error("Kh√¥ng t√¨m th·∫•y qu·∫≠n/huy·ªán t∆∞∆°ng ·ª©ng");
            document.querySelector("#district").value = district.DistrictID;

            await loadWards(district.DistrictID);
            const wardRes = await fetch(`/api/ghn/wards?districtId=${district.DistrictID}`);
            const wardJson = await wardRes.json();
            const wardList = JSON.parse(wardJson.data).data;

            const ward = wardList.find(w =>
                normalize(w.WardName).includes(normalize(data.phuongXa))
            );
            if (!ward) throw new Error("Kh√¥ng t√¨m th·∫•y ph∆∞·ªùng/x√£ t∆∞∆°ng ·ª©ng");
            document.querySelector("#ward").value = ward.WardCode;

            document.querySelector("#address").value = data.chiTietDiaChi || "";
            await loadShippingServices(district.DistrictID);
            await calculateShipping();
        } catch (err) {
            console.error("L·ªói khi t·∫£i ƒë·ªãa ch·ªâ:", err);
            Swal.fire({
                icon: "error",
                title: "L·ªói ƒë·ªãa ch·ªâ",
                text: err.message
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadProvinces();
        loadOrderItems();
        loadSavedAddress();
        updateCartCount();
        document.querySelector('.payment-method[data-value="550E8400-E29B-41D4-A716-446655440017"]').classList.add('active');
    });

    async function getShippingFee() {
        try {
            const fromDistrictId = 1542;
            const toDistrictId = parseInt(document.getElementById("district").value);
            const toWardCode = document.getElementById("ward").value;

            const res = await fetch(`/api/ghn/available-services?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}`);
            const serviceData = await res.json();
            const serviceList = JSON.parse(serviceData.data).data;
            const serviceId = serviceList[0]?.service_id;

            if (!serviceId) throw new Error("Kh√¥ng t√¨m th·∫•y d·ªãch v·ª• GHN");

            const shippingRes = await fetch(`/api/ghn/shipping-fee?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}&toWardCode=${toWardCode}&weight=500&length=20&width=15&height=10&serviceId=${serviceId}&insuranceValue=100000`);
            const json = await shippingRes.json();

            const fee = JSON.parse(json.data).data.total;
            document.getElementById("shippingFee").innerText = fee.toLocaleString("vi-VN") + " VND";
        } catch (error) {
            alert("L·ªói t√≠nh ph√≠ v·∫≠n chuy·ªÉn: " + error.message);
        }
    }

    // Load order items
    async function loadOrderItems() {
        const orderItemsContainer = document.getElementById('order-items');
        let subtotal = 0;
        let items = [];
        let source = '';

        if (isFromCart()) {
            try {
                const response = await fetch('/api/cart', { credentials: 'include' });
                if (response.ok) {
                    const cartData = await response.json();
                    items = cartData.chiTietGioHang.map(item => ({
                        chiTietSanPhamId: item.chiTietSanPham.id,
                        tenSanPham: item.chiTietSanPham.sanPham.tenSanPham,
                        soLuong: item.soLuong,
                        gia: item.gia,
                        urlHinhAnh: item.chiTietSanPham.urlHinhAnh || '/images/default-product.jpg',
                        sizeId: item.chiTietSanPham.kichCo.id,
                        colorId: item.chiTietSanPham.mauSac.id,
                        sizeName: item.chiTietSanPham.kichCo.ten,
                        colorName: item.chiTietSanPham.mauSac.tenMau
                    }));
                    subtotal = items.reduce((sum, item) => sum + item.gia * item.soLuong, 0);
                    source = 'Gi·ªè h√†ng (API /cart)';
                    console.log('Ngu·ªìn d·ªØ li·ªáu:', source, items);
                } else {
                    console.log('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng t·ª´ API /cart. Tr·∫°ng th√°i:', response.status);
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói',
                        text: 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!',
                    });
                }
            } catch (error) {
                console.error('L·ªói khi t·∫£i gi·ªè h√†ng:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!',
                });
            }
        } else {
            const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
            if (checkoutItem) {
                items = [checkoutItem];
                subtotal = checkoutItem.gia * checkoutItem.soLuong;
                source = 'Mua ngay (localStorage.checkoutItem)';
                console.log('Ngu·ªìn d·ªØ li·ªáu:', source, items);
            }
        }

        if (items.length === 0) {
            orderItemsContainer.innerHTML = `<p class="text-gray-600">Kh√¥ng c√≥ s·∫£n ph·∫©m trong ${isFromCart() ? 'gi·ªè h√†ng' : 'ƒë∆°n h√†ng'}.</p>`;
            document.getElementById('submit-order').disabled = true;
            return;
        }

        orderItemsContainer.innerHTML = items.map(item => `
            <div class="order-item flex items-center space-x-4">
                <img src="${item.urlHinhAnh}" alt="${item.tenSanPham}" class="order-item-img"/>
                <div class="flex-1">
                    <h6 class="font-semibold text-gray-800">${item.tenSanPham}</h6>
                    <p class="text-gray-600 text-sm">K√≠ch c·ª°: ${item.sizeName || 'N/A'}</p>
                    <p class="text-gray-600 text-sm">M√†u s·∫Øc: ${item.colorName || 'N/A'}</p>
                    <p class="text-gray-600 text-sm">S·ªë l∆∞·ª£ng: ${item.soLuong}</p>
                    <p class="text-gray-600 text-sm">ƒê∆°n gi√°: ${formatVND(item.gia)}</p>
                    <p class="text-orange-600 font-bold">Th√†nh ti·ªÅn: ${formatVND(item.gia * item.soLuong)}</p>
                </div>
            </div>
        `).join('');

        const shippingFee = parseFloat(document.getElementById('shipping-fee').textContent.replace(/[^\d]/g, '')) || 0;
        const discount = parseFloat(document.getElementById('discount').textContent.replace(/[^\d]/g, '')) || 0;
        document.getElementById('subtotal').textContent = formatVND(subtotal);
        document.getElementById('shipping-fee').textContent = formatVND(shippingFee);
        document.getElementById('total').textContent = formatVND(subtotal + shippingFee - discount);
    }

    // Apply voucher
    document.getElementById('apply-voucher').addEventListener('click', async () => {
        const voucherCode = document.getElementById('voucher').value.trim();
        if (!voucherCode) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: 'Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!',
            });
            return;
        }

        try {
            const response = await fetch(`/api/checkout/apply-voucher?voucher=${voucherCode}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });
            const data = await response.json();

            if (response.ok) {
                const discount = data.data;
                document.getElementById('discount').textContent = formatVND(discount);
                const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace(/[^\d]/g, '')) || 0;
                const shippingFee = parseFloat(document.getElementById('shipping-fee').textContent.replace(/[^\d]/g, '')) || 0;
                document.getElementById('total').textContent = formatVND(subtotal + shippingFee - discount);
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng',
                    text: data.message,
                    timer: 1500
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: data.message,
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'ƒê√£ x·∫£y ra l·ªói khi √°p d·ª•ng m√£ gi·∫£m gi√°!',
            });
        }
    });

    // Update total when shipping method changes
    document.getElementById('shippingMethod').addEventListener('change', () => {
        loadOrderItems();
    });
    document.getElementById('shippingMethod').addEventListener('change', calculateShipping);

    // Handle payment method selection
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            method.classList.add('active');
            method.querySelector('input').checked = true;
        });
    });

    // Handle checkout form submission with confirmation
    document.getElementById('submit-order').addEventListener('click', async (e) => {
        e.preventDefault();

        // Validate form inputs
        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        if (!fullName || !phone || !address) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng!',
            });
            return;
        }

        // Get items
        let items = [];
        let source = '';
        if (isFromCart()) {
            try {
                const response = await fetch('/api/cart', { credentials: 'include' });
                if (response.ok) {
                    const cartData = await response.json();
                    items = cartData.chiTietGioHang.map(item => ({
                        chiTietSanPhamId: item.chiTietSanPham.id,
                        soLuong: item.soLuong,
                        sizeId: item.chiTietSanPham.kichCo.id,
                        colorId: item.chiTietSanPham.mauSac.id
                    }));
                    source = 'Gi·ªè h√†ng (API /cart)';
                    console.log('G·ª≠i ƒë∆°n h√†ng v·ªõi s·∫£n ph·∫©m t·ª´:', source, items);
                } else {
                    console.log('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng t·ª´ API /cart. Tr·∫°ng th√°i:', response.status);
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói',
                        text: 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!',
                    });
                    return;
                }
            } catch (error) {
                console.error('L·ªói khi t·∫£i gi·ªè h√†ng:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!',
                });
                return;
            }
        } else {
            const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
            if (checkoutItem) {
                items = [checkoutItem];
                source = 'Mua ngay (localStorage.checkoutItem)';
                console.log('G·ª≠i ƒë∆°n h√†ng v·ªõi s·∫£n ph·∫©m t·ª´:', source, items);
            }
        }

        if (items.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: `Kh√¥ng c√≥ s·∫£n ph·∫©m trong ${isFromCart() ? 'gi·ªè h√†ng' : 'ƒë∆°n h√†ng'}! Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.`,
            });
            return;
        }

        // Map payment methods to UUIDs
        const paymentMethodMap = {
            "550E8400-E29B-41D4-A716-446655440017": "550E8400-E29B-41D4-A716-446655440017",
            "550E8400-E29B-41D4-A716-446655440018": "550E8400-E29B-41D4-A716-446655440018"
        };

        const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        const paymentMethodId = paymentMethodMap[selectedMethod];

        // Create payload
        const shippingFee = parseFloat(document.getElementById('shipping-fee').textContent.replace(/[^\d]/g, '')) || 0;

        const orderData = {
            fullName: fullName,
            phone: phone,
            address: address,
            shippingMethod: document.getElementById('shippingMethod').value,
            paymentMethodId: paymentMethodId,
            notes: document.getElementById('note').value,
            voucher: document.getElementById('voucher').value,
            shippingFee: shippingFee,
            orderItems: items.map(item => ({
                chiTietSanPhamId: item.chiTietSanPhamId,
                soLuong: item.soLuong
            }))
        };

        // Confirmation dialog with cancel button
        const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace(/[^\d]/g, '')) || 0;
        const discount = parseFloat(document.getElementById('discount').textContent.replace(/[^\d]/g, '')) || 0;
        const totalAmount = subtotal + shippingFee - discount;

        const confirmResult = await Swal.fire({
            icon: 'question',
            title: 'X√°c nh·∫≠n thanh to√°n',
            html: `
                <p><strong>T·ªïng ti·ªÅn:</strong> ${formatVND(totalAmount)}</p>
                <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${paymentMethodId === '550E8400-E29B-41D4-A716-446655440017' ? 'Thanh to√°n khi nh·∫≠n h√†ng (COD)' : 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng'}</p>
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c thanh to√°n?</p>
            `,
            showCancelButton: true,
            confirmButtonText: 'X√°c nh·∫≠n',
            cancelButtonText: 'H·ªßy',
            confirmButtonColor: '#f97316',
            cancelButtonColor: '#d33',
        });

        if (!confirmResult.isConfirmed) {
            return;
        }

        console.log("üì¶ Payload g·ª≠i ƒëi:", orderData);

        // Handle submission based on payment method
        try {
            if (paymentMethodId === '550E8400-E29B-41D4-A716-446655440018') {
                // Bank transfer - redirect to payment link
                if (totalAmount <= 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'L·ªói',
                        text: 'T·ªïng ti·ªÅn ph·∫£i l·ªõn h∆°n 0.',
                    });
                    return;
                }

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/create-payment-link';
                form.style.display = 'none';

                const productNameInput = document.createElement('input');
                productNameInput.type = 'hidden';
                productNameInput.name = 'productName';
                productNameInput.value = items.map(item => item.tenSanPham).join(', ');
                form.appendChild(productNameInput);

                const priceInput = document.createElement('input');
                priceInput.type = 'hidden';
                priceInput.name = 'price';
                priceInput.value = totalAmount.toString();
                form.appendChild(priceInput);

                const descriptionInput = document.createElement('input');
                descriptionInput.type = 'hidden';
                descriptionInput.name = 'description';
                descriptionInput.value = `Thanh to√°n ƒë∆°n h√†ng`;
                form.appendChild(descriptionInput);

                sessionStorage.setItem('pendingOrder', JSON.stringify({ orderData }));

                document.body.appendChild(form);
                form.submit();
            } else {
                // COD payment
                const response = await fetch('/api/checkout/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    if (source === 'Mua ngay (localStorage.checkoutItem)') {
                        localStorage.removeItem('checkoutItem');
                    } else {
                        localStorage.removeItem('cartItems');
                    }
                    Swal.fire({
                        icon: 'success',
                        title: 'Th√†nh c√¥ng',
                        text: `ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${data.data}`,
                        confirmButtonText: 'Quay l·∫°i trang ch·ªß',
                    }).then(() => {
                        window.location.href = '/';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói',
                        text: data.message || 'Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng! Vui l√≤ng th·ª≠ l·∫°i.',
                    });
                }
            }
        } catch (error) {
            console.error("L·ªói g·ª≠i ƒë∆°n h√†ng:", error);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'ƒê√£ x·∫£y ra l·ªói khi g·ª≠i ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!',
            });
        }
    });

    // Update cart count
    async function updateCartCount() {
        try {
            const response = await fetch('/api/cart', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                const cartCount = data.chiTietGioHang ? data.chiTietGioHang.length : 0;
                document.getElementById('cart-count').textContent = cartCount;
            } else if (response.status === 401) {
                document.getElementById('cart-count').textContent = 0;
            }
        } catch (error) {
            console.error('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng:', error);
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        loadOrderItems();
        updateCartCount();
        document.querySelector('.payment-method[data-value="550E8400-E29B-41D4-A716-446655440017"]').classList.add('active');
    });
</script>
</body>
</html>
