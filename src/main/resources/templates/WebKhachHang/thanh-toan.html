<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ACV Store - Thanh to√°n</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom, #f8fafc, #e2e8f0); }
        .navbar { background: linear-gradient(90deg, #f97316, #ef4444); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .container { max-width: 1280px; }
        .section-box { background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .section-box:hover { transform: translateY(-4px); box-shadow: 0 6px 24px rgba(0,0,0,0.1); }
        .section-title { font-size: 20px; font-weight: 700; color: #f97316; display: flex; align-items: center; }
        .order-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .form-control { border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px 14px; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .form-control:focus { border-color: #f97316; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1); outline: none; }
        .btn-primary { background: linear-gradient(90deg, #f97316, #ef4444); border: none; border-radius: 8px; padding: 12px; font-weight: 600; transition: background 0.3s ease, transform 0.2s ease; }
        .btn-primary:hover { background: linear-gradient(90deg, #ef4444, #f97316); transform: translateY(-2px); }
        .voucher-btn { background: white; border: 1px solid #f97316; color: #f97316; border-radius: 8px; padding: 10px 16px; font-weight: 600; transition: all 0.3s ease; }
        .voucher-btn:hover { background: #f97316; color: white; }
        .payment-method { padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s ease; }
        .payment-method:hover { border-color: #f97316; background: #fff7ed; }
        .payment-method.active { border-color: #f97316; background: #fff7ed; }
        .order-item { border-bottom: 1px solid #e5e7eb; padding-bottom: 16px; }
        .submit-btn { position: sticky; bottom: 20px; }
        @media (max-width: 768px) {
            .order-item-img { width: 60px; height: 60px; }
            .section-box { padding: 16px; }
            .container { padding: 0 16px; }
        }
    </style>
</head>
<body>
<!-- Header -->
<nav class="navbar fixed-top">
    <div class="container mx-auto flex items-center justify-between py-4 px-6">
        <a href="/" class="text-2xl font-bold text-white">ACV Store</a>
        <div class="flex items-center space-x-6">
            <a href="/cart" class="text-white text-xl relative">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2 py-1">0</span>
            </a>
        </div>
    </div>
</nav>

<!-- Checkout Section -->
<section class="container mx-auto py-24">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Thanh to√°n</h1>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Customer Info, Shipping, Payment, Note -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Customer Information -->
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-user mr-2"></i> Th√¥ng tin kh√°ch h√†ng</h2>
                <form id="checkout-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">H·ªç v√† t√™n</label>
                            <input type="text" id="fullName" name="fullName" class="form-control w-full" required/>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="phone" name="phone" class="form-control w-full" required/>
                        </div>
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</label>
                        <input type="text" id="address" name="address" class="form-control w-full" required/>
                    </div>
                </form>
            </div>

            <!-- Shipping Method -->
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-truck mr-2"></i> Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn</h2>
                <select id="shippingMethod" name="shippingMethod" class="form-control w-full" required>
                    <option value="STANDARD">Giao h√†ng ti√™u chu·∫©n (3-5 ng√†y) - 15,000 VNƒê</option>
                    <option value="EXPRESS">Giao h√†ng nhanh (1-2 ng√†y) - 30,000 VNƒê</option>
                </select>
            </div>

            <!-- Payment Method -->
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-credit-card mr-2"></i> Ph∆∞∆°ng th·ª©c thanh to√°n</h2>
                <div class="payment-method active" data-value="COD">
                    <input type="radio" name="paymentMethod" value="COD" checked>
                    <span class="ml-2 font-medium">Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
                </div>
                <div class="payment-method" data-value="BANK">
                    <input type="radio" name="paymentMethod" value="BANK">
                    <span class="ml-2 font-medium">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                </div>
                <div class="payment-method" data-value="ONLINE">
                    <input type="radio" name="paymentMethod" value="ONLINE">
                    <span class="ml-2 font-medium">Thanh to√°n tr·ª±c tuy·∫øn</span>
                </div>
            </div>

            <!-- Note -->
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-sticky-note mr-2"></i> Ghi ch√∫</h2>
                <textarea id="note" name="note" class="form-control w-full" rows="4" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (t√πy ch·ªçn)"></textarea>
            </div>
        </div>

        <!-- Right Column: Order Summary -->
        <div class="section-box">
            <h2 class="section-title mb-4"><i class="fas fa-shopping-bag mr-2"></i> ƒê∆°n h√†ng</h2>
            <div id="order-items" class="space-y-4 mb-6"></div>
            <div class="border-t pt-4">
                <div class="flex justify-between mb-2 text-sm">
                    <span>T·∫°m t√≠nh:</span>
                    <span id="subtotal" class="font-semibold">0 VNƒê</span>
                </div>
                <div class="flex justify-between mb-2 text-sm">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                    <span id="shipping-fee" class="font-semibold">15,000 VNƒê</span>
                </div>
                <div class="flex justify-between mb-2 text-sm">
                    <span>Gi·∫£m gi√°:</span>
                    <span id="discount" class="font-semibold">0 VNƒê</span>
                </div>
                <div class="flex justify-between text-lg font-bold">
                    <span>T·ªïng ti·ªÅn:</span>
                    <span id="total" class="text-orange-600">15,000 VNƒê</span>
                </div>
            </div>
            <div class="mt-6">
                <label for="voucher" class="block text-sm font-medium text-gray-700 mb-1">M√£ gi·∫£m gi√°</label>
                <div class="flex space-x-3">
                    <input type="text" id="voucher" class="form-control w-full" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°"/>
                    <button id="apply-voucher" class="voucher-btn">√Åp d·ª•ng</button>
                </div>
            </div>
            <button id="submit-order" class="btn btn-primary w-full mt-6 submit-btn">
                <i class="fas fa-check-circle mr-2"></i> ƒê·∫∑t h√†ng
            </button>
        </div>
    </div>
</section>

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Format number to VND
    function formatVND(number) {
        return new Intl.NumberFormat('vi-VN', { style: 'decimal', minimumFractionDigits: 0 }).format(number) + ' VNƒê';
    }

    // Load order items from localStorage or cart API
    async function loadOrderItems() {
        const orderItemsContainer = document.getElementById('order-items');
        let subtotal = 0;
        let items = [];

        // Check if there's a checkout item from "Mua ngay"
        const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
        if (checkoutItem) {
            console.log('S·∫£n ph·∫©m t·ª´ "Mua ngay" (localStorage):', checkoutItem); // Log s·∫£n ph·∫©m t·ª´ localStorage
            items.push(checkoutItem);
            subtotal += checkoutItem.gia * checkoutItem.soLuong;
        } else {
            console.log('Kh√¥ng c√≥ s·∫£n ph·∫©m t·ª´ "Mua ngay" trong localStorage');
            // Load from cart API if no checkout item
            try {
                const response = await fetch('/api/cart');
                if (response.ok) {
                    const cartData = await response.json();
                    items = cartData.chiTietGioHang || [];
                    console.log('S·∫£n ph·∫©m t·ª´ gi·ªè h√†ng (API /cart):', items); // Log s·∫£n ph·∫©m t·ª´ gi·ªè h√†ng
                    subtotal = items.reduce((sum, item) => sum + item.gia * item.soLuong, 0);
                } else {
                    console.log('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng t·ª´ API /cart. Tr·∫°ng th√°i:', response.status);
                }
            } catch (error) {
                console.error('L·ªói khi t·∫£i gi·ªè h√†ng:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!',
                });
            }
        }

        // Ki·ªÉm tra xem c√≥ s·∫£n ph·∫©m n√†o hay kh√¥ng
        if (items.length === 0) {
            console.log('Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong ƒë∆°n h√†ng.');
        } else {
            console.log(`T·ªïng c·ªông ${items.length} s·∫£n ph·∫©m trong ƒë∆°n h√†ng.`);
        }

        // Render order items
        orderItemsContainer.innerHTML = items.map(item => `
        <div class="order-item flex items-center space-x-4">
            <img src="${item.urlHinhAnh}" alt="${item.tenSanPham}" class="order-item-img"/>
            <div class="flex-1">
                <h6 class="font-semibold text-gray-800">${item.tenSanPham}</h6>
                <p class="text-gray-600 text-sm">S·ªë l∆∞·ª£ng: ${item.soLuong}</p>
                <p class="text-gray-600 text-sm">ƒê∆°n gi√°: ${formatVND(item.gia)}</p>
                <p class="text-orange-600 font-bold">Th√†nh ti·ªÅn: ${formatVND(item.gia * item.soLuong)}</p>
            </div>
        </div>
    `).join('');

        // Update subtotal, shipping fee, and total
        const shippingFee = document.getElementById('shippingMethod').value === 'EXPRESS' ? 30000 : 15000;
        document.getElementById('subtotal').textContent = formatVND(subtotal);
        document.getElementById('shipping-fee').textContent = formatVND(shippingFee);
        document.getElementById('total').textContent = formatVND(subtotal + shippingFee);
    }

    // Apply voucher
    document.getElementById('apply-voucher').addEventListener('click', async () => {
        const voucherCode = document.getElementById('voucher').value.trim();
        if (!voucherCode) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: 'Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°!',
            });
            return;
        }

        try {
            const response = await fetch(`/api/checkout/apply-voucher?voucher=${voucherCode}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (response.ok) {
                const discount = data.data;
                document.getElementById('discount').textContent = formatVND(discount);
                const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace(/[^\d]/g, '')) || 0;
                const shippingFee = parseFloat(document.getElementById('shipping-fee').textContent.replace(/[^\d]/g, '')) || 0;
                document.getElementById('total').textContent = formatVND(subtotal + shippingFee - discount);
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng',
                    text: data.message,
                    timer: 1500
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: data.message,
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'ƒê√£ x·∫£y ra l·ªói khi √°p d·ª•ng m√£ gi·∫£m gi√°!',
            });
        }
    });

    // Update total when shipping method changes
    document.getElementById('shippingMethod').addEventListener('change', () => {
        loadOrderItems();
    });

    // Handle payment method selection
    document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', () => {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            method.classList.add('active');
            method.querySelector('input').checked = true;
        });
    });

    // Load user information
    async function loadUserInfo() {
        try {
            const response = await fetch('/api/checkout/get-user');
            if (response.ok) {
                const data = await response.json();
                const user = data.data;
                document.getElementById('fullName').value = user.hoTen || '';
                document.getElementById('phone').value = user.soDienThoai || '';
                document.getElementById('address').value = user.diaChi || '';
            } else if (response.status === 401) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Ch∆∞a ƒëƒÉng nh·∫≠p',
                    text: 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c!',
                    confirmButtonText: 'ƒêƒÉng nh·∫≠p',
                }).then(() => {
                    window.location.href = '/login';
                });
            }
        } catch (error) {
            console.error('Error loading user info:', error);
        }
    }

    // Handle checkout form submission
    document.getElementById('submit-order').addEventListener('click', async (e) => {
        e.preventDefault();

        // ‚úÖ B∆∞·ªõc 1: L·∫•y s·∫£n ph·∫©m t·ª´ localStorage ho·∫∑c t·ª´ gi·ªè h√†ng
        const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
        const itemsRaw = checkoutItem ? [checkoutItem] : (await (await fetch('/api/cart')).json()).chiTietGioHang;

        // ‚úÖ B∆∞·ªõc 2: Map ƒë√∫ng format cho backend
        const orderItems = itemsRaw.map(item => ({
            chiTietSanPhamId: item.chiTietSanPhamId,
            soLuong: item.soLuong
        }));

        // ‚úÖ B∆∞·ªõc 3: Map ph∆∞∆°ng th·ª©c thanh to√°n (chu·ªói ‚Üí UUID)
        const paymentMethodMap = {
            COD: "550e8400-e29b-41d4-a716-446655440017",    // Ti·ªÅn m·∫∑t
            BANK: "550e8400-e29b-41d4-a716-446655440018",   // Chuy·ªÉn kho·∫£n
            ONLINE: "550e8400-e29b-41d4-a716-446655440019"  // N·∫øu c√≥ ONLINE, th√™m v√†o DB v√† s·ª≠a UUID
        };

        const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || 'COD';
        const paymentMethodId = paymentMethodMap[selectedMethod];

        // ‚úÖ B∆∞·ªõc 4: T·∫°o payload request
        const request = {
            fullName: document.getElementById('fullName').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            shippingMethod: document.getElementById('shippingMethod').value,
            paymentMethodId: paymentMethodId,
            notes: document.getElementById('note').value,
            voucher: document.getElementById('voucher').value,
            orderItems: orderItems
        };

        console.log("üì¶ Payload g·ª≠i ƒëi:", request); // debug

        // ‚úÖ B∆∞·ªõc 5: G·ª≠i request
        try {
            const response = await fetch('/api/checkout/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.removeItem('checkoutItem');
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng',
                    text: `ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${data.data}`,
                    confirmButtonText: 'Quay l·∫°i trang ch·ªß',
                }).then(() => {
                    window.location.href = '/';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: data.message || 'Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng',
                });
            }
        } catch (error) {
            console.error("‚ùå L·ªói g·ª≠i ƒë∆°n h√†ng:", error);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'ƒê√£ x·∫£y ra l·ªói khi g·ª≠i ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!',
            });
        }
    });

    // Update cart count
    async function updateCartCount() {
        try {
            const response = await fetch('/api/cart');
            if (response.ok) {
                const data = await response.json();
                const cartCount = data.chiTietGioHang ? data.chiTietGioHang.length : 0;
                document.getElementById('cart-count').textContent = cartCount;
            } else if (response.status === 401) {
                document.getElementById('cart-count').textContent = 0;
            }
        } catch (error) {
            console.error('Error updating cart count:', error);
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        loadOrderItems();
        loadUserInfo();
        updateCartCount();
        document.querySelector('.payment-method[data-value="COD"]').classList.add('active');
    });
</script>
</body>
</html>