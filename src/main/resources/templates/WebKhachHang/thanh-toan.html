<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ACV Store - Thanh to√°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/image/ACV.png" type="image/png" sizes="32x32"/>
    <style>
        :root {
            --primary-color: #153054;
            --secondary-color: #9FD5F7;
            --secondary-color: #9FD5F7;
            --primary-hover: #1e4066;
            --secondary-hover: #7bc3f0;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-hover) 100%);
            --gradient-surface: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: var(--gray-800);
            background: linear-gradient(135deg, var(--gray-50) 0%, #ffffff 50%, var(--gray-50) 100%);
            padding-top: 100px;
            scroll-behavior: smooth;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .search-suggestions.active {
            opacity: 1;
            visibility: visible;
        }
        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .suggestion-item:hover {
            background-color: #f1f5f9;
        }
        .suggestion-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .history-item:hover {
            background-color: #e2e8f0;
        }
        .history-item .highlight {
            background-color: #9FD5F7;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .history-item .delete-btn {
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .history-item .delete-btn:hover {
            color: #b91c1c;
        }.search-suggestions {
             position: absolute;
             top: 100%;
             left: 0;
             right: 0;
             background: white;
             border: 1px solid #ccc;
             border-radius: 8px;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
             z-index: 1000;
             max-height: 300px;
             overflow-y: auto;
             opacity: 0;
             visibility: hidden;
             transition: opacity 0.3s ease, visibility 0.3s ease;
         }
        .search-suggestions.active {
            opacity: 1;
            visibility: visible;
        }
        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .suggestion-item:hover {
            background-color: #f1f5f9;
        }
        .suggestion-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .history-item:hover {
            background-color: #e2e8f0;
        }
        .history-item .highlight {
            background-color: #9FD5F7;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .history-item .delete-btn {
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .history-item .delete-btn:hover {
            color: #b91c1c;
        }

        /* Enhanced button system with micro-interactions */
        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--border-radius);
            padding: 14px 28px;
            font-weight: 600;
            color: white;
            font-size: 15px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary-hover) 0%, #2a5a8a 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: var(--shadow);
            transition: var(--transition-fast);
        }

        .btn-primary:focus {
            outline: 3px solid rgba(21, 48, 84, 0.3);
            outline-offset: 2px;
        }

        /* Enhanced form controls with better states */
        .form-control {
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 16px 20px;
            font-size: 15px;
            transition: var(--transition);
            background: white;
            font-family: var(--font-family);
            position: relative;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(21, 48, 84, 0.1);
            outline: none;
            background: var(--gray-50);
            transform: translateY(-1px);
        }

        .form-control:hover:not(:focus):not(:disabled) {
            border-color: var(--gray-300);
            box-shadow: var(--shadow-sm);
        }

        .form-control:disabled {
            background: var(--gray-50);
            border-color: var(--gray-200);
            color: var(--gray-600);
            cursor: not-allowed;
        }

        /* Enhanced section boxes with better animations */
        .section-box {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-100);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
        }

        .section-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: var(--transition);
            transform: scaleX(0);
            transform-origin: left;
        }

        .section-box::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(21, 48, 84, 0.03) 0%, transparent 70%);
            opacity: 0;
            transition: var(--transition-slow);
            pointer-events: none;
        }

        .section-box:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: var(--shadow-2xl);
            border-color: var(--secondary-color);
        }

        .section-box:hover::before {
            opacity: 1;
            transform: scaleX(1);
        }

        .section-box:hover::after {
            opacity: 1;
        }

        /* Enhanced payment methods with better interactions */
        .payment-method {
            padding: 24px;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
        }

        .payment-method::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(21, 48, 84, 0.05), transparent);
            transition: var(--transition-slow);
        }

        .payment-method::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(21, 48, 84, 0.1) 0%, transparent 70%);
            transition: var(--transition);
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }

        .payment-method:hover {
            border-color: var(--primary-color);
            background: var(--gradient-surface);
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .payment-method:hover::before {
            left: 100%;
        }

        .payment-method:hover::after {
            width: 100px;
            height: 100px;
        }

        .payment-method.active {
            border-color: #9FD5F7;
            background: #9FD5F7;
            box-shadow: var(--shadow-md);
            transform: scale(1.02);
        }

        .payment-method.active::after {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(21, 48, 84, 0.05) 0%, transparent 70%);
        }

        /* Enhanced address cards */
        .address-card {
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 16px;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .address-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
            transform: scaleY(0);
            transition: var(--transition);
            transform-origin: bottom;
        }

        .address-card:hover {
            background: var(--gradient-surface);
            border-color: var(--primary-color);
            transform: translateY(-2px) translateX(4px);
            box-shadow: var(--shadow-lg);
        }

        .address-card:hover::before {
            transform: scaleY(1);
        }

        .address-card.active {
            border-color: var(--primary-color);
            background: var(--gradient-secondary);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .address-card.active::before {
            transform: scaleY(1);
        }

        /* Enhanced modal system */
        .modal-content {
            border-radius: var(--border-radius-xl);
            border: none;
            box-shadow: var(--shadow-2xl);
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .modal-header {
            background: var(--gradient-primary);
            color: white;
            border-bottom: none;
            padding: 28px 36px;
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        .modal-body {
            padding: 36px;
            background: var(--gradient-surface);
        }

        .modal-footer {
            background: linear-gradient(135deg, white 0%, var(--gray-50) 100%);
            border-top: 1px solid var(--gray-200);
            padding: 24px 36px;
        }

        /* Enhanced voucher modal */
        #voucherModal .modal-dialog {
            max-width: 800px;
        }

        #voucherModal .voucher-card {
            padding: 24px;
            border: 2px solid var(--gray-200) !important;
            border-radius: var(--border-radius) !important;
            transition: var(--transition);
            background: white;
            position: relative;
            overflow: hidden;
            margin-bottom: 12px;
        }

        #voucherModal .voucher-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(21, 48, 84, 0.05), transparent);
            transition: var(--transition-slow);
        }

        #voucherModal .voucher-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 100%;
            background: var(--gradient-primary);
            transition: var(--transition);
        }

        #voucherModal .voucher-card:hover {
            border-color: var(--primary-color) !important;
            background: var(--gradient-surface);
            transform: translateY(-2px) translateX(4px);
            box-shadow: var(--shadow-lg);
        }

        #voucherModal .voucher-card:hover::before {
            left: 100%;
        }

        #voucherModal .voucher-card:hover::after {
            width: 4px;
        }

        /* Enhanced animations */
        @keyframes spin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(40px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Enhanced form labels with icons */
        .form-label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            font-size: 14px;
            letter-spacing: 0.025em;
        }

        .form-label i {
            margin-right: 8px;
            color: var(--primary-color);
            font-size: 14px;
        }

        /* Enhanced order items */
        .order-item {
            border-bottom: 1px solid var(--gray-200);
            padding-bottom: 24px;
            margin-bottom: 24px;
            transition: var(--transition);
            border-radius: var(--border-radius);
        }

        .order-item:hover {
            background: var(--gradient-surface);
            padding: 20px;
            margin: -4px -20px 20px -20px;
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .order-item-img {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 2px solid var(--gray-100);
        }

        .order-item:hover .order-item-img {
            transform: scale(1.05) rotate(1deg);
            box-shadow: var(--shadow-md);
            border-color: var(--secondary-color);
        }

        /* Enhanced responsive design */
        @media (max-width: 768px) {
            body {
                padding-top: 80px;
            }

            .section-box {
                padding: 24px 20px;
                margin-bottom: 16px;
            }

            .modal-body {
                padding: 24px 20px;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-footer {
                padding: 16px 20px;
            }

            .payment-method {
                padding: 20px;
            }

            .address-card {
                padding: 20px;
            }

            .order-item-img {
                width: 70px;
                height: 70px;
            }
        }

        /* Enhanced focus states for accessibility */
        .btn:focus,
        .form-control:focus,
        .payment-method:focus,
        .address-card:focus,
        .voucher-card:focus {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Enhanced scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
            transition: var(--transition);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover);
        }

        /* Enhanced utility classes */
        .text-primary {
            color: var(--primary-color) !important;
        }

        .text-secondary {
            color: var(--gray-600) !important;
        }

        .text-muted {
            color: var(--gray-500) !important;
        }

        .fw-bold {
            font-weight: 700 !important;
        }

        .fw-semibold {
            font-weight: 600 !important;
        }

        /* Enhanced grid system */
        .grid {
            display: grid;
            gap: 24px;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        @media (min-width: 1024px) {
            .lg\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }

            .lg\:col-span-2 {
                grid-column: span 2 / span 2;
            }
        }

        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        /* Enhanced section animations */
        .section-box {
            animation: fadeInUp 0.6s ease-out;
            animation-fill-mode: both;
        }

        .section-box:nth-child(1) { animation-delay: 0.1s; }
        .section-box:nth-child(2) { animation-delay: 0.2s; }
        .section-box:nth-child(3) { animation-delay: 0.3s; }
        .section-box:nth-child(4) { animation-delay: 0.4s; }

        /* Enhanced button loading state */
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        button[disabled] {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-outline-primary {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: var(--border-radius);
            padding: 12px 24px;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
            border-radius: var(--border-radius);
            padding: 12px 24px;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
            border-color: var(--gray-400);
            transform: translateY(-1px);
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 50%, #2a5a8a 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow-lg);
            position: fixed;
            top: 40px;
            left: 0;
            width: 100%;
            z-index: 1040;
        }

        .ticker {
            background: linear-gradient(90deg, var(--secondary-color) 0%, #b8e0f8 50%, var(--secondary-color) 100%);
            color: var(--primary-color);
            font-weight: 700;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1050;
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            position: relative;
            padding-bottom: 12px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 2px;
        }

        .section-title i {
            margin-right: 12px;
            font-size: 20px;
            color: var(--secondary-color);
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .payment-method input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-color);
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .voucher-disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .voucher-disabled .form-check-input {
            pointer-events: none;
        }

        .submit-btn {
            position: sticky;
            bottom: 20px;
            z-index: 10;
        }

        .text-primary {
            color: var(--primary-color) !important;
        }

        .text-secondary {
            color: var(--gray-600) !important;
        }

        .text-muted {
            color: var(--gray-500) !important;
        }

        .fw-bold {
            font-weight: 700 !important;
        }

        .fw-semibold {
            font-weight: 600 !important;
        }

        /* Enhanced form control focus states */
        #add-address-form .form-control:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 3px rgba(21, 48, 84, 0.1) !important;
            outline: none;
        }

        /* Enhanced button hover effects */
        #add-address-form button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md) !important;
        }

        #add-address-form button[onclick="hideAddAddressForm()"]:hover {
            background: var(--gray-200) !important;
            border-color: var(--gray-300) !important;
        }

        /* Enhanced add new address button hover */
        button[onclick="showAddAddressForm()"]:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg) !important;
            background: linear-gradient(135deg, #8dd3f7 0%, #6bb8e8 100%) !important;
        }

        /* Enhanced scrollbar for address list */
        #address-list::-webkit-scrollbar {
            width: 6px;
        }

        #address-list::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 3px;
        }

        #address-list::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        #address-list::-webkit-scrollbar-thumb:hover {
            background: #1a3a5f;
        }
    </style>
</head>
<body class="bg-gray-100">

<div class="ticker py-1 overflow-hidden fixed top-0 w-full z-50">
    <marquee behavior="scroll" direction="left" scrollamount="5">
        üéâ Khuy·∫øn m√£i ƒë·∫∑c bi·ªát: Gi·∫£m gi√° l√™n ƒë·∫øn 50% cho t·∫•t c·∫£ s·∫£n ph·∫©m h√¥m nay! üéâ - Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n t·ª´ 500k!
    </marquee>
</div>

<div th:replace="~{fragments/kh_navbar :: navbar(user=${user}, keyword=${keyword}, cartCount=${cartCount})}"></div>

<section class="container mx-auto py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Thanh to√°n</h1>
    <div th:if="${error}" class="bg-red-100 text-red-700 p-4 rounded mb-4" th:text="${error}"></div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- LEFT -->
        <div class="lg:col-span-2 space-y-6">
            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-user mr-2"></i> Th√¥ng tin kh√°ch h√†ng</h2>
                <form id="checkout-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ giao h√†ng</label>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addressModal">
                            Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng
                        </button>
                        <input type="hidden" id="addressId" name="addressId"/>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="fullName" class="form-label">
                                <i class="fas fa-user"></i>
                                H·ªç v√† t√™n
                            </label>
                            <input type="text" id="fullName" name="fullName" class="form-control w-full" th:value="${nguoiNhan}" required disabled/>
                        </div>
                        <div>
                            <label for="phone" class="form-label">
                                <i class="fas fa-phone"></i>
                                S·ªë ƒëi·ªán tho·∫°i
                            </label>
                            <input type="tel" id="phone" name="phone" class="form-control w-full" th:value="${soDienThoaiNguoiNhan}" required disabled/>
                        </div>
                    </div>
                    <div>
                        <label for="address" class="form-label">
                            <i class="fas fa-map-marker-alt"></i>
                            ƒê·ªãa ch·ªâ nh·∫≠n h√†ng
                        </label>
                        <input type="text" id="address" name="address" class="form-control w-full" th:value="${loggedInUser?.chiTietDiaChi}" required disabled/>
                    </div>

                    <!-- hidden region selects for shipping calc -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 mt-4" hidden>
                        <select id="province" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>
                        </select>
                        <select id="district" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>
                        </select>
                        <select id="ward" class="form-control" required disabled>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="section-box" hidden>
                <h2 class="section-title mb-4"><i class="fas fa-truck mr-2"></i> Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn</h2>
                <select id="shippingMethod" name="shippingMethod" class="form-control w-full" required>
                    <option value="53321">Giao h√†ng nhanh (H√†ng nh·∫π)</option>
                    <option value="100039">Giao h√†ng ch·∫≠m (H√†ng n·∫∑ng)</option>
                </select>
            </div>

            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-credit-card mr-2"></i> Ph∆∞∆°ng th·ª©c thanh to√°n</h2>
                <div class="payment-method active" data-value="550E8400-E29B-41D4-A716-446655440017">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440017" checked>
                    <span class="ml-2 font-medium">Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
                </div>
                <div class="payment-method" data-value="550E8400-E29B-41D4-A716-446655440018">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440018">
                    <span class="ml-2 font-medium">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</span>
                </div>
                <div class="payment-method" data-value="550E8400-E29B-41D4-A716-446655440019">
                    <input type="radio" name="paymentMethod" value="550E8400-E29B-41D4-A716-446655440019">
                    <span class="ml-2 font-medium">V√≠ ƒëi·ªán t·ª≠</span>
                    <span id="wallet-balance" class="ml-2 text-sm text-gray-600">(ƒêang t·∫£i...)</span>
                </div>
            </div>

            <div class="section-box">
                <h2 class="section-title mb-4"><i class="fas fa-sticky-note mr-2"></i> Ghi ch√∫</h2>
                <textarea id="note" name="note" class="form-control w-full" rows="4" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (t√πy ch·ªçn)"></textarea>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="section-box">
            <h2 class="section-title mb-4"><i class="fas fa-shopping-bag mr-2"></i> ƒê∆°n h√†ng</h2>
            <div id="order-items" class="space-y-4 mb-6"></div>

            <div class="border-top pt-3">
                <div class="d-flex justify-content-between mb-2 small">
                    <span>T·∫°m t√≠nh:</span><span id="subtotal" class="fw-semibold">0 VNƒê</span>
                </div>
                <div class="d-flex justify-content-between mb-2 small">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn:</span><span id="shipping-fee" class="fw-semibold">0 VNƒê</span>
                </div>
                <div class="d-flex justify-content-between mb-1 small">
                    <span>Gi·∫£m gi√° ƒë∆°n (ORDER):</span><span id="discount-order" class="fw-semibold">0 VNƒê</span>
                </div>
                <div class="d-flex justify-content-between mb-2 small">
                    <span>Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn (FREESHIP):</span><span id="discount-ship" class="fw-semibold">0 VNƒê</span>
                </div>
                <div class="d-flex justify-content-between fs-5 fw-bold">
                    <span>T·ªïng ti·ªÅn:</span><span id="total" class="text-[#153054]">0 VNƒê</span>
                </div>
            </div>

            <!-- ========== CH·ªåN M√É GI·∫¢M GI√Å (NEW) ========== -->
            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas fa-ticket-alt fs-3 text-primary"></i>
                        <h3 class="fs-5 fw-bold mb-0">Ch·ªçn m√£ gi·∫£m gi√°</h3>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="openVoucherModal()">Ch·ªçn</button>
                </div>
                <!-- t√≥m t·∫Øt m√£ ƒëang ch·ªçn -->
                <div id="voucher-summary" class="small text-muted"></div>

                <!-- Gi·ªØ 2 select ·∫®N ƒë·ªÉ d√πng l·∫°i applyOrderVoucher/applyShipVoucher -->
                <select id="order-voucher" hidden>
                    <option value=""></option>
                    <th:block th:each="voucher : ${vouchers}">
                        <option th:if="${voucher.phamViApDung != 'SHIPPING'}"
                                th:value="${voucher.ma}"
                                th:text="${voucher.ten} + ' (T·ªëi thi·ªÉu: ' + ${#numbers.formatDecimal(voucher.giaTriGiamToiThieu, 0, 'COMMA', 0, 'POINT')} + ' VNƒê)'">
                        </option>
                    </th:block>
                </select>

                <select id="ship-voucher" hidden>
                    <option value=""></option>
                    <th:block th:each="voucher : ${vouchers}">
                        <option th:if="${voucher.phamViApDung == 'SHIPPING'}"
                                th:value="${voucher.ma}"
                                th:text="${voucher.ten}">
                        </option>
                    </th:block>
                </select>
            </div>


            <button id="submit-order" class="btn btn-primary w-100 mt-4 submit-btn" disabled>
                <i class="fas fa-check-circle me-2"></i> ƒê·∫∑t h√†ng
            </button>

        </div>
    </div>
</section>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: var(--border-radius-lg); border: none; box-shadow: var(--shadow-xl);">
            <!-- Enhanced modal header with better styling and icon -->
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, #1a3a5f 100%); color: white; border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0; padding: 24px; border-bottom: none;">
                <h5 class="modal-title d-flex align-items-center" id="addressModalLabel" style="font-weight: 600; font-size: 1.25rem;">
                    <i class="fas fa-map-marker-alt me-3" style="color: var(--secondary-color);"></i>
                    Ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1);"></button>
            </div>

            <!-- Enhanced modal body with better spacing and visual hierarchy -->
            <div class="modal-body" style="padding: 32px; background: linear-gradient(135deg, #f8fafc 0%, white 100%);">
                <!-- Enhanced address list section -->
                <div class="mb-4">
                    <h6 class="text-gray-700 mb-3 d-flex align-items-center" style="font-weight: 600; font-size: 1rem;">
                        <i class="fas fa-list me-2 text-primary"></i>
                        ƒê·ªãa ch·ªâ ƒë√£ l∆∞u
                    </h6>
                    <div id="address-list" class="mb-4" style="max-height: 300px; overflow-y: auto; padding-right: 8px;"></div>
                </div>

                <button type="button" class="btn w-100 mb-4 d-flex align-items-center justify-content-center"
                        onclick="openAddAddressModal()"
                        style="background: linear-gradient(135deg, var(--secondary-color) 0%, #7cc7f0 100%);
               border: none; color: var(--primary-color); font-weight: 600;
               padding: 16px; border-radius: var(--border-radius);">
                    <i class="fas fa-plus me-2"></i>
                    Th√™m ƒë·ªãa ch·ªâ m·ªõi
                </button>
            </div>

            <!-- Enhanced modal footer -->
            <div class="modal-footer" style="background: var(--gray-50); border-top: 1px solid var(--gray-200); padding: 20px 32px; border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);">
                <button type="button" class="btn px-4 py-2" data-bs-dismiss="modal"
                        style="background: var(--gray-100); color: var(--gray-600); border: 2px solid var(--gray-200);
                               border-radius: var(--border-radius); font-weight: 500; transition: var(--transition);">
                    <i class="fas fa-times me-1"></i>
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Address Modal (m·ªõi) -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: var(--border-radius-lg); border: none; box-shadow: var(--shadow-xl);">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, #1a3a5f 100%); color: #fff;">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Th√™m ƒë·ªãa ch·ªâ m·ªõi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body" style="padding: 24px;">
                <form id="new-address-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-user me-1 text-primary"></i>H·ªç v√† t√™n</label>
                            <input id="new-fullName" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-phone me-1 text-primary"></i>S·ªë ƒëi·ªán tho·∫°i</label>
                            <input id="new-phone" class="form-control" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-home me-1 text-primary"></i>ƒê·ªãa ch·ªâ chi ti·∫øt</label>
                        <input id="new-address" class="form-control" required placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng...">
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label"><i class="fas fa-map me-1 text-primary"></i>T·ªânh/Th√†nh ph·ªë</label>
                            <select id="new-province" class="form-control" required>
                                <option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label"><i class="fas fa-building me-1 text-primary"></i>Qu·∫≠n/Huy·ªán</label>
                            <select id="new-district" class="form-control" required>
                                <option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label"><i class="fas fa-location-dot me-1 text-primary"></i>Ph∆∞·ªùng/X√£</label>
                            <select id="new-ward" class="form-control" required>
                                <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer" style="background:#f8fafc;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-primary" onclick="saveNewAddress()">
                    <i class="fas fa-save me-1"></i>L∆∞u ƒë·ªãa ch·ªâ
                </button>
            </div>
        </div>
    </div>
</div>


<footer style="background: linear-gradient(to right, #153054, #1e4066); color: white; padding-top: 30px; padding-bottom: 20px; position: relative; z-index: 1;">
    <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
            <h3 class="text-lg font-bold mb-4">ACV Store</h3>
            <p class="text-sm">C·ª≠a h√†ng th·ªùi trang h√†ng ƒë·∫ßu v·ªõi c√°c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng v√† gi√° c·∫£ h·ª£p l√Ω.</p>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Li√™n k·∫øt nhanh</h3>
            <ul class="space-y-2">
                <li><a href="/new" class="hover:text-blue-300">S·∫£n ph·∫©m m·ªõi</a></li>
                <li><a href="/all" class="hover:text-blue-300">T·∫•t c·∫£ s·∫£n ph·∫©m</a></li>
                <li><a href="/bestsellers" class="hover:text-blue-300">S·∫£n ph·∫©m b√°n ch·∫°y</a></li>
            </ul>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Li√™n h·ªá</h3>
            <p class="text-sm">ƒê·ªãa ch·ªâ: 330 Ph·ªë Nam D∆∞, Tr·∫ßn Ph√∫, Hai B√† Tr∆∞ng, H√† N·ªôi, Vi·ªát Nam</p>
            <p class="text-sm">Email: datn.acv@gmail.com</p>
            <p class="text-sm">Hotline: 0911 006 045</p>
            <div class="flex space-x-4 mt-4">
                <a href="https://www.facebook.com" class="text-white hover:text-blue-300" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.instagram.com" class="text-white hover:text-blue-300" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="https://twitter.com" class="text-white hover:text-blue-300" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </div>
    <div class="container mx-auto mt-8">
        <div class="map-container relative overflow-hidden rounded-lg shadow-md transition-all duration-300 hover:shadow-lg">
            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3724.7142835949912!2d105.85287637508011!3d21.004087180639065!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3135ad002fc50fd1%3A0x9a7962d208d20498!2sACV%20Store!5e0!3m2!1sen!2s!4v1755701406991!5m2!1sen!2s" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <p class="text-center text-sm mt-2 text-gray-300">* B·∫£n ƒë·ªì hi·ªÉn th·ªã v·ªã tr√≠ chi nh√°nh ch√≠nh t·∫°i ACV Store t·∫°i 330 Ph·ªë Nam D∆∞, Tr·∫ßn Ph√∫, Hai B√† Tr∆∞ng, H√† N·ªôi. Vui l√≤ng li√™n h·ªá ƒë·ªÉ x√°c nh·∫≠n gi·ªù m·ªü c·ª≠a.</p>
    </div>
    <div class="text-center mt-8 text-sm">¬© 2025 ACV Store. All rights reserved.</div>

    <div class="absolute top-0 left-0 w-full h-full bg-[linear-gradient(45deg,transparent_40%,rgba(0,0,0,0.02)_50%,transparent_60%),linear-gradient(-45deg,transparent_40%,rgba(0,0,0,0.02)_50%,transparent_60%)] bg-[length:60px_60px] animate-[patternMove_20s_linear_infinite] -z-10"></div>
</footer>

<!-- ========== MODAL CH·ªåN VOUCHER (compact, centered, scrollable) ========== -->
<div class="modal fade" id="voucherModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header border-0">
                <div class="d-flex align-items-center gap-3">
                    <i class="fas fa-ticket-alt fs-3 text-primary"></i>
                    <h3 class="fs-4 fw-bold mb-0">Ch·ªçn m√£ gi·∫£m gi√°</h3>
                </div>
                <button type="button" class="btn-close" aria-label="Close" onclick="closeVoucherModal()"></button>
            </div>

            <!-- BODY cu·ªôn d·ªçc -->
            <div class="modal-body pt-0" style="max-height: 60vh; overflow-y: auto;">

                <!-- Thanh t√¨m ki·∫øm (STICKY) -->
                <div class="voucher-search">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input id="voucher-search" type="text" class="form-control"
                               placeholder="T√¨m theo t√™n m√£, code, m√¥ t·∫£...">
                        <button id="voucher-search-clear" class="btn btn-outline-secondary" type="button" title="X√≥a">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- SHIPPING -->
                <!-- SHIPPING -->
                <div class="mb-3" id="ship-list">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fas fa-truck"></i>
                        <span class="fw-bold">Freeship (SHIPPING)</span>
                    </div>

                    <th:block th:each="v : ${vouchers}">
                        <th:block th:if="${v.phamViApDung == 'SHIPPING'}">
                            <label class="voucher-card d-flex align-items-start gap-3 border rounded mb-2 w-100"
                                   style="cursor:pointer;"
                                   th:attr="data-scope=${'SHIPPING'},
                      data-code=${v.ma},
                      data-min-order=${v.giaTriGiamToiThieu},
                      data-loai=${v.loai},
                      data-giam=${v.giaTriGiam != null ? v.giaTriGiam : 0},
                      data-cap=${v.giaTriGiamToiDa != null ? v.giaTriGiamToiDa : 0}">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold" th:text="${v.ten}">T√™n phi·∫øu</div>
                                    <div class="text-muted small">
            <span th:text="${
              v.loai == 'FREESHIP_FULL' ? 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn'
              : (v.loai == 'FREESHIP_CAP'
                  ? 'Gi·∫£m ' + #numbers.formatDecimal(v.giaTriGiamToiDa, 0, 'POINT', 0, 'COMMA') + ' VND'
                  : 'Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn')
            }">M√¥ t·∫£ freeship</span>
                                        ‚Ä¢ ƒêH t·ªëi thi·ªÉu:
                                        <span th:text="${#numbers.formatDecimal(v.giaTriGiamToiThieu, 0, 'POINT', 0, 'COMMA')}">0</span> VND
                                        ‚Ä¢ HSD:
                                        <span th:text="${#temporals.format(v.ngayKetThuc,'d/M/yyyy')}"></span>
                                        ‚Ä¢ PTTT:
                                        <span th:text="${
              #maps.containsKey(voucherPtttMapById, v.id) ? voucherPtttMapById[v.id]
              : (#maps.containsKey(voucherPtttMapByMa, v.ma) ? voucherPtttMapByMa[v.ma]
              : 'T·∫•t c·∫£')
            }">T·∫•t c·∫£</span>
                                    </div>
                                </div>
                                <input class="form-check-input mt-1" type="radio" name="rb-ship" th:value="${v.ma}">
                            </label>
                        </th:block>
                    </th:block>
                </div>


                <!-- ORDER -->
                <!-- ORDER -->
                <div class="mt-4" id="order-list">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="fas fa-receipt"></i>
                        <span class="fw-bold">M√£ gi·∫£m gi√° ƒë∆°n h√†ng (ORDER)</span>
                    </div>

                    <th:block th:each="v : ${vouchers}">
                        <th:block th:if="${v.phamViApDung != 'SHIPPING'}">
                            <label class="voucher-card d-flex align-items-start gap-3 border rounded mb-2 w-100"
                                   style="cursor:pointer;"
                                   th:attr="data-scope=${'ORDER'},
                      data-code=${v.ma},
                      data-min-order=${v.giaTriGiamToiThieu},
                      data-loai=${v.loai},
                      data-giam=${v.giaTriGiam != null ? v.giaTriGiam : 0},
                      data-cap=${v.giaTriGiamToiDa != null ? v.giaTriGiamToiDa : 0}">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold" th:text="${v.ten}">T√™n phi·∫øu</div>
                                    <div class="text-muted small">
                                        Gi·∫£m
                                        <span th:text="${#numbers.formatDecimal(v.giaTriGiam, 0, 'POINT', 0, 'COMMA')}">0</span>
                                        <span th:text="${v.loai=='PERCENT' ? '%' : 'VND'}"></span>
                                        ‚Ä¢ ƒêH t·ªëi thi·ªÉu:
                                        <span th:text="${#numbers.formatDecimal(v.giaTriGiamToiThieu, 0, 'POINT', 0, 'COMMA')}">0</span> VND
                                        ‚Ä¢ HSD:
                                        <span th:text="${#temporals.format(v.ngayKetThuc,'d/M/yyyy')}"></span>
                                        ‚Ä¢ PTTT:
                                        <span th:text="${#maps.containsKey(voucherPtttMapById, v.id) ? voucherPtttMapById[v.id] :
                              (#maps.containsKey(voucherPtttMapByMa, v.ma) ? voucherPtttMapByMa[v.ma] : 'T·∫•t c·∫£')}">
              T·∫•t c·∫£
            </span>
                                    </div>
                                </div>
                                <input class="form-check-input mt-1" type="radio" name="rb-order" th:value="${v.ma}">
                            </label>
                        </th:block>
                    </th:block>
                </div>




                <!-- Kh√¥ng c√≥ k·∫øt qu·∫£ -->
                <div id="voucher-no-result" class="text-center text-muted py-3 d-none">
                    Kh√¥ng t√¨m th·∫•y m√£ ph√π h·ª£p
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" id="btn-clear-vouchers" class="btn btn-outline-secondary">B·ªè ch·ªçn t·∫•t c·∫£</button>
                <button type="button" id="btn-apply-vouchers" class="btn btn-primary">√Åp d·ª•ng</button>
            </div>
        </div>
    </div>
</div>






<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Added SockJS and STOMP for WebSocket support -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

<script th:inline="javascript">
    function normalizeVNPhone(raw='') {
        let s = String(raw).trim().replace(/\s|\.|-/g,'');
        if (s.startsWith('+84')) s = '0' + s.slice(3);
        else if (s.startsWith('84')) s = '0' + s.slice(2);
        return s;
    }

    // Tr·∫£ v·ªÅ { ok, errors[], data{fullName, phone, address} }
    function validateNewAddressForm() {
        const elName = document.getElementById('new-fullName');
        const elPhone = document.getElementById('new-phone');
        const elAddr = document.getElementById('new-address');

        // reset tr·∫°ng th√°i invalid
        [elName, elPhone, elAddr].forEach(el => el.classList.remove('is-invalid'));

        const fullName = (elName.value || '').trim().replace(/\s+/g,' ');
        const phoneRaw = (elPhone.value || '');
        const address = (elAddr.value || '').trim();

        const errors = [];

        // --- H·ªå T√äN ---
        // - T·ªëi thi·ªÉu 2 t·ª´
        // - Kh√¥ng ch·ª©a s·ªë/k√Ω t·ª± l·∫°; cho ph√©p ch·ªØ c√≥ d·∫•u, kho·∫£ng tr·∫Øng, d·∫•u n·ªëi
        const nameHasTwoWords = fullName.split(/\s+/).length >= 2;
        const nameOkChars = /^[A-Za-z√Ä-·ªπƒêƒë'‚Äô. -]+$/u.test(fullName);
        const nameLenOK = fullName.length >= 4 && fullName.length <= 60;
        if (!fullName || !nameHasTwoWords || !nameOkChars || !nameLenOK) {
            elName.classList.add('is-invalid');
            errors.push('‚Ä¢ H·ªç v√† t√™n kh√¥ng h·ª£p l·ªá (√≠t nh·∫•t 2 t·ª´, 4‚Äì60 k√Ω t·ª±, ch·ªâ bao g·ªìm ch·ªØ v√† kho·∫£ng tr·∫Øng).');
        }

        // --- S·ªê ƒêI·ªÜN THO·∫†I ---
        // - Chu·∫©n ho√° +84 -> 0
        // - 10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0
        const phone = normalizeVNPhone(phoneRaw);
        const phoneOk = /^0\d{9}$/.test(phone); // mobile VN hi·ªán l√† 10 s·ªë
        if (!phoneOk) {
            elPhone.classList.add('is-invalid');
            errors.push('‚Ä¢ S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0; ch·∫•p nh·∫≠n nh·∫≠p d·∫°ng +84...).');
        }

        // --- ƒê·ªäA CH·ªà CHI TI·∫æT ---
        // - 5‚Äì150 k√Ω t·ª±; cho ph√©p ch·ªØ s·ªë, d·∫•u / , . - #
        // - Khuy·∫øn kh√≠ch c√≥ s·ªë nh√†
        const addrOkChars = /^[0-9A-Za-z√Ä-·ªπƒêƒë\s,./#-]{5,150}$/u.test(address);
        const addrHasNumber = /\d/.test(address); // th∆∞·ªùng c√≥ s·ªë nh√†
        if (!address || !addrOkChars || !addrHasNumber) {
            elAddr.classList.add('is-invalid');
            errors.push('‚Ä¢ ƒê·ªãa ch·ªâ chi ti·∫øt ch∆∞a ƒë√∫ng (5‚Äì150 k√Ω t·ª±, n√™n c√≥ s·ªë nh√†; ch·ªâ d√πng ch·ªØ s·ªë).');
        }

        return {
            ok: errors.length === 0,
            errors,
            data: { fullName, phone, address }
        };
    }

    // üëâ Th√™m submit cho form ƒë·ªÉ Enter ho·∫°t ƒë·ªông
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('new-address-form');
        if (form) {
            // Submit m·∫∑c ƒë·ªãnh
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (typeof saveNewAddress === 'function') saveNewAddress();
            });

            // B·∫Øt Enter trong input/select c·ªßa modal (ph√≤ng khi tr√¨nh duy·ªát kh√¥ng t·ª± submit)
            document.querySelectorAll('#addAddressModal input, #addAddressModal select').forEach(el => {
                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (typeof saveNewAddress === 'function') saveNewAddress();
                    }
                });
            });
        }
    });

    window.openAddAddressModal = function () {
        // reset field
        document.getElementById('new-fullName').value = '';
        document.getElementById('new-phone').value = '';
        document.getElementById('new-address').value = '';
        document.getElementById('new-province').innerHTML = '<option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>';
        document.getElementById('new-district').innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
        document.getElementById('new-ward').innerHTML     = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';

        // n·∫°p t·ªânh/th√†nh cho modal m·ªõi
        loadProvinces('new-province');

        // m·ªü modal th√™m ƒë·ªãa ch·ªâ (kh√¥ng c·∫ßn ƒë√≥ng addressModal, Bootstrap cho ph√©p x·∫øp ch·ªìng)
        new bootstrap.Modal(document.getElementById('addAddressModal')).show();
    };

    // Ch·ªâ b·∫≠t ƒë·∫∑t h√†ng khi ƒë√£ nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t√≠nh ph√≠ ship (k·ªÉ c·∫£ 0ƒë v·∫´n OK)
    let shippingFeeReady = false;

    function updateSubmitEnabled() {
        const btn = document.getElementById('submit-order');
        if (btn) btn.disabled = !shippingFeeReady;
    }

    // ===== SEARCH HELPERS =====
    function vnNormalize(str = '') {
        return String(str)
            .toLowerCase()
            .normalize('NFD')                // t√°ch d·∫•u
            .replace(/[\u0300-\u036f]/g, '') // b·ªè d·∫•u
            .replace(/[.,]/g, '')            // lo·∫°i d·∫•u ph√¢n c√°ch s·ªë ƒë·ªÉ t√¨m 23000 ~ 23.000
            .trim();
    }

    function filterVouchersInModal(termRaw = '') {
        const modal = document.getElementById('voucherModal');
        if (!modal) return;

        const term = vnNormalize(termRaw);
        const cards = modal.querySelectorAll('label.voucher-card');
        let anyShown = false;

        cards.forEach(card => {
            const code = card.dataset.code || '';
            const text = card.innerText || '';
            const hay  = vnNormalize(code + ' ' + text);

            const matched = term === '' || hay.includes(term);
            card.classList.toggle('d-none', !matched);
            if (matched) anyShown = true;
        });

        const noRes = document.getElementById('voucher-no-result');
        if (noRes) noRes.classList.toggle('d-none', anyShown);
    }

    function debounce(fn, wait = 150) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(null, args), wait);
        };
    }

    // ================== STATE & HELPERS ==================
    const loadingState = {
        provinces: false,
        addresses: false,
        orderItems: false,
        walletBalance: false,
        shippingServices: false,
    };

    function checkLoadingComplete() {
        const overlay = document.getElementById('loading-overlay');
        if (!overlay) return; // Kh√¥ng c√≥ overlay th√¨ th√¥i, kh·ªèi thao t√°c classList
        const allLoaded = Object.values(loadingState).every(s => s === true);
        if (allLoaded) overlay.classList.remove('active');
    }

    function formatVND(number) {
        return new Intl.NumberFormat('vi-VN', { style: 'decimal', minimumFractionDigits: 0 }).format(Number(number||0)) + ' VNƒê';
    }

    function onlyDigits(s) {
        return Number(String(s || '').replace(/[^\d]/g, '')) || 0;
    }
    // ƒë·ªÉ kh√¥ng ƒë·ª•ng c√°c ch·ªó ƒëang g·ªçi _num ·ªü computePotentialDiscount
    function _num(x) { return onlyDigits(x); }

    function getCheckoutMode() {
        const qs = new URLSearchParams(location.search).get('from');
        if (['cart','cart-selected','buy-now'].includes(qs)) return qs;

        // ∆Øu ti√™n d·ªØ li·ªáu th·ª±c t·∫ø ƒëang c√≥
        if (localStorage.getItem('checkoutItem'))       return 'buy-now';
        if (localStorage.getItem('cartSelectedItems'))  return 'cart-selected';

        // Cu·ªëi c√πng m·ªõi d√πng session (c√≥ th·ªÉ l√† gi√° tr·ªã c≈©)
        const ss = sessionStorage.getItem('checkout.from');
        if (['cart','cart-selected','buy-now'].includes(ss)) return ss;

        return 'cart';
    }

    // ================== GHN LOCATION & SHIPPING ==================
    let provinceList = [];
    let districtList = [];

    async function loadProvinces(target = "province") {
        try {
            const res = await fetch('/api/ghn/provinces');
            const json = await res.json();
            if (!json || !json.data) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu t·ªânh/th√†nh');
            const result = JSON.parse(json.data);
            provinceList = result.data || [];

            const select = document.getElementById(target);
            select.innerHTML = '<option value="">-- Ch·ªçn t·ªânh/th√†nh --</option>';
            provinceList.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.ProvinceID;
                opt.textContent = p.ProvinceName;
                select.appendChild(opt);
            });

            loadingState.provinces = true;
            checkLoadingComplete();
        } catch (err) {
            console.error('L·ªói t·∫£i t·ªânh/th√†nh:', err);
            // Swal.fire({ icon: 'error', title: 'L·ªói t·∫£i t·ªânh/th√†nh', text: err.message });
            loadingState.provinces = true;
            checkLoadingComplete();
        }
    }
    function markVoucherEligibility() {
        const subtotal = onlyDigits(document.getElementById('subtotal').textContent);
        const shipping = onlyDigits(document.getElementById('shipping-fee').textContent);
        const selOrder = document.getElementById('order-voucher');
        const selShip  = document.getElementById('ship-voucher');

        // ƒê√°nh d·∫•u kh·∫£ d·ª•ng / kh√¥ng kh·∫£ d·ª•ng
        document.querySelectorAll('#voucherModal label[data-scope]').forEach(label => {
            const scope    = label.dataset.scope;              // 'ORDER' | 'SHIPPING'
            const minOrder = Number(label.dataset.minOrder||0);
            const radio    = label.querySelector('input[type="radio"]');

            const okByOrder = subtotal >= minOrder;
            const okByShip  = (scope !== 'SHIPPING') || (shipping > 0);
            const eligible  = okByOrder && okByShip;

            if (eligible) {
                label.classList.remove('voucher-disabled');
                radio.disabled = false;
                label.removeAttribute('title');
            } else {
                label.classList.add('voucher-disabled');
                radio.checked = false;
                radio.disabled = true;
                const reason = !okByOrder
                    ? `Ch∆∞a ƒë·∫°t ƒêH t·ªëi thi·ªÉu ${formatVND(minOrder)}`
                    : `Ch∆∞a c√≥ ph√≠ v·∫≠n chuy·ªÉn (h√£y ch·ªçn ƒë·ªãa ch·ªâ)`;
                label.setAttribute('title', reason);
            }
        });

        // N·∫øu hidden select ƒëang gi·ªØ 1 m√£ nh∆∞ng m√£ ƒë√≥ v·ª´a b·ªã disable -> clear
        const clearIfDisabled = (scope, code, selEl, discountId) => {
            if (!code) return;
            const selector = `#voucherModal label[data-scope="${scope}"][data-code="${CSS.escape(code)}"]`;
            const lab = document.querySelector(selector);
            if (lab && lab.classList.contains('voucher-disabled')) {
                selEl.value = '';
                document.getElementById(discountId).textContent = formatVND(0);
            }
        };
        clearIfDisabled('ORDER',    selOrder.value, selOrder, 'discount-order');
        clearIfDisabled('SHIPPING', selShip.value,  selShip,  'discount-ship');

        // C·∫≠p nh·∫≠t t√≥m t·∫Øt
        const parts = [];
        if (selOrder.value) {
            const t = selOrder.querySelector(`option[value="${selOrder.value}"]`)?.textContent || selOrder.value;
            parts.push('ORDER: ' + t);
        }
        if (selShip.value) {
            const t = selShip.querySelector(`option[value="${selShip.value}"]`)?.textContent || selShip.value;
            parts.push('SHIP: ' + t);
        }
        // document.getElementById('voucher-summary').textContent = parts.length ? parts.join(' | ') : 'Ch∆∞a ch·ªçn';
    }
    function _num(x){ const n = Number(String(x??0).toString().replace(/[^\d.]/g,'')); return isFinite(n)? n : 0; }

    function computePotentialDiscount(label, subtotal, shipping){
        const scope = label.dataset.scope;
        const loai  = (label.dataset.loai || '').toUpperCase();
        const giam  = _num(label.dataset.giam);
        const cap   = _num(label.dataset.cap);
        const minOrder = _num(label.dataset.minOrder);

        // ƒêi·ªÅu ki·ªán c∆° b·∫£n (ƒë√£ ph·∫£n √°nh c√πng logic markVoucherEligibility)
        const okByOrder = subtotal >= minOrder;
        const okByShip  = scope !== 'SHIPPING' || shipping > 0;
        const eligible  = okByOrder && okByShip;

        let potential = 0;

        if (scope === 'ORDER'){
            if (!eligible) return { eligible:false, potential:0 };
            if (loai === 'PERCENT'){
                potential = Math.floor(subtotal * giam / 100);
            } else { // AMOUNT ho·∫∑c c√°c lo·∫°i s·ªë ti·ªÅn kh√°c
                potential = giam;
            }
            if (cap > 0) potential = Math.min(potential, cap);
            potential = Math.min(potential, subtotal);
        } else { // SHIPPING
            if (!eligible) return { eligible:false, potential:0 };
            if (loai === 'FREESHIP_FULL'){
                potential = shipping;
            } else if (loai === 'FREESHIP_CAP'){
                potential = Math.min(cap || shipping, shipping);
            } else if (loai === 'PERCENT'){
                potential = Math.floor(shipping * giam / 100);
                if (cap > 0) potential = Math.min(potential, cap);
                potential = Math.min(potential, shipping);
            } else { // AMOUNT ho·∫∑c fallback
                potential = Math.min(giam, shipping);
            }
        }
        return { eligible:true, potential: Math.max(0, potential) };
    }

    function sortVouchersInModal() {
        const modal = document.getElementById('voucherModal');
        if (!modal) return;

        // L·∫§Y GI√Å TR·ªä TH·ª∞C T·ª™ DOM (100.000 VNƒê -> 100000)
        const subtotal = onlyDigits(document.getElementById('subtotal')?.textContent);
        const shipping = onlyDigits(document.getElementById('shipping-fee')?.textContent);

        const sortContainer = (containerSelector) => {
            const box = modal.querySelector(containerSelector);
            if (!box) return;

            const items = Array.from(box.querySelectorAll('label.voucher-card'));
            if (!items.length) return;

            const scored = items.map(el => {
                const isDisabled = el.classList.contains('voucher-disabled'); // ƒë√£ set ·ªü markVoucherEligibility
                const { eligible, potential } = computePotentialDiscount(el, subtotal, shipping);
                const finalEligible = !isDisabled && eligible;
                return {
                    el,
                    eligible: finalEligible,
                    potential: finalEligible ? potential : 0,
                    code: (el.dataset.code || '')
                };
            });

            scored.sort((a, b) => {
                // ƒë·ªß ƒëi·ªÅu ki·ªán tr∆∞·ªõc, kh√¥ng ƒë·ªß xu·ªëng d∆∞·ªõi
                if (a.eligible !== b.eligible) return a.eligible ? -1 : 1;
                // m·ª©c gi·∫£m ti·ªÅm nƒÉng cao l√™n tr√™n
                if (b.potential !== a.potential) return b.potential - a.potential;
                // tie-break ·ªïn ƒë·ªãnh
                return a.code.localeCompare(b.code);
            });

            scored.forEach(s => box.appendChild(s.el));
        };

        sortContainer('#ship-list');
        sortContainer('#order-list');
    }


    // G·ªçi s·∫Øp x·∫øp sau khi ƒë√°nh d·∫•u eligibility
    const _origMarkVoucherEligibility = markVoucherEligibility;
    markVoucherEligibility = function(){
        _origMarkVoucherEligibility();
        // Sau khi ƒë√°nh d·∫•u enable/disable -> sort l·∫°i
        sortVouchersInModal();
    };

    // Khi l·ªçc t√¨m ki·∫øm trong modal xong c≈©ng sort l·∫°i (ƒë·∫£m b·∫£o th·ª© t·ª± trong k·∫øt qu·∫£)
    const _origFilterInModal = filterVouchersInModal;
    filterVouchersInModal = function(term){
        _origFilterInModal(term);
        sortVouchersInModal();
    };

    // An to√†n: khi m·ªü modal l·∫ßn ƒë·∫ßu, t√≠nh & sort
    document.addEventListener('DOMContentLoaded', () => {
        const modalEl = document.getElementById('voucherModal');
        if (modalEl){
            modalEl.addEventListener('shown.bs.modal', () => {
                if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
                sortVouchersInModal();
            });
        }
    });


    async function loadDistricts(provinceId, target = "district") {
        try {
            const res = await fetch(`/api/ghn/districts?provinceId=${provinceId}`);
            const json = await res.json();
            if (!json || !json.data) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu qu·∫≠n/huy·ªán');

            const result = JSON.parse(json.data);
            districtList = result.data || [];

            const select = document.getElementById(target);
            select.innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
            districtList.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.DistrictID;
                opt.textContent = d.DistrictName;
                select.appendChild(opt);
            });

            document.getElementById(target === 'district' ? 'ward' : 'new-ward').innerHTML =
                '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
        } catch (err) {
            console.error('L·ªói t·∫£i qu·∫≠n/huy·ªán:', err);
            Swal.fire({ icon: 'error', title: 'L·ªói t·∫£i qu·∫≠n/huy·ªán', text: err.message });
        }
    }

    async function loadWards(districtId, target = "ward") {
        try {
            const res = await fetch(`/api/ghn/wards?districtId=${districtId}`);
            const json = await res.json();
            if (!json || !json.data) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu ph∆∞·ªùng/x√£');

            const result = JSON.parse(json.data);
            const wards = result.data || [];

            const select = document.getElementById(target);
            select.innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
            wards.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.WardCode;
                opt.textContent = w.WardName;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error('L·ªói t·∫£i ph∆∞·ªùng/x√£:', err);
            Swal.fire({ icon: 'error', title: 'L·ªói t·∫£i ph∆∞·ªùng/x√£', text: err.message });
        }
    }

    async function loadShippingServices(toDistrictId) {
        const fromDistrictId = 1542;
        try {
            const res = await fetch(`/api/ghn/available-services?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}`);
            const json = await res.json();
            const services = JSON.parse(json.data).data || [];

            const select = document.getElementById('shippingMethod');
            select.innerHTML = '';
            services.forEach(srv => {
                const opt = document.createElement('option');
                opt.value = srv.service_id;
                opt.textContent = srv.short_name + ` (${srv.service_type_id})`;
                select.appendChild(opt);
            });

            if (services.length) {
                select.value = services[0].service_id;
                await calculateShipping();
            }

            loadingState.shippingServices = true;
            checkLoadingComplete();
        } catch (err) {
            console.error('L·ªói t·∫£i d·ªãch v·ª• v·∫≠n chuy·ªÉn:', err);
            // Swal.fire({ icon: 'error', title: 'L·ªói', text: 'Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªãch v·ª• v·∫≠n chuy·ªÉn: ' + err.message });
            loadingState.shippingServices = true;
            checkLoadingComplete();
        }
    }

    async function calculateShipping() {
        // kh√≥a n√∫t trong l√∫c ƒëang t√≠nh l·∫°i ph√≠
        shippingFeeReady = false;
        updateSubmitEnabled();

        const toDistrictId = document.getElementById('district').value;
        const toWardCode   = document.getElementById('ward').value;
        const serviceId    = document.getElementById('shippingMethod').value;
        const fromDistrictId = 1542;

        // Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ g·ªçi API -> coi nh∆∞ ch∆∞a s·∫µn s√†ng
        if (!toDistrictId || !toWardCode || !serviceId) {
            document.getElementById('shipping-fee').textContent = formatVND(0);
            shippingFeeReady = false;
            updateSubmitEnabled();
            return;
        }

        try {
            const res = await fetch(`/api/ghn/shipping-fee?fromDistrictId=${fromDistrictId}&toDistrictId=${toDistrictId}&toWardCode=${toWardCode}&weight=500&length=20&width=15&height=10&serviceId=${serviceId}&insuranceValue=100000`);
            const json = await res.json();
            const fee  = JSON.parse(json.data).data.total || 0;

            document.getElementById('shipping-fee').textContent = formatVND(fee);

            if (document.getElementById('ship-voucher').value) {
                await applyShipVoucher(); // re-apply freeship v·ªõi ph√≠ m·ªõi
            } else {
                document.getElementById('discount-ship').textContent = formatVND(0);
            }
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();

            // >>> ƒê√É NH·∫¨N PH·∫¢N H·ªíI (k·ªÉ c·∫£ 0ƒë) -> cho ph√©p ƒë·∫∑t h√†ng
            shippingFeeReady = true;
            updateSubmitEnabled();
        } catch (err) {
            console.error('L·ªói t√≠nh ph√≠ v·∫≠n chuy·ªÉn:', err);
            Swal.fire({ icon:'error', title:'L·ªói t√≠nh ph√≠ v·∫≠n chuy·ªÉn', text: err.message });
            shippingFeeReady = false;
            updateSubmitEnabled();
        }
    }


    // ================== TOTAL & UI FNs ==================
    function updateTotal() {
        const subtotal = onlyDigits(document.getElementById('subtotal').textContent);
        const shipping = onlyDigits(document.getElementById('shipping-fee').textContent);
        const discountOrder = onlyDigits(document.getElementById('discount-order').textContent);
        const discountShip = onlyDigits(document.getElementById('discount-ship').textContent);
        const total = Math.max(0, subtotal + shipping - discountOrder - discountShip);
        document.getElementById('total').textContent = formatVND(total);
    }

    // ================== ADDRESS BOOK ==================
    async function loadSavedAddresses() {
        try {
            if (!provinceList.length) await loadProvinces();

            const res = await fetch('/api/checkout/addresses', { credentials: 'include' });
            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·ªãa ch·ªâ');

            const listEl = document.getElementById('address-list');
            listEl.innerHTML = data.data.length ? '' : '<p>Kh√¥ng c√≥ ƒë·ªãa ch·ªâ n√†o ƒë∆∞·ª£c l∆∞u.</p>';

            data.data.forEach(address => {
                const card = document.createElement('div');
                card.className = 'address-card card mb-2 p-3';
                card.setAttribute('data-id', address.id);
                card.setAttribute('data-nguoi-nhan', address.nguoiNhan || '');
                card.setAttribute('data-sdt', address.soDienThoaiNguoiNhan || '');
                card.setAttribute('data-chi-tiet', address.chiTietDiaChi || '');
                card.setAttribute('data-phuong-xa', address.phuongXa || '');
                card.setAttribute('data-quan-huyen', address.quanHuyen || '');
                card.setAttribute('data-tinh-thanh-pho', address.tinhThanhPho || '');
                card.innerHTML = `
              <div class="card-body">
                <h6 class="card-title">${address.nguoiNhan} ${address.macDinh ? '<span class="badge bg-primary ms-2">M·∫∑c ƒë·ªãnh</span>' : ''}</h6>
                <p class="card-text">${address.chiTietDiaChi}, ${address.phuongXa}, ${address.quanHuyen}, ${address.tinhThanhPho}</p>
                <p class="card-text">SƒêT: ${address.soDienThoaiNguoiNhan}</p>
                <button type="button" class="btn btn-primary btn-sm" onclick="selectAddress(this)">Ch·ªçn</button>
              </div>`;
                listEl.appendChild(card);
            });

            const defaultAddress = data.data.find(a => a.macDinh);
            if (defaultAddress) {
                const fullNameInput = document.getElementById('fullName');
                const phoneInput = document.getElementById('phone');
                const addressInput = document.getElementById('address');
                const addressIdInput = document.getElementById('addressId');
                const provinceSelect = document.getElementById('province');
                const districtSelect = document.getElementById('district');
                const wardSelect = document.getElementById('ward');

                addressIdInput.value = defaultAddress.id;
                fullNameInput.value = defaultAddress.nguoiNhan || fullNameInput.value;
                phoneInput.value = defaultAddress.soDienThoaiNguoiNhan || phoneInput.value;
                addressInput.value = `${defaultAddress.chiTietDiaChi || ''}, ${defaultAddress.phuongXa || ''}, ${defaultAddress.quanHuyen || ''}, ${defaultAddress.tinhThanhPho || ''}`
                    .replace(/, ,/g, '').replace(/^,|,$/g, '');

                const normalize = (str) => str?.toLowerCase().replace(/(t·ªânh|th√†nh ph·ªë)/gi,'').replace(/[\s.\-]/g,'')
                    .normalize('NFD').replace(/[\u0300-\u036f]/g,'');

                const provinceMatch = provinceList.find(p => normalize(p.ProvinceName).includes(normalize(defaultAddress.tinhThanhPho)));
                if (provinceMatch) {
                    provinceSelect.value = provinceMatch.ProvinceID;
                    await loadDistricts(provinceMatch.ProvinceID);

                    const districtMatch = districtList.find(d => normalize(d.DistrictName).includes(normalize(defaultAddress.quanHuyen)));
                    if (districtMatch) {
                        districtSelect.value = districtMatch.DistrictID;
                        await loadWards(districtMatch.DistrictID);

                        const wardRes = await fetch(`/api/ghn/wards?districtId=${districtMatch.DistrictID}`);
                        const wardJson = await wardRes.json();
                        const wards = JSON.parse(wardJson.data).data || [];
                        const wardMatch = wards.find(w => normalize(w.WardName).includes(normalize(defaultAddress.phuongXa)));
                        if (wardMatch) {
                            wardSelect.value = wardMatch.WardCode;
                            await loadShippingServices(districtMatch.DistrictID);
                        }
                    }
                }

                const defaultCard = listEl.querySelector(`[data-id="${defaultAddress.id}"]`);
                if (defaultCard) {
                    document.querySelectorAll('.address-card').forEach(c => c.classList.remove('active'));
                    defaultCard.classList.add('active');
                }
            } else {
                // Kh√¥ng c√≥ ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh -> tr√°nh k·∫πt overlay
                loadingState.shippingServices = true;
                checkLoadingComplete();
            }

            loadingState.addresses = true;
            checkLoadingComplete();
        } catch (err) {
            console.error('L·ªói t·∫£i danh s√°ch ƒë·ªãa ch·ªâ:', err);

            loadingState.addresses = true;
            loadingState.shippingServices = true; // tr√°nh k·∫πt overlay
            checkLoadingComplete();
        }
    }

    window.selectAddress = function (button) {
        const card = button.closest('.address-card');
        const fullNameInput = document.getElementById('fullName');
        const phoneInput    = document.getElementById('phone');
        const addressInput  = document.getElementById('address');
        const addressIdInput= document.getElementById('addressId');
        const provinceSelect= document.getElementById('province');
        const districtSelect= document.getElementById('district');
        const wardSelect    = document.getElementById('ward');

        addressIdInput.value = card.dataset.id;
        fullNameInput.value  = card.dataset.nguoiNhan || fullNameInput.value;
        phoneInput.value     = card.dataset.sdt || phoneInput.value;
        addressInput.value   = `${card.dataset.chiTiet}, ${card.dataset.phuongXa}, ${card.dataset.quanHuyen}, ${card.dataset.tinhThanhPho}`;

        const normalize = (str)=>str?.toLowerCase().replace(/(t·ªânh|th√†nh ph·ªë)/gi,'').replace(/[\s.\-]/g,'')
            .normalize('NFD').replace(/[\u0300-\u036f]/g,'');

        // >>> Kh√≥a n√∫t tr∆∞·ªõc khi t√≠nh l·∫°i ship cho ƒë·ªãa ch·ªâ m·ªõi
        shippingFeeReady = false;
        updateSubmitEnabled();

        (async function updateAddressDetails() {
            try {
                if (!provinceList.length) await loadProvinces();
                const province = provinceList.find(p => normalize(p.ProvinceName).includes(normalize(card.dataset.tinhThanhPho)));
                if (province) {
                    provinceSelect.value = province.ProvinceID;
                    await loadDistricts(province.ProvinceID);

                    const district = districtList.find(d => normalize(d.DistrictName).includes(normalize(card.dataset.quanHuyen)));
                    if (district) {
                        districtSelect.value = district.DistrictID;
                        await loadWards(district.DistrictID);

                        const wardRes = await fetch(`/api/ghn/wards?districtId=${district.DistrictID}`);
                        const wardJson= await wardRes.json();
                        const wards   = JSON.parse(wardJson.data).data || [];
                        const ward    = wards.find(w => normalize(w.WardName).includes(normalize(card.dataset.phuongXa)));
                        if (ward) {
                            wardSelect.value = ward.WardCode;
                            await loadShippingServices(district.DistrictID); // s·∫Ω t·ª± g·ªçi calculateShipping()
                        }
                    }
                }
            } catch (err) {
                console.error('L·ªói khi c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ:', err);
                // Swal.fire({ icon: 'error', title: 'L·ªói c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ', text: err.message });
            }
        })();

        document.querySelectorAll('.address-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
    };

    window.showAddAddressForm = function () {
        document.getElementById('add-address-form').classList.remove('d-none');
        document.getElementById('new-fullName').value = '';
        document.getElementById('new-phone').value = '';
        document.getElementById('new-address').value = '';
        document.getElementById('new-province').value = '';
        document.getElementById('new-district').innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
        document.getElementById('new-ward').innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
        loadProvinces('new-province');
    };

    window.hideAddAddressForm = function () {
        document.getElementById('add-address-form').classList.add('d-none');
    };

    window.saveNewAddress = async function () {
        const v = validateNewAddressForm();
        if (!v.ok) {
            Swal.fire({
                icon: 'error',
                title: 'Th√¥ng tin ch∆∞a h·ª£p l·ªá',
                html: v.errors.join('<br>'),
            });
            // focus v√†o √¥ l·ªói ƒë·∫ßu ti√™n
            const firstInvalid = document.querySelector('#addAddressModal .is-invalid');
            if (firstInvalid) firstInvalid.focus();
            return;
        }
        // D√πng d·ªØ li·ªáu ƒë√£ chu·∫©n ho√°
        const fullName = v.data.fullName;
        const phone    = v.data.phone;   // ƒë√£ chu·∫©n ho√° 0xxxxxxxxx
        const address  = v.data.address;

        // (ph·∫ßn c√≤n l·∫°i c·ªßa h√†m gi·ªØ nguy√™n nh∆∞ b·∫°n ƒëang c√≥)
        const pSel = document.getElementById('new-province');
        const dSel = document.getElementById('new-district');
        const wSel = document.getElementById('new-ward');

        const provinceId = pSel.value;
        const districtId = dSel.value;
        const wardCode   = wSel.value;

        const province = pSel.options[pSel.selectedIndex]?.text || '';
        const district = dSel.options[dSel.selectedIndex]?.text || '';
        const ward     = wSel.options[wSel.selectedIndex]?.text || '';

        if (!fullName || !phone || !address || !provinceId || !districtId || !wardCode) {
            Swal.fire({icon:'warning',title:'L·ªói',text:'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!'});
            return;
        }

        try {
            const res = await fetch('/api/checkout/addresses', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    nguoiNhan: fullName,
                    soDienThoaiNguoiNhan: phone,
                    chiTietDiaChi: address,
                    phuongXa: ward,
                    quanHuyen: district,
                    tinhThanhPho: province,
                    wardCode: wardCode,
                    districtId: Number(districtId),
                    provinceId: Number(provinceId),
                    macDinh: false
                })
            });
            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.message || 'Kh√¥ng th·ªÉ l∆∞u ƒë·ªãa ch·ªâ.');

            const newId = data.data?.id || data.data;

            // ƒê·ªï v√†o form ch√≠nh
            document.getElementById('fullName').value = fullName;
            document.getElementById('phone').value    = phone;
            document.getElementById('address').value  = `${address}, ${ward}, ${district}, ${province}`;
            document.getElementById('addressId').value= newId || '';

            // ƒê·ªìng b·ªô select ·∫©n
            document.getElementById('province').value = provinceId;
            document.getElementById('district').value = districtId;
            document.getElementById('ward').value     = wardCode;

            // >>> Kh√≥a n√∫t tr∆∞·ªõc khi t√≠nh l·∫°i ship
            shippingFeeReady = false;
            updateSubmitEnabled();

            // Refresh danh s√°ch + highlight
            await loadSavedAddresses();
            if (newId) {
                const newCard = document.querySelector(`.address-card[data-id="${CSS.escape(newId)}"]`);
                if (newCard) newCard.classList.add('active');
            }

            // T√≠nh ship theo ƒë·ªãa ch·ªâ m·ªõi
            await loadShippingServices(districtId);
            await calculateShipping();

            const addM = bootstrap.Modal.getInstance(document.getElementById('addAddressModal'));
            if (addM) addM.hide();
            Swal.fire({icon:'success',title:'ƒê√£ th√™m ƒë·ªãa ch·ªâ',timer:1200,showConfirmButton:false});
        } catch (err) {
            console.error(err);
            Swal.fire({icon:'error',title:'L·ªói',text: err.message || 'Kh√¥ng th·ªÉ th√™m ƒë·ªãa ch·ªâ.'});
        }
    };

    // ================== WALLET ==================
    async function LoadWalletBalance() {
        const el = document.getElementById('wallet-balance');
        if (!el) return;

        el.textContent = '(ƒêang t·∫£i...)';
        el.classList.add('loading');

        try {
            const res = await fetch('/api/wallet/balance', { credentials: 'include' });
            const data = await res.json();
            if (res.ok && data.success) {
                el.textContent = `(S·ªë d∆∞: ${formatVND(data.data || 0)})`;
            } else {
                el.textContent = '(Kh√¥ng c√≥ v√≠)';
            }
            loadingState.walletBalance = true;
            checkLoadingComplete();
        } catch (err) {
            console.error('L·ªói t·∫£i s·ªë d∆∞ v√≠:', err);
            el.textContent = '(L·ªói t·∫£i s·ªë d∆∞)';
            loadingState.walletBalance = true;
            checkLoadingComplete();
        } finally {
            el.classList.remove('loading');
        }
    }

    // ================== ORDER ITEMS ==================
    async function loadOrderItems() {
        const container = document.getElementById('order-items');
        if (!container) return;

        const mode = getCheckoutMode();
        let items = [];
        let subtotal = 0;

        if (mode === 'cart') {
            try {
                const response = await fetch('/api/cart', { credentials: 'include' });
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng');
                const cartData = await response.json();
                items = (cartData.chiTietGioHang || []).map(item => ({
                    chiTietSanPhamId: item.chiTietSanPham.id,
                    tenSanPham: item.chiTietSanPham.sanPham.tenSanPham,
                    soLuong: item.soLuong,
                    gia: item.gia,
                    urlHinhAnh: (item.chiTietSanPhams?.[0]?.urlHinhAnh)
                        || (item.chiTietSanPham.hinhAnhSanPhams?.[0]?.urlHinhAnh)
                        || item.chiTietSanPham.sanPham.urlHinhAnh
                        || '/images/default-product.jpg',
                    sizeName: item.chiTietSanPham.kichCo?.ten || 'N/A',
                    colorName: item.chiTietSanPham.mauSac?.tenMau || 'N/A',
                }));
            } catch (e) {
                Swal.fire({ icon:'error', title:'L·ªói', text: e.message || 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!' });
            }
        } else if (mode === 'cart-selected') {
            const ls = localStorage.getItem('cartSelectedItems');
            items = ls ? JSON.parse(ls) : [];
            if (!items.length) {
                container.innerHTML = `<p class="text-gray-600">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ thanh to√°n.</p>`;
                document.getElementById('submit-order').disabled = true;
            }
        } else {
            const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem'));
            items = checkoutItem ? [checkoutItem] : [];
            if (!items.length) {
                container.innerHTML = `<p class="text-gray-600">Kh√¥ng c√≥ s·∫£n ph·∫©m trong ƒë∆°n h√†ng.</p>`;
                document.getElementById('submit-order').disabled = true;
            }
        }

        subtotal = items.reduce((sum, it) => sum + Number(it.gia || 0) * Number(it.soLuong || 0), 0);

        if (items.length) {
            container.innerHTML = items.map(item => `
      <div class="order-item d-flex align-items-center gap-3">
        <img src="${item.urlHinhAnh}" alt="${item.tenSanPham}" class="order-item-img" onerror="this.src='/images/default-product.jpg'"/>
        <div class="flex-1">
          <h6 class="fw-semibold text-gray-800 mb-1">${item.tenSanPham}</h6>
          <p class="text-gray-600 small mb-0">K√≠ch c·ª°: ${item.sizeName}</p>
          <p class="text-gray-600 small mb-0">M√†u s·∫Øc: ${item.colorName}</p>
          <p class="text-gray-600 small mb-0">S·ªë l∆∞·ª£ng: ${item.soLuong}</p>
          <p class="text-gray-600 small mb-0">ƒê∆°n gi√°: ${formatVND(item.gia)}</p>
          <p class="text-[#153054] fw-bold mb-0">Th√†nh ti·ªÅn: ${formatVND(Number(item.gia)*Number(item.soLuong))}</p>
        </div>
      </div>
    `).join('');
        }

        const subtotalEl = document.getElementById('subtotal');
        const shippingEl = document.getElementById('shipping-fee');
        const discountOrderEl = document.getElementById('discount-order');
        const discountShipEl = document.getElementById('discount-ship');

        if (subtotalEl) subtotalEl.textContent = formatVND(subtotal);
        if (shippingEl && !shippingEl.textContent.trim()) {
            shippingEl.textContent = formatVND(0);
        }
        if (discountOrderEl) discountOrderEl.textContent = formatVND(0);
        if (discountShipEl) discountShipEl.textContent = formatVND(0);

        updateTotal();

        loadingState.orderItems = true;
        checkLoadingComplete();

        // Call markVoucherEligibility if it exists
        if (typeof markVoucherEligibility === 'function') {
            markVoucherEligibility();
        }
    }

    // Build body for voucher APIs (for buy-now & cart-selected)
    function buildVoucherBodyForCurrentMode() {
        const mode = getCheckoutMode();
        if (mode === 'cart') return []; // server d√πng to√†n b·ªô gi·ªè
        if (mode === 'cart-selected') {
            const items = JSON.parse(localStorage.getItem('cartSelectedItems') || '[]');
            return items.map(i => ({
                chiTietSanPhamId: i.chiTietSanPhamId,
                gia: Number(i.gia || 0),
                soLuong: Number(i.soLuong || 0),
            }));
        }
        const it = JSON.parse(localStorage.getItem('checkoutItem') || 'null');
        return it ? [{ chiTietSanPhamId: it.chiTietSanPhamId, gia: Number(it.gia||0), soLuong: Number(it.soLuong||0) }] : [];
    }

    // ================== VOUCHERS ==================
    // H√†m √°p d·ª•ng voucher ORDER
    async function applyOrderVoucher({ silent = false } = {}) {
        const voucherCode = document.getElementById('order-voucher').value.trim();
        const discountEl = document.getElementById('discount-order');
        const selOrder = document.getElementById('order-voucher');

        console.log("[v0] Applying ORDER voucher:", voucherCode);

        // Kh√¥ng ch·ªçn m√£ -> clear
        if (!voucherCode) {
            discountEl.textContent = formatVND(0);
            selOrder.value = ''; // ƒê·∫£m b·∫£o select ·∫©n ƒë∆∞·ª£c reset
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
            return { ok: true, discount: 0, message: 'Kh√¥ng ch·ªçn m√£ ORDER' };
        }

        const mode = getCheckoutMode();
        const source = mode;
        const subtotal = onlyDigits(document.getElementById('subtotal').textContent);
        const checkoutItems = buildVoucherBodyForCurrentMode();

        console.log("[v0] Voucher request data:", {
            voucherCode,
            mode,
            source,
            subtotal,
            checkoutItems
        });

        // L·∫§Y PTTT ƒêANG CH·ªåN
        const paymentMethodId = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        if (!paymentMethodId) {
            if (!silent) Swal.fire({ icon: 'warning', title: 'Ch∆∞a ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n' });
            discountEl.textContent = formatVND(0);
            selOrder.value = ''; // B·ªè ch·ªçn n·∫øu thi·∫øu PTTT
            updateTotal();
            return { ok: false, discount: 0, message: 'missing paymentMethodId' };
        }

        const url = `/api/checkout/apply-voucher`
            + `?voucher=${encodeURIComponent(voucherCode)}`
            + `&source=${encodeURIComponent(source)}`
            + `&type=ORDER`
            + `&subtotal=${subtotal}`
            + `&paymentMethodId=${encodeURIComponent(paymentMethodId)}`;

        console.log("[v0] API URL:", url);
        console.log("[v0] Request timestamp:", new Date().toISOString());

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(checkoutItems)
            });
            const data = await res.json();

            console.log("[v0] API Response:", {
                status: res.status,
                ok: res.ok,
                data: data
            });

            if (res.ok && (data.success || data.isSuccess)) {
                const discount = Number(data.data || 0);
                discountEl.textContent = formatVND(discount);

                console.log("[v0] Voucher applied successfully, discount:", discount);

                if (!silent) {
                    Swal.fire({
                        icon: 'success',
                        title: '√Åp d·ª•ng m√£ ORDER th√†nh c√¥ng',
                        text: `Gi·∫£m ${formatVND(discount)}`,
                        timer: 1200,
                        showConfirmButton: false
                    });
                }
                return { ok: true, discount, message: data.message || '' };
            } else {
                discountEl.textContent = formatVND(0);
                selOrder.value = ''; // B·ªè ch·ªçn n·∫øu √°p d·ª•ng th·∫•t b·∫°i

                console.log("[v0] Voucher application failed:", data.message);

                if (!silent) {
                    Swal.fire({
                        icon: 'error',
                        title: 'ORDER th·∫•t b·∫°i',
                        text: data.message || '√Åp d·ª•ng m√£ th·∫•t b·∫°i'
                    });
                }
                return { ok: false, discount: 0, message: data.message || '√Åp d·ª•ng m√£ th·∫•t b·∫°i' };
            }
        } catch (err) {
            console.error('L·ªói ORDER voucher:', err);
            console.log("[v0] Voucher application error:", err);

            discountEl.textContent = formatVND(0);
            selOrder.value = ''; // B·ªè ch·ªçn n·∫øu c√≥ l·ªói
            if (!silent) {
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: 'ƒê√£ x·∫£y ra l·ªói khi √°p d·ª•ng m√£ ORDER!'
                });
            }
            return { ok: false, discount: 0, message: 'L·ªói √°p d·ª•ng m√£ ORDER' };
        } finally {
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        }
    }

    // H√†m √°p d·ª•ng voucher SHIPPING
    async function applyShipVoucher({ silent = false } = {}) {
        const code = document.getElementById('ship-voucher').value.trim();
        const elDiscountShip = document.getElementById('discount-ship');
        const selShip = document.getElementById('ship-voucher');

        if (!code) {
            elDiscountShip.textContent = formatVND(0);
            selShip.value = ''; // ƒê·∫£m b·∫£o select ·∫©n ƒë∆∞·ª£c reset
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
            return { ok: true, discount: 0, message: 'Kh√¥ng ch·ªçn m√£ FREESHIP' };
        }

        const shippingFee = onlyDigits(document.getElementById('shipping-fee').textContent);
        const subtotal = onlyDigits(document.getElementById('subtotal').textContent);
        const mode = getCheckoutMode();
        const source = mode;

        if (shippingFee <= 0) {
            if (!silent) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Ch∆∞a c√≥ ph√≠ v·∫≠n chuy·ªÉn',
                    text: 'Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ ƒë·ªÉ t√≠nh ph√≠ ship tr∆∞·ªõc.'
                });
            }
            elDiscountShip.textContent = formatVND(0);
            selShip.value = ''; // B·ªè ch·ªçn n·∫øu ch∆∞a c√≥ ph√≠ ship
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
            return { ok: false, discount: 0, message: 'Ch∆∞a c√≥ ph√≠ v·∫≠n chuy·ªÉn' };
        }

        const paymentMethodId = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        if (!paymentMethodId) {
            if (!silent) Swal.fire({ icon: 'warning', title: 'Ch∆∞a ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n' });
            elDiscountShip.textContent = formatVND(0);
            selShip.value = ''; // B·ªè ch·ªçn n·∫øu thi·∫øu PTTT
            updateTotal();
            return { ok: false, discount: 0, message: 'missing paymentMethodId' };
        }

        const url = `/api/checkout/apply-voucher`
            + `?voucher=${encodeURIComponent(code)}`
            + `&source=${encodeURIComponent(source)}`
            + `&type=SHIPPING`
            + `&shippingFee=${shippingFee}`
            + `&subtotal=${subtotal}`
            + `&paymentMethodId=${encodeURIComponent(paymentMethodId)}`;

        const payload = buildVoucherBodyForCurrentMode() || [];

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok && (data.success || data.isSuccess)) {
                const currentShip = onlyDigits(document.getElementById('shipping-fee').textContent);
                const discount = Math.min(Number(data.data || 0), currentShip);
                elDiscountShip.textContent = formatVND(discount);
                if (!silent) {
                    Swal.fire({
                        icon: 'success',
                        title: '√Åp d·ª•ng FREESHIP th√†nh c√¥ng',
                        text: `Gi·∫£m ${formatVND(discount)} ph√≠ v·∫≠n chuy·ªÉn`,
                        timer: 1200,
                        showConfirmButton: false
                    });
                }
                return { ok: true, discount, message: data.message || '' };
            } else {
                elDiscountShip.textContent = formatVND(0);
                selShip.value = ''; // B·ªè ch·ªçn n·∫øu √°p d·ª•ng th·∫•t b·∫°i
                if (!silent) {
                    Swal.fire({
                        icon: 'error',
                        title: 'FREESHIP th·∫•t b·∫°i',
                        text: data.message || '√Åp d·ª•ng m√£ freeship th·∫•t b·∫°i'
                    });
                }
                return { ok: false, discount: 0, message: data.message || '√Åp d·ª•ng m√£ freeship th·∫•t b·∫°i' };
            }
        } catch (e) {
            console.error('L·ªói FREESHIP:', e);
            elDiscountShip.textContent = formatVND(0);
            selShip.value = ''; // B·ªè ch·ªçn n·∫øu c√≥ l·ªói
            if (!silent) {
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói',
                    text: 'ƒê√£ x·∫£y ra l·ªói khi √°p d·ª•ng m√£ freeship!'
                });
            }
            return { ok: false, discount: 0, message: 'L·ªói √°p d·ª•ng m√£ FREESHIP' };
        } finally {
            updateTotal();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        }
    }




    // ================== SUBMIT ORDER ==================
    async function submitOrder(e) {
        e.preventDefault();

        // >>> Ch·∫∑n n·∫øu ph√≠ ship ch∆∞a s·∫µn s√†ng (ph√≤ng ng∆∞·ªùi d√πng g·ª° disabled b·∫±ng DevTools)
        if (!shippingFeeReady) {
            Swal.fire({ icon:'warning', title:'Ch∆∞a c√≥ ph√≠ v·∫≠n chuy·ªÉn', text:'Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ/ƒë·ª£i t√≠nh ph√≠ ship xong.' });
            return;
        }

        const btn = document.getElementById('submit-order');
        btn.classList.add('loading');
        btn.disabled = true;

        const fullName = document.getElementById('fullName').value.trim();
        const phone    = document.getElementById('phone').value.trim();
        const address  = document.getElementById('address').value.trim();
        const addressId= document.getElementById('addressId').value.trim();

        const province = document.getElementById('province').options[document.getElementById('province').selectedIndex]?.text || '';
        const district = document.getElementById('district').options[document.getElementById('district').selectedIndex]?.text || '';
        const ward     = document.getElementById('ward').options[document.getElementById('ward').selectedIndex]?.text || '';

        if (!fullName || !phone || !address) {
            Swal.fire({ icon:'warning', title:'L·ªói', text:'Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!' });
            btn.classList.remove('loading'); btn.disabled = false; return;
        }

        const mode = getCheckoutMode();
        let items = [];
        let source = '';

        try {
            if (mode === 'cart') {
                const response = await fetch('/api/cart', { credentials: 'include' });
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng');
                const cartData = await response.json();
                items = (cartData.chiTietGioHang || []).map(i => ({
                    chiTietSanPhamId: i.chiTietSanPham.id,
                    soLuong: i.soLuong,
                    tenSanPham: i.chiTietSanPham.sanPham.tenSanPham,
                    gia: i.gia
                }));
                source = 'Gi·ªè h√†ng (API /cart)';
            } else if (mode === 'cart-selected') {
                items = JSON.parse(localStorage.getItem('cartSelectedItems') || '[]')
                    .map(i => ({ chiTietSanPhamId: i.chiTietSanPhamId, soLuong: i.soLuong, tenSanPham: i.tenSanPham, gia: i.gia }));
                source = 'Gi·ªè h√†ng (ƒë√£ ch·ªçn)';
            } else {
                const checkoutItem = JSON.parse(localStorage.getItem('checkoutItem') || 'null');
                if (checkoutItem) {
                    items = [{ chiTietSanPhamId: checkoutItem.chiTietSanPhamId, soLuong: checkoutItem.soLuong, tenSanPham: checkoutItem.tenSanPham, gia: checkoutItem.gia }];
                    source = 'Mua ngay (localStorage.checkoutItem)';
                }
            }
        } catch (err) {
            Swal.fire({ icon:'error', title:'L·ªói', text: err.message || 'Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng!' });
            btn.classList.remove('loading'); btn.disabled = false; return;
        }

        if (!items.length) {
            Swal.fire({ icon:'warning', title:'L·ªói', text:`Kh√¥ng c√≥ s·∫£n ph·∫©m trong ${mode==='cart'?'gi·ªè h√†ng':(mode==='cart-selected'?'danh s√°ch ƒë√£ ch·ªçn':'ƒë∆°n h√†ng')}!` });
            btn.classList.remove('loading'); btn.disabled = false; return;
        }

        const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
        const shippingFee    = onlyDigits(document.getElementById('shipping-fee').textContent);
        const subtotal       = onlyDigits(document.getElementById('subtotal').textContent);
        const discountOrder  = onlyDigits(document.getElementById('discount-order').textContent);
        const discountShip   = onlyDigits(document.getElementById('discount-ship').textContent);
        const totalAmount    = subtotal + shippingFee - discountOrder - discountShip;

        const orderVoucher = document.getElementById('order-voucher').value.trim();
        const shipVoucher  = document.getElementById('ship-voucher').value.trim();

        const orderData = {
            addressId: addressId,
            fullName: fullName,
            phone: phone,
            address: addressId ? '' : `${address}, ${ward}, ${district}, ${province}`,
            shippingMethod: document.getElementById('shippingMethod').value,
            paymentMethodId: selectedMethod,
            notes: document.getElementById('note').value,
            voucherOrder: orderVoucher || '',
            voucherShipping: shipVoucher || '',
            shippingFee: shippingFee,
            orderItems: items.map(i => ({ chiTietSanPhamId: i.chiTietSanPhamId, soLuong: i.soLuong })),
            source: source
        };

        // V√≠ ƒëi·ªán t·ª≠ ‚Äì ki·ªÉm tra s·ªë d∆∞
        if (selectedMethod === '550E8400-E29B-41D4-A716-446655440019') {
            try {
                const res = await fetch('/api/wallet/balance', { credentials: 'include' });
                const data = await res.json();
                if (!res.ok || !data.success || (data.data || 0) < totalAmount) {
                    Swal.fire({
                        icon:'warning',
                        title:'S·ªë d∆∞ kh√¥ng ƒë·ªß',
                        html:`<p>B·∫°n c·∫ßn <strong>${formatVND(totalAmount)}</strong> nh∆∞ng s·ªë d∆∞ hi·ªán t·∫°i l√† <strong>${formatVND(data.data || 0)}</strong>.</p><p>Vui l√≤ng n·∫°p th√™m ti·ªÅn v√†o v√≠ ƒë·ªÉ ti·∫øp t·ª•c.</p>`,
                        showCancelButton:true,
                        confirmButtonText:'N·∫°p ti·ªÅn ngay',
                        cancelButtonText:'Quay l·∫°i',
                        confirmButtonColor:'#153054',
                        cancelButtonColor:'#d33',
                        customClass:{ cancelButton:'swal-cancel-button' }
                    }).then(r => { if (r.isConfirmed) location.href = '/vi?redirect=/thanh-toan'; });
                    btn.classList.remove('loading'); btn.disabled = false; return;
                }
            } catch (err) {
                console.error('L·ªói ki·ªÉm tra s·ªë d∆∞ v√≠:', err);
                Swal.fire({ icon:'error', title:'L·ªói', text:'Kh√¥ng th·ªÉ ki·ªÉm tra s·ªë d∆∞ v√≠. Vui l√≤ng th·ª≠ l·∫°i!' });
                btn.classList.remove('loading'); btn.disabled = false; return;
            }
        }

        const confirmResult = await Swal.fire({
            icon:'question',
            title:'X√°c nh·∫≠n thanh to√°n',
            html: `
            <p><strong>T·ªïng ti·ªÅn:</strong> ${formatVND(totalAmount)}</p>
            <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${
                selectedMethod === '550E8400-E29B-41D4-A716-446655440017' ? 'Thanh to√°n khi nh·∫≠n h√†ng (COD)'
                    : selectedMethod === '550E8400-E29B-41D4-A716-446655440018' ? 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng'
                        : 'V√≠ ƒëi·ªán t·ª≠'
            }</p>
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c thanh to√°n?</p>
        `,
            showCancelButton:true,
            confirmButtonText:'X√°c nh·∫≠n',
            cancelButtonText:'H·ªßy',
            confirmButtonColor:'#153054',
            cancelButtonColor:'#d33'
        });

        if (!confirmResult.isConfirmed) { btn.classList.remove('loading'); btn.disabled = false; return; }

        try {
            if (selectedMethod === '550E8400-E29B-41D4-A716-446655440018') {
                if (totalAmount <= 0) {
                    Swal.fire({ icon:'warning', title:'L·ªói', text:'T·ªïng ti·ªÅn ph·∫£i l·ªõn h∆°n 0.' });
                    btn.classList.remove('loading'); btn.disabled = false; return;
                }
                const form = document.createElement('form');
                form.method = 'POST'; form.action = '/kh-payment/kh-create-payment-link'; form.style.display = 'none';

                const productNameInput = document.createElement('input');
                productNameInput.type = 'hidden'; productNameInput.name = 'productName';
                productNameInput.value = items.map(i => i.tenSanPham).join(', '); form.appendChild(productNameInput);

                const priceInput = document.createElement('input');
                priceInput.type = 'hidden'; priceInput.name = 'price';
                priceInput.value = totalAmount.toString(); form.appendChild(priceInput);

                const descriptionInput = document.createElement('input');
                descriptionInput.type = 'hidden'; descriptionInput.name = 'description';
                descriptionInput.value = 'Thanh to√°n ƒë∆°n h√†ng'; form.appendChild(descriptionInput);

                sessionStorage.setItem('pendingOrder', JSON.stringify({ orderData }));
                const mode = getCheckoutMode();
                sessionStorage.setItem('checkout.from', mode);

                const fromInput = document.createElement('input');
                fromInput.type = 'hidden';
                fromInput.name = 'from';
                fromInput.value = mode;
                form.appendChild(fromInput);

                document.body.appendChild(form); form.submit();
            } else {
                const response = await fetch('/api/checkout/submit', {
                    method:'POST',
                    headers:{ 'Content-Type':'application/json' },
                    body: JSON.stringify(orderData),
                    credentials:'include'
                });
                const data = await response.json();
                if (response.ok) {
                    const mode = getCheckoutMode();
                    if (mode === 'buy-now') localStorage.removeItem('checkoutItem');
                    if (mode === 'cart-selected') localStorage.removeItem('cartSelectedItems');
                    Swal.fire({
                        icon:'success', title:'Th√†nh c√¥ng',
                        text:`ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${data.data}`,
                        showCancelButton:true, confirmButtonText:'Trang ch·ªß', cancelButtonText:'ƒê∆°n mua',
                        confirmButtonColor:'#153054', cancelButtonColor:'#9fd5f7',
                        customClass:{ cancelButton:'swal-cancel-button' }
                    }).then(r => {
                        if (r.isConfirmed) location.href = '/';
                        else if (r.isDismissed) location.href = '/dsdon-mua';
                    });
                } else {
                    Swal.fire({ icon:'error', title:'L·ªói', text: data.message || 'Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng! Vui l√≤ng th·ª≠ l·∫°i.' });
                }
            }
        } catch (err) {
            console.error('L·ªói g·ª≠i ƒë∆°n h√†ng:', err);
            Swal.fire({ icon:'error', title:'L·ªói', text:'ƒê√£ x·∫£y ra l·ªói khi g·ª≠i ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i!' });
        } finally {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }

    // ================== CART COUNT ==================
    async function updateCartCount() {
        try {
            const res = await fetch('/api/cart', { credentials: 'include' });
            if (res.ok) {
                const data = await res.json();
                const count = data.chiTietGioHang ? data.chiTietGioHang.length : 0;
                document.getElementById('cart-count').textContent = count;
            } else if (res.status === 401) {
                document.getElementById('cart-count').textContent = 0;
            }
        } catch (err) {
            console.error('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng gi·ªè h√†ng:', err);
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const mode = getCheckoutMode();
        sessionStorage.setItem('checkout.from', mode);
        if (mode === 'buy-now')       localStorage.removeItem('cartSelectedItems');
        if (mode === 'cart-selected') localStorage.removeItem('checkoutItem');

        // ===== INIT =====
        shippingFeeReady = false;
        updateSubmitEnabled();
        loadProvinces();
        loadOrderItems();
        updateCartCount();
        loadSavedAddresses();
        LoadWalletBalance();

        document
            .querySelector('.payment-method[data-value="550E8400-E29B-41D4-A716-446655440017"]')
            ?.classList.add('active');

        // ===== ADDRESS / SHIPPING EVENTS =====
        document.getElementById('province')?.addEventListener('change', (e) => {
            const provinceId = parseInt(e.target.value);
            if (provinceId) loadDistricts(provinceId);
        });

        document.getElementById('district')?.addEventListener('change', async (e) => {
            const districtId = parseInt(e.target.value);
            shippingFeeReady = false; updateSubmitEnabled();
            if (districtId) await loadWards(districtId);
            await loadShippingServices(districtId); // s·∫Ω t·ª± g·ªçi calculateShipping()
        });

        document.getElementById('ward')?.addEventListener('change', () => {
            shippingFeeReady = false; updateSubmitEnabled();
            calculateShipping();
        });

        document.getElementById('new-province')?.addEventListener('change', (e) => {
            const provinceId = parseInt(e.target.value);
            if (provinceId) loadDistricts(provinceId, 'new-district');
        });

        document.getElementById('new-district')?.addEventListener('change', async (e) => {
            const districtId = parseInt(e.target.value);
            if (districtId) await loadWards(districtId, 'new-ward');
        });

        // ===== PAYMENT CARD SELECT =====
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', async () => {
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
                method.classList.add('active');
                method.querySelector('input').checked = true;

                // ‚¨ÖÔ∏è PTTT ƒë·ªïi -> re-apply voucher ƒë·ªÉ BE check PTTT
                await applyOrderVoucher({ silent: true });
                await applyShipVoucher({ silent: true });
                if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
            });
        });


        // ===== VOUCHER HIDDEN SELECTS =====
        document.getElementById('order-voucher')?.addEventListener('change', async () => {
            await applyOrderVoucher();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        });

        document.getElementById('ship-voucher')?.addEventListener('change', async () => {
            await applyShipVoucher();
            if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        });

        document.getElementById('shippingMethod')?.addEventListener('change', () => {
            shippingFeeReady = false; updateSubmitEnabled();
            calculateShipping();
        });

        document.getElementById('submit-order')?.addEventListener('click', submitOrder);

        // ===== VOUCHER MODAL HANDLERS =====
        const modalEl   = document.getElementById('voucherModal');
        const btnClear  = document.getElementById('btn-clear-vouchers');
        const btnApply  = document.getElementById('btn-apply-vouchers');
        const searchInput = document.getElementById('voucher-search');
        const searchClear = document.getElementById('voucher-search-clear');

        if (modalEl) {
            // Khi m·ªü modal -> ƒë√°nh gi√° ƒëi·ªÅu ki·ªán & focus √¥ t√¨m ki·∫øm
            modalEl.addEventListener('shown.bs.modal', () => {
                if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
                if (searchInput) {
                    searchInput.focus({ preventScroll: true });
                    if (typeof filterVouchersInModal === 'function') {
                        filterVouchersInModal(searchInput.value || '');
                    }
                }
            });

            // Cho ph√©p click l·∫ßn 2 ƒë·ªÉ b·ªè ch·ªçn radio (b·ªè qua radio b·ªã disabled)
            let lastShip = null, lastOrder = null;
            modalEl.addEventListener('click', (e) => {
                if (e.target.matches('input[name="rb-ship"]') && !e.target.disabled) {
                    if (lastShip === e.target) { e.target.checked = false; lastShip = null; }
                    else { lastShip = e.target; }
                }
                if (e.target.matches('input[name="rb-order"]') && !e.target.disabled) {
                    if (lastOrder === e.target) { e.target.checked = false; lastOrder = null; }
                    else { lastOrder = e.target; }
                }
            });

            // B·ªè ch·ªçn t·∫•t c·∫£ trong modal
            btnClear?.addEventListener('click', () => {
                modalEl.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
                lastShip = null; lastOrder = null;
            });

            // √Åp d·ª•ng: ƒë·ªï v√†o 2 select ·∫©n, g·ªçi logic √°p m√£, c·∫≠p nh·∫≠t summary, ƒë√≥ng modal
            btnApply?.addEventListener('click', async () => {
                const ship  = modalEl.querySelector('input[name="rb-ship"]:checked')?.value || '';
                const order = modalEl.querySelector('input[name="rb-order"]:checked')?.value || '';

                const selShip  = document.getElementById('ship-voucher');
                const selOrder = document.getElementById('order-voucher');
                selShip.value  = ship;
                selOrder.value = order;

                // G·ªçi 2 h√†m √°p m√£ ·ªü ch·∫ø ƒë·ªô silent ƒë·ªÉ KH√îNG b·∫≠t Swal ri√™ng l·∫ª
                const orderResult = await applyOrderVoucher({ silent: true });
                const shipResult  = await applyShipVoucher({ silent: true });

                if (typeof markVoucherEligibility === 'function') markVoucherEligibility();

                // C·∫≠p nh·∫≠t t√≥m t·∫Øt
                const parts = [];
                if (order) {
                    const t = selOrder.querySelector(`option[value="${CSS.escape(order)}"]`)?.textContent || order;
                    parts.push('ORDER: ' + t);
                }
                if (ship) {
                    const t = selShip.querySelector(`option[value="${CSS.escape(ship)}"]`)?.textContent || ship;
                    parts.push('SHIP: ' + t);
                }
                // document.getElementById('voucher-summary').textContent =
                //     parts.length ? parts.join(' | ') : 'Ch∆∞a ch·ªçn';

                // T·∫°o th√¥ng b√°o t·ªïng h·ª£p
                const lines = [];
                if (order) {
                    lines.push(orderResult.ok
                        ? `ORDER: gi·∫£m <b>${formatVND(orderResult.discount)}</b>`
                        : `ORDER: <span style="color:#c00">${orderResult.message || 'Kh√¥ng √°p d·ª•ng ƒë∆∞·ª£c'}</span>`);
                }
                if (ship) {
                    lines.push(shipResult.ok
                        ? `FREESHIP: gi·∫£m <b>${formatVND(shipResult.discount)}</b>`
                        : `FREESHIP: <span style="color:#c00">${shipResult.message || 'Kh√¥ng √°p d·ª•ng ƒë∆∞·ª£c'}</span>`);
                }

                // Ch·ªçn icon ph√π h·ª£p
                const overallOk =
                    (order ? orderResult.ok : true) &&
                    (ship ? shipResult.ok : true);

                Swal.fire({
                    icon: overallOk ? 'success' : (orderResult.ok || shipResult.ok ? 'info' : 'error'),
                    title: 'K·∫øt qu·∫£ √°p m√£',
                    html: lines.join('<br>'),
                    timer: 1600,
                    showConfirmButton: false
                });

                // ƒê√≥ng modal
                (bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl)).hide();
            });


            // ====== T√åM KI·∫æM TRONG MODAL =====
            if (searchInput) {
                const doFilter = debounce(() => {
                    if (typeof filterVouchersInModal === 'function') {
                        filterVouchersInModal(searchInput.value);
                    }
                }, 150);
                searchInput.addEventListener('input', doFilter);

                // (Tu·ª≥ ch·ªçn) reset khi ƒë√≥ng modal
                // modalEl.addEventListener('hidden.bs.modal', () => {
                //   searchInput.value = '';
                //   if (typeof filterVouchersInModal === 'function') filterVouchersInModal('');
                // });
            }

            if (searchClear) {
                searchClear.addEventListener('click', () => {
                    if (!searchInput) return;
                    searchInput.value = '';
                    if (typeof filterVouchersInModal === 'function') filterVouchersInModal('');
                    searchInput.focus({ preventScroll: true });
                });
            }
        }
    });

    // === M·ªû/ƒê√ìNG MODAL (g·ªçi ·ªü n√∫t "Ch·ªçn") ===
    function openVoucherModal() {
        const el = document.getElementById('voucherModal');
        if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
        new bootstrap.Modal(el).show();
    }
    function closeVoucherModal() {
        const m = bootstrap.Modal.getInstance(document.getElementById('voucherModal'));
        if (m) m.hide();
    }

    async function reloadVouchersInModal() {
        try {
            console.log('[v0] Reloading vouchers in modal...');

            // Simply reload the page's voucher modal content by fetching the current page
            // This ensures we get the latest vouchers from the server
            const currentUrl = window.location.href;
            const response = await fetch(currentUrl, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Indicate this is an AJAX request
                }
            });

            if (!response.ok) {
                console.error('[v0] Failed to reload vouchers:', response.status);
                return;
            }

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Extract voucher lists from the fresh HTML
            const newShipList = doc.getElementById('ship-list');
            const newOrderList = doc.getElementById('order-list');

            if (newShipList && newOrderList) {
                // Update the modal content with fresh vouchers
                const currentShipList = document.getElementById('ship-list');
                const currentOrderList = document.getElementById('order-list');

                if (currentShipList) currentShipList.innerHTML = newShipList.innerHTML;
                if (currentOrderList) currentOrderList.innerHTML = newOrderList.innerHTML;

                console.log('[v0] Vouchers reloaded successfully');

                // Re-apply eligibility and sorting
                if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
                if (typeof sortVouchersInModal === 'function') sortVouchersInModal();
            }

        } catch (error) {
            console.error('[v0] Error reloading vouchers:', error);
        }
    }

    function handlePaymentVoucherUpdate(update) {
        console.log('[v0] Voucher update received:', update);

        const { action, voucherId, voucherCode, status, quantity, message } = update;

        // Auto-refresh page when vouchers are created, updated, or deleted from admin
        if (action === 'CREATED' || action === 'UPDATED' || action === 'DELETED') {
            console.log('[v0] Auto-refreshing page due to voucher update from admin:', action);

            // Show notification before refresh
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'info',
                    title: 'C·∫≠p nh·∫≠t m√£ gi·∫£m gi√°!',
                    text: `Trang s·∫Ω t·ª± ƒë·ªông l√†m m·ªõi ƒë·ªÉ c·∫≠p nh·∫≠t m√£ gi·∫£m gi√° m·ªõi nh·∫•t.`,
                    timer: 2000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            }

            // Auto-refresh after 2.5 seconds to allow notification to show
            setTimeout(() => {
                console.log('[v0] Refreshing page now...');
                window.location.reload();
            }, 2500);

            return; // Exit early since we're refreshing
        }

        // Show notification for new vouchers
        if (action === 'CREATED') {
            // Show toast notification for new voucher
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'info',
                    title: 'M√£ gi·∫£m gi√° m·ªõi!',
                    text: `C√≥ m√£ gi·∫£m gi√° m·ªõi: ${voucherCode}`,
                    timer: 3000,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true
                });
            }
        }

        // Check if currently applied vouchers are affected
        const currentOrderVoucher = document.getElementById('order-voucher')?.value;
        const currentShipVoucher = document.getElementById('ship-voucher')?.value;

        if (currentOrderVoucher === voucherCode || currentShipVoucher === voucherCode) {
            console.log('[v0] Currently applied voucher affected:', voucherCode);

            // Re-validate current vouchers
            setTimeout(async () => {
                if (currentOrderVoucher === voucherCode) {
                    const result = await applyOrderVoucher({ silent: true });
                    if (!result.ok) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'M√£ gi·∫£m gi√° kh√¥ng c√≤n hi·ªáu l·ª±c',
                            text: `M√£ ORDER "${voucherCode}" ƒë√£ thay ƒë·ªïi v√† kh√¥ng th·ªÉ √°p d·ª•ng.`,
                            confirmButtonText: 'ƒê√£ hi·ªÉu'
                        });
                    }
                }

                if (currentShipVoucher === voucherCode) {
                    const result = await applyShipVoucher({ silent: true });
                    if (!result.ok) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'M√£ freeship kh√¥ng c√≤n hi·ªáu l·ª±c',
                            text: `M√£ FREESHIP "${voucherCode}" ƒë√£ thay ƒë·ªïi v√† kh√¥ng th·ªÉ √°p d·ª•ng.`,
                            confirmButtonText: 'ƒê√£ hi·ªÉu'
                        });
                    }
                }
            }, 2000); // Increased delay to 2 seconds for better backend sync
        }

        if (action === 'CREATED' || action === 'UPDATED' || action === 'DELETED') {
            console.log('[v0] Reloading voucher dropdowns due to action:', action);

            setTimeout(async () => {
                await reloadVoucherDropdowns();

                // Also reload modal if it's open
                const modal = document.getElementById('voucherModal');
                if (modal && modal.classList.contains('show')) {
                    console.log('[v0] Modal is open, reloading vouchers...');
                    await reloadVouchersInModal();
                } else {
                    console.log('[v0] Modal is closed, vouchers will be updated when opened');
                }
            }, 1500); // Increased delay to 1.5 seconds for better backend sync
        }
    }

    async function reloadVoucherDropdowns() {
        try {
            console.log('[v0] Reloading voucher dropdowns...');
            const response = await fetch(window.location.href, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                console.error('[v0] Failed to reload voucher dropdowns:', response.status);
                return;
            }

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const newOrderVoucherSelect = doc.getElementById('order-voucher');
            const newShipVoucherSelect = doc.getElementById('ship-voucher');

            if (newOrderVoucherSelect && newShipVoucherSelect) {
                const currentOrderVoucherSelect = document.getElementById('order-voucher');
                const currentShipVoucherSelect = document.getElementById('ship-voucher');

                if (currentOrderVoucherSelect) currentOrderVoucherSelect.innerHTML = newOrderVoucherSelect.innerHTML;
                if (currentShipVoucherSelect) currentShipVoucherSelect.innerHTML = newShipVoucherSelect.innerHTML;

                console.log('[v0] Voucher dropdowns reloaded successfully');
            }
        } catch (error) {
            console.error('[v0] Error reloading voucher dropdowns:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const modalEl = document.getElementById('voucherModal');
        if (modalEl) {
            modalEl.addEventListener('show.bs.modal', () => {
                console.log('[v0] Modal opening, reloading vouchers...');
                setTimeout(() => {
                    reloadVouchersInModal();
                }, 100);
            });

            modalEl.addEventListener('shown.bs.modal', () => {
                if (typeof markVoucherEligibility === 'function') markVoucherEligibility();
                if (typeof sortVouchersInModal === 'function') sortVouchersInModal();
            });
        }
    });

    function connectWebSocket() {
        try {
            console.log('[v0] Connecting to WebSocket...');
            const socket = new SockJS('/ws');
            stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                debug: (str) => console.log('[v0 WebSocket]', str),
                reconnectDelay: 5000,
                heartbeatIncoming: 4000,
                heartbeatOutgoing: 4000,
            });

            stompClient.onConnect = (frame) => {
                console.log('[v0] Connected to voucher updates successfully');

                // Subscribe to payment voucher updates
                stompClient.subscribe('/topic/payment/vouchers', (message) => {
                    try {
                        const update = JSON.parse(message.body);
                        console.log('[v0] Received voucher update:', update);
                        handlePaymentVoucherUpdate(update);
                    } catch (e) {
                        console.error('[v0] Error parsing voucher update:', e);
                    }
                });
            };

            stompClient.onStompError = (frame) => {
                console.error('[v0] STOMP error:', frame);
            };

            stompClient.onDisconnect = () => {
                console.log('[v0] WebSocket disconnected');
            };

            stompClient.activate();
        } catch (error) {
            console.error('[v0] WebSocket connection failed:', error);
        }
    }

    connectWebSocket();

    let voucherReloadInProgress = false;
    let pendingVoucherUpdates = [];

    // Enhanced voucher dropdown reload with cache busting and retry mechanism
    async function reloadVoucherDropdowns(retryCount = 0) {
        if (voucherReloadInProgress) {
            console.log('[v0] Voucher reload already in progress, skipping...');
            return false;
        }

        try {
            voucherReloadInProgress = true;
            console.log('[v0] Reloading voucher dropdowns...');

            const timestamp = Date.now();
            const response = await fetch(`${window.location.pathname}?_t=${timestamp}`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Update order voucher dropdown
            const newOrderSelect = doc.querySelector('#order-voucher');
            const currentOrderSelect = document.querySelector('#order-voucher');
            if (newOrderSelect && currentOrderSelect) {
                const selectedValue = currentOrderSelect.value;
                currentOrderSelect.innerHTML = newOrderSelect.innerHTML;
                if (currentOrderSelect.querySelector(`option[value="${selectedValue}"]`)) {
                    currentOrderSelect.value = selectedValue;
                }
            }

            // Update ship voucher dropdown
            const newShipSelect = doc.querySelector('#ship-voucher');
            const currentShipSelect = document.querySelector('#ship-voucher');
            if (newShipSelect && currentShipSelect) {
                const selectedValue = currentShipSelect.value;
                currentShipSelect.innerHTML = newShipSelect.innerHTML;
                if (currentShipSelect.querySelector(`option[value="${selectedValue}"]`)) {
                    currentShipSelect.value = selectedValue;
                }
            }

            console.log('[v0] Voucher dropdowns reloaded successfully');
            return true;

        } catch (error) {
            console.error('[v0] Error reloading voucher dropdowns:', error);

            if (retryCount < 3) {
                const delay = Math.pow(2, retryCount) * 1000;
                console.log(`[v0] Retrying in ${delay}ms... (${retryCount + 1}/3)`);
                setTimeout(() => reloadVoucherDropdowns(retryCount + 1), delay);
            }
            return false;
        } finally {
            voucherReloadInProgress = false;
        }
    }

    // Process pending voucher updates
    async function processPendingVoucherUpdates() {
        if (pendingVoucherUpdates.length === 0) return;

        console.log(`[v0] Processing ${pendingVoucherUpdates.length} pending voucher updates`);

        while (pendingVoucherUpdates.length > 0) {
            const update = pendingVoucherUpdates.shift();
            await handleVoucherUpdate(update);
            await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between updates
        }
    }

    // Handle individual voucher update
    async function handleVoucherUpdate(data) {
        console.log('[v0] Processing voucher update:', data);

        // Wait for backend to fully process the change
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Reload voucher dropdowns
        const reloadSuccess = await reloadVoucherDropdowns();

        if (reloadSuccess) {
            // If modal is open, also reload modal content
            const modal = document.querySelector('#voucherModal');
            if (modal && modal.style.display !== 'none') {
                console.log('[v0] Modal is open, reloading modal vouchers...');
                setTimeout(() => {
                    if (typeof reloadVouchersInModal === 'function') {
                        reloadVouchersInModal();
                    }
                }, 500);
            }
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (stompClient && stompClient.connected) {
            stompClient.deactivate();
        }
    });

</script>
</body>
</html>
