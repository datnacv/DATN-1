<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kết quả tìm kiếm - ACV Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-Avb2QiuDEEvB4bZJYdft2mNjVShBftLdPG8FJ0V7irTLQ8Uo0qcPxh4Plq7G5tGm0rU+1SPhVotteLpBERwTkw==" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/image/ACV.png" type="image/png" sizes="32x32"/>

    <style>
        .navbar {
            background: linear-gradient(to right, #153054, #1e4066);

        }
       
        .product-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        .badge-new {
            background-color: #153054;
        }
        .swiper-slide img {
            object-fit: cover;
            height: 600px;
            width: 100%;
            loading: lazy;
        }
        .ticker {
            background-color: #9FD5F7;
            color: #153054;
            font-weight: bold;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1050;
        }
        .navbar {
            position: fixed;
            top: 40px;
            left: 0;
            width: 100%;
            z-index: 1040;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .search-suggestions.active {
            opacity: 1;
            visibility: visible;
        }
        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .suggestion-item:hover {
            background-color: #f1f5f9;
        }
        .suggestion-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .history-item:hover {
            background-color: #e2e8f0;
        }
        .history-item .highlight {
            background-color: #9FD5F7;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .history-item .delete-btn {
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .history-item .delete-btn:hover {
            color: #b91c1c;
        }.search-suggestions {
             position: absolute;
             top: 100%;
             left: 0;
             right: 0;
             background: white;
             border: 1px solid #ccc;
             border-radius: 8px;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
             z-index: 1000;
             max-height: 300px;
             overflow-y: auto;
             opacity: 0;
             visibility: hidden;
             transition: opacity 0.3s ease, visibility 0.3s ease;
         }
        .search-suggestions.active {
            opacity: 1;
            visibility: visible;
        }
        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .suggestion-item:hover {
            background-color: #f1f5f9;
        }
        .suggestion-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .history-item:hover {
            background-color: #e2e8f0;
        }
        .history-item .highlight {
            background-color: #9FD5F7;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .history-item .delete-btn {
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .history-item .delete-btn:hover {
            color: #b91c1c;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .dropdown:hover .dropdown-menu {
            display: block;
        }
        body {
            padding-top: 140px;
        }
        .user-info {
            display: none;
            color: white;
        }
        .user-info.active {
            display: inline;
        }

        /* Product Card Styling */
        :root {
            --acv-blue: #153054;
            --card-r: 14px;
        }
        .product-card {
            position: relative;
            border: 1px solid #e5edf6;
            border-radius: var(--card-r);
            background: #fff;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(21,48,84,.06);
            transition: transform .25s, box-shadow .25s;
        }
        .product-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 16px 32px rgba(21,48,84,.15);
        }
        .product-media {
            position: relative;
            aspect-ratio: 1/1;
            background: #f6f7fb;
            overflow: hidden;
        }
        .product-media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scale(1.02);
            transition: transform .6s ease;
        }
        .product-card:hover .product-media img {
            transform: scale(1.08);
        }
        .media-gradient {
            position: absolute;
            inset: auto 0 0 0;
            height: 44%;
            background: linear-gradient(to top, rgba(0,0,0,.45), rgba(0,0,0,0));
        }
        .badge-new {
            background: #10b981;
            color: #fff;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: .7rem;
            font-weight: 700;
            box-shadow: 0 8px 16px rgba(0,0,0,.2);
        }
        .badge-hot {
            background: #ef4444;
            color: #fff;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: .7rem;
            font-weight: 700;
            box-shadow: 0 8px 16px rgba(0,0,0,.2);
        }
        .action-group {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 3;
            opacity: 0;
            transform: translateX(6px);
            transition: all .25s ease;
        }
        .product-card:hover .action-group {
            opacity: 1;
            transform: none;
        }
        .action-btn {
            background: #fff;
            border: 0;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(21,48,84,.25);
        }
        .action-btn:hover {
            background: #e8f1fb;
        }
        .product-body {
            padding: 12px 14px;
        }
        .product-title {
            font-weight: 600;
            color: #1f2937;
            line-height: 1.35;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 42px;
        }
        .size-option{
            padding: 8px 16px; border: 2px solid #ccc; border-radius: 8px;
            cursor: pointer; transition: all 0.3s;
        }
        .size-option.active{
            background:#153054; color:#fff; border-color:#153054;
        }

        /* Swatch tròn khi có mã màu (data-swatch="true") */
        .color-option[data-swatch="true"]{
            width:30px; height:30px; border-radius:50%;
            border:2px solid #ccc;       /* <- đồng bộ viền với size */
            padding:0; cursor:pointer; transition:.3s;
        }
        .color-option[data-swatch="true"].active{
            border-color:#153054;
        }

        /* Màu dạng chữ (không có mã màu) – giống hệt size */
        .color-option:not([data-swatch="true"]){
            padding: 8px 16px; border: 2px solid #ccc; border-radius: 8px;
            cursor: pointer; transition: all 0.3s;
        }
        .color-option:not([data-swatch="true"]).active{
            background:#153054; color:#fff; border-color:#153054;
        }
    </style>
</head>
<body class="bg-gray-100">
<!-- Ticker -->
<div class="ticker py-1 overflow-hidden" style="height: 40px;">
    <marquee behavior="scroll" direction="left" scrollamount="5">
        🎉 50% cho tất cả sản phẩm hôm nay! 🎉 - Miễn phí vận chuyển cho đơn từ 500k!
    </marquee>
</div>

<!-- Navbar -->
<div th:replace="~{fragments/kh_navbar :: navbar(user=${user}, keyword=${keyword}, cartCount=${cartCount})}"></div>

<!-- Main content -->
<div class="container mx-auto py-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">
        Kết quả tìm kiếm cho: <span th:text="${keyword}">Từ khóa</span>
    </h2>
    <div th:if="${products.isEmpty()}">
        <p class="text-gray-600">Không tìm thấy sản phẩm nào.</p>
        <p class="text-gray-600">Gợi ý: Kiểm tra lại từ khóa hoặc xem các sản phẩm nổi bật bên dưới.</p>
    </div>
    <div class="product-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" th:unless="${products.isEmpty()}">
        <div class="product-card bg-white rounded-lg shadow-md overflow-hidden" th:each="product : ${products}">
            <div class="relative">
                <a th:href="@{/chitietsanpham(id=${product.id})}">
                    <img th:src="${product.urlHinhAnh}" th:alt="'Hình ảnh sản phẩm ' + ${product.tenSanPham}" class="w-full h-48 object-cover" loading="lazy"/>
                </a>
                <div class="action-group">
                    <button class="action-btn cart-icon"
                            th:attr="
                  data-product-id=${product.id},
                  data-product-name=${product.tenSanPham},
                  data-product-price=${product.price},
                  data-product-img=${product.urlHinhAnh},
                  data-kich-co=${@jacksonObjectMapper.writeValueAsString(product.kichCoList)},
                  data-mau-sac=${@jacksonObjectMapper.writeValueAsString(product.mauSacList)},
                  data-stock=${product.tongSoLuong}">
                        <i class="fas fa-shopping-cart text-blue-800"></i>
                    </button>
                    <button class="action-btn quick-view-btn"
                            th:attr="data-product-id=${product.id}" aria-label="Xem nhanh sản phẩm">
                        <i class="fas fa-eye text-blue-800"></i>
                    </button>
                </div>
                <div class="media-gradient"></div>
            </div>
            <a th:href="@{/chitietsanpham(id=${product.id})}" class="block p-4">
                <h4 th:text="${product.tenSanPham}" class="text-sm font-semibold text-gray-800 truncate"></h4>
                <div class="price text-blue-800 font-bold mt-2" th:text="${product.price} + ' VNĐ'"></div>
                <div th:if="${product.tongSoLuong != null}" class="text-sm text-gray-600">Tồn kho: <span th:text="${product.tongSoLuong}"></span></div>
                <div class="rating text-yellow-400 text-sm mt-1">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star-half-alt"></i><i class="far fa-star"></i>
                </div>
            </a>
        </div>
    </div>
    <div th:unless="${products.isEmpty()}" class="see-all text-center mt-6">
        <a href="/all" class="text-blue-800 font-semibold hover:underline">Xem tất cả sản phẩm »</a>
    </div>
</div>

<div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-lg">
            <div class="modal-header" style="background-color: #153054; color: white;">
                <h5 class="modal-title" id="addToCartModalLabel">Thêm vào giỏ hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="modal-product-info flex items-center space-x-4">
                    <img id="modalProductImage" src="" alt="Product Image" class="w-20 h-20 object-cover rounded">
                    <div>
                        <h6 id="modalProductName" class="font-semibold"></h6>
                        <p id="modalProductPrice" class="text-blue-800 font-bold"></p>
                        <p id="modalProductStock" class="text-sm text-gray-600"></p>
                    </div>
                </div>
                <div class="size-selection mt-4">
                    <h6 class="font-semibold">Chọn size:</h6>
                    <div class="size-options flex space-x-2 mt-2" id="modalSizeOptions"></div>
                </div>
                <div class="color-selection mt-4">
                    <h6 class="font-semibold">Chọn màu sắc:</h6>
                    <div class="color-options flex space-x-2 mt-2" id="modalColorOptions"></div>
                </div>
                <div class="quantity-selection mt-4">
                    <h6 class="font-semibold">Số lượng:</h6>
                    <div class="quantity-control flex items-center space-x-2 mt-2">
                        <button class="quantity-btn minus px-3 py-1 bg-gray-200 rounded">-</button>
                        <input type="number" value="1" min="1" class="quantity-input w-16 text-center border rounded">
                        <button class="quantity-btn plus px-3 py-1 bg-gray-200 rounded">+</button>
                    </div>
                </div>
                <div id="modalError" class="text-red-500 text-sm mt-2 hidden">Vui lòng chọn kích thước và màu sắc!</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn text-white" style="background-color: #153054;" id="confirmAddToCart">Thêm vào giỏ</button>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer style="background: linear-gradient(to right, #153054, #1e4066); color: white; padding-top: 30px; padding-bottom: 20px">
    <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
            <h3 class="text-lg font-bold mb-4">ACV Store</h3>
            <p class="text-sm">Cửa hàng thời trang hàng đầu với các sản phẩm chất lượng và giá cả hợp lý.</p>
            <div class="mt-4">
                <h4 class="text-sm font-semibold">Đăng ký nhận tin</h4>
                <form class="flex gap-2 mt-2">
                    <input type="email" class="w-full p-2 rounded border" placeholder="Nhập email của bạn" aria-label="Email đăng ký nhận tin">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Đăng ký</button>
                </form>
            </div>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Liên kết nhanh</h3>
            <ul class="space-y-2">
                <li><a href="/new" class="hover:text-blue-300">Sản phẩm mới</a></li>
                <li><a href="/all" class="hover:text-blue-300">Tất cả sản phẩm</a></li>
                <li><a href="/bestsellers" class="hover:text-blue-300">Sản phẩm bán chạy</a></li>
            </ul>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Liên hệ</h3>
            <p class="text-sm">Email: datn.acv@gmail.com</p>
            <p class="text-sm">Hotline: 0911 006 045</p>
            <div class="flex space-x-4 mt-4">
                <a href="#" class="text-white hover:text-blue-300" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="text-white hover:text-blue-300" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" class="text-white hover:text-blue-300" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </div>
    <div class="text-center mt-8 text-sm">© 2025 ACV Store. All rights reserved.</div>
</footer>

<!-- Back to top -->
<button id="back-to-top" class="fixed bottom-20 right-20 bg-blue-600 text-white p-3 rounded-full shadow-lg hidden" aria-label="Quay lại đầu trang">
    <i class="fas fa-arrow-up"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script>
    // === REPLACE toàn bộ block .cart-icon hiện tại bằng block này ===
    document.querySelectorAll('.cart-icon').forEach(button => {
        button.addEventListener('click', async () => {
            const modalEl = document.getElementById('addToCartModal');
            const modal   = new bootstrap.Modal(modalEl);

            // Info cơ bản
            modalEl.querySelector('#modalProductImage').src = button.dataset.productImg || '';
            modalEl.querySelector('#modalProductName').textContent = button.dataset.productName || 'Sản phẩm';
            modalEl.querySelector('#modalProductPrice').innerHTML =
                'Từ ' + Number(button.dataset.productPrice || 0).toLocaleString('vi-VN') + ' VNĐ';
            modalEl.querySelector('#modalProductStock').textContent =
                `Tồn kho: ${button.dataset.stock ?? 'N/A'}`;

            const productId = button.dataset.productId; // dùng làm sanPhamId

            // Helpers
            const safeJSONParse = (val, fallback = []) => {
                if (val == null || val === '' || val === 'undefined' || val === 'null') return fallback;
                try { return JSON.parse(val); } catch {}
                try { const t = document.createElement('textarea'); t.innerHTML = val; return JSON.parse(t.value); } catch { return fallback; }
            };
            const setDisabled = (btn, disabled) => {
                btn.disabled = disabled;
                btn.classList.toggle('opacity-50', disabled);
                btn.classList.toggle('cursor-not-allowed', disabled);
                if (disabled) btn.classList.remove('active');
            };
            const showSuccess = (text) => window.Swal
                ? Swal.fire({ icon:'success', title:'Thành công', text, timer:1500, showConfirmButton:false })
                : alert(text);
            const showError = (text) => window.Swal
                ? Swal.fire({ icon:'error', title:'Lỗi', text })
                : alert('Lỗi: ' + text);

            // Lấy options từ data-attr (nếu có) hoặc API
            let sizes  = safeJSONParse(button.dataset.kichCo);
            let colors = safeJSONParse(button.dataset.mauSac);
            if (!Array.isArray(sizes) || !sizes.length || !Array.isArray(colors) || !colors.length) {
                try {
                    const resp = await fetch(`/api/product/${encodeURIComponent(productId)}/options`, { headers:{Accept:'application/json'} });
                    if (resp.ok) {
                        const opts = await resp.json();
                        sizes  = Array.isArray(opts.sizes)  ? opts.sizes  : [];
                        colors = Array.isArray(opts.colors) ? opts.colors : [];
                    }
                } catch(e){ console.error('Không tải được options:', e); }
            }

            // Render options
            const sizeWrap  = modalEl.querySelector('#modalSizeOptions');
            const colorWrap = modalEl.querySelector('#modalColorOptions');
            const stockEl   = modalEl.querySelector('#modalProductStock');
            const priceEl   = modalEl.querySelector('#modalProductPrice');
            const errEl     = modalEl.querySelector('#modalError');

            const enableAllSizes  = () => {
                sizeWrap.querySelectorAll('.size-option').forEach(b => setDisabled(b, false));
            };
            const enableAllColors = () => {
                colorWrap.querySelectorAll('.color-option').forEach(b => setDisabled(b, false));
            };
            const resetUIToBase   = () => {
                stockEl.textContent = `Tồn kho: ${button.dataset.stock ?? 'N/A'}`;
                priceEl.innerHTML   = 'Từ ' + Number(button.dataset.productPrice || 0).toLocaleString('vi-VN') + ' VNĐ';
                qtyInput.value = 1;
                qtyInput.removeAttribute('max');
            };

            sizeWrap.innerHTML = '';
            (sizes||[]).forEach(s => {
                const btn = document.createElement('button');
                btn.className = 'size-option';
                btn.textContent = s.ten ?? s.name ?? 'Size';
                btn.dataset.sizeId = s.id;
                sizeWrap.appendChild(btn);
            });

            const isCssColor = (str)=> /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(str)||/^rgb(a?)\(/i.test(str)||/^[a-z]+$/i.test(str);
            colorWrap.innerHTML = '';
            (colors || []).forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'color-option';

                const css = (c.maMauHex || '').toString().trim();
                if (css && isCssColor(css)) {
                    // Swatch tròn
                    btn.dataset.swatch = 'true';             // <-- QUAN TRỌNG: để CSS nhận biết là swatch
                    btn.style.backgroundColor = css;
                    btn.title = c.tenMau || '';
                } else {
                    // Pill chữ (hành vi như size)
                    btn.textContent = c.tenMau || 'Màu';
                    // Không đặt width/height; CSS sẽ xử lý như size-option
                }

                btn.dataset.colorId = c.id;
                colorWrap.appendChild(btn);
            });

            // Qty
            const minusBtn = modalEl.querySelector('.quantity-btn.minus');
            const plusBtn  = modalEl.querySelector('.quantity-btn.plus');
            const qtyInput = modalEl.querySelector('.quantity-input');
            minusBtn.onclick = () => { qtyInput.value = Math.max(1, (parseInt(qtyInput.value) || 1) - 1); };
            plusBtn.onclick  = () => {
                const max = parseInt(qtyInput.max || '999999', 10);
                qtyInput.value = Math.min((parseInt(qtyInput.value) || 1) + 1, max);
            };

            // Trạng thái chọn + biến thể
            let selectedSizeId  = null;
            let selectedColorId = null;
            let currentVariant  = null;

            // ====== VALID COMBINATIONS ======
            /** validCombos: [{sizeId, colorId, soLuongTonKho?}] nếu có API; nếu không — lazy probe + cache */
            let validCombos = null;
            const variantCache = new Map(); // key = `${sid}-${cid}` -> { exists:boolean, stock:number, gia:number, oldPrice:number }

            async function tryLoadValidCombos() {
                const tryUrls = [
                    `/api/product/${encodeURIComponent(productId)}/valid-combinations`,
                    `/api/product/${encodeURIComponent(productId)}/combinations`,
                    `/api/product/${encodeURIComponent(productId)}/variants`
                ];
                for (const url of tryUrls) {
                    try {
                        const r = await fetch(url, { headers:{Accept:'application/json'} });
                        if (r.ok) { validCombos = await r.json(); if (Array.isArray(validCombos)) return; }
                    } catch {}
                }
                validCombos = null; // không có endpoint -> dùng lazy probe
            }
            await tryLoadValidCombos();

            const keyOf = (sid, cid) => `${sid}-${cid}`;
            async function probeVariant(sid, cid) {
                const key = keyOf(sid, cid);
                if (variantCache.has(key)) return variantCache.get(key);
                try {
                    const res = await fetch(
                        `/api/getChiTietSanPham?sanPhamId=${encodeURIComponent(productId)}&sizeId=${encodeURIComponent(sid)}&colorId=${encodeURIComponent(cid)}`,
                        { credentials: 'include' }
                    );
                    const data = await res.json();
                    const exists = !!data?.id;
                    const value = { exists, stock: data?.soLuongTonKho, gia: data?.gia, oldPrice: data?.oldPrice, id: data?.id };
                    variantCache.set(key, value);
                    return value;
                } catch {
                    const value = { exists:false };
                    variantCache.set(key, value);
                    return value;
                }
            }

            function applyEnableBySize(sid) {
                if (!sid) { enableAllColors(); return; }
                const colorBtns = [...colorWrap.querySelectorAll('.color-option')];
                if (validCombos) {
                    const okSet = new Set(validCombos.filter(v => String(v.sizeId) === String(sid)).map(v => String(v.colorId)));
                    colorBtns.forEach(btn => setDisabled(btn, !okSet.has(btn.dataset.colorId)));
                } else {
                    Promise.all(colorBtns.map(async btn => {
                        const r = await probeVariant(sid, btn.dataset.colorId);
                        setDisabled(btn, !r.exists);
                    }));
                }
            }

            function applyEnableByColor(cid) {
                if (!cid) { enableAllSizes(); return; }
                const sizeBtns = [...sizeWrap.querySelectorAll('.size-option')];
                if (validCombos) {
                    const okSet = new Set(validCombos.filter(v => String(v.colorId) === String(cid)).map(v => String(v.sizeId)));
                    sizeBtns.forEach(btn => setDisabled(btn, !okSet.has(btn.dataset.sizeId)));
                } else {
                    Promise.all(sizeBtns.map(async btn => {
                        const r = await probeVariant(btn.dataset.sizeId, cid);
                        setDisabled(btn, !r.exists);
                    }));
                }
            }


            async function fetchVariantAndRender() {
                if (!selectedSizeId || !selectedColorId) {
                    currentVariant = null;
                    stockEl.textContent = 'Tồn kho: hãy chọn size & màu';
                    return;
                }
                // nếu đã có trong cache thì dùng luôn
                let data = variantCache.get(keyOf(selectedSizeId, selectedColorId));
                if (!data || data.id == null) {
                    const res = await fetch(
                        `/api/getChiTietSanPham?sanPhamId=${encodeURIComponent(productId)}&sizeId=${encodeURIComponent(selectedSizeId)}&colorId=${encodeURIComponent(selectedColorId)}`,
                        { credentials: 'include' }
                    );
                    const j = await res.json();
                    data = { id:j?.id, stock:j?.soLuongTonKho, gia:j?.gia, oldPrice:j?.oldPrice, exists:!!j?.id };
                    variantCache.set(keyOf(selectedSizeId, selectedColorId), data);
                }
                if (!data?.id) {
                    currentVariant = null;
                    stockEl.textContent = 'Biến thể không khả dụng';
                    return;
                }
                currentVariant = { id:data.id, soLuongTonKho:data.stock, gia:data.gia, oldPrice:data.oldPrice };

                // tồn kho
                if (typeof data.stock === 'number') {
                    stockEl.textContent = `Tồn kho: ${data.stock}`;
                    qtyInput.max = data.stock;
                    if (+qtyInput.value > data.stock) qtyInput.value = data.stock;
                } else {
                    stockEl.textContent = 'Tồn kho: N/A';
                    qtyInput.removeAttribute('max');
                }

                // giá
                const cur = Number(data.gia || 0).toLocaleString('vi-VN') + ' VNĐ';
                if (data.oldPrice && data.oldPrice !== data.gia) {
                    const old = Number(data.oldPrice).toLocaleString('vi-VN') + ' VNĐ';
                    priceEl.innerHTML = `${cur} <span class="text-red-600 line-through ml-2">${old}</span>`;
                } else {
                    priceEl.textContent = cur;
                }
            }

            // Bắt sự kiện chọn + ràng buộc enable/disable
            // SIZE: toggle chọn / bỏ chọn
            sizeWrap.querySelectorAll('.size-option').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const isActive = btn.classList.contains('active');

                    // Nếu đang active -> bỏ tick
                    if (isActive) {
                        btn.classList.remove('active');
                        selectedSizeId = null;
                        applyEnableBySize(null);               // bật lại toàn bộ màu
                        if (selectedColorId) applyEnableByColor(selectedColorId); // nếu còn màu, lọc size theo màu
                        currentVariant = null;
                        stockEl.textContent = selectedColorId ? 'Tồn kho: hãy chọn size' : `Tồn kho: ${button.dataset.stock ?? 'N/A'}`;
                        priceEl.innerHTML   = 'Từ ' + Number(button.dataset.productPrice || 0).toLocaleString('vi-VN') + ' VNĐ';
                        qtyInput.removeAttribute('max');
                        return;
                    }

                    // Chọn size mới
                    sizeWrap.querySelectorAll('.size-option').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedSizeId = btn.dataset.sizeId;
                    applyEnableBySize(selectedSizeId);
                    await fetchVariantAndRender();
                });
            });

// COLOR: toggle chọn / bỏ chọn
            colorWrap.querySelectorAll('.color-option').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const isActive = btn.classList.contains('active');

                    // Nếu đang active -> bỏ tick
                    if (isActive) {
                        btn.classList.remove('active');
                        selectedColorId = null;
                        applyEnableByColor(null);               // bật lại toàn bộ size
                        if (selectedSizeId) applyEnableBySize(selectedSizeId); // nếu còn size, lọc màu theo size
                        currentVariant = null;
                        stockEl.textContent = selectedSizeId ? 'Tồn kho: hãy chọn màu' : `Tồn kho: ${button.dataset.stock ?? 'N/A'}`;
                        priceEl.innerHTML   = 'Từ ' + Number(button.dataset.productPrice || 0).toLocaleString('vi-VN') + ' VNĐ';
                        qtyInput.removeAttribute('max');
                        return;
                    }

                    // Chọn màu mới
                    colorWrap.querySelectorAll('.color-option').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedColorId = btn.dataset.colorId;
                    applyEnableByColor(selectedColorId);
                    await fetchVariantAndRender();
                });
            });

            // Mở modal
            errEl.classList.add('hidden');
            // Ban đầu: enable tất cả
            sizeWrap.querySelectorAll('.size-option').forEach(b => setDisabled(b, false));
            colorWrap.querySelectorAll('.color-option').forEach(b => setDisabled(b, false));
            modal.show();

            // Thêm vào giỏ (giữ đúng flow trang chi tiết)
            const confirmButton = modalEl.querySelector('#confirmAddToCart');
            confirmButton.onclick = async () => {
                errEl.classList.add('hidden');

                const sBtn = sizeWrap.querySelector('.size-option.active');
                const cBtn = colorWrap.querySelector('.color-option.active');
                if (!sBtn || !cBtn) {
                    errEl.textContent = 'Vui lòng chọn kích thước và màu sắc!';
                    errEl.classList.remove('hidden');
                    return;
                }
                if (!currentVariant?.id) {
                    await fetchVariantAndRender();
                    if (!currentVariant?.id) return showError('Không thể lấy thông tin biến thể!');
                }

                const quantity = Math.max(1, parseInt(qtyInput.value) || 1);
                if (typeof currentVariant.soLuongTonKho === 'number' && quantity > currentVariant.soLuongTonKho) {
                    return showError('Số lượng vượt quá tồn kho!');
                }

                confirmButton.disabled = true;
                confirmButton.classList.add('loading');

                try {
                    const payload = { id: currentVariant.id, quantity };
                    const addRes = await fetch('/api/cart/add', {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(payload)
                    });

                    if (addRes.ok) {
                        showSuccess('Đã thêm vào giỏ hàng!');
                        try { window.updateCartCount?.(); } catch {}
                        modal.hide();
                    } else if (addRes.status === 401) {
                        window.location.href = '/customers/login';
                    } else {
                        let msg = '';
                        try { const j = await addRes.json(); msg = j.error || JSON.stringify(j); }
                        catch { msg = await addRes.text(); }
                        showError(msg || 'Có lỗi xảy ra khi thêm vào giỏ hàng!');
                    }
                } catch (e) {
                    showError(e?.message || 'Lỗi mạng khi thêm vào giỏ hàng!');
                } finally {
                    confirmButton.disabled = false;
                    confirmButton.classList.remove('loading');
                }
            };
        });
    });

    document.querySelectorAll('.quick-view-btn').forEach(button => {
        button.addEventListener('click', async () => {
            const productId = button.dataset.productId;
            let product;

            try {
                const res = await fetch(`/api/product/${encodeURIComponent(productId)}`, {
                    headers: { 'Accept': 'application/json' }
                });
                if (!res.ok) {
                    const txt = await res.text().catch(() => '');
                    throw new Error(txt || `HTTP ${res.status}`);
                }
                const ct = res.headers.get('content-type') || '';
                product = ct.includes('application/json') ? await res.json() : JSON.parse(await res.text());
            } catch (err) {
                console.error('Quick View error:', err);
                alert('Không lấy được dữ liệu sản phẩm (có thể ID không tồn tại hoặc API trả về lỗi).');
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'modal fade';
            wrapper.tabIndex = -1;
            wrapper.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header" style="background-color: #153054; color: white;">
            <h5 class="modal-title">${product.tenSanPham ?? 'Sản phẩm'}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <img src="${product.urlHinhAnh ?? ''}" alt="${product.tenSanPham ?? ''}" class="w-full h-64 object-cover rounded mb-4">
            <p class="text-blue-800 font-bold">${Number(product.price || 0).toLocaleString('vi-VN')} VNĐ</p>
            <p class="text-sm text-gray-600">Tồn kho: ${product.tongSoLuong ?? 'N/A'}</p>
            <p class="text-sm">${product.moTa || 'Không có mô tả'}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <a href="/chitietsanpham?id=${product.id}" class="btn text-white" style="background-color: #153054;">Xem chi tiết</a>
          </div>
        </div>
      </div>
    `;
            document.body.appendChild(wrapper);
            const quickViewModal = new bootstrap.Modal(wrapper);
            quickViewModal.show();
            wrapper.addEventListener('hidden.bs.modal', () => wrapper.remove(), { once: true });
        });
    });

    // Search suggestions (tái sử dụng từ index.html)
    const searchInput = document.getElementById('searchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');
    let debounceTimer;

    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            const keyword = searchInput.value.trim();
            searchSuggestions.innerHTML = '';
            if (keyword.length < 2) {
                showSearchHistory();
                return;
            }

            try {
                const response = await fetch(`/api/search-with-history?keyword=${encodeURIComponent(keyword)}`, { credentials: 'include' });
                const products = await response.json();
                searchSuggestions.innerHTML = '';
                if (products.length === 0) {
                    searchSuggestions.innerHTML = '<div class="suggestion-item">Không tìm thấy sản phẩm, xem các sản phẩm nổi bật</div>';
                }
                products.forEach(product => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'suggestion-item';
                    suggestion.innerHTML = `
                            <img src="${product.urlHinhAnh}" alt="${product.tenSanPham}"/>
                            <div>
                                <div class="font-semibold">${product.tenSanPham}</div>
                                <div class="text-blue-800">${product.price.toLocaleString('vi-VN')} VNĐ</div>
                            </div>
                        `;
                    suggestion.addEventListener('click', () => {
                        window.location.href = `/chitietsanpham?id=${product.id}`;
                    });
                    searchSuggestions.appendChild(suggestion);
                });
                searchSuggestions.classList.add('active');
            } catch (error) {
                console.error('Error fetching search suggestions:', error);
                searchSuggestions.innerHTML = '<div class="suggestion-item">Lỗi khi tải gợi ý</div>';
                searchSuggestions.classList.add('active');
            }
        }, 300);
    });

    searchInput.addEventListener('focus', async () => {
        if (searchInput.value.trim().length < 2) {
            showSearchHistory();
        }
    });

    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
            searchSuggestions.classList.remove('active');
        }
    });

    async function showSearchHistory() {
        try {
            const response = await fetch('/api/search-history', { credentials: 'include' });
            const history = await response.json();
            searchSuggestions.innerHTML = '';
            if (history.length === 0) {
                searchSuggestions.innerHTML = '<div class="history-item">Không có lịch sử tìm kiếm</div>';
            } else {
                history.forEach(keyword => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `<i class="fas fa-history mr-2"></i>${keyword}`;
                    historyItem.addEventListener('click', () => {
                        searchInput.value = keyword;
                        searchInput.dispatchEvent(new Event('input'));
                    });
                    searchSuggestions.appendChild(historyItem);
                });
            }
            searchSuggestions.classList.add('active');
        } catch (error) {
            console.error('Error fetching search history:', error);
            searchSuggestions.innerHTML = '<div class="history-item">Lỗi khi tải lịch sử tìm kiếm</div>';
            searchSuggestions.classList.add('active');
        }
    }

    // Back to top
    const backToTop = document.getElementById('back-to-top');
    window.addEventListener('scroll', () => {
        backToTop.classList.toggle('hidden', window.scrollY < 200);
    });
    backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
</script>
</body>
</html>