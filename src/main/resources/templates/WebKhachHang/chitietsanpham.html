<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ACV Store - Chi ti·∫øt s·∫£n ph·∫©m</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        button[disabled] {
            pointer-events: none;
            opacity: 0.5;
            cursor: not-allowed;
        }
        .navbar { background: linear-gradient(to right, #153054, #1e4066); }
        .navbar { position: fixed; top: 38px; left: 0; width: 100%; z-index: 1040; }
        .product-img { width: 100%; max-height: 400px; object-fit: cover; }
        .thumbnail-img { width: 80px; height: 80px; object-fit: cover; cursor: pointer; }
        .thumbnail-img:hover { opacity: 0.8; }
        .size-option.active, .color-option.active { background-color: #153054; color: white; }
        .ticker { background-color: #9FD5F7; color: #153054; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1050; }
        .dropdown-menu { display: none; position: absolute; background-color: white; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1000; }
        .dropdown:hover .dropdown-menu { display: block; }
        body { padding-top: 100px; }
        .quantity-control { display: flex; align-items: center; gap: 10px; }
        .quantity-input { width: 60px; text-align: center; }
        .quantity-input:disabled { background-color: #f1f1f1; cursor: not-allowed; }
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .search-suggestions.active {
            opacity: 1;
            visibility: visible;
        }
        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .suggestion-item:hover {
            background-color: #f1f5f9;
        }
        .suggestion-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            border-radius: 4px;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .history-item:hover {
            background-color: #e2e8f0;
        }
        .history-item .highlight {
            background-color: #9FD5F7;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .history-item .delete-btn {
            color: #ef4444;
            font-size: 14px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .history-item .delete-btn:hover {
            color: #b91c1c;
        }
        @media (max-width: 640px) {
            .product-img { max-height: 300px; }
            .thumbnail-img { width: 60px; height: 60px; }
            .dropdown-menu { width: 100%; left: 0; }
            body { padding-top: 80px; }
        }
        .map-container {
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .map-container:hover {
            transform: translateY(-5px);
        }
        @keyframes patternMove {
            0% { background-position: 0 0, 0 0; }
            100% { background-position: 60px 60px, -60px 60px; }
        }
        @media (max-width: 768px) {
            .map-container iframe {
                height: 200px;
            }
            .container.mx-auto {
                padding: 0 10px;
            }
        }
    /*    chatbot*/
        #chatbot-box{
            position: fixed; bottom: 100px; right: 30px;
            width: 420px;
            height: clamp(520px, 70vh, 640px); /* <-- th√™m */
            max-height: none;                  /* <-- b·ªè gi·ªõi h·∫°n c≈© */
            display: flex;
            flex-direction: column;
            background:#fff; border-radius:14px;
            box-shadow: 0 12px 32px rgba(0,0,0,.18);
            overflow: hidden; z-index:10000;
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;

            /* tr·∫°ng th√°i ·∫©n */
            opacity: 0;
            transform: translateY(12px) scale(.98);
            pointer-events: none;
            visibility: hidden;
            transform-origin: bottom right;

            transition: opacity .25s ease, transform .25s ease, visibility .25s;
            will-change: opacity, transform;
        }

        #chat-messages{
            padding:12px 12px 6px;
            flex: 1;           /* <-- th√™m */
            min-height: 0;     /* <-- r·∫•t quan tr·ªçng ƒë·ªÉ ph·∫ßn n√†y cu·ªôn ƒë∆∞·ª£c trong flex */
            overflow-y: auto;
            background:#fff;
        }


        /* tr·∫°ng th√°i hi·ªán */
        #chatbot-box.is-open{
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
            visibility: visible;
        }

        /* t√¥n tr·ªçng gi·∫£m chuy·ªÉn ƒë·ªông */
        @media (prefers-reduced-motion: reduce){
            #chatbot-box{ transition: none; }
        }


        /* Header t·ªëi, icon tr√≤n */
        .cb-header{ background:#153054; color:#fff; padding:10px 12px; display:flex; align-items:center; gap:10px; }
        .brand-logo{ width:45px; height:45px; border-radius:30px; object-fit:cover; }

        .cb-header .brand{
            display:flex; align-items:center; gap:8px; font-weight:700;
        }
        .cb-header .brand .dot{
            width:28px;height:28px;border-radius:50%;
            background:#9FD5F7; display:inline-block;
        }
        /* QR combobox b√™n tr√°i input */
        .qr-wrap{ position:relative; }
        .qr-btn{
            width:44px;height:44px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;color:#111827;
            display:flex;align-items:center;justify-content:center; cursor:pointer;
        }
        .qr-btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
        .qr-menu{
            position:absolute; left:0; bottom:52px; /* n·ªïi ph√≠a tr√™n input */
            width:260px; max-height:260px; overflow:auto;
            background:#fff; border:1px solid #e5e7eb; border-radius:12px;
            box-shadow:0 12px 28px rgba(0,0,0,.12);
            padding:8px; display:none; z-index:10001;
        }
        .qr-menu.show{ display:block; }
        .qr-item{
            width:100%; text-align:left; border:0; background:#fff; color:#111827;
            padding:10px 12px; border-radius:10px; font-size:14px; cursor:pointer;
        }
        .qr-item:hover{ background:#f3f4f6; }

        .cb-actions{ margin-left:auto; display:flex; gap:8px; }
        .cb-icon{
            width:32px;height:32px;border-radius:8px;
            display:flex;align-items:center;justify-content:center;
            background:rgba(255,255,255,.08); color:#fff; cursor:pointer; border:0;
        }
        .cb-icon:hover{ background:rgba(255,255,255,.16); }

        /* V√πng tin nh·∫Øn */
        #chat-messages{
            padding:12px 12px 6px;
            height:420px; overflow-y:auto; background:#fff;
        }

        /* Bong b√≥ng bot + avatar b·∫±ng ::before */
        .chatbot-msg-bot{
            position:relative;
            background:#f3f4f6; color:#111827;
            padding:10px 12px; border-radius:14px 14px 14px 4px;
            max-width:82%; margin:0 56px 10px 40px; /* ch·ª´a ch·ªó avatar tr√°i */
            font-size:15px; line-height:1.45; word-wrap:break-word;
        }
        .chatbot-msg-bot::before {
            content: "";
            position: absolute;
            left: -40px;
            top: 4px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-image: url('/image/ACV.jpg');
            background-size: cover;
            background-position: center;
        }


        .chatbot-msg-user{
            background:#153054; color:#fff;
            padding:10px 12px; border-radius:14px 14px 4px 14px;
            max-width:82%; margin:0 0 10px auto;
            font-size:15px; line-height:1.45; word-wrap:break-word;
        }

        /* Typing indicator gi·∫£ l·∫≠p */
        #typing-indicator{ opacity:.8; font-style:italic; }

        /* Quick reply d·∫°ng pill d∆∞·ªõi v√πng chat */
        .cb-quick{
            padding:6px 12px 10px; background:#fff;
            display:flex; flex-wrap:wrap; gap:8px;
        }
        .cb-pill{
            border:1px solid #e5e7eb; background:#fff; color:#111827;
            padding:8px 12px; border-radius:18px; font-size:14px;
            cursor:pointer; transition:.15s;
        }
        .cb-pill:hover{ background:#f3f4f6; }

        /* Thanh nh·∫≠p + n√∫t g·ª≠i */
        .cb-inputbar{
            border-top:1px solid #eee;
            padding:10px; display:flex; gap:8px; align-items:center; background:#fff;
        }
        #chat-input{
            flex:1; padding:12px 14px; border:1px solid #e5e7eb;
            border-radius:24px; font-size:15px; outline:none;
        }
        #chat-input:focus{ border-color:#b6c2ff; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
        #chat-send{
            width:44px;height:44px;border-radius:50%;border:0;
            background:#153054;
            color:#fff; display:flex;align-items:center;justify-content:center;
        }


        /* Ghi ch√∫ nh·ªè gi·ªëng caption ‚ÄúTh√¥ng tin ch·ªâ mang t√≠nh tham kh·∫£o‚Ä¶‚Äù */
        .cb-note{
            padding:6px 14px 12px; font-size:10px; text-align: center ; color:#6b7280; background:#fff ;
        }
        #chat-input {
            flex: 1;
            resize: none;              /* kh√¥ng cho k√©o th·ªß c√¥ng */
            overflow-y: hidden;        /* ·∫©n thanh cu·ªôn */
            line-height: 1.4;
            max-height: 120px;         /* gi·ªõi h·∫°n chi·ªÅu cao t·ªëi ƒëa (t·∫ßm 5-6 d√≤ng) */
        }
        @media (max-width: 640px){
            #chatbot-box{
                width: 92vw;
                right: 4vw;
                bottom: 90px;   /* tr√°nh ƒë√® n√∫t n·ªïi */
                height: 70vh;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="ticker py-1 overflow-hidden fixed top-0 w-full z-50">
    <marquee behavior="scroll" direction="left" scrollamount="5">
        üéâ Khuy·∫øn m√£i ƒë·∫∑c bi·ªát: Gi·∫£m gi√° l√™n ƒë·∫øn 50% cho t·∫•t c·∫£ s·∫£n ph·∫©m h√¥m nay! üéâ - Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n t·ª´ 500k!
    </marquee>
</div>

<div th:replace="~{fragments/kh_navbar :: navbar(user=${user}, keyword=${keyword}, cartCount=${cartCount})}"></div>

<section class="container mx-auto py-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
            <img th:src="${productDetail.urlHinhAnh}" th:alt="${productDetail.tenSanPham}" class="product-img rounded-lg"/>
            <div class="flex space-x-2 mt-4">
                <img th:if="${productDetail.hinhAnhList != null and not #lists.isEmpty(productDetail.hinhAnhList)}" th:each="image : ${productDetail.hinhAnhList}"
                     th:src="${image}" th:alt="${productDetail.tenSanPham}" class="thumbnail-img rounded"/>
                <img th:unless="${productDetail.hinhAnhList != null and not #lists.isEmpty(productDetail.hinhAnhList)}" th:src="${productDetail.urlHinhAnh}"
                     th:alt="${productDetail.tenSanPham}" class="thumbnail-img rounded"/>
            </div>
        </div>
        <div>
            <h1 th:text="${productDetail.tenSanPham}" class="text-3xl font-bold text-gray-800 mb-4"></h1>
            <!-- Hi·ªÉn th·ªã gi√° -->
            <div class="mb-4">
                <!-- Gi√° (khi ch∆∞a ch·ªçn: hi·ªÉn th·ªã min - max) -->
                <span id="detail-price"
                      class="price text-[#153054] font-bold text-2xl"
                      th:attr="data-min=${minPrice},data-max=${maxPrice},data-old-min=${oldMinPrice},data-old-max=${oldMaxPrice}">
    </span>

                <!-- Gi√° c≈© (·∫©n m·∫∑c ƒë·ªãnh) -->
                <div id="detail-old-price"
                     class="old-price text-sm text-red-600 line-through inline-block ml-2"
                     style="display:none"></div>

                <!-- Discount Campaign -->
                <div th:if="${productDetail.discountCampaignName != null}" class="text-sm text-green-600">
                    <span th:text="'Gi·∫£m gi√°: ' + ${productDetail.discountCampaignName}"></span>
                </div>
            </div>
            <p class="text-gray-600 mb-4" th:text="${productDetail.moTa}"></p>
            <p class="text-gray-600 mb-2">Th∆∞∆°ng hi·ªáu: <span th:text="${productDetail.thuongHieu.tenThuongHieu}"></span></p>
            <p class="text-gray-600 mb-2">S·ªë l∆∞·ª£ng t·ªìn kho: <span id="dynamic-stock">Ch·ªçn m√†u & size</span></p>
            <div class="size-selection mb-4">
                <h6 class="font-semibold">K√≠ch c·ª°:</h6>
                <div class="size-options flex space-x-2 mt-2">
                    <button th:each="size : ${productDetail.kichCoList}" th:text="${size.ten}" th:attr="data-size-id=${size.id}" class="size-option px-4 py-2 border rounded hover:bg-[#e0ebf5]"></button>
                </div>
            </div>
            <div class="color-selection mb-4">
                <h6 class="font-semibold">M√†u s·∫Øc:</h6>
                <div class="color-options flex space-x-2 mt-2">
                    <button th:each="color : ${productDetail.mauSacList}" th:text="${color.tenMau}" th:attr="data-color-id=${color.id}" class="color-option px-4 py-2 border rounded hover:bg-[#e0ebf5]"></button>
                </div>
            </div>
            <div class="quantity-selection mb-4">
                <h6 class="font-semibold">S·ªë l∆∞·ª£ng:</h6>
                <div class="quantity-control flex items-center space-x-2 mt-2">
                    <button class="quantity-btn minus px-3 py-1 bg-gray-200 rounded" disabled>-</button>
                    <input type="number" value="1" min="1" th:max="${productDetail.soLuongTonKho}" class="quantity-input border rounded" disabled/>
                    <button class="quantity-btn plus px-3 py-1 bg-gray-200 rounded" disabled>+</button>
                </div>
            </div>
            <div class="button-group mt-4">
                <button class="btn bg-[#153054] text-white hover:bg-[#1e4066] px-6 py-2 rounded add-to-cart"
                        th:attr="data-product-id=${productDetail.id},data-san-pham-id=${productDetail.sanPhamId},data-product-name=${productDetail.tenSanPham},data-product-price=${#numbers.formatDecimal(productDetail.gia, 0, 0, 'COMMA')},data-product-img=${productDetail.urlHinhAnh}">
                    <i class="fas fa-shopping-cart"></i> Th√™m v√†o gi·ªè h√†ng
                </button>
                <button class="btn bg-green-600 text-white hover:bg-green-700 px-6 py-2 rounded buy-now"
                        th:attr="data-product-id=${productDetail.id},data-san-pham-id=${productDetail.sanPhamId},data-product-name=${productDetail.tenSanPham},data-product-price=${#numbers.formatDecimal(productDetail.gia, 0, 0, 'COMMA')},data-product-img=${productDetail.urlHinhAnh}">
                    <i class="fas fa-bolt"></i> Mua ngay
                </button>
                <a href="/" class="btn bg-gray-500 text-white hover:bg-gray-600 px-6 py-2 rounded">
                    <i class="fas fa-home"></i> Quay l·∫°i trang ch·ªß
                </a>
            </div>
        </div>
    </div>
</section>

<section class="mt-10">
    <h2 class="text-2xl font-bold mb-4">ƒê√°nh gi√° s·∫£n ph·∫©m</h2>
    <div id="rating-summary" class="mb-6">
        <p class="font-semibold text-lg">‚≠ê <span id="avg-rating">0</span>/5 t·ª´ <span id="total-reviews">0</span> ƒë√°nh gi√°</p>
    </div>
    <div id="ratings-list" class="space-y-4">
        <p>ƒêang t·∫£i ƒë√°nh gi√°...</p>
    </div>
</section>

<section class="container mx-auto py-12">
    <h2 class="text-2xl font-bold text-gray-800 mb-6">S·∫£n ph·∫©m li√™n quan</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        <div th:each="sp : ${sanPhamLienQuan}" class="bg-white rounded-lg shadow hover:shadow-md transition p-3">
            <a th:href="@{/chitietsanpham(id=${sp.id})}">
                <img th:src="${sp.urlHinhAnh}" th:alt="${sp.tenSanPham}" class="w-full h-52 object-cover rounded mb-3"/>
                <h3 th:text="${sp.tenSanPham}" class="text-base font-semibold text-gray-700 line-clamp-2 h-[48px]"></h3>
                <div class="mb-2">
                    <!-- Formatted Price -->
                    <span class="price text-[#153054] font-bold text-sm" th:attr="data-price=${sp.price}"></span>
                    <!-- Old Price with Line-through -->
                    <div th:if="${sp.oldPrice != null and sp.price != sp.oldPrice}" class="old-price text-sm text-red-600 line-through inline-block ml-2">
                        <span th:attr="data-old-price=${sp.oldPrice}"></span>
                    </div>
                    <!-- Discount Campaign -->
                    <div th:if="${sp.discountCampaignName != null}" class="text-sm text-green-600">
                        <span th:text="'Gi·∫£m gi√°: ' + ${sp.discountCampaignName}"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>
</section>

<!-- Floating Chatbot Icon -->
<div id="chatbot-toggle"
     style="position: fixed; bottom: 20px; right: 20px; background-color: #9FD5F7;
            width: 60px; height: 60px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; z-index: 10000;
            cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
    <img th:src="@{/image/ACV.jpg}" alt="ACV"
         style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
</div>

<!-- Chatbot Box -->
<div id="chatbot-box">
    <!-- Header -->
    <div class="cb-header">
  <span class="brand">
    <img th:src="@{/image/ACV.jpg}" alt="ACV" class="brand-logo" />
    ACV Store
  </span>
        <div class="cb-actions">
            <button id="chat-reload" class="cb-icon" title="Xo√° l·ªãch s·ª≠ chat">
                <i class="fas fa-rotate-right"></i>
            </button>
            <button id="chatbot-close" class="cb-icon" title="ƒê√≥ng">
                <i class="fas fa-minus"></i>
            </button>
        </div>
    </div>


    <!-- Messages -->
    <div id="chat-messages"></div>

    <!-- Quick row (ch·ªâ hi·ªán tr∆∞·ªõc khi c√≥ tin nh·∫Øn ƒë·∫ßu ti√™n) -->
    <div id="quick-row" class="cb-quick" style="display:none">
        <button class="cb-pill quick-reply">S·∫£n ph·∫©m m·ªõi nh·∫•t</button>
        <button class="cb-pill quick-reply">Th√¥ng tin li√™n h·ªá</button>
        <button class="cb-pill quick-reply">ƒê·ªãa ch·ªâ c·ª≠a h√†ng</button>
    </div>

    <!-- Input + Send Button -->
    <div class="cb-inputbar">
        <!-- Quick-reply combobox icon -->
        <div class="qr-wrap">
            <button id="qr-trigger" class="qr-btn" aria-haspopup="true" aria-expanded="false" title="Quick reply">
                <i class="fas fa-bars"></i>
            </button>
            <div id="qr-menu" class="qr-menu" role="menu" aria-hidden="true">
                <button class="qr-item quick-reply" role="menuitem">S·∫£n ph·∫©m m·ªõi nh·∫•t</button>
                <button class="qr-item quick-reply" role="menuitem">Th√¥ng tin li√™n h·ªá</button>
                <button class="qr-item quick-reply" role="menuitem">ƒê·ªãa ch·ªâ c·ª≠a h√†ng</button>
            </div>
        </div>

        <textarea id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1"></textarea>
        <button id="chat-send" aria-label="G·ª≠i" title="G·ª≠i (Enter)">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>


    <!-- Note -->
    <div class="cb-note">
        Th√¥ng tin ch·ªâ mang t√≠nh tham kh·∫£o, ƒë∆∞·ª£c t∆∞ v·∫•n b·ªüi Tr·ª£ l√Ω Tr√≠ tu·ªá Nh√¢n T·∫°o.
    </div>
</div>

<footer style="background: linear-gradient(to right, #153054, #1e4066); color: white; padding-top: 30px; padding-bottom: 20px; position: relative; z-index: 1;">
    <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
            <h3 class="text-lg font-bold mb-4">ACV Store</h3>
            <p class="text-sm">C·ª≠a h√†ng th·ªùi trang h√†ng ƒë·∫ßu v·ªõi c√°c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng v√† gi√° c·∫£ h·ª£p l√Ω.</p>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Li√™n k·∫øt nhanh</h3>
            <ul class="space-y-2">
                <li><a href="/new" class="hover:text-blue-300">S·∫£n ph·∫©m m·ªõi</a></li>
                <li><a href="/all" class="hover:text-blue-300">T·ªß ƒë·ªì m√πa h√®</a></li>
                <li><a href="/bestsellers" class="hover:text-blue-300">S·∫£n ph·∫©m b√°n ch·∫°y</a></li>
            </ul>
        </div>
        <div>
            <h3 class="text-lg font-bold mb-4">Li√™n h·ªá</h3>
            <p class="text-sm">ƒê·ªãa ch·ªâ: Chung C∆∞ Le Capitole, H√† N·ªôi, Vi·ªát Nam</p>
            <p class="text-sm">Email: datn.acv@gmail.com</p>
            <p class="text-sm">Hotline: 0911 006 045</p>
            <div class="flex space-x-4 mt-4">
                <a href="#" class="text-white hover:text-blue-300" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="text-white hover:text-blue-300" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="#" class="text-white hover:text-blue-300" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
    </div>
    <div class="container mx-auto mt-8">
        <div class="map-container relative overflow-hidden rounded-lg shadow-md transition-all duration-300 hover:shadow-lg">
            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3724.646955515961!2d105.81876547508028!3d21.00678448063709!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3135ad4154d7e2e9%3A0x4ac6110617de42bc!2sChung%20C%C6%B0%20Le%20Capitole!5e0!3m2!1sen!2s!4v1754127537191!5m2!1sen!2s" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
        <p class="text-center text-sm mt-2 text-gray-300">* B·∫£n ƒë·ªì hi·ªÉn th·ªã v·ªã tr√≠ chi nh√°nh ch√≠nh t·∫°i Chung C∆∞ Le Capitole, H√† N·ªôi. Vui l√≤ng li√™n h·ªá ƒë·ªÉ x√°c nh·∫≠n gi·ªù m·ªü c·ª≠a.</p>
    </div>
    <div class="text-center mt-8 text-sm">¬© 2025 ACV Store. All rights reserved.</div>
    <!-- Hi·ªáu ·ª©ng n·ªÅn -->
    <div class="absolute top-0 left-0 w-full h-full bg-[linear-gradient(45deg,transparent_40%,rgba(0,0,0,0.02)_50%,transparent_60%),linear-gradient(-45deg,transparent_40%,rgba(0,0,0,0.02)_50%,transparent_60%)] bg-[length:60px_60px] animate-[patternMove_20s_linear_infinite] -z-10"></div>
</footer>

<button id="back-to-top" class="fixed bottom-20 right-20 bg-blue-600 text-white p-3 rounded-full shadow-lg hidden" aria-label="Quay l·∫°i ƒë·∫ßu trang">
    <i class="fas fa-arrow-up"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/navbar.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    window.validCombinations = /*[[${productDetail.validCombinations}]]*/ [];
    /*]]>*/
</script>

<!--chatbot-->
<script>
    const qrTrigger = document.getElementById('qr-trigger');
    const qrMenu    = document.getElementById('qr-menu');

    qrTrigger?.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = qrMenu.classList.toggle('show');
        qrTrigger.setAttribute('aria-expanded', open ? 'true' : 'false');
        qrMenu.setAttribute('aria-hidden', open ? 'false' : 'true');
    });

    // click ngo√†i ƒë·ªÉ ƒë√≥ng menu
    document.addEventListener('click', (e) => {
        if (!qrMenu) return;
        if (!qrMenu.contains(e.target) && !qrTrigger.contains(e.target)) {
            qrMenu.classList.remove('show');
            qrTrigger.setAttribute('aria-expanded', 'false');
            qrMenu.setAttribute('aria-hidden', 'true');
        }
    });


    function showQuickRow() {
        const el = document.getElementById('quick-row');
        if (el) el.style.display = 'flex';
    }
    function hideQuickRow() {
        const el = document.getElementById('quick-row');
        if (el) el.style.display = 'none';
    }

    // ƒê√≥ng combobox khi ch·ªçn quick-reply trong menu
    qrMenu?.addEventListener('click', (e) => {
        const item = e.target.closest('.quick-reply');
        if (!item) return;
        // t·∫Øt menu ngay
        qrMenu.classList.remove('show');
        qrTrigger.setAttribute('aria-expanded', 'false');
        qrMenu.setAttribute('aria-hidden', 'true');
    });


    // ====== DOM refs m·ªõi ======
    const reloadBtn  = document.getElementById('chat-reload');
    const quickCombo = document.getElementById('quick-combobox');
    const sendBtn    = document.getElementById('chat-send');

    // ====== Reload l·ªãch s·ª≠ ======
    reloadBtn?.addEventListener('click', () => {
        // Xo√° to√†n b·ªô l·ªãch s·ª≠ chat trong sessionStorage
        sessionStorage.removeItem('chat_history');

        // Xo√° tin nh·∫Øn tr√™n giao di·ªán
        chatMessages.innerHTML = '';
        showQuickRow();


        // G·ªçi l·ªùi ch√†o m·∫∑c ƒë·ªãnh nh∆∞ m·ªõi m·ªü
        ensureGreeting();
    });

    // ====== Quick-reply combobox ======
    quickCombo?.addEventListener('change', () => {
        const v = quickCombo.value.trim();
        if (!v) return;
        chatInput.value = v;
        chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        quickCombo.selectedIndex = 0; // reset l·∫°i option ƒë·∫ßu
    });

    // ====== N√∫t g·ª≠i click = nh·∫•n Enter ======
    sendBtn?.addEventListener('click', () => {
        chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
    });

    // ====== Auto ch√†o khi m·ªü l·∫ßn ƒë·∫ßu ======
    function ensureGreeting() {
        const items = JSON.parse(sessionStorage.getItem('chat_history') || '[]');
        if (items.length > 0) return;

        const greet1 = 'Xin ch√†o B·∫°n! M√¨nh l√† tr·ª£ l√Ω AI c·ªßa ACV Store';
        const greet2 = 'M√¨nh r·∫•t s·∫µn l√≤ng h·ªó tr·ª£ B·∫°n üòä';

        const g1 = document.createElement('div');
        g1.className = 'chatbot-msg-bot';
        g1.textContent = greet1;

        const g2 = document.createElement('div');
        g2.className = 'chatbot-msg-bot';
        g2.textContent = greet2;

        chatMessages.appendChild(g1);
        chatMessages.appendChild(g2);

        saveToHistory('bot', greet1);
        saveToHistory('bot', greet2);

        chatMessages.scrollTop = chatMessages.scrollHeight;
        showQuickRow(); // hi·ªán quick-reply khi l·∫ßn ƒë·∫ßu m·ªü
    }

    function formatVND(n) {
        return new Intl.NumberFormat('vi-VN').format(n) + ' VNƒê';
    }
    function formatPrice() {
        // Format price
        document.querySelectorAll('.price').forEach(el => {
            const raw = el.dataset.price;
            if (!raw || isNaN(raw)) return;
            el.textContent = formatVND(raw);
        });

        // Format old price
        document.querySelectorAll('.old-price span').forEach(el => {
            const raw = el.dataset.oldPrice;
            if (!raw || isNaN(raw)) return;
            el.textContent = formatVND(raw);
        });
    }

    function showPriceRange() {
        const priceEl = document.getElementById('detail-price');
        const oldEl = document.getElementById('detail-old-price');
        if (!priceEl) return;

        const min = parseFloat(priceEl.dataset.min);
        const max = parseFloat(priceEl.dataset.max);
        const oldMin = parseFloat(priceEl.dataset.oldMin);
        const oldMax = parseFloat(priceEl.dataset.oldMax);

        if (min && max) {
            if (min === max) {
                // N·∫øu min v√† max b·∫±ng nhau, ch·ªâ hi·ªÉn th·ªã m·ªôt gi√°
                priceEl.textContent = formatVND(min);
            } else {
                // N·∫øu kh√°c nhau, hi·ªÉn th·ªã kho·∫£ng gi√°
                priceEl.textContent = `${formatVND(min)} - ${formatVND(max)}`;
            }
        }

        if (oldEl && oldMin && oldMax && (oldMin !== min || oldMax !== max)) {
            if (oldMin === oldMax) {
                // N·∫øu gi√° g·ªëc min v√† max b·∫±ng nhau, ch·ªâ hi·ªÉn th·ªã m·ªôt gi√° g·ªëc
                oldEl.textContent = formatVND(oldMin);
                oldEl.style.display = 'inline-block';
            } else {
                // N·∫øu gi√° g·ªëc min v√† max kh√°c nhau, hi·ªÉn th·ªã kho·∫£ng gi√° g·ªëc
                oldEl.textContent = `${formatVND(oldMin)} - ${formatVND(oldMax)}`;
                oldEl.style.display = 'inline-block';
            }
        } else if (oldEl) {
            oldEl.style.display = 'none';
        }
    }
    // Format the old price in the same way as the regular price
    document.querySelectorAll('.formatted-old-price').forEach(el => {
        const raw = el.textContent.trim();
        if (!raw || isNaN(raw)) {
            return;
        }
        const formatted = Number(raw).toLocaleString('vi-VN') + ' VNƒê';
        el.textContent = formatted;
    });

    function updateSendBtn() {
        const hasText = chatInput.value.trim().length > 0;
        sendBtn.style.backgroundColor = hasText ? '#1e4066' : '#9FD5F7';
        sendBtn.disabled = !hasText;
        sendBtn.style.opacity = hasText ? '1' : '.9';
        sendBtn.style.cursor  = hasText ? 'pointer' : 'not-allowed';
    }

    // Toggle chatbot
    const toggleBtn = document.getElementById('chatbot-toggle');
    const chatBox = document.getElementById('chatbot-box');
    const closeBtn = document.getElementById('chatbot-close');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');

    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = chatInput.scrollHeight + 'px';
        updateSendBtn();
    });
    document.addEventListener('DOMContentLoaded', updateSendBtn);

    function openChat(){
        if (!chatBox.classList.contains('is-open')) {
            chatBox.classList.add('is-open');
            restoreHistory();
            ensureGreeting();
            requestAnimationFrame(() => chatInput?.focus());
        }
    }
    function closeChat(){ chatBox.classList.remove('is-open'); }
    function isOpen(){ return chatBox.classList.contains('is-open'); }

    toggleBtn.onclick = (e) => {
        e.stopPropagation();
        isOpen() ? closeChat() : openChat();
    };

    closeBtn.onclick = (e) => {
        e.stopPropagation();
        closeChat();
    };

    /* click ra ngo√†i ƒë·ªÉ ƒë√≥ng */
    document.addEventListener('click', (e) => {
        if (!chatBox.contains(e.target) && !toggleBtn.contains(e.target)) closeChat(); // ‚úÖ
    });


    /* nh·∫•n ESC ƒë·ªÉ ƒë√≥ng */
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isOpen()) closeChat();
    });

    function saveToHistory(role, msg) {
        const current = JSON.parse(sessionStorage.getItem("chat_history") || "[]");
        current.push({ role, msg });
        sessionStorage.setItem("chat_history", JSON.stringify(current));
    }

    function restoreHistory() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '';
        const items = JSON.parse(sessionStorage.getItem("chat_history") || "[]");

        // render l·∫°i l·ªãch s·ª≠
        for (const item of items) {
            const div = document.createElement('div');
            div.className = item.role === 'user' ? 'chatbot-msg-user' : 'chatbot-msg-bot';
            div.innerHTML = item.msg;
            chatMessages.appendChild(div);
        }

        // hi·ªán quick-reply n·∫øu CH∆ØA c√≥ tin nh·∫Øn user n√†o
        const hasUserMsg = items.some(i => i.role === 'user');
        if (hasUserMsg) hideQuickRow(); else showQuickRow();

        const typingIndicator = document.createElement('div');
        typingIndicator.id = 'typing-indicator';
        typingIndicator.className = 'chatbot-msg-bot hidden';
        typingIndicator.textContent = 'ƒêang so·∫°n tin...';
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }


    document.querySelectorAll('.quick-reply').forEach(btn => {
        btn.addEventListener('click', () => {
            chatInput.value = btn.textContent;
            chatInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        });
    });

    chatInput.addEventListener('keydown', async (event) => {
        if (event.key !== 'Enter' || event.repeat) return;

        event.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;
        hideQuickRow();

        const userDiv = document.createElement('div');
        userDiv.className = 'chatbot-msg-user';
        userDiv.textContent = message;
        chatMessages.appendChild(userDiv);
        saveToHistory('user', message);
        chatInput.value = '';

        const typingIndicator = addTypingIndicator();
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
            const response = await fetch('https://lucnguyenthanhoai.app.n8n.cloud/webhook/website-chatbot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ body: { from: 'user_123', message } })
            });

            const data = await response.json();
            console.log('üì• D·ªØ li·ªáu g·ªëc t·ª´ bot:', data);

            const rawMessage = extractMessageFromResponse(data);
            const formattedMsg = formatMessage(rawMessage);

            const botDiv = document.createElement('div');
            botDiv.className = 'chatbot-msg-bot';
            botDiv.innerHTML = formattedMsg;
            chatMessages.appendChild(botDiv);
            saveToHistory('bot', botDiv.innerHTML);
            chatMessages.scrollTop = chatMessages.scrollHeight;

        } catch (error) {
            console.error('üí• L·ªói k·∫øt n·ªëi:', error);
            const botErr = document.createElement('div');
            botErr.className = 'chatbot-msg-bot';
            botErr.textContent = 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.';
            chatMessages.appendChild(botErr);
            saveToHistory('bot', botErr.textContent);
        } finally {
            typingIndicator.classList.add('hidden');
        }
    });

    function addTypingIndicator() {
        const existingIndicator = document.getElementById('typing-indicator');
        if (existingIndicator) existingIndicator.remove();

        const indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'chatbot-msg-bot';
        indicator.textContent = 'ƒêang so·∫°n tin...';
        chatMessages.appendChild(indicator);
        return indicator;
    }

    function extractMessageFromResponse(data) {
        if (typeof data.message !== 'string') {
            if (typeof data.message === 'object' && data.message !== null && 'message' in data.message) {
                console.log('üîç D·ªØ li·ªáu t·ª´ object:', data.message.message);
                return data.message.message;
            }
            console.warn('ü§∑‚Äç‚ôÇÔ∏è Kh√¥ng hi·ªÉu ki·ªÉu d·ªØ li·ªáu message:', data.message);
            return 'Xin l·ªói, bot kh√¥ng ph·∫£n h·ªìi ƒë√∫ng ƒë·ªãnh d·∫°ng.';
        }

        let cleanedMessage = data.message.replace(/```json\n|\n```/g, '').trim();
        console.log('Tr∆∞·ªõc khi l√†m s·∫°ch:', cleanedMessage);

        cleanedMessage = cleanedMessage.replace(/[\u001F\u007F-\u009F]/g, '');
        console.log('Sau khi l√†m s·∫°ch:', cleanedMessage);

        try {
            const parsedData = JSON.parse(cleanedMessage);
            console.log('üß† D·ªØ li·ªáu sau parse:', parsedData.message);
            return parsedData.message || cleanedMessage;
        } catch (parseErr) {
            console.log('‚ùå L·ªói parse JSON:', parseErr);
            // Tr√≠ch xu·∫•t th·ªß c√¥ng n·∫øu parse th·∫•t b·∫°i
            const messageMatch = cleanedMessage.match(/"message":\s*"([^"]*)"/);
            if (messageMatch && messageMatch[1]) {
                console.log('‚úÖ Tr√≠ch xu·∫•t th·ªß c√¥ng th√†nh c√¥ng:', messageMatch[1]);
                return messageMatch[1];
            }
            console.log('‚ö†Ô∏è Kh√¥ng tr√≠ch xu·∫•t ƒë∆∞·ª£c, s·ª≠ d·ª•ng cleanedMessage:', cleanedMessage);
            return cleanedMessage;
        }
    }

    function isImageUrl(url) {
        // Nh·∫≠n di·ªán link ·∫£nh ph·ªï bi·∫øn, cho ph√©p c√≥ query string
        return /\.(png|jpe?g|gif|webp|svg)(\?.*)?$/i.test(url);
    }

    function formatMessage(message) {
        // N·∫øu bot ƒë√£ g·ª≠i s·∫µn th·∫ª <img>, gi·ªØ nguy√™n (tr√°nh replace URL b√™n trong th·∫ª)
        if (/<\s*img\b[^>]*src=/i.test(message)) {
            return message; // ho·∫∑c: return message.replace(/\n/g, '<br>'); n·∫øu mu·ªën √©p xu·ªëng d√≤ng
        }

        // X·ª≠ l√Ω t·∫•t c·∫£ URLs: link ·∫£nh -> <img>, link kh√°c -> <a>
        return message
            .replace(
                /(https?:\/\/[^\s<]+|acvstore\.site\/[^\s<]+)/g,
                (raw) => {
                    const url = raw.startsWith('http') ? raw : 'https://' + raw;
                    if (isImageUrl(url)) {
                        return `<img src="${url}" alt="·∫¢nh" loading="lazy" style="max-width:100%;height:auto;margin-top:8px;" />`;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener" style="color:#153054;text-decoration:underline;">${raw}</a>`;
                }
            )
            .replace(/\n/g, '<br>');
    }

    // Apply formatPrice to both price and old price elements
    window.addEventListener('DOMContentLoaded', function() {
        showPriceRange();
        formatPrice();
    });

    //s·∫Øp x·∫øp size

    document.addEventListener('DOMContentLoaded', () => {
        const order = ["XS", "S", "M", "L", "XL", "XXL", "3XL", "4XL"]; // th·ª© t·ª± chu·∫©n
        const container = document.querySelector('.size-options');
        if (!container) return;

        // L·∫•y t·∫•t c·∫£ button size
        const buttons = Array.from(container.querySelectorAll('.size-option'));

        // S·∫Øp x·∫øp theo th·ª© t·ª± trong m·∫£ng order
        buttons.sort((a, b) => {
            const aIndex = order.indexOf(a.textContent.trim());
            const bIndex = order.indexOf(b.textContent.trim());
            return aIndex - bIndex;
        });

        // Clear container v√† append l·∫°i theo th·ª© t·ª±
        container.innerHTML = '';
        buttons.forEach(btn => container.appendChild(btn));
    });
</script>

<script th:inline="javascript">
    // Update cart count
    async function updateCartCount() {
        try {
            const response = await fetch('/api/cart', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                const cartCount = data.chiTietGioHang ? data.chiTietGioHang.length : 0;
                document.getElementById('cart-count').textContent = cartCount;
            } else if (response.status === 401) {
                // Ch∆∞a ƒëƒÉng nh·∫≠p => ƒë·ªÉ 0, KH√îNG redirect
                document.getElementById('cart-count').textContent = 0;
            }
        } catch (error) {
            console.error('Error updating cart count:', error);
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        updateCartCount();
    });

    // Quantity controls
    const minusBtn = document.querySelector('.quantity-btn.minus');
    const plusBtn = document.querySelector('.quantity-btn.plus');
    const quantityInput = document.querySelector('.quantity-input');

    minusBtn.addEventListener('click', () => {
        if (quantityInput.disabled) return;
        if (quantityInput.value > 1) quantityInput.value--;
    });

    plusBtn.addEventListener('click', () => {
        if (quantityInput.disabled) return;
        if (parseInt(quantityInput.value) < parseInt(quantityInput.max)) quantityInput.value++;
    });

    quantityInput.addEventListener('change', () => {
        if (quantityInput.disabled) return;
        if (quantityInput.value < 1) quantityInput.value = 1;
        if (parseInt(quantityInput.value) > parseInt(quantityInput.max)) quantityInput.value = quantityInput.max;
    });

    // Size and Color selection
    const sizeOptions = document.querySelectorAll('.size-option');
    const colorOptions = document.querySelectorAll('.color-option');

    function checkSelections() {
        const selectedSize = document.querySelector('.size-option.active');
        const selectedColor = document.querySelector('.color-option.active');
        const isEnabled = selectedSize && selectedColor;
        quantityInput.disabled = !isEnabled;
        minusBtn.disabled = !isEnabled;
        plusBtn.disabled = !isEnabled;

        updateStockInfo();
    }

    function updateStockInfo() {
        const selectedSize  = document.querySelector('.size-option.active');
        const selectedColor = document.querySelector('.color-option.active');
        const stockElement  = document.getElementById('dynamic-stock');

        // ==== TH√äM: khi ch∆∞a ch·ªçn -> hi·ªán kho·∫£ng gi√°, ·∫©n old price ====
        if (!selectedSize || !selectedColor) {
            stockElement.textContent = 'Ch·ªçn m√†u & size';
            quantityInput.max = 1;
            showPriceRange(); // <<----
            return;
        }

        const sizeId   = selectedSize.dataset.sizeId;
        const colorId  = selectedColor.dataset.colorId;
        const sanPhamId = document.querySelector('.add-to-cart').dataset.sanPhamId;

        fetch(`/api/getChiTietSanPham?sanPhamId=${sanPhamId}&sizeId=${sizeId}&colorId=${colorId}`)
            .then(res => res.json())
            .then(data => {
                console.log("D·ªØ li·ªáu t·ªìn kho nh·∫≠n v·ªÅ t·ª´ API:", data);

                // t·ªìn kho
                if (typeof data.soLuongTonKho === 'number') {
                    if (data.soLuongTonKho === 0) {
                        stockElement.textContent = "H·∫øt h√†ng";
                        quantityInput.disabled = true;
                        minusBtn.disabled = true;
                        plusBtn.disabled = true;
                    } else {
                        stockElement.textContent = data.soLuongTonKho;
                        quantityInput.max = data.soLuongTonKho;
                        if (parseInt(quantityInput.value) > data.soLuongTonKho) {
                            quantityInput.value = data.soLuongTonKho;
                        }
                        quantityInput.disabled = false;
                        minusBtn.disabled = false;
                        plusBtn.disabled  = false;
                    }
                } else {
                    stockElement.textContent = 'Kh√¥ng kh·∫£ d·ª•ng';
                    quantityInput.max = 1;
                }

                // ==== GI√Å (bi·∫øn th·ªÉ ƒë√£ ch·ªçn) ====
                const priceElement   = document.getElementById('detail-price');
                const oldPriceElement = document.getElementById('detail-old-price');

                if (data.gia && priceElement) {
                    priceElement.textContent = formatVND(data.gia);
                }
                if (oldPriceElement) {
                    if (data.oldPrice && data.oldPrice !== data.gia) {
                        oldPriceElement.textContent = formatVND(data.oldPrice);
                        oldPriceElement.style.display = 'inline-block';
                    } else {
                        oldPriceElement.style.display = 'none';
                    }
                }
            })
            .catch(err => {
                console.error('L·ªói khi g·ªçi API t·ªìn kho:', err);
                stockElement.textContent = 'L·ªói khi t·∫£i t·ªìn kho';
                // fallback: v·∫´n hi·ªán kho·∫£ng gi√° ƒë·ªÉ user kh√¥ng b·ªã "r·ªóng"
                showPriceRange();
            });
    }


    let selectedSizeId = null;
    let selectedColorId = null;

    // Tr·∫£ v·ªÅ danh s√°ch m√†u h·ª£p l·ªá theo size
    function getValidColorsForSize(sizeId) {
        return window.validCombinations
            .filter(c => c.sizeId === sizeId)
            .map(c => c.colorId);
    }

    // Tr·∫£ v·ªÅ danh s√°ch size h·ª£p l·ªá theo m√†u
    function getValidSizesForColor(colorId) {
        return window.validCombinations
            .filter(c => c.colorId === colorId)
            .map(c => c.sizeId);
    }

    sizeOptions.forEach(option => {
        option.addEventListener('click', () => {
            const isActive = option.classList.contains('active');
            sizeOptions.forEach(o => o.classList.remove('active'));

            if (isActive) {
                // Hu·ª∑ ch·ªçn
                selectedSizeId = null;
            } else {
                option.classList.add('active');
                selectedSizeId = option.dataset.sizeId;
            }

            const validColors = getValidColorsForSize(selectedSizeId);

            colorOptions.forEach(color => {
                const id = color.dataset.colorId;

                if (!selectedSizeId) {
                    // N·∫øu hu·ª∑ ch·ªçn size th√¨ enable l·∫°i t·∫•t c·∫£ m√†u
                    color.disabled = false;
                    color.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    const isValid = validColors.includes(id);
                    color.disabled = !isValid;
                    color.classList.toggle('opacity-50', !isValid);
                    color.classList.toggle('cursor-not-allowed', !isValid);

                    if (!isValid && color.classList.contains('active')) {
                        color.classList.remove('active');
                        selectedColorId = null;
                    }
                }
            });

            checkSelections();
        });
    });

    colorOptions.forEach(option => {
        option.addEventListener('click', () => {
            if (option.disabled) return;

            const isActive = option.classList.contains('active');

            // H·ªßy active t·∫•t c·∫£
            colorOptions.forEach(o => o.classList.remove('active'));

            if (isActive) {
                // N·∫øu ƒëang active v√† click l·∫°i => hu·ª∑ ch·ªçn
                selectedColorId = null;
            } else {
                option.classList.add('active');
                selectedColorId = option.dataset.colorId;
            }

            const validSizes = getValidSizesForColor(selectedColorId);
            sizeOptions.forEach(size => {
                const id = size.dataset.sizeId;

                if (!selectedColorId) {
                    // N·∫øu ƒë√£ hu·ª∑ ch·ªçn m√†u => enable l·∫°i t·∫•t c·∫£ size
                    size.disabled = false;
                    size.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    const isValid = validSizes.includes(id);
                    size.disabled = !isValid;
                    size.classList.toggle('opacity-50', !isValid);
                    size.classList.toggle('cursor-not-allowed', !isValid);

                    // N·∫øu size kh√¥ng h·ª£p l·ªá v√† ƒëang active th√¨ hu·ª∑ lu√¥n
                    if (!isValid && size.classList.contains('active')) {
                        size.classList.remove('active');
                        selectedSizeId = null;
                    }
                }
            });

            checkSelections();
        });
    });

    // Thumbnail image click to update main image
    document.querySelectorAll('.thumbnail-img').forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            const mainImage = document.querySelector('.product-img');
            mainImage.src = thumbnail.src;
        });
    });

    // Handle Add to Cart and Buy Now
    function handleProductAction(button, action) {
        const selectedSize = document.querySelector('.size-option.active');
        const selectedColor = document.querySelector('.color-option.active');
        const quantity = parseInt(quantityInput.value);

        if (!selectedSize || !selectedColor) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: 'Vui l√≤ng ch·ªçn k√≠ch c·ª° v√† m√†u s·∫Øc!',
            });
            return;
        }

        if (quantity > parseInt(quantityInput.max)) {
            Swal.fire({
                icon: 'warning',
                title: 'L·ªói',
                text: 'S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho!',
            });
            return;
        }

        try {
            // Get chiTietSanPhamId
            fetch(`/api/getChiTietSanPham?sanPhamId=${button.dataset.sanPhamId}&sizeId=${selectedSize.dataset.sizeId}&colorId=${selectedColor.dataset.colorId}`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (!data.id) {
                        Swal.fire({
                            icon: 'error',
                            title: 'L·ªói',
                            text: data.error || 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin s·∫£n ph·∫©m!',
                        });
                        return;
                    }

                    if (action === 'cart') {
                        // Add to cart
                        const payload = {
                            id: data.id,
                            quantity: quantity
                        };
                        fetch('/api/cart/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                            credentials: 'include'
                        })
                            .then(addResponse => {
                                if (addResponse.ok) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Th√†nh c√¥ng',
                                        text: 'ƒê√£ th√™m v√†o gi·ªè h√†ng!',
                                        showConfirmButton: false,
                                        timer: 1500
                                    });
                                    updateCartCount();
                                } else if (addResponse.status === 401) {
                                    window.location.href = '/customers/login';
                                } else {
                                    addResponse.json().then(errorData => {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'L·ªói',
                                            text: errorData.error || 'C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng!'
                                        });
                                    }).catch(() => {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'L·ªói',
                                            text: 'Kh√¥ng th·ªÉ x·ª≠ l√Ω ph·∫£n h·ªìi m√°y ch·ªß.'
                                        });
                                    });
                                }
                            })
                                .catch(error => {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'L·ªói',
                                    text: 'C√≥ l·ªói x·∫£y ra: ' + error.message,
                                });
                            });
                    } else {
                        // Buy now
                        const orderItem = {
                            chiTietSanPhamId: data.id,
                            tenSanPham: button.dataset.productName,
                            gia: data.gia,
                            soLuong: quantity,
                            urlHinhAnh: button.dataset.productImg,
                            sizeId: selectedSize.dataset.sizeId,
                            colorId: selectedColor.dataset.colorId,
                            sizeName: selectedSize.textContent,
                            colorName: selectedColor.textContent
                        };
                        localStorage.setItem('checkoutItem', JSON.stringify(orderItem));
                        window.location.href = '/thanh-toan';
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói',
                        text: 'C√≥ l·ªói x·∫£y ra: ' + error.message,
                    });
                });
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: 'C√≥ l·ªói x·∫£y ra: ' + error.message,
            });
        }
    }

    // Add to cart button
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', () => handleProductAction(button, 'cart'));
    });

    // Buy now button
    document.querySelectorAll('.buy-now').forEach(button => {
        button.addEventListener('click', () => handleProductAction(button, 'buy'));
    });

    document.addEventListener("DOMContentLoaded", function() {
        const sanPhamId = /*[[${productDetail.sanPhamId}]]*/ '';

        fetch(`/api/product/${sanPhamId}/ratings`, { credentials: 'include' })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                const list = document.getElementById("ratings-list");
                const avgRating = document.getElementById("avg-rating");
                const totalReviews = document.getElementById("total-reviews");

                const allReviews = [...(data.myReviews || []), ...(data.otherReviews || [])];
                if (allReviews.length === 0) {
                    list.innerHTML = "<p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho s·∫£n ph·∫©m n√†y.</p>";
                    avgRating.textContent = "0";
                    totalReviews.textContent = "0";
                    return;
                }

                const avg = allReviews.reduce((sum, r) => sum + r.rating, 0) / allReviews.length || 0;
                avgRating.textContent = avg.toFixed(1);
                totalReviews.textContent = allReviews.length;

                list.innerHTML = "";

                // Hi·ªÉn th·ªã ƒë√°nh gi√° c·ªßa b·∫°n
                if (data.myReviews && data.myReviews.length > 0) {
                    list.innerHTML += `<h3 class="font-bold text-lg text-[#153054]">ƒê√°nh gi√° c·ªßa b·∫°n</h3>`;
                    data.myReviews.forEach(r => {
                        list.innerHTML += renderReview(r, true);
                    });
                    list.innerHTML += `<hr class="my-4"/>`;
                }

                // Hi·ªÉn th·ªã ƒë√°nh gi√° c·ªßa ng∆∞·ªùi kh√°c
                if (data.otherReviews && data.otherReviews.length > 0) {
                    list.innerHTML += `<h3 class="font-bold text-lg">ƒê√°nh gi√° t·ª´ kh√°ch h√†ng kh√°c</h3>`;
                    data.otherReviews.forEach(r => {
                        list.innerHTML += renderReview(r, false);
                    });
                }
            })
            .catch(err => {
                console.error("L·ªói khi t·∫£i ƒë√°nh gi√°:", err);
                const list = document.getElementById("ratings-list");
                list.innerHTML = "<p>L·ªói khi t·∫£i ƒë√°nh gi√°. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
            });

        function renderReview(r, isMine) {
            const stars = "‚òÖ".repeat(r.rating) + "‚òÜ".repeat(5 - r.rating);
            const mediaHtml = r.media
                ? r.media.split(",").map(url => `<img src="${url}" class="w-20 h-20 object-cover rounded"/>`).join("")
                : "";
            return `
                <div class="p-4 bg-white rounded-lg shadow ${isMine ? 'border border-[#153054]' : ''}">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold">${r.user} ${isMine ? '(B·∫°n)' : ''}</span>
                        <span class="text-yellow-500">${stars}</span>
                    </div>
                    <p class="text-gray-600 mt-1">${r.content || ""}</p>
                    <div class="flex gap-2 mt-2">${mediaHtml}</div>
                    <small class="text-gray-400">${new Date(r.date).toLocaleDateString()}</small>
                </div>
            `;
        }
    });

</script>
</body>
</html>