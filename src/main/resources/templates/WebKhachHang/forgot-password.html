<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quên mật khẩu - ACV Store</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="/image/ACV.png" type="image/png" sizes="32x32"/>
    <style>
        :root { --primary-color:#153054; --secondary-color:#9FD5F7; --accent-color:#666; --light-gray:#f8f9fa; --medium-gray:#e9ecef; --dark-gray:#495057; --white:#fff; --shadow-light:0 4px 20px rgba(0,0,0,.1); --shadow-medium:0 8px 30px rgba(0,0,0,.15); --shadow-heavy:0 15px 40px rgba(0,0,0,.2); }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;min-height:100vh;background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 50%,#dee2e6 100%);position:relative;overflow-x:hidden}
        body::before{content:'';position:absolute;inset:0;background-image:linear-gradient(45deg,transparent 40%,rgba(0,0,0,.02) 50%,transparent 60%),linear-gradient(-45deg,transparent 40%,rgba(0,0,0,.02) 50%,transparent 60%);background-size:60px 60px;animation:patternMove 20s linear infinite}
        @keyframes patternMove{0%{background-position:0 0,0 0}100%{background-position:60px 60px,-60px 60px}}
        body::after{content:'';position:absolute;top:10%;left:10%;width:100px;height:100px;border:2px solid rgba(0,0,0,.05);border-radius:50%;animation:float1 15s ease-in-out infinite}
        @keyframes float1{0%,100%{transform:translate(0,0) rotate(0)}33%{transform:translate(30px,-30px) rotate(120deg)}66%{transform:translate(-20px,20px) rotate(240deg)}}
        .container-fluid{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:10px;position:relative;z-index:1}
        .forgot-container{max-width:450px;width:100%;position:relative}
        .forgot-container::before{content:'';position:absolute;top:-50px;right:-50px;width:80px;height:80px;border:1px solid rgba(0,0,0,.1);transform:rotate(45deg);animation:float2 12s ease-in-out infinite}
        .forgot-container::after{content:'';position:absolute;bottom:-30px;left:-30px;width:60px;height:60px;background:rgba(0,0,0,.03);border-radius:50%;animation:float3 18s ease-in-out infinite}
        @keyframes float2{0%,100%{transform:rotate(45deg) translate(0,0)}50%{transform:rotate(225deg) translate(20px,-20px)}}
        @keyframes float3{0%,100%{transform:scale(1) translate(0,0)}50%{transform:scale(1.2) translate(-10px,10px)}}
        .forgot-card{background:var(--white);border:1px solid var(--medium-gray);border-radius:16px;padding:30px 25px;box-shadow:var(--shadow-medium);transition:all .4s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
        .forgot-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));border-radius:16px 16px 0 0}
        .forgot-card:hover{transform:translateY(-8px);box-shadow:var(--shadow-heavy)}
        .brand-section{text-align:center;margin-bottom:20px}
        .brand-logo{width:60px;height:60px;margin:0 auto 10px;display:block;border-radius:12px;box-shadow:var(--shadow-light);transition:transform .3s ease}
        .brand-logo:hover{transform:scale(1.05)}
        .welcome-title{font-size:24px;font-weight:800;color:var(--primary-color);margin-bottom:4px;letter-spacing:-.5px}
        .welcome-subtitle{color:var(--dark-gray);font-size:14px;font-weight:500}
        .form-floating{margin-bottom:16px;position:relative}
        .form-floating .form-control{height:50px;border:2px solid var(--medium-gray);border-radius:10px;font-size:14px;font-weight:500;padding-left:45px;transition:all .3s ease;background:var(--white);color:var(--primary-color)}
        .form-floating .form-control:focus{border-color:var(--primary-color);box-shadow:0 0 0 4px rgba(0,0,0,.1);background:var(--white)}
        .form-floating label{padding-left:45px;color:var(--dark-gray);font-weight:500;font-size:14px}
        .input-icon{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:var(--accent-color);font-size:16px;z-index:5;transition:color .3s ease}
        .form-floating .form-control:focus + label + .input-icon{color:var(--primary-color)}
        .btn-submit{width:100%;height:48px;background:var(--primary-color);border:none;border-radius:10px;color:var(--white);font-size:16px;font-weight:600;letter-spacing:.5px;transition:all .3s ease;position:relative;overflow:hidden;margin-bottom:16px}
        .btn-submit::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}
        .btn-submit:hover::before{left:100%}
        .btn-submit:hover{background:var(--secondary-color);transform:translateY(-2px);box-shadow:var(--shadow-medium)}
        .btn-submit:active{transform:translateY(0)}
        .alert{border:none;border-radius:10px;padding:12px 15px;font-weight:500;margin-bottom:16px;position:relative;overflow:hidden}
        .alert-danger{background:#f8f9fa;color:#dc3545;border:1px solid #f5c6cb;border-left:4px solid #dc3545}
        .footer-links{text-align:center;margin-top:20px;padding-top:16px;border-top:1px solid var(--medium-gray)}
        .footer-links a{color:var(--primary-color);text-decoration:none;font-weight:600;font-size:13px;transition:all .3s ease;position:relative}
        .footer-links a::after{content:'';position:absolute;width:0;height:2px;bottom:-2px;left:50%;background:var(--primary-color);transition:all .3s ease;transform:translateX(-50%)}
        .footer-links a:hover::after{width:100%}
        .footer-links a:hover{color:var(--secondary-color)}
        .btn-loading{pointer-events:none;opacity:.8}
        .spinner{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;margin-right:6px}
        @keyframes spin{to{transform:rotate(360deg)}}
        @media (max-width:576px){.forgot-card{padding:25px 20px;margin:5px}.welcome-title{font-size:20px}.brand-logo{width:50px;height:50px}}
        .form-control:focus{outline:none}
        .btn:focus{outline:2px solid var(--primary-color);outline-offset:2px}
        .was-validated .form-control:invalid{border-color:#dc3545;animation:shake .5s ease-in-out}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="forgot-container">
        <div class="forgot-card">
            <div class="brand-section">
                <img src="/image/acv-logo2.png" alt="Company Logo" class="brand-logo">
                <h1 class="welcome-title">Quên mật khẩu</h1>
                <p class="welcome-subtitle">Nhập email để nhận mã OTP khôi phục mật khẩu</p>
            </div>

            <form id="forgotForm" th:action="@{/customers/auth/forgot-password}" method="post" novalidate>
                <!-- CSRF (nếu bạn bật Spring Security CSRF) -->
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

                <div class="form-floating">
                    <input type="email"
                           class="form-control"
                           id="email"
                           name="email"
                           placeholder="Email"
                           th:value="${email}">
                    <label for="email">Email</label>
                    <i class="fas fa-envelope input-icon"></i>
                    <!-- thông điệp lỗi hiển thị CHỈ SAU KHI SUBMIT -->
                    <div id="emailInvalid" class="invalid-feedback">Vui lòng nhập email hợp lệ (vd: ten@domain.com).</div>
                </div>

                <div th:if="${error}" class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span th:text="${error}"></span>
                </div>

                <button id="submitBtn" type="submit" class="btn btn-submit">
                    <span class="btn-text">Gửi mã OTP</span>
                </button>

                <div class="footer-links">
                    <a href="/customers/login"><i class="fas fa-arrow-left me-1"></i>Quay lại đăng nhập</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const EMAIL_REGEX = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;

    const form = document.getElementById('forgotForm');
    const emailInput = document.getElementById('email');
    const emailInvalid = document.getElementById('emailInvalid');
    const submitBtn = document.getElementById('submitBtn');

    function setButtonChecking() {
        submitBtn.disabled = true;
        submitBtn.classList.add('btn-loading');
        submitBtn.innerHTML = '<span class="spinner"></span>Đang kiểm tra...';
    }

    function setButtonSending() {
        submitBtn.disabled = true;
        submitBtn.classList.add('btn-loading');
        submitBtn.innerHTML = '<span class="spinner"></span>Đang gửi...';
    }

    function resetButton() {
        submitBtn.disabled = false;
        submitBtn.classList.remove('btn-loading');
        submitBtn.innerHTML = '<span class="btn-text">Gửi mã OTP</span>';
    }

    function showEmailError(msg) {
        emailInvalid.textContent = msg || 'Vui lòng nhập email hợp lệ.';
        emailInput.classList.add('is-invalid');
    }

    function clearEmailError() {
        emailInput.classList.remove('is-invalid');
        // giữ nguyên nội dung default, chỉ ẩn khi không có class is-invalid
    }

    // Xoá trạng thái lỗi khi người dùng sửa lại (KHÔNG hiện lỗi realtime)
    emailInput.addEventListener('input', () => {
        if (emailInput.classList.contains('is-invalid')) {
            clearEmailError();
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // chặn submit mặc định để kiểm tra 1 lần tại thời điểm bấm nút

        clearEmailError();

        const value = (emailInput.value || '').trim().toLowerCase();

        // 1) Rỗng -> báo lỗi tại input
        if (!value) {
            showEmailError('Vui lòng nhập email.');
            return;
        }

        // 2) Sai định dạng -> báo lỗi tại input
        if (!EMAIL_REGEX.test(value)) {
            showEmailError('Email không đúng định dạng (vd: ten@domain.com).');
            return;
        }

        // 3) Kiểm tra tồn tại qua API (chỉ khi bấm submit)
        try {
            setButtonChecking();
            const res = await fetch(`/customers/auth/check-email?email=${encodeURIComponent(value)}`, { method: 'GET' });
            const data = await res.json();

            if (!data.validFormat) {
                resetButton();
                showEmailError('Email không đúng định dạng.');
                return;
            }

            if (!data.exists) {
                resetButton();
                showEmailError('Email này chưa được đăng ký trong hệ thống.');
                return;
            }

            // 4) OK -> submit form thật
            setButtonSending();
            form.submit();

        } catch (err) {
            // Nếu lỗi mạng/API, cho submit để server kiểm tra lần nữa
            setButtonSending();
            form.submit();
        }
    });

    // Ẩn alert server sau 5s
    document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                alert.style.opacity = '0';
                alert.style.transform = 'translateY(-20px)';
                setTimeout(function() { alert.style.display = 'none'; }, 300);
            }, 5000);
        });
    });
</script>
</body>
</html>
