<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACV Store - S·∫£n ph·∫©m m·ªõi</title>

  <!-- Libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Styles gi·ªØ nguy√™n tone m√†u + c·∫£i ti·∫øn -->
  <style>
    .navbar { background: linear-gradient(to right, #153054, #1e4066); position: fixed; top: 40px; left: 0; width: 100%; z-index: 1040; }
    .ticker { background-color: #9FD5F7; color: #153054; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 1050; height: 40px; }
    body { padding-top: 118px; }
    .product-card { transition: transform .3s, box-shadow .3s; }
    .product-card:hover { transform: translateY(-10px); box-shadow: 0 8px 24px rgba(0,0,0,.15); }

    /* Size chip */
    .size-option{ padding:8px 16px; border:2px solid #ccc; border-radius:8px; cursor:pointer; transition:.3s; }
    .size-option.active{ background:#153054; color:#fff; border-color:#153054; }

    /* Swatch tr√≤n khi c√≥ m√£ m√†u */
    .color-option[data-swatch="true"]{ width:30px; height:30px; border-radius:50%; border:2px solid #ccc; padding:0; cursor:pointer; transition:.3s; }
    .color-option[data-swatch="true"].active{ border-color:#153054; }

    /* M√†u d·∫°ng ch·ªØ n·∫øu kh√¥ng c√≥ m√£ m√†u */
    .color-option:not([data-swatch="true"]){ padding:8px 16px; border:2px solid #ccc; border-radius:8px; cursor:pointer; transition:.3s; }
    .color-option:not([data-swatch="true"]).active{ background:#153054; color:#fff; border-color:#153054; }

    /* Spinner cho n√∫t th√™m gi·ªè */
    #confirmAddToCart.loading::after{
      content:''; display:inline-block; width:16px; height:16px; margin-left:8px;
      border:2px solid #fff; border-top-color:transparent; border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Chatbot */
    #chatbot-box{ position:fixed; bottom:100px; right:30px; width:420px; height: clamp(520px, 70vh, 640px);
      background:#fff; border-radius:14px; box-shadow:0 12px 32px rgba(0,0,0,.18); overflow:hidden; z-index:10000;
      opacity:0; transform: translateY(12px) scale(.98); pointer-events:none; visibility:hidden; transform-origin:bottom right;
      transition: opacity .25s ease, transform .25s ease, visibility .25s; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    #chatbot-box.is-open{ opacity:1; transform: translateY(0) scale(1); pointer-events:auto; visibility:visible; }
    .cb-header{ background:#153054; color:#fff; padding:10px 12px; display:flex; align-items:center; gap:10px; }
    .brand-logo{ width:45px;height:45px;border-radius:30px; object-fit:cover; }
    .cb-actions{ margin-left:auto; display:flex; gap:8px; }
    .cb-icon{ width:32px;height:32px;border-radius:8px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.08); color:#fff; border:0; cursor:pointer; }
    #chat-messages{ padding:12px 12px 6px; height:420px; overflow-y:auto; background:#fff; }
    .chatbot-msg-bot{ position:relative; background:#f3f4f6; color:#111827; padding:10px 12px; border-radius:14px 14px 14px 4px; max-width:82%; margin:0 56px 10px 40px; font-size:15px; line-height:1.45; }
    .chatbot-msg-bot::before{ content:""; position:absolute; left:-40px; top:4px; width:36px; height:36px; border-radius:50%; background-image:url('/image/ACV.jpg'); background-size:cover; background-position:center; }
    .chatbot-msg-user{ background:#153054; color:#fff; padding:10px 12px; border-radius:14px 14px 4px 14px; max-width:82%; margin:0 0 10px auto; font-size:15px; line-height:1.45;}
    .cb-quick{ padding:6px 12px 10px; display:flex; flex-wrap:wrap; gap:8px; background:#fff; }
    .cb-pill{ border:1px solid #e5e7eb; background:#fff; color:#111827; padding:8px 12px; border-radius:18px; font-size:14px; cursor:pointer; }
    .cb-inputbar{ border-top:1px solid #eee; padding:10px; display:flex; gap:8px; align-items:center; background:#fff; }
    #chat-input{ flex:1; padding:12px 14px; border:1px solid #e5e7eb; border-radius:24px; font-size:15px; outline:none; resize:none; overflow-y:hidden; line-height:1.4; max-height:120px; }
    #chat-send{ width:44px;height:44px;border-radius:50%;border:0;background:#153054;color:#fff;display:flex;align-items:center;justify-content:center; }
    .cb-note{ padding:6px 14px 12px; font-size:10px; text-align:center; color:#6b7280; background:#fff;}
    #back-to-top{ transition:opacity .3s; } #back-to-top.hidden{ opacity:0; pointer-events:none; }
    @media (max-width:640px){ #chatbot-box{ width:92vw; right:4vw; bottom:90px; height:70vh; } }
  </style>
</head>
<body class="bg-gray-100">

<!-- Ticker -->
<div class="ticker py-1 overflow-hidden">
  <marquee behavior="scroll" direction="left" scrollamount="5">
    üéâ Khuy·∫øn m√£i ƒë·∫∑c bi·ªát: Gi·∫£m gi√° l√™n ƒë·∫øn 50% cho t·∫•t c·∫£ s·∫£n ph·∫©m h√¥m nay! üéâ - Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n t·ª´ 500k!
  </marquee>
</div>

<!-- Navbar -->
<div th:replace="~{fragments/kh_navbar :: navbar(user=${user}, keyword=${keyword}, cartCount=${cartCount})}"></div>

<!-- Modal th√™m gi·ªè -->
<div class="modal fade" id="addToCartModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-lg">
    <div class="modal-header" style="background:#153054;color:#fff">
      <h5 class="modal-title">Th√™m v√†o gi·ªè h√†ng</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body p-4">
      <div class="flex items-center space-x-4">
        <img id="modalProductImage" src="" class="w-20 h-20 object-cover rounded" alt="">
        <div>
          <h6 id="modalProductName" class="font-semibold"></h6>
          <p id="modalProductPrice" class="text-blue-800 font-bold"></p>
          <p id="modalProductStock" class="text-sm text-gray-600"></p>
        </div>
      </div>
      <div class="mt-4">
        <h6 class="font-semibold">Ch·ªçn size:</h6>
        <div class="flex gap-2 mt-2" id="modalSizeOptions"></div>
      </div>
      <div class="mt-4">
        <h6 class="font-semibold">Ch·ªçn m√†u s·∫Øc:</h6>
        <div class="flex gap-2 mt-2 items-center" id="modalColorOptions"></div>
      </div>
      <div class="mt-4">
        <h6 class="font-semibold">S·ªë l∆∞·ª£ng:</h6>
        <div class="flex items-center gap-2 mt-2">
          <button class="quantity-btn minus px-3 py-1 bg-gray-200 rounded">-</button>
          <input type="number" value="1" min="1" class="quantity-input w-16 text-center border rounded">
          <button class="quantity-btn plus px-3 py-1 bg-gray-200 rounded">+</button>
        </div>
      </div>
      <div id="modalError" class="text-red-500 text-sm mt-2 hidden">Vui l√≤ng ch·ªçn k√≠ch th∆∞·ªõc v√† m√†u s·∫Øc!</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      <button id="confirmAddToCart" class="btn text-white" style="background:#153054">Th√™m v√†o gi·ªè</button>
    </div>
  </div></div>
</div>

<!-- CONTENT -->
<div class="container mx-auto py-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-2">S·∫£n ph·∫©m m·ªõi</h1>
  <p class="text-gray-600 mb-6" th:text="'T·ªïng s·ªë: ' + ${products != null ? products.size() : 0} + ' s·∫£n ph·∫©m'">T·ªïng s·ªë: 0 s·∫£n ph·∫©m</p>

  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
    <div class="product-card bg-white rounded-lg shadow-md overflow-hidden" th:each="product : ${products}">
      <div class="relative">
        <a th:href="@{/chitietsanpham(id=${product.id})}">
          <img th:src="${product.urlHinhAnh}" th:alt="${product.tenSanPham}" class="w-full h-48 object-cover" loading="lazy"/>
        </a>
        <span class="absolute top-2 left-2 bg-emerald-600 text-white text-xs font-semibold px-2 py-1 rounded shadow">M·ªõi</span>

        <!-- D·ªØ li·ªáu JSON an to√†n -->
        <button class="cart-icon absolute top-2 right-2 bg-white p-2 rounded-full shadow hover:bg-blue-100"
                th:attr="
          data-product-id=${product.id},
          data-product-name=${product.tenSanPham},
          data-product-price=${product.price},
          data-product-img=${product.urlHinhAnh},
          data-kich-co=${@jacksonObjectMapper.writeValueAsString(product.kichCoList)},
          data-mau-sac=${@jacksonObjectMapper.writeValueAsString(product.mauSacList)},
          data-stock=${product.tongSoLuong}">
          <i class="fas fa-shopping-cart text-blue-800"></i>
        </button>

        <button class="quick-view-btn absolute top-10 right-2 bg-white p-2 rounded-full shadow hover:bg-blue-100"
                th:attr="data-product-id=${product.id}">
          <i class="fas fa-eye text-blue-800"></i>
        </button>
      </div>

      <a th:href="@{/chitietsanpham(id=${product.id})}" class="block p-4">
        <h4 th:text="${product.tenSanPham}" class="text-sm font-semibold text-gray-800 truncate"></h4>
        <div class="price text-blue-800 font-bold mt-2" th:attr="data-price=${product.price}">
          <span th:text="${product.price}"></span> VNƒê
        </div>
        <div th:if="${product.oldPrice != null and product.discount != '0%'}" class="text-sm text-red-600 line-through">
          <span class="formatted-old-price" th:text="${product.oldPrice}">Gi√° g·ªëc</span>
        </div>
        <div class="rating text-yellow-400 text-sm mt-1" th:attr="data-product-id=${product.id}">
          <span class="stars"></span>
          <span class="avg-rating">0</span> (<span class="total-reviews">0</span> ƒë√°nh gi√°)
        </div>
      </a>
    </div>
  </div>
</div>

<!-- Floating Chatbot Icon -->
<div id="chatbot-toggle" style="position:fixed;bottom:20px;right:20px;background:#9FD5F7;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:10000;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.2);">
  <img th:src="@{/image/ACV.jpg}" alt="ACV" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
</div>

<!-- Chatbot Box -->
<div id="chatbot-box">
  <div class="cb-header">
    <span class="brand">
      <img th:src="@{/image/ACV.jpg}" alt="ACV" class="brand-logo"/>
      ACV Store
    </span>
    <div class="cb-actions">
      <button id="chat-reload" class="cb-icon" title="Xo√° l·ªãch s·ª≠ chat"><i class="fas fa-rotate-right"></i></button>
      <button id="chatbot-close" class="cb-icon" title="ƒê√≥ng"><i class="fas fa-minus"></i></button>
    </div>
  </div>

  <div id="chat-messages"></div>

  <div id="quick-row" class="cb-quick" style="display:none">
    <button class="cb-pill quick-reply">S·∫£n ph·∫©m m·ªõi nh·∫•t</button>
    <button class="cb-pill quick-reply">Th√¥ng tin li√™n h·ªá</button>
    <button class="cb-pill quick-reply">ƒê·ªãa ch·ªâ c·ª≠a h√†ng</button>
  </div>

  <div class="cb-inputbar">
    <div class="qr-wrap">
      <button id="qr-trigger" class="qr-btn" aria-haspopup="true" aria-expanded="false" title="Quick reply"><i class="fas fa-bars"></i></button>
      <div id="qr-menu" class="qr-menu" role="menu" aria-hidden="true">
        <button class="qr-item quick-reply" role="menuitem">S·∫£n ph·∫©m m·ªõi nh·∫•t</button>
        <button class="qr-item quick-reply" role="menuitem">Th√¥ng tin li√™n h·ªá</button>
        <button class="qr-item quick-reply" role="menuitem">ƒê·ªãa ch·ªâ c·ª≠a h√†ng</button>
      </div>
    </div>
    <textarea id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1"></textarea>
    <button id="chat-send" aria-label="G·ª≠i" title="G·ª≠i (Enter)"><i class="fas fa-paper-plane"></i></button>
  </div>

  <div class="cb-note">Th√¥ng tin ch·ªâ mang t√≠nh tham kh·∫£o, ƒë∆∞·ª£c t∆∞ v·∫•n b·ªüi Tr·ª£ l√Ω Tr√≠ tu·ªá Nh√¢n T·∫°o.</div>
</div>

<!-- Footer -->
<footer style="background:linear-gradient(to right,#153054,#1e4066); color:#fff; padding-top:30px; padding-bottom:20px; position:relative; z-index:1;">
  <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
    <div>
      <h3 class="text-lg font-bold mb-4">ACV Store</h3>
      <p class="text-sm">C·ª≠a h√†ng th·ªùi trang h√†ng ƒë·∫ßu v·ªõi c√°c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng v√† gi√° c·∫£ h·ª£p l√Ω.</p>
    </div>
    <div>
      <h3 class="text-lg font-bold mb-4">Li√™n k·∫øt nhanh</h3>
      <ul class="space-y-2">
        <li><a href="/new" class="hover:text-blue-300">S·∫£n ph·∫©m m·ªõi</a></li>
        <li><a href="/all" class="hover:text-blue-300">T·∫•t c·∫£ s·∫£n ph·∫©m</a></li>
        <li><a href="/bestsellers" class="hover:text-blue-300">S·∫£n ph·∫©m b√°n ch·∫°y</a></li>
      </ul>
    </div>
    <div>
      <h3 class="text-lg font-bold mb-4">Li√™n h·ªá</h3>
      <p class="text-sm">ƒê·ªãa ch·ªâ: Chung C∆∞ Le Capitole, H√† N·ªôi, Vi·ªát Nam</p>
      <p class="text-sm">Email: datn.acv@gmail.com</p>
      <p class="text-sm">Hotline: 0911 006 045</p>
      <div class="flex space-x-4 mt-4">
        <a href="https://www.facebook.com" class="text-white hover:text-blue-300" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="https://www.instagram.com" class="text-white hover:text-blue-300" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="https://twitter.com" class="text-white hover:text-blue-300" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
      </div>
    </div>
  </div>
  <div class="container mx-auto mt-8">
    <div class="map-container relative overflow-hidden rounded-lg shadow-md">
      <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3724.646955515961!2d105.81876547508028!3d21.00678448063709!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3135ad4154d7e2e9%3A0x4ac6110617de42bc!2sChung%20C%C6%B0%20Le%20Capitole!5e0!3m2!1sen!2s!4v1754127537191!5m2!1sen!2s" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
    </div>
    <p class="text-center text-sm mt-2 text-gray-300">* B·∫£n ƒë·ªì hi·ªÉn th·ªã v·ªã tr√≠ chi nh√°nh ch√≠nh t·∫°i Chung C∆∞ Le Capitole, H√† N·ªôi. Vui l√≤ng li√™n h·ªá ƒë·ªÉ x√°c nh·∫≠n gi·ªù m·ªü c·ª≠a.</p>
  </div>
  <div class="text-center mt-8 text-sm">¬© 2025 ACV Store. All rights reserved.</div>
</footer>

<button id="back-to-top" class="fixed bottom-20 right-20 bg-blue-600 text-white p-3 rounded-full shadow-lg hidden" aria-label="Quay l·∫°i ƒë·∫ßu trang">
  <i class="fas fa-arrow-up"></i>
</button>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script src="/js/navbar.js"></script>

<script>
  // ===== Quick reply combobox
  const qrTrigger = document.getElementById('qr-trigger');
  const qrMenu    = document.getElementById('qr-menu');
  qrTrigger?.addEventListener('click', (e)=>{ e.stopPropagation(); const open=qrMenu.classList.toggle('show'); qrTrigger.setAttribute('aria-expanded', open?'true':'false'); qrMenu.setAttribute('aria-hidden', open?'false':'true'); });
  document.addEventListener('click',(e)=>{ if(!qrMenu) return; if(!qrMenu.contains(e.target)&&!qrTrigger.contains(e.target)){ qrMenu.classList.remove('show'); qrTrigger.setAttribute('aria-expanded','false'); qrMenu.setAttribute('aria-hidden','true'); }});

  // ===== Format gi√°
  document.querySelectorAll('.price').forEach(el=>{
    const raw = el.getAttribute('data-price');
    if (!raw || isNaN(raw)) { el.textContent = 'Li√™n h·ªá'; return; }
    el.textContent = 'T·ª´ ' + Number(raw).toLocaleString('vi-VN') + ' VNƒê';
  });
  document.querySelectorAll('.formatted-old-price').forEach(el=>{
    const raw = el.textContent.trim(); if(!raw || isNaN(raw)) return;
    el.textContent = Number(raw).toLocaleString('vi-VN') + ' VNƒê';
  });

  // ===== Back to top
  const backToTop=document.getElementById('back-to-top');
  window.addEventListener('scroll',()=>{ backToTop.classList.toggle('hidden', window.scrollY<200); });
  backToTop.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));

  // ===== Rating
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.rating').forEach(container=>{
      const sanPhamId = container.dataset.productId; if(!sanPhamId) return;
      fetch(`/api/product/${sanPhamId}/ratings`, { credentials:'include' })
              .then(res=>res.ok?res.json():Promise.reject(res.status))
              .then(data=>{
                const starsContainer=container.querySelector('.stars');
                const avgEl=container.querySelector('.avg-rating'); const totalEl=container.querySelector('.total-reviews');
                const all=[...(data.myReviews||[]), ...(data.otherReviews||[])];
                if(all.length===0){ starsContainer.innerHTML='Ch∆∞a c√≥ ƒë√°nh gi√°'; avgEl.textContent='0'; totalEl.textContent='0'; return; }
                const avg = all.reduce((s,r)=>s+r.rating,0)/all.length; const r = Math.round(avg*2)/2;
                avgEl.textContent=r.toFixed(1); totalEl.textContent=all.length;
                let html=''; const full=Math.floor(r); const half=r%1>=0.5;
                for(let i=0;i<full;i++) html+='<i class="fas fa-star text-yellow-400"></i>';
                if(half&&full<5) html+='<i class="fas fa-star-half-alt text-yellow-400"></i>';
                for(let i=0;i<5-full-(half?1:0);i++) html+='<i class="far fa-star text-yellow-400"></i>';
                starsContainer.innerHTML = html;
              })
              .catch(()=>{ container.innerHTML='<span class="text-gray-600">L·ªói t·∫£i ƒë√°nh gi√°</span>'; });
    });
  });

  // ===== Helpers
  function safeJSONParse(val, fallback = []) {
    if (val == null || val === '' || val === 'undefined' || val === 'null') return fallback;
    try { return JSON.parse(val); } catch {}
    try { const t = document.createElement('textarea'); t.innerHTML = val; return JSON.parse(t.value); } catch { return fallback; }
  }
  const isCssColor = (str)=> /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(str) || /^rgb(a?)\(/i.test(str) || /^[a-z]+$/i.test(str);
  const showSuccess = (text) => window.Swal ? Swal.fire({ icon:'success', title:'Th√†nh c√¥ng', text, timer:1500, showConfirmButton:false }) : alert(text);
  const showError   = (text) => window.Swal ? Swal.fire({ icon:'error', title:'L·ªói', text }) : alert('L·ªói: ' + text);

  // ===== Cart + bi·∫øn th·ªÉ (ƒë·ªìng b·ªô v·ªõi c√°c trang kh√°c)
  document.querySelectorAll('.cart-icon').forEach(button=>{
    button.addEventListener('click', async ()=>{
      const modalEl = document.getElementById('addToCartModal');
      const modal   = new bootstrap.Modal(modalEl);

      // Info c∆° b·∫£n
      modalEl.querySelector('#modalProductImage').src = button.dataset.productImg || '';
      modalEl.querySelector('#modalProductName').textContent = button.dataset.productName || 'S·∫£n ph·∫©m';
      modalEl.querySelector('#modalProductPrice').innerHTML =
              'T·ª´ ' + Number(button.dataset.productPrice || 0).toLocaleString('vi-VN') + ' VNƒê';
      modalEl.querySelector('#modalProductStock').textContent =
              `T·ªìn kho: ${button.dataset.stock ?? 'N/A'}`;

      const productId = button.dataset.productId;

      // L·∫•y options t·ª´ data-* ho·∫∑c API d·ª± ph√≤ng
      let sizes  = safeJSONParse(button.dataset.kichCo);
      let colors = safeJSONParse(button.dataset.mauSac);
      if (!Array.isArray(sizes) || !sizes.length || !Array.isArray(colors) || !colors.length) {
        try {
          const resp = await fetch(`/api/product/${encodeURIComponent(productId)}/options`, { headers:{Accept:'application/json'} });
          if (resp.ok) {
            const opts = await resp.json();
            sizes  = Array.isArray(opts.sizes)  ? opts.sizes  : [];
            colors = Array.isArray(opts.colors) ? opts.colors : [];
          }
        } catch(e){ console.error('Kh√¥ng t·∫£i ƒë∆∞·ª£c options:', e); }
      }

      // Render options
      const sizeWrap  = modalEl.querySelector('#modalSizeOptions');
      const colorWrap = modalEl.querySelector('#modalColorOptions');
      const stockEl   = modalEl.querySelector('#modalProductStock');
      const priceEl   = modalEl.querySelector('#modalProductPrice');
      const errEl     = modalEl.querySelector('#modalError');

      sizeWrap.innerHTML=''; (sizes||[]).forEach(s=>{
        const b=document.createElement('button');
        b.className='size-option';
        b.textContent=s.ten ?? s.name ?? 'Size';
        b.dataset.sizeId=s.id; sizeWrap.appendChild(b);
      });

      colorWrap.innerHTML=''; (colors||[]).forEach(c=>{
        const b=document.createElement('button'); b.className='color-option';
        const css=(c.maMauHex||'').toString().trim();
        if(css && isCssColor(css)){ b.dataset.swatch='true'; b.style.backgroundColor=css; b.title=c.tenMau||''; }
        else{ b.textContent=c.tenMau || 'M√†u'; }
        b.dataset.colorId=c.id; colorWrap.appendChild(b);
      });

      // Qty
      const minusBtn = modalEl.querySelector('.quantity-btn.minus');
      const plusBtn  = modalEl.querySelector('.quantity-btn.plus');
      const qtyInput = modalEl.querySelector('.quantity-input');
      minusBtn.onclick=()=>{ qtyInput.value=Math.max(1,(parseInt(qtyInput.value)||1)-1); };
      plusBtn.onclick =()=>{
        const max = parseInt(qtyInput.max || '999999', 10);
        qtyInput.value = Math.min((parseInt(qtyInput.value)||1)+1, max);
      };

      // State
      let selectedSizeId=null, selectedColorId=null, currentVariant=null;

      // Valid combos + cache
      let validCombos=null;
      const variantCache=new Map(); // `${sid}-${cid}` -> {exists, stock, gia, oldPrice, id}
      async function tryLoadValidCombos(){
        const urls=[
          `/api/product/${encodeURIComponent(productId)}/valid-combinations`,
          `/api/product/${encodeURIComponent(productId)}/combinations`,
          `/api/product/${encodeURIComponent(productId)}/variants`
        ];
        for(const url of urls){
          try{ const r=await fetch(url,{headers:{Accept:'application/json'}}); if(r.ok){ validCombos=await r.json(); if(Array.isArray(validCombos)) return; } }catch{}
        }
        validCombos=null;
      }
      await tryLoadValidCombos();

      const keyOf=(sid,cid)=>`${sid}-${cid}`;
      async function probeVariant(sid,cid){
        const key=keyOf(sid,cid);
        if(variantCache.has(key)) return variantCache.get(key);
        const urls=[
          `/api/getChiTietSanPham?sanPhamId=${encodeURIComponent(productId)}&sizeId=${encodeURIComponent(sid)}&colorId=${encodeURIComponent(cid)}`,
          `/acvstore/chi-tiet-san-pham/api?sanPhamId=${encodeURIComponent(productId)}&sizeId=${encodeURIComponent(sid)}&colorId=${encodeURIComponent(cid)}`
        ];
        let value={exists:false};
        for(const url of urls){
          try{
            const res=await fetch(url,{credentials:'include'});
            if(!res.ok) continue;
            const data=await res.json();
            if(data?.id){ value={exists:true, stock:data?.soLuongTonKho, gia:data?.gia, oldPrice:data?.oldPrice, id:data?.id}; break; }
          }catch{}
        }
        variantCache.set(key,value); return value;
      }

      function setDisabled(btn, dis){
        btn.disabled=dis;
        btn.classList.toggle('opacity-50', dis);
        btn.classList.toggle('cursor-not-allowed', dis);
        if(dis) btn.classList.remove('active');
      }
      function enableAllSizes(){  sizeWrap.querySelectorAll('.size-option').forEach(b=>setDisabled(b,false)); }
      function enableAllColors(){ colorWrap.querySelectorAll('.color-option').forEach(b=>setDisabled(b,false)); }

      function applyEnableBySize(sid){
        if(!sid){ enableAllColors(); return; }
        const colorBtns=[...colorWrap.querySelectorAll('.color-option')];
        if(validCombos){
          const ok=new Set(validCombos.filter(v=>String(v.sizeId)===String(sid)).map(v=>String(v.colorId)));
          colorBtns.forEach(b=>setDisabled(b,!ok.has(b.dataset.colorId)));
        }else{
          Promise.all(colorBtns.map(async b=>{ const r=await probeVariant(sid,b.dataset.colorId); setDisabled(b,!r.exists); }));
        }
      }
      function applyEnableByColor(cid){
        if(!cid){ enableAllSizes(); return; }
        const sizeBtns=[...sizeWrap.querySelectorAll('.size-option')];
        if(validCombos){
          const ok=new Set(validCombos.filter(v=>String(v.colorId)===String(cid)).map(v=>String(v.sizeId)));
          sizeBtns.forEach(b=>setDisabled(b,!ok.has(b.dataset.sizeId)));
        }else{
          Promise.all(sizeBtns.map(async b=>{ const r=await probeVariant(b.dataset.sizeId,cid); setDisabled(b,!r.exists); }));
        }
      }

      async function fetchVariantAndRender(){
        if(!selectedSizeId || !selectedColorId){
          currentVariant=null; stockEl.textContent='T·ªìn kho: h√£y ch·ªçn size & m√†u'; return;
        }
        let data=variantCache.get(keyOf(selectedSizeId,selectedColorId));
        if(!data || data.id==null){ data=await probeVariant(selectedSizeId,selectedColorId); }
        if(!data?.id){ currentVariant=null; stockEl.textContent='Bi·∫øn th·ªÉ kh√¥ng kh·∫£ d·ª•ng'; return; }
        currentVariant={ id:data.id, soLuongTonKho:data.stock, gia:data.gia, oldPrice:data.oldPrice };

        // t·ªìn kho
        if(typeof data.stock==='number'){
          stockEl.textContent=`T·ªìn kho: ${data.stock}`;
          qtyInput.max=data.stock;
          if(+qtyInput.value>data.stock) qtyInput.value=data.stock;
        }else{
          stockEl.textContent='T·ªìn kho: N/A';
          qtyInput.removeAttribute('max');
        }
        // gi√°
        const cur=Number(data.gia||0).toLocaleString('vi-VN')+' VNƒê';
        if(data.oldPrice && data.oldPrice!==data.gia){
          const old=Number(data.oldPrice).toLocaleString('vi-VN')+' VNƒê';
          priceEl.innerHTML=`${cur} <span class="text-red-600 line-through ms-2">${old}</span>`;
        }else{
          priceEl.textContent=cur;
        }
      }

      // Toggle ch·ªçn
      sizeWrap.querySelectorAll('.size-option').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const active=b.classList.contains('active');
          if(active){
            b.classList.remove('active'); selectedSizeId=null; applyEnableBySize(null);
            if(selectedColorId) applyEnableByColor(selectedColorId);
            currentVariant=null;
            stockEl.textContent = selectedColorId ? 'T·ªìn kho: h√£y ch·ªçn size' : `T·ªìn kho: ${button.dataset.stock ?? 'N/A'}`;
            priceEl.innerHTML   = 'T·ª´ ' + Number(button.dataset.productPrice || 0).toLocaleString('vi-VN') + ' VNƒê';
            qtyInput.removeAttribute('max'); return;
          }
          sizeWrap.querySelectorAll('.size-option').forEach(x=>x.classList.remove('active'));
          b.classList.add('active'); selectedSizeId=b.dataset.sizeId; applyEnableBySize(selectedSizeId);
          await fetchVariantAndRender();
        });
      });
      colorWrap.querySelectorAll('.color-option').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const active=b.classList.contains('active');
          if(active){
            b.classList.remove('active'); selectedColorId=null; applyEnableByColor(null);
            if(selectedSizeId) applyEnableBySize(selectedSizeId);
            currentVariant=null;
            stockEl.textContent = selectedSizeId ? 'T·ªìn kho: h√£y ch·ªçn m√†u' : `T·ªìn kho: ${button.dataset.stock ?? 'N/A'}`;
            priceEl.innerHTML   = 'T·ª´ ' + Number(button.dataset.productPrice || 0).toLocaleString('vi-VN') + ' VNƒê';
            qtyInput.removeAttribute('max'); return;
          }
          colorWrap.querySelectorAll('.color-option').forEach(x=>x.classList.remove('active'));
          b.classList.add('active'); selectedColorId=b.dataset.colorId; applyEnableByColor(selectedColorId);
          await fetchVariantAndRender();
        });
      });

      // M·ªü modal
      modal.show();

      // Th√™m v√†o gi·ªè
      const confirmBtn=modalEl.querySelector('#confirmAddToCart');
      confirmBtn.onclick = async ()=>{
        errEl.classList.add('hidden');
        const sBtn=sizeWrap.querySelector('.size-option.active');
        const cBtn=colorWrap.querySelector('.color-option.active');
        if(!sBtn || !cBtn){
          errEl.textContent='Vui l√≤ng ch·ªçn k√≠ch th∆∞·ªõc v√† m√†u s·∫Øc!';
          errEl.classList.remove('hidden'); return;
        }
        if(!currentVariant?.id){
          await fetchVariantAndRender();
          if(!currentVariant?.id) return showError('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin bi·∫øn th·ªÉ!');
        }
        const quantity=Math.max(1, parseInt(qtyInput.value)||1);
        if(typeof currentVariant.soLuongTonKho==='number' && quantity>currentVariant.soLuongTonKho){
          return showError('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho!');
        }

        confirmBtn.disabled=true; confirmBtn.classList.add('loading');
        try{
          const payload={ id: currentVariant.id, quantity };
          const addRes=await fetch('/api/cart/add',{
            method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify(payload)
          });
          if(addRes.ok){
            showSuccess('ƒê√£ th√™m v√†o gi·ªè h√†ng!');
            try{ window.updateCartCount?.(); }catch{}
            modal.hide();
          }else if(addRes.status===401){
            window.location.href='/customers/login';
          }else{
            let msg=''; try{ const j=await addRes.json(); msg=j.error||JSON.stringify(j); }catch{ msg=await addRes.text(); }
            showError(msg||'C√≥ l·ªói x·∫£y ra khi th√™m v√†o gi·ªè h√†ng!');
          }
        }catch(e){
          showError(e?.message||'L·ªói m·∫°ng khi th√™m v√†o gi·ªè h√†ng!');
        }finally{
          confirmBtn.disabled=false; confirmBtn.classList.remove('loading');
        }
      };
    });
  });

  // ===== Quick View ch·∫Øc ch·∫Øn
  document.querySelectorAll('.quick-view-btn').forEach(button=>{
    button.addEventListener('click', async ()=>{
      const productId=button.dataset.productId;
      let product;
      const res=await fetch(`/api/product/${encodeURIComponent(productId)}`,{headers:{Accept:'application/json'}});
      if(res.ok){
        const ct=res.headers.get('content-type')||'';
        product = ct.includes('application/json') ? await res.json() : JSON.parse(await res.text());
      }else{ alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu s·∫£n ph·∫©m.'); return; }

      const modalEl=document.createElement('div');
      modalEl.className='modal fade'; modalEl.tabIndex=-1;
      modalEl.innerHTML=`
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
          <div class="modal-header" style="background:#153054;color:#fff">
            <h5 class="modal-title">${product.tenSanPham ?? 'S·∫£n ph·∫©m'}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <img src="${product.urlHinhAnh ?? ''}" alt="${product.tenSanPham ?? ''}" class="w-100 h-64 object-cover rounded mb-4">
            <p class="text-blue-800 font-bold">${Number(product.price||0).toLocaleString('vi-VN')} VNƒê</p>
            <p class="text-sm text-gray-600">T·ªìn kho: ${product.tongSoLuong ?? 'N/A'}</p>
            <p class="text-sm">${product.moTa || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <a href="/chitietsanpham?id=${product.id}" class="btn text-white" style="background:#153054;">Xem chi ti·∫øt</a>
          </div>
        </div></div>`;
      document.body.appendChild(modalEl);
      const quickModal=new bootstrap.Modal(modalEl); quickModal.show();
      modalEl.addEventListener('hidden.bs.modal',()=>modalEl.remove(), { once:true });
    });
  });

  // ===== Chatbot toggle
  const toggleBtn=document.getElementById('chatbot-toggle');
  const chatBox=document.getElementById('chatbot-box');
  const closeBtn=document.getElementById('chatbot-close');
  const chatInput=document.getElementById('chat-input');
  const chatMessages=document.getElementById('chat-messages');
  function openChat(){ if(!chatBox.classList.contains('is-open')){ chatBox.classList.add('is-open'); restoreHistory(); ensureGreeting(); requestAnimationFrame(()=>chatInput?.focus()); } }
  function closeChat(){ chatBox.classList.remove('is-open'); } function isOpen(){ return chatBox.classList.contains('is-open'); }
  toggleBtn.onclick=(e)=>{ e.stopPropagation(); isOpen()?closeChat():openChat(); }; closeBtn.onclick=(e)=>{ e.stopPropagation(); closeChat(); };
  document.addEventListener('click',(e)=>{ if(!chatBox.contains(e.target)&&!toggleBtn.contains(e.target)) closeChat(); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'&&isOpen()) closeChat(); });

  document.querySelectorAll('.quick-reply').forEach(btn=>btn.addEventListener('click',()=>{ chatInput.value=btn.textContent; chatInput.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter'})); }));
  const sendBtn=document.getElementById('chat-send'); sendBtn?.addEventListener('click',()=>{ chatInput.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter'})); });

  function saveToHistory(role,msg){ const current=JSON.parse(sessionStorage.getItem("chat_history")||"[]"); current.push({role,msg}); sessionStorage.setItem("chat_history", JSON.stringify(current)); }
  function restoreHistory(){ chatMessages.innerHTML=''; const items=JSON.parse(sessionStorage.getItem("chat_history")||"[]");
    for(const item of items){ const div=document.createElement('div'); div.className=item.role==='user'?'chatbot-msg-user':'chatbot-msg-bot'; div.innerHTML=item.msg; chatMessages.appendChild(div); }
    const hasUserMsg=items.some(i=>i.role==='user'); document.getElementById('quick-row').style.display = hasUserMsg?'none':'flex';
    const typing=document.createElement('div'); typing.id='typing-indicator'; typing.className='chatbot-msg-bot hidden'; typing.textContent='ƒêang so·∫°n tin...'; chatMessages.appendChild(typing);
    chatMessages.scrollTop=chatMessages.scrollHeight;
  }
  function ensureGreeting(){ const items=JSON.parse(sessionStorage.getItem('chat_history')||'[]'); if(items.length>0) return;
    const greet1='Xin ch√†o B·∫°n! M√¨nh l√† tr·ª£ l√Ω AI c·ªßa ACV Store'; const greet2='M√¨nh r·∫•t s·∫µn l√≤ng h·ªó tr·ª£ B·∫°n üòä';
    const g1=document.createElement('div'); g1.className='chatbot-msg-bot'; g1.textContent=greet1;
    const g2=document.createElement('div'); g2.className='chatbot-msg-bot'; g2.textContent=greet2;
    chatMessages.appendChild(g1); chatMessages.appendChild(g2); saveToHistory('bot',greet1); saveToHistory('bot',greet2); chatMessages.scrollTop=chatMessages.scrollHeight;
  }

  chatInput.addEventListener('keydown', async (event)=>{
    if(event.key!=='Enter'||event.repeat) return; event.preventDefault();
    const message = chatInput.value.trim(); if(!message) return;
    document.getElementById('quick-row').style.display='none';
    const userDiv=document.createElement('div'); userDiv.className='chatbot-msg-user'; userDiv.textContent=message; chatMessages.appendChild(userDiv); saveToHistory('user',message); chatInput.value='';
    const typing=document.getElementById('typing-indicator'); typing?.classList.remove('hidden'); chatMessages.scrollTop=chatMessages.scrollHeight;

    try{
      const res = await fetch('https://lucnguyenthanhoai.app.n8n.cloud/webhook/website-chatbot',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ body:{ from:'user_123', message }})});
      const data = await res.json();
      let raw = (typeof data.message==='string') ? data.message : (data.message?.message ?? 'Xin l·ªói, bot kh√¥ng ph·∫£n h·ªìi ƒë√∫ng ƒë·ªãnh d·∫°ng.');
      raw = raw.replace(/```json\n|\n```/g,'').trim();
      try{ const parsed=JSON.parse(raw); raw = parsed.message || raw; }catch(_){}
      const html = raw
              .replace(/(https?:\/\/[^\s<]+|acvstore\.site\/[^\s<]+)/g,(u)=>{ const url=u.startsWith('http')?u:'https://'+u; return /\.(png|jpe?g|gif|webp|svg)(\?.*)?$/i.test(url) ? `<img src="${url}" alt="·∫¢nh" loading="lazy" style="max-width:100%;height:auto;margin-top:8px;" />` : `<a href="${url}" target="_blank" rel="noopener" style="color:#153054;text-decoration:underline;">${u}</a>`; })
              .replace(/\n/g,'<br>');
      const botDiv=document.createElement('div'); botDiv.className='chatbot-msg-bot'; botDiv.innerHTML=html; chatMessages.appendChild(botDiv); saveToHistory('bot', botDiv.innerHTML);
      chatMessages.scrollTop=chatMessages.scrollHeight;
    }catch(err){
      const botErr=document.createElement('div'); botErr.className='chatbot-msg-bot'; botErr.textContent='L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.'; chatMessages.appendChild(botErr); saveToHistory('bot', botErr.textContent);
    } finally { typing?.classList.add('hidden'); }
  });
</script>
</body>
</html>