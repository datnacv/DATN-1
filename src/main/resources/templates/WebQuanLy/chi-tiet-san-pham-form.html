<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Chi Tiết Sản Phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1300px; }
        .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-bottom: 1.5rem; }
        .card-header { background-color: #ffffff; border-bottom: 1px solid #e9ecef; padding: 1rem 1.5rem; font-weight: 500; }
        .table { border-color: #e9ecef; }
        .table thead { background-color: #f8f9fa; font-weight: 500; }
        .btn { border-radius: 0.375rem; padding: 0.6rem 1.2rem; font-weight: 500; }
    </style>
</head>
<body>
<div class="d-flex">
    <!-- Include sidebar fragment -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 justify-content-between fixed-top">
        <a class="navbar-brand fw-bold text-primary" href="#">
            <i class="fas fa-store-alt me-2"></i>ACV Admin
        </a>
        <div th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </nav>
    <!-- Nội dung chính bên phải -->
    <div class="content" id="content">
    <h2 class="mb-4 text-center">DANH SÁCH CHI TIẾT SẢN PHẨM</h2>

    <div class="card">
        <div class="card-header"><i class="fas fa-list me-2"></i>Danh Sách Chi Tiết Sản Phẩm</div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Ảnh</th>
                    <th>Sản phẩm</th>
                    <th>Màu sắc</th>
                    <th>Kích cỡ</th>
                    <th>Xuất xứ</th>
                    <th>Chất liệu</th>
                    <th>Kiểu dáng</th>
                    <th>Tay áo</th>
                    <th>Cổ áo</th>
                    <th>Thương hiệu</th>
                    <th>Giá</th>
                    <th>Số lượng tồn</th>
                    <th>Giới tính</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="pd, stats : ${chiTietSanPhamList}">
                    <td th:text="${stats.count}"></td>
                    <td>
                        <div th:if="${pd.hinhAnhSanPhams != null and !pd.hinhAnhSanPhams.isEmpty()}">
                            <img th:src="${pd.hinhAnhSanPhams[0].urlHinhAnh}" alt="Ảnh" style="width: 60px; height: 60px; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                            <span style="display:none;" class="text-danger small">Ảnh lỗi</span>
                        </div>
                        <span th:unless="${pd.hinhAnhSanPhams != null and !pd.hinhAnhSanPhams.isEmpty()}" class="text-muted">Không có</span>
                    </td>
                    <td th:text="${pd.sanPham?.tenSanPham ?: 'N/A'}"></td>
                    <td th:text="${pd.mauSac?.tenMau ?: 'N/A'}"></td>
                    <td th:text="${pd.kichCo?.ten ?: 'N/A'}"></td>
                    <td th:text="${pd.xuatXu?.tenXuatXu ?: 'N/A'}"></td>
                    <td th:text="${pd.chatLieu?.tenChatLieu ?: 'N/A'}"></td>
                    <td th:text="${pd.kieuDang?.tenKieuDang ?: 'N/A'}"></td>
                    <td th:text="${pd.tayAo?.tenTayAo ?: 'N/A'}"></td>
                    <td th:text="${pd.coAo?.tenCoAo ?: 'N/A'}"></td>
                    <td th:text="${pd.thuongHieu?.tenThuongHieu ?: 'N/A'}"></td>
                    <td th:text="${#numbers.formatDecimal(pd.gia, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                    <td th:text="${pd.soLuongTonKho}"></td>
                    <td th:text="${pd.gioiTinh ?: 'N/A'}"></td>
                    <td th:text="${pd.trangThai ? 'Hoạt động' : 'Ngừng hoạt động'}"></td>
                    <td class="text-center">
                        <button class="btn btn-warning btn-sm edit-btn" th:data-id="${pd.id}" data-bs-toggle="modal" data-bs-target="#editChiTietSanPhamModal" title="Sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form th:action="@{'/acvstore/chi-tiet-san-pham/delete/' + ${pd.id}}" method="post" style="display: inline;">
                            <input type="hidden" name="productId" th:value="${param.productId}"/>
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc muốn xóa chi tiết này?');" title="Xóa">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${chiTietSanPhamList == null or chiTietSanPhamList.isEmpty()}">
                    <td colspan="16" class="text-center text-muted py-5">Chưa có chi tiết sản phẩm nào được thêm.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Editing Product Detail -->
    <div class="modal fade" id="editChiTietSanPhamModal" tabindex="-1" aria-labelledby="editChiTietSanPhamModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editChiTietSanPhamModalLabel"><i class="fas fa-edit me-2"></i>Sửa Chi Tiết Sản Phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editChiTietSanPhamForm" enctype="multipart/form-data">
                        <input type="hidden" id="editId" name="id"/>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editProduct" class="form-label">Sản phẩm</label>
                                <select class="form-select" id="editProduct" disabled>
                                    <option value="">Chọn sản phẩm...</option>
                                    <option th:each="p : ${sanPhams}" th:value="${p.id}" th:text="${p.tenSanPham}"></option>
                                </select>
                                <input type="hidden" id="editProductHidden" name="productId"/>
                            </div>
                            <div class="col-md-6">
                                <label for="editColor" class="form-label">Màu sắc</label>
                                <select class="form-select" id="editColor" name="colorId" required>
                                    <option value="">Chọn màu...</option>
                                    <option th:each="c : ${mauSacs}" th:value="${c.id}" th:text="${c.tenMau}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editSize" class="form-label">Kích cỡ</label>
                                <select class="form-select" id="editSize" name="sizeId" required>
                                    <option value="">Chọn kích cỡ...</option>
                                    <option th:each="s : ${kichCos}" th:value="${s.id}" th:text="${s.ten}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editOrigin" class="form-label">Xuất xứ</label>
                                <select class="form-select" id="editOrigin" name="originId" required>
                                    <option value="">Chọn xuất xứ...</option>
                                    <option th:each="o : ${xuatXus}" th:value="${o.id}" th:text="${o.tenXuatXu}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editMaterial" class="form-label">Chất liệu</label>
                                <select class="form-select" id="editMaterial" name="materialId" required>
                                    <option value="">Chọn chất liệu...</option>
                                    <option th:each="m : ${chatLieus}" th:value="${m.id}" th:text="${m.tenChatLieu}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editStyle" class="form-label">Kiểu dáng</label>
                                <select class="form-select" id="editStyle" name="styleId" required>
                                    <option value="">Chọn kiểu dáng...</option>
                                    <option th:each="st : ${kieuDangs}" th:value="${st.id}" th:text="${st.tenKieuDang}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editSleeve" class="form-label">Tay áo</label>
                                <select class="form-select" id="editSleeve" name="sleeveId" required>
                                    <option value="">Chọn tay áo...</option>
                                    <option th:each="sa : ${tayAos}" th:value="${sa.id}" th:text="${sa.tenTayAo}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editCollar" class="form-label">Cổ áo</label>
                                <select class="form-select" id="editCollar" name="collarId" required>
                                    <option value="">Chọn cổ áo...</option>
                                    <option th:each="ca : ${coAos}" th:value="${ca.id}" th:text="${ca.tenCoAo}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editBrand" class="form-label">Thương hiệu</label>
                                <select class="form-select" id="editBrand" name="brandId" required>
                                    <option value="">Chọn thương hiệu...</option>
                                    <option th:each="th : ${thuongHieus}" th:value="${th.id}" th:text="${th.tenThuongHieu}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editGender" class="form-label">Giới tính</label>
                                <select class="form-select" id="editGender" name="gender" required>
                                    <option value="">Chọn giới tính...</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                    <option value="Unisex">Unisex</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editPrice" class="form-label">Giá bán</label>
                                <div class="input-group">
                                    <span class="input-group-text">₫</span>
                                    <input type="number" class="form-control" id="editPrice" name="price" step="1000" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="editStockQuantity" class="form-label">Số lượng tồn</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-boxes"></i></span>
                                    <input type="number" class="form-control" id="editStockQuantity" name="stockQuantity" min="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editStatus" class="form-label">Trạng thái</label>
                                <select class="form-select" id="editStatus" name="status" required>
                                    <option value="true">Hoạt động</option>
                                    <option value="false">Ngừng hoạt động</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Đóng</button>
                            <button class="btn btn-primary" type="submit"><i class="fas fa-save me-2"></i>Lưu thay đổi</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        $('#editProduct').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn sản phẩm...", width: '100%' });
        $('#editColor').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn màu...", width: '100%' });
        $('#editSize').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn kích cỡ...", width: '100%' });
        $('#editOrigin').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn xuất xứ...", width: '100%' });
        $('#editMaterial').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn chất liệu...", width: '100%' });
        $('#editStyle').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn kiểu dáng...", width: '100%' });
        $('#editSleeve').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn tay áo...", width: '100%' });
        $('#editCollar').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn cổ áo...", width: '100%' });
        $('#editBrand').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn thương hiệu...", width: '100%' });
        $('#editGender').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn giới tính...", width: '100%' });
        $('#editStatus').select2({ dropdownParent: $('#editChiTietSanPhamModal .modal-body'), placeholder: "Chọn trạng thái...", width: '100%' });

        $(document).on('click', '.edit-btn', function () {
            const productDetailId = $(this).data('id');
            $.ajax({
                url: '/acvstore/chi-tiet-san-pham/edit/' + productDetailId,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    $('#editId').val(response.id);
                    $('#editProduct').val(response.productId).trigger('change');
                    $('#editProductHidden').val(response.productId);
                    $('#editColor').val(response.colorId).trigger('change');
                    $('#editSize').val(response.sizeId).trigger('change');
                    $('#editOrigin').val(response.originId).trigger('change');
                    $('#editMaterial').val(response.materialId).trigger('change');
                    $('#editStyle').val(response.styleId).trigger('change');
                    $('#editSleeve').val(response.sleeveId).trigger('change');
                    $('#editCollar').val(response.collarId).trigger('change');
                    $('#editBrand').val(response.brandId).trigger('change');
                    $('#editGender').val(response.gender).trigger('change');
                    $('#editPrice').val(response.price);
                    $('#editStockQuantity').val(response.stockQuantity);
                    $('#editStatus').val(response.status ? 'true' : 'false').trigger('change');
                },
                error: function (xhr) {
                    alert("Lỗi khi tải dữ liệu chi tiết sản phẩm: " + (xhr.responseText || xhr.statusText));
                }
            });
        });

        $('#editChiTietSanPhamForm').on('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const id = $('#editId').val();
            $.ajax({
                url: '/acvstore/chi-tiet-san-pham/update/' + id,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function () {
                    $('#editChiTietSanPhamModal').modal('hide');
                    location.reload();
                },
                error: function (xhr) {
                    alert("Lỗi khi cập nhật chi tiết sản phẩm: " + (xhr.responseText || xhr.statusText));
                }
            });
        });
    });
</script>
</body>
</html>