<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Danh sách đợt giảm giá</title>

  <!-- Libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Inter font như ảnh -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/admin.css}">

  <style>
    :root{
      --primary:#153054;
      --primary-600:#1e4066;
      --secondary:#9FD5F7;
      --ink:#0f213d;
      --muted:#6b7280;
      --line:#e6eef5;
      --soft:#f6f9fb;
      --glass:rgba(255,255,255,.95);
      --shadow:0 10px 30px rgba(21,48,84,.08);
      --radius-lg:20px;
      --radius-md:14px;
    }

    html,body{height:100%}
    body{
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:linear-gradient(135deg,#f6f9fb,#eaf3fb);
      color:var(--ink);
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .content{
      padding:1.25rem 2rem 2rem;
      margin-left:256px;
      margin-top:64px;
      max-width:1400px;
    }

    /* ===== Page Title ===== */
    .page-title{
      background:var(--glass);backdrop-filter:blur(16px);
      border:1px solid rgba(21,48,84,.08);border-radius:20px;box-shadow:var(--shadow);
      padding:.75rem 1rem;
      margin:4px 0 16px;
      display:flex;align-items:center;justify-content:center;gap:.85rem;
    }
    .page-title .title-icon{
      width:52px;height:52px;border-radius:14px;background:var(--primary);color:#fff;
      display:inline-flex;align-items:center;justify-content:center;font-size:1.25rem;
      box-shadow:0 6px 18px rgba(21,48,84,.18);
    }
    .page-title .title-text{
      position:relative;margin:0;
      font-weight:800;font-size:1.75rem;line-height:1.2;letter-spacing:.1px;color:var(--ink);
    }
    .page-title .title-text::after{
      content:"";position:absolute;left:0;right:0;margin:auto;bottom:-8px;
      width:170px;height:3px;border-radius:999px;background:linear-gradient(90deg,var(--primary),var(--secondary));
    }
    @media (max-width:576px){
      .page-title{justify-content:flex-start}
      .page-title .title-text{font-size:1.45rem}
      .page-title .title-text::after{width:120px}
      .content{margin-left:0}
    }

    /* ===== Cards ===== */
    .card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid rgba(21,48,84,.08);box-shadow:var(--shadow);border-radius:var(--radius-lg);overflow:hidden}
    .card-header{background:linear-gradient(180deg,#f7fbff,#eef6ff);border-bottom:1px solid var(--line)}

    /* ===== Filter ===== */
    .filter-box .form-label{font-weight:600;text-transform:uppercase;font-size:.72rem;letter-spacing:.4px;color:var(--ink);margin-bottom:.35rem}
    .filter-box .form-control,.filter-box .form-select{border-radius:12px;border:2px solid var(--line);padding:.7rem .9rem;font-weight:500;background:#fff;transition:border-color .15s, box-shadow .15s}
    .filter-box .form-control:focus,.filter-box .form-select:focus{border-color:var(--primary);box-shadow:0 0 0 .25rem rgba(21,48,84,.12)}

    /* ===== Buttons ===== */
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-600));border:none;border-radius:12px;font-weight:700}
    .btn-primary:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .btn-warning{background:linear-gradient(135deg,#ffd76a,#ffc107);border:none;color:#111}
    .btn-danger{background:linear-gradient(135deg,#e35b6b,#dc3545);border:none}
    .btn-success{background:linear-gradient(135deg,#2bb673,#28a745);border:none}

    .employee-notice{background:#e6f0ff;border:1px solid #cfe0ff;color:#0b2a55;padding:.75rem 1rem;border-radius:.75rem;margin-bottom:1rem}

    /* ===== Table & Horizontal Scroll ===== */
    .table-wrap{border-top:1px solid var(--line)}
    .table-scroll-x{overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch;}
    .table-x-min{ min-width: 1400px; }
    .table{--bs-table-bg:transparent;margin-bottom:0}
    .table thead th{background:#f3f7ff;color:var(--ink);font-weight:700;border-bottom:1px solid var(--line)}
    .table th,.table td{vertical-align:middle;padding:.9rem 1rem;white-space:nowrap;}
    .table tbody tr{transition:background .12s ease}
    .table tbody tr:hover{background:#f8fbff}
    .table .badge{padding:.5rem .65rem;border-radius:999px;font-weight:700;letter-spacing:.2px}

    .action-buttons .btn{border-radius:10px;padding:.35rem .55rem}

    /* ===== Pagination ===== */
    .pagination.pagination-acv{gap:.5rem}
    .pagination.pagination-acv .page-link{background:#fff;color:var(--ink);border:1px solid rgba(21,48,84,.22);border-radius:12px;min-width:44px;text-align:center;padding:.55rem .9rem;transition:.15s ease}
    .pagination.pagination-acv .page-link:hover{border-color:var(--primary)}
    .pagination.pagination-acv .page-item.active .page-link{background:var(--primary);color:#fff;border-color:var(--primary);font-weight:700}
    .pagination.pagination-acv .page-item.disabled .page-link{opacity:.5;pointer-events:none;background:#f5f7fb}
    .pagination.pagination-acv .page-link.nav-prev,.pagination.pagination-acv .page-link.nav-next{min-width:auto;padding:.55rem 1rem}

    .text-muted-ink{color:var(--muted)}
    .table-responsive{border-top:1px solid var(--line)}

    /* ===== Toast ===== */
    .toast-acv{color:#fff;border:0;border-radius:14px;box-shadow:var(--shadow)}
    .toast-acv.bg-success{background:linear-gradient(135deg,#2bb673,#28a745)}
    .toast-acv.bg-danger{background:linear-gradient(135deg,#e35b6b,#dc3545)}
    .toast-acv .toast-body{display:flex;align-items:center;gap:.6rem}
    .toast-acv .toast-icon{display:inline-flex;width:28px;height:28px;border-radius:999px;align-items:center;justify-content:center;background:rgba(255,255,255,.18)}

    /* ===== Modal confirm ===== */
    .modal-confirm .modal-content{border:0;border-radius:16px;box-shadow:var(--shadow)}
    .modal-confirm .modal-header{
      background:#153054;color:#fff;border:0;border-top-left-radius:16px;border-top-right-radius:16px;
    }
    .modal-confirm .modal-title{font-weight:800}
    .modal-confirm .btn-close-white{filter: invert(1) grayscale(100%) brightness(200%);}
    .modal-confirm .modal-footer{border-top:0;padding-top:0.25rem}
    .modal-confirm .btn-primary{
      background:#153054;border:0;border-radius:12px;font-weight:700;padding:.45rem .9rem;
    }
    .modal-confirm .btn-primary:hover{filter:brightness(1.06)}
    .modal-confirm .btn-secondary{
      border-radius:12px;padding:.45rem .9rem;
    }

    /* Highlight khi trạng thái đổi */
    .row-bumped{animation: bumpBg 1.2s ease}
    @keyframes bumpBg{
      0%{background:#fff6d9}
      100%{background:transparent}
    }

    /* >>> THÊM: style cho hộp gợi ý từ khoá */
    .acv-suggest{
      position:absolute; top:100%; left:0; right:0; z-index:1050;
      background:#fff; border:1px solid var(--line); border-radius:12px; margin-top:.35rem;
      max-height:260px; overflow:auto; box-shadow:var(--shadow);
    }
    .acv-suggest .list-group-item{ border:0; padding:.55rem .85rem; cursor:pointer }
    .acv-suggest .list-group-item:hover{ background:#f8fbff }
    /* Header bảng: nền #153054 + chữ trắng */
    .table thead.acv-head th{
      background:#153054 !important;
      color:#fff !important;
      border-color:#153054 !important;    /* viền đồng bộ */
    }

    /* Icon/bi/link trong th cũng trắng */
    .table thead.acv-head th i,
    .table thead.acv-head th .bi,
    .table thead.acv-head th a{
      color:#fff !important;
    }
    /* SweetAlert2: đồng bộ kích thước confirm & success */
    .swal2-popup.swal-acv{
      width: clamp(320px, 92vw, 520px);   /* cùng size cho confirm & success */
      border-radius: 16px;
      padding: 1.25rem 1.25rem 1rem;
    }

  </style>
</head>
<body>
<div class="d-flex">
  <!-- Sidebar & Navbar -->
  <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>
  <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
    <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
  </nav>

  <div class="content" id="content">
    <!-- Title -->
    <header class="page-title">
      <span class="title-icon"><i class="fa-solid fa-percent"></i></span>
      <h2 class="title-text">Đợt Giảm Giá</h2>
    </header>

    <!-- Notice -->
    <div th:unless="${isAdmin}" class="employee-notice">
      <i class="fas fa-info-circle me-2"></i><strong>Chế độ xem:</strong> Bạn đang ở chế độ chỉ xem. Không thể tạo mới, chỉnh sửa hoặc xóa chiến dịch.
    </div>

    <!-- Filters -->
    <div class="card mb-4 filter-box">
      <div class="card-header py-3 d-flex align-items-center justify-content-between">
        <h5 class="mb-0 d-flex align-items-center gap-2"><i class="fas fa-filter"></i><span>Bộ lọc</span></h5>
      </div>
      <div class="card-body">
        <form class="row g-3 filter-grid" method="get" th:action="@{/acvstore/chien-dich-giam-gia}" id="filterForm">
          <div class="col-lg-4 col-md-6">
            <label class="form-label small">Từ khóa</label>
            <div class="position-relative">
              <input id="keywordInput" type="text" name="keyword" class="form-control ps-5" placeholder="Nhập tên, mã hoặc % giảm" th:value="${keyword}">
              <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3"></i>

              <!-- >>> THÊM: Hộp gợi ý -->
              <div id="kwSuggest" class="acv-suggest list-group d-none"></div>
            </div>
          </div>
          <div class="col-lg-2 col-md-6">
            <label class="form-label small">Từ ngày</label>
            <input type="datetime-local" name="startDate" class="form-control" th:value="${startDate != null ? #temporals.format(startDate,'yyyy-MM-dd''T''HH:mm') : ''}">
          </div>
          <div class="col-lg-2 col-md-6">
            <label class="form-label small">Đến ngày</label>
            <input type="datetime-local" name="endDate" class="form-control" th:value="${endDate != null ? #temporals.format(endDate,'yyyy-MM-dd''T''HH:mm') : ''}">
          </div>
          <div class="col-lg-2 col-md-6">
            <label class="form-label small">Trạng thái</label>
            <select name="status" class="form-select">
              <option value="">Tất cả</option>
              <option value="ONGOING" th:selected="${status == 'ONGOING'}">Đang diễn ra</option>
              <option value="UPCOMING" th:selected="${status == 'UPCOMING'}">Sắp diễn ra</option>
              <option value="ENDED" th:selected="${status == 'ENDED'}">Đã kết thúc</option>
            </select>
          </div>
          <div class="col-lg-2 col-md-6">
            <label class="form-label small">Mức giảm</label>
            <select name="discountLevel" class="form-select">
              <option value="">Tất cả</option>
              <option value="10" th:selected="${discountLevel == '10'}">Trên 10%</option>
              <option value="30" th:selected="${discountLevel == '30'}">Trên 30%</option>
              <option value="50" th:selected="${discountLevel == '50'}">Trên 50%</option>
            </select>
          </div>

          <input type="hidden" name="page" id="pageInput" th:value="${currentPage}">
          <input type="hidden" name="size" id="sizeInput" th:value="${pageSize != null ? pageSize : 10}">
        </form>
      </div>
    </div>

    <!-- List -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center py-3">
        <h5 class="mb-0 d-flex align-items-center gap-2"><i class="fa-solid fa-bag-shopping"></i><span>Danh sách chiến dịch</span></h5>
        <a th:href="@{/acvstore/chien-dich-giam-gia/create}" class="btn btn-primary" th:if="${isAdmin}">
          <i class="fas fa-plus me-1"></i>Thêm mới
        </a>
      </div>

      <div class="table-wrap table-scroll-x">
        <table class="table table-bordered table-hover table-x-min">
          <thead class="acv-head">
          <tr class="text-center">
          <th class="d-none d-md-table-cell">STT</th>
            <th>Mã</th>
            <th class="text-start">Tên chiến dịch</th>
            <th>% Giảm</th>
            <th>Ngày bắt đầu</th>
            <th>Ngày kết thúc</th>
            <th>Trạng thái</th>
            <th>Thao tác</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="campaign, iterStat : ${campaignList}"
              class="align-middle text-center"
              th:attr="data-campaign-id=${campaign.id}">
            <td class="d-none d-md-table-cell" th:text="${iterStat.count + currentPage * pageSize}"></td>
            <td th:text="${campaign.ma}"></td>
            <td class="text-start" th:text="${campaign.ten}"></td>

            <!-- % giảm (giữ nguyên logic hiện tại) -->
            <td th:utext="${campaign.phanTramGiam % 1 == 0} ? ${campaign.phanTramGiam.intValue()} + '&#37;' : ${campaign.phanTramGiam} + '&#37;'"></td>

            <td th:text="${#temporals.format(campaign.ngayBatDau,'dd/MM/yyyy HH:mm')}"></td>
            <td th:text="${#temporals.format(campaign.ngayKetThuc,'dd/MM/yyyy HH:mm')}"></td>

            <!-- TRẠNG THÁI + data-* để JS auto update -->
            <td th:with="st=${T(java.time.LocalDateTime).now().isAfter(campaign.ngayKetThuc)?'ENDED':(T(java.time.LocalDateTime).now().isBefore(campaign.ngayBatDau)?'UPCOMING':'ONGOING')}">
              <span class="badge status-badge"
                    th:attr="data-id=${campaign.id}, data-status=${st}"
                    th:classappend="${st == 'ONGOING'} ? ' bg-success' : (${st == 'UPCOMING'} ? ' bg-primary' : ' bg-secondary')"
                    th:text="${st == 'ONGOING'} ? 'Đang diễn ra' : (${st == 'UPCOMING'} ? 'Sắp diễn ra' : 'Đã kết thúc')">
              </span>
            </td>

            <!-- THAO TÁC -->
            <td th:with="st=${T(java.time.LocalDateTime).now().isAfter(campaign.ngayKetThuc)?'ENDED':(T(java.time.LocalDateTime).now().isBefore(campaign.ngayBatDau)?'UPCOMING':'ONGOING')}">
              <div class="action-buttons d-inline-flex gap-1">
                <a th:href="@{'/acvstore/chien-dich-giam-gia/view/' + ${campaign.id}}"
                   class="btn btn-sm btn-success" title="Xem"><i class="fas fa-eye"></i></a>

                <!-- Nút Sửa: render khi UP-COMING, JS sẽ ẩn khi đổi trạng thái -->
                <a th:if="${isAdmin && st == 'UPCOMING'}"
                   th:href="@{'/acvstore/chien-dich-giam-gia/edit/' + ${campaign.id}}"
                   class="btn btn-sm btn-warning edit-btn"
                   th:attr="data-id=${campaign.id}"
                   title="Sửa"><i class="fas fa-edit"></i></a>

                <button th:if="${isAdmin}"
                        type="button"
                        class="btn btn-sm btn-danger delete-btn"
                        th:attr="data-id=${campaign.id},data-name=${campaign.ten},data-status=${st}"
                        title="Xóa">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>

          <tr th:if="${#lists.isEmpty(campaignList)}">
            <td colspan="8" class="text-center py-4 text-muted-ink">Không có chiến dịch giảm giá nào</td>
          </tr>
          </tbody>
        </table>
      </div>

      <div class="card-footer" th:if="${totalPages > 0}">
        <nav>
          <ul class="pagination pagination-acv justify-content-center mb-0">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
              <a class="page-link page-nav nav-prev" href="#" data-page="prev"><i class="bi bi-chevron-left me-1"></i>Trước</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${currentPage == i} ? 'active'">
              <a class="page-link page-nav" href="#" th:data-page="${i}" th:text="${i + 1}"></a>
            </li>
            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
              <a class="page-link page-nav nav-next" href="#" data-page="next">Sau<i class="bi bi-chevron-right ms-1"></i></a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Modal xóa -->
<!--<div class="modal fade modal-confirm" id="deleteModal" tabindex="-1" th:if="${isAdmin}">-->
<!--  <div class="modal-dialog modal-dialog-centered">-->
<!--    <div class="modal-content">-->
<!--      <div class="modal-header">-->
<!--        <h5 class="modal-title"><i class="fa-solid fa-triangle-exclamation me-2"></i>Xác nhận xóa</h5>-->
<!--        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--      </div>-->
<!--      <div class="modal-body">-->
<!--        <p class="mb-0">Bạn có chắc chắn muốn xóa chiến dịch <span id="campaignNameToDelete" class="fw-bold"></span>?</p>-->
<!--      </div>-->
<!--      <div class="modal-footer">-->
<!--        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>-->
<!--        <form id="deleteForm" method="post" style="display:inline;">-->
<!--          <button type="submit" class="btn btn-primary">Xác nhận xóa</button>-->
<!--        </form>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</div>-->

<!-- Toast (góc phải) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
  <div id="toastMessage" class="toast toast-acv align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body fw-semibold">
        <span class="toast-icon"><i class="fa-solid fa-circle-check"></i></span>
        <span class="toast-text"></span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
<form id="deleteForm" method="post" class="d-none"></form>

<script th:src="@{/js/sidebar.js}" defer></script>
<script th:src="@{/js/notification.js}" defer></script>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('filterForm');
    const pageInput = document.getElementById('pageInput');
    const currentPage = parseInt(pageInput.value || '0');
    const totalPages = /*[[${totalPages}]]*/ 0;

    // Submit khi đổi select / datetime (giữ nguyên)
    form.querySelectorAll('select, input[type="datetime-local"]').forEach(el => {
      el.addEventListener('change', () => { pageInput.value = '0'; form.submit(); });
    });

    // >>> Thay thế xử lý keyword: auto-suggest + auto-submit
    const keyword = document.getElementById('keywordInput');
    const suggestBox = document.getElementById('kwSuggest');

    document.querySelectorAll('.page-nav').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const li = a.closest('li');
        if (li.classList.contains('disabled')) return;
        const target = a.getAttribute('data-page');
        let nextPage = currentPage;
        if (target === 'prev') nextPage = Math.max(0, currentPage - 1);
        else if (target === 'next') nextPage = Math.min(totalPages - 1, currentPage + 1);
        else nextPage = parseInt(target);
        pageInput.value = nextPage; form.submit();
      });
    });

    const isAdmin = /*[[${isAdmin}]]*/ false;

    // ==== Delete modal logic (giữ nguyên) ====
    // ==== Delete with SweetAlert2 ====
    // ==== Delete with SweetAlert2 ====
    if (isAdmin) {
      const deleteButtons = document.querySelectorAll('.delete-btn');

      // Toast sẵn có
      const toastEl  = document.getElementById('toastMessage');
      const toastTxt = toastEl.querySelector('.toast-text');
      const toastIns = new bootstrap.Toast(toastEl);

      function toast(_type, msg){
        toastEl.classList.remove('bg-success','bg-danger','bg-warning','bg-info');
        toastEl.classList.add('bg-success');          // luôn xanh lá
        toastTxt.textContent = msg;
        toastIns.show();
      }


      // Lấy tên tham số CSRF & token (nếu có Thymeleaf)
      let csrfParam = '_csrf', csrfToken = '';
      try {
        csrfParam = /*[['${_csrf.parameterName}']]*/ '_csrf';
        csrfToken = /*[['${_csrf.token}']]*/ '';
      } catch(e){ /* ignore */ }

      // Helper escape
      const escapeHtml = (str) => String(str||'').replace(/[&<>"']/g, m => (
              {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]
      ));

      deleteButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const status = btn.getAttribute('data-status');
          if (status !== 'UPCOMING') {
            toast('error','Chỉ được xóa khi chiến dịch ở trạng thái "Sắp diễn ra".');
            return;
          }

          const name = btn.getAttribute('data-name') || '';
          const id   = btn.getAttribute('data-id');

          const result = await Swal.fire({
            title: 'Xác nhận xóa',
            html: `Bạn có chắc chắn muốn xóa chiến dịch <b>${escapeHtml(name)}</b>?`,
            icon: 'warning',
            showCancelButton: true,
            reverseButtons: true,
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy',
            focusCancel: true,
            buttonsStyling: false,
            customClass: {
              confirmButton: 'btn btn-danger',
              cancelButton: 'btn btn-secondary ms-2'
            },
            showLoaderOnConfirm: true,
            allowOutsideClick: () => !Swal.isLoading(),
            preConfirm: async () => {
              try {
                // Ưu tiên fetch (không reload trang)
                const body = new URLSearchParams();
                if (csrfToken) body.append(csrfParam, csrfToken);

                // API delete theo REST dạng POST (đang dùng path /delete/{id})
                const res = await fetch(`/acvstore/chien-dich-giam-gia/delete/${id}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                  body: body.toString()
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return true;
              } catch (err) {
                // Nếu fetch lỗi (ví dụ CSRF), hiển thị lỗi ngay popup
                Swal.showValidationMessage('Lỗi khi xóa: ' + (err?.message || 'Không xác định'));
                return false;
              }
            }
          });

          if (result.isConfirmed) {
            // Xóa hàng khỏi bảng (animation)
            const row = btn.closest('tr');
            if (row) {
              row.style.transition = 'opacity .5s ease';
              row.style.opacity = '0';
              setTimeout(() => row.remove(), 500);
            }
            Swal.fire({ icon: 'success', title: 'Đã xóa', timer: 1400, showConfirmButton: false });
          }
        });
      });
    }



    // Toast theo flash message (giữ nguyên)
    (function handleToast(){
      const toastEl  = document.getElementById('toastMessage');
      const toastText= toastEl.querySelector('.toast-text');
      const toastInst= new bootstrap.Toast(toastEl);
      toastEl.classList.remove('bg-success','bg-danger');

      const success = /*[[${successMessage}]]*/ null;
      const error   = /*[[${errorMessage}]]*/ null;
      if (success){
        toastEl.classList.add('bg-success');
        toastText.textContent = success;
        toastInst.show();
      } else if (error){
        toastEl.classList.add('bg-danger');
        toastText.textContent = error;
        toastInst.show();
      }
    })();

    // ===== Auto refresh statuses (giữ nguyên) =====
    (function autoRefreshStatuses(){
      function collectVisibleCampaignIds(){
        return Array.from(document.querySelectorAll('tr[data-campaign-id]'))
                .map(tr => tr.getAttribute('data-campaign-id'))
                .filter(Boolean);
      }

      const STATUS_TEXT = { UPCOMING:'Sắp diễn ra', ONGOING:'Đang diễn ra', ENDED:'Đã kết thúc' };
      const STATUS_BADGE_CLASS = { UPCOMING:'bg-primary', ONGOING:'bg-success', ENDED:'bg-secondary' };

      function updateRowStatus(id, st){
        const row = document.querySelector(`tr[data-campaign-id="${id}"]`);
        const badge = document.querySelector(`.status-badge[data-id="${id}"]`);
        if (badge){
          const old = badge.getAttribute('data-status');
          if (old !== st){ // chỉ hiệu ứng khi có thay đổi
            row && row.classList.add('row-bumped');
            setTimeout(()=>{ row && row.classList.remove('row-bumped'); }, 1200);
          }
          badge.classList.remove('bg-primary','bg-success','bg-secondary');
          badge.classList.add(STATUS_BADGE_CLASS[st] || 'bg-secondary');
          badge.textContent = STATUS_TEXT[st] || '—';
          badge.setAttribute('data-status', st);
        }

        // cập nhật nút Xóa
        const delBtn = document.querySelector(`.delete-btn[data-id="${id}"]`);
        if (delBtn){
          delBtn.setAttribute('data-status', st);
          if (st !== 'UPCOMING'){
            delBtn.classList.add('disabled');
            delBtn.setAttribute('aria-disabled','true');
          } else {
            delBtn.classList.remove('disabled');
            delBtn.removeAttribute('aria-disabled');
          }
        }

        // Ẩn/hiện nút Sửa
        const editBtn = document.querySelector(`.edit-btn[data-id="${id}"]`);
        if (editBtn){
          if (st !== 'UPCOMING'){
            editBtn.classList.add('d-none');
          } else {
            editBtn.classList.remove('d-none');
          }
        }
      }

      async function fetchAndApplyStatuses(){
        const ids = collectVisibleCampaignIds();
        if (ids.length === 0) return;
        const url = '/acvstore/chien-dich-giam-gia/statuses?ids=' + encodeURIComponent(ids.join(','));
        try{
          const res = await fetch(url, { method: 'GET' });
          if (!res.ok) return;
          const data = await res.json(); // { "uuid":"UPCOMING", ... }
          Object.entries(data).forEach(([id, st]) => updateRowStatus(id, st));
        }catch(e){ /* im lặng */ }
      }

      fetchAndApplyStatuses();
      setInterval(fetchAndApplyStatuses, 30000);
    })();

    // ====== >>> THÊM MỚI: Auto-suggest + auto-submit cho từ khoá ======
    const norm = (s) => (s || '').trim().replace(/\s+/g, ' ');
    const debounce = (fn, ms) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; };
    const showSuggest = () => suggestBox.classList.remove('d-none');
    const hideSuggest = () => { suggestBox.classList.add('d-none'); suggestBox.innerHTML = ''; };
    const escapeHtml = (str) => str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    let lastSuggestQ = '';
    let abortCtl = null;

    const fetchSuggest = debounce(async (raw) => {
      const q = norm(raw);
      if (!q) { hideSuggest(); return; }
      if (q === lastSuggestQ) return;
      lastSuggestQ = q;

      try {
        if (abortCtl) abortCtl.abort();
        abortCtl = new AbortController();

        const res = await fetch(`/acvstore/chien-dich-giam-gia/suggest?q=${encodeURIComponent(q)}&limit=8`, {
          signal: abortCtl.signal
        });
        if (!res.ok) { hideSuggest(); return; }
        const list = await res.json();
        if (!Array.isArray(list) || list.length === 0) { hideSuggest(); return; }

        suggestBox.innerHTML = list.map(s =>
                `<button type="button" class="list-group-item">${escapeHtml(String(s))}</button>`
        ).join('');
        showSuggest();

        // click chọn gợi ý
        suggestBox.querySelectorAll('.list-group-item').forEach(btn => {
          btn.addEventListener('click', () => {
            keyword.value = btn.textContent;
            hideSuggest();
            pageInput.value = '0';
            keyword.value = norm(keyword.value);
            form.submit();
          });
        });
      } catch (e) {
        hideSuggest();
      }
    }, 200);

    const autoSubmit = debounce(() => {
      pageInput.value = '0';
      keyword.value = norm(keyword.value);
      form.submit();
    }, 500);

    if (keyword) {
      // Chặn Enter để tránh submit kép
      keyword.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
        }
      });

      keyword.addEventListener('input', () => {
        fetchSuggest(keyword.value); // gợi ý
        autoSubmit();                // tự submit sau 500ms không gõ
      });

      // Ẩn gợi ý khi click ra ngoài
      document.addEventListener('click', (e) => {
        if (!suggestBox.contains(e.target) && e.target !== keyword) hideSuggest();
      });
    }
  });
</script>
</body>
</html>