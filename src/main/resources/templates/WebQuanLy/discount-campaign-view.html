<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xem chi tiết đợt giảm giá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <style>
        :root{
            --primary:#153054;
            --secondary:#9FD5F7;
            --ink:#1b2430;
            --line:#e6eef5;
        }
        body{ background:#f5f7fb; color:var(--ink); }
        .content{ padding:1.25rem 2rem 2rem; margin-left:256px; margin-top:64px; }
        .sticky-header{
            position:sticky; top:60px; z-index:10; background:#fff; padding:.75rem 1.25rem;
            margin:-1rem -2rem 1rem -2rem; border-bottom:1px solid var(--line);
            display:flex; justify-content:space-between; align-items:center;
        }
        .card{ border:1px solid var(--line); }
        .card-header{ background:var(--primary); color:#fff; }
        .btn-outline-secondary{ border-color:var(--primary); color:var(--primary); }
        .btn-outline-secondary:hover{ background:var(--primary); color:#fff; }
        .badge-status{ border-radius:999px; padding:.4rem .7rem; font-weight:700; }
        .badge.bg-primary{ background-color:var(--primary) !important; }
        .table th,.table td{ vertical-align:middle; }
    </style>
    <script th:src="@{/js/sidebar.js}" defer></script>
</head>
<body>
<div class="d-flex">
    <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>
    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
        <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </nav>

    <div class="content">
        <div class="sticky-header">
            <div class="d-flex align-items-center">
                <a th:href="@{/acvstore/chien-dich-giam-gia}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </a>
                <h4 class="mb-0"><i class="fas fa-tags me-2"></i>Xem chi tiết đợt giảm giá</h4>
            </div>
            <div>
                <span th:classappend="${status=='ONGOING'} ? 'badge bg-success' : (${status=='UPCOMING'} ? 'badge bg-primary' : 'badge bg-secondary')"
                      class="badge-status"
                      th:text="${status=='ONGOING'} ? 'Đang diễn ra' : (${status=='UPCOMING'} ? 'Sắp diễn ra' : 'Đã kết thúc')">
                </span>
            </div>
        </div>

        <!-- Thông tin chung -->
        <div class="card mb-3">
            <div class="card-header fw-bold">Thông tin đợt giảm giá</div>
            <div class="card-body row g-3">
                <div class="col-md-3">
                    <div class="form-label">Mã đợt</div>
                    <div class="form-control" disabled th:text="${chienDich.ma}">ACVSALE</div>
                </div>
                <div class="col-md-4">
                    <div class="form-label">Tên đợt</div>
                    <div class="form-control" disabled th:text="${chienDich.ten}">Đợt giảm giá</div>
                </div>
                <div class="col-md-2">
                    <div class="form-label">% giảm (chỉ số)</div>
                    <div class="form-control" disabled
                         th:text="${(chienDich.phanTramGiam % 1 == 0) ? chienDich.phanTramGiam.intValue() : chienDich.phanTramGiam}">10</div>
                </div>
                <div class="col-md-3">
                    <div class="form-label">Ngày tạo</div>
                    <div class="form-control" disabled th:text="${#temporals.format(chienDich.thoiGianTao, 'dd/MM/yyyy HH:mm')}"></div>
                </div>
                <div class="col-md-3">
                    <div class="form-label">Ngày bắt đầu</div>
                    <div class="form-control" disabled th:text="${#temporals.format(chienDich.ngayBatDau, 'dd/MM/yyyy HH:mm')}"></div>
                </div>
                <div class="col-md-3">
                    <div class="form-label">Ngày kết thúc</div>
                    <div class="form-control" disabled th:text="${#temporals.format(chienDich.ngayKetThuc, 'dd/MM/yyyy HH:mm')}"></div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <!-- Sản phẩm đã chọn -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">Sản phẩm đã chọn</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width:90px">#</th>
                                    <th>Mã SP</th>
                                    <th>Tên sản phẩm</th>
                                </tr>
                                </thead>

                                <!-- NHÁNH SNAPSHOT: lấy unique theo maSanPham từ snapshotDetails -->
                                <tbody th:if="${useSnapshot}" th:with="seen=${new java.util.HashSet()}">
                                <tr th:each="d : ${snapshotDetails}"
                                    th:if="${d.maSanPham != null and seen.add(d.maSanPham)}">
                                    <td class="text-center" th:text="${seen.size()}"></td>
                                    <td th:text="${d.maSanPham}"></td>
                                    <td th:text="${d.tenSanPham}"></td>
                                </tr>
                                <tr th:if="${seen.isEmpty()}">
                                    <td colspan="3" class="text-center text-muted">Không có sản phẩm nào</td>
                                </tr>
                                </tbody>

                                <!-- NHÁNH DỮ LIỆU HIỆN THỜI -->
                                <tbody th:unless="${useSnapshot}">
                                <tr th:each="p, iStat : ${selectedProducts}">
                                    <td class="text-center" th:text="${iStat.count}"></td>
                                    <td th:text="${p.maSanPham}"></td>
                                    <td th:text="${p.tenSanPham}"></td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(selectedProducts)}">
                                    <td colspan="3" class="text-center text-muted">Không có sản phẩm nào</td>
                                </tr>
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chi tiết sản phẩm đã chọn -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header fw-bold">Chi tiết sản phẩm đã chọn</div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width:90px">#</th>
                                    <th>Tên SP</th>
                                    <th>Màu</th>
                                    <th>Size</th>
                                    <th>Giá</th>
                                    <th>Tồn</th>
                                </tr>
                                </thead>

                                <!-- NHÁNH SNAPSHOT -->
                                <tbody th:if="${useSnapshot}">
                                <tr th:each="d, iStat : ${snapshotDetails}">
                                    <td class="text-center" th:text="${iStat.count}"></td>
                                    <td th:text="${d.tenSanPham != null ? d.tenSanPham : 'Không có'}"></td>
                                    <td th:text="${d.mau != null ? d.mau : 'Không có'}"></td>
                                    <td th:text="${d.size != null ? d.size : 'Không có'}"></td>
                                    <td th:text="${d.gia != null ? #numbers.formatDecimal(d.gia, 0, 'POINT', 0, 'NONE') + ' VNĐ' : 'Không có'}"></td>
                                    <td th:text="${d.ton != null ? d.ton : 0}"></td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(snapshotDetails)}">
                                    <td colspan="6" class="text-center text-muted">Không có chi tiết nào</td>
                                </tr>
                                </tbody>

                                <!-- NHÁNH DỮ LIỆU HIỆN THỜI -->
                                <tbody th:unless="${useSnapshot}">
                                <tr th:each="d, iStat : ${selectedDetails}">
                                    <td class="text-center" th:text="${iStat.count}"></td>
                                    <td th:text="${d.sanPham != null ? d.sanPham.tenSanPham : 'Không có'}"></td>
                                    <td th:text="${d.mauSac != null ? d.mauSac.tenMau : 'Không có'}"></td>
                                    <td th:text="${d.kichCo != null ? d.kichCo.ten : 'Không có'}"></td>
                                    <td th:text="${d.gia != null ? #numbers.formatDecimal(d.gia, 0, 'POINT', 0, 'NONE') + ' VNĐ' : 'Không có'}"></td>
                                    <td th:text="${d.soLuongTonKho != null ? d.soLuongTonKho : 0}"></td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(selectedDetails)}">
                                    <td colspan="6" class="text-center text-muted">Không có chi tiết nào</td>
                                </tr>
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/notification.js}" defer></script>
</body>
</html>
