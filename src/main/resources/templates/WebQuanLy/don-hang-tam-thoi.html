<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh Sách Đơn Hàng Tạm Thời</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .modal-dialog { max-width: 800px; }
        .table th, .table td { vertical-align: middle; }
        .empty-state { text-align: center; padding: 20px; color: #6c757d; }
        .toast { background-color: #fff3cd; border-color: #ffeeba; }
        .toast-header { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2>Danh Sách Đơn Hàng Tạm Thời</h2>
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between mb-3">
                <a href="/acvstore/banhang" class="btn btn-outline-primary">
                    <i class="fa-solid fa-arrow-left me-1"></i> Quay lại bán hàng
                </a>
                <button class="btn btn-danger" onclick="clearAllHeldOrders()">
                    <i class="fa-solid fa-trash me-1"></i> Xóa tất cả
                </button>
            </div>
            <table class="table table-striped" id="heldOrdersTable">
                <thead>
                <tr>
                    <th>STT</th>
                    <th>Mã Đơn Hàng</th>
                    <th>Khách Hàng</th>
                    <th>Tổng Tiền (VNĐ)</th>
                    <th>Thời Gian Tạo</th>
                    <th>Hành Động</th>
                </tr>
                </thead>
                <tbody id="heldOrdersBody">
                <!-- Danh sách đơn hàng sẽ được đổ vào đây bằng JavaScript -->
                </tbody>
            </table>
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fa-solid fa-box-open fa-2x"></i>
                <h5>Không có đơn hàng tạm thời</h5>
                <p class="text-muted">Hiện tại không có đơn hàng nào được giữ.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chi Tiết Đơn Hàng -->
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailModalLabel">Chi Tiết Đơn Hàng Tạm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Mã Đơn Hàng:</strong> <span id="orderId"></span></p>
                <p><strong>Khách Hàng:</strong> <span id="customerName"></span></p>
                <p><strong>Tổng Tiền:</strong> <span id="totalAmount"></span></p>
                <p><strong>Thời Gian Tạo:</strong> <span id="createdTime"></span></p>
                <p><strong>Phương Thức Thanh Toán:</strong> <span id="paymentMethod"></span></p>
                <p><strong>Hình Thức Bán Hàng:</strong> <span id="deliveryMethod"></span></p>
                <p><strong>Phiếu Giảm Giá:</strong> <span id="voucher"></span></p>
                <h6 class="mt-3">Danh Sách Sản Phẩm</h6>
                <table class="table table-bordered">
                    <thead>
                    <tr>
                        <th>Tên Sản Phẩm</th>
                        <th>Màu Sắc</th>
                        <th>Kích Cỡ</th>
                        <th>Số Lượng</th>
                        <th>Giá (VNĐ)</th>
                        <th>Thành Tiền (VNĐ)</th>
                    </tr>
                    </thead>
                    <tbody id="orderItems"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button onclick="khoiPhucDonHang('[[${donHang.id}]]')">Khôi phục</button>
                <button type="button" class="btn btn-danger" onclick="deleteOrder()">Xóa</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast thông báo -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="actionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
        <div class="toast-header">
            <strong class="me-auto">Thông báo</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="actionToastBody"></div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentOrderId = null;

    // Hàm lấy danh sách đơn hàng tạm thời
    function fetchHeldOrders() {
        fetch('/acvstore/banhang/held-orders')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Dữ liệu từ held-orders:', data); // Debug
                const tableBody = document.getElementById('heldOrdersBody');
                tableBody.innerHTML = '';
                if (!data || !Array.isArray(data) || data.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('heldOrdersTable').style.display = 'none';
                } else {
                    document.getElementById('emptyState').style.display = 'none';
                    document.getElementById('heldOrdersTable').style.display = 'table';
                    data.forEach((order, index) => {
                        const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${order.id || 'Không rõ'}</td>
                            <td>${order.tenKhachHang || 'Không rõ'}</td>
                            <td>${parseFloat(order.tong || 0).toLocaleString('vi-VN')} VNĐ</td>
                            <td>${new Date(order.thoiGianTao || Date.now()).toLocaleString('vi-VN')}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewOrderDetails('${order.id}')">
                                    <i class="fa fa-eye"></i> Xem
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="restoreOrder('${order.id}')">
                                    <i class="fa fa-undo"></i> Khôi phục
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')">
                                    <i class="fa fa-trash"></i> Xóa
                                </button>
                            </td>
                        </tr>
                    `;
                        tableBody.innerHTML += row;
                    });
                }
            })
            .catch(error => {
                console.error('Lỗi khi tải đơn hàng tạm:', error);
                showToast('Lỗi khi tải danh sách đơn hàng tạm!');
            });
    }

    // Hàm xem chi tiết đơn hàng
    function viewOrderDetails(orderId) {
        currentOrderId = orderId;
        fetch(`/acvstore/banhang/held-order-details/${orderId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Dữ liệu từ held-order-details:', data); // Thêm log để debug
                document.getElementById('orderId').textContent = data.id || 'Không rõ';
                document.getElementById('customerName').textContent = data.tenKhachHang || 'Không rõ';
                document.getElementById('totalAmount').textContent = parseFloat(data.tong).toLocaleString('vi-VN') + ' VNĐ';
                document.getElementById('createdTime').textContent = new Date(data.thoiGianTao).toLocaleString('vi-VN');
                document.getElementById('paymentMethod').textContent = data.phuongThucThanhToan || 'Chưa chọn';
                document.getElementById('deliveryMethod').textContent = data.phuongThucBanHang || 'Chưa chọn';
                document.getElementById('voucher').textContent = data.idPhieuGiamGia || 'Không áp dụng';

                const orderItems = document.getElementById('orderItems');
                orderItems.innerHTML = '';
                if (data.danhSachSanPham && Array.isArray(data.danhSachSanPham)) {
                    data.danhSachSanPham.forEach(item => {
                        const row = `
                        <tr>
                            <td>${item.tenSanPham || 'Không rõ'}</td>
                            <td>${item.mauSac || 'Không rõ'}</td>
                            <td>${item.kichCo || 'Không rõ'}</td>
                            <td>${item.soLuong || 0}</td>
                            <td>${parseFloat(item.gia || 0).toLocaleString('vi-VN')}</td>
                            <td>${parseFloat(item.thanhTien || 0).toLocaleString('vi-VN')}</td>
                        </tr>
                    `;
                        orderItems.innerHTML += row;
                    });
                } else {
                    console.error('danhSachSanPham không hợp lệ:', data.danhSachSanPham);
                    orderItems.innerHTML = '<tr><td colspan="6">Không có sản phẩm trong đơn hàng</td></tr>';
                }

                $('#orderDetailModal').modal('show');
            })
            .catch(error => {
                console.error('Lỗi khi tải chi tiết đơn hàng:', error);
                showToast('Lỗi khi tải chi tiết đơn hàng!');
            });
    }

    // Hàm khôi phục đơn hàng
    // Hàm khôi phục đơn hàng
    function restoreOrder(orderId = currentOrderId) {
        if (confirm('Bạn có chắc muốn khôi phục đơn hàng này?')) {
            fetch('/acvstore/banhang/restore-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `orderId=${orderId}`
            })
                .then(response => {
                    if (!response.ok) {
                        // Nếu server trả về lỗi (ví dụ 500), chúng ta sẽ bắt ở đây
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Lỗi từ server.');
                        });
                    }
                    return response.json(); // Server của bạn luôn trả về JSON khi thành công 200 OK
                })
                .then(data => {
                    console.log('Dữ liệu khôi phục thành công từ server:', data);
                    // Các dòng code dưới đây là nguyên nhân gây lỗi vì các hàm và biến chỉ có trên trang ban-hang.html
                    // XÓA BỎ HOẶC COMMENT CÁC DÒNG NÀY:
                    /*
                    cart = data.danhSachSanPham.map(item => ({
                        productDetailId: item.idChiTietSanPham,
                        quantity: item.soLuong,
                        price: parseFloat(item.gia) || 0,
                        total: parseFloat(item.thanhTien) || 0,
                        tenSanPham: item.tenSanPham || 'Không rõ',
                        mauSac: item.mauSac || 'Không rõ',
                        kichCo: item.kichCo || 'Không rõ'
                    }));
                    const customerSelect = document.getElementById('customerSelect');
                    if (customerSelect) customerSelect.value = data.soDienThoaiKhachHang || '0999999999';

                    const shippingFee = document.getElementById('shippingFee');
                    if (shippingFee) shippingFee.value = data.phiVanChuyen ? parseFloat(data.phiVanChuyen) : 0;

                    const voucherSelect = document.getElementById('voucherSelect');
                    if (voucherSelect) voucherSelect.value = data.idPhieuGiamGia || '';

                    const paymentMethod = document.getElementById('paymentMethod');
                    if (paymentMethod) paymentMethod.value = data.phuongThucThanhToan || '';

                    const deliveryMethod = document.getElementById('deliveryMethod');
                    if (deliveryMethod) deliveryMethod.value = data.phuongThucBanHang || 'Tại quầy';

                    handleCustomerSelection(); // Không tồn tại trên trang này
                    togglePaymentFields(); // Không tồn tại trên trang này
                    fetchCartData().then(() => { // Không tồn tại trên trang này
                        showToast('Đơn hàng đã được khôi phục thành công!');
                        $('#orderDetailModal').modal('hide');
                        window.location.href = '/acvstore/banhang';
                    });
                    */

                    // Thay thế bằng logic đơn giản: hiển thị toast và chuyển hướng
                    showToast('Đơn hàng đã được khôi phục thành công!');
                    $('#orderDetailModal').modal('hide');
                    // Chuyển hướng người dùng về trang bán hàng chính
                    window.location.href = '/acvstore/banhang';

                })
                .catch(error => {
                    console.error('Lỗi khi khôi phục đơn hàng:', error);
                    // Hiển thị thông báo lỗi chi tiết hơn nếu có
                    showToast('Lỗi khi khôi phục đơn hàng: ' + error.message);
                });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchHeldOrders();
        // Gắn sự kiện cho button "Khôi phục"
        document.querySelectorAll('.btn-primary[onclick^="restoreOrder"]').forEach(btn => {
            btn.addEventListener('click', () => restoreOrder(btn.getAttribute('onclick').match(/'([^']+)'/)[1]));
        });
    });

    // Hàm xóa đơn hàng
    function deleteOrder(orderId = currentOrderId) {
        if (confirm('Bạn có chắc muốn xóa đơn hàng này?')) {
            fetch('/acvstore/banhang/delete-held-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `orderId=${orderId}`
            })
                .then(response => response.json())
                .then(data => {
                    showToast(data.message || 'Đã xóa đơn hàng tạm thành công!');
                    $('#orderDetailModal').modal('hide');
                    fetchHeldOrders();
                })
                .catch(error => {
                    console.error('Lỗi khi xóa đơn hàng:', error);
                    showToast('Lỗi khi xóa đơn hàng tạm!');
                });
        }
    }

    // Hàm xóa tất cả đơn hàng tạm
    function clearAllHeldOrders() {
        if (confirm('Bạn có chắc muốn xóa tất cả đơn hàng tạm?')) {
            fetch('/acvstore/banhang/delete-all-held-orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    showToast(data.message || 'Đã xóa tất cả đơn hàng tạm!');
                    fetchHeldOrders();
                })
                .catch(error => {
                    console.error('Lỗi khi xóa tất cả đơn hàng:', error);
                    showToast('Lỗi khi xóa tất cả đơn hàng tạm!');
                });
        }
    }

    // Hàm hiển thị toast thông báo
    function showToast(message) {
        document.getElementById('actionToastBody').textContent = message;
        const toast = new bootstrap.Toast(document.getElementById('actionToast'));
        toast.show();
    }

    // Khởi tạo
    document.addEventListener('DOMContentLoaded', () => {
        fetchHeldOrders();
    });
</script>
</body>
</html>