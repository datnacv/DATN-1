<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Quản lý yêu cầu đổi sản phẩm - ACV Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" th:href="@{/css/admin.css}"/>
    <script th:src="@{/js/sidebar.js}" defer></script>
    <script th:src="@{/js/notification.js}"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            color: #153054;
            line-height: 1.6;
            margin: 0;
            padding-top: 100px;
            min-height: 100vh;
        }

        .page-title {
            background: linear-gradient(135deg, #153054 0%, #153054 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
        }

        .info-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }

        table thead {
            background: linear-gradient(135deg, #153054 0%, #153054 100%);
            color: white;
        }

        table th, table td {
            padding: 1rem;
            text-align: left;
            white-space: nowrap;
        }

        .action-buttons button {
            padding: 10px 15px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .btn-approve {
            background: #10b981;
            color: white;
        }

        .btn-approve i {
            font-size: 18px;
        }

        .btn-reject {
            background: #ef4444;
            color: white;
        }

        .btn-reject i {
            font-size: 18px;
        }

        .price {
            font-weight: 600;
            color: #153054;
        }

        .price.negative {
            color: #ef4444;
        }
    </style>
</head>
<body>
<div class="d-flex">
    <!-- Include sidebar fragment -->
    <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>

    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
        <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${currentUser})}"></div>
    </nav>

    <!-- Nội dung chính bên phải -->
    <div class="content" id="content">
        <h1 class="page-title text-4xl">Quản lý yêu cầu đổi sản phẩm</h1>

        <div class="info-section">
            <table>
                <thead>
                <tr>
                    <th>Mã đơn hàng</th>
                    <th>Khách hàng</th>
                    <th>Sản phẩm đổi</th>
                    <th>Màu sắc</th>
                    <th>Kích cỡ</th>
                    <th>Sản phẩm thay thế</th>
                    <th>Màu sắc thay thế</th>
                    <th>Kích cỡ thay thế</th>
                    <th>Số lượng</th>
                    <th>Lý do</th>
                    <th>Trạng thái</th>
                    <th>Thời gian</th>
                    <th>Chênh lệch giá</th>
                    <th>Hành động</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="request : ${exchangeRequests}">
                    <td th:text="${request.hoaDon.donHang.maDonHang}"></td>
                    <td th:text="${request.hoaDon.donHang.nguoiDung.hoTen}"></td>
                    <td th:text="${request.chiTietDonHang.tenSanPham}"></td>
                    <td th:text="${request.chiTietDonHang.chiTietSanPham.mauSac != null ? request.chiTietDonHang.chiTietSanPham.mauSac.tenMau : 'N/A'}"></td>
                    <td th:text="${request.chiTietDonHang.chiTietSanPham.kichCo != null ? request.chiTietDonHang.chiTietSanPham.kichCo.ten : 'N/A'}"></td>
                    <td th:text="${request.chiTietSanPhamThayThe.sanPham.tenSanPham}"></td>
                    <td th:text="${request.chiTietSanPhamThayThe.mauSac != null ? request.chiTietSanPhamThayThe.mauSac.tenMau : 'N/A'}"></td>
                    <td th:text="${request.chiTietSanPhamThayThe.kichCo != null ? request.chiTietSanPhamThayThe.kichCo.ten : 'N/A'}"></td>
                    <td th:text="${request.soLuong}"></td>
                    <td th:text="${request.lyDoDoiHang}"></td>
                    <td th:text="${request.trangThai}"></td>
                    <td th:text="${request.thoiGianDoi}"></td>
                    <td>
                        <span class="price"
                              th:attr="data-value=${request.chenhLechGia != null ? request.chenhLechGia : 0}"
                              th:classappend="${request.chenhLechGia != null and request.chenhLechGia < 0} ? 'negative'"></span>
                    </td>
                    <td class="action-buttons">
                        <button th:if="${request.trangThai == 'Chờ xử lý'}"
                                class="btn-approve"
                                th:attr="data-id=${request.id}"
                                onclick="approveRequest(this)">
                            <i class="fas fa-check"></i>
                        </button>
<!--                        <button th:if="${request.trangThai == 'Chờ xử lý'}"-->
<!--                                class="btn-reject"-->
<!--                                th:attr="data-id=${request.id}"-->
<!--                                onclick="rejectRequest(this)">-->
<!--                            <i class="fas fa-times"></i>-->
<!--                        </button>-->
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Phân trang -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link" th:href="@{/acvstore/exchange-requests(page=${currentPage - 1})}">Trước</a>
                </li>
                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link" th:href="@{/acvstore/exchange-requests(page=${i})}" th:text="${i + 1}"></a>
                </li>
                <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                    <a class="page-link" th:href="@{/acvstore/exchange-requests(page=${currentPage + 1})}">Tiếp</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Định dạng giá trị tiền tệ cho cột chênh lệch giá
    document.addEventListener('DOMContentLoaded', function() {
        const priceElements = document.querySelectorAll('.price[data-value]');
        priceElements.forEach(element => {
            const value = parseFloat(element.getAttribute('data-value'));
            element.textContent = new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(value).replace('₫', ' VNĐ');
        });
    });

    function approveRequest(button) {
        const id = button.getAttribute('data-id');
        Swal.fire({
            title: 'Xác nhận yêu cầu đổi hàng',
            text: 'Bạn có chắc muốn xác nhận yêu cầu này?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#ef4444',
            confirmButtonText: 'Xác nhận',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/acvstore/exchange-requests/approve/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        Swal.fire({
                            title: data.success ? 'Thành công!' : 'Lỗi!',
                            text: data.message,
                            icon: data.success ? 'success' : 'error',
                            confirmButtonColor: '#153054'
                        }).then(() => {
                            if (data.success) {
                                window.location.reload();
                            }
                        });
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Có lỗi xảy ra. Vui lòng thử lại.',
                            icon: 'error',
                            confirmButtonColor: '#153054'
                        });
                    });
            }
        });
    }

    function rejectRequest(button) {
        const id = button.getAttribute('data-id');
        Swal.fire({
            title: 'Hủy yêu cầu đổi hàng',
            text: 'Vui lòng nhập lý do hủy (tùy chọn):',
            input: 'text',
            inputPlaceholder: 'Nhập lý do hủy...',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Hủy yêu cầu',
            cancelButtonText: 'Đóng'
        }).then((result) => {
            if (result.isConfirmed) {
                const reason = result.value || '';
                fetch(`/acvstore/exchange-requests/reject/${id}?rejectReason=${encodeURIComponent(reason)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        Swal.fire({
                            title: data.success ? 'Thành công!' : 'Lỗi!',
                            text: data.message,
                            icon: data.success ? 'success' : 'error',
                            confirmButtonColor: '#153054'
                        }).then(() => {
                            if (data.success) {
                                window.location.reload();
                            }
                        });
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: 'Có lỗi xảy ra. Vui lòng thử lại.',
                            icon: 'error',
                            confirmButtonColor: '#153054'
                        });
                    });
            }
        });
    }
</script>
</body>
</html>