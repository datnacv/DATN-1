<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACV Store - B√°n H√†ng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <script th:src="@{/js/sidebar.js}" defer></script>
  <style>
    :root {
      --primary-color: #153054;
      --primary-hover: #0e2239;
      --secondary-color: #153054;
      --success-color: #153054;
      --danger-color: #153054;
      --warning-color: #153054;
      --light-gray: #f8f9fa;
      --border-color: #dee2e6;
      --text-color: #9FD5F7;
      --dark-blue: #153054;
      --light-blue: #ffffff;
      --neutral-gray: #6B7280;
    }

    body {
      background-color: white;
      color: var(--dark-blue);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #qrScannerModal {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
    }

    .scanner-container {
      position: relative;
      width: 90%;
      max-width: 400px;
      background: none;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
    }

    #qr-reader {
      width: 100%;
      height: auto;
      display: block;
      border: none;
    }

    .scan-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: #00ff88;
      box-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88;
      animation: scan 2s linear infinite;
    }

    @keyframes scan {
      0% { top: 0; }
      50% { top: 100%; }
      100% { top: 0; }
    }

    .scanner-corners {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .close-button {
      background: var(--neutral-gray);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 16px;
    }

    .close-button:hover {
      background: #4b5563;
    }

    .scanner-footer {
      text-align: center;
      margin-top: 16px;
    }

    /* Stack toasts (newest on top) */
    #toastContainer{
      position: fixed; top: 1rem; right: 1rem;
      display: flex; flex-direction: column; /* x·∫øp d·ªçc */
      align-items: stretch; gap: .5rem;
      z-index: 9999;
      width: min(360px, calc(100vw - 2rem));
    }

    .toast{
      position: relative; /* kh√¥ng c√≤n fixed t·ª´ng c√°i */
      top: auto; right: auto; margin: 0;
      width: 100%;
      opacity: 0; transform: translateY(-6px);
      transition: all .3s ease;
    }

    .toast.show{
      opacity: 1; transform: translateY(0);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border-radius: 16px;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      margin-right: 12px;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      background: #f5f5f5;
      border: 2px solid var(--border-color);
      color: var(--dark-blue);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 0 0 0 transparent;
    }

    .tab:hover:not(.active) {
      background: #eaeaea;
      color: var(--dark-blue);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-color);
    }

    .tab.active {
      background: linear-gradient(135deg, #153054, #0e2239);
      color: var(--light-blue);
      font-weight: 600;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      border-color: #153054;
    }

    .tab .btn {
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.05);
      border: none;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      opacity: 0.4;
      color: var(--dark-blue);
      pointer-events: auto;
    }

    .tab.active .btn {
      opacity: 1;
      background: rgba(255, 255, 255, 0.2);
      color: var(--light-blue);
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.2);
    }

    .tab:hover .btn,
    .tab .btn:hover {
      opacity: 1;
    }

    .tab .btn:hover {
      background: var(--danger-color);
      color: var(--light-blue);
      transform: rotate(90deg) scale(1.1);
      box-shadow: 0 4px 12px rgba(21, 48, 84, 0.3);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-content h3,
    .modal-content h4 {
      color: var(--dark-blue);
    }

    .modal-content .fw-medium,
    .modal-content .fw-semibold {
      color: var(--dark-blue);
    }

    .modal-content .text-muted {
      color: var(--neutral-gray) !important;
    }

    .modal-content .text-primary {
      color: var(--dark-blue) !important;
    }

    .modal-content .text-success {
      color: var(--dark-blue) !important;
    }

    .form-control {
      transition: all 0.3s ease;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: white;
      padding: 12px 16px;
      color: var(--dark-blue);
    }

    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(21, 48, 84, 0.1);
      outline: none;
      transform: translateY(-1px);
    }

    .form-control:disabled,
    .form-control[readonly] {
      color: var(--neutral-gray);
      background: #e9ecef;
    }

    .btn-primary {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: var(--light-blue);
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
      position: relative;
      overflow: hidden;
      padding: 12px 24px;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(159, 213, 247, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .btn-secondary {
      background: var(--neutral-gray);
      border-color: var(--neutral-gray);
      color: white;
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 24px;
    }

    .btn-secondary:hover {
      background: #4b5563;
      border-color: #4b5563;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .btn-success {
      background: var(--success-color);
      border-color: var(--success-color);
      color: var(--light-blue);
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 24px;
    }

    .btn-success:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .btn-danger {
      background: var(--danger-color);
      border-color: var(--danger-color);
      color: var(--light-blue);
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 24px;
    }

    .btn-danger:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .spinner {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .cart-table {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .cart-table th {
      background: var(--light-gray);
      padding: 1.5rem 1rem;
      font-weight: 700;
      color: var(--dark-blue);
      border: none;
    }

    .cart-table td {
      padding: 1.5rem 1rem;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
      color: var(--dark-blue);
    }

    .cart-table .fw-semibold {
      color: var(--dark-blue);
    }

    .cart-table .quantity {
      color: var(--dark-blue);
      font-weight: bold;
    }

    .cart-table tr:hover {
      background: var(--light-gray);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    .cart-table img {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .cart-table .text-muted {
      color: var(--neutral-gray) !important;
    }

    .cart-table .text-success {
      color: var(--dark-blue) !important;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--light-gray);
      padding: 0.5rem;
      border-radius: 12px;
      border: 2px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .quantity-controls.loading {
      opacity: 0.5;
      pointer-events: none;
    }
    .quantity-controls input[type="number"]::-webkit-outer-spin-button,
    .quantity-controls input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance: none;
      margin: 0;
    }
    .quantity-controls input[type="number"]{
      -moz-appearance: textfield;     /* Firefox */
      text-align: center;
      padding-right: .25rem;           /* ƒë·ª° ƒë·ª•ng v√†o m√©p */
      width: 7ch;                      /* ƒë·ªß 3‚Äì4 ch·ªØ s·ªë */
      min-width: 70px;
    }

    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      background: var(--primary-color);
      color: var(--light-blue);
    }

    .quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .quantity-btn:not(:disabled):hover {
      transform: scale(1.1);
      background: var(--primary-hover);
    }

    .stock-warning {
      color: var(--danger-color);
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .summary-card {
      background: var(--light-gray);
      border-radius: 20px;
      padding: 2rem;
      border: 2px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }

    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--success-color), var(--warning-color));
    }

    .summary-card .fw-medium {
      color: var(--dark-blue);
    }

    .summary-card #subTotal,
    .summary-card #shippingFeeDisplay,
    .summary-card #discount,
    .summary-card #changeAmount {
      color: var(--dark-blue);
    }

    .summary-card #total {
      color: var(--dark-blue);
    }

    .summary-card .bg-light #total {
      color: var(--dark-blue);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .section-header h3 {
      color: var(--dark-blue);
    }

    .section-icon {
      width: 24px;
      height: 24px;
      color: var(--primary-color);
    }

    .customer-info-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      align-items: end;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .floating-label {
      position: relative;
    }

    .floating-label input,
    .floating-label select {
      padding-top: 1.5rem;
      color: var(--dark-blue);
    }

    .floating-label label {
      position: absolute;
      left: 1rem;
      top: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--dark-blue);
      pointer-events: none;
    }

    .badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      background-color: var(--primary-color);
      color: var(--light-blue);
    }

    .badge-primary {
      background-color: var(--primary-color);
      color: var(--light-blue);
    }

    .badge-secondary {
      background-color: var(--secondary-color);
      color: var(--light-blue);
    }

    @media (max-width: 768px) {
      .content {
        padding: 1rem;
      }

      .cart-table th,
      .cart-table td {
        font-size: 0.875rem;
        padding: 1rem 0.5rem;
      }

      .cart-table img {
        max-width: 40px;
        max-height: 40px;
      }

      .quantity-controls {
        flex-direction: column;
        gap: 0.25rem;
      }

      .customer-info-grid {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .header-gradient {
      background: linear-gradient(135deg, #153054, #0e2239);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    /* Overlay trung t√¢m cho .modal custom */
    .modal {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.35); z-index: 1050;
      padding: 16px;
    }
    .modal .modal-content { background: #fff; padding: 16px; }

    #voucherGroup > label{
      position: static !important;
      transform: none !important;
      top: auto; left: auto;
      margin-bottom: .375rem;
      opacity: .85;
      pointer-events: none;
    }
    /* Tinh ch·ªânh nh·ªè cho n√∫t-gi·∫£-select */
    #voucherBtn.form-select{
      cursor: pointer;
      display: flex;
      padding-right: 2.25rem; /* d∆∞ ch√∫t cho icon m≈©i t√™n */
    }
    #voucherBtn .fa-chevron-down{ pointer-events: none; }
    .btn-primary {
      background-color: #143C6A;  /* ch·ªânh theo m√†u b·∫°n d√πng */
      border-color: #143C6A;
    }
    .btn-primary:hover,
    .btn-primary:focus {
      background-color: #0F3158;
      border-color: #0F3158;
    }
  </style>
</head>
<body>
<div class="d-flex">
  <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>

  <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
    <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
  </nav>

  <div class="content mt-16" id="mainContent">
    <div class="text-center mb-2 mt-3">
      <p class="fs-2 fw-bold header-gradient mb-1">B√°n h√†ng t·∫°i qu·∫ßy</p>
      <!-- Thanh g·∫°ch ch√¢n -->
      <div aria-hidden="true"
           style="
         width:220px; height:4px; margin:6px auto 0;
         border-radius:999px;
         background:linear-gradient(90deg, var(--secondary, #9FD5F7), var(--primary, #153054));
         box-shadow:0 6px 16px rgba(21,48,84,.18);
       ">
      </div>
    </div>


    <div class="glass-card p-4 mb-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div id="orderTabs" class="d-flex flex-wrap"></div>
        <button id="addTabBtn" class="btn btn-secondary d-flex align-items-center gap-2">
          <i class="fas fa-plus"></i>
          Th√™m ƒê∆°n H√†ng
        </button>
      </div>
    </div>

    <div class="glass-card p-4">
      <div class="action-buttons">
        <button onclick="showQrScanner()" class="btn btn-success d-flex align-items-center justify-content-center gap-3">
          <i class="fas fa-qrcode fs-5"></i>
          <span class="fw-semibold">Qu√©t QR s·∫£n ph·∫©m</span>
        </button>
        <button onclick="showProductModal()" class="btn btn-primary d-flex align-items-center justify-content-center gap-3">
          <i class="fas fa-box fs-5"></i>
          <span class="fw-semibold">Ch·ªçn s·∫£n ph·∫©m</span>
        </button>
      </div>

      <div class="mb-4">
        <div class="section-header">
          <i class="fas fa-shopping-cart section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">Gi·ªè h√†ng</h3>
        </div>

        <div class="table-responsive">
          <table class="table cart-table">
            <thead>
            <tr>
              <th>H√¨nh ·∫£nh</th>
              <th>T√™n s·∫£n ph·∫©m</th>
              <th>M√†u s·∫Øc</th>
              <th>K√≠ch c·ª°</th>
              <th>Gi√°</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>Th√†nh ti·ªÅn</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody id="cartItems"></tbody>
          </table>
        </div>
      </div>

      <div class="mb-4">
        <div class="section-header">
          <i class="fas fa-user section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">Th√¥ng tin kh√°ch h√†ng</h3>
        </div>

        <div class="customer-info-grid mb-3">
          <div class="floating-label">
            <label for="customerPhone">S·ªë ƒëi·ªán tho·∫°i</label>
            <input
                    type="tel"
                    id="customerPhone"
                    class="form-control"
                    inputmode="tel"
                    autocomplete="tel"
                    placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng"
                    pattern="^(?:\+?84|0)(?:[35789]\d{8}|2\d{9})$"
                    title="SƒêT VN: di ƒë·ªông 10 s·ªë (03/05/07/08/09) ho·∫∑c c·ªë ƒë·ªãnh 11 s·ªë (02...), ch·∫•p nh·∫≠n +84"
            />
          </div>
          <button onclick="showCustomerModal()" class="btn btn-primary d-flex align-items-center gap-2">
            <i class="fas fa-users"></i>
            Ch·ªçn kh√°ch h√†ng
          </button>
        </div>

        <div class="form-grid">
          <div class="floating-label">
            <label for="customerName">T√™n kh√°ch h√†ng</label>
            <input type="text" id="customerName" class="form-control" placeholder="T√™n kh√°ch h√†ng" disabled>
          </div>
          <div class="floating-label">
            <label for="customerEmail">Email</label>
            <input type="email" id="customerEmail" class="form-control" placeholder="Email kh√°ch h√†ng" disabled>
          </div>
        </div>
      </div>

      <div id="addressSection" class="mb-4 d-none">
        <div class="section-header">
          <i class="fas fa-map-marker-alt section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">ƒê·ªãa ch·ªâ giao h√†ng</h3>
        </div>

        <div class="mb-3">
          <div class="floating-label mb-3">
            <label for="addressSelect">Ch·ªçn ƒë·ªãa ch·ªâ</label>
            <select id="addressSelect" class="form-select">
              <option value="">Ch·ªçn ƒë·ªãa ch·ªâ</option>
            </select>
          </div>

          <button onclick="showAddAddressForm()" class="btn btn-secondary d-flex align-items-center gap-2">
            <i class="fas fa-plus"></i>
            Th√™m ƒë·ªãa ch·ªâ m·ªõi
          </button>

          <div id="addAddressForm" class="d-none bg-light p-4 rounded border-2 border-dashed mt-3">
            <h4 class="fw-semibold mb-3">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h4>
            <div class="form-grid">
              <div class="floating-label">
                <label for="provinceSelect">T·ªânh/Th√†nh ph·ªë</label>
                <select id="provinceSelect" class="form-select" onchange="fetchDistricts(this.value)">
                  <option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>
                </select>
              </div>
              <div class="floating-label">
                <label for="districtSelect">Qu·∫≠n/Huy·ªán</label>
                <select id="districtSelect" class="form-select" onchange="fetchWards(this.value)">
                  <option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>
                </select>
              </div>
              <div class="floating-label">
                <label for="wardSelect">Ph∆∞·ªùng/X√£</label>
                <select id="wardSelect" class="form-select">
                  <option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>
                </select>
              </div>
              <div class="floating-label">
                <label for="addressLine">ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label>
                <input
                        type="text"
                        id="addressLine"
                        class="form-control"
                        placeholder="S·ªë nh√†, ƒë∆∞·ªùng‚Ä¶ (vd: 12/5 Ng√µ 8 Ph·ªë Hu·∫ø)"
                        required
                        maxlength="120"
                        autocomplete="address-line1">
              </div>
            </div>
            <div class="d-flex gap-3 mt-3">
              <button onclick="addNewAddress()" class="btn btn-success d-flex align-items-center gap-2">
                <i class="fas fa-save"></i>
                L∆∞u ƒë·ªãa ch·ªâ
              </button>
              <button onclick="document.getElementById('addAddressForm').classList.add('d-none')" class="btn btn-secondary">
                H·ªßy
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-4">
        <div class="section-header">
          <i class="fas fa-cog section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">C·∫•u h√¨nh ƒë∆°n h√†ng</h3>
        </div>

        <div class="form-grid">
          <div class="floating-label">
            <label for="saleMethod">Ph∆∞∆°ng th·ª©c b√°n h√†ng</label>
            <select id="saleMethod" onchange="toggleAddressSection()" class="form-select">
              <option value="T·∫°i qu·∫ßy">üè™ T·∫°i qu·∫ßy</option>
              <option value="Giao h√†ng">üöö Giao h√†ng</option>
            </select>
          </div>

          <div class="floating-label d-none" id="shippingFeeContainer">
            <label for="shippingFee">Ph√≠ v·∫≠n chuy·ªÉn</label>
            <input type="text" id="shippingFee" value="0" class="form-control" inputmode="numeric" disabled>
            <small id="shippingCalcStatus" class="text-muted d-none" hidden>ƒêang t√≠nh ph√≠ GHN‚Ä¶</small>
          </div>


          <!-- GHN: D·ªãch v·ª• v·∫≠n chuy·ªÉn -->
          <div class="floating-label d-none" id="shippingMethodContainer" hidden>
            <label for="shippingMethod">D·ªãch v·ª• GHN</label>
            <select id="shippingMethod" class="form-select"></select>
          </div>


          <!-- Phi·∫øu gi·∫£m gi√° (n√∫t m·ªü modal) -->
          <!-- N√∫t m·ªü modal ch·ªçn phi·∫øu (k√≠ch th∆∞·ªõc nh∆∞ <select>) -->
          <!-- N√∫t ch·ªçn phi·∫øu (gi·ªëng Ch·ªçn kh√°ch h√†ng) -->
          <div class="mb-3" id="voucherGroup">
            <button type="button"
                    class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2 py-3 rounded-3 shadow-sm"
                    onclick="openVoucherModal()">
              <i class="fas fa-ticket-alt fs-5"></i>
              <span class="fw-semibold">Ch·ªçn phi·∫øu</span>
            </button>
          </div>






          <div id="voucherModal" class="modal">
            <div class="modal-content" style="max-width: 720px;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-3">
                  <i class="fas fa-ticket-alt fs-3 text-primary"></i>
                  <h3 class="fs-3 fw-bold">Ch·ªçn m√£ gi·∫£m gi√°</h3>
                </div>
                <button onclick="closeVoucherModal()" class="btn-close"></button>
              </div>

              <!-- Freeship -->
              <div class="mb-4">
                <h4 class="fs-5 fw-semibold mb-3 d-flex align-items-center gap-2">
                  <i class="fas fa-truck text-success"></i> Freeship (SHIPPING)
                </h4>
                <div id="shipVoucherList" class="d-grid gap-2"></div>
              </div>

              <!-- Order -->
              <div class="mb-4">
                <h4 class="fs-5 fw-semibold mb-3 d-flex align-items-center gap-2">
                  <i class="fas fa-receipt text-primary"></i> M√£ gi·∫£m gi√° ƒë∆°n h√†ng (ORDER)
                </h4>
                <div id="orderVoucherList" class="d-grid gap-2"></div>
              </div>

              <div class="d-flex justify-content-between gap-3">
                <button class="btn btn-outline-secondary" onclick="clearVoucherSelections()">B·ªè ch·ªçn t·∫•t c·∫£</button>
                <div class="d-flex gap-3">
                  <button class="btn btn-secondary" onclick="closeVoucherModal()">H·ªßy</button>
                  <button class="btn btn-success" onclick="applySelectedVouchers()">
                    <i class="fas fa-check-circle me-2"></i>√Åp d·ª•ng
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="floating-label">
            <label for="paymentMethod">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <select id="paymentMethod" onchange="toggleCashInput()" class="form-select">
              <option value="550E8400-E29B-41D4-A716-446655440017">üíµ Ti·ªÅn m·∫∑t</option>
              <option value="550E8400-E29B-41D4-A716-446655440018">üè¶ Chuy·ªÉn kho·∫£n</option>
            </select>
          </div>

          <div id="cashInput" class="d-none floating-label">
            <label for="cashAmount">S·ªë ti·ªÅn kh√°ch ƒë∆∞a</label>
            <input type="text" id="cashAmount" value="0" class="form-control" inputmode="numeric">
          </div>
        </div>
      </div>

      <div class="summary-card mb-4">
        <div class="section-header">
          <i class="fas fa-calculator section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">T·ªïng k·∫øt ƒë∆°n h√†ng</h3>
        </div>

        <div class="row">
          <div class="col-md-6">

            <!-- T·∫°m t√≠nh (subtotal) -->
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <span class="fw-medium">T·∫°m t√≠nh:</span>
              <span id="subTotal" class="fw-bold fs-5">0 VNƒê</span>
            </div>

            <!-- Ph√≠ v·∫≠n chuy·ªÉn G·ªêC -->
            <div id="shippingBaseRow" class="d-flex justify-content-between align-items-center py-2 border-bottom d-none">
              <span class="fw-medium">Ph√≠ v·∫≠n chuy·ªÉn (g·ªëc):</span>
              <span id="shippingFeeBaseDisplay" class="fw-bold fs-5">0 VNƒê</span>
            </div>

            <!-- Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn (Freeship) -->
            <div id="shippingDiscountRow" class="d-flex justify-content-between align-items-center py-2 border-bottom d-none">
              <span class="fw-medium">Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn:</span>
              <span id="shippingDiscountDisplay" class="fw-bold fs-6 text-success">- 0 VNƒê</span>
            </div>

            <!-- Gi·∫£m gi√° ƒë∆°n (Order) -->
            <div id="orderDiscountRow" class="d-flex justify-content-between align-items-center py-2 border-bottom d-none">
              <span class="fw-medium">Gi·∫£m gi√° ƒë∆°n:</span>
              <span id="orderDiscountDisplay" class="fw-bold fs-6 text-success">- 0 VNƒê</span>
            </div>

          </div>

          <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center py-3 bg-light rounded px-3 mb-3">
              <span class="fw-bold fs-4">T·ªïng ti·ªÅn:</span>
              <span id="total" class="fw-bold fs-3 text-success">0 VNƒê</span>
            </div>
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <span class="fw-medium">Ti·ªÅn tr·∫£ l·∫°i:</span>
              <span id="changeAmount" class="fw-bold fs-5">0 VNƒê</span>
            </div>
          </div>
        </div>
      </div>


      <button onclick="createOrder()" class="btn btn-success w-100 py-3 fs-4 fw-bold d-flex align-items-center justify-content-center gap-3">
        <i class="fas fa-check-circle fs-3"></i>
        T·∫°o ƒë∆°n h√†ng
      </button>
    </div>

    <div id="qrScannerModal">
      <div class="scanner-container">
        <div id="qr-reader"></div>
        <div class="scan-overlay">
          <div class="scan-line"></div>
          <div class="scanner-corners"></div>
        </div>
      </div>
      <div class="scanner-footer">
        <button class="close-button" onclick="stopQrScanner()">Close</button>
      </div>
    </div>

    <div id="customerModal" class="modal">
      <div class="modal-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-users fs-3 text-primary"></i>
            <h3 class="fs-3 fw-bold">Danh s√°ch kh√°ch h√†ng</h3>
          </div>
          <button onclick="document.getElementById('customerModal').style.display='none'" class="btn-close"></button>
        </div>

        <div class="mb-4">
          <div class="floating-label">
            <label for="customerSearch">T√¨m ki·∫øm kh√°ch h√†ng</label>
            <input type="text" id="customerSearch" class="form-control" placeholder="Nh·∫≠p t√™n, s·ªë ƒëi·ªán tho·∫°i ho·∫∑c email">
          </div>
        </div>

        <div class="mb-4">
          <h4 class="fs-5 fw-semibold text-muted mb-3 d-flex align-items-center gap-2">
            <i class="fas fa-user text-primary"></i>
            Kh√°ch l·∫ª
          </h4>
          <div id="retailCustomer" class="p-3 border-2 border-dashed rounded cursor-pointer hover-bg-light" onclick="selectCustomerFromModal('0999999999', 'Kh√°ch l·∫ª', '')">
            <div class="d-flex align-items-center gap-3">
              <i class="fas fa-user-circle fs-3 text-muted"></i>
              <span class="fw-medium">Kh√°ch l·∫ª</span>
            </div>
          </div>
        </div>

        <div>
          <h4 class="fs-5 fw-semibold text-muted mb-3 d-flex align-items-center gap-2">
            <i class="fas fa-address-book text-success"></i>
            Kh√°ch h√†ng kh√°c
          </h4>
          <div id="customerList" class="overflow-auto" style="max-height: 300px;"></div>
        </div>

        <div id="customerSpinner" class="spinner mt-4"></div>
      </div>
    </div>

    <div id="productModal" class="modal">
      <div class="modal-content">
        <div class="d-flex align-items-center gap-3 mb-4">
          <i class="fas fa-box fs-3 text-primary"></i>
          <h3 class="fs-3 fw-bold">Danh s√°ch s·∫£n ph·∫©m</h3>
        </div>
        <div class="mb-4">
          <div class="floating-label">
            <label for="productSearch">T√¨m ki·∫øm s·∫£n ph·∫©m</label>
            <input type="text" id="productSearch" class="form-control" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m">
          </div>
        </div>
        <div id="productList" class="overflow-auto" style="max-height: 400px;"></div>
        <div id="productSpinner" class="spinner mt-4"></div>
        <button onclick="document.getElementById('productModal').style.display='none'" class="btn btn-secondary w-100 mt-3">
          ƒê√≥ng
        </button>
      </div>
    </div>

    <div id="variantModal" class="modal">
      <div class="modal-content">
        <div class="d-flex align-items-center gap-3 mb-4">
          <i class="fas fa-palette fs-3 text-primary"></i>
          <h3 class="fs-3 fw-bold" id="variantModalTitle">Ch·ªçn bi·∫øn th·ªÉ s·∫£n ph·∫©m</h3>
        </div>

        <div class="form-grid mb-4">
          <div class="floating-label">
            <label for="colorSelect">M√†u s·∫Øc</label>
            <select id="colorSelect" class="form-select" onchange="fetchVariants()">
              <option value="">Ch·ªçn m√†u s·∫Øc</option>
            </select>
          </div>

          <div class="floating-label">
            <label for="sizeSelect">K√≠ch c·ª°</label>
            <select id="sizeSelect" class="form-select" onchange="fetchVariants()">
              <option value="">Ch·ªçn k√≠ch c·ª°</option>
            </select>
          </div>
        </div>

        <div id="variantDetails" class="d-none bg-light p-4 rounded mb-4">
          <div class="row align-items-center">
            <div class="col-md-6" id="variantImage"></div>
            <div class="col-md-6">
              <div class="mb-3 d-flex justify-content-between">
                <span class="fw-medium">Gi√°:</span>
                <span id="variantPrice" class="fw-bold text-primary"></span>
              </div>
              <div class="mb-3 d-flex justify-content-between">
                <span class="fw-medium">T·ªìn kho:</span>
                <span id="variantStock" class="fw-bold text-success"></span>
              </div>
              <div class="floating-label">
                <label for="variantQuantity">S·ªë l∆∞·ª£ng</label>
                <input type="number" id="variantQuantity" min="1" value="1" class="form-control">
              </div>
            </div>
          </div>
        </div>
        <div id="variantSpinner" class="spinner mb-4"></div>

        <div class="d-flex gap-3">
          <button onclick="addVariantToCart()" class="btn btn-success flex-fill d-flex align-items-center justify-content-center gap-2">
            <i class="fas fa-cart-plus"></i>
            Th√™m v√†o gi·ªè h√†ng
          </button>
          <button onclick="document.getElementById('variantModal').style.display='none'" class="btn btn-secondary">
            H·ªßy
          </button>
        </div>
      </div>
    </div>
  </div>

</div>

<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // === PTTT maps (∆∞u ti√™n label PTTT do BE tr·∫£ v·ªÅ) ===
  let voucherPtttMapById = {};
  let voucherPtttMapByMa = {};

  // ==== HARD REVALIDATE tr∆∞·ªõc khi checkout ====
  // Re-validate 1 voucher c·ª• th·ªÉ, t·ª± g·ª° state + UI n·∫øu fail
  async function _revalidateOneVoucher({ id, kind }) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab || !id) return { ok: true };

    const shippingFee = Number(tab.shippingFeeBase || 0);
    const url = `${BASE_URL}/cart/apply-voucher`
            + `?voucherId=${id}`
            + `&shippingFee=${shippingFee}`
            + `&tabId=${currentTabId}`
            + `&paymentMethodId=${encodeURIComponent(getSelectedPaymentMethodId())}`;

    try {
      const res = await fetch(url);
      if (!res.ok) {
        // G·ª° trong state + UI
        if (kind === 'ORDER') {
          tab.voucherId = null;
          tab.orderVoucherId = null;
          tab.discount = 0;
          document.querySelectorAll('#voucherModal input[name="orderVoucher"]').forEach(r => {
            if (r.value === String(id)) r.checked = false;
          });
          const voucherSelect = document.getElementById('voucherSelect');
          if (voucherSelect && voucherSelect.value === String(id)) voucherSelect.value = '';
        } else if (kind === 'SHIP') {
          tab.shipVoucherId = null;
          tab.shippingDiscount = 0;
          document.querySelectorAll('#voucherModal input[name="shipVoucher"]').forEach(r => {
            if (r.value === String(id)) r.checked = false;
          });
        }
        updateSummary(tab);
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
        await refreshCartFromServer(); // ƒë·∫£m b·∫£o server-side c≈©ng s·∫°ch
        return { ok: false };
      }

      // Th√†nh c√¥ng ‚Üí ƒë·ªìng b·ªô l·∫°i gi·ªè/t·ªïng
      const data = await res.json();
      updateCartFromResponse(data);
      return { ok: true };
    } catch {
      // L·ªói m·∫°ng coi nh∆∞ kh√¥ng ok ƒë·ªÉ an to√†n
      return { ok: false };
    }
  }
  function clearAddressUiElements() {
    const addressSection          = document.getElementById('addressSection');
    const shippingFeeContainer    = document.getElementById('shippingFeeContainer');
    const shippingMethodContainer = document.getElementById('shippingMethodContainer');
    const addressSelect           = document.getElementById('addressSelect');

    addressSection?.classList.add('d-none');
    shippingFeeContainer?.classList.add('d-none');
    shippingMethodContainer?.classList.add('d-none');
    if (addressSelect) addressSelect.innerHTML = '<option value="">Ch·ªçn ƒë·ªãa ch·ªâ</option>';
  }
  function resetShippingStateForCurrentTab() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;
    tab.selectedAddress  = '';
    tab.shippingFeeBase  = 0;
    tab.shippingDiscount = 0;
    tab.shipVoucherId    = null;
    updateSummary(tab);
    localStorage.setItem('orderTabs', JSON.stringify(tabs));
    updateShipSectionVisibility?.();
  }

  // G·ªçi tr∆∞·ªõc createOrder(): n·∫øu c√≥ m√£ b·ªã g·ª° ‚Üí ch·∫∑n t·∫°o ƒë∆°n & b√°o
  async function hardRevalidateVouchersBeforeCheckout() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return { proceed: false, removed: false };

    let removed = false;

    // 1) ORDER
    if (tab.orderVoucherId || tab.voucherId) {
      const vid = tab.orderVoucherId || tab.voucherId;
      const r = await _revalidateOneVoucher({ id: vid, kind: 'ORDER' });
      if (!r.ok) removed = true;
    }

    // 2) SHIPPING
    if (isShippingEnabled() && tab.shipVoucherId) {
      const r = await _revalidateOneVoucher({ id: tab.shipVoucherId, kind: 'SHIP' });
      if (!r.ok) removed = true;
    }

    if (removed) {
      showToast('M·ªôt ho·∫∑c nhi·ªÅu m√£ ƒë√£ h·∫øt hi·ªáu l·ª±c v√† ƒë√£ ƒë∆∞·ª£c g·ª°. Vui l√≤ng ki·ªÉm tra l·∫°i t·ªïng ti·ªÅn r·ªìi b·∫•m thanh to√°n l·∫°i.', 'warning', { duration: 5000 });
      return { proceed: false, removed: true };
    }
    return { proceed: true, removed: false };
  }

  // === NEW: Gi·ªõi h·∫°n theo DECIMAL(18,2) ===
  const DECIMAL_TOTAL_DIGITS = 18;
  const DECIMAL_SCALE = 2;
  const MAX_CENTS_BIG = BigInt('9'.repeat(DECIMAL_TOTAL_DIGITS));          // 999... (18 s·ªë 9)
  const MAX_VND_BIG = 1000000000000000n;

  function clampCashToDbLimit(raw) {
    // Nh·∫≠n string b·∫•t k·ª≥ (c√≥ th·ªÉ c√≥ d·∫•u ch·∫•m), tr·∫£ v·ªÅ { digits, over }
    let digits = String(raw || '').replace(/[^\d]/g, '');
    if (digits === '') digits = '0';
    let over = false;
    try {
      let val = BigInt(digits);
      if (val > MAX_VND_BIG) { val = MAX_VND_BIG; over = true; }
      return { digits: val.toString(), over };
    } catch {
      // N·∫øu parse l·ªói th√¨ coi nh∆∞ 0
      return { digits: '0', over: true };
    }
  }

  function formatBigVndDigits(digitsStr) {
    // D√πng l·∫°i style "12.345" nh∆∞ √¥ input ti·ªÅn m·∫∑t
    return String(digitsStr).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }

  async function revalidateVouchersOnPaymentChange() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    await reapplyCurrentOrderVoucher();
    await reapplyCurrentShipVoucher();
    await fetchVouchers();                 // <<<<<< ƒë·∫£m b·∫£o UI voucher ƒë√∫ng theo PTTT m·ªõi
    updateSummary(tab);
    showToast('ƒê√£ ki·ªÉm tra l·∫°i ƒëi·ªÅu ki·ªán m√£ theo ph∆∞∆°ng th·ª©c thanh to√°n m·ªõi.', 'info');
  }


  const DEFAULT_PHONE_PLACEHOLDER = 'Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng';
  function normalizeVNPhone(raw) {
    let s = String(raw || '').trim();
    s = s.replace(/[^\d+]/g, '');       // gi·ªØ s·ªë v√† d·∫•u + ƒë·∫ßu chu·ªói
    if (s.startsWith('+84')) s = '0' + s.slice(3);
    return s.replace(/\D/g, '');        // ch·ªâ c√≤n s·ªë
  }
  function isValidVNPhone(raw) {
    const n = normalizeVNPhone(raw);
    // di ƒë·ªông 10 s·ªë: 0 + (3|5|7|8|9) + 8 s·ªë
    // c·ªë ƒë·ªãnh 11 s·ªë: 0 + 2 + 9 s·ªë
    return /^0(?:[35789]\d{8}|2\d{9})$/.test(n);
  }

  async function finalizePhoneInput() {
    const el = document.getElementById('customerPhone');
    if (!el) return '';

    // Chu·∫©n ho√° s·ªë: b·ªè k√Ω t·ª± l·∫°, +84 -> 0, ch·ªâ gi·ªØ s·ªë
    const n = normalizeVNPhone(el.value);

    // Validate (tr·ª´ m√£ ‚ÄúKh√°ch l·∫ª‚Äù)
    if (n && !isValidVNPhone(n) && n !== '0999999999') {
      showToast('SƒêT VN kh√¥ng h·ª£p l·ªá: di ƒë·ªông 10 s·ªë (03/05/07/08/09) ho·∫∑c c·ªë ƒë·ªãnh 11 s·ªë (02...)', 'warning');
      return '';
    }

    // Ghi gi√° tr·ªã ƒë√£ chu·∫©n ho√° v·ªÅ input
    el.value = n;

    // ƒê·ªìng b·ªô state & k√≠ch ho·∫°t lu·ªìng ƒë·ªïi kh√°ch chu·∫©n
    const tab = tabs.find(t => t.id === currentTabId);
    if (tab) {
      const prev = tab.customerPhone || '';
      const next = n || '';

      if (prev !== next) {
        // ‚ö†Ô∏è KH√ÅC KH√ÅCH: d√πng 1 entry-point chu·∫©n ƒë·ªÉ clear voucher, reset ship, n·∫°p l·∫°i d·ªØ li·ªáu
        await onCustomerChanged(next);
      } else {
        // Kh√¥ng ƒë·ªïi kh√°ch: ch·ªâ ƒë·ªìng b·ªô l·∫°i state hi·ªán t·∫°i
        tab.customerPhone = next;
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
      }
    }

    return n;
  }




  function clearAddressUI() {
    const addressSection          = document.getElementById('addressSection');
    const shippingFeeContainer    = document.getElementById('shippingFeeContainer');
    const shippingMethodContainer = document.getElementById('shippingMethodContainer');
    const addressSelect           = document.getElementById('addressSelect');

    addressSection?.classList.add('d-none');
    shippingFeeContainer?.classList.add('d-none');
    shippingMethodContainer?.classList.add('d-none');

    if (addressSelect) addressSelect.innerHTML = '<option value="">Ch·ªçn ƒë·ªãa ch·ªâ</option>';

    const tab = tabs.find(t => t.id === currentTabId);
    if (tab) {
      tab.selectedAddress   = '';
      tab.shippingFeeBase   = 0;
      tab.shippingDiscount  = 0;
      tab.shipVoucherId     = null;
      updateSummary(tab);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      updateShipSectionVisibility?.();
    }
  }
  function resetCash() {
    const tab = tabs.find(t => t.id === currentTabId);
    const cashEl = document.getElementById('cashAmount');
    if (cashEl) cashEl.value = '0';
    if (tab) {
      tab.cashAmount = 0;
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      updateSummary(tab);
    }
  }

  // === NEW: ·∫®n/hi·ªán option "Giao h√†ng" theo SƒêT kh√°ch ===
  function isRetailCustomer() {
    const tab = tabs.find(t => t.id === currentTabId);
    return !!(tab && tab.customerPhone === '0999999999');
  }
  function setDeliveryVisibilityForPhone(phone) {
    const select = document.getElementById('saleMethod');
    if (!select) return;
    const deliveryValue = 'Giao h√†ng';

    const ensureDeliveryOption = () => {
      if (![...select.options].some(o => o.value === deliveryValue)) {
        const opt = document.createElement('option');
        opt.value = deliveryValue;
        opt.textContent = 'üöö Giao h√†ng';
        select.add(opt);
      }
    };
    const removeDeliveryOption = () => {
      [...select.options].forEach(o => { if (o.value === deliveryValue) o.remove(); });
      // lu√¥n √©p v·ªÅ "T·∫°i qu·∫ßy" khi kh√¥ng cho giao h√†ng
      select.value = 'T·∫°i qu·∫ßy';
    };

    // üîí N·∫øu l√† Kh√°ch l·∫ª theo tab ho·∫∑c phone truy·ªÅn v√†o l√† 0999999999 -> c·∫•m giao h√†ng
    const retail = isRetailCustomer() || phone === '0999999999';
    if (retail) {
      removeDeliveryOption();

      // ·∫®n khu v·∫≠n chuy·ªÉn + reset ph√≠/phi·∫øu ship
      document.getElementById('addressSection')?.classList.add('d-none');
      document.getElementById('shippingFeeContainer')?.classList.add('d-none');
      document.getElementById('shippingMethodContainer')?.classList.add('d-none');

      const tab = tabs.find(t => t.id === currentTabId);
      if (tab) {
        const prevBase = Number(tab.shippingFeeBase || 0);
        tab.saleMethod = 'T·∫°i qu·∫ßy';
        tab.shippingFeeBase = 0;
        tab.shippingDiscount = 0;
        tab.shipVoucherId = null;
        updateSummary(tab);
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
        if (!isApplyingVoucher && prevBase !== 0) reapplyCurrentOrderVoucher?.();
        updateShipSectionVisibility?.();
      }
    } else {
      ensureDeliveryOption();
    }
  }
  // === Helper: re-apply / validate ORDER voucher hi·ªán t·∫°i ===
  async function reapplyCurrentOrderVoucher() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;
    const id = tab.orderVoucherId || tab.voucherId;
    if (!id || isApplyingVoucher) return;

    await applyVoucher(id); // applyVoucher ƒë√£ x·ª≠ l√Ω auto-clear n·∫øu fail
  }

  // === Helper: re-apply / validate SHIPPING voucher hi·ªán t·∫°i ===
  async function reapplyCurrentShipVoucher() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab || !tab.shipVoucherId || !isShippingEnabled() || isApplyingVoucher) return;
    try {
      isApplyingVoucher = true;
      const shippingFee = Number(tab.shippingFeeBase || 0);
      const res = await fetch(`${BASE_URL}/cart/apply-voucher?voucherId=${tab.shipVoucherId}&shippingFee=${shippingFee}&tabId=${currentTabId}&paymentMethodId=${encodeURIComponent(getSelectedPaymentMethodId())}`);
      if (!res.ok) {
        const removedId = tab.shipVoucherId;
        let msg = 'Phi·∫øu Freeship kh√¥ng c√≤n ƒë·ªß ƒëi·ªÅu ki·ªán, ƒë√£ g·ª° m√£.';
        try { const err = await res.json(); msg = err.error || err.message || msg; } catch {}
        tab.shipVoucherId = null;
        tab.shippingDiscount = 0;
        updateSummary(tab);
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
        // b·ªè ch·ªçn radio n·∫øu ƒëang m·ªü modal
        document.querySelectorAll('#voucherModal input[name="shipVoucher"]').forEach(r => {
          if (r.value === String(removedId)) r.checked = false;
        });
        showToast(msg, 'warning');
        return;
      }
      const data = await res.json();
      if (typeof data.phiVanChuyenGoc  !== 'undefined') tab.shippingFeeBase  = data.phiVanChuyenGoc;
      if (typeof data.giamGiaVanChuyen !== 'undefined') tab.shippingDiscount = data.giamGiaVanChuyen;
      updateSummary(tab);
    } finally {
      isApplyingVoucher = false;
    }
  }

  // ƒë·∫∑t g·∫ßn ƒë·∫ßu script
  const getAvailableStock = (item) =>
          Number(item?.availableStock ?? item?.stockQuantity ?? item?.soLuongTonKho ?? 0);

  // Chuy·ªÉn "12.345 VNƒê" -> 12345
  const unformatCurrency = (v) => parseInt(String(v).replace(/[^\d]/g, ''), 10) || 0;
  // Chuy·ªÉn 12345 -> "12.345"
  const formatCurrency = (n) => (Number(n) || 0).toLocaleString('vi-VN');

  const BASE_URL = '/acvstore/ban-hang';
  let tabs = [];
  let currentTabId = null;
  const MAX_TABS = 5;
  let currentProductId = null;
  let isUpdating = false;
  let isApplyingVoucher = false;       // ƒëang √°p voucher
  let isRecalculatingShipping = false; // ƒëang t√≠nh ph√≠ GHN
  // Prevent concurrent updates
  function getSelectedPaymentMethodId() {
    return document.getElementById('paymentMethod')?.value || "";
  }

  // ===== GHN CONFIG (t√°i d√πng nh∆∞ trang checkout) =====
  const SHOP_FROM_DISTRICT_ID = 1542; // Qu·∫≠n/Huy·ªán l·∫•y h√†ng c·ªßa shop
  const GHN_DEFAULT = {
    weightPerItem: 500, // gram
    length: 20, width: 15, height: 10, // cm
    insuranceValue: 100000 // VND
  };

  // GHN state/cache
  const GHN = {
    provinces: [],               // [{ProvinceID, ProvinceName}]
    districtsByProvince: {},     // { [provinceId]: [{DistrictID, DistrictName}] }
    wardsByDistrict: {}          // { [districtId]: [{WardCode, WardName}] }
  };

  // Chu·∫©n h√≥a chu·ªói ƒë·ªÉ so kh·ªõp t√™n h√†nh ch√≠nh
  const normalize = (str) => (str || "")
          .toLowerCase()
          .replace(/(t·ªânh|th√†nh ph·ªë|qu·∫≠n|huy·ªán|th·ªã x√£|ph∆∞·ªùng|x√£|th·ªã tr·∫•n)/gi, "")
          .replace(/[\s\.\-]/g, "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

  // L·∫•y danh s√°ch T·ªânh/Th√†nh t·ª´ GHN
  async function ghnLoadProvinces() {
    if (GHN.provinces.length) return GHN.provinces;
    const res = await fetch('/api/ghn/provinces');
    const json = await res.json();
    const parsed = JSON.parse(json.data);
    GHN.provinces = parsed.data || [];
    return GHN.provinces;
  }

  // L·∫•y Qu·∫≠n/Huy·ªán theo ProvinceID t·ª´ GHN (c√≥ cache)
  async function ghnLoadDistricts(provinceId) {
    if (GHN.districtsByProvince[provinceId]) return GHN.districtsByProvince[provinceId];
    const res = await fetch(`/api/ghn/districts?provinceId=${provinceId}`);
    const json = await res.json();
    const parsed = JSON.parse(json.data);
    GHN.districtsByProvince[provinceId] = parsed.data || [];
    return GHN.districtsByProvince[provinceId];
  }

  // L·∫•y Ph∆∞·ªùng/X√£ theo DistrictID t·ª´ GHN (c√≥ cache)
  async function ghnLoadWards(districtId) {
    if (GHN.wardsByDistrict[districtId]) return GHN.wardsByDistrict[districtId];
    const res = await fetch(`/api/ghn/wards?districtId=${districtId}`);
    const json = await res.json();
    const parsed = JSON.parse(json.data);
    GHN.wardsByDistrict[districtId] = parsed.data || [];
    return GHN.wardsByDistrict[districtId];
  }

  // Parse "S·ªë nh√†, Ph∆∞·ªùng, Qu·∫≠n, T·ªânh" -> m√£ GHN
  async function mapAddressTextToGhnCodes(fullAddress) {
    // K·ª≥ v·ªçng: "... , <Ph∆∞·ªùng/X√£> , <Qu·∫≠n/Huy·ªán> , <T·ªânh/Th√†nh>"
    const parts = (fullAddress || '').split(',').map(s => s.trim()).filter(Boolean);
    if (parts.length < 3) throw new Error('ƒê·ªãa ch·ªâ kh√¥ng ƒë·ªß 3 ph·∫ßn: ph∆∞·ªùng, qu·∫≠n, t·ªânh.');

    const wardName     = parts[parts.length - 3];
    const districtName = parts[parts.length - 2];
    const provinceName = parts[parts.length - 1];

    await ghnLoadProvinces();
    const province = GHN.provinces.find(p =>
            normalize(p.ProvinceName).includes(normalize(provinceName))
    );
    if (!province) throw new Error('Kh√¥ng t√¨m th·∫•y T·ªânh/Th√†nh trong GHN.');

    const districts = await ghnLoadDistricts(province.ProvinceID);
    const district = districts.find(d =>
            normalize(d.DistrictName).includes(normalize(districtName))
    );
    if (!district) throw new Error('Kh√¥ng t√¨m th·∫•y Qu·∫≠n/Huy·ªán trong GHN.');

    const wards = await ghnLoadWards(district.DistrictID);
    const ward = wards.find(w =>
            normalize(w.WardName).includes(normalize(wardName))
    );
    if (!ward) throw new Error('Kh√¥ng t√¨m th·∫•y Ph∆∞·ªùng/X√£ trong GHN.');

    return {
      provinceId: province.ProvinceID,
      districtId: district.DistrictID,
      wardCode: ward.WardCode
    };
  }

  function zeroShippingBecauseNoAddress() {
    const shippingFeeInput = document.getElementById('shippingFee');
    const shippingMethodContainer = document.getElementById('shippingMethodContainer');
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const prevBase = Number(tab.shippingFeeBase || 0);

    // reset ph√≠ ship v·ªÅ 0 theo m√¥ h√¨nh base/discount
    tab.shippingFeeBase = 0;
    tab.shippingDiscount = 0;
    tab.shipVoucherId = null; // <<< clear Freeship n·∫øu kh√¥ng c√≤n ƒë·ªãa ch·ªâ

    if (shippingFeeInput) shippingFeeInput.value = formatCurrency(0);
    updateSummary(tab);
    localStorage.setItem('orderTabs', JSON.stringify(tabs));

    if (!isApplyingVoucher && prevBase !== 0) {
      reapplyCurrentOrderVoucher();
      // (ship ƒë√£ ƒë∆∞·ª£c clear ·ªü ƒë√¢y n√™n kh√¥ng c·∫ßn re-apply ship)
    }
    shippingMethodContainer?.classList.add('d-none');

    // ·∫®n khu Freeship trong modal
    updateShipSectionVisibility();
  }






  function setShippingUiLoading(isLoading) {
    const status = document.getElementById('shippingCalcStatus');
    if (!status) return;
    status.classList.toggle('d-none', !isLoading);
    status.textContent = isLoading ? 'ƒêang t√≠nh ph√≠ GHN‚Ä¶' : '';
  }

  async function ghnLoadServices(toDistrictId) {
    const select = document.getElementById('shippingMethod');
    if (!select) return [];
    select.innerHTML = '';
    const res = await fetch(`/api/ghn/available-services?fromDistrictId=${SHOP_FROM_DISTRICT_ID}&toDistrictId=${toDistrictId}`);
    const json = await res.json();
    const services = (JSON.parse(json.data).data) || [];

    services.forEach(sv => {
      const opt = document.createElement('option');
      opt.value = sv.service_id;
      opt.text = `${sv.short_name || 'GHN'} (type ${sv.service_type_id})`;
      select.appendChild(opt);
    });
    return services;
  }

  function computePackageFromCart(tab) {
    // G·ªôp c√¢n n·∫∑ng theo s·ªë l∆∞·ª£ng ‚Äì m·ªói sp 0.5kg (500g)
    const totalQty = (tab.cart || []).reduce((sum, item) => sum + (parseInt(item.soLuong) || 0), 0);
    const weight = Math.max(1, totalQty) * GHN_DEFAULT.weightPerItem; // gram
    return {
      weight,
      length: GHN_DEFAULT.length,
      width:  GHN_DEFAULT.width,
      height: GHN_DEFAULT.height,
      insuranceValue: GHN_DEFAULT.insuranceValue
    };
  }

  async function ghnCalculateShipping({ districtId, wardCode }) {
    const serviceSelect = document.getElementById('shippingMethod');
    if (!serviceSelect || !serviceSelect.value) return null;

    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return null;

    const pkg = computePackageFromCart(tab);
    const url = `/api/ghn/shipping-fee?fromDistrictId=${SHOP_FROM_DISTRICT_ID}`
            + `&toDistrictId=${districtId}`
            + `&toWardCode=${wardCode}`
            + `&weight=${pkg.weight}`
            + `&length=${pkg.length}`
            + `&width=${pkg.width}`
            + `&height=${pkg.height}`
            + `&serviceId=${serviceSelect.value}`
            + `&insuranceValue=${pkg.insuranceValue}`;

    const res = await fetch(url);
    const json = await res.json();
    const fee = JSON.parse(json.data).data.total;
    return fee || 0;
  }

  async function setupShippingForSelectedAddress({ recalcOnly = false } = {}) {
    const tab = tabs.find(t => t.id === currentTabId);
    const shippingFeeInput = document.getElementById('shippingFee');
    const shippingMethodContainer = document.getElementById('shippingMethodContainer');
    const addressSelect = document.getElementById('addressSelect');

    if (!tab) return;

    if (tab.saleMethod !== 'Giao h√†ng') {
      shippingMethodContainer?.classList.add('d-none');
      const prevBase = Number(tab.shippingFeeBase || 0);
      if (prevBase !== 0 || Number(tab.shippingDiscount || 0) !== 0) {
        tab.shippingFeeBase = 0;
        tab.shippingDiscount = 0;
        tab.shipVoucherId = null;
        if (shippingFeeInput) shippingFeeInput.value = formatCurrency(0);
        updateSummary(tab);
        if (tab.orderVoucherId && !isApplyingVoucher && prevBase !== 0) await applyVoucher(tab.orderVoucherId);
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
      }
      updateShipSectionVisibility();
      return;
    }

    tab.selectedAddress = (tab.selectedAddress || addressSelect?.value || '').trim();
    if (!tab.selectedAddress) {
      zeroShippingBecauseNoAddress();
      return;
    }

    if (isRecalculatingShipping) return;
    isRecalculatingShipping = true;

    try {
      setShippingUiLoading(true);
      shippingMethodContainer?.classList.remove('d-none');

      const { districtId, wardCode } = await mapAddressTextToGhnCodes(tab.selectedAddress);

      if (!recalcOnly) {
        const services = await ghnLoadServices(districtId);
        if (!services.length) {
          showToast('Kh√¥ng c√≥ d·ªãch v·ª• GHN kh·∫£ d·ª•ng cho qu·∫≠n n√†y.', 'warning');
          zeroShippingBecauseNoAddress();
          return;
        }
        const select = document.getElementById('shippingMethod');
        if (select && !select.value && services[0]) {
          select.value = services[0].service_id;
        }
      }

      const select = document.getElementById('shippingMethod');
      if (select && !select.value) {
        const services = await ghnLoadServices(districtId);
        if (services[0]) select.value = services[0].service_id;
      }

      if (!document.getElementById('shippingMethod')?.value) {
        showToast('Ch∆∞a ch·ªçn d·ªãch v·ª• GHN.', 'warning');
        zeroShippingBecauseNoAddress();
        return;
      }

      const prevBase = Number(tab.shippingFeeBase || 0);
      const fee = await ghnCalculateShipping({ districtId, wardCode });
      const shippingFee = Number.isFinite(fee) ? fee : 0;

      if (shippingFeeInput) shippingFeeInput.value = formatCurrency(shippingFee);
      tab.shippingFeeBase = shippingFee;

      updateSummary(tab);

      // --- RE-APPLY ORDER n·∫øu base thay ƒë·ªïi ---
      if (tab.orderVoucherId && !isApplyingVoucher && prevBase !== shippingFee) {
        await applyVoucher(tab.orderVoucherId);
      }

      // --- RE-APPLY SHIPPING n·∫øu base thay ƒë·ªïi ---
      if (tab.shipVoucherId && !isApplyingVoucher && prevBase !== shippingFee) {
        try {
          isApplyingVoucher = true;
          const res = await fetch(`${BASE_URL}/cart/apply-voucher?voucherId=${tab.shipVoucherId}&shippingFee=${shippingFee}&tabId=${currentTabId}&paymentMethodId=${encodeURIComponent(getSelectedPaymentMethodId())}`);
          if (res.ok) {
            const data = await res.json();
            if (typeof data.phiVanChuyenGoc  !== 'undefined') tab.shippingFeeBase  = data.phiVanChuyenGoc;
            if (typeof data.giamGiaVanChuyen !== 'undefined') tab.shippingDiscount = data.giamGiaVanChuyen;
            updateSummary(tab);
          } else {
            const removedId = tab.shipVoucherId;
            let msg = 'Kh√¥ng c√≤n ƒë·ªß ƒëi·ªÅu ki·ªán Freeship, ƒë√£ g·ª° m√£.';
            try { const err = await res.json(); msg = err.error || err.message || msg; } catch {}
            tab.shipVoucherId = null;
            tab.shippingDiscount = 0;
            updateSummary(tab);
            localStorage.setItem('orderTabs', JSON.stringify(tabs));
            document.querySelectorAll('#voucherModal input[name="shipVoucher"]').forEach(r => {
              if (r.value === String(removedId)) r.checked = false;
            });
            showToast(msg, 'warning');
          }
        } finally {
          isApplyingVoucher = false;
        }
      }

      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    } catch (err) {
      console.error('GHN setup/t√≠nh ph√≠ l·ªói:', err);
      showToast('Kh√¥ng t√≠nh ƒë∆∞·ª£c ph√≠ GHN. B·∫°n c√≥ th·ªÉ nh·∫≠p tay ph√≠ ship.', 'warning');
      zeroShippingBecauseNoAddress();
      shippingFeeInput?.removeAttribute('disabled');
      shippingFeeInput?.setAttribute('placeholder', 'Nh·∫≠p ph√≠ ship th·ªß c√¥ng');
    } finally {
      setShippingUiLoading(false);
      isRecalculatingShipping = false;
      updateShipSectionVisibility();
    }
  }




  function showToast(message, type = "info", opts = {}) {
    const {
      duration = 3000,      // th·ªùi gian t·ª± ·∫©n (ms)
      dismissible = true,   // c√≥ n√∫t ƒë√≥ng hay kh√¥ng
      maxToasts = 5         // gi·ªõi h·∫°n s·ªë toast hi·ªÉn th·ªã ƒë·ªìng th·ªùi
    } = opts;

    // 1) L·∫•y/kh·ªüi t·∫°o container
    let container = document.getElementById("toastContainer");
    if (!container) {
      container = document.createElement("div");
      container.id = "toastContainer";
      container.className = "position-fixed top-0 end-0 p-3";
      container.style.zIndex = 9999;
      document.body.appendChild(container);
    }

    // 2) Map m√†u & icon
    const bg = {
      success: "bg-success",
      error:   "bg-danger",
      warning: "bg-warning",
      info:    "bg-primary"
    };
    const icon = {
      success: "fas fa-check-circle",
      error:   "fas fa-exclamation-circle",
      warning: "fas fa-exclamation-triangle",
      info:    "fas fa-info-circle"
    };

    // 3) Escape text ƒë·ªÉ an to√†n
    const escapeHtml = (str) =>
            String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");

    // 4) T·∫°o toast
    const toast = document.createElement("div");
    toast.className = `toast show align-items-center text-white ${bg[type] || bg.info} border-0 shadow`;
    toast.setAttribute("role", "alert");
    toast.setAttribute("aria-live", "assertive");
    toast.setAttribute("aria-atomic", "true");

    toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body d-flex align-items-center gap-2">
        <i class="${icon[type] || icon.info}"></i>
        <span class="fw-medium">${escapeHtml(message)}</span>
      </div>
      ${dismissible
            ? `<button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>`
            : ""
    }
    </div>
  `;

    // 5) Th√™m l√™n ƒê·∫¶U ƒë·ªÉ toast m·ªõi n·∫±m tr√™n
    container.prepend(toast);

    // 6) T·ª± ·∫©n + cho ph√©p ƒë√≥ng tay
    const removeToast = () => {
      toast.classList.remove("show");
      // ch·ªù transition .3s r·ªìi remove
      setTimeout(() => toast.remove(), 300);
    };

    let timerId = null;
    if (duration > 0) {
      timerId = setTimeout(removeToast, duration);
    }

    if (dismissible) {
      toast.querySelector(".btn-close")?.addEventListener("click", (e) => {
        e.stopPropagation();
        if (timerId) clearTimeout(timerId);
        removeToast();
      });
    }

    // 7) Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng toast
    while (container.children.length > maxToasts) {
      container.lastElementChild?.remove();
    }
  }

  // C·∫£i thi·ªán h√†m renderCart v·ªõi ki·ªÉm tra t·ªìn kho ch√≠nh x√°c
  function renderCart(cart) {
    const tbody = document.getElementById("cartItems");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!cart || cart.length === 0) {
      const emptyRow = document.createElement("tr");
      emptyRow.innerHTML = `
      <td colspan="8" class="text-center py-5">
        <div class="d-flex flex-column align-items-center gap-3 text-muted">
          <i class="fas fa-shopping-cart" style="font-size: 4rem; opacity: 0.3;"></i>
          <p class="fs-4 fw-medium">Gi·ªè h√†ng tr·ªëng</p>
          <p class="small">H√£y th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng</p>
        </div>
      </td>
    `;
      tbody.appendChild(emptyRow);
      return;
    }

    cart.forEach((item, index) => {
      const row = document.createElement("tr");

      const actualStock = getAvailableStock(item);
      const currentQuantity = parseInt(item.soLuong || 0);
      const maxAllowed = currentQuantity + Math.max(0, actualStock);

      const price = parseFloat(item.gia || 0);
      const totalPrice = parseFloat(item.thanhTien || 0);
      const originalPrice = parseFloat(item.originalPrice || item.gia);
      const phanTramGiam = parseFloat(item.phanTramGiam || 0);

      const isMinQuantity = currentQuantity <= 1;
      const isMaxQuantity = maxAllowed <= currentQuantity;
      const isOverStock = actualStock < 0;

      const stockWarning = isOverStock
              ? `<div class="stock-warning"><i class="fas fa-exclamation-triangle"></i>T·ªìn kho √¢m (${actualStock})</div>`
              : actualStock === 0
                      ? `<div class="stock-warning"><i class="fas fa-exclamation-triangle"></i>H·∫øt t·ªìn kho kh·∫£ d·ª•ng</div>`
                      : "";

      const priceDisplay = phanTramGiam > 0
              ? `<span class="fw-bold">${price.toLocaleString("vi-VN")} VNƒê</span>
               <div class="small text-muted text-decoration-line-through">${originalPrice.toLocaleString("vi-VN")} VNƒê</div>
               <div class="small text-success">Gi·∫£m ${phanTramGiam}%</div>`
              : `<span class="fw-bold">${price.toLocaleString("vi-VN")} VNƒê</span>`;

      row.innerHTML = `
      <td>
        <img src="${item.hinhAnh || "https://via.placeholder.com/60x60?text=No+Image"}"
             alt="H√¨nh ·∫£nh"
             class="rounded shadow-sm"
             style="width: 60px; height: 60px; object-fit: cover;"
             onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
      </td>
      <td>
        <div class="fw-semibold">${item.tenSanPham || "N/A"}</div>
        <div class="small text-muted">T·ªìn kho kh·∫£ d·ª•ng: ${actualStock}</div>
      </td>
      <td>
        <span class="badge badge-primary">
          ${item.mauSac || "N/A"}
        </span>
      </td>
      <td>
        <span class="badge badge-secondary">
          ${item.kichCo || "N/A"}
        </span>
      </td>
      <td>
        ${priceDisplay}
      </td>
      <td>
        <div class="quantity-controls" data-index="${index}">
          <button class="quantity-btn btn btn-danger btn-sm ${isMinQuantity ? "disabled" : ""}"
                  ${isMinQuantity ? "disabled" : ""}
                  onclick="updateQuantity(${index}, -1, '${item.idChiTietSanPham}', ${maxAllowed})"
                  title="${isMinQuantity ? "Kh√¥ng th·ªÉ gi·∫£m th√™m" : "Gi·∫£m s·ªë l∆∞·ª£ng"}">
            <i class="fas fa-minus"></i>
          </button>
          <input type="number"
                 min="1"
                 value="${currentQuantity}"
                 max="${maxAllowed}"
                 class="form-control form-control-sm text-center fw-bold ${isOverStock ? "text-danger" : ""}"
                 style="width: 70px;"
                 onchange="updateQuantityFromInput(${index}, this.value, '${item.idChiTietSanPham}', ${maxAllowed})"
                 onblur="validateQuantityInput(this, ${maxAllowed}, ${index})">
          <button class="quantity-btn btn btn-success btn-sm ${isMaxQuantity ? "disabled" : ""}"
                  ${isMaxQuantity ? "disabled" : ""}
                  onclick="updateQuantity(${index}, 1, '${item.idChiTietSanPham}', ${maxAllowed})"
                  title="${isMaxQuantity ? "H·∫øt t·ªìn kho kh·∫£ d·ª•ng" : "TƒÉng s·ªë l∆∞·ª£ng"}">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        ${stockWarning}
      </td>
      <td>
        <span class="fw-bold fs-5 text-success">${totalPrice.toLocaleString("vi-VN")} VNƒê</span>
      </td>
      <td>
        <button class="btn btn-danger btn-sm d-flex align-items-center gap-2"
                onclick="removeItem(${index}, '${item.idChiTietSanPham}')">
          <i class="fas fa-trash"></i>
          <span class="d-none d-sm-inline">X√≥a</span>
        </button>
      </td>
    `;
      tbody.appendChild(row);
    });
  }

  // C·∫£i thi·ªán h√†m updateQuantity v·ªõi ki·ªÉm tra t·ªìn kho ch·∫∑t ch·∫Ω
  async function updateQuantity(index, delta, productDetailId, maxAllowed) {
    if (isUpdating) {
      showToast("ƒêang x·ª≠ l√Ω, vui l√≤ng ƒë·ª£i...", "warning");
      return;
    }

    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab || !tab.cart[index]) {
      showToast("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m trong gi·ªè h√†ng.", "error");
      return;
    }

    const currentItem = tab.cart[index];
    const currentQuantity = parseInt(currentItem.soLuong || 0);
    let newQuantity = currentQuantity + delta;

    if (Number.isFinite(maxAllowed) && newQuantity > maxAllowed) {
      showToast(`S·ªë l∆∞·ª£ng t·ªëi ƒëa l√† ${maxAllowed}.`, "warning");
      return;
    }

    if (newQuantity < 1) {
      newQuantity = 1;
      showToast("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0.", "warning");
      return;
    }

    isUpdating = true;
    const quantityControls = document.querySelector(`.quantity-controls[data-index="${index}"]`);
    if (quantityControls) {
      quantityControls.classList.add("loading");
    }

    try {
      const requestData = {
        productDetailId: String(productDetailId),
        quantity: parseInt(newQuantity),
        shippingFee: parseFloat(tab.shippingFeeBase || 0),
        tabId: String(currentTabId),
      };

      const response = await fetch(`${BASE_URL}/cart/update`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestData),
      });

      if (!response.ok) {
        let errorMessage = "L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      await refreshCartFromServer();
      await reapplyCurrentOrderVoucher();
      await reapplyCurrentShipVoucher();

      showToast("ƒê√£ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng!", "success");
    } catch (error) {
      console.error("L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng:", error);
      showToast("L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng: " + error.message, "error");
      await refreshCartFromServer();
      await reapplyCurrentOrderVoucher();
      await reapplyCurrentShipVoucher();
    } finally {
      isUpdating = false;
      if (quantityControls) {
        quantityControls.classList.remove("loading");
      }
    }
  }


  // H√†m m·ªõi ƒë·ªÉ x·ª≠ l√Ω input tr·ª±c ti·∫øp t·ª´ √¥ nh·∫≠p s·ªë l∆∞·ª£ng
  async function updateQuantityFromInput(index, inputValue, productDetailId, maxAllowed) {
    const quantity = parseInt(inputValue);
    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab || !tab.cart[index]) return;

    const currentQuantity = parseInt(tab.cart[index].soLuong);

    if (isNaN(quantity) || quantity < 1) {
      showToast("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá (‚â• 1).", "warning");
      const input = document.querySelector(`.quantity-controls[data-index="${index}"] input`);
      if (input) input.value = currentQuantity;
      return;
    }

    if (Number.isFinite(maxAllowed) && quantity > maxAllowed) {
      showToast(`S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${maxAllowed}.`, "warning");
      const input = document.querySelector(`.quantity-controls[data-index="${index}"] input`);
      if (input) input.value = Math.min(currentQuantity, maxAllowed);
      return;
    }

    const delta = quantity - currentQuantity;
    if (delta !== 0) await updateQuantity(index, delta, productDetailId, maxAllowed);
  }

  // H√†m validate input khi ng∆∞·ªùi d√πng r·ªùi kh·ªèi √¥ nh·∫≠p
  function validateQuantityInput(inputElement, maxAllowed, index) {
    const value = parseInt(inputElement.value);
    const tab = tabs.find((t) => t.id === currentTabId);

    if (!tab || !tab.cart[index]) return;

    const currentQuantity = parseInt(tab.cart[index].soLuong);

    if (isNaN(value) || value < 1) {
      inputElement.value = currentQuantity;
      showToast("S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu l√† 1.", "warning");
    } else if (Number.isFinite(maxAllowed) && value > maxAllowed) {
      inputElement.value = Math.min(currentQuantity, maxAllowed);
      showToast(`S·ªë l∆∞·ª£ng t·ªëi ƒëa l√† ${maxAllowed}.`, "warning");
    }
  }

  // H√†m l√†m m·ªõi gi·ªè h√†ng t·ª´ server khi c√≥ l·ªói
  async function refreshCartFromServer() {
    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab) return;

    try {
      const response = await fetch(`${BASE_URL}/cart/get?tabId=${currentTabId}&shippingFee=${tab.shippingFeeBase}`);
      if (response.ok) {
        const cartData = await response.json();
        tab.cart     = cartData.danhSachSanPham || [];
        tab.subTotal = cartData.tongTienHang    || 0;
        tab.discount = cartData.giamGia         || 0;
        tab.total    = cartData.tong            || 0;

        // map fields m·ªõi n·∫øu BE tr·∫£ v·ªÅ
        if (typeof cartData.phiVanChuyenGoc  !== 'undefined') tab.shippingFeeBase  = cartData.phiVanChuyenGoc;
        if (typeof cartData.giamGiaVanChuyen !== 'undefined') tab.shippingDiscount = cartData.giamGiaVanChuyen;
        // fallback legacy
        if (typeof cartData.phiVanChuyen !== 'undefined' && typeof cartData.phiVanChuyenGoc === 'undefined') {
          tab.shippingFeeBase = cartData.phiVanChuyen || 0;
        }

        renderCart(tab.cart);
        updateSummary(tab);
        localStorage.setItem("orderTabs", JSON.stringify(tabs));
      }
    } catch (error) {
      console.error("L·ªói khi l√†m m·ªõi gi·ªè h√†ng:", error);
      showToast("Kh√¥ng th·ªÉ l√†m m·ªõi gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.", "error");
    }
  }


  // C·∫£i thi·ªán h√†m th√™m s·∫£n ph·∫©m v·ªõi ki·ªÉm tra t·ªìn kho
  async function addVariantToCart() {
    const productDetailId = document.getElementById("variantDetails").dataset.productDetailId;
    const quantity = parseInt(document.getElementById("variantQuantity").value);
    const maxStock = parseInt(document.getElementById("variantQuantity").max);

    if (!productDetailId) {
      showToast("Vui l√≤ng ch·ªçn bi·∫øn th·ªÉ s·∫£n ph·∫©m.", "warning");
      return;
    }

    if (isNaN(quantity) || quantity < 1) {
      showToast("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá (‚â• 1).", "warning");
      return;
    }

    if (quantity > maxStock) {
      showToast(`S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${maxStock} (t·ªìn kho kh·∫£ d·ª•ng).`, "warning");
      return;
    }

    try {
      const tab = tabs.find((t) => t.id === currentTabId);
      if (!tab) throw new Error("Kh√¥ng t√¨m th·∫•y tab hi·ªán t·∫°i.");

      const existingIndex = tab.cart.findIndex((item) => item.idChiTietSanPham === productDetailId);
      if (existingIndex >= 0) {
        const currentQuantity = tab.cart[existingIndex].soLuong;
        const available   = Number(maxStock);
        const maxAllowed  = currentQuantity + Math.max(0, available);
        const newTotalQuantity = currentQuantity + quantity;

        if (newTotalQuantity > maxAllowed) {
          showToast(`T·ªïng s·ªë l∆∞·ª£ng t·ªëi ƒëa l√† ${maxAllowed}.`, "warning");
          return;
        }
        await updateQuantity(existingIndex, quantity, productDetailId, maxAllowed);
        document.getElementById("variantModal").style.display = "none";
        return;
      }

      const requestData = {
        productDetailId: String(productDetailId),
        quantity: parseInt(quantity),
        shippingFee: parseFloat(tab.shippingFeeBase || 0),
        tabId: String(currentTabId),
      };

      const response = await fetch(`${BASE_URL}/cart/add`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestData),
      });

      if (!response.ok) {
        let errorMessage = "L·ªói khi th√™m s·∫£n ph·∫©m.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      document.getElementById("variantModal").style.display = "none";
      await refreshCartFromServer();
      await reapplyCurrentOrderVoucher();
      await reapplyCurrentShipVoucher();
      showToast("ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!", "success");
    } catch (error) {
      console.error("L·ªói khi th√™m bi·∫øn th·ªÉ:", error);
      showToast("L·ªói khi th√™m s·∫£n ph·∫©m: " + error.message, "error");
    }
  }


  // C·∫≠p nh·∫≠t h√†m renderTabs v·ªõi styling m·ªõi
  function renderTabs() {
    const tabsContainer = document.getElementById('orderTabs');
    if (!tabsContainer) return;

    tabsContainer.innerHTML = '';

    tabs.sort((a, b) => a.id - b.id).forEach(tab => {
      const tabElement = document.createElement('div');
      tabElement.className = `tab ${tab.id === currentTabId ? 'active' : ''}`;

      const tabContent = document.createElement('div');
      tabContent.className = 'd-flex align-items-center gap-2';
      tabContent.innerHTML = `
        <i class="fas fa-receipt"></i>
        <span class="fw-semibold">ƒê∆°n ${tab.id}</span>
      `;

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-danger btn-sm rounded-circle ms-2 d-flex align-items-center justify-content-center';
      deleteBtn.style.width = '24px';
      deleteBtn.style.height = '24px';
      deleteBtn.innerHTML = '<i class="fas fa-xmark fa-sm"></i>';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteTab(tab.id);
      };

      tabContent.appendChild(deleteBtn);
      tabElement.appendChild(tabContent);
      tabElement.onclick = () => switchTab(tab.id);
      tabsContainer.appendChild(tabElement);
    });

    const addTabBtn = document.getElementById('addTabBtn');
    if (addTabBtn) {
      addTabBtn.disabled = tabs.length >= MAX_TABS;
    }
  }

  // Th√™m s·∫£n ph·∫©m b·∫±ng QR
  async function addProductByQr(productDetailId) {
    try {
      const tab = tabs.find(t => t.id === currentTabId);
      if (!tab) throw new Error('Kh√¥ng t√¨m th·∫•y tab hi·ªán t·∫°i.');

      // Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i
      const existingIndex = tab.cart.findIndex(item => item.idChiTietSanPham === productDetailId);
      if (existingIndex >= 0) {
        const currentQuantity = Number(tab.cart[existingIndex].soLuong || 0);
        const available       = getAvailableStock(tab.cart[existingIndex]);
        const maxAllowed      = currentQuantity + Math.max(0, available);
        await updateQuantity(existingIndex, 1, productDetailId, maxAllowed);
        return;
      }

      const requestData = {
        productDetailId: String(productDetailId),
        quantity: 1,
        shippingFee: parseFloat(tab.shippingFeeBase || 0),
        tabId: String(currentTabId)
      };

      const response = await fetch(`${BASE_URL}/cart/add`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        let errorMessage = "L·ªói khi th√™m s·∫£n ph·∫©m.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      await refreshCartFromServer();
      await reapplyCurrentOrderVoucher();
      await reapplyCurrentShipVoucher();
      showToast('ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!', 'success');
    } catch (error) {
      console.error('L·ªói khi th√™m s·∫£n ph·∫©m:', error);
      showToast('L·ªói khi th√™m s·∫£n ph·∫©m: ' + error.message, 'error');
    }
  }

  // C·∫≠p nh·∫≠t gi·ªè h√†ng t·ª´ response
  function updateCartFromResponse(data) {
    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab) return;

    tab.cart     = data.danhSachSanPham || [];
    tab.subTotal = data.tongTienHang    || 0;
    tab.discount = data.giamGia         || 0;
    tab.total    = data.tong            || 0;

    // map fields m·ªõi n·∫øu BE tr·∫£ v·ªÅ
    if (typeof data.phiVanChuyenGoc  !== 'undefined') tab.shippingFeeBase  = data.phiVanChuyenGoc;
    if (typeof data.giamGiaVanChuyen !== 'undefined') tab.shippingDiscount = data.giamGiaVanChuyen;
    // fallback legacy
    if (typeof data.phiVanChuyen !== 'undefined' && typeof data.phiVanChuyenGoc === 'undefined') {
      tab.shippingFeeBase = data.phiVanChuyen || 0;
    }

    renderCart(tab.cart);
    updateSummary(tab);

    // ‚õî ƒë·ª´ng recalc ship n·∫øu ƒëang apply voucher
    if (tab.saleMethod === 'Giao h√†ng' && tab.selectedAddress && !isApplyingVoucher) {
      setupShippingForSelectedAddress({ recalcOnly: true });
    }

    localStorage.setItem("orderTabs", JSON.stringify(tabs));
    fetchVouchers();
  }




  // Kh·ªüi t·∫°o tabs
  async function initTabs() {
    try {
      const savedTabs = localStorage.getItem('orderTabs');
      const savedTabId = localStorage.getItem('currentTabId');

      if (savedTabs && savedTabId) {
        tabs = JSON.parse(savedTabs);

        // migrate t·ª´ d·ªØ li·ªáu c≈© (shippingFee -> shippingFeeBase)
        tabs.forEach(tab => {
          if (typeof tab.shippingFeeBase === 'undefined') tab.shippingFeeBase = Number(tab.shippingFee || 0);
          if (typeof tab.shippingDiscount === 'undefined') tab.shippingDiscount = 0;
          if (!tab.paymentMethod || tab.paymentMethod !== '550E8400-E29B-41D4-A716-446655440018') {
            tab.paymentMethod = '550E8400-E29B-41D4-A716-446655440017';
          }
        });

        currentTabId = parseInt(savedTabId);
        tabs.sort((a, b) => a.id - b.id);
        renderTabs();
        loadTabContent(currentTabId);
        return;
      }

      await addNewTab();
    } catch (error) {
      console.error('L·ªói khi kh·ªüi t·∫°o tabs:', error);
      showToast('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      await addNewTab();
    }
  }


  function getNextTabId() {
    for (let i = 1; i <= MAX_TABS; i++) {
      if (!tabs.some(tab => tab.id === i)) return i;
    }
    return tabs.length + 1;
  }

  async function addNewTab() {
    if (tabs.length >= MAX_TABS) {
      showToast('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 5 ƒë∆°n h√†ng.', 'warning');
      return;
    }

    try {
      const newTabId = getNextTabId();

      // X√≥a gi·ªè h√†ng c≈© tr∆∞·ªõc khi t·∫°o tab m·ªõi
      await fetch(`${BASE_URL}/cart/clear?tabId=${newTabId}`, { method: 'POST' });

      const newTab = {
        id: newTabId,
        cart: [],
        customerPhone: '',
        customerName: '',
        customerEmail: '',
        saleMethod: 'T·∫°i qu·∫ßy',

        // ======= PH√ç V·∫¨N CHUY·ªÇN (m√¥ h√¨nh g·ªëc/gi·∫£m) =======
        shippingFeeBase: 0,      // ph√≠ ship g·ªëc (GHN tr·∫£ v·ªÅ)
        shippingDiscount: 0,     // gi·∫£m ph√≠ ship (voucher SHIPPING)

        // ======= VOUCHER =======
        voucherId: null,         // backward-compatible: id voucher ORDER ƒëang √°p qua applyVoucher()
        orderVoucherId: null,    // t√°ch ri√™ng ORDER
        shipVoucherId:  null,    // t√°ch ri√™ng SHIPPING (freeship)

        paymentMethod: '550E8400-E29B-41D4-A716-446655440017', // m·∫∑c ƒë·ªãnh ti·ªÅn m·∫∑t
        cashAmount: 0,

        // ======= T·ªîNG H·ª¢P =======
        subTotal: 0,
        discount: 0,             // gi·∫£m gi√° ƒë∆°n (ORDER)
        total: 0,

        // ======= ƒê·ªäA CH·ªà =======
        addresses: [],
        selectedAddress: ''
      };

      tabs.push(newTab);
      currentTabId = newTab.id;
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      localStorage.setItem('currentTabId', currentTabId);
      renderTabs();
      loadTabContent(currentTabId);

      setTimeout(() => {
        const saleMethodEl = document.getElementById('saleMethod');
        const addressSection = document.getElementById('addressSection');
        const shippingFeeContainer = document.getElementById('shippingFeeContainer');
        const shippingMethodContainer = document.getElementById('shippingMethodContainer');

        if (saleMethodEl) saleMethodEl.value = 'T·∫°i qu·∫ßy';
        addressSection?.classList.add('d-none');
        shippingFeeContainer?.classList.add('d-none');
        shippingMethodContainer?.classList.add('d-none');

        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.saleMethod = 'T·∫°i qu·∫ßy';
          tab.shippingFeeBase = 0;
          tab.shippingDiscount = 0;
          tab.shipVoucherId = null;
          updateSummary(tab);
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
        const phoneEl = document.getElementById('customerPhone');
        if (phoneEl) {
          phoneEl.value = '';
          phoneEl.placeholder = DEFAULT_PHONE_PLACEHOLDER;
        }
        updateShipSectionVisibility();
        resetCash();
      }, 0);
    } catch (error) {
      showToast('L·ªói khi t·∫°o tab m·ªõi: ' + error.message, 'error');
    }
  }



  function switchTab(tabId) {
    currentTabId = tabId;
    localStorage.setItem('currentTabId', currentTabId);
    renderTabs();
    loadTabContent(tabId);
  }

  async function deleteTab(tabId) {
    if (tabs.length <= 1) {
      showToast("Ph·∫£i gi·ªØ √≠t nh·∫•t m·ªôt tab.", "warning");
      return;
    }

    try {
      await fetch(`${BASE_URL}/cart/clear?tabId=${tabId}`, { method: "POST" });
      tabs = tabs.filter(t => t.id !== tabId);
      if (currentTabId === tabId) {
        currentTabId = tabs.length > 0 ? tabs[tabs.length - 1].id : null;
      }

      localStorage.setItem("orderTabs", JSON.stringify(tabs));
      localStorage.setItem("currentTabId", currentTabId);
      renderTabs();

      if (currentTabId) {
        loadTabContent(currentTabId);
      }
      showToast("ƒê√£ x√≥a tab!", "success");
    } catch (error) {
      console.error("L·ªói khi x√≥a tab:", error);
      showToast("L·ªói khi x√≥a tab: " + error.message, "error");
    }
  }

  async function loadTabContent(tabId) {
    clearAddressUI();
    const tab = tabs.find(t => t.id === tabId);
    if (!tab) return;

    // ƒê·∫∑t ph∆∞∆°ng th·ª©c thanh to√°n m·∫∑c ƒë·ªãnh l√† Ti·ªÅn m·∫∑t n·∫øu kh√¥ng h·ª£p l·ªá
    if (!tab.paymentMethod || tab.paymentMethod !== '550E8400-E29B-41D4-A716-446655440018') {
      tab.paymentMethod = '550E8400-E29B-41D4-A716-446655440017';
    }

    const elements = {
      customerPhone: document.getElementById('customerPhone'),
      customerName: document.getElementById('customerName'),
      customerEmail: document.getElementById('customerEmail'),
      saleMethod: document.getElementById('saleMethod'),
      shippingFee: document.getElementById('shippingFee'),
      paymentMethod: document.getElementById('paymentMethod'),
      cashAmount: document.getElementById('cashAmount'),
      shippingFeeContainer: document.getElementById('shippingFeeContainer'),
      addressSection: document.getElementById('addressSection')
    };

    if (elements.customerPhone) {
      elements.customerPhone.placeholder = DEFAULT_PHONE_PLACEHOLDER;
    }

    if (elements.customerPhone) elements.customerPhone.value = tab.customerPhone || '';
    if (elements.customerName)  elements.customerName.value  = tab.customerName  || '';
    if (elements.customerEmail) elements.customerEmail.value = tab.customerEmail || '';
    if (elements.saleMethod) elements.saleMethod.value = tab.saleMethod;

    // Kh√°ch l·∫ª
    if (tab.customerPhone === '0999999999') {
      if (elements.customerPhone) {
        elements.customerPhone.value = '';
        elements.customerPhone.placeholder = 'Kh√°ch l·∫ª (kh√¥ng thu th·∫≠p SƒêT)';
      }
      if (elements.customerName)  elements.customerName.value  = 'Kh√°ch l·∫ª';
      if (elements.customerEmail) elements.customerEmail.value = '';

      if (elements.saleMethod) {
        elements.saleMethod.value = 'T·∫°i qu·∫ßy';
        elements.saleMethod.setAttribute('disabled', 'true');
      }
      const addressSection = document.getElementById('addressSection');
      const shippingFeeContainer = document.getElementById('shippingFeeContainer');
      addressSection?.classList.add('d-none');
      shippingFeeContainer?.classList.add('d-none');

      tab.saleMethod = 'T·∫°i qu·∫ßy';
      tab.shippingFeeBase = 0;
      tab.shippingDiscount = 0;

      updateSummary(tab);
      renderCart(tab.cart);

      if (tab.saleMethod === 'Giao h√†ng' && tab.selectedAddress) {
        setupShippingForSelectedAddress();
      }
    } else {
      if (elements.saleMethod) elements.saleMethod.removeAttribute('disabled');
      if (elements.customerPhone) elements.customerPhone.placeholder = DEFAULT_PHONE_PLACEHOLDER;
    }
    setDeliveryVisibilityForPhone(tab.customerPhone || '');

    if (elements.shippingFee) elements.shippingFee.value = formatCurrency(tab.shippingFeeBase);
    if (elements.paymentMethod) elements.paymentMethod.value = tab.paymentMethod;
    if (elements.cashAmount) elements.cashAmount.value = tab.cashAmount || 0;

    toggleCashInput();
    renderCart(tab.cart);
    updateSummary(tab);

    // Load gi·ªè h√†ng t·ª´ server (truy·ªÅn ph√≠ ship g·ªëc)
    try {
      const response = await fetch(`${BASE_URL}/cart/get?tabId=${tabId}&shippingFee=${tab.shippingFeeBase}`);
      if (response.ok) {
        const cartData = await response.json();
        tab.cart = cartData.danhSachSanPham || [];
        tab.subTotal = cartData.tongTienHang || 0;
        tab.discount = cartData.giamGia || 0;
        tab.total = cartData.tong || 0;
        tab.cashAmount = cartData.cashAmount || 0;

        if (typeof cartData.phiVanChuyenGoc  !== 'undefined') tab.shippingFeeBase  = cartData.phiVanChuyenGoc;
        if (typeof cartData.giamGiaVanChuyen !== 'undefined') tab.shippingDiscount = cartData.giamGiaVanChuyen;

        renderCart(tab.cart);
        updateSummary(tab);
      }
    } catch (error) {
      console.error('L·ªói khi load gi·ªè h√†ng:', error);
    }

    if (tab.customerPhone && tab.customerPhone !== '0999999999') {
      await fetchCustomerAddresses();
    }
    toggleAddressSection();
    await fetchVouchers();
    localStorage.setItem('orderTabs', JSON.stringify(tabs));
  }


  async function fetchCustomerAddresses() {
    const phoneEl = document.getElementById('customerPhone');
    const nameEl  = document.getElementById('customerName');
    const emailEl = document.getElementById('customerEmail');
    const addressSection        = document.getElementById('addressSection');
    const shippingFeeContainer  = document.getElementById('shippingFeeContainer');
    const addressSelect         = document.getElementById('addressSelect');

    if (!phoneEl) return;

    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const phone = (phoneEl.value || '').trim();
    setDeliveryVisibilityForPhone(phone);

    if (!phone) { clearAddressUI(); return; }
    if (phone === '0999999999') return;

    // (n·∫øu b·∫°n ƒëang ƒë·ªÉ validate 10 s·ªë)
    if (!/^\d{10}$/.test(phone)) {
      showToast('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p 10 ch·ªØ s·ªë.', 'warning');
      clearAddressUI();
      return;
    }

    let phoneRaw = (phoneEl.value || '').trim();
    setDeliveryVisibilityForPhone(phone);

    if (!phone) {
      clearAddressUI();
      return;
    }

// Kh√°ch l·∫ª -> b·ªè qua
    if (phone === '0999999999') {
      const tab0 = tabs.find(t => t.id === currentTabId);
      if (tab0) {
        tab0.customerPhone = '0999999999';
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
      }
      return;
    }

// Validate ƒë√∫ng quy t·∫Øc VN (10 di ƒë·ªông / 11 c·ªë ƒë·ªãnh, ch·∫•p nh·∫≠n +84)
    if (!isValidVNPhone(phone)) {
      showToast('SƒêT VN kh√¥ng h·ª£p l·ªá: di ƒë·ªông 10 s·ªë (03/05/07/08/09) ho·∫∑c c·ªë ƒë·ªãnh 11 s·ªë (02...)', 'warning');
      clearAddressUI();
      return;
    }

// L∆∞u s·ªë ƒë√£ chu·∫©n ho√° (b·∫Øt ƒë·∫ßu b·∫±ng 0) v√†o tab & input
    const tab0 = tabs.find(t => t.id === currentTabId);
    if (tab0) {
      tab0.customerPhone = phone;
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    }
    phoneEl.value = phone;

    // ==== END validate ====

    // M·ªü kho√° saleMethod
    document.getElementById('saleMethod')?.removeAttribute('disabled');

    try {
      const res = await fetch(`${BASE_URL}/customer/${phone}/addresses`);
      if (!res.ok) {
        let errorMessage = "Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng.";
        try {
          const err = await res.json();
          errorMessage = err.error || err.message || errorMessage;
        } catch {}
        showToast(errorMessage, 'error');
        nameEl && (nameEl.value = '');
        emailEl && (emailEl.value = '');
        addressSection?.classList.add('d-none');
        return;
      }

      const data = await res.json();

      // Th√¥ng tin KH
      tab.customerName  = data.hoTen  || '';
      tab.customerEmail = data.email  || '';
      nameEl  && (nameEl.value  = tab.customerName);
      emailEl && (emailEl.value = tab.customerEmail);

      // ==== ƒê·ªäA CH·ªà: d·ª±ng l·∫°i options + ch·ªçn m·∫∑c ƒë·ªãnh ====
      const raw = Array.isArray(data.addresses) ? data.addresses : [];
      const toString = (a) => typeof a === 'string'
              ? a
              : [a.chiTietDiaChi, a.phuongXa, a.quanHuyen, a.tinhThanhPho].filter(Boolean).join(', ');

      // T√¨m m·∫∑c ƒë·ªãnh theo nhi·ªÅu kh·∫£ nƒÉng
      const defaultObj =
              raw.find(a => typeof a === 'object' && (a.macDinh || a.isDefault || a.default)) || null;

      let defaultAddress =
              (typeof data.defaultAddress === 'string' && data.defaultAddress) ? data.defaultAddress
                      : (defaultObj ? toString(defaultObj)
                              : (raw[0] ? toString(raw[0]) : ''));

      // ƒê·ªï dropdown
      if (addressSelect) {
        addressSelect.innerHTML = '<option value="">Ch·ªçn ƒë·ªãa ch·ªâ</option>';
        const unique = [...new Set(raw.map(toString))]; // lo·∫°i tr√πng
        unique.forEach(addr => {
          const opt = document.createElement('option');
          opt.value = addr;
          opt.text  = addr;
          addressSelect.appendChild(opt);
        });

        // Ch·ªçn m·∫∑c ƒë·ªãnh
        if (defaultAddress && unique.includes(defaultAddress)) {
          addressSelect.value = defaultAddress;
          tab.selectedAddress = defaultAddress;
        } else {
          // kh√¥ng c√≥ -> b·ªè ch·ªçn
          addressSelect.value = '';
          tab.selectedAddress = '';
        }
      }

      // Hi·ªán/·∫©n UI theo saleMethod
      if (tab.saleMethod === 'Giao h√†ng') {
        addressSection?.classList.remove('d-none');
        shippingFeeContainer?.classList.remove('d-none');

        // N·∫øu c√≥ ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh -> t√≠nh GHN, ng∆∞·ª£c l·∫°i fee=0
        if (tab.selectedAddress) {
          setupShippingForSelectedAddress();
        } else {
          zeroShippingBecauseNoAddress();
        }
      } else {
        addressSection?.classList.add('d-none');
        shippingFeeContainer?.classList.add('d-none');
        tab.shippingFeeBase = 0;
        tab.shippingDiscount = 0;
        updateSummary(tab);
      }

      // L∆∞u l·∫°i
      tab.addresses = raw.map(toString);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    } catch (error) {
      console.error('L·ªói khi l·∫•y th√¥ng tin kh√°ch h√†ng:', error);
      showToast('L·ªói khi t·∫£i ƒë·ªãa ch·ªâ: ' + error.message, 'error');
      addressSection?.classList.add('d-none');
    }
  }

  let provincesData = [];

  async function fetchProvinces() {
    try {
      const response = await fetch('https://provinces.open-api.vn/api/p/');
      if (!response.ok) throw new Error('L·ªói khi l·∫•y danh s√°ch t·ªânh/th√†nh ph·ªë');
      const data = await response.json();
      provincesData = data;

      const provinceSelect = document.getElementById('provinceSelect');
      if (provinceSelect) {
        provinceSelect.innerHTML = '<option value="">Ch·ªçn t·ªânh/th√†nh ph·ªë</option>';
        data.forEach(province => {
          const option = document.createElement('option');
          option.value = province.code;
          option.text = province.name;
          provinceSelect.appendChild(option);
        });

        const districtSelect = document.getElementById('districtSelect');
        const wardSelect = document.getElementById('wardSelect');
        if (districtSelect) districtSelect.innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
        if (wardSelect) wardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';
      }
    } catch (error) {
      showToast('L·ªói khi t·∫£i t·ªânh/th√†nh ph·ªë: ' + error.message, 'error');
    }
  }

  async function fetchDistricts(provinceCode) {
    const districtSelect = document.getElementById('districtSelect');
    const wardSelect = document.getElementById('wardSelect');
    if (!districtSelect || !wardSelect) return;

    districtSelect.innerHTML = '<option value="">Ch·ªçn qu·∫≠n/huy·ªán</option>';
    wardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';

    if (!provinceCode) return;

    try {
      const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
      if (!response.ok) throw new Error('L·ªói khi l·∫•y danh s√°ch qu·∫≠n/huy·ªán');
      const data = await response.json();
      const districts = data.districts || [];

      districts.forEach(district => {
        const option = document.createElement('option');
        option.value = district.code;
        option.text = district.name;
        districtSelect.appendChild(option);
      });
    } catch (error) {
      showToast('L·ªói khi t·∫£i qu·∫≠n/huy·ªán: ' + error.message, 'error');
    }
  }

  async function fetchWards(districtCode) {
    const wardSelect = document.getElementById('wardSelect');
    if (!wardSelect) return;

    wardSelect.innerHTML = '<option value="">Ch·ªçn ph∆∞·ªùng/x√£</option>';

    if (!districtCode) return;

    try {
      const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
      if (!response.ok) throw new Error('L·ªói khi l·∫•y danh s√°ch ph∆∞·ªùng/x√£');
      const data = await response.json();
      const wards = data.wards || [];

      wards.forEach(ward => {
        const option = document.createElement('option');
        option.value = ward.code;
        option.text = ward.name;
        wardSelect.appendChild(option);
      });
    } catch (error) {
      showToast('L·ªói khi t·∫£i ph∆∞·ªùng/x√£: ' + error.message, 'error');
    }
  }

  function sanitizeSpaces(str) {
    return String(str || '')
            .replace(/\s+/g, ' ')
            .replace(/\s*,\s*/g, ', ')
            .replace(/\s*([./\-#])\s*/g, '$1')
            .trim();
  }
  function addFieldError(el, msg) {
    if (!el) return;
    el.classList.add('is-invalid');
    let fb = el.nextElementSibling;
    if (!fb || !fb.classList.contains('invalid-feedback')) {
      fb = document.createElement('div');
      fb.className = 'invalid-feedback';
      el.after(fb);
    }
    fb.textContent = msg || 'Gi√° tr·ªã kh√¥ng h·ª£p l·ªá';
  }
  function clearFieldError(el) {
    if (!el) return;
    el.classList.remove('is-invalid');
    const fb = el.nextElementSibling;
    if (fb && fb.classList.contains('invalid-feedback')) fb.textContent = '';
  }

  // Ki·ªÉm tra "ƒë·ªãa ch·ªâ c·ª• th·ªÉ"
  function validateAddressDetail(raw) {
    const s0 = sanitizeSpaces(raw);
    if (s0.length < 5 || s0.length > 120) {
      return { ok:false, msg:'ƒê·ªô d√†i ph·∫£i t·ª´ 5‚Äì120 k√Ω t·ª±.' };
    }
    // b·∫Øt ƒë·∫ßu/k·∫øt th√∫c b·∫±ng k√Ω t·ª± h·ª£p l·ªá
    if (/^[,./\-#]/.test(s0) || /[,./\-#]$/.test(s0)) {
      return { ok:false, msg:'Kh√¥ng b·∫Øt ƒë·∫ßu/k·∫øt th√∫c b·∫±ng k√Ω hi·ªáu (.,-/#).' };
    }
    // ch·ªâ cho ch·ªØ c√≥ d·∫•u ti·∫øng Vi·ªát, s·ªë, kho·∫£ng tr·∫Øng v√† , . / - #
    if (/[^0-9A-Za-z√Ä-·ª∏√†-·ªπƒêƒë\s,./\-#]/.test(s0)) {
      return { ok:false, msg:'Ch·ªâ d√πng ch·ªØ, s·ªë v√† k√Ω hi·ªáu , . / - #.' };
    }
    // n√™n c√≥ √≠t nh·∫•t m·ªôt ch·ªØ s·ªë (th∆∞·ªùng l√† s·ªë nh√†/ng√µ)
    if (!/[0-9]/.test(s0)) {
      return { ok:false, msg:'Vui l√≤ng th√™m s·ªë nh√†/ng√µ (√≠t nh·∫•t 1 ch·ªØ s·ªë).' };
    }
    // n√™n c√≥ ch·ªØ c√°i (t√™n ƒë∆∞·ªùng/khu)
    if (!/[A-Za-z√Ä-·ª∏√†-·ªπƒêƒë]/.test(s0)) {
      return { ok:false, msg:'Vui l√≤ng nh·∫≠p t√™n ƒë∆∞·ªùng/khu v·ª±c.' };
    }
    // gom d·∫•u tr√πng
    const s = s0
            .replace(/,{2,}/g, ',')
            .replace(/\.{2,}/g, '.')
            .replace(/\/{2,}/g, '/');
    return { ok:true, value:s };
  }

  // G·ª£i √Ω: validate live khi blur
  (function wireAddressLineValidation(){
    const el = document.getElementById('addressLine');
    if (!el) return;
    el.addEventListener('blur', () => {
      const v = validateAddressDetail(el.value);
      if (!v.ok) addFieldError(el, v.msg); else { el.value = v.value; clearFieldError(el); }
    });
  })();

  async function addNewAddress() {
    const phoneInput      = document.getElementById('customerPhone');
    const addressLineInput= document.getElementById('addressLine');
    const wardSelect      = document.getElementById('wardSelect');
    const districtSelect  = document.getElementById('districtSelect');
    const provinceSelect  = document.getElementById('provinceSelect');

    if (!phoneInput || !addressLineInput || !wardSelect || !districtSelect || !provinceSelect) {
      showToast('Kh√¥ng t√¨m th·∫•y c√°c tr∆∞·ªùng nh·∫≠p li·ªáu.', 'error');
      return;
    }

    clearFieldError(addressLineInput); // NEW
    const phone = (phoneInput.value || '').trim();
    const chiTietDiaChiRaw = addressLineInput.value;

    // NEW: validate "ƒë·ªãa ch·ªâ c·ª• th·ªÉ"
    const check = validateAddressDetail(chiTietDiaChiRaw);
    if (!check.ok) { addFieldError(addressLineInput, check.msg); showToast(check.msg, 'warning'); return; }
    const chiTietDiaChi = check.value;

    // ch·ªçn ƒë·ªß 3 c·∫•p h√†nh ch√≠nh
    if (wardSelect.selectedIndex <= 0 || districtSelect.selectedIndex <= 0 || provinceSelect.selectedIndex <= 0) {
      showToast('Vui l√≤ng ch·ªçn ƒë·ªß Ph∆∞·ªùng/X√£, Qu·∫≠n/Huy·ªán, T·ªânh/Th√†nh.', 'warning');
      return;
    }

    // build chu·ªói ƒë√∫ng ƒë·ªãnh d·∫°ng
    const phuongXa     = wardSelect.options[wardSelect.selectedIndex].text.trim();
    const quanHuyen    = districtSelect.options[districtSelect.selectedIndex].text.trim();
    const tinhThanhPho = provinceSelect.options[provinceSelect.selectedIndex].text.trim();
    const fullAddress  = `${chiTietDiaChi}, ${phuongXa}, ${quanHuyen}, ${tinhThanhPho}`;

    // NEW: pre-check kh·ªõp GHN tr∆∞·ªõc khi l∆∞u (b·∫Øt l·ªói s·ªõm n·∫øu sai)
    try {
      await mapAddressTextToGhnCodes(fullAddress);
    } catch (e) {
      addFieldError(addressLineInput, 'ƒê·ªãa ch·ªâ ch∆∞a kh·ªõp h·ªá th·ªëng GHN, vui l√≤ng ki·ªÉm tra l·∫°i.');
      showToast(e?.message || 'ƒê·ªãa ch·ªâ ch∆∞a kh·ªõp GHN, vui l√≤ng ki·ªÉm tra l·∫°i.', 'warning');
      return;
    }

    // Payload g·ª≠i BE gi·ªØ nguy√™n nh∆∞ c·ªßa b·∫°n
    const requestData = { chiTietDiaChi, phuongXa, quanHuyen, tinhThanhPho };

    try {
      const response = await fetch(`${BASE_URL}/customer/${phone}/add-address`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        const errorData = await response.json();
        showToast(`L·ªói: ${errorData.error || 'Kh√¥ng x√°c ƒë·ªãnh'}`, 'error');
        throw new Error(errorData.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
      }

      const data = await response.json();

      // c·∫≠p nh·∫≠t UI hi·ªán c√≥ (gi·ªØ nguy√™n logic c·ªßa b·∫°n)
      const tab = tabs.find(t => t.id === currentTabId);
      if (tab) {
        const fmt = (s) => s.trim();
        const normalized = fmt(fullAddress);
        // ch·ªëng tr√πng (so s√°nh kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng & kho·∫£ng tr·∫Øng)
        const existed = (tab.addresses || []).some(a => fmt(a).toLowerCase() === normalized.toLowerCase());
        if (!existed) tab.addresses.push(normalized);
        tab.selectedAddress = normalized;

        const addressSelect = document.getElementById('addressSelect');
        if (addressSelect) {
          // n·∫øu ch∆∞a c√≥ option tr√πng -> th√™m v√†o
          const hasOption = [...addressSelect.options].some(o => fmt(o.value).toLowerCase() === normalized.toLowerCase());
          if (!hasOption) {
            const opt = document.createElement('option');
            opt.value = normalized;
            opt.text  = normalized;
            addressSelect.appendChild(opt);
          }
          addressSelect.value = normalized;
          await setupShippingForSelectedAddress(); // t√≠nh ph√≠ GHN
        }

        localStorage.setItem('orderTabs', JSON.stringify(tabs));
      }

      document.getElementById('addAddressForm').classList.add('d-none');
      clearFieldError(addressLineInput); // NEW
      showToast('ƒê√£ th√™m ƒë·ªãa ch·ªâ th√†nh c√¥ng!', 'success');
    } catch (error) {
      console.error('L·ªói khi th√™m ƒë·ªãa ch·ªâ:', error);
      showToast('L·ªói khi th√™m ƒë·ªãa ch·ªâ: ' + error.message, 'error');
    }
  }

  function showAddAddressForm() {
    const addAddressForm = document.getElementById('addAddressForm');
    if (addAddressForm) {
      addAddressForm.classList.remove('d-none');
      fetchProvinces();
    }
  }

  function toggleAddressSection() {
    const saleMethodSelect        = document.getElementById('saleMethod');
    const phoneInput              = document.getElementById('customerPhone');
    const addressSection          = document.getElementById('addressSection');
    const shippingFeeContainer    = document.getElementById('shippingFeeContainer');
    const shippingMethodContainer = document.getElementById('shippingMethodContainer');
    if (!saleMethodSelect || !addressSection || !shippingFeeContainer) return;

    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const inputPhone = (phoneInput?.value || '').trim();
    const retail = isRetailCustomer() || inputPhone === '0999999999';

    // ƒë·ªìng b·ªô dropdown theo tr·∫°ng th√°i hi·ªán t·∫°i
    setDeliveryVisibilityForPhone(retail ? '0999999999' : inputPhone);

    if (retail) {
      // üîí kho√° & √©p v·ªÅ "T·∫°i qu·∫ßy"
      saleMethodSelect.value = 'T·∫°i qu·∫ßy';
      saleMethodSelect.setAttribute('disabled','true');
      addressSection.classList.add('d-none');
      shippingFeeContainer.classList.add('d-none');
      shippingMethodContainer?.classList.add('d-none');

      const prevBase = Number(tab.shippingFeeBase || 0);
      tab.saleMethod = 'T·∫°i qu·∫ßy';
      tab.shippingFeeBase = 0;
      tab.shippingDiscount = 0;
      tab.shipVoucherId = null;

      updateSummary(tab);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      if (!isApplyingVoucher && prevBase !== 0) reapplyCurrentOrderVoucher?.();
      updateShipSectionVisibility?.();
      return; // ‚õî d·ª´ng t·∫°i ƒë√¢y, kh√¥ng ch·∫°y logic giao h√†ng
    }

    // Ng∆∞·ªùi d√πng th∆∞·ªùng ‚Üí m·ªü kho√° & x·ª≠ l√Ω nh∆∞ c≈©
    saleMethodSelect.removeAttribute('disabled');
    tab.saleMethod = saleMethodSelect.value;

    if (tab.saleMethod === 'Giao h√†ng' && (tab.customerPhone || inputPhone)) {
      addressSection.classList.remove('d-none');
      shippingFeeContainer.classList.remove('d-none');
      shippingMethodContainer?.classList.remove('d-none');

      fetchCustomerAddresses().then(() => {
        const addressSelect = document.getElementById('addressSelect');
        if (!addressSelect?.value) {
          zeroShippingBecauseNoAddress();
        } else {
          setTimeout(() => setupShippingForSelectedAddress(), 0);
        }
        updateShipSectionVisibility();
      });
    } else {
      addressSection.classList.add('d-none');
      shippingFeeContainer.classList.add('d-none');
      shippingMethodContainer?.classList.add('d-none');

      const prevBase = Number(tab.shippingFeeBase || 0);
      tab.shippingFeeBase = 0;
      tab.shippingDiscount = 0;
      tab.shipVoucherId = null;

      updateSummary(tab);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      if (tab.voucherId && !isApplyingVoucher && prevBase !== 0) applyVoucher(tab.voucherId);

      updateShipSectionVisibility();
    }

    fetchVouchers();
  }

  function toggleCashInput() {
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const cashInput = document.getElementById('cashInput');

    if (!paymentMethodSelect || !cashInput) return;

    const paymentMethod = paymentMethodSelect.value;
    const tab = tabs.find(t => t.id === currentTabId);

    if (tab) {
      tab.paymentMethod = paymentMethod;
      if (paymentMethod === '550E8400-E29B-41D4-A716-446655440017') {
        cashInput.classList.remove('d-none');
      } else {
        cashInput.classList.add('d-none');
      }

      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    }
  }

  // QR Scanner
  let html5QrCode = null;

  async function showQrScanner() {
    const qrScannerModal = document.getElementById('qrScannerModal');
    if (qrScannerModal) qrScannerModal.style.display = 'flex';

    const qrReader = document.getElementById('qr-reader');
    if (!qrReader) return;

    try {
      // Initialize html5-qrcode scanner
      html5QrCode = new Html5Qrcode("qr-reader");

      // Start scanning with back camera
      await html5QrCode.start(
              { facingMode: "environment" },
              {
                fps: 10, // Frames per second for scanning
                qrbox: { width: 250, height: 250 } // Scanning box size
              },
              (decodedText) => {
                // Success callback when QR code is decoded
                addProductByQr(decodedText);
                stopQrScanner();
              },
              (error) => {
                // Optional error callback (can be used for debugging)
                // console.warn('QR scan error:', error);
              }
      );
    } catch (error) {
      showToast('L·ªói khi m·ªü camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.', 'error');
    }
  }

  function stopQrScanner() {
    if (html5QrCode) {
      html5QrCode
              .stop()
              .then(() => {
                html5QrCode.clear();
                html5QrCode = null;
              })
              .catch((error) => {
                console.error('L·ªói khi d·ª´ng qu√©t QR:', error);
              });
    }
    const qrScannerModal = document.getElementById('qrScannerModal');
    if (qrScannerModal) qrScannerModal.style.display = 'none';
  }

  async function removeItem(index, productDetailId) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    try {
      const requestData = {
        productDetailId: String(productDetailId),
        shippingFee: parseFloat(tab.shippingFeeBase || 0),
        tabId: String(currentTabId)
      };

      const response = await fetch(`${BASE_URL}/cart/remove`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        let errorMessage = "L·ªói khi x√≥a s·∫£n ph·∫©m.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      await refreshCartFromServer();
      await reapplyCurrentOrderVoucher();
      await reapplyCurrentShipVoucher();
      showToast("ƒê√£ x√≥a s·∫£n ph·∫©m!", "success");
    } catch (error) {
      showToast("L·ªói khi x√≥a s·∫£n ph·∫©m: " + error.message, "error");
    }
  }


  // L·∫•y & g·ªôp danh s√°ch voucher (ORDER/SHIPPING) ‚Äî ch·ªëng v·ª° d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ API
  async function fetchVouchers() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const subTotal = Number(tab.subTotal || 0);
    let qsBase = `subTotal=${subTotal}&tabId=${currentTabId}`;

    // ===== Voucher c√° nh√¢n (n·∫øu c√≥ KH) =====
    let personalVouchers = [];
    if (tab.customerPhone && tab.customerPhone !== '0999999999') {
      try {
        const customerRes = await fetch(`/acvstore/customers/by-phone/${tab.customerPhone}`);
        if (customerRes.ok) {
          const customerData = await customerRes.json();
          if (customerData.id) {
            tab.customerId = customerData.id;
            qsBase += `&customerId=${tab.customerId}`;
            const pvRes = await fetch(`/acvstore/customers/vouchers/${tab.customerPhone}`);
            if (pvRes.ok) {
              const pv = await pvRes.json();
              personalVouchers = Array.isArray(pv) ? pv : (pv?.vouchers || []);
            }
          }
        }
      } catch (e) {
        console.error('L·ªói l·∫•y KH/phi·∫øu c√° nh√¢n:', e);
      }
    }

    // ===== Voucher c√¥ng khai (nh·∫≠n th√™m map PTTT n·∫øu BE tr·∫£ k√®m) =====
    let publicAll = [];
    try {
      const res = await fetch(`${BASE_URL}/vouchers?${qsBase}`);
      if (!res.ok) throw new Error('L·ªói khi l·∫•y phi·∫øu gi·∫£m gi√° c√¥ng khai.');
      const data = await res.json();

      if (Array.isArray(data)) {
        publicAll = data;
      } else {
        publicAll = Array.isArray(data?.vouchers) ? data.vouchers : [];
        // üëâ gi·ªØ map PTTT t·ª´ BE (n·∫øu c√≥)
        if (data?.voucherPtttMapById && typeof data.voucherPtttMapById === 'object') {
          voucherPtttMapById = data.voucherPtttMapById;
        }
        if (data?.voucherPtttMapByMa && typeof data.voucherPtttMapByMa === 'object') {
          voucherPtttMapByMa = data.voucherPtttMapByMa;
        }
      }
    } catch (e) {
      console.error('L·ªói get public vouchers:', e);
    }

    // ===== N·∫øu BE h·ªó tr·ª£ t√°ch theo type, g·ªçi k√®m ƒë·ªÉ g·∫Øn nh√£n ch√≠nh x√°c h∆°n =====
    let typedOrder = [], typedShip = [];
    try {
      const [oRes, sRes] = await Promise.allSettled([
        fetch(`${BASE_URL}/vouchers?${qsBase}&type=ORDER`),
        fetch(`${BASE_URL}/vouchers?${qsBase}&type=SHIPPING`)
      ]);
      if (oRes.status === 'fulfilled' && oRes.value.ok) {
        const j = await oRes.value.json();
        const arr = Array.isArray(j) ? j : (j?.vouchers || []);
        typedOrder = arr.map(v => ({ ...v, __type: 'ORDER' }));
      }
      if (sRes.status === 'fulfilled' && sRes.value.ok) {
        const j = await sRes.value.json();
        const arr = Array.isArray(j) ? j : (j?.vouchers || []);
        typedShip = arr.map(v => ({ ...v, __type: 'SHIPPING' }));
      }
    } catch { /* ignore */ }

    // G·∫Øn nh√£n type cho c√°c danh s√°ch ch∆∞a r√µ lo·∫°i
    const tagType = (list, fallback) =>
            (Array.isArray(list) ? list : []).map(v => {
              const t = getVoucherType(v, fallback);
              return t ? { ...v, __type: t } : { ...v, __type: 'ORDER' }; // default ORDER
            });

    // G·ªôp + kh·ª≠ tr√πng l·∫∑p theo id
    const merged = dedupById([
      ...typedOrder,
      ...typedShip,
      ...tagType(publicAll),
      ...tagType(personalVouchers)
    ]);

    renderVoucherModalLists(merged);
    localStorage.setItem('orderTabs', JSON.stringify(tabs));
  }





  async function applyVoucher(voucherId) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const voucherSelect = document.getElementById('voucherSelect');
    const selectedVoucherId = voucherId || (voucherSelect ? voucherSelect.value : null);
    const shippingFee = tab.shippingFeeBase || 0;

    if (!selectedVoucherId) {
      tab.voucherId = null;
      tab.orderVoucherId = null;
      tab.discount = 0;
      updateSummary(tab);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      return;
    }

    if (isApplyingVoucher) return;
    isApplyingVoucher = true;
    try {
      const response = await fetch(`${BASE_URL}/cart/apply-voucher?voucherId=${selectedVoucherId}&shippingFee=${shippingFee}&tabId=${currentTabId}&paymentMethodId=${encodeURIComponent(getSelectedPaymentMethodId())}`);
      if (!response.ok) {
        let errorMessage = "L·ªói khi √°p d·ª•ng voucher.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }

        // üî• N·∫øu voucher ƒëang √°p m√† re-apply fail ‚Üí g·ª° lu√¥n
        const wasApplied =
                String(tab.voucherId) === String(selectedVoucherId) ||
                String(tab.orderVoucherId) === String(selectedVoucherId);

        if (wasApplied) {
          tab.voucherId = null;
          tab.orderVoucherId = null;
          tab.discount = 0;
          updateSummary(tab);
          localStorage.setItem('orderTabs', JSON.stringify(tabs));

          // B·ªè ch·ªçn UI
          document.querySelectorAll('#voucherModal input[name="orderVoucher"]').forEach(r => {
            if (r.value === String(selectedVoucherId)) r.checked = false;
          });
          if (voucherSelect && voucherSelect.value === String(selectedVoucherId)) voucherSelect.value = '';
          showToast('M√£ gi·∫£m gi√° kh√¥ng c√≤n ƒë·ªß ƒëi·ªÅu ki·ªán, ƒë√£ g·ª° m√£.', 'warning');
        } else {
          showToast(errorMessage, 'error');
        }
        return;
      }

      // ‚úÖ Th√†nh c√¥ng
      const data = await response.json();
      tab.voucherId = selectedVoucherId;      // gi·ªØ t∆∞∆°ng th√≠ch c≈©
      tab.orderVoucherId = selectedVoucherId; // canonical
      updateCartFromResponse(data);
      showToast('ƒê√£ √°p d·ª•ng phi·∫øu gi·∫£m gi√°!', 'success');
    } catch (error) {
      console.error('L·ªói khi √°p d·ª•ng voucher:', error);
      showToast('L·ªói khi √°p d·ª•ng voucher: ' + error.message, 'error');
    } finally {
      isApplyingVoucher = false;
    }
  }
  async function applySelectedVouchers() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const pickedOrder = document.querySelector('#voucherModal input[name="orderVoucher"]:checked')?.value || null;
    const pickedShip  = document.querySelector('#voucherModal input[name="shipVoucher"]:checked')?.value  || null;

    // L∆∞u l·ª±a ch·ªçn r√µ r√†ng c·ªßa user
    tab.orderVoucherId = pickedOrder;
    tab.shipVoucherId  = isShippingEnabled() ? pickedShip : null;
    localStorage.setItem('orderTabs', JSON.stringify(tabs));

    // 1) ORDER
    if (pickedOrder) {
      await applyVoucher(pickedOrder);
    } else {
      tab.voucherId = null; // gi·ªØ t∆∞∆°ng th√≠ch c≈© n·∫øu n∆°i kh√°c c√≤n d√πng
      tab.discount = 0;
    }

    // 2) SHIPPING
    if (isShippingEnabled()) {
      // B·∫£o ƒë·∫£m c√≥ ph√≠ g·ªëc tr∆∞·ªõc khi g·ªçi freeship
      if (!Number(tab.shippingFeeBase) || Number(tab.shippingFeeBase) <= 0) {
        try { await setupShippingForSelectedAddress({ recalcOnly: false }); } catch {}
      }
      if (tab.shipVoucherId) {
        try {
          isApplyingVoucher = true;
          const shippingFee = Number(tab.shippingFeeBase || 0);
          const res = await fetch(`${BASE_URL}/cart/apply-voucher?voucherId=${tab.shipVoucherId}&shippingFee=${shippingFee}&tabId=${currentTabId}&paymentMethodId=${encodeURIComponent(getSelectedPaymentMethodId())}`);
          if (!res.ok) {
            let msg = 'Kh√¥ng √°p d·ª•ng ƒë∆∞·ª£c m√£ Freeship.';
            try { const err = await res.json(); msg = err.error || err.message || msg; } catch {}
            throw new Error(msg);
          }
          const data = await res.json();
          if (typeof data.phiVanChuyenGoc  !== 'undefined') tab.shippingFeeBase  = data.phiVanChuyenGoc;
          if (typeof data.giamGiaVanChuyen !== 'undefined') tab.shippingDiscount = data.giamGiaVanChuyen;
        } catch (e) {
          tab.shipVoucherId = null;
          tab.shippingDiscount = 0;
          updateSummary(tab);
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
          showToast(e.message || 'Kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán Freeship, ƒë√£ g·ª° m√£.', 'warning');
        } finally {
          isApplyingVoucher = false;
        }
      } else {
        tab.shippingDiscount = 0;
      }
    } else {
      tab.shipVoucherId = null;
      tab.shippingDiscount = 0;
    }

    updateSummary(tab);
    localStorage.setItem('orderTabs', JSON.stringify(tabs));
    closeVoucherModal();
  }




  function updateSummary(tab) {
    // T√≠nh to√°n
    const subTotal      = Number(tab.subTotal || 0);
    const orderDiscount = Number(tab.discount || 0);            // gi·∫£m gi√° ƒë∆°n (ORDER)
    const isDelivery    = tab.saleMethod === 'Giao h√†ng';

    // Ph√≠ ship theo m√¥ h√¨nh g·ªëc/gi·∫£m
    const shippingBase  = isDelivery ? Number(tab.shippingFeeBase || 0) : 0;     // ph√≠ ship g·ªëc
    const shippingDisc  = isDelivery ? Number(tab.shippingDiscount || 0) : 0;    // gi·∫£m ph√≠ ship (freeship)
    const shippingPay   = Math.max(0, shippingBase - shippingDisc);              // ph√≠ ship ph·∫£i tr·∫£

    // T·ªïng thanh to√°n
    const total = subTotal - orderDiscount + shippingPay;

    // Ti·ªÅn kh√°ch ƒë∆∞a (ch·ªâ khi ti·ªÅn m·∫∑t)
    const cashEl     = document.getElementById('cashAmount');
    const rawCashStr = cashEl ? String(cashEl.value).replace(/\./g, '') : '0';
    const cashAmount = tab.paymentMethod === '550E8400-E29B-41D4-A716-446655440017'
            ? Number(rawCashStr || 0)
            : 0;
    tab.cashAmount   = cashAmount;
    const change     = Math.max(0, cashAmount - total);

    // Helper
    const el  = (id) => document.getElementById(id);
    const fmt = (n)  => (Number(n) || 0).toLocaleString('vi-VN') + ' VNƒê';

    // Subtotal
    if (el('subTotal')) el('subTotal').innerText = fmt(subTotal);

    // Ph√≠ v·∫≠n chuy·ªÉn (g·ªëc): lu√¥n HI·ªÜN khi ch·ªçn "Giao h√†ng", ·∫©n khi "T·∫°i qu·∫ßy"
    if (el('shippingBaseRow')) {
      el('shippingBaseRow').classList.toggle('d-none', !isDelivery);
    }
    if (el('shippingFeeBaseDisplay')) {
      el('shippingFeeBaseDisplay').innerText = fmt(shippingBase);
    }

    // Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn: lu√¥n HI·ªÜN khi "Giao h√†ng" (k·ªÉ c·∫£ = 0 -> hi·ªÉn th·ªã "- 0 VNƒê")
    if (el('shippingDiscountRow')) {
      el('shippingDiscountRow').classList.toggle('d-none', !isDelivery);
    }
    if (el('shippingDiscountDisplay')) {
      el('shippingDiscountDisplay').innerText = '- ' + fmt(shippingDisc);
    }

    // Gi·∫£m gi√° ƒë∆°n: LU√îN HI·ªÇN TH·ªä ·ªü c·∫£ "T·∫°i qu·∫ßy" & "Giao h√†ng" (k·ªÉ c·∫£ = 0)
    if (el('orderDiscountRow')) {
      el('orderDiscountRow').classList.remove('d-none');
    }
    if (el('orderDiscountDisplay')) {
      el('orderDiscountDisplay').innerText = '- ' + fmt(orderDiscount);
    }

    // T·ªïng & ti·ªÅn th·ªëi
    if (el('total'))        el('total').innerText        = fmt(total);
    if (el('changeAmount')) el('changeAmount').innerText = fmt(change);
  }




  async function createOrder() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    // validate c∆° b·∫£n
    if (!tab.customerPhone) {
      showToast('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng.', 'warning');
      return;
    }
    if (tab.saleMethod === 'Giao h√†ng' && !tab.selectedAddress && tab.customerPhone !== '0999999999') {
      showToast('Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng.', 'warning');
      return;
    }
    if (!tab.cart || tab.cart.length === 0) {
      showToast('Gi·ªè h√†ng tr·ªëng.', 'warning');
      return;
    }

    const isDelivery       = tab.saleMethod === 'Giao h√†ng';
    const shippingBase     = isDelivery ? Number(tab.shippingFeeBase || 0) : 0;
    const shippingDiscount = isDelivery ? Number(tab.shippingDiscount || 0) : 0;
    const shippingPay      = isDelivery ? Math.max(0, shippingBase - shippingDiscount) : 0;

    const subTotal      = Number(tab.subTotal || 0);
    const orderDiscount = Number(tab.discount || 0);
    const totalAmount   = subTotal - orderDiscount + shippingPay;

    const CASH_ID  = '550E8400-E29B-41D4-A716-446655440017';
    const BANK_ID  = '550E8400-E29B-41D4-A716-446655440018';

    const cashAmountInput = document.getElementById('cashAmount');
    const getRawCash = () => {
      const rawStr = (cashAmountInput?.value || '').replace(/\./g, '').trim();
      return rawStr === '' ? NaN : Number(rawStr);
    };

    if (tab.paymentMethod === CASH_ID) {
      const cash = getRawCash();
      if (!Number.isFinite(cash) || cash <= 0) {
        showToast('Vui l√≤ng nh·∫≠p "Ti·ªÅn kh√°ch ƒë∆∞a" (l·ªõn h∆°n 0).', 'warning');
        if (cashAmountInput) {
          cashAmountInput.classList.add('is-invalid');
          cashAmountInput.focus();
          const rmErr = () => { cashAmountInput.classList.remove('is-invalid'); cashAmountInput.removeEventListener('input', rmErr); };
          cashAmountInput.addEventListener('input', rmErr);
        }
        return;
      }
      if (cash < totalAmount) {
        const thieu = (totalAmount - cash).toLocaleString('vi-VN');
        showToast(`S·ªë ti·ªÅn kh√°ch ƒë∆∞a ch∆∞a ƒë·ªß. Thi·∫øu ${thieu} VNƒê.`, 'warning');
        cashAmountInput?.focus();
        return;
      }
    } else if (tab.paymentMethod === BANK_ID) {
      if (totalAmount <= 0) {
        showToast('T·ªïng ti·ªÅn ph·∫£i l·ªõn h∆°n 0 ƒë·ªÉ t·∫°o link thanh to√°n.', 'warning');
        return;
      }
    }

    // clamp theo DECIMAL(18,2)
    const cashDigitsForCheck = String(cashAmountInput?.value || '').replace(/[^\d]/g, '');
    if (clampCashToDbLimit(cashDigitsForCheck).over) {
      showToast(
              `S·ªë ti·ªÅn kh√°ch ƒë∆∞a v∆∞·ª£t gi·ªõi h·∫°n. Vui l√≤ng nh·∫≠p ‚â§ ${formatBigVndDigits(MAX_VND_BIG.toString())} VNƒê.`,
              'warning'
      );
      cashAmountInput?.classList.add('is-invalid');
      cashAmountInput?.focus();
      return;
    }

    // ===== NEW: revalidate t·∫•t c·∫£ m√£ tr∆∞·ªõc khi confirm =====
    const gate = await hardRevalidateVouchersBeforeCheckout();
    if (!gate.proceed) return; // ƒë√£ g·ª° & b√°o trong h√†m tr√™n

    // confirm
    const confirmResult = await Swal.fire({
      icon: 'question',
      title: 'X√°c nh·∫≠n thanh to√°n',
      html: `
      <p><strong>T·ªïng ti·ªÅn:</strong> ${totalAmount.toLocaleString('vi-VN')} VNƒê</p>
      <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${
              tab.paymentMethod === BANK_ID ? 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng' : 'Thanh to√°n ti·ªÅn m·∫∑t'
      }</p>
      <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c thanh to√°n?</p>
    `,
      showCancelButton: true,
      confirmButtonText: 'X√°c nh·∫≠n',
      cancelButtonText: 'H·ªßy',
      confirmButtonColor: '#f97316',
      cancelButtonColor: '#d33',
    });
    if (!confirmResult.isConfirmed) return;

    try {
      const soTienKhachDua =
              tab.paymentMethod === CASH_ID
                      ? (Number(String(cashAmountInput?.value || '0').replace(/\./g, '')) || 0)
                      : 0;

      const orderData = {
        soDienThoaiKhachHang: tab.customerPhone,
        phuongThucBanHang: tab.saleMethod,
        phuongThucThanhToan: tab.paymentMethod,
        soTienKhachDua: soTienKhachDua,
        phiVanChuyen: Math.max(0, shippingBase - shippingDiscount),
        phiVanChuyenGoc: shippingBase,
        giamGiaVanChuyen: shippingDiscount,
        idPhieuGiamGia: tab.voucherId || null,
        danhSachSanPham: tab.cart,
        diaChiGiaoHang: tab.selectedAddress,
        tabId: String(currentTabId)
      };

      if (tab.paymentMethod === BANK_ID) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/create-payment-link';
        form.style.display = 'none';

        const productNameInput = document.createElement('input');
        productNameInput.type = 'hidden';
        productNameInput.name = 'productName';
        productNameInput.value = tab.cart.map(item => item.tenSanPham).join(', ');
        form.appendChild(productNameInput);

        const priceInput = document.createElement('input');
        priceInput.type = 'hidden';
        priceInput.name = 'price';
        priceInput.value = String(totalAmount);
        form.appendChild(priceInput);

        const descriptionInput = document.createElement('input');
        descriptionInput.type = 'hidden';
        descriptionInput.name = 'description';
        descriptionInput.value = `Thanh to√°n ƒë∆°n h√†ng ${currentTabId}`;
        form.appendChild(descriptionInput);

        sessionStorage.setItem('pendingOrder', JSON.stringify({ orderData, tabId: currentTabId }));
        document.body.appendChild(form);
        form.submit();
        return;
      }

      const response = await fetch(`${BASE_URL}/create-order`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(orderData)
      });

      if (!response.ok) {
        let errorMessage = "L·ªói khi t·∫°o ƒë∆°n h√†ng.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      showToast(`H√≥a ƒë∆°n ${data.maDonHang} ƒë√£ ƒë∆∞·ª£c t·∫°o v√† in h√≥a ƒë∆°n th√†nh c√¥ng!`, 'success');

      if (data.pdfData) {
        try {
          const byteCharacters = atob(data.pdfData);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'application/pdf' });

          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `HoaDon_${data.maDonHang}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          console.error('L·ªói khi x·ª≠ l√Ω file PDF:', error);
          showToast('L·ªói khi in h√≥a ƒë∆°n PDF.', 'error');
        }
      }

      // gi·ªØ nguy√™n flow reset tab sau thanh to√°n‚Ä¶
      tabs = tabs.filter(t => t.id !== currentTabId);
      if (tabs.length === 0) {
        await addNewTab();
      } else {
        currentTabId = tabs[tabs.length - 1].id;
        const lastTab = tabs.find(t => t.id === currentTabId);
        if (lastTab) lastTab.paymentMethod = CASH_ID;
      }

      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      localStorage.setItem('currentTabId', currentTabId);
      renderTabs();
      loadTabContent(currentTabId);
      setTimeout(resetCash, 0);
    } catch (error) {
      console.error('L·ªói khi t·∫°o ƒë∆°n h√†ng:', error);
      showToast('L·ªói khi t·∫°o ƒë∆°n h√†ng: ' + error.message, 'error');
    }
  }





  async function fetchCustomers(keyword = '') {
    try {
      const response = await fetch(`${BASE_URL}/customers?keyword=${encodeURIComponent(keyword)}`);
      if (!response.ok) {
        let errorMessage = "L·ªói khi t·∫£i danh s√°ch kh√°ch h√†ng.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      const customerList = document.getElementById('customerList');
      if (customerList) {
        customerList.innerHTML = '';

        data.customers
                .filter(customer => customer.soDienThoai !== '0999999999')
                .forEach(customer => {
                  const div = document.createElement('div');
                  div.className = 'p-3 border rounded cursor-pointer mb-2';
                  div.style.cursor = 'pointer';
                  div.innerHTML = `
                        <div class="d-flex align-items-center gap-3">
                            <i class="fas fa-user-circle fs-3 text-primary"></i>
                            <div>
                                <div class="fw-semibold">${customer.hoTen}</div>
                                <div class="small text-muted">${customer.soDienThoai} ‚Ä¢ ${customer.email}</div>
                            </div>
                        </div>
                    `;
                  div.onmouseover = () => div.classList.add('bg-light');
                  div.onmouseout = () => div.classList.remove('bg-light');
                  div.onclick = () => selectCustomerFromModal(customer.soDienThoai, customer.hoTen, customer.email);
                  customerList.appendChild(div);
                });
      }
    } catch (error) {
      showToast('L·ªói khi t·∫£i danh s√°ch kh√°ch h√†ng: ' + error.message, 'error');
    }
  }

  function showCustomerModal() {
    const customerModal = document.getElementById('customerModal');
    if (customerModal) customerModal.style.display = 'flex';
    fetchCustomers();
  }

  function selectCustomerFromModal(phone, name, email) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    // Gi·ªØ UI name/email nh∆∞ c≈©
    const phoneEl = document.getElementById('customerPhone');
    const nameEl  = document.getElementById('customerName');
    const emailEl = document.getElementById('customerEmail');

    if (phoneEl) {
      phoneEl.value = (phone === '0999999999') ? '' : phone;
      phoneEl.placeholder = (phone === '0999999999')
              ? 'Kh√°ch l·∫ª (kh√¥ng thu th·∫≠p SƒêT)' : DEFAULT_PHONE_PLACEHOLDER;
    }
    if (nameEl)  nameEl.value  = (phone === '0999999999') ? 'Kh√°ch l·∫ª' : (name || '');
    if (emailEl) emailEl.value = (phone === '0999999999') ? ''         : (email || '');

    // üîÅ THAY cho vi·ªác g√°n tr·ª±c ti·∫øp & g·ªçi l·∫ª t·∫ª: d√πng 1 entry point chu·∫©n
    onCustomerChanged(phone);

    const modalEl = document.getElementById('customerModal');
    if (modalEl) modalEl.style.display = 'none';
  }



  document.getElementById('productSearch').addEventListener('input', function() {
    const keyword = this.value.trim();
    fetchProducts(keyword);
  });

  async function fetchProducts(keyword = '') {
    const productSpinner = document.getElementById('productSpinner');
    if (productSpinner) productSpinner.style.display = 'block';

    try {
      const response = await fetch(`${BASE_URL}/products?keyword=${encodeURIComponent(keyword)}`);
      if (!response.ok) {
        throw new Error("L·ªói khi t·∫£i danh s√°ch s·∫£n ph·∫©m.");
      }

      const data = await response.json();
      const productList = document.getElementById('productList');
      if (productList) {
        productList.innerHTML = '';

        // Nh√≥m s·∫£n ph·∫©m theo t√™n
        const productsByName = data.products.reduce((acc, product) => {
          if (!acc[product.tenSanPham]) {
            acc[product.tenSanPham] = [];
          }
          acc[product.tenSanPham].push(product);
          return acc;
        }, {});

        Object.keys(productsByName).forEach(productName => {
          const div = document.createElement('div');
          div.className = 'p-3 border rounded cursor-pointer mb-2';
          div.style.cursor = 'pointer';
          div.innerHTML = `
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-box fs-3 text-success"></i>
            <div>
              <div class="fw-semibold">${productName}</div>
              <div class="small text-muted">Nh·∫•n ƒë·ªÉ ch·ªçn bi·∫øn th·ªÉ</div>
            </div>
          </div>
        `;
          div.onmouseover = () => div.classList.add('bg-light');
          div.onmouseout = () => div.classList.remove('bg-light');
          div.onclick = () => showVariantModal(productsByName[productName][0].idChiTietSanPham);
          productList.appendChild(div);
        });
      }
    } catch (error) {
      showToast('L·ªói khi t·∫£i danh s√°ch s·∫£n ph·∫©m: ' + error.message, 'error');
    } finally {
      if (productSpinner) productSpinner.style.display = 'none';
    }
  }



  function showProductModal() {
    const productModal = document.getElementById('productModal');
    if (productModal) productModal.style.display = 'flex';
    fetchProducts();
  }

  // Trong h√†m showVariantModal, th√™m s·ª± ki·ªán sau khi render xong
  async function showVariantModal(productDetailId) {
    fetch(`${BASE_URL}/product-detail/${productDetailId}`)
            .then(async res => {
              if (!res.ok) {
                let errorMessage = "L·ªói khi l·∫•y th√¥ng tin s·∫£n ph·∫©m.";
                try {
                  const errorData = await res.json();
                  errorMessage = errorData.error || errorData.message || errorMessage;
                } catch (e) {
                  errorMessage = `HTTP ${res.status}: ${res.statusText}`;
                }
                throw new Error(errorMessage);
              }

              const data = await res.json();
              currentProductId = data.productId;

              const productModal = document.getElementById('productModal');
              const variantModal = document.getElementById('variantModal');
              const variantModalTitle = document.getElementById('variantModalTitle');
              const variantDetails = document.getElementById('variantDetails');

              if (productModal) productModal.style.display = 'none';
              if (variantModal) variantModal.style.display = 'flex';
              if (variantModalTitle) variantModalTitle.innerText = `Ch·ªçn bi·∫øn th·ªÉ: ${data.tenSanPham}`;

              if (variantDetails) {
                variantDetails.innerHTML = `
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="text-center" id="variantImage">
                <img src="${data.hinhAnh || 'https://via.placeholder.com/150x150?text=No+Image'}"
                     alt="H√¨nh ·∫£nh" class="rounded shadow-lg mx-auto mb-3"
                     style="width: 150px; height: 150px; object-fit: cover;"
                     onerror="this.src='https://via.placeholder.com/150x150?text=No+Image'">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3 d-flex justify-content-between">
                <span class="fw-medium">Gi√°:</span>
                <span id="variantPrice" class="fw-bold text-primary"></span>
              </div>
              <div class="mb-3 d-flex justify-content-between">
                <span class="fw-medium">T·ªìn kho:</span>
                <span id="variantStock" class="fw-bold text-success"></span>
              </div>
              <div class="floating-label">
                <label for="variantQuantity">S·ªë l∆∞·ª£ng</label>
                <input type="number" id="variantQuantity" min="1" value="1" class="form-control">
              </div>
            </div>
          </div>
        `;
              }

              // ƒê·∫∑t l·∫°i combobox v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
              const colorSelect = document.getElementById('colorSelect');
              const sizeSelect = document.getElementById('sizeSelect');
              if (colorSelect) colorSelect.value = '';
              if (sizeSelect) sizeSelect.value = '';
              if (variantDetails) variantDetails.classList.add('d-none');

              await fetchProductVariants();

              // Th√™m s·ª± ki·ªán sau khi modal ƒë√£ render
              if (colorSelect && sizeSelect) {
                colorSelect.onchange = () => {
                  filterSizesByColor(); // <== th√™m d√≤ng n√†y
                  fetchVariants();
                };
                sizeSelect.onchange = fetchVariants;
              }
            })
            .catch(error => {
              showToast('L·ªói khi l·∫•y th√¥ng tin s·∫£n ph·∫©m: ' + error.message, 'error');
            });
  }

  function filterSizesByColor() {
    const selectedColorId = document.getElementById("colorSelect").value;
    const sizeSelect = document.getElementById("sizeSelect");

    if (!selectedColorId || !window.productVariants || !sizeSelect) return;

    const filteredVariants = window.productVariants.filter(v => v.colorId === selectedColorId);
    const uniqueSizes = [...new Set(filteredVariants.map(v => JSON.stringify({ id: v.sizeId, ten: v.kichCo })))]
            .map(str => JSON.parse(str));

    sizeSelect.innerHTML = '<option value="">Ch·ªçn k√≠ch c·ª°</option>';
    uniqueSizes.forEach(size => {
      const option = document.createElement("option");
      option.value = size.id;
      option.text = size.ten;
      sizeSelect.appendChild(option);
    });
  }

  async function fetchProductVariants() {
    const variantSpinner = document.getElementById('variantSpinner');
    if (variantSpinner) variantSpinner.style.display = 'block';

    try {
      const response = await fetch(`${BASE_URL}/product/${currentProductId}/variants`);
      if (!response.ok) {
        let errorMessage = "L·ªói khi l·∫•y bi·∫øn th·ªÉ s·∫£n ph·∫©m.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      window.productVariants = data.variants || [];

      // L·∫•y danh s√°ch m√†u s·∫Øc v√† k√≠ch c·ª° duy nh·∫•t t·ª´ c√°c bi·∫øn th·ªÉ
      const uniqueColors = [...new Set(window.productVariants.map(v => JSON.stringify({ id: v.colorId, tenMau: v.mauSac })))].map(str => JSON.parse(str));
      const uniqueSizes = [...new Set(window.productVariants.map(v => JSON.stringify({ id: v.sizeId, ten: v.kichCo })))].map(str => JSON.parse(str));

      // Kh·ªüi t·∫°o combobox m√†u s·∫Øc
      const colorSelect = document.getElementById('colorSelect');
      if (colorSelect) {
        colorSelect.innerHTML = '<option value="">Ch·ªçn m√†u s·∫Øc</option>';
        uniqueColors.forEach(color => {
          const option = document.createElement('option');
          option.value = color.id;
          option.text = color.tenMau;
          colorSelect.appendChild(option);
        });
      }

      // Kh·ªüi t·∫°o combobox k√≠ch c·ª°
      const sizeSelect = document.getElementById('sizeSelect');
      if (sizeSelect) {
        sizeSelect.innerHTML = '<option value="">Ch·ªçn k√≠ch c·ª°</option>';
        uniqueSizes.forEach(size => {
          const option = document.createElement('option');
          option.value = size.id;
          option.text = size.ten;
          sizeSelect.appendChild(option);
        });
      }

      const variantDetails = document.getElementById('variantDetails');
      if (variantDetails) variantDetails.classList.add('d-none');
    } catch (error) {
      showToast('L·ªói khi l·∫•y bi·∫øn th·ªÉ s·∫£n ph·∫©m: ' + error.message, 'error');
    } finally {
      if (variantSpinner) variantSpinner.style.display = 'none';
    }
  }

  async function fetchVariants() {
    const colorSelect = document.getElementById("colorSelect");
    const sizeSelect = document.getElementById("sizeSelect");
    const variantDetails = document.getElementById("variantDetails");
    const variantSpinner = document.getElementById("variantSpinner");
    const variantPrice = document.getElementById("variantPrice");
    const variantStock = document.getElementById("variantStock");
    const variantImage = document.getElementById("variantImage");
    const variantQuantity = document.getElementById("variantQuantity");

    if (!colorSelect || !sizeSelect || !variantDetails || !variantSpinner || !variantPrice || !variantStock || !variantImage || !variantQuantity) {
      showToast("M·ªôt s·ªë ph·∫ßn t·ª≠ kh√¥ng ƒë∆∞·ª£c t√¨m th·∫•y trong DOM.", "error");
      console.error("Missing elements:", { colorSelect, sizeSelect, variantDetails, variantSpinner, variantPrice, variantStock, variantImage, variantQuantity });
      return;
    }

    if (!colorSelect.value || !sizeSelect.value) {
      variantDetails.classList.add("d-none");
      return;
    }

    variantSpinner.style.display = "block";
    variantDetails.classList.add("d-none");

    try {
      const response = await fetch(
              `${BASE_URL}/product/variant?productId=${currentProductId}&colorId=${colorSelect.value}&sizeId=${sizeSelect.value}`
      );
      const data = await response.json();

      if (data.error) {
        showToast(data.error, "error");
        return;
      }

      const price = parseFloat(data.price);
      const discountedPrice = parseFloat(data.discountedPrice);
      const phanTramGiam = parseFloat(data.phanTramGiam);
      const stock = parseInt(data.availableStock);

      if (variantPrice) {
        variantPrice.innerHTML = phanTramGiam > 0
                ? `<span class="text-decoration-line-through">${price.toLocaleString("vi-VN")} VNƒê</span><br>
           <span class="text-primary">${discountedPrice.toLocaleString("vi-VN")} VNƒê</span><br>
           <span class="text-success">Gi·∫£m ${phanTramGiam}%</span>`
                : `<span class="text-primary">${price.toLocaleString("vi-VN")} VNƒê</span>`;
      }
      if (variantStock) variantStock.textContent = stock;
      if (variantQuantity) variantQuantity.max = stock;
      if (variantImage) {
        const imgElement = variantImage.querySelector("img");
        if (imgElement) {
          imgElement.src = data.hinhAnh || "https://via.placeholder.com/150x150?text=No+Image";
          imgElement.onerror = () => (imgElement.src = "https://via.placeholder.com/150x150?text=No+Image");
        } else {
          variantImage.innerHTML = `
          <img src="${data.hinhAnh || "https://via.placeholder.com/150x150?text=No+Image"}"
               alt="H√¨nh ·∫£nh"
               class="rounded shadow-sm"
               style="width: 100%; max-width: 150px; height: auto;"
               onerror="this.src='https://via.placeholder.com/150x150?text=No+Image'">
        `;
        }
      }
      if (variantDetails) {
        variantDetails.dataset.productDetailId = data.productDetailId;
        variantDetails.classList.remove("d-none");
      }
    } catch (error) {
      showToast("L·ªói khi l·∫•y th√¥ng tin bi·∫øn th·ªÉ: " + error.message, "error");
    } finally {
      if (variantSpinner) variantSpinner.style.display = "none";
    }
  }
  async function openVoucherModal() {
    const m = document.getElementById('voucherModal');
    if (!m) return;

    const tab = tabs.find(t => t.id === currentTabId);
    if (tab && isShippingEnabled()) {
      if (!Number(tab.shippingFeeBase) || Number(tab.shippingFeeBase) <= 0) {
        try { await setupShippingForSelectedAddress({ recalcOnly: false }); } catch {}
      }
    }

    await fetchVouchers();         // lu√¥n n·∫°p theo tr·∫°ng th√°i m·ªõi nh·∫•t
    m.style.display = 'flex';
    updateShipSectionVisibility();
  }


  function clearVoucherSelections() {
    document
            .querySelectorAll('#voucherModal input[type=radio][name="orderVoucher"], #voucherModal input[type=radio][name="shipVoucher"]')
            .forEach(el => el.checked = false);

    const tab = tabs.find(t => t.id === currentTabId);
    if (tab) {
      tab.orderVoucherId = null;
      tab.shipVoucherId  = null;
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    }
    showToast('ƒê√£ b·ªè ch·ªçn trong modal. Nh·∫•n "√Åp d·ª•ng" ƒë·ªÉ c·∫≠p nh·∫≠t ƒë∆°n.', 'info');
  }
  function formatCashInput(value) {
    return value.replace(/\D/g, '') // ch·ªâ l·∫•y s·ªë
            .replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // th√™m d·∫•u ch·∫•m
  }
  async function onCustomerChanged(newPhone) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    // 1) C·∫≠p nh·∫≠t kh√°ch
    tab.customerPhone = newPhone || '';

    // 2) CLEAR ∆∞u ƒë√£i & v·∫≠n chuy·ªÉn theo chu·∫©n POS
    //   - Clear ORDER voucher
    tab.voucherId = null;
    tab.orderVoucherId = null;
    tab.discount = 0;

    //   - Clear SHIPPING voucher + ph√≠ ship + ƒë·ªãa ch·ªâ
    tab.shipVoucherId = null;
    tab.shippingDiscount = 0;
    tab.shippingFeeBase = 0;
    tab.selectedAddress = '';

    // 3) UI: b·ªè ch·ªçn radio trong modal (n·∫øu ƒëang m·ªü)
    document.querySelectorAll('#voucherModal input[name="orderVoucher"]').forEach(r => (r.checked = false));
    document.querySelectorAll('#voucherModal input[name="shipVoucher"]').forEach(r => (r.checked = false));

    // 4) C·∫≠p nh·∫≠t t√≥m t·∫Øt + l∆∞u
    updateSummary(tab);
    localStorage.setItem('orderTabs', JSON.stringify(tabs));

    // 5) ƒêi·ªÅu ch·ªânh hi·ªÉn th·ªã giao h√†ng theo s·ªë m·ªõi (kho√° n·∫øu kh√°ch l·∫ª)
    setDeliveryVisibilityForPhone(newPhone);
    toggleAddressSection(); // s·∫Ω ·∫©n khu giao h√†ng n·∫øu b·ªã kho√°

    // 6) N·∫°p l·∫°i ƒë·ªãa ch·ªâ & danh s√°ch voucher theo kh√°ch m·ªõi
    if (newPhone && newPhone !== '0999999999') {
      await fetchCustomerAddresses();
    } else {
      clearAddressUI();
    }
    await fetchVouchers();
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    // GHN: preload provinces
    ghnLoadProvinces().catch(() => {});

    // Khi ƒë·ªïi d·ªãch v·ª• ‚Üí t√≠nh l·∫°i ph√≠ ngay
    const shippingMethodSelect = document.getElementById('shippingMethod');
    if (shippingMethodSelect) {
      shippingMethodSelect.addEventListener('change', () => {
        setupShippingForSelectedAddress({ recalcOnly: true });
      });
    }

    // Khi ƒë·ªïi ƒë·ªãa ch·ªâ ‚Üí t√≠nh l·∫°i GHN (g·ªôp 1 listener duy nh·∫•t)
    const addressSelect = document.getElementById('addressSelect');
    if (addressSelect) {
      addressSelect.addEventListener('change', () => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (!tab) return;

        tab.selectedAddress = addressSelect.value || '';
        localStorage.setItem('orderTabs', JSON.stringify(tabs));

        if (!tab.selectedAddress) {
          zeroShippingBecauseNoAddress();
          return;
        }
        setupShippingForSelectedAddress();
      });
    }

    // Nh·∫≠p ti·ªÅn m·∫∑t (ƒë·ªãnh d·∫°ng & c·∫≠p nh·∫≠t t√≥m t·∫Øt)
    // Nh·∫≠p ti·ªÅn m·∫∑t (ƒë·ªãnh d·∫°ng, clamp theo DECIMAL(18,2) & c·∫≠p nh·∫≠t t√≥m t·∫Øt)
    const cashInput = document.getElementById('cashAmount');
    if (cashInput) {
      let cashOverflowWarnedAt = 0;

      cashInput.addEventListener('input', (e) => {
        // L·∫•y s·ªë, clamp theo DECIMAL(18,2)
        const rawDigits = e.target.value.replace(/[^\d]/g, '');
        const { digits, over } = clampCashToDbLimit(rawDigits);

        // Ghi l·∫°i l√™n √¥ input theo ƒë√∫ng format "12.345"
        e.target.value = formatBigVndDigits(digits);

        // C·∫£nh b√°o (debounce ƒë·ªÉ kh√¥ng spam)
        if (over) {
          const now = Date.now();
          if (now - cashOverflowWarnedAt > 1200) {
            showToast(
                    `Gi√° tr·ªã t·ªëi ƒëa cho ph√©p l√† ${formatBigVndDigits(MAX_VND_BIG.toString())} VNƒê.`,
                    'warning'
            );
            cashOverflowWarnedAt = now;
          }
          e.target.classList.add('is-invalid');
        } else {
          e.target.classList.remove('is-invalid');
        }

        // C·∫≠p nh·∫≠t state & t√≥m t·∫Øt (tab.cashAmount v·∫´n l√† Number cho c√°c case b√¨nh th∆∞·ªùng)
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.cashAmount = Number(digits) || 0; // ƒë·ªß an to√†n cho h·∫ßu h·∫øt case th·ª±c t·∫ø
          updateSummary(tab);
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
      });

      // Khi blur c≈©ng ki·ªÉm tra l·∫°i ƒë·ªÉ ch·∫Øc c√∫
      cashInput.addEventListener('blur', (e) => {
        const { digits, over } = clampCashToDbLimit(e.target.value);
        if (over) {
          e.target.value = formatBigVndDigits(digits);
          e.target.classList.add('is-invalid');
          showToast(
                  `S·ªë ti·ªÅn v∆∞·ª£t gi·ªõi h·∫°n l∆∞u tr·ªØ. Vui l√≤ng nh·∫≠p ‚â§ ${formatBigVndDigits(MAX_VND_BIG.toString())} VNƒê.`,
                  'warning'
          );
        }
      });
    }

    // Enter tr√™n √¥ SƒêT ‚Üí t·∫£i ƒë·ªãa ch·ªâ
    const customerPhone = document.getElementById('customerPhone');
    if (customerPhone) {
      customerPhone.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();                // kh√¥ng submit form
          const n = finalizePhoneInput();    // chu·∫©n ho√° + l∆∞u v√†o tab + validate
          if (!n) return;                    // sai -> gi·ªØ focus, KH√îNG blur (tr√°nh toast l·∫∑p)
          setDeliveryVisibilityForPhone(n);  // c·∫≠p nh·∫≠t cho ph√©p/kh√≥a "Giao h√†ng"
          fetchCustomerAddresses();          // n·∫°p ƒë·ªãa ch·ªâ n·∫øu c√≥
          customerPhone.blur();
        }
      });
    }

    if (customerPhone) {
      // Ch·ªâ cho s·ªë v√† duy nh·∫•t d·∫•u + ·ªü ƒë·∫ßu
      customerPhone.addEventListener('input', () => {
        let v = customerPhone.value.replace(/[^\d+]/g, '');
        if (v.indexOf('+') > 0) v = v.replace(/\+/g, '');
        customerPhone.value = v;
      });

      // Khi r·ªùi √¥: chu·∫©n ho√°, c·∫£nh b√°o n·∫øu sai, v√† l∆∞u v√†o tab
      customerPhone.addEventListener('blur', () => {
        const n = normalizeVNPhone(customerPhone.value);
        if (n && !isValidVNPhone(n) && n !== '0999999999') {
          showToast('SƒêT VN kh√¥ng h·ª£p l·ªá: di ƒë·ªông 10 s·ªë (03/05/07/08/09) ho·∫∑c c·ªë ƒë·ªãnh 11 s·ªë (02...)', 'warning');
          return;
        }
        customerPhone.value = n;
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.customerPhone = n || '';
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
      });

      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã giao h√†ng theo SƒêT + l∆∞u tab khi change
      customerPhone.addEventListener('change', () => {
        const n = normalizeVNPhone(customerPhone.value);
        setDeliveryVisibilityForPhone(n);
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.customerPhone = n || '';
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
      });
    }
    // Ph√≠ v·∫≠n chuy·ªÉn (FE cho ph√©p nh·∫≠p tay) ‚Üí ghi v√†o ph√≠ g·ªëc
    const shippingFee = document.getElementById('shippingFee');
    if (shippingFee) {
      shippingFee.value = formatCurrency(shippingFee.value);
      shippingFee.addEventListener('input', () => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (!tab) return;
        const raw = unformatCurrency(shippingFee.value);
        shippingFee.value = formatCurrency(raw);

        const prevBase = Number(tab.shippingFeeBase || 0);
        tab.shippingFeeBase = raw;
        updateSummary(tab);
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
        reapplyCurrentOrderVoucher();
        reapplyCurrentShipVoucher();

        if (tab.voucherId && !isApplyingVoucher && prevBase !== raw) {
          applyVoucher(tab.voucherId);
        }
      });
    }


    // Th√™m tab ƒë∆°n h√†ng
    const addTabBtn = document.getElementById('addTabBtn');
    if (addTabBtn) {
      addTabBtn.addEventListener('click', addNewTab);
    }

    // Ch·ªçn voucher
    const voucherSelect = document.getElementById('voucherSelect');
    if (voucherSelect) {
      voucherSelect.addEventListener('change', (e) => {
        applyVoucher(e.target.value || null);
      });
    }

    // T√¨m kh√°ch h√†ng trong modal
    const customerSearch = document.getElementById('customerSearch');
    if (customerSearch) {
      customerSearch.addEventListener('input', () => {
        const keyword = customerSearch.value.trim();
        fetchCustomers(keyword);
      });
    }

    // ƒê·ªïi ph∆∞∆°ng th·ª©c thanh to√°n
    const paymentMethodSelect = document.getElementById('paymentMethod');
    if (paymentMethodSelect) {
      paymentMethodSelect.addEventListener('change', async (e) => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (!tab) return;

        tab.paymentMethod = e.target.value;            // l∆∞u PTTT m·ªõi
        toggleCashInput();                              // ·∫©n/hi·ªán √¥ ti·ªÅn m·∫∑t
        localStorage.setItem('orderTabs', JSON.stringify(tabs));

        // üîÅ Ki·ªÉm tra l·∫°i, t·ª± g·ª° & b√°o ngay n·∫øu m√£ kh√¥ng c√≤n h·ª£p l·ªá theo PTTT m·ªõi
        await revalidateVouchersOnPaymentChange();
      });
    }


    // Kh·ªüi t·∫°o khi trang load
    initTabs();
  });
  // === Helper ki·ªÉm tra ƒëi·ªÅu ki·ªán cho ph√©p d√πng Freeship ===
  function isShippingEnabled() {
    const tab = tabs.find(t => t.id === currentTabId);
    return !!(tab && tab.saleMethod === 'Giao h√†ng' && tab.selectedAddress);
  }

  // ·∫®n/hi·ªán section Freeship trong modal theo ƒëi·ªÅu ki·ªán giao h√†ng
  function updateShipSectionVisibility() {
    const shipList = document.getElementById('shipVoucherList');
    const shipSection = shipList ? shipList.closest('.mb-4') : null; // b·ªçc ngo√†i title "Freeship (SHIPPING)"
    if (!shipSection) return;
    shipSection.classList.toggle('d-none', !isShippingEnabled());
  }
  function dedupById(arr) {
    const seen = new Set();
    return (arr || []).filter(v => {
      const id = String(v?.id ?? '');
      if (!id || seen.has(id)) return false;
      seen.add(id);
      return true;
    });
  }
  // Chu·∫©n ho√° type voucher
  // Chu·∫©n ho√° type voucher
  function getVoucherType(v, fallback = '') {
    // 1) ∆ØU TI√äN scope t·ª´ backend
    const scope = String(
            v?.phamViApDung ?? v?.phamviapdung ?? v?.scope ?? ''
    ).toUpperCase();
    if (scope === 'ORDER' || scope === 'SHIPPING') return scope;

    // 2) N·∫øu FE ƒë√£ g·∫Øn __type (t·ª´ typedOrder/typedShip), d√πng lu√¥n
    if (v?.__type === 'ORDER' || v?.__type === 'SHIPPING') return v.__type;

    // 3) ƒê·ª™NG d√πng loaiGiamGia (PHAN_TRAM/TIEN) ƒë·ªÉ ƒëo√°n ph·∫°m vi
    let raw = (
            v?.type ?? v?.loai ?? v?.voucherType ?? v?.category ?? v?.kind ?? fallback
    );
    raw = (raw == null ? '' : String(raw)).toUpperCase();

    if (/SHIP|FREESHIP/.test(raw)) return 'SHIPPING';
    if (/ORDER|ƒê∆†N|DON|TOTAL|HOA ?DON/.test(raw)) return 'ORDER';

    // 4) ƒêo√°n theo t√™n/m√¥ t·∫£ (ph·ª•)
    const text = `${v?.ten ?? ''} ${v?.title ?? ''} ${v?.moTa ?? ''} ${v?.description ?? ''}`.toLowerCase();
    if (/ship|v·∫≠n.?chuy·ªÉn|van chuyen|freeship/.test(text)) return 'SHIPPING';

    // 5) M·∫∂C ƒê·ªäNH ‚Üí ORDER (ƒë·ªÉ kh√¥ng b·ªã r∆°i m·∫•t phi·∫øu)
    return 'ORDER';
  }
  function getVoucherCode(v) {
    return String(v?.ma ?? v?.code ?? v?.voucherCode ?? v?.maPhieu ?? '')
            .trim()
            .toUpperCase();
  }

  // Gi·ªØ logic c≈© cho SHIPPING, ch·ªâ th√™m rule ƒë·∫∑c bi·ªát cho FREESHIP_FULL
  function labelShipVoucher(v, shipBase) {
    const fmt  = n => (Number(n)||0).toLocaleString('vi-VN') + ' ‚Ç´';
    const base = Math.max(0, Number(shipBase || 0));
    const code = String(v?.ma ?? v?.code ?? v?.voucherCode ?? v?.maPhieu ?? '').toUpperCase();

    if (code === 'FREESHIP_FULL') return 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn';

    // Nh·∫≠n di·ªán lo·∫°i gi·∫£m: % hay ti·ªÅn
    const typeRaw = String(v?.loaiGiamGia ?? v?.discountType ?? v?.type ?? '').toUpperCase();
    const isPercentType = /PHAN|PERCENT|%/.test(typeRaw);
    const isAmountType  = /TIEN|AMOUNT|VND|FIXED/.test(typeRaw);

    // ƒê·ªçc % (c√≥ khi BE ƒë·ªÉ 0.12)
    const readPercent = () => {
      let pct = Number(
              v?.phanTram ?? v?.phanTramGiam ?? v?.phanTramGiamGia ??
              v?.tyLe ?? v?.percentage ?? v?.tyLeGiam ?? 0
      );
      if (!pct && isPercentType) {
        // BE nh√©t % v√†o giaTriGiam khi loaiGiamGia = PHAN_TRAM
        pct = Number(v?.giaTriGiam ?? v?.mucGiam ?? 0);
      }
      if (pct > 0 && pct <= 1) pct *= 100; // 0.12 -> 12%
      return Math.max(0, pct);
    };

    // ƒê·ªçc s·ªë ti·ªÅn
    const readAmount = () => {
      const val =
              v?.giaTriGiam ?? v?.mucGiam ?? v?.soTien ??
              v?.discountAmount ?? v?.fixedDiscount ?? 0;
      return Math.max(0, Number(val) || 0);
    };

    const capRaw =
            v?.mucGiamToiDa ?? v?.giamToiDa ?? v?.maxDiscount ??
            v?.maxShipDiscount ?? v?.tranGiamVanChuyen ?? v?.cap ?? v?.giaTriGiamToiDa;
    const cap = capRaw == null ? Infinity : (Number(capRaw) || Infinity);

    const pct = readPercent();
    const fixed = isPercentType ? 0 : readAmount(); // n·∫øu ƒë√£ x√°c ƒë·ªãnh l√† % th√¨ kh√¥ng coi giaTriGiam l√† ti·ªÅn

    let est = 0;
    if (fixed > 0) est = Math.min(fixed, base);
    else if (pct > 0) est = Math.min(Math.floor(base * pct / 100), cap);

    if (base > 0 && est >= base) return 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn';

    if (fixed > 0) return `Gi·∫£m ${fmt(fixed)} ph√≠ v·∫≠n chuy·ªÉn`;

    if (pct > 0) {
      const tail = Number.isFinite(cap) && cap !== Infinity ? ` (t·ªëi ƒëa ${fmt(cap)})` : '';
      return base > 0
              ? `Gi·∫£m ~${fmt(est)} ph√≠ v·∫≠n chuy·ªÉn${tail}`
              : `Gi·∫£m ${pct}% ph√≠ v·∫≠n chuy·ªÉn${tail}`;
    }

    return 'Gi·∫£m ph√≠ v·∫≠n chuy·ªÉn';
  }

  // Cho ph√©p radio trong 1 nh√≥m b·∫•m l·∫ßn 2 ƒë·ªÉ b·ªè ch·ªçn
  function enableRadioToggleOff(groupName, onChange) {
    const radios = document.querySelectorAll(`#voucherModal input[name="${groupName}"]`);
    radios.forEach(radio => {
      // ghi nh·ªõ tr·∫°ng th√°i tr∆∞·ªõc click
      radio.addEventListener('mousedown', function () { this._wasChecked = this.checked; });
      radio.addEventListener('click', function () {
        // n·∫øu tr∆∞·ªõc ƒë√≥ ƒëang checked -> click l·∫ßn 2 ƒë·ªÉ b·ªè ch·ªçn
        if (this._wasChecked) {
          this.checked = false;
          // ph√°t s·ª± ki·ªán change cho c√°c logic kh√°c (n·∫øu c√≥)
          this.dispatchEvent(new Event('change', { bubbles: true }));
          if (typeof onChange === 'function') onChange(null);
        } else {
          if (typeof onChange === 'function') onChange(this.value);
        }
      });
    });
  }


  // Render danh s√°ch ORDER / SHIPPING v√†o modal
  function renderVoucherModalLists(allVouchers = []) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const orderList = document.getElementById('orderVoucherList');
    const shipList  = document.getElementById('shipVoucherList');
    if (!orderList || !shipList) return;

    orderList.innerHTML = '';
    shipList.innerHTML  = '';

    const fmtVND = (n) => (Number(n) || 0).toLocaleString('vi-VN') + ' VNƒê';
    const fmtPct = (x) => {
      const n = Number(x) || 0;
      return Number.isInteger(n) ? String(n) : String(+n.toFixed(2));
    };

    const firstNonEmpty = (obj, keys = []) => {
      for (const k of keys) {
        const v = obj?.[k];
        if (v === 0) return 0;
        if (v !== undefined && v !== null) {
          if (typeof v === 'string' && v.trim() === '') continue;
          return v;
        }
      }
      return null;
    };

    const toNumberSafe = (val) => {
      if (val == null) return 0;
      if (typeof val === 'number' && !isNaN(val)) return val;
      const s = String(val).trim();
      const kMatch = s.match(/^(\d+(?:[.,]\d+)?)\s*k$/i);
      if (kMatch) return Math.round(parseFloat(kMatch[1].replace(',', '.')) * 1000);
      const m = s.match(/-?\d+(?:[.,]\d+)?/);
      if (!m) return 0;
      return Number(m[0].replace(',', '.'));
    };

    const domMoney = (id) => {
      const el = document.getElementById(id);
      if (!el) return 0;
      const raw = ('value' in el && el.value != null) ? String(el.value) : String(el.textContent || '');
      const n = Number(raw.replace(/[^\d]/g, ''));
      return isNaN(n) ? 0 : n;
    };

    const _normType = (s) =>
            String(s || '')
                    .toUpperCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^A-Z0-9%]/g, '');

    function _isLikelyPercent(v) {
      const raw = firstNonEmpty(v, ['giaTriGiam','mucGiam']);
      const val = toNumberSafe(raw);
      if (!(val > 0)) return false;
      if (/%/.test(String(raw))) return true;
      const cap = toNumberSafe(firstNonEmpty(v, [
        'mucGiamToiDa','giamToiDa','maxDiscount','maxShipDiscount','tranGiamVanChuyen','cap','giaTriGiamToiDa'
      ]));
      const hasMoneyFields = firstNonEmpty(v, ['soTien','discountAmount','fixedDiscount']) != null;
      if (val <= 100 && (!hasMoneyFields || cap > 0)) return true;
      return false;
    }

    function getPercent(v) {
      const typeRaw = _normType(
              v?.loaiGiamGia ?? v?.discountType ?? v?.type ??
              v?.hinhThucGiamGia ?? v?.kieuGiamGia ?? v?.hinhThuc ?? v?.kieu ?? ''
      );
      const isPercentType = /(PHANTRAM|PERCENT|PCT|TYLE|%)/.test(typeRaw);

      let pct = toNumberSafe(firstNonEmpty(v, [
        'phanTram','phanTramGiam','phanTramGiamGia','tyLe','percentage','tyLeGiam'
      ]));

      if ((!pct || pct === 0) && isPercentType) {
        pct = toNumberSafe(firstNonEmpty(v, ['giaTriGiam','mucGiam']));
      }
      if (!pct || pct === 0) {
        const rawCandidate = firstNonEmpty(v, ['giaTriGiam','mucGiam']);
        if (/%/.test(String(rawCandidate))) {
          pct = toNumberSafe(rawCandidate);
        }
      }
      if ((!pct || pct === 0) && _isLikelyPercent(v)) {
        pct = toNumberSafe(firstNonEmpty(v, ['giaTriGiam','mucGiam']));
      }
      if (pct > 0 && pct <= 1) pct *= 100;
      return Math.max(0, pct || 0);
    }

    function getMoneyDiscount(v) {
      const typeRaw = _normType(
              v?.loaiGiamGia ?? v?.discountType ?? v?.type ??
              v?.hinhThucGiamGia ?? v?.kieuGiamGia ?? v?.hinhThuc ?? v?.kieu ?? ''
      );
      const isPercentType = /(PHANTRAM|PERCENT|PCT|TYLE|%)/.test(typeRaw);

      const raw = firstNonEmpty(v, [
        'giaTriGiam','mucGiam','soTien','discountAmount','fixedDiscount'
      ]);
      if (/%/.test(String(raw)) || isPercentType || _isLikelyPercent(v)) return 0;
      return toNumberSafe(raw);
    }

    const getMinOrder    = (v) => toNumberSafe(firstNonEmpty(v, ['donToiThieu','giaTriGiamToiThieu','minOrder','donHangToiThieu','minTotal','minSubtotal']));
    const getMaxDiscount = (v) => toNumberSafe(firstNonEmpty(v, ['mucGiamToiDa','giamToiDa','maxDiscount','maxShipDiscount','tranGiamVanChuyen','cap','giaTriGiamToiDa']));
    const getExpiry      = (v) => firstNonEmpty(v, ['ngayKetThuc','thoiGianKetThuc','hanSuDung','expiredAt','endAt']);

    const _pmNormalize = (s) =>
            String(s || '')
                    .toUpperCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^A-Z0-9]/g, '');

    function _buildFallbackPMMap() {
      const M = new Map();
      ['CASH','TIENMAT','TM','MAT','COD'].forEach(k => M.set(k, 'üíµ Ti·ªÅn m·∫∑t'));
      ['BANK','BANKTRANSFER','TRANSFER','CK','CHUYENKHOAN','ATM','IB','INTERNETBANKING'].forEach(k => M.set(k, 'üè¶ Chuy·ªÉn kho·∫£n'));
      ['WALLET','EWALLET','VI','VIDIENTU','MOMO','ZALOPAY','VNPAY','PAYOS','AIRPAY','SHOPEEPAY'].forEach(k => M.set(k, 'üëõ V√≠'));
      M.set(_pmNormalize('550E8400-E29B-41D4-A716-446655440017'), 'üíµ Ti·ªÅn m·∫∑t');
      M.set(_pmNormalize('550E8400-E29B-41D4-A716-446655440018'), 'üè¶ Chuy·ªÉn kho·∫£n');
      return M;
    }

    const pmMap = (() => {
      const map = _buildFallbackPMMap();
      const sel = document.getElementById('paymentMethod');
      if (sel) {
        [...sel.options].forEach(o => {
          const label = (o.text || '').trim();
          const key = _pmNormalize(o.value);
          if (label) map.set(key, label);
        });
      }
      return map;
    })();

    function parsePaymentMethodsFromVoucher(v, pmMap) {
      const candidates = [
        v?.paymentMethods, v?.allowedPaymentMethods, v?.phuongThucThanhToan,
        v?.phuongThucApDung, v?.apDungChoPhuongThuc, v?.methods,
        v?.methodIds, v?.paymentMethodIds
      ];
      const hasConstraint = candidates.some(c => c != null);
      if (!hasConstraint) return { labels: [], keys: new Set(), hasConstraint: false };

      let raw = candidates.find(c => c != null);
      const arr = [];
      const pushVal = (x) => {
        if (x == null) return;
        if (typeof x === 'number') { arr.push(String(x)); return; }
        if (typeof x === 'string') { arr.push(x); return; }
        if (Array.isArray(x)) { x.forEach(pushVal); return; }
        if (typeof x === 'object') {
          const fields = ['id','code','value','method','name','ma','maPhuongThuc'];
          for (const f of fields) if (x[f]) { arr.push(String(x[f])); return; }
          arr.push(JSON.stringify(x));
        }
      };
      pushVal(raw);

      const outLabels = [];
      const outKeys   = new Set();
      const seenLabel = new Set();

      for (const x of arr) {
        const key = _pmNormalize(x);
        outKeys.add(key);

        let label = pmMap.get(key);
        if (!label) {
          if (/CASH|TIEN.?MAT|^TM$/.test(key))      label = 'üíµ Ti·ªÅn m·∫∑t';
          else if (/BANK|TRANSFER|CHUYEN.?KHOAN|^CK$/.test(key)) label = 'üè¶ Chuy·ªÉn kho·∫£n';
          else if (/WALLET|VI|MOMO|ZALO|VNPAY|PAYOS|AIRPAY|SHOPEE/.test(key)) label = 'üëõ V√≠';
        }
        if (!label) label = String(x);

        if (!seenLabel.has(label)) {
          seenLabel.add(label);
          outLabels.push(label);
        }
      }

      return { labels: outLabels, keys: outKeys, hasConstraint: true };
    }

    function ptttLabelFromMaps(v) {
      const id = String(v?.id ?? '').trim();
      const code = getVoucherCode(v);
      const label =
              (id && voucherPtttMapById && voucherPtttMapById[id]) ? voucherPtttMapById[id]
                      : (code && voucherPtttMapByMa && voucherPtttMapByMa[code]) ? voucherPtttMapByMa[code]
                              : '';
      return label ? `PTTT: ${label}` : '';
    }

    function buildPaymentMethodLabel(v) {
      const fromMap = ptttLabelFromMaps(v);
      if (fromMap) return fromMap;

      const { labels, hasConstraint } = parsePaymentMethodsFromVoucher(v, pmMap);
      if (!hasConstraint) return 'PTTT: T·∫•t c·∫£';
      if (labels.length === 0) return 'PTTT: C√≥ gi·ªõi h·∫°n';
      return `PTTT: ${labels.join(', ')}`;
    }

    let shipBase = Number(tab.shippingFeeBase || 0) || domMoney('shippingFeeBaseDisplay') || domMoney('shippingFee');
    let subTotal = Number(tab.subTotal || 0) || domMoney('subTotal');

    const paymentSel = document.getElementById('paymentMethod');
    const currentPaymentLabel = (paymentSel && paymentSel.options[paymentSel.selectedIndex])
            ? (paymentSel.options[paymentSel.selectedIndex].text || '').trim()
            : '';
    const currentPaymentKey = _pmNormalize(paymentSel?.value || '');

    const orders = [];
    const ships  = [];
    (Array.isArray(allVouchers) ? allVouchers : []).forEach(v => {
      const t = getVoucherType(v);
      if (t === 'SHIPPING') ships.push(v);
      else orders.push(v);
    });

    function buildInfoLine(v, type = 'ORDER') {
      let main = '';
      if (type === 'SHIPPING') {
        main = labelShipVoucher(v, shipBase);
      } else {
        const pct   = getPercent(v);
        const money = getMoneyDiscount(v);
        if (pct > 0)       main = `Gi·∫£m ${fmtPct(pct)}%`;
        else if (money>0)  main = `Gi·∫£m ${fmtVND(money)}`;
        else               main = 'Gi·∫£m';
      }

      const parts = [main];
      parts.push(buildPaymentMethodLabel(v));

      const pctForInfo = getPercent(v);
      if (pctForInfo > 0 && !/Gi·∫£m\s+\d+(\.\d+)?%/.test(main)) {
        parts.push(`∆Øu ƒë√£i: ${fmtPct(pctForInfo)}%`);
      }

      const minOrder = getMinOrder(v);
      if (minOrder) parts.push(`ƒêH t·ªëi thi·ªÉu: ${fmtVND(minOrder)}`);

      const expiry = getExpiry(v);
      if (expiry) {
        const d = new Date(expiry);
        if (!isNaN(d.getTime())) parts.push(`HSD: ${d.toLocaleDateString('vi-VN')}`);
      }

      if (type === 'SHIPPING' && minOrder && subTotal < minOrder) {
        parts.push(`Mua th√™m ${fmtVND(minOrder - subTotal)} ƒë·ªÉ mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn`);
      }
      return parts.join(' ‚Ä¢ ');
    }

    // === UPDATED: ki·ªÉm tra h·∫øt h·∫°n/h·∫øt s·ªë l∆∞·ª£ng + c√°c ƒëi·ªÅu ki·ªán kh√°c
    function checkEligibility(v, type) {
      const reasons = [];
      let ok = true;

      // h·∫øt h·∫°n
      const expiry = getExpiry(v);
      if (expiry) {
        const d = new Date(expiry);
        if (!isNaN(d.getTime()) && d.getTime() < Date.now()) {
          ok = false;
          reasons.push('M√£ ƒë√£ h·∫øt h·∫°n');
        }
      }

      // h·∫øt s·ªë l∆∞·ª£ng/l∆∞·ª£t
      const qtyFields = [
        v?.soLuongConLai, v?.soLuong, v?.remaining, v?.remain, v?.stockLeft,
        v?.soLuotConLai, v?.soLuotSuDungConLai, v?.gioiHanSuDungConLai
      ];
      const left = qtyFields.map(Number).find(x => Number.isFinite(x));
      if (left !== undefined && left <= 0) {
        ok = false;
        reasons.push('H·∫øt s·ªë l∆∞·ª£ng');
      }

      // min order
      const minOrder = getMinOrder(v);
      if (minOrder && subTotal < minOrder) {
        ok = false;
        reasons.push('Ch∆∞a ƒë·∫°t gi√° tr·ªã t·ªëi thi·ªÉu');
      }

      // SHIPPING ƒëi·ªÅu ki·ªán
      if (type === 'SHIPPING') {
        if (!isShippingEnabled()) {
          ok = false;
          reasons.push('Ch·ªâ √°p d·ª•ng khi Giao h√†ng + c√≥ ƒë·ªãa ch·ªâ');
        } else if (!shipBase || shipBase <= 0) {
          reasons.push('Ph√≠ VC g·ªëc = 0');
        }
      }

      // PTTT ph√π h·ª£p?
      const candidates = parsePaymentMethodsFromVoucher(v, pmMap);
      if (candidates.hasConstraint && (candidates.labels.length > 0 || candidates.keys.size > 0)) {
        const labelMatch = candidates.labels.includes(currentPaymentLabel);
        const keyMatch   = candidates.keys.has(currentPaymentKey);
        if (!labelMatch && !keyMatch) {
          ok = false;
          reasons.push('Kh√¥ng √°p d·ª•ng cho PTTT ƒëang ch·ªçn');
        }
      }

      return { ok, message: reasons.join('; ') };
    }

    const makeOrderItem = (v, checked, disabled, reason) => `
    <label class="d-flex align-items-center justify-content-between p-3 border rounded-3 ${disabled ? 'bg-light' : ''}">
      <div class="me-3">
        <div class="fw-semibold">${v.ten || v.title || ('M√£ ' + (v.ma || v.code || v.id))}</div>
        <div class="small text-muted">${buildInfoLine(v, 'ORDER')}</div>
        ${disabled ? `<div class="small text-danger mt-1"><i class="fa fa-circle-exclamation me-1"></i>${reason}</div>` : ''}
      </div>
      <input type="radio" name="orderVoucher" value="${v.id}" ${checked ? 'checked' : ''} ${disabled ? 'disabled' : ''}>
    </label>`;

    const makeShipItem = (v, checked, disabled, reason) => `
    <label class="d-flex align-items-center justify-content-between p-3 border rounded-3 ${disabled ? 'bg-light' : ''}">
      <div class="me-3">
        <div class="fw-semibold">${v.ten || v.title || ('M√£ ' + (v.ma || v.code || v.id))}</div>
        <div class="small text-muted">${buildInfoLine(v, 'SHIPPING')}</div>
        ${disabled ? `<div class="small text-danger mt-1"><i class="fa fa-circle-exclamation me-1"></i>${reason}</div>` : ''}
      </div>
      <input type="radio" name="shipVoucher" value="${v.id}" ${checked ? 'checked' : ''} ${disabled ? 'disabled' : ''}>
    </label>`;

    const orderItems = [];
    const shipItems  = [];

    orders.forEach(v => {
      const eligible = checkEligibility(v, 'ORDER');
      const checked  = String(tab.orderVoucherId || tab.voucherId || '') === String(v.id) && eligible.ok;
      orderItems.push({ html: makeOrderItem(v, checked, !eligible.ok, eligible.message), sortKey: checked ? 0 : 1 });
    });

    ships.forEach(v => {
      const eligible = checkEligibility(v, 'SHIPPING');
      const checked  = String(tab.shipVoucherId || '') === String(v.id) && eligible.ok;
      shipItems.push({ html: makeShipItem(v, checked, !eligible.ok, eligible.message), sortKey: checked ? 0 : 1 });
    });

    orderItems.sort((a,b) => a.sortKey - b.sortKey);
    shipItems.sort((a,b) => a.sortKey - b.sortKey);

    orderList.innerHTML = orderItems.map(x => x.html).join('') || `<div class="text-muted small">Ch∆∞a c√≥ m√£ ƒë∆°n h√†ng kh·∫£ d·ª•ng.</div>`;
    shipList.innerHTML  = shipItems.map(x => x.html).join('')  || `<div class="text-muted small">Ch∆∞a c√≥ m√£ Freeship kh·∫£ d·ª•ng.</div>`;

    enableRadioToggleOff('orderVoucher');
    enableRadioToggleOff('shipVoucher');

    updateShipSectionVisibility();
  }



  // ==== Modal helpers ====




  function clearVoucherSelections() {
    document.querySelectorAll('#voucherModal input[name="orderVoucher"]').forEach(r => { r.checked = false; });
    document.querySelectorAll('#voucherModal input[name="shipVoucher"]').forEach(r => { r.checked = false; });
    // KH√îNG ƒë·ª•ng state ƒëang √°p d·ª•ng (tab.orderVoucherId / tab.shipVoucherId) cho t·ªõi khi ng∆∞·ªùi d√πng b·∫•m "√Åp d·ª•ng"
    showToast('ƒê√£ b·ªè ch·ªçn trong modal. Nh·∫•n "√Åp d·ª•ng" ƒë·ªÉ c·∫≠p nh·∫≠t ƒë∆°n.', 'info');
  }





  // M·ªü/ƒë√≥ng modal voucher


  function closeVoucherModal() {
    const m = document.getElementById('voucherModal');
    if (m) m.style.display = 'none';
  }
  // B·ªè ch·ªçn t·∫•t c·∫£ radio trong modal






</script>
<script th:src="@{/js/notification.js}"></script>

</body>
</html>