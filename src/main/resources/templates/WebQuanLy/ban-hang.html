<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bán Hàng Tại Quầy</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    .modal-dialog { max-width: 800px; }
    .product-image { max-width: 50px; max-height: 50px; }
    .cart-empty-state { text-align: center; padding: 20px; color: #6c757d; }
    .toast { background-color: #fff3cd; border-color: #ffeeba; }
    .toast-header { background-color: #fff3cd; color: #856404; }
    .payment-processing { display: none; text-align: center; padding: 10px; }

    #qr-reader {
      width: 300px;
      margin: 0 auto;
      display: none;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }
    .toast {
      background: linear-gradient(135deg, #198754, #28a745);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      border-radius: 10px;
      animation: slideIn 0.3s ease-out;
      font-size: 15px;
    }
    .toast-body {
      font-weight: 500;
      padding-right: 0.75rem;
    }
    .toast .btn-close {
      filter: brightness(0) invert(1);
    }
    .toast .progress {
      height: 4px;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 0 0 10px 10px;
    }
    .toast .progress-bar {
      background-color: #fff;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>

<div class="container mt-4">
  <!-- Vùng hiện camera cho QR -->
  <div id="qr-reader" style="width: 300px; margin: 0 auto; display: none;" class="my-3 border rounded"></div>
  <h2>Bán Hàng Tại Quầy</h2>
  <div class="row">
    <!-- Danh sách sản phẩm -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">Danh Sách Sản Phẩm</div>
        <button class="btn btn-outline-dark mb-3" onclick="startQrScanner()">
          <i class="fa-solid fa-qrcode"></i> Quét QR
        </button>
        <div class="card-body">
          <table class="table table-striped" id="productList">
            <thead>
            <tr>
              <th>STT</th>
              <th>Hình Ảnh</th>
              <th>Tên Sản Phẩm</th>
              <th>Số Lượng Tồn</th>
              <th>Giá (VNĐ)</th>
              <th>Mã QR</th>
              <th>Hành Động</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="product, stat : ${products}">
              <td th:text="${stat.count}"></td>
              <td><img th:src="${product.urlHinhAnh}" alt="Product Image" class="product-image"></td>
              <td th:text="${product.tenSanPham}"></td>
              <td th:text="${product.totalStockQuantity}" id="stock-${product.id}"></td>
              <td th:text="${product.minPriceFormatted} + ' - ' + ${product.maxPriceFormatted}"></td>
              <td>
                <!-- Thêm mã QR cho từng biến thể -->
                <div th:each="variant : ${product.chiTietSanPhams}">
                  <img th:src="@{/generate-qr(data='productDetailId:' + ${variant.id})}" alt="QR Code" style="max-width: 50px; max-height: 50px;">
                </div>
              </td>
              <td>
                <button class="btn btn-primary btn-sm" th:attr="data-product-id=${product.id}" onclick="showProductVariants(this)">Chọn</button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Giỏ hàng và thông tin -->
    <div class="col-md-4">
      <form id="orderForm">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title d-flex align-items-center">
              <i class="fa-solid fa-cart-shopping me-2"></i>
              <span>Giỏ hàng</span>
              <span class="badge bg-primary ms-2" id="cartItemCount">0</span>
            </h5>

            <!-- Customer Selection -->
            <div class="customer-info mb-3">
              <h6 class="d-flex align-items-center">
                <i class="fa-solid fa-user me-2"></i>
                <span>Thông tin khách hàng</span>
              </h6>
              <div class="mb-3">
                <label class="form-label d-flex align-items-center">
                  <i class="fa-solid fa-users-viewfinder me-2"></i>
                  <span>Chọn khách hàng</span>
                </label>
                <div class="input-group">
                  <select id="customerSelect" class="form-select" name="selectedCustomer" onchange="handleCustomerSelection()">
                    <option value="" data-name="" data-email="">Chọn khách hàng</option>
                    <option value="0999999999" data-name="Khách lẻ" data-email="" selected>Khách lẻ</option>
                    <option th:each="cus : ${customers}"
                            th:if="${cus.hoTen != 'Khách lẻ'}"
                            th:value="${cus.soDienThoai}"
                            th:data-name="${cus.hoTen}"
                            th:data-email="${cus.email}"
                            th:text="${cus.hoTen} + ' - ' + ${cus.soDienThoai}">
                    </option>
                  </select>
                  <button type="button" class="btn btn-outline-primary" onclick="openCustomerModal()">
                    <i class="fa fa-user-plus"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Customer Info -->
            <div id="customerInfo" class="mb-3 p-3 bg-light rounded" style="display: none;">
              <p class="mb-1"><strong><i class="fa-solid fa-user me-2"></i>Tên:</strong> <span id="customerName"></span></p>
              <p class="mb-0"><strong><i class="fa-solid fa-envelope me-2"></i>Email:</strong> <span id="customerEmail"></span></p>
            </div>

            <!-- Cart Items -->
            <div class="card shadow-sm mb-3">
              <div class="card-body p-0">
                <div id="cartItems" class="p-3"></div>
                <div id="cartEmpty" class="cart-empty-state">
                  <i class="fa-solid fa-cart-arrow-down"></i>
                  <h5>Giỏ hàng trống</h5>
                  <p class="text-muted">Hãy thêm sản phẩm vào giỏ hàng</p>
                </div>
              </div>
            </div>

            <!-- Cart Summary -->
            <div id="cartSummary" style="display: none;">
              <div class="d-flex justify-content-between">
                <span>Tạm tính:</span>
                <span id="subTotal">0 VNĐ</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Giảm giá:</span>
                <span id="discount" class="text-danger">0 VNĐ</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Phí vận chuyển:</span>
                <span id="shippingFeeDisplay">0 VNĐ</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between fw-bold">
                <span>Tổng cộng:</span>
                <span id="totalPrice" class="text-primary">0 VNĐ</span>
              </div>
            </div>

            <!-- Voucher -->
            <div class="mb-3">
              <label for="voucherSelect" class="form-label d-flex align-items-center">
                <i class="fa-solid fa-ticket me-2"></i>
                <span>Mã giảm giá</span>
              </label>
              <select id="voucherSelect" class="form-select" name="voucherId" onchange="applyVoucher()">
                <option value="" selected>-- Không áp dụng mã --</option>
                <option th:each="voucher : ${discountVouchers}"
                        th:value="${voucher.id}"
                        th:data-min-order-value="${voucher.giaTriGiamToiThieu}"
                        th:text="${voucher.ten} + ' (Tối thiểu ' + ${voucher.giaTriGiamToiThieuFormatted} + ')'">
                </option>
              </select>
              <div id="voucherMessage" class="text-danger mt-1" style="display: none;"></div>
            </div>

            <!-- Shipping Fee -->
            <div class="mb-3">
              <label for="shippingFee" class="form-label d-flex align-items-center">
                <i class="fa-solid fa-truck me-2"></i>
                <span>Phí vận chuyển</span>
              </label>
              <input type="number" id="shippingFee" name="shippingFee" class="form-control" value="0" min="0" onchange="updateTotal()">
            </div>

            <!-- Payment and Delivery Method -->
            <div class="mb-3">
              <label for="paymentMethod" class="form-label d-flex align-items-center">
                <i class="fa-solid fa-wallet me-2"></i>
                <span>Phương thức thanh toán</span>
              </label>
              <select id="paymentMethod" name="paymentMethod" class="form-select" onchange="togglePaymentFields()">
                <option value="" selected>Chọn phương thức thanh toán</option>
                <option th:each="method : ${paymentMethods}"
                        th:value="${method.id}"
                        th:text="${method.tenPhuongThuc}">
                </option>
              </select>
            </div>

            <div id="cashPaymentFields" class="mb-3">
              <label class="form-label d-flex align-items-center">
                <i class="fa-solid fa-money-bill-wave me-2"></i>
                <span>Số tiền khách đưa:</span>
              </label>
              <input type="number" id="cashAmount" class="form-control" placeholder="Nhập số tiền khách đưa" min="0" oninput="calculateChange()">
              <p class="mt-2 d-flex justify-content-between">
                <span>Tiền thối lại:</span>
                <span id="changeAmount" class="text-success fw-bold">0 VNĐ</span>
              </p>
            </div>

            <div class="mb-3">
              <label for="deliveryMethod" class="form-label d-flex align-items-center">
                <i class="fa-solid fa-box-open me-2"></i>
                <span>Hình thức bán hàng</span>
              </label>
              <select id="deliveryMethod" name="deliveryMethod" class="form-select">
                <option value="Tại quầy" selected>Tại quầy</option>
                <option value="Giao hàng">Giao hàng</option>
              </select>
            </div>

            <!-- Payment Processing Indicator -->
            <div id="paymentProcessing" class="payment-processing">
              <i class="fa-solid fa-spinner fa-spin"></i>
              <p>Đang xử lý thanh toán...</p>
            </div>

            <!-- Buttons -->
            <div class="d-flex gap-2 mb-2">
              <button type="button" class="btn btn-warning flex-grow-1" onclick="holdOrder()">
                <i class="fa-solid fa-pause me-1"></i> Giữ đơn
              </button>
              <button type="button" class="btn btn-danger flex-grow-1" onclick="clearCart()">
                <i class="fa-solid fa-trash me-1"></i> Xóa giỏ
              </button>
            </div>
            <button type="button" class="btn btn-success w-100" onclick="createOrder()" id="confirmPaymentBtn">
              <i class="fa-solid fa-check me-1"></i> Xác nhận thanh toán
            </button>
          </div>
        </div>
      </form>

      <!-- Danh sách đơn hàng tạm thời -->
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center">
            <i class="fa-solid fa-clock me-2"></i>
            <span>Đơn hàng tạm thời</span>
          </h5>
          <a href="/acvstore/banhang/don-hang-tam-thoi" class="btn btn-outline-primary w-100">
            <i class="fa-solid fa-list me-1"></i> Xem đơn hàng tạm thời
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Biến Thể -->
<div class="modal fade" id="productVariantModal" tabindex="-1" aria-labelledby="productVariantModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productVariantModalLabel">Chọn Biến Thể</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="variantDetails"></div>
        <div class="mb-3">
          <label for="colorSelect" class="form-label">Màu Sắc</label>
          <select class="form-select" id="colorSelect"></select>
        </div>
        <div class="mb-3">
          <label for="sizeSelect" class="form-label">Kích Cỡ</label>
          <select class="form-select" id="sizeSelect"></select>
        </div>
        <p>Số lượng tồn kho: <span id="stockQuantity">0</span></p>
        <p>Giá: <span id="variantPrice">0 VNĐ</span></p>
        <input type="number" class="form-control mb-3" id="quantityInput" min="1" value="1">
        <div class="mb-3 text-center">
          <label>Mã QR Biến Thể:</label>
          <img id="variantQrCode" src="" alt="QR Code" style="max-width: 150px; max-height: 150px;">
        </div>
        <button class="btn btn-primary" id="addToCartBtn">Thêm Vào Giỏ</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Thêm Khách Hàng -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCustomerModalLabel">Thêm Khách Hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form th:action="@{/acvstore/banhang/add-customer}" method="post">
          <div class="mb-3">
            <label for="hoTen" class="form-label">Họ Tên</label>
            <input type="text" class="form-control" id="hoTen" name="hoTen" required>
          </div>
          <div class="mb-3">
            <label for="soDienThoai" class="form-label">Số Điện Thoại</label>
            <input type="text" class="form-control" id="soDienThoai" name="soDienThoai" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email" required>
          </div>
          <button type="submit" class="btn btn-primary">Lưu</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast thông báo -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
  <div id="qrToast" class="toast align-items-center text-white bg-success border-0" role="alert" data-bs-autohide="false">
    <div class="d-flex">
      <div class="toast-body" id="qrToastBody">Thông báo</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
    <div class="progress">
      <div class="progress-bar bg-white" role="progressbar" style="width: 100%" id="toastProgressBar"></div>
    </div>
  </div>
  <div id="resetToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
    <div class="toast-header">
      <strong class="me-auto">Thông báo</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      Đơn hàng không đủ điều kiện, mã giảm giá không được áp dụng!
    </div>
  </div>
  <div id="paymentToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
    <div class="toast-header">
      <strong class="me-auto">Thông báo</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="paymentToastBody"></div>
  </div>
</div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Biến toàn cục lưu giỏ hàng trên client-side
  let cart = [];

  // Hàm hiển thị thông tin khách hàng khi chọn
  function handleCustomerSelection() {
    const select = document.getElementById('customerSelect');
    const customerInfo = document.getElementById('customerInfo');
    const customerName = document.getElementById('customerName');
    const customerEmail = document.getElementById('customerEmail');
    const selectedOption = select.options[select.selectedIndex];

    if (selectedOption.value === '0999999999') {
      customerName.textContent = 'Khách lẻ';
      customerEmail.textContent = '';
      customerInfo.style.display = 'none';
    } else {
      customerName.textContent = selectedOption.getAttribute('data-name');
      customerEmail.textContent = selectedOption.getAttribute('data-email') || 'Chưa có email';
      customerInfo.style.display = 'block';
    }
  }

  // Hàm mở modal thêm khách hàng
  function openCustomerModal() {
    $('#addCustomerModal').modal('show');
  }

  // Hàm hiển thị biến thể sản phẩm
  function showProductVariants(button) {
    let productId;
    if (button.getAttribute) {
      productId = button.getAttribute('data-product-id');
    } else {
      productId = button.productId; // For QR scan, use productId from API response
    }
    document.getElementById('productVariantModal').setAttribute('data-product-id', productId);
    console.log("Showing variants for productId:", productId);

    fetch(`/acvstore/banhang/product/${productId}/variants`)
            .then(response => {
              if (!response.ok) return response.json().then(err => Promise.reject(err));
              return response.json();
            })
            .then(data => {
              const colorSelect = document.getElementById('colorSelect');
              const sizeSelect = document.getElementById('sizeSelect');
              colorSelect.innerHTML = '<option value="">Chọn màu sắc</option>';
              sizeSelect.innerHTML = '<option value="">Chọn kích cỡ</option>';

              if (data.colors && data.sizes) {
                data.colors.forEach(color => {
                  const option = document.createElement('option');
                  option.value = color.id;
                  option.textContent = color.tenMau;
                  colorSelect.appendChild(option);
                });
                data.sizes.forEach(size => {
                  const option = document.createElement('option');
                  option.value = size.id;
                  option.textContent = size.ten;
                  sizeSelect.appendChild(option);
                });
              } else {
                throw new Error('Dữ liệu màu sắc hoặc kích cỡ không hợp lệ');
              }

              // Gọi updateVariantDetails ngay khi modal mở để hiển thị thông tin mặc định
              updateVariantDetails();

              colorSelect.addEventListener('change', updateVariantDetails);
              sizeSelect.addEventListener('change', updateVariantDetails);

              document.getElementById('quantityInput').value = 1;
              $('#productVariantModal').modal('show');
            })
            .catch(error => {
              console.error('Lỗi khi tải biến thể:', error);
              showToast(error.message || 'Không tìm thấy thông tin biến thể. Vui lòng thử lại!', 10000, 'error');
            });
  }

  // Hàm cập nhật thông tin biến thể
  function updateVariantDetails() {
    const productId = document.getElementById('productVariantModal').getAttribute('data-product-id');
    const colorId = document.getElementById('colorSelect').value;
    const sizeId = document.getElementById('sizeSelect').value;
    const variantQrCode = document.getElementById('variantQrCode');

    if (!productId) {
      console.error('productId không tồn tại trong modal');
      return;
    }
    if (!colorId || !sizeId) {
      document.getElementById('variantPrice').textContent = '0 VNĐ';
      document.getElementById('stockQuantity').textContent = '0';
      document.getElementById('addToCartBtn').disabled = true;
      variantQrCode.src = '';
      return;
    }

    console.log("Fetching variant details: productId=", productId, "colorId=", colorId, "sizeId=", sizeId);
    fetch(`/acvstore/banhang/product/variant?productId=${productId}&colorId=${colorId}&sizeId=${sizeId}`)
            .then(response => {
              if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
              return response.json();
            })
            .then(data => {
              console.log("Variant details response:", data);
              if (data.error) {
                alert(data.error);
                document.getElementById('variantPrice').textContent = '0 VNĐ';
                document.getElementById('stockQuantity').textContent = '0';
                document.getElementById('addToCartBtn').disabled = true;
                variantQrCode.src = '';
              } else {
                document.getElementById('stockQuantity').textContent = data.stockQuantity > 0 ? data.stockQuantity : 0;
                document.getElementById('variantPrice').textContent = data.price.toLocaleString('vi-VN') + ' VNĐ';
                document.getElementById('addToCartBtn').dataset.productDetailId = data.productDetailId || '';
                document.getElementById('addToCartBtn').disabled = !data.productDetailId || data.stockQuantity <= 0;
                variantQrCode.src = data.productDetailId ? `/generate-qr?data=productDetailId:${data.productDetailId}` : '';
              }
            })
            .catch(error => {
              console.error('Lỗi khi cập nhật biến thể:', error);
              alert('Không thể tải thông tin biến thể: ' + error.message);
              variantQrCode.src = '';
            });
  }

  // Hàm thêm sản phẩm vào giỏ hàng
  document.getElementById('addToCartBtn').addEventListener('click', () => {
    const productDetailId = document.getElementById('addToCartBtn').dataset.productDetailId;
    const quantityInput = document.getElementById('quantityInput');
    const quantity = parseInt(quantityInput.value) || 0;
    const shippingFee = parseFloat(document.getElementById('shippingFee').value) || 0;

    console.log("Adding to cart:", { productDetailId, quantity, shippingFee });

    if (!productDetailId) {
      alert('Vui lòng chọn biến thể sản phẩm hợp lệ.');
      return;
    }
    if (quantity <= 0) {
      alert('Số lượng phải lớn hơn 0.');
      return;
    }

    fetch('/acvstore/banhang/cart/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productDetailId, quantity, shippingFee })
    })
            .then(response => {
              if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
              return response.json();
            })
            .then(data => {
              console.log("Cart add response:", data);
              fetchCartData();
              updateTotal();
              $('#productVariantModal').modal('hide');
              showToast('Đã thêm sản phẩm vào giỏ hàng!', 3000, 'success');
            })
            .catch(error => {
              console.error('Lỗi khi thêm vào giỏ hàng:', error);
              showToast(`Lỗi: ${error.message}`, 10000, 'error');
            });
  });

  // Hàm lấy productId từ productDetailId
  function getProductIdFromDetailId(productDetailId) {
    const button = document.querySelector(`#productList tr button[data-product-detail-id="${productDetailId}"]`) ||
            document.querySelector(`#cartItems div[data-product-detail-id="${productDetailId}"] .increase-btn`);
    return button ? button.getAttribute('data-product-id') : null;
  }

  // Hàm cập nhật số lượng tồn kho trong bảng sản phẩm
  function updateStockQuantity(productId, productDetailId, quantityChange) {
    fetch(`/acvstore/banhang/product/variant?productDetailId=${productDetailId}`)
            .then(response => {
              if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
              }
              return response.json();
            })
            .then(data => {
              const productRow = document.querySelector(`#productList tr button[data-product-id="${productId}"]`)?.parentElement?.parentElement;
              if (productRow) {
                const stockCell = productRow.querySelector('td:nth-child(4)');
                if (stockCell) {
                  let currentStock = parseInt(data.stockQuantity) || 0;
                  fetch(`/acvstore/banhang/cart/get-temp-stock?productDetailId=${productDetailId}`)
                          .then(resp => resp.json())
                          .then(tempData => {
                            let reserved = parseInt(tempData.reservedQuantity) || 0;
                            let newStock = currentStock - reserved + quantityChange;
                            stockCell.textContent = newStock >= 0 ? newStock : 0;
                            if (document.getElementById('stockQuantity')) {
                              document.getElementById('stockQuantity').textContent = newStock >= 0 ? newStock : 0;
                            }
                          })
                          .catch(() => {
                            stockCell.textContent = currentStock;
                            if (document.getElementById('stockQuantity')) {
                              document.getElementById('stockQuantity').textContent = currentStock;
                            }
                          });
                }
              }
            })
            .catch(error => {
              console.error('Lỗi khi cập nhật số lượng tồn kho:', error);
              alert('Không thể cập nhật số lượng tồn kho. Vui lòng thử lại.');
            });
  }

  // Hàm lấy giỏ hàng bằng AJAX
  function fetchCartData() {
    return fetch('/acvstore/banhang/cart/get?shippingFee=0', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' }
    })
            .then(response => {
              if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
              return response.json();
            })
            .then(data => {
              updateCartDisplay(data);
              // Cập nhật các trường khác nếu có dữ liệu khôi phục
              if (data.soDienThoaiKhachHang) {
                document.getElementById('customerSelect').value = data.soDienThoaiKhachHang;
                handleCustomerSelection();
              }
              if (data.phiVanChuyen) {
                document.getElementById('shippingFee').value = parseFloat(data.phiVanChuyen);
              }
              if (data.idPhieuGiamGia) {
                document.getElementById('voucherSelect').value = data.idPhieuGiamGia;
              }
              if (data.phuongThucThanhToan) {
                document.getElementById('paymentMethod').value = data.phuongThucThanhToan;
              }
              if (data.phuongThucBanHang) {
                document.getElementById('deliveryMethod').value = data.phuongThucBanHang;
              }
              togglePaymentFields();
              updateTotal();
              return data;
            })
            .catch(error => {
              console.error('Lỗi khi tải dữ liệu giỏ hàng:', error);
              updateCartDisplay({ danhSachSanPham: [] });
              return { danhSachSanPham: [] };
            });
  }

  // Hàm hiển thị giỏ hàng
  function updateCartDisplay(data) {
    const cartItems = document.getElementById('cartItems');
    const danhSachSanPham = data?.danhSachSanPham || [];
    cart = danhSachSanPham.map(item => ({
      productDetailId: item.idChiTietSanPham,
      quantity: item.soLuong,
      price: item.gia,
      total: item.thanhTien,
      tenSanPham: item.tenSanPham || 'Không rõ', // Đảm bảo không null
      mauSac: item.mauSac || 'Không rõ',        // Đảm bảo không null
      kichCo: item.kichCo || 'Không rõ'         // Đảm bảo không null
    }));
    cartItems.innerHTML = danhSachSanPham.map(item => `
    <div class="d-flex justify-content-between align-items-center mb-2" data-product-detail-id="${item.idChiTietSanPham}">
      <span>${item.tenSanPham || 'Không rõ'} (${item.mauSac || 'Không rõ'}, ${item.kichCo || 'Không rõ'})</span>
      <div class="d-flex align-items-center">
        <button class="btn btn-sm btn-outline-secondary decrease-btn" data-product-detail-id="${item.idChiTietSanPham}" data-stock="${item.stockQuantity || 0}">-</button>
        <span class="mx-2" id="quantity-${item.idChiTietSanPham}">${item.soLuong || 0}</span>
        <button class="btn btn-sm btn-outline-secondary increase-btn" data-product-detail-id="${item.idChiTietSanPham}" data-stock="${item.stockQuantity || 0}">+</button>
        <span class="ms-2">${(item.thanhTien || 0).toLocaleString('vi-VN').replace(/\s*đ$/, '')} VNĐ</span>
        <button class="btn btn-sm btn-danger" onclick="removeFromCart('${item.idChiTietSanPham}')"><i class="fa fa-trash"></i></button>
      </div>
    </div>
  `).join('');
    document.getElementById('subTotal').textContent = (data.tongTienHang || 0).toLocaleString('vi-VN');
    document.getElementById('discount').textContent = (data.giamGia || 0).toLocaleString('vi-VN');
    document.getElementById('totalPrice').textContent = (data.tong || 0).toLocaleString('vi-VN');
    document.getElementById('cartItemCount').textContent = danhSachSanPham.length;

    if (danhSachSanPham.length > 0) {
      document.getElementById('cartEmpty').style.display = 'none';
      document.getElementById('cartSummary').style.display = 'block';
    } else {
      document.getElementById('cartEmpty').style.display = 'block';
      document.getElementById('cartSummary').style.display = 'none';
    }

    document.querySelectorAll('.increase-btn').forEach(btn => {
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        const productDetailId = btn.getAttribute('data-product-detail-id');
        const stockQuantity = parseInt(btn.getAttribute('data-stock')) || 0;
        increaseQuantity(productDetailId, stockQuantity);
      });
    });

    document.querySelectorAll('.decrease-btn').forEach(btn => {
      btn.addEventListener('click', (event) => {
        event.preventDefault();
        const productDetailId = btn.getAttribute('data-product-detail-id');
        const stockQuantity = parseInt(btn.getAttribute('data-stock')) || 0;
        decreaseQuantity(productDetailId, stockQuantity);
      });
    });

    applyVoucher();
    console.log("Cart updated:", cart); // Thêm log để debug
  }

  // Hàm tăng số lượng
  function increaseQuantity(productDetailId, stockQuantity) {
    const currentQuantityElement = document.getElementById(`quantity-${productDetailId}`);
    let currentQuantity = parseInt(currentQuantityElement.textContent) || 0;
    const newQuantity = currentQuantity + 1;

    if (newQuantity > stockQuantity) {
      alert(`Số lượng vượt quá tồn kho: ${stockQuantity}`);
      return;
    }

    currentQuantityElement.textContent = newQuantity;

    fetch('/acvstore/banhang/cart/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productDetailId, quantity: newQuantity, shippingFee: 0 })
    })
            .then(response => {
              if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || `HTTP error! Status: ${response.status}`); });
              }
              return response.json();
            })
            .then(data => {
              updateCartDisplay(data);
              const productId = getProductIdFromDetailId(productDetailId);
              if (productId) updateStockQuantity(productId, productDetailId, -1);
            })
            .catch(error => {
              console.error('Lỗi khi tăng số lượng:', error);
              alert(`Lỗi: ${error.message}`);
              currentQuantityElement.textContent = currentQuantity;
            });
  }

  // Hàm giảm số lượng
  function decreaseQuantity(productDetailId, stockQuantity) {
    const currentQuantityElement = document.getElementById(`quantity-${productDetailId}`);
    let currentQuantity = parseInt(currentQuantityElement.textContent) || 0;
    const newQuantity = currentQuantity - 1;

    if (newQuantity < 1) {
      removeFromCart(productDetailId);
      return;
    }

    currentQuantityElement.textContent = newQuantity;

    fetch('/acvstore/banhang/cart/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productDetailId, quantity: newQuantity, shippingFee: 0 })
    })
            .then(response => {
              if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || `HTTP error! Status: ${response.status}`); });
              }
              return response.json();
            })
            .then(data => {
              updateCartDisplay(data);
              const productId = getProductIdFromDetailId(productDetailId);
              if (productId) updateStockQuantity(productId, productDetailId, 1);
            })
            .catch(error => {
              console.error('Lỗi khi giảm số lượng:', error);
              alert(`Lỗi: ${error.message}`);
              currentQuantityElement.textContent = currentQuantity;
            });
  }

  // Hàm xóa sản phẩm khỏi giỏ hàng
  function removeFromCart(productDetailId) {
    if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
      fetch('/acvstore/banhang/cart/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productDetailId, shippingFee: 0 })
      })
              .then(response => {
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return response.json();
              })
              .then(data => {
                updateCartDisplay(data);
                updateTotal();
                const productId = getProductIdFromDetailId(productDetailId);
                if (productId) updateStockQuantity(productId, productDetailId, 0);
              })
              .catch(error => {
                console.error('Lỗi khi xóa khỏi giỏ hàng:', error);
                alert(`Lỗi: ${error.message}`);
              });
    }
  }

  // Hàm áp dụng voucher
  function applyVoucher() {
    const voucherSelect = document.getElementById('voucherSelect');
    const subTotal = parseFloat(document.getElementById('subTotal').textContent.replace(' VNĐ', '').replace(/\./g, '')) || 0;
    const voucherMessage = document.getElementById('voucherMessage');

    let currentVoucherId = voucherSelect.value;
    let shouldReset = false;

    for (let option of voucherSelect.options) {
      const minOrderValue = parseFloat(option.getAttribute('data-min-order-value')) || 0;
      if (option.value && subTotal < minOrderValue) {
        option.disabled = true;
        if (option.value === currentVoucherId) {
          shouldReset = true;
        }
      } else {
        option.disabled = false;
      }
    }

    if (shouldReset && currentVoucherId) {
      voucherSelect.value = "";
      document.getElementById('discount').textContent = '0 VNĐ';
      updateTotal();

      const toast = new bootstrap.Toast(document.getElementById('resetToast'));
      toast.show();
    }

    const voucherId = voucherSelect.value;
    const minOrderValue = parseFloat(document.querySelector(`#voucherSelect option[value="${voucherId}"]`)?.getAttribute('data-min-order-value')) || 0;

    if (voucherId && subTotal < minOrderValue) {
      voucherMessage.textContent = `Đơn hàng phải tối thiểu ${minOrderValue.toLocaleString('vi-VN')} VNĐ`;
      voucherMessage.style.display = 'block';
      document.getElementById('discount').textContent = '0 VNĐ';
      updateTotal();
    } else {
      voucherMessage.style.display = 'none';
      if (voucherId) {
        fetch(`/acvstore/banhang/cart/apply-voucher?voucherId=${voucherId}&shippingFee=0`, {
          method: 'POST'
        })
                .then(response => response.json())
                .then(data => {
                  document.getElementById('discount').textContent = data.giamGia || '0 VNĐ';
                  updateTotal();
                })
                .catch(error => console.error('Lỗi khi áp dụng voucher:', error));
      }
    }
  }

  // Hàm cập nhật tổng tiền
  function updateTotal() {
    const subTotal = parseFloat(document.getElementById('subTotal').textContent.replace(' VNĐ', '').replace(/\./g, '')) || 0;
    const discount = parseFloat(document.getElementById('discount').textContent.replace(' VNĐ', '').replace(/\./g, '')) || 0;
    const shippingFee = parseFloat(document.getElementById('shippingFee').value) || 0;
    const total = subTotal - discount + shippingFee;
    document.getElementById('shippingFeeDisplay').textContent = shippingFee.toLocaleString('vi-VN').replace(/\s*đ$/, '') + ' VNĐ';
    document.getElementById('totalPrice').textContent = total.toLocaleString('vi-VN').replace(/\s*đ$/, '') + ' VNĐ';
    calculateChange();
  }

  // Hàm tính tiền thối lại
  function calculateChange() {
    const total = parseFloat(document.getElementById('totalPrice').textContent.replace(' VNĐ', '').replace(/\./g, '')) || 0;
    const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
    const change = cashAmount - total;
    document.getElementById('changeAmount').textContent = change >= 0 ? change.toLocaleString('vi-VN') + ' VNĐ' : '0 VNĐ';
  }

  // Hàm hiển thị/ẩn trường thanh toán tiền mặt
  function togglePaymentFields() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const deliveryMethod = document.getElementById('deliveryMethod').value;
    const cashFields = document.getElementById('cashPaymentFields');

    // Lấy tên phương thức từ UUID
    const tenPhuongThuc = getTenPhuongThucFromId(paymentMethod);

    // Hiển thị trường thanh toán tiền mặt chỉ khi:
    // 1. Phương thức thanh toán là "Tiền mặt"
    // 2. Hình thức bán hàng là "Tại quầy"
    cashFields.style.display = (tenPhuongThuc === 'Tiền mặt' && deliveryMethod === 'Tại quầy') ? 'block' : 'none';

    // Xóa giá trị input và tiền thối nếu trường không hiển thị
    if (tenPhuongThuc !== 'Tiền mặt' || deliveryMethod !== 'Tại quầy') {
      document.getElementById('cashAmount').value = '';
      document.getElementById('changeAmount').textContent = '0 VNĐ';
    }
  }

  // Hàm giữ đơn hàng
  function holdOrder() {
    const donHangDTO = {
      soDienThoaiKhachHang: document.getElementById('customerSelect').value,
      phiVanChuyen: parseFloat(document.getElementById('shippingFee').value) || 0,
      phuongThucThanhToan: document.getElementById('paymentMethod').value,
      phuongThucBanHang: document.getElementById('deliveryMethod').value,
      soTienKhachDua: parseFloat(document.getElementById('cashAmount').value) || 0,
      danhSachSanPham: cart.map(item => ({
        idChiTietSanPham: item.productDetailId,
        tenSanPham: item.tenSanPham,
        mauSac: item.mauSac,
        kichCo: item.kichCo,
        soLuong: item.quantity,
        gia: item.price,
        thanhTien: item.total
      })),
      idPhieuGiamGia: document.getElementById('voucherSelect').value
    };
    console.log("Sending to hold-order:", donHangDTO); // Thêm log để debug
    fetch('/acvstore/banhang/hold-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(donHangDTO)
    })
            .then(response => response.json())
            .then(data => {
              if (data.message) {
                alert(data.message);
                cart = [];
                updateCartDisplay(data.cart);
                updateTotal();
                document.getElementById('shippingFee').value = '0';
                document.getElementById('voucherSelect').value = '';
                document.getElementById('paymentMethod').value = '';
                document.getElementById('cashAmount').value = '';
                document.getElementById('changeAmount').textContent = '0 VNĐ';
                document.getElementById('discount').textContent = '0 VNĐ';
                document.getElementById('totalPrice').textContent = '0 VNĐ';
                document.getElementById('subTotal').textContent = '0 VNĐ';
                document.getElementById('shippingFeeDisplay').textContent = '0 VNĐ';
                document.getElementById('voucherMessage').style.display = 'none';
              } else if (data.error) {
                alert('Lỗi: ' + data.error);
              }
            })
            .catch(error => console.error('Lỗi khi giữ đơn:', error));
  }

  // Hàm xóa giỏ hàng
  function clearCart() {
    fetch('/acvstore/banhang/cart/clear', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
              updateCartDisplay(data);
              updateTotal();
            })
            .catch(error => console.error('Lỗi khi xóa giỏ hàng:', error));
  }

  // Hàm tạo đơn hàng
  function createOrder() {
    if (cart.length === 0) {
      alert('Giỏ hàng trống. Vui lòng thêm sản phẩm trước khi thanh toán.');
      return;
    }

    const paymentMethod = document.getElementById('paymentMethod').value; // UUID
    const total = parseFloat(document.getElementById('totalPrice').textContent.replace(' VNĐ', '').replace(/\./g, '')) || 0;
    const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
    const phoneNumber = document.getElementById('customerSelect').value;
    const deliveryMethod = document.getElementById('deliveryMethod').value;

    if (!phoneNumber || phoneNumber.trim() === '') {
      alert('Vui lòng chọn khách hàng hoặc nhập số điện thoại hợp lệ.');
      return;
    }

    if (paymentMethod === '') {
      alert('Vui lòng chọn phương thức thanh toán.');
      return;
    }

    const tenPhuongThuc = getTenPhuongThucFromId(paymentMethod);
    if (tenPhuongThuc === 'Tiền mặt' && deliveryMethod === 'Tại quầy' && cashAmount < total) {
      alert('Số tiền khách đưa không đủ để thanh toán.');
      return;
    }

    // Log dữ liệu gửi lên server để debug
    console.log("Cart data being sent:", cart);

    const donHangDTO = {
      soDienThoaiKhachHang: phoneNumber,
      phiVanChuyen: parseFloat(document.getElementById('shippingFee').value) || 0,
      phuongThucThanhToan: paymentMethod,
      phuongThucBanHang: document.getElementById('deliveryMethod').value,
      soTienKhachDua: tenPhuongThuc === 'Tiền mặt' && deliveryMethod === 'Tại quầy' ? cashAmount : total,
      danhSachSanPham: cart.map(item => ({
        idChiTietSanPham: item.productDetailId,
        soLuong: item.quantity,
        gia: item.price,
        thanhTien: item.total
      })),
      idPhieuGiamGia: document.getElementById('voucherSelect').value
    };

    document.getElementById('confirmPaymentBtn').disabled = true;
    document.getElementById('paymentProcessing').style.display = 'block';

    fetch('/acvstore/banhang/create-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(donHangDTO)
    })
            .then(response => {
              if (!response.ok) throw new Error('Lỗi khi đặt hàng');
              return response.json();
            })
            .then(data => {
              document.getElementById('paymentToastBody').textContent = data.message || 'Đơn hàng đã được tạo thành công!';
              const toast = new bootstrap.Toast(document.getElementById('paymentToast'));
              toast.show();

              // Xóa giỏ hàng trên server
              return fetch('/acvstore/banhang/cart/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
            })
            .then(clearResponse => {
              if (!clearResponse.ok) throw new Error('Lỗi khi xóa giỏ hàng');
              return clearResponse.json();
            })
            .then(clearData => {
              // Xóa giỏ hàng trên client-side
              cart = []; // Đặt lại giỏ hàng thành rỗng
              updateCartDisplay({ danhSachSanPham: [] }); // Cập nhật giao diện
              updateTotal(); // Cập nhật tổng tiền
              setTimeout(() => {
                window.location.href = '/acvstore/banhang'; // Reload trang sau 2 giây
              }, 2000);
            })
            .catch(error => {
              console.error('Lỗi create-order:', error);
              document.getElementById('paymentToastBody').textContent = 'Lỗi khi đặt hàng: ' + error.message;
              const toast = new bootstrap.Toast(document.getElementById('paymentToast'));
              toast.show();
              document.getElementById('confirmPaymentBtn').disabled = false;
              document.getElementById('paymentProcessing').style.display = 'none';
            });
  }

  // Hàm lấy tên phương thức từ UUID
  function getTenPhuongThucFromId(uuid) {
    const paymentMethods = [...document.getElementById('paymentMethod').options]
            .filter(option => option.value === uuid)
            .map(option => option.text);
    return paymentMethods.length > 0 ? paymentMethods[0] : '';
  }

  // // Hàm định dạng tiền tệ
  // function formatCurrency(amount) {
  //   if (amount == null || isNaN(amount)) return '0 VNĐ';
  //   return parseFloat(amount).toLocaleString('vi-VN') + ' VNĐ';
  // }

  // Hàm hiển thị thông báo toast
  function showToast(message, duration = 10000, type = 'success') {
    const toast = document.getElementById('qrToast');
    const toastBody = document.getElementById('qrToastBody');
    const progressBar = document.getElementById('toastProgressBar');

    toast.className = 'toast align-items-center border-0';
    switch (type) {
      case 'error':
        toast.classList.add('bg-danger', 'text-white');
        break;
      case 'warning':
        toast.classList.add('bg-warning', 'text-dark');
        break;
      default:
        toast.classList.add('bg-success', 'text-white');
        break;
    }

    toastBody.textContent = message;
    progressBar.style.width = '100%';

    const toastInstance = new bootstrap.Toast(toast);
    toastInstance.show();

    const startTime = Date.now();
    const interval = setInterval(() => {
      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, duration - elapsed);
      const percentage = (remaining / duration) * 100;
      progressBar.style.width = percentage + '%';

      if (remaining <= 0) {
        clearInterval(interval);
        toastInstance.hide();
      }
    }, 100);
  }

  // Hàm quét QR code
  function startQrScanner() {
    const qrReader = document.getElementById("qr-reader");
    if (!qrReader) {
      console.error('Không tìm thấy phần tử qr-reader');
      showToast('Không thể khởi động quét QR: Thiếu phần tử hiển thị.', 10000, 'error');
      return;
    }
    qrReader.style.display = "block";

    const html5QrCode = new Html5Qrcode("qr-reader");

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        const backCamera = devices.find(device => device.label.toLowerCase().includes("back")) || devices[0];
        const cameraId = backCamera.id;

        html5QrCode.start(
                cameraId,
                { fps: 20, qrbox: 320, aspectRatio: 1.777 },
                qrCodeMessage => {
                  console.log("QR content:", qrCodeMessage);
                  let productDetailId = qrCodeMessage.trim();
                  if (qrCodeMessage.includes('productDetailId:')) {
                    productDetailId = qrCodeMessage.split('productDetailId:')[1].trim();
                  }

                  const uuidRegex = /^[0-9a-fA-F\-]{36}$/;
                  if (!uuidRegex.test(productDetailId)) {
                    showToast("QR không hợp lệ!", 10000, 'error');
                    html5QrCode.stop().then(() => qrReader.style.display = "none");
                    return;
                  }

                  // Gọi API lấy thông tin biến thể
                  fetch(`/acvstore/banhang/product/variant?productDetailId=${productDetailId}`)
                          .then(res => {
                            if (!res.ok) throw new Error('Không tìm thấy thông tin biến thể');
                            return res.json();
                          })
                          .then(data => {
                            if (!data || !data.productDetailId) {
                              throw new Error(data.error || 'Dữ liệu biến thể không hợp lệ');
                            }

                            // Thêm vào giỏ hàng luôn
                            fetch('/acvstore/banhang/cart/add', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                productDetailId: data.productDetailId,
                                quantity: 1,
                                shippingFee: parseFloat(document.getElementById('shippingFee').value) || 0
                              })
                            })
                                    .then(resp => {
                                      if (!resp.ok) throw new Error('Thêm vào giỏ thất bại');
                                      return resp.json();
                                    })
                                    .then(cartData => {
                                      showToast(`✅ Đã thêm "${data.tenSanPham} (${data.mauSac}, ${data.kichCo})" vào giỏ hàng`, 6000, 'success');
                                      fetchCartData(); // Cập nhật giao diện giỏ hàng
                                    })
                                    .catch(err => {
                                      showToast('❌ ' + err.message, 8000, 'error');
                                    });

                            html5QrCode.stop().then(() => qrReader.style.display = "none");
                          })
                          .catch(err => {
                            showToast('❌ Lỗi khi xử lý mã QR: ' + err.message, 8000, 'error');
                            html5QrCode.stop().then(() => qrReader.style.display = "none");
                          });
                },
                errorMessage => {
                  console.warn("QR đọc lỗi:", errorMessage);
                }
        );

        showToast("📷 Đưa mã QR gần camera để quét", 5000, 'success');
      } else {
        showToast("❌ Không tìm thấy camera!", 10000, 'error');
      }
    }).catch(err => {
      showToast("Không thể mở camera: " + err, 10000, 'error');
    });
  }


  // Khởi tạo
  document.addEventListener('DOMContentLoaded', () => {
    handleCustomerSelection();
    togglePaymentFields();
    fetchCartData();
    applyVoucher();
  });

  // Thêm sự kiện
  document.getElementById('shippingFee').addEventListener('input', updateTotal);
  document.getElementById('cashAmount').addEventListener('input', calculateChange);
  document.getElementById('paymentMethod').addEventListener('change', togglePaymentFields);
  document.getElementById('deliveryMethod').addEventListener('change', togglePaymentFields);
  document.getElementById('orderForm').addEventListener('submit', (event) => {
    event.preventDefault();
  });
</script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</body>
</html>