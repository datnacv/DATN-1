<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACV Store - Bán Hàng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <script th:src="@{/js/sidebar.js}" defer></script>
  <style>
    :root {
      --primary-color: #153054;
      --primary-hover: #0e2239;
      --secondary-color: #153054;
      --success-color: #153054;
      --danger-color: #153054;
      --warning-color: #153054;
      --light-gray: #f8f9fa;
      --border-color: #dee2e6;
      --text-color: #9FD5F7;
      --dark-blue: #153054;
      --light-blue: #ffffff;
      --neutral-gray: #6B7280;
    }

    body {
      background-color: white;
      color: var(--dark-blue);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #qrScannerModal {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
    }

    .scanner-container {
      position: relative;
      width: 90%;
      max-width: 400px;
      background: none;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
    }

    #qr-reader {
      width: 100%;
      height: auto;
      display: block;
      border: none;
    }

    .scan-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .scan-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: #00ff88;
      box-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88;
      animation: scan 2s linear infinite;
    }

    @keyframes scan {
      0% { top: 0; }
      50% { top: 100%; }
      100% { top: 0; }
    }

    .scanner-corners {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .close-button {
      background: var(--neutral-gray);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 16px;
    }

    .close-button:hover {
      background: #4b5563;
    }

    .scanner-footer {
      text-align: center;
      margin-top: 16px;
    }

    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: var(--primary-color);
      color: var(--light-blue);
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      opacity: 0;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border-radius: 16px;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      margin-right: 12px;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
      background: #f5f5f5;
      border: 2px solid var(--border-color);
      color: var(--dark-blue);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: inset 0 0 0 0 transparent;
    }

    .tab:hover:not(.active) {
      background: #eaeaea;
      color: var(--dark-blue);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-color);
    }

    .tab.active {
      background: linear-gradient(135deg, #153054, #0e2239);
      color: var(--light-blue);
      font-weight: 600;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      border-color: #153054;
    }

    .tab .btn {
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.05);
      border: none;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      opacity: 0.4;
      color: var(--dark-blue);
      pointer-events: auto;
    }

    .tab.active .btn {
      opacity: 1;
      background: rgba(255, 255, 255, 0.2);
      color: var(--light-blue);
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.2);
    }

    .tab:hover .btn,
    .tab .btn:hover {
      opacity: 1;
    }

    .tab .btn:hover {
      background: var(--danger-color);
      color: var(--light-blue);
      transform: rotate(90deg) scale(1.1);
      box-shadow: 0 4px 12px rgba(21, 48, 84, 0.3);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 70vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-content h3,
    .modal-content h4 {
      color: var(--dark-blue);
    }

    .modal-content .fw-medium,
    .modal-content .fw-semibold {
      color: var(--dark-blue);
    }

    .modal-content .text-muted {
      color: var(--neutral-gray) !important;
    }

    .modal-content .text-primary {
      color: var(--dark-blue) !important;
    }

    .modal-content .text-success {
      color: var(--dark-blue) !important;
    }

    .form-control {
      transition: all 0.3s ease;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: white;
      padding: 12px 16px;
      color: var(--dark-blue);
    }

    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(21, 48, 84, 0.1);
      outline: none;
      transform: translateY(-1px);
    }

    .form-control:disabled,
    .form-control[readonly] {
      color: var(--neutral-gray);
      background: #e9ecef;
    }

    .btn-primary {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: var(--light-blue);
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
      position: relative;
      overflow: hidden;
      padding: 12px 24px;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(159, 213, 247, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .btn-secondary {
      background: var(--neutral-gray);
      border-color: var(--neutral-gray);
      color: white;
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 24px;
    }

    .btn-secondary:hover {
      background: #4b5563;
      border-color: #4b5563;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .btn-success {
      background: var(--success-color);
      border-color: var(--success-color);
      color: var(--light-blue);
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 24px;
    }

    .btn-success:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .btn-danger {
      background: var(--danger-color);
      border-color: var(--danger-color);
      color: var(--light-blue);
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 24px;
    }

    .btn-danger:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .spinner {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .cart-table {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .cart-table th {
      background: var(--light-gray);
      padding: 1.5rem 1rem;
      font-weight: 700;
      color: var(--dark-blue);
      border: none;
    }

    .cart-table td {
      padding: 1.5rem 1rem;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
      color: var(--dark-blue);
    }

    .cart-table .fw-semibold {
      color: var(--dark-blue);
    }

    .cart-table .quantity {
      color: var(--dark-blue);
      font-weight: bold;
    }

    .cart-table tr:hover {
      background: var(--light-gray);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    .cart-table img {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .cart-table .text-muted {
      color: var(--neutral-gray) !important;
    }

    .cart-table .text-success {
      color: var(--dark-blue) !important;
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--light-gray);
      padding: 0.5rem;
      border-radius: 12px;
      border: 2px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .quantity-controls.loading {
      opacity: 0.5;
      pointer-events: none;
    }

    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
      background: var(--primary-color);
      color: var(--light-blue);
    }

    .quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .quantity-btn:not(:disabled):hover {
      transform: scale(1.1);
      background: var(--primary-hover);
    }

    .stock-warning {
      color: var(--danger-color);
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .summary-card {
      background: var(--light-gray);
      border-radius: 20px;
      padding: 2rem;
      border: 2px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }

    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--success-color), var(--warning-color));
    }

    .summary-card .fw-medium {
      color: var(--dark-blue);
    }

    .summary-card #subTotal,
    .summary-card #shippingFeeDisplay,
    .summary-card #discount,
    .summary-card #changeAmount {
      color: var(--dark-blue);
    }

    .summary-card #total {
      color: var(--dark-blue);
    }

    .summary-card .bg-light #total {
      color: var(--dark-blue);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-color);
    }

    .section-header h3 {
      color: var(--dark-blue);
    }

    .section-icon {
      width: 24px;
      height: 24px;
      color: var(--primary-color);
    }

    .customer-info-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      align-items: end;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .floating-label {
      position: relative;
    }

    .floating-label input,
    .floating-label select {
      padding-top: 1.5rem;
      color: var(--dark-blue);
    }

    .floating-label label {
      position: absolute;
      left: 1rem;
      top: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--dark-blue);
      pointer-events: none;
    }

    .badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
      background-color: var(--primary-color);
      color: var(--light-blue);
    }

    .badge-primary {
      background-color: var(--primary-color);
      color: var(--light-blue);
    }

    .badge-secondary {
      background-color: var(--secondary-color);
      color: var(--light-blue);
    }

    @media (max-width: 768px) {
      .content {
        padding: 1rem;
      }

      .cart-table th,
      .cart-table td {
        font-size: 0.875rem;
        padding: 1rem 0.5rem;
      }

      .cart-table img {
        max-width: 40px;
        max-height: 40px;
      }

      .quantity-controls {
        flex-direction: column;
        gap: 0.25rem;
      }

      .customer-info-grid {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .header-gradient {
      background: linear-gradient(135deg, #153054, #0e2239);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
<div class="d-flex">
  <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>

  <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
    <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
  </nav>

  <div class="content mt-16" id="mainContent">
    <div class="text-center mb-2 mt-3">
      <p class="fs-2 fw-bold header-gradient">Bán hàng tại quầy</p>
    </div>

    <div class="glass-card p-4 mb-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div id="orderTabs" class="d-flex flex-wrap"></div>
        <button id="addTabBtn" class="btn btn-secondary d-flex align-items-center gap-2">
          <i class="fas fa-plus"></i>
          Thêm Đơn Hàng
        </button>
      </div>
    </div>

    <div class="glass-card p-4">
      <div class="action-buttons">
        <button onclick="showQrScanner()" class="btn btn-success d-flex align-items-center justify-content-center gap-3">
          <i class="fas fa-qrcode fs-5"></i>
          <span class="fw-semibold">Quét QR sản phẩm</span>
        </button>
        <button onclick="showProductModal()" class="btn btn-primary d-flex align-items-center justify-content-center gap-3">
          <i class="fas fa-box fs-5"></i>
          <span class="fw-semibold">Chọn sản phẩm</span>
        </button>
      </div>

      <div class="mb-4">
        <div class="section-header">
          <i class="fas fa-shopping-cart section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">Giỏ hàng</h3>
        </div>

        <div class="table-responsive">
          <table class="table cart-table">
            <thead>
            <tr>
              <th>Hình ảnh</th>
              <th>Tên sản phẩm</th>
              <th>Màu sắc</th>
              <th>Kích cỡ</th>
              <th>Giá</th>
              <th>Số lượng</th>
              <th>Thành tiền</th>
              <th>Hành động</th>
            </tr>
            </thead>
            <tbody id="cartItems"></tbody>
          </table>
        </div>
      </div>

      <div class="mb-4">
        <div class="section-header">
          <i class="fas fa-user section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">Thông tin khách hàng</h3>
        </div>

        <div class="customer-info-grid mb-3">
          <div class="floating-label">
            <label for="customerPhone">Số điện thoại</label>
            <input type="text" id="customerPhone" class="form-control" placeholder="Nhập số điện thoại khách hàng">
          </div>
          <button onclick="showCustomerModal()" class="btn btn-primary d-flex align-items-center gap-2">
            <i class="fas fa-users"></i>
            Chọn khách hàng
          </button>
        </div>

        <div class="form-grid">
          <div class="floating-label">
            <label for="customerName">Tên khách hàng</label>
            <input type="text" id="customerName" class="form-control" placeholder="Tên khách hàng" disabled>
          </div>
          <div class="floating-label">
            <label for="customerEmail">Email</label>
            <input type="email" id="customerEmail" class="form-control" placeholder="Email khách hàng" disabled>
          </div>
        </div>
      </div>

      <div id="addressSection" class="mb-4 d-none">
        <div class="section-header">
          <i class="fas fa-map-marker-alt section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">Địa chỉ giao hàng</h3>
        </div>

        <div class="mb-3">
          <div class="floating-label mb-3">
            <label for="addressSelect">Chọn địa chỉ</label>
            <select id="addressSelect" class="form-select">
              <option value="">Chọn địa chỉ</option>
            </select>
          </div>

          <button onclick="showAddAddressForm()" class="btn btn-secondary d-flex align-items-center gap-2">
            <i class="fas fa-plus"></i>
            Thêm địa chỉ mới
          </button>

          <div id="addAddressForm" class="d-none bg-light p-4 rounded border-2 border-dashed mt-3">
            <h4 class="fw-semibold mb-3">Thêm địa chỉ mới</h4>
            <div class="form-grid">
              <div class="floating-label">
                <label for="provinceSelect">Tỉnh/Thành phố</label>
                <select id="provinceSelect" class="form-select" onchange="fetchDistricts(this.value)">
                  <option value="">Chọn tỉnh/thành phố</option>
                </select>
              </div>
              <div class="floating-label">
                <label for="districtSelect">Quận/Huyện</label>
                <select id="districtSelect" class="form-select" onchange="fetchWards(this.value)">
                  <option value="">Chọn quận/huyện</option>
                </select>
              </div>
              <div class="floating-label">
                <label for="wardSelect">Phường/Xã</label>
                <select id="wardSelect" class="form-select">
                  <option value="">Chọn phường/xã</option>
                </select>
              </div>
              <div class="floating-label">
                <label for="addressLine">Địa chỉ cụ thể</label>
                <input type="text" id="addressLine" class="form-control" placeholder="Số nhà, đường,...">
              </div>
            </div>
            <div class="d-flex gap-3 mt-3">
              <button onclick="addNewAddress()" class="btn btn-success d-flex align-items-center gap-2">
                <i class="fas fa-save"></i>
                Lưu địa chỉ
              </button>
              <button onclick="document.getElementById('addAddressForm').classList.add('d-none')" class="btn btn-secondary">
                Hủy
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-4">
        <div class="section-header">
          <i class="fas fa-cog section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">Cấu hình đơn hàng</h3>
        </div>

        <div class="form-grid">
          <div class="floating-label">
            <label for="saleMethod">Phương thức bán hàng</label>
            <select id="saleMethod" onchange="toggleAddressSection()" class="form-select">
              <option value="Tại quầy">🏪 Tại quầy</option>
              <option value="Giao hàng">🚚 Giao hàng</option>
            </select>
          </div>

          <div class="floating-label d-none" id="shippingFeeContainer">
            <label for="shippingFee">Phí vận chuyển</label>
            <input type="text" id="shippingFee" value="0" class="form-control" inputmode="numeric" disabled>
            <small id="shippingCalcStatus" class="text-muted d-none" hidden>Đang tính phí GHN…</small>
          </div>

          <div class="floating-label d-none" id="shippingMethodContainer" hidden>
            <label for="shippingMethod">Dịch vụ GHN</label>
            <select id="shippingMethod" class="form-select"></select>
          </div>

          <!-- Trường hiển thị phiếu giảm giá, nhấn để mở modal -->
          <div class="floating-label">
            <label for="voucherDisplay">Phiếu giảm giá</label>
            <input type="text" id="voucherDisplay" class="form-control" readonly placeholder="Chọn phiếu giảm giá" onclick="showVoucherModal()">
          </div>

          <div class="floating-label">
            <label for="paymentMethod">Phương thức thanh toán</label>
            <select id="paymentMethod" onchange="toggleCashInput()" class="form-select">
              <option value="550E8400-E29B-41D4-A716-446655440017">💵 Tiền mặt</option>
              <option value="550E8400-E29B-41D4-A716-446655440018">🏦 Chuyển khoản</option>
            </select>
          </div>

          <div id="cashInput" class="d-none floating-label">
            <label for="cashAmount">Số tiền khách đưa</label>
            <input type="text" id="cashAmount" value="0" class="form-control" inputmode="numeric">
          </div>
        </div>
      </div>
      <!-- Modal chọn phiếu giảm giá -->
      <div class="modal fade" id="voucherModal" tabindex="-1" aria-labelledby="voucherModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header" style="background-color: var(--light-blue);">
              <h5 class="modal-title" id="voucherModalLabel">Chọn phiếu giảm giá</h5>
              <button type="button" class="btn-close" onclick="closeVoucherModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <!-- Phần phiếu ORDER -->
              <div class="mb-4">
                <h6 class="fw-bold">Phiếu giảm giá đơn hàng</h6>
                <div id="orderVoucherList" class="d-flex flex-column gap-2">
                  <div class="form-check">
                    <input type="checkbox" id="no-order-voucher" class="form-check-input" name="orderVoucher" value="" checked>
                    <label for="no-order-voucher" class="form-check-label">🎫 Không sử dụng</label>
                  </div>
                  <!-- Phiếu ORDER sẽ được thêm vào đây -->
                </div>
              </div>
              <!-- Phần phiếu SHIPPING -->
              <div id="shippingVoucherSection" class="d-none">
                <h6 class="fw-bold">Phiếu miễn phí vận chuyển</h6>
                <div id="shippingVoucherList" class="d-flex flex-column gap-2">
                  <div class="form-check">
                    <input type="checkbox" id="no-shipping-voucher" class="form-check-input" name="shippingVoucher" value="" checked>
                    <label for="no-shipping-voucher" class="form-check-label">🚚 Không sử dụng</label>
                  </div>
                  <!-- Phiếu SHIPPING sẽ được thêm vào đây -->
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" style="background-color: var(--primary-color);" onclick="applyVouchersFromModal()">Áp dụng</button>
              <button type="button" class="btn btn-secondary" onclick="closeVoucherModal()">Đóng</button>
            </div>
          </div>
        </div>
      </div>
      <div class="summary-card mb-4">
        <div class="section-header">
          <i class="fas fa-calculator section-icon"></i>
          <h3 class="fs-4 fw-bold mb-0">Tổng kết đơn hàng</h3>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <span class="fw-medium">Tổng tiền hàng:</span>
              <span id="subTotal" class="fw-bold fs-5">0 VNĐ</span>
            </div>
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <span class="fw-medium">Phí vận chuyển:</span>
              <span id="shippingFeeDisplay" class="fw-bold fs-5">0 VNĐ</span>
            </div>
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <span class="fw-medium">Giảm giá:</span>
              <span id="discount" class="fw-bold fs-5">0 VNĐ</span>
            </div>
          </div>

          <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center py-3 bg-light rounded px-3 mb-3">
              <span class="fw-bold fs-4">Tổng tiền:</span>
              <span id="total" class="fw-bold fs-3 text-success">0 VNĐ</span>
            </div>
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <span class="fw-medium">Tiền trả lại:</span>
              <span id="changeAmount" class="fw-bold fs-5">0 VNĐ</span>
            </div>
          </div>
        </div>
      </div>

      <button onclick="createOrder()" class="btn btn-success w-100 py-3 fs-4 fw-bold d-flex align-items-center justify-content-center gap-3">
        <i class="fas fa-check-circle fs-3"></i>
        Tạo đơn hàng
      </button>
    </div>

    <div id="qrScannerModal">
      <div class="scanner-container">
        <div id="qr-reader"></div>
        <div class="scan-overlay">
          <div class="scan-line"></div>
          <div class="scanner-corners"></div>
        </div>
      </div>
      <div class="scanner-footer">
        <button class="close-button" onclick="stopQrScanner()">Close</button>
      </div>
    </div>

    <div id="customerModal" class="modal">
      <div class="modal-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-users fs-3 text-primary"></i>
            <h3 class="fs-3 fw-bold">Danh sách khách hàng</h3>
          </div>
          <button onclick="document.getElementById('customerModal').style.display='none'" class="btn-close"></button>
        </div>

        <div class="mb-4">
          <div class="floating-label">
            <label for="customerSearch">Tìm kiếm khách hàng</label>
            <input type="text" id="customerSearch" class="form-control" placeholder="Nhập tên, số điện thoại hoặc email">
          </div>
        </div>

        <div class="mb-4">
          <h4 class="fs-5 fw-semibold text-muted mb-3 d-flex align-items-center gap-2">
            <i class="fas fa-user text-primary"></i>
            Khách lẻ
          </h4>
          <div id="retailCustomer" class="p-3 border-2 border-dashed rounded cursor-pointer hover-bg-light" onclick="selectCustomerFromModal('0999999999', 'Khách lẻ', '')">
            <div class="d-flex align-items-center gap-3">
              <i class="fas fa-user-circle fs-3 text-muted"></i>
              <span class="fw-medium">Khách lẻ</span>
            </div>
          </div>
        </div>

        <div>
          <h4 class="fs-5 fw-semibold text-muted mb-3 d-flex align-items-center gap-2">
            <i class="fas fa-address-book text-success"></i>
            Khách hàng khác
          </h4>
          <div id="customerList" class="overflow-auto" style="max-height: 300px;"></div>
        </div>

        <div id="customerSpinner" class="spinner mt-4"></div>
      </div>
    </div>

    <div id="productModal" class="modal">
      <div class="modal-content">
        <div class="d-flex align-items-center gap-3 mb-4">
          <i class="fas fa-box fs-3 text-primary"></i>
          <h3 class="fs-3 fw-bold">Danh sách sản phẩm</h3>
        </div>
        <div class="mb-4">
          <div class="floating-label">
            <label for="productSearch">Tìm kiếm sản phẩm</label>
            <input type="text" id="productSearch" class="form-control" placeholder="Nhập tên sản phẩm">
          </div>
        </div>
        <div id="productList" class="overflow-auto" style="max-height: 400px;"></div>
        <div id="productSpinner" class="spinner mt-4"></div>
        <button onclick="document.getElementById('productModal').style.display='none'" class="btn btn-secondary w-100 mt-3">
          Đóng
        </button>
      </div>
    </div>

    <div id="variantModal" class="modal">
      <div class="modal-content">
        <div class="d-flex align-items-center gap-3 mb-4">
          <i class="fas fa-palette fs-3 text-primary"></i>
          <h3 class="fs-3 fw-bold" id="variantModalTitle">Chọn biến thể sản phẩm</h3>
        </div>

        <div class="form-grid mb-4">
          <div class="floating-label">
            <label for="colorSelect">Màu sắc</label>
            <select id="colorSelect" class="form-select" onchange="fetchVariants()">
              <option value="">Chọn màu sắc</option>
            </select>
          </div>

          <div class="floating-label">
            <label for="sizeSelect">Kích cỡ</label>
            <select id="sizeSelect" class="form-select" onchange="fetchVariants()">
              <option value="">Chọn kích cỡ</option>
            </select>
          </div>
        </div>

        <div id="variantDetails" class="d-none bg-light p-4 rounded mb-4">
          <div class="row align-items-center">
            <div class="col-md-6" id="variantImage"></div>
            <div class="col-md-6">
              <div class="mb-3 d-flex justify-content-between">
                <span class="fw-medium">Giá:</span>
                <span id="variantPrice" class="fw-bold text-primary"></span>
              </div>
              <div class="mb-3 d-flex justify-content-between">
                <span class="fw-medium">Tồn kho:</span>
                <span id="variantStock" class="fw-bold text-success"></span>
              </div>
              <div class="floating-label">
                <label for="variantQuantity">Số lượng</label>
                <input type="number" id="variantQuantity" min="1" value="1" class="form-control">
              </div>
            </div>
          </div>
        </div>

        <div id="variantSpinner" class="spinner mb-4"></div>

        <div class="d-flex gap-3">
          <button onclick="addVariantToCart()" class="btn btn-success flex-fill d-flex align-items-center justify-content-center gap-2">
            <i class="fas fa-cart-plus"></i>
            Thêm vào giỏ hàng
          </button>
          <button onclick="document.getElementById('variantModal').style.display='none'" class="btn btn-secondary">
            Hủy
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Chuyển "12.345 VNĐ" -> 12345
  const unformatCurrency = (v) => parseInt(String(v).replace(/[^\d]/g, ''), 10) || 0;
  // Chuyển 12345 -> "12.345"
  const formatCurrency = (n) => (Number(n) || 0).toLocaleString('vi-VN');

  const BASE_URL = '/acvstore/ban-hang';
  let tabs = [];
  let currentTabId = null;
  const MAX_TABS = 5;
  let currentProductId = null;
  let isUpdating = false; // Prevent concurrent updates

  // ===== GHN CONFIG (tái dùng như trang checkout) =====
  const SHOP_FROM_DISTRICT_ID = 1542; // Quận/Huyện lấy hàng của shop
  const GHN_DEFAULT = {
    weightPerItem: 500, // gram
    length: 20, width: 15, height: 10, // cm
    insuranceValue: 100000 // VND
  };

  // GHN state/cache
  const GHN = {
    provinces: [],               // [{ProvinceID, ProvinceName}]
    districtsByProvince: {},     // { [provinceId]: [{DistrictID, DistrictName}] }
    wardsByDistrict: {}          // { [districtId]: [{WardCode, WardName}] }
  };

  // Chuẩn hóa chuỗi để so khớp tên hành chính
  const normalize = (str) => (str || "")
          .toLowerCase()
          .replace(/(tỉnh|thành phố|quận|huyện|thị xã|phường|xã|thị trấn)/gi, "")
          .replace(/[\s\.\-]/g, "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

  // Lấy danh sách Tỉnh/Thành từ GHN
  async function ghnLoadProvinces() {
    if (GHN.provinces.length) return GHN.provinces;
    const res = await fetch('/api/ghn/provinces');
    const json = await res.json();
    const parsed = JSON.parse(json.data);
    GHN.provinces = parsed.data || [];
    return GHN.provinces;
  }

  // Lấy Quận/Huyện theo ProvinceID từ GHN (có cache)
  async function ghnLoadDistricts(provinceId) {
    if (GHN.districtsByProvince[provinceId]) return GHN.districtsByProvince[provinceId];
    const res = await fetch(`/api/ghn/districts?provinceId=${provinceId}`);
    const json = await res.json();
    const parsed = JSON.parse(json.data);
    GHN.districtsByProvince[provinceId] = parsed.data || [];
    return GHN.districtsByProvince[provinceId];
  }

  // Lấy Phường/Xã theo DistrictID từ GHN (có cache)
  async function ghnLoadWards(districtId) {
    if (GHN.wardsByDistrict[districtId]) return GHN.wardsByDistrict[districtId];
    const res = await fetch(`/api/ghn/wards?districtId=${districtId}`);
    const json = await res.json();
    const parsed = JSON.parse(json.data);
    GHN.wardsByDistrict[districtId] = parsed.data || [];
    return GHN.wardsByDistrict[districtId];
  }

  // Parse "Số nhà, Phường, Quận, Tỉnh" -> mã GHN
  async function mapAddressTextToGhnCodes(fullAddress) {
    // Kỳ vọng: "... , <Phường/Xã> , <Quận/Huyện> , <Tỉnh/Thành>"
    const parts = (fullAddress || '').split(',').map(s => s.trim()).filter(Boolean);
    if (parts.length < 3) throw new Error('Địa chỉ không đủ 3 phần: phường, quận, tỉnh.');

    const wardName     = parts[parts.length - 3];
    const districtName = parts[parts.length - 2];
    const provinceName = parts[parts.length - 1];

    await ghnLoadProvinces();
    const province = GHN.provinces.find(p =>
            normalize(p.ProvinceName).includes(normalize(provinceName))
    );
    if (!province) throw new Error('Không tìm thấy Tỉnh/Thành trong GHN.');

    const districts = await ghnLoadDistricts(province.ProvinceID);
    const district = districts.find(d =>
            normalize(d.DistrictName).includes(normalize(districtName))
    );
    if (!district) throw new Error('Không tìm thấy Quận/Huyện trong GHN.');

    const wards = await ghnLoadWards(district.DistrictID);
    const ward = wards.find(w =>
            normalize(w.WardName).includes(normalize(wardName))
    );
    if (!ward) throw new Error('Không tìm thấy Phường/Xã trong GHN.');

    return {
      provinceId: province.ProvinceID,
      districtId: district.DistrictID,
      wardCode: ward.WardCode
    };
  }

  function zeroShippingBecauseNoAddress() {
    const shippingFeeInput = document.getElementById('shippingFee');
    const shippingMethodContainer = document.getElementById('shippingMethodContainer');
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab || !shippingFeeInput) return;

    tab.shippingFee = 0;
    shippingFeeInput.value = formatCurrency(0);
    updateSummary(tab);
    // Nếu có voucher thì re-apply để tổng tiền chuẩn
    if (tab.voucherId) applyVoucher(tab.voucherId);
    // Ẩn chọn dịch vụ GHN vì chưa có địa chỉ
    shippingMethodContainer?.classList.add('d-none');
  }


  function setShippingUiLoading(isLoading) {
    const status = document.getElementById('shippingCalcStatus');
    if (!status) return;
    status.classList.toggle('d-none', !isLoading);
    status.textContent = isLoading ? 'Đang tính phí GHN…' : '';
  }

  async function ghnLoadServices(toDistrictId) {
    const select = document.getElementById('shippingMethod');
    if (!select) return [];
    select.innerHTML = '';
    const res = await fetch(`/api/ghn/available-services?fromDistrictId=${SHOP_FROM_DISTRICT_ID}&toDistrictId=${toDistrictId}`);
    const json = await res.json();
    const services = (JSON.parse(json.data).data) || [];

    services.forEach(sv => {
      const opt = document.createElement('option');
      opt.value = sv.service_id;
      opt.text = `${sv.short_name || 'GHN'} (type ${sv.service_type_id})`;
      select.appendChild(opt);
    });
    return services;
  }

  function computePackageFromCart(tab) {
    // Gộp cân nặng theo số lượng – mỗi sp 0.5kg (500g)
    const totalQty = (tab.cart || []).reduce((sum, item) => sum + (parseInt(item.soLuong) || 0), 0);
    const weight = Math.max(1, totalQty) * GHN_DEFAULT.weightPerItem; // gram
    return {
      weight,
      length: GHN_DEFAULT.length,
      width:  GHN_DEFAULT.width,
      height: GHN_DEFAULT.height,
      insuranceValue: GHN_DEFAULT.insuranceValue
    };
  }

  async function ghnCalculateShipping({ districtId, wardCode }) {
    const serviceSelect = document.getElementById('shippingMethod');
    if (!serviceSelect || !serviceSelect.value) return null;

    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return null;

    const pkg = computePackageFromCart(tab);
    const url = `/api/ghn/shipping-fee?fromDistrictId=${SHOP_FROM_DISTRICT_ID}`
            + `&toDistrictId=${districtId}`
            + `&toWardCode=${wardCode}`
            + `&weight=${pkg.weight}`
            + `&length=${pkg.length}`
            + `&width=${pkg.width}`
            + `&height=${pkg.height}`
            + `&serviceId=${serviceSelect.value}`
            + `&insuranceValue=${pkg.insuranceValue}`;

    const res = await fetch(url);
    const json = await res.json();
    const fee = JSON.parse(json.data).data.total;
    return fee || 0;
  }

  async function setupShippingForSelectedAddress({ recalcOnly = false } = {}) {
    const tab = tabs.find(t => t.id === currentTabId);
    const shippingFeeInput = document.getElementById('shippingFee');
    const shippingMethodContainer = document.getElementById('shippingMethodContainer');
    const addressSelect = document.getElementById('addressSelect');

    if (!tab) return;

    // Không giao hàng -> ẩn chọn dịch vụ + phí = 0
    if (tab.saleMethod !== 'Giao hàng') {
      shippingMethodContainer?.classList.add('d-none');
      if (tab.shippingFee !== 0) {
        tab.shippingFee = 0;
        if (shippingFeeInput) shippingFeeInput.value = formatCurrency(0);
        updateSummary(tab);
        if (tab.voucherId) await applyVoucher(tab.voucherId);
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
      }
      return;
    }

    // Lấy địa chỉ hiện tại (từ state hoặc dropdown)
    tab.selectedAddress = (tab.selectedAddress || addressSelect?.value || '').trim();

    // Không có địa chỉ -> phí ship = 0 và thoát
    if (!tab.selectedAddress) {
      zeroShippingBecauseNoAddress();
      return;
    }

    try {
      setShippingUiLoading(true);
      shippingMethodContainer?.classList.remove('d-none');

      // 1) Map địa chỉ text -> mã GHN
      const { districtId, wardCode } = await mapAddressTextToGhnCodes(tab.selectedAddress);

      // 2) Nạp dịch vụ GHN (trừ khi chỉ tính lại)
      if (!recalcOnly) {
        const services = await ghnLoadServices(districtId);
        if (!services.length) {
          showToast('Không có dịch vụ GHN khả dụng cho quận này.', 'warning');
          zeroShippingBecauseNoAddress();
          return;
        }
        const select = document.getElementById('shippingMethod');
        if (select && !select.value && services[0]) {
          select.value = services[0].service_id;
        }
      }

      // Nếu đang recalc nhưng select chưa có option, nạp dịch vụ luôn
      const select = document.getElementById('shippingMethod');
      if (select && !select.value) {
        const services = await ghnLoadServices(districtId);
        if (services[0]) select.value = services[0].service_id;
      }

      if (!document.getElementById('shippingMethod')?.value) {
        showToast('Chưa chọn dịch vụ GHN.', 'warning');
        zeroShippingBecauseNoAddress();
        return;
      }

      // 3) Tính phí GHN
      const fee = await ghnCalculateShipping({ districtId, wardCode });
      const shippingFee = Number.isFinite(fee) ? fee : 0;

      // 4) Cập nhật UI + state
      if (shippingFeeInput) shippingFeeInput.value = formatCurrency(shippingFee);
      tab.shippingFee = shippingFee;
      updateSummary(tab);
      if (tab.voucherId) await applyVoucher(tab.voucherId);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    } catch (err) {
      console.error('GHN setup/tính phí lỗi:', err);
      showToast('Không tính được phí GHN. Bạn có thể nhập tay phí ship.', 'warning');
      zeroShippingBecauseNoAddress();
      shippingFeeInput?.removeAttribute('disabled');
      shippingFeeInput?.setAttribute('placeholder', 'Nhập phí ship thủ công');
    } finally {
      setShippingUiLoading(false);
    }
  }

  // Hiển thị thông báo toast với animation cải tiến
  function showToast(message, type = "info") {
    const container = document.getElementById("toastContainer");
    if (!container) return;

    const toast = document.createElement("div");
    const colors = {
      success: "bg-success",
      error: "bg-danger",
      warning: "bg-warning",
      info: "bg-primary"
    };

    toast.className = `toast show align-items-center text-white ${colors[type] || colors.info} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    const icon = {
      success: "fas fa-check-circle",
      error: "fas fa-exclamation-circle",
      warning: "fas fa-exclamation-triangle",
      info: "fas fa-info-circle"
    };

    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body d-flex align-items-center gap-2">
          <i class="${icon[type] || icon.info}"></i>
          <span class="fw-medium">${message}</span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

    container.appendChild(toast);

    // Remove toast after 3 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 3000);
  }

  // Cải thiện hàm renderCart với kiểm tra tồn kho chính xác
  function renderCart(cart) {
    const tbody = document.getElementById("cartItems");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!cart || cart.length === 0) {
      const emptyRow = document.createElement("tr");
      emptyRow.innerHTML = `
      <td colspan="8" class="text-center py-5">
        <div class="d-flex flex-column align-items-center gap-3 text-muted">
          <i class="fas fa-shopping-cart" style="font-size: 4rem; opacity: 0.3;"></i>
          <p class="fs-4 fw-medium">Giỏ hàng trống</p>
          <p class="small">Hãy thêm sản phẩm vào giỏ hàng</p>
        </div>
      </td>
    `;
      tbody.appendChild(emptyRow);
      return;
    }

    cart.forEach((item, index) => {
      const row = document.createElement("tr");

      const actualStock = parseInt(item.availableStock || 0);
      const currentQuantity = parseInt(item.soLuong || 0);
      const price = parseFloat(item.gia || 0);
      const totalPrice = parseFloat(item.thanhTien || 0);
      const originalPrice = parseFloat(item.originalPrice || item.gia);
      const phanTramGiam = parseFloat(item.phanTramGiam || 0);

      const isMinQuantity = currentQuantity <= 1;
      const isMaxQuantity = actualStock === 0; // Chỉ vô hiệu hóa khi tồn kho khả dụng bằng 0
      const isOverStock = actualStock < 0;

      const stockWarning = isOverStock
              ? `<div class="stock-warning"><i class="fas fa-exclamation-triangle"></i>Tồn kho âm (${actualStock})</div>`
              : actualStock === 0
                      ? `<div class="stock-warning"><i class="fas fa-exclamation-triangle"></i>Hết tồn kho khả dụng</div>`
                      : "";

      const priceDisplay = phanTramGiam > 0
              ? `<span class="fw-bold">${price.toLocaleString("vi-VN")} VNĐ</span>
               <div class="small text-muted text-decoration-line-through">${originalPrice.toLocaleString("vi-VN")} VNĐ</div>
               <div class="small text-success">Giảm ${phanTramGiam}%</div>`
              : `<span class="fw-bold">${price.toLocaleString("vi-VN")} VNĐ</span>`;

      row.innerHTML = `
      <td>
        <img src="${item.hinhAnh || "https://via.placeholder.com/60x60?text=No+Image"}"
             alt="Hình ảnh"
             class="rounded shadow-sm"
             style="width: 60px; height: 60px; object-fit: cover;"
             onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
      </td>
      <td>
        <div class="fw-semibold">${item.tenSanPham || "N/A"}</div>
        <div class="small text-muted">Tồn kho khả dụng: ${actualStock}</div>
      </td>
      <td>
        <span class="badge badge-primary">
          ${item.mauSac || "N/A"}
        </span>
      </td>
      <td>
        <span class="badge badge-secondary">
          ${item.kichCo || "N/A"}
        </span>
      </td>
      <td>
        ${priceDisplay}
      </td>
      <td>
        <div class="quantity-controls" data-index="${index}">
          <button class="quantity-btn btn btn-danger btn-sm ${isMinQuantity ? "disabled" : ""}"
                  ${isMinQuantity ? "disabled" : ""}
                  onclick="updateQuantity(${index}, -1, '${item.idChiTietSanPham}', ${actualStock})"
                  title="${isMinQuantity ? "Không thể giảm thêm" : "Giảm số lượng"}">
            <i class="fas fa-minus"></i>
          </button>
          <input type="number"
                 min="1"
                 value="${currentQuantity}"
                 class="form-control form-control-sm text-center fw-bold ${isOverStock ? "text-danger" : ""}"
                 style="width: 70px;"
                 onchange="updateQuantityFromInput(${index}, this.value, '${item.idChiTietSanPham}', ${actualStock})"
                 onblur="validateQuantityInput(this, ${actualStock}, ${index})">
          <button class="quantity-btn btn btn-success btn-sm ${isMaxQuantity ? "disabled" : ""}"
                  ${isMaxQuantity ? "disabled" : ""}
                  onclick="updateQuantity(${index}, 1, '${item.idChiTietSanPham}', ${actualStock})"
                  title="${isMaxQuantity ? "Hết tồn kho khả dụng" : "Tăng số lượng"}">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        ${stockWarning}
      </td>
      <td>
        <span class="fw-bold fs-5 text-success">${totalPrice.toLocaleString("vi-VN")} VNĐ</span>
      </td>
      <td>
        <button class="btn btn-danger btn-sm d-flex align-items-center gap-2"
                onclick="removeItem(${index}, '${item.idChiTietSanPham}')">
          <i class="fas fa-trash"></i>
          <span class="d-none d-sm-inline">Xóa</span>
        </button>
      </td>
    `;
      tbody.appendChild(row);
    });
  }

  // Cải thiện hàm updateQuantity với kiểm tra tồn kho chặt chẽ
  async function updateQuantity(index, delta, productDetailId, maxStock) {
    if (isUpdating) {
      showToast("Đang xử lý, vui lòng đợi...", "warning");
      return;
    }

    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab || !tab.cart[index]) {
      showToast("Không tìm thấy sản phẩm trong giỏ hàng.", "error");
      return;
    }

    const currentItem = tab.cart[index];
    const currentQuantity = parseInt(currentItem.soLuong || 0);
    let newQuantity = currentQuantity + delta;

    if (newQuantity < 1) {
      newQuantity = 1;
      showToast("Số lượng phải lớn hơn 0.", "warning");
      return;
    }

    // Không chặn số lượng tối đa ở đây, để backend xử lý
    isUpdating = true;
    const quantityControls = document.querySelector(`.quantity-controls[data-index="${index}"]`);
    if (quantityControls) {
      quantityControls.classList.add("loading");
    }

    try {
      const requestData = {
        productDetailId: String(productDetailId),
        quantity: parseInt(newQuantity),
        shippingFee: parseFloat(tab.shippingFee || 0),
        tabId: String(currentTabId),
      };

      const response = await fetch(`${BASE_URL}/cart/update`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestData),
      });

      if (!response.ok) {
        let errorMessage = "Lỗi khi cập nhật số lượng.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      await refreshCartFromServer(); // Cập nhật tồn kho theo thời gian thực
      if (tab.voucherId) {
        await applyVoucher(tab.voucherId);
      }
      showToast("Đã cập nhật số lượng!", "success");
    } catch (error) {
      console.error("Lỗi khi cập nhật số lượng:", error);
      showToast("Lỗi khi cập nhật số lượng: " + error.message, "error");
      await refreshCartFromServer(); // Đảm bảo đồng bộ giao diện khi có lỗi
    } finally {
      isUpdating = false;
      if (quantityControls) {
        quantityControls.classList.remove("loading");
      }
    }
  }

  // Hàm mới để xử lý input trực tiếp từ ô nhập số lượng
  async function updateQuantityFromInput(index, inputValue, productDetailId, maxStock) {
    const quantity = parseInt(inputValue);
    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab || !tab.cart[index]) return;

    const currentQuantity = parseInt(tab.cart[index].soLuong);

    if (isNaN(quantity) || quantity < 1) {
      showToast("Vui lòng nhập số lượng hợp lệ (≥ 1).", "warning");
      const input = document.querySelector(`.quantity-controls[data-index="${index}"] input`);
      if (input) input.value = currentQuantity;
      return;
    }

    if (quantity > maxStock) {
      showToast(`Số lượng không được vượt quá ${maxStock} (tồn kho khả dụng).`, "warning");
      const input = document.querySelector(`.quantity-controls[data-index="${index}"] input`);
      if (input) input.value = Math.min(currentQuantity, maxStock);
      return;
    }

    const delta = quantity - currentQuantity;
    if (delta !== 0) {
      await updateQuantity(index, delta, productDetailId, maxStock);
    }
  }

  // Hàm validate input khi người dùng rời khỏi ô nhập
  function validateQuantityInput(inputElement, maxStock, index) {
    const value = parseInt(inputElement.value);
    const tab = tabs.find((t) => t.id === currentTabId);

    if (!tab || !tab.cart[index]) return;

    const currentQuantity = parseInt(tab.cart[index].soLuong);

    if (isNaN(value) || value < 1) {
      inputElement.value = currentQuantity;
      showToast("Số lượng tối thiểu là 1.", "warning");
    } else if (value > maxStock) {
      inputElement.value = Math.min(currentQuantity, maxStock);
      showToast(`Số lượng tối đa là ${maxStock} (tồn kho khả dụng).`, "warning");
    }
  }

  // Hàm làm mới giỏ hàng từ server khi có lỗi
  async function refreshCartFromServer() {
    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab) return;

    try {
      const response = await fetch(`${BASE_URL}/cart/get?tabId=${currentTabId}&shippingFee=${tab.shippingFee}`);
      if (response.ok) {
        const cartData = await response.json();
        tab.cart = cartData.danhSachSanPham || [];
        tab.subTotal = cartData.tongTienHang || 0;
        tab.discount = cartData.giamGia || 0;
        tab.total = cartData.tong || 0;
        tab.shippingFee = cartData.phiVanChuyen || 0;
        renderCart(tab.cart);
        updateSummary(tab);
        localStorage.setItem("orderTabs", JSON.stringify(tabs));
      }
    } catch (error) {
      console.error("Lỗi khi làm mới giỏ hàng:", error);
      showToast("Không thể làm mới giỏ hàng. Vui lòng thử lại.", "error");
    }
  }

  // Cải thiện hàm thêm sản phẩm với kiểm tra tồn kho
  async function addVariantToCart() {
    const productDetailId = document.getElementById("variantDetails").dataset.productDetailId;
    const quantity = parseInt(document.getElementById("variantQuantity").value);
    const maxStock = parseInt(document.getElementById("variantQuantity").max);

    if (!productDetailId) {
      showToast("Vui lòng chọn biến thể sản phẩm.", "warning");
      return;
    }

    if (isNaN(quantity) || quantity < 1) {
      showToast("Vui lòng nhập số lượng hợp lệ (≥ 1).", "warning");
      return;
    }

    if (quantity > maxStock) {
      showToast(`Số lượng không được vượt quá ${maxStock} (tồn kho khả dụng).`, "warning");
      return;
    }

    try {
      const tab = tabs.find((t) => t.id === currentTabId);
      if (!tab) throw new Error("Không tìm thấy tab hiện tại.");

      const existingIndex = tab.cart.findIndex((item) => item.idChiTietSanPham === productDetailId);
      if (existingIndex >= 0) {
        const currentQuantity = tab.cart[existingIndex].soLuong;
        const newTotalQuantity = currentQuantity + quantity;

        if (newTotalQuantity > maxStock) {
          showToast(`Tổng số lượng sẽ vượt quá ${maxStock} (tồn kho khả dụng).`, "warning");
          return;
        }

        await updateQuantity(existingIndex, quantity, productDetailId, maxStock);
        document.getElementById("variantModal").style.display = "none";
        return;
      }

      const requestData = {
        productDetailId: String(productDetailId),
        quantity: parseInt(quantity),
        shippingFee: parseFloat(tab.shippingFee || 0),
        tabId: String(currentTabId),
      };

      const response = await fetch(`${BASE_URL}/cart/add`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestData),
      });

      if (!response.ok) {
        let errorMessage = "Lỗi khi thêm sản phẩm.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      document.getElementById("variantModal").style.display = "none";
      await refreshCartFromServer(); // Ensure stock is updated
      showToast("Đã thêm sản phẩm vào giỏ hàng!", "success");
    } catch (error) {
      console.error("Lỗi khi thêm biến thể:", error);
      showToast("Lỗi khi thêm sản phẩm: " + error.message, "error");
    }
  }

  // Cập nhật hàm renderTabs với styling mới
  function renderTabs() {
    const tabsContainer = document.getElementById('orderTabs');
    if (!tabsContainer) return;

    tabsContainer.innerHTML = '';

    tabs.sort((a, b) => a.id - b.id).forEach(tab => {
      const tabElement = document.createElement('div');
      tabElement.className = `tab ${tab.id === currentTabId ? 'active' : ''}`;

      const tabContent = document.createElement('div');
      tabContent.className = 'd-flex align-items-center gap-2';
      tabContent.innerHTML = `
        <i class="fas fa-receipt"></i>
        <span class="fw-semibold">Đơn ${tab.id}</span>
      `;

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-danger btn-sm rounded-circle ms-2 d-flex align-items-center justify-content-center';
      deleteBtn.style.width = '24px';
      deleteBtn.style.height = '24px';
      deleteBtn.innerHTML = '<i class="fas fa-xmark fa-sm"></i>';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteTab(tab.id);
      };

      tabContent.appendChild(deleteBtn);
      tabElement.appendChild(tabContent);
      tabElement.onclick = () => switchTab(tab.id);
      tabsContainer.appendChild(tabElement);
    });

    const addTabBtn = document.getElementById('addTabBtn');
    if (addTabBtn) {
      addTabBtn.disabled = tabs.length >= MAX_TABS;
    }
  }

  // Thêm sản phẩm bằng QR
  async function addProductByQr(productDetailId) {
    try {
      const tab = tabs.find(t => t.id === currentTabId);
      if (!tab) throw new Error('Không tìm thấy tab hiện tại.');

      // Kiểm tra sản phẩm đã tồn tại
      const existingIndex = tab.cart.findIndex(item => item.idChiTietSanPham === productDetailId);
      if (existingIndex >= 0) {
        const currentQuantity = tab.cart[existingIndex].soLuong;
        const maxStock = tab.cart[existingIndex].soLuongTonKho || tab.cart[existingIndex].stockQuantity || 0;
        await updateQuantity(existingIndex, 1, productDetailId, maxStock);
        return;
      }

      const requestData = {
        productDetailId: String(productDetailId),
        quantity: 1,
        shippingFee: parseFloat(tab.shippingFee || 0),
        tabId: String(currentTabId)
      };

      const response = await fetch(`${BASE_URL}/cart/add`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        let errorMessage = "Lỗi khi thêm sản phẩm.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      showToast('Đã thêm sản phẩm vào giỏ hàng!', 'success');
    } catch (error) {
      console.error('Lỗi khi thêm sản phẩm:', error);
      showToast('Lỗi khi thêm sản phẩm: ' + error.message, 'error');
    }
  }

  // Cập nhật giỏ hàng từ response
  function updateCartFromResponse(data) {
    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab) return;

    tab.cart = data.danhSachSanPham || [];
    tab.subTotal = data.tongTienHang || 0;
    tab.discount = data.giamGia || 0;
    tab.total = data.tong || 0;
    tab.shippingFee = (data.phiVanChuyen !== undefined && data.phiVanChuyen !== null)
      ? data.phiVanChuyen
      : tab.shippingFee;

    renderCart(tab.cart);
    updateSummary(tab);
    // Nếu giao hàng: cân nặng thay đổi → tính lại GHN
    if (tab.saleMethod === 'Giao hàng' && tab.selectedAddress) {
      setupShippingForSelectedAddress({ recalcOnly: true });
    }
    localStorage.setItem("orderTabs", JSON.stringify(tabs));
    fetchVouchers();
  }

  // Khởi tạo tabs
  async function initTabs() {
    try {
      const savedTabs = localStorage.getItem('orderTabs');
      const savedTabId = localStorage.getItem('currentTabId');

      if (savedTabs && savedTabId) {
        tabs = JSON.parse(savedTabs);
        // Đặt lại paymentMethod cho các tab không hợp lệ
        tabs.forEach(tab => {
          if (!tab.paymentMethod || tab.paymentMethod !== '550E8400-E29B-41D4-A716-446655440018') {
            tab.paymentMethod = '550E8400-E29B-41D4-A716-446655440017';
          }
        });
        currentTabId = parseInt(savedTabId);
        tabs.sort((a, b) => a.id - b.id);
        renderTabs();
        loadTabContent(currentTabId);
        return;
      }

      // Tạo tab mặc định
      await addNewTab();
    } catch (error) {
      console.error('Lỗi khi khởi tạo tabs:', error);
      showToast('Không thể tải giỏ hàng. Vui lòng thử lại.', 'error');
      await addNewTab();
    }
  }

  function getNextTabId() {
    for (let i = 1; i <= MAX_TABS; i++) {
      if (!tabs.some(tab => tab.id === i)) return i;
    }
    return tabs.length + 1;
  }

  async function addNewTab() {
    if (tabs.length >= MAX_TABS) {
      showToast('Đã đạt giới hạn 5 đơn hàng.', 'warning');
      return;
    }

    try {
      const newTabId = getNextTabId();

      // Xóa giỏ hàng cũ trước khi tạo tab mới
      await fetch(`${BASE_URL}/cart/clear?tabId=${newTabId}`, { method: 'POST' });

      const newTab = {
        id: newTabId,
        cart: [],
        customerPhone: '',
        customerName: '',
        customerEmail: '',
        saleMethod: 'Tại quầy',
        shippingFee: 0,
        voucherId: null,
        paymentMethod: '550E8400-E29B-41D4-A716-446655440017',
        cashAmount: 0,
        subTotal: 0,
        discount: 0,
        total: 0,
        addresses: [],
        selectedAddress: ''
      };

      tabs.push(newTab);
      currentTabId = newTab.id;
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      localStorage.setItem('currentTabId', currentTabId);
      renderTabs();
      loadTabContent(currentTabId);

      setTimeout(() => {
        const saleMethodEl = document.getElementById('saleMethod');
        const addressSection = document.getElementById('addressSection');
        const shippingFeeContainer = document.getElementById('shippingFeeContainer');
        const shippingMethodContainer = document.getElementById('shippingMethodContainer');

        if (saleMethodEl) saleMethodEl.value = 'Tại quầy';
        addressSection?.classList.add('d-none');
        shippingFeeContainer?.classList.add('d-none');
        shippingMethodContainer?.classList.add('d-none');

        // Đồng bộ lại tổng tiền & lưu state
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.saleMethod = 'Tại quầy';
          tab.shippingFee = 0;
          updateSummary(tab);
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
      }, 0);
    } catch (error) {
      showToast('Lỗi khi tạo tab mới: ' + error.message, 'error');
    }
  }

  function switchTab(tabId) {
    currentTabId = tabId;
    localStorage.setItem('currentTabId', currentTabId);
    renderTabs();
    loadTabContent(tabId);
  }

  async function deleteTab(tabId) {
    if (tabs.length <= 1) {
      showToast("Phải giữ ít nhất một tab.", "warning");
      return;
    }

    try {
      await fetch(`${BASE_URL}/cart/clear?tabId=${tabId}`, { method: "POST" });
      tabs = tabs.filter(t => t.id !== tabId);
      if (currentTabId === tabId) {
        currentTabId = tabs.length > 0 ? tabs[tabs.length - 1].id : null;
      }

      localStorage.setItem("orderTabs", JSON.stringify(tabs));
      localStorage.setItem("currentTabId", currentTabId);
      renderTabs();

      if (currentTabId) {
        loadTabContent(currentTabId);
      }
      showToast("Đã xóa tab và giải phóng tồn kho!", "success");
    } catch (error) {
      console.error("Lỗi khi xóa tab:", error);
      showToast("Lỗi khi xóa tab: " + error.message, "error");
    }
  }

  async function loadTabContent(tabId) {
    const tab = tabs.find(t => t.id === tabId);
    if (!tab) return;

    // Đặt phương thức thanh toán mặc định là Tiền mặt nếu không hợp lệ
    if (!tab.paymentMethod || tab.paymentMethod !== '550E8400-E29B-41D4-A716-446655440018') {
      tab.paymentMethod = '550E8400-E29B-41D4-A716-446655440017';
    }

    // Load thông tin từ tab
    const elements = {
      customerPhone: document.getElementById('customerPhone'),
      customerName: document.getElementById('customerName'),
      customerEmail: document.getElementById('customerEmail'),
      saleMethod: document.getElementById('saleMethod'),
      shippingFee: document.getElementById('shippingFee'),
      paymentMethod: document.getElementById('paymentMethod'),
      cashAmount: document.getElementById('cashAmount'),
      shippingFeeContainer: document.getElementById('shippingFeeContainer'),
      addressSection: document.getElementById('addressSection')
    };

    if (elements.customerPhone) elements.customerPhone.value = tab.customerPhone || '';
    if (elements.customerName)  elements.customerName.value  = tab.customerName  || '';
    if (elements.customerEmail) elements.customerEmail.value = tab.customerEmail || '';

    if (elements.saleMethod) elements.saleMethod.value = tab.saleMethod;

// Nếu là Khách lẻ: không hiển thị SĐT & Email
    if (tab.customerPhone === '0999999999') {
      if (elements.customerPhone) {
        elements.customerPhone.value = '';
        elements.customerPhone.placeholder = 'Khách lẻ (không thu thập SĐT)';
      }
      if (elements.customerName)  elements.customerName.value  = 'Khách lẻ';
      if (elements.customerEmail) elements.customerEmail.value = '';

      // Khoá phần giao hàng + reset phí ship
      if (elements.saleMethod) {
        elements.saleMethod.value = 'Tại quầy';
        elements.saleMethod.setAttribute('disabled', 'true');
      }
      const addressSection = document.getElementById('addressSection');
      const shippingFeeContainer = document.getElementById('shippingFeeContainer');
      if (addressSection) addressSection.classList.add('d-none');
      if (shippingFeeContainer) shippingFeeContainer.classList.add('d-none');

      tab.saleMethod = 'Tại quầy';
      tab.shippingFee = 0;
      updateSummary(tab);
      renderCart(tab.cart);
      // Nếu tab đang ở "Giao hàng" và có địa chỉ thì tính GHN
      if (tab.saleMethod === 'Giao hàng' && tab.selectedAddress) {
        setupShippingForSelectedAddress();
      }

    } else {
      if (elements.saleMethod) elements.saleMethod.removeAttribute('disabled');
    }

    if (elements.shippingFee) elements.shippingFee.value = formatCurrency(tab.shippingFee);
    if (elements.paymentMethod) elements.paymentMethod.value = tab.paymentMethod;
    if (elements.cashAmount) elements.cashAmount.value = tab.cashAmount || 0; // Default to 0

    toggleCashInput();
    renderCart(tab.cart);
    updateSummary(tab);

    // Load giỏ hàng từ server
    try {
      const response = await fetch(`${BASE_URL}/cart/get?tabId=${tabId}&shippingFee=${tab.shippingFee}`);
      if (response.ok) {
        const cartData = await response.json();
        tab.cart = cartData.danhSachSanPham || [];
        tab.subTotal = cartData.tongTienHang || 0;
        tab.discount = cartData.giamGia || 0;
        tab.total = cartData.tong || 0;
        tab.cashAmount = cartData.cashAmount || 0;
        renderCart(tab.cart);
        updateSummary(tab);
      }
    } catch (error) {
      console.error('Lỗi khi load giỏ hàng:', error);
    }

    if (tab.customerPhone && tab.customerPhone !== '0999999999') {
      await fetchCustomerAddresses();
    }

    await fetchVouchers();
    localStorage.setItem('orderTabs', JSON.stringify(tabs));
  }

  async function fetchCustomerAddresses() {
    const phoneEl = document.getElementById('customerPhone');
    const nameEl  = document.getElementById('customerName');
    const emailEl = document.getElementById('customerEmail');
    const addressSection        = document.getElementById('addressSection');
    const shippingFeeContainer  = document.getElementById('shippingFeeContainer');
    const addressSelect         = document.getElementById('addressSelect');

    if (!phoneEl) return;

    const phone = (phoneEl.value || '').trim();
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    // ==== Validate SĐT (điều kiện showToast mới) ====
    // Không nhập gì -> ẩn khu vực địa chỉ, không toast
    if (!phone) {
      addressSection?.classList.add('d-none');
      return;
    }

    // Khách lẻ -> bỏ qua (đã xử lý nơi khác), không toast
    if (phone === '0999999999') return;

    // Nhập nhưng sai định dạng 10 số -> toast (vì KHÔNG phải 0999999999)
    if (!/^\d{10}$/.test(phone)) {
      showToast('Số điện thoại không hợp lệ. Vui lòng nhập 10 chữ số.', 'warning');
      addressSection?.classList.add('d-none');
      return;
    }
    // ==== END validate ====

    // Mở khoá saleMethod
    document.getElementById('saleMethod')?.removeAttribute('disabled');

    try {
      const res = await fetch(`${BASE_URL}/customer/${phone}/addresses`);
      if (!res.ok) {
        let errorMessage = "Không tìm thấy khách hàng.";
        try {
          const err = await res.json();
          errorMessage = err.error || err.message || errorMessage;
        } catch {}
        showToast(errorMessage, 'error');
        nameEl && (nameEl.value = '');
        emailEl && (emailEl.value = '');
        addressSection?.classList.add('d-none');
        return;
      }

      const data = await res.json();

      // Thông tin KH
      tab.customerName  = data.hoTen  || '';
      tab.customerEmail = data.email  || '';
      nameEl  && (nameEl.value  = tab.customerName);
      emailEl && (emailEl.value = tab.customerEmail);

      // ==== ĐỊA CHỈ: dựng lại options + chọn mặc định ====
      const raw = Array.isArray(data.addresses) ? data.addresses : [];
      const toString = (a) => typeof a === 'string'
              ? a
              : [a.chiTietDiaChi, a.phuongXa, a.quanHuyen, a.tinhThanhPho].filter(Boolean).join(', ');

      // Tìm mặc định theo nhiều khả năng
      const defaultObj =
              raw.find(a => typeof a === 'object' && (a.macDinh || a.isDefault || a.default)) || null;

      let defaultAddress =
              (typeof data.defaultAddress === 'string' && data.defaultAddress) ? data.defaultAddress
                      : (defaultObj ? toString(defaultObj)
                              : (raw[0] ? toString(raw[0]) : ''));

      // Đổ dropdown
      if (addressSelect) {
        addressSelect.innerHTML = '<option value="">Chọn địa chỉ</option>';
        const unique = [...new Set(raw.map(toString))]; // loại trùng
        unique.forEach(addr => {
          const opt = document.createElement('option');
          opt.value = addr;
          opt.text  = addr;
          addressSelect.appendChild(opt);
        });

        // Chọn mặc định
        if (defaultAddress && unique.includes(defaultAddress)) {
          addressSelect.value = defaultAddress;
          tab.selectedAddress = defaultAddress;
        } else {
          // không có -> bỏ chọn
          addressSelect.value = '';
          tab.selectedAddress = '';
        }
      }

      // Hiện/ẩn UI theo saleMethod
      if (tab.saleMethod === 'Giao hàng') {
        addressSection?.classList.remove('d-none');
        shippingFeeContainer?.classList.remove('d-none');

        // Nếu có địa chỉ mặc định -> tính GHN, ngược lại fee=0
        if (tab.selectedAddress) {
          setupShippingForSelectedAddress();
        } else {
          zeroShippingBecauseNoAddress();
        }
      } else {
        addressSection?.classList.add('d-none');
        shippingFeeContainer?.classList.add('d-none');
        tab.shippingFee = 0;
        updateSummary(tab);
      }

      // Lưu lại
      tab.addresses = raw.map(toString);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    } catch (error) {
      console.error('Lỗi khi lấy thông tin khách hàng:', error);
      showToast('Lỗi khi tải địa chỉ: ' + error.message, 'error');
      addressSection?.classList.add('d-none');
    }
  }

  let provincesData = [];

  async function fetchProvinces() {
    try {
      const response = await fetch('https://provinces.open-api.vn/api/p/');
      if (!response.ok) throw new Error('Lỗi khi lấy danh sách tỉnh/thành phố');
      const data = await response.json();
      provincesData = data;

      const provinceSelect = document.getElementById('provinceSelect');
      if (provinceSelect) {
        provinceSelect.innerHTML = '<option value="">Chọn tỉnh/thành phố</option>';
        data.forEach(province => {
          const option = document.createElement('option');
          option.value = province.code;
          option.text = province.name;
          provinceSelect.appendChild(option);
        });

        const districtSelect = document.getElementById('districtSelect');
        const wardSelect = document.getElementById('wardSelect');
        if (districtSelect) districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
        if (wardSelect) wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';
      }
    } catch (error) {
      showToast('Lỗi khi tải tỉnh/thành phố: ' + error.message, 'error');
    }
  }

  async function fetchDistricts(provinceCode) {
    const districtSelect = document.getElementById('districtSelect');
    const wardSelect = document.getElementById('wardSelect');
    if (!districtSelect || !wardSelect) return;

    districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
    wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';

    if (!provinceCode) return;

    try {
      const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
      if (!response.ok) throw new Error('Lỗi khi lấy danh sách quận/huyện');
      const data = await response.json();
      const districts = data.districts || [];

      districts.forEach(district => {
        const option = document.createElement('option');
        option.value = district.code;
        option.text = district.name;
        districtSelect.appendChild(option);
      });
    } catch (error) {
      showToast('Lỗi khi tải quận/huyện: ' + error.message, 'error');
    }
  }

  async function fetchWards(districtCode) {
    const wardSelect = document.getElementById('wardSelect');
    if (!wardSelect) return;

    wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';

    if (!districtCode) return;

    try {
      const response = await fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`);
      if (!response.ok) throw new Error('Lỗi khi lấy danh sách phường/xã');
      const data = await response.json();
      const wards = data.wards || [];

      wards.forEach(ward => {
        const option = document.createElement('option');
        option.value = ward.code;
        option.text = ward.name;
        wardSelect.appendChild(option);
      });
    } catch (error) {
      showToast('Lỗi khi tải phường/xã: ' + error.message, 'error');
    }
  }

  async function addNewAddress() {
    const phoneInput = document.getElementById('customerPhone');
    const addressLineInput = document.getElementById('addressLine');
    const wardSelect = document.getElementById('wardSelect');
    const districtSelect = document.getElementById('districtSelect');
    const provinceSelect = document.getElementById('provinceSelect');

    if (!phoneInput || !addressLineInput || !wardSelect || !districtSelect || !provinceSelect) {
      showToast('Không tìm thấy các trường nhập liệu.', 'error');
      return;
    }

    const phone = phoneInput.value.trim();
    const chiTietDiaChi = addressLineInput.value.trim();

    // Kiểm tra người dùng có chọn đủ phường/xã, quận/huyện, tỉnh/thành chưa
    if (
            !phone || !chiTietDiaChi ||
            wardSelect.selectedIndex <= 0 ||
            districtSelect.selectedIndex <= 0 ||
            provinceSelect.selectedIndex <= 0
    ) {
      showToast('Vui lòng nhập đầy đủ địa chỉ và số điện thoại.', 'warning');
      return;
    }

    const phuongXa = wardSelect.options[wardSelect.selectedIndex].text;
    const quanHuyen = districtSelect.options[districtSelect.selectedIndex].text;
    const tinhThanhPho = provinceSelect.options[provinceSelect.selectedIndex].text;

    const requestData = {
      chiTietDiaChi,
      phuongXa,
      quanHuyen,
      tinhThanhPho
    };

    try {
      const response = await fetch(`${BASE_URL}/customer/${phone}/add-address`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        const errorData = await response.json();
        showToast(`Lỗi: ${errorData.error || 'Không xác định'}`, 'error');
        throw new Error(errorData.error || 'Lỗi không xác định');
      }

      const data = await response.json();

      const tab = tabs.find(t => t.id === currentTabId);
      if (tab) {
        const fullAddress = `${chiTietDiaChi}, ${phuongXa}, ${quanHuyen}, ${tinhThanhPho}`;

        // Không thêm nếu đã có địa chỉ này
        if (!tab.addresses.includes(fullAddress)) {
          tab.addresses.push(fullAddress);
        }

        // Cập nhật địa chỉ đang chọn
        tab.selectedAddress = fullAddress;

        // Thêm vào dropdown
        const addressSelect = document.getElementById('addressSelect');
        if (addressSelect) {
          const option = document.createElement('option');
          option.value = fullAddress;
          option.text = fullAddress;
          addressSelect.appendChild(option);
          addressSelect.value = fullAddress;
          setupShippingForSelectedAddress();
        }

        // Lưu tabs vào localStorage
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
      }

      // Ẩn form và thông báo thành công
      document.getElementById('addAddressForm').classList.add('d-none');
      showToast('Đã thêm địa chỉ thành công!', 'success');
    } catch (error) {
      console.error('Lỗi khi thêm địa chỉ:', error);
      showToast('Lỗi khi thêm địa chỉ: ' + error.message, 'error');
    }
  }

  function showAddAddressForm() {
    const addAddressForm = document.getElementById('addAddressForm');
    if (addAddressForm) {
      addAddressForm.classList.remove('d-none');
      fetchProvinces();
    }
  }

  function toggleAddressSection() {
    const saleMethodSelect       = document.getElementById('saleMethod');
    const phoneInput             = document.getElementById('customerPhone');
    const addressSection         = document.getElementById('addressSection');
    const shippingFeeContainer   = document.getElementById('shippingFeeContainer');
    const shippingMethodContainer= document.getElementById('shippingMethodContainer'); // << cần có phần tử này ở HTML

    if (!saleMethodSelect || !phoneInput || !addressSection || !shippingFeeContainer) return;

    const saleMethod = saleMethodSelect.value;
    const phone = (phoneInput.value || '').trim();
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    // KHÁCH LẺ → luôn Tại quầy, ẩn giao hàng & GHN, ship = 0
    if (phone === '0999999999') {
      saleMethodSelect.value = 'Tại quầy';
      saleMethodSelect.setAttribute('disabled','true');
      addressSection.classList.add('d-none');
      shippingFeeContainer.classList.add('d-none');
      shippingMethodContainer?.classList.add('d-none');

      tab.saleMethod = 'Tại quầy';
      tab.shippingFee = 0;
      updateSummary(tab);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      if (tab.voucherId) applyVoucher(tab.voucherId);
      return;
    } else {
      saleMethodSelect.removeAttribute('disabled');
    }

    tab.saleMethod = saleMethod;

    if (saleMethod === 'Giao hàng' && phone) {
      addressSection.classList.remove('d-none');
      shippingFeeContainer.classList.remove('d-none');
      shippingMethodContainer?.classList.remove('d-none');

      // Load địa chỉ rồi quyết định tính GHN hay set ship=0
      fetchCustomerAddresses().then(() => {
        const addressSelect = document.getElementById('addressSelect');
        if (!addressSelect?.value) {
          // ❗ Chưa có địa chỉ → phí ship = 0
          zeroShippingBecauseNoAddress();
        } else {
          // Có địa chỉ → tính phí GHN
          setTimeout(() => setupShippingForSelectedAddress(), 0);
        }
      });
    } else {
      // Tại quầy hoặc thiếu SĐT → ẩn giao hàng & GHN, ship = 0
      addressSection.classList.add('d-none');
      shippingFeeContainer.classList.add('d-none');
      shippingMethodContainer?.classList.add('d-none');

      tab.shippingFee = 0;
      updateSummary(tab);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      if (tab.voucherId) applyVoucher(tab.voucherId);
    }

    fetchVouchers();
  }

  function toggleCashInput() {
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const cashInput = document.getElementById('cashInput');

    if (!paymentMethodSelect || !cashInput) return;

    const paymentMethod = paymentMethodSelect.value;
    const tab = tabs.find(t => t.id === currentTabId);

    if (tab) {
      tab.paymentMethod = paymentMethod;
      if (paymentMethod === '550E8400-E29B-41D4-A716-446655440017') {
        cashInput.classList.remove('d-none');
      } else {
        cashInput.classList.add('d-none');
      }

      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    }
  }

  // QR Scanner
  let html5QrCode = null;

  async function showQrScanner() {
    const qrScannerModal = document.getElementById('qrScannerModal');
    if (qrScannerModal) qrScannerModal.style.display = 'flex';

    const qrReader = document.getElementById('qr-reader');
    if (!qrReader) return;

    try {
      // Initialize html5-qrcode scanner
      html5QrCode = new Html5Qrcode("qr-reader");

      // Start scanning with back camera
      await html5QrCode.start(
              { facingMode: "environment" },
              {
                fps: 10, // Frames per second for scanning
                qrbox: { width: 250, height: 250 } // Scanning box size
              },
              (decodedText) => {
                // Success callback when QR code is decoded
                addProductByQr(decodedText);
                stopQrScanner();
              },
              (error) => {
                // Optional error callback (can be used for debugging)
                // console.warn('QR scan error:', error);
              }
      );
    } catch (error) {
      showToast('Lỗi khi mở camera. Vui lòng kiểm tra quyền truy cập.', 'error');
    }
  }

  function stopQrScanner() {
    if (html5QrCode) {
      html5QrCode
              .stop()
              .then(() => {
                html5QrCode.clear();
                html5QrCode = null;
              })
              .catch((error) => {
                console.error('Lỗi khi dừng quét QR:', error);
              });
    }
    const qrScannerModal = document.getElementById('qrScannerModal');
    if (qrScannerModal) qrScannerModal.style.display = 'none';
  }

  async function removeItem(index, productDetailId) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    try {
      const requestData = {
        productDetailId: String(productDetailId),
        shippingFee: String(tab.shippingFee || 0),
        tabId: String(currentTabId)
      };

      const response = await fetch(`${BASE_URL}/cart/remove`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        let errorMessage = "Lỗi khi xóa sản phẩm.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      await refreshCartFromServer(); // Ensure stock is updated
      showToast("Đã xóa sản phẩm!", "success");
    } catch (error) {
      showToast("Lỗi khi xóa sản phẩm: " + error.message, "error");
    }
  }

  async function fetchVouchers() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const subTotal = tab.subTotal || 0;
    let url = `${BASE_URL}/vouchers?subTotal=${subTotal}&tabId=${currentTabId}`;

    if (tab.customerPhone && tab.customerPhone !== '0999999999') {
      try {
        const customerRes = await fetch(`/acvstore/customers/by-phone/${tab.customerPhone}`);
        if (customerRes.ok) {
          const customerData = await customerRes.json();
          if (customerData.id) {
            tab.customerId = customerData.id;
            url += `&customerId=${tab.customerId}`; // cho API public voucher (nếu có)

            // 👉 Gọi tiếp API lấy voucher cá nhân
            const personalVoucherRes = await fetch(`/acvstore/customers/vouchers/${tab.customerPhone}`);
            if (personalVoucherRes.ok) {
              const personalVouchers = await personalVoucherRes.json();
              tab.personalVouchers = personalVouchers;
              console.log('📦 Phiếu cá nhân:', personalVouchers);
            }
          }
        }
      } catch (e) {
        console.error("Lỗi khi lấy customerId hoặc phiếu cá nhân:", e);
      }
    }

    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error("Lỗi khi lấy phiếu giảm giá công khai.");
      const data = await response.json();

      const voucherSelect = document.getElementById('voucherSelect');
      if (voucherSelect) {
        voucherSelect.innerHTML = '<option value="">🎫 Không sử dụng</option>';

        // Gộp cả hai loại voucher: cá nhân + công khai
        const allVouchers = [...(tab.personalVouchers || []), ...(data.vouchers || [])];
        allVouchers.forEach(voucher => {
          const option = document.createElement('option');
          option.value = voucher.id;
          option.text = `${voucher.ten} (Tối thiểu: ${voucher.giaTriGiamToiThieuFormatted || voucher.giaTriGiamToiThieu + ' VNĐ'})`;
          voucherSelect.appendChild(option);
        });

        voucherSelect.value = tab.voucherId || '';
      }
    } catch (error) {
      console.error('Lỗi khi xử lý phiếu giảm giá:', error);
    }
  }



  async function applyVoucher(voucherId) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const voucherSelect = document.getElementById('voucherSelect');
    const selectedVoucherId = voucherId || (voucherSelect ? voucherSelect.value : null);
    const shippingFee = tab.shippingFee || 0;

    if (!selectedVoucherId) {
      tab.voucherId = null;
      tab.discount = 0;
      tab.total = tab.subTotal;
      updateSummary(tab);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      return;
    }

    try {
      const response = await fetch(`${BASE_URL}/cart/apply-voucher?voucherId=${selectedVoucherId}&shippingFee=${shippingFee}&tabId=${currentTabId}`);
      if (!response.ok) {
        let errorMessage = "Lỗi khi áp dụng voucher.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      tab.voucherId = selectedVoucherId;
      updateCartFromResponse(data);
      showToast('Đã áp dụng phiếu giảm giá!', 'success');
    } catch (error) {
      console.error('Lỗi khi áp dụng voucher:', error);
      showToast('Lỗi khi áp dụng voucher: ' + error.message, 'error');
    }
  }

  function updateSummary(tab) {
    const subTotal = parseFloat(tab.subTotal) || 0;
    const discount = parseFloat(tab.discount) || 0;
    const shippingFee = parseFloat(tab.shippingFee) || 0;
    const total = subTotal - discount;
    const totalWithShipping = total + (tab.saleMethod === 'Giao hàng' ? shippingFee : 0); // Chỉ cộng phí vận chuyển khi chọn Giao hàng

    const cashAmountInput = document.getElementById('cashAmount');
    const cashAmount = parseFloat(cashAmountInput ? cashAmountInput.value.replace(/\./g, '') : 0) || 0;
    tab.cashAmount = cashAmount;

    const change = Math.max(0, cashAmount - totalWithShipping);

    const elements = {
      subTotal: document.getElementById('subTotal'),
      discount: document.getElementById('discount'),
      shippingFeeDisplay: document.getElementById('shippingFeeDisplay'),
      total: document.getElementById('total'),
      changeAmount: document.getElementById('changeAmount')
    };

    if (elements.subTotal) elements.subTotal.innerText = subTotal.toLocaleString('vi-VN') + ' VNĐ';
    if (elements.discount) elements.discount.innerText = discount.toLocaleString('vi-VN') + ' VNĐ';
    if (elements.shippingFeeDisplay) {
      elements.shippingFeeDisplay.innerText = (tab.saleMethod === 'Giao hàng' ? shippingFee : 0).toLocaleString('vi-VN') + ' VNĐ';
    }
    if (elements.total) elements.total.innerText = totalWithShipping.toLocaleString('vi-VN') + ' VNĐ';
    if (elements.changeAmount) elements.changeAmount.innerText = change.toLocaleString('vi-VN') + ' VNĐ';
  }

  async function createOrder() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    if (!tab.customerPhone) {
      showToast('Vui lòng nhập số điện thoại khách hàng.', 'warning');
      return;
    }

    if (tab.saleMethod === 'Giao hàng' && !tab.selectedAddress && tab.customerPhone !== '0999999999') {
      showToast('Vui lòng chọn địa chỉ giao hàng.', 'warning');
      return;
    }

    if (tab.cart.length === 0) {
      showToast('Giỏ hàng trống.', 'warning');
      return;
    }

    const cashAmountInput = document.getElementById('cashAmount');
    const orderData = {
      soDienThoaiKhachHang: tab.customerPhone,
      phiVanChuyen: tab.saleMethod === 'Giao hàng' ? tab.shippingFee : 0,
      phuongThucThanhToan: tab.paymentMethod,
      soTienKhachDua: tab.paymentMethod === '550E8400-E29B-41D4-A716-446655440018' ? 0 : (parseFloat(cashAmountInput?.value.replace(/\./g, '') || '0') || 0),
      phuongThucBanHang: tab.saleMethod,
      idPhieuGiamGia: tab.voucherId || null,
      danhSachSanPham: tab.cart,
      diaChiGiaoHang: tab.selectedAddress,
      tabId: String(currentTabId)
    };

    // Log để kiểm tra orderData
    console.log('orderData before saving to sessionStorage:', JSON.stringify(orderData));

    const totalAmount = (Number(tab.subTotal) || 0) - (Number(tab.discount) || 0) + (tab.saleMethod === 'Giao hàng' ? (Number(tab.shippingFee) || 0) : 0);

    const confirmResult = await Swal.fire({
      icon: 'question',
      title: 'Xác nhận thanh toán',
      html: `
            <p><strong>Tổng tiền:</strong> ${totalAmount.toLocaleString('vi-VN')} VNĐ</p>
            <p><strong>Phương thức thanh toán:</strong> ${
              tab.paymentMethod === '550E8400-E29B-41D4-A716-446655440018'
                      ? 'Chuyển khoản ngân hàng'
                      : 'Thanh toán tiền mặt'
      }</p>
            <p>Bạn có chắc chắn muốn tiếp tục thanh toán?</p>
        `,
      showCancelButton: true,
      confirmButtonText: 'Xác nhận',
      cancelButtonText: 'Hủy',
      confirmButtonColor: '#f97316',
      cancelButtonColor: '#d33',
    });

    if (!confirmResult.isConfirmed) {
      return;
    }

    try {
      if (tab.paymentMethod === '550E8400-E29B-41D4-A716-446655440018') {
        if (totalAmount <= 0) {
          showToast('Tổng tiền phải lớn hơn 0.', 'warning');
          return;
        }

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/create-payment-link';
        form.style.display = 'none';

        const productNameInput = document.createElement('input');
        productNameInput.type = 'hidden';
        productNameInput.name = 'productName';
        productNameInput.value = tab.cart.map(item => item.tenSanPham).join(', ');
        form.appendChild(productNameInput);

        const priceInput = document.createElement('input');
        priceInput.type = 'hidden';
        priceInput.name = 'price';
        priceInput.value = totalAmount.toString();
        form.appendChild(priceInput);

        const descriptionInput = document.createElement('input');
        descriptionInput.type = 'hidden';
        descriptionInput.name = 'description';
        descriptionInput.value = `Thanh toán đơn hàng ${currentTabId}`;
        form.appendChild(descriptionInput);

        sessionStorage.setItem('pendingOrder', JSON.stringify({ orderData, tabId: currentTabId }));
        document.body.appendChild(form);
        form.submit();
      } else {
        const response = await fetch(`${BASE_URL}/create-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(orderData)
        });

        if (!response.ok) {
          let errorMessage = "Lỗi khi tạo đơn hàng.";
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorData.message || errorMessage;
          } catch (e) {
            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();
        showToast(`Hóa đơn ${data.maDonHang} đã được tạo và in hóa đơn thành công!`, 'success');

        if (data.pdfData) {
          try {
            const byteCharacters = atob(data.pdfData);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/pdf' });

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HoaDon_${data.maDonHang}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          } catch (error) {
            console.error('Lỗi khi xử lý file PDF:', error);
            showToast('Lỗi khi in hóa đơn PDF.', 'error');
          }
        }

        tabs = tabs.filter(t => t.id !== currentTabId);
        if (tabs.length === 0) {
          await addNewTab();
        } else {
          currentTabId = tabs[tabs.length - 1].id;
          const lastTab = tabs.find(t => t.id === currentTabId);
          if (lastTab) {
            lastTab.paymentMethod = '550E8400-E29B-41D4-A716-446655440017';
          }
        }

        localStorage.setItem('orderTabs', JSON.stringify(tabs));
        localStorage.setItem('currentTabId', currentTabId);
        renderTabs();
        loadTabContent(currentTabId);
      }
    } catch (error) {
      console.error('Lỗi khi tạo đơn hàng:', error);
      showToast('Lỗi khi tạo đơn hàng: ' + error.message, 'error');
    }
  }

  async function fetchCustomers(keyword = '') {
    try {
      const response = await fetch(`${BASE_URL}/customers?keyword=${encodeURIComponent(keyword)}`);
      if (!response.ok) {
        let errorMessage = "Lỗi khi tải danh sách khách hàng.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      const customerList = document.getElementById('customerList');
      if (customerList) {
        customerList.innerHTML = '';

        data.customers
                .filter(customer => customer.soDienThoai !== '0999999999')
                .forEach(customer => {
                  const div = document.createElement('div');
                  div.className = 'p-3 border rounded cursor-pointer mb-2';
                  div.style.cursor = 'pointer';
                  div.innerHTML = `
                        <div class="d-flex align-items-center gap-3">
                            <i class="fas fa-user-circle fs-3 text-primary"></i>
                            <div>
                                <div class="fw-semibold">${customer.hoTen}</div>
                                <div class="small text-muted">${customer.soDienThoai} • ${customer.email}</div>
                            </div>
                        </div>
                    `;
                  div.onmouseover = () => div.classList.add('bg-light');
                  div.onmouseout = () => div.classList.remove('bg-light');
                  div.onclick = () => selectCustomerFromModal(customer.soDienThoai, customer.hoTen, customer.email);
                  customerList.appendChild(div);
                });
      }
    } catch (error) {
      showToast('Lỗi khi tải danh sách khách hàng: ' + error.message, 'error');
    }
  }

  function showCustomerModal() {
    const customerModal = document.getElementById('customerModal');
    if (customerModal) customerModal.style.display = 'flex';
    fetchCustomers();
  }

  function selectCustomerFromModal(phone, name, email) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    tab.customerPhone = phone;
    tab.customerName  = name;
    tab.customerEmail = email;

    const phoneEl   = document.getElementById('customerPhone');
    const nameEl    = document.getElementById('customerName');
    const emailEl   = document.getElementById('customerEmail');
    const modalEl   = document.getElementById('customerModal');

    if (phoneEl) {
      if (phone === '0999999999') { // Khách lẻ
        phoneEl.value = '';
        phoneEl.placeholder = 'Khách lẻ (không thu thập SĐT)';
      } else {
        phoneEl.value = phone;
        phoneEl.placeholder = 'Nhập số điện thoại khách hàng';
      }
    }

    if (nameEl)  nameEl.value  = (phone === '0999999999') ? 'Khách lẻ' : (name || '');
    if (emailEl) emailEl.value = (phone === '0999999999') ? ''         : (email || '');

    if (modalEl) modalEl.style.display = 'none';

    toggleAddressSection(); // sẽ khoá giao hàng nếu là Khách lẻ
    fetchCustomerAddresses();
    localStorage.setItem('orderTabs', JSON.stringify(tabs));
  }

  document.getElementById('productSearch').addEventListener('input', function() {
    const keyword = this.value.trim();
    fetchProducts(keyword);
  });

  async function fetchProducts(keyword = '') {
    const productSpinner = document.getElementById('productSpinner');
    if (productSpinner) productSpinner.style.display = 'block';

    try {
      const response = await fetch(`${BASE_URL}/products?keyword=${encodeURIComponent(keyword)}`);
      if (!response.ok) {
        throw new Error("Lỗi khi tải danh sách sản phẩm.");
      }

      const data = await response.json();
      const productList = document.getElementById('productList');
      if (productList) {
        productList.innerHTML = '';

        // Nhóm sản phẩm theo tên
        const productsByName = data.products.reduce((acc, product) => {
          if (!acc[product.tenSanPham]) {
            acc[product.tenSanPham] = [];
          }
          acc[product.tenSanPham].push(product);
          return acc;
        }, {});

        Object.keys(productsByName).forEach(productName => {
          const div = document.createElement('div');
          div.className = 'p-3 border rounded cursor-pointer mb-2';
          div.style.cursor = 'pointer';
          div.innerHTML = `
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-box fs-3 text-success"></i>
            <div>
              <div class="fw-semibold">${productName}</div>
              <div class="small text-muted">Nhấn để chọn biến thể</div>
            </div>
          </div>
        `;
          div.onmouseover = () => div.classList.add('bg-light');
          div.onmouseout = () => div.classList.remove('bg-light');
          div.onclick = () => showVariantModal(productsByName[productName][0].idChiTietSanPham);
          productList.appendChild(div);
        });
      }
    } catch (error) {
      showToast('Lỗi khi tải danh sách sản phẩm: ' + error.message, 'error');
    } finally {
      if (productSpinner) productSpinner.style.display = 'none';
    }
  }



  function showProductModal() {
    const productModal = document.getElementById('productModal');
    if (productModal) productModal.style.display = 'flex';
    fetchProducts();
  }

  // Trong hàm showVariantModal, thêm sự kiện sau khi render xong
  async function showVariantModal(productDetailId) {
    fetch(`${BASE_URL}/product-detail/${productDetailId}`)
            .then(async res => {
              if (!res.ok) {
                let errorMessage = "Lỗi khi lấy thông tin sản phẩm.";
                try {
                  const errorData = await res.json();
                  errorMessage = errorData.error || errorData.message || errorMessage;
                } catch (e) {
                  errorMessage = `HTTP ${res.status}: ${res.statusText}`;
                }
                throw new Error(errorMessage);
              }

              const data = await res.json();
              currentProductId = data.productId;

              const productModal = document.getElementById('productModal');
              const variantModal = document.getElementById('variantModal');
              const variantModalTitle = document.getElementById('variantModalTitle');
              const variantDetails = document.getElementById('variantDetails');

              if (productModal) productModal.style.display = 'none';
              if (variantModal) variantModal.style.display = 'flex';
              if (variantModalTitle) variantModalTitle.innerText = `Chọn biến thể: ${data.tenSanPham}`;

              if (variantDetails) {
                variantDetails.innerHTML = `
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="text-center" id="variantImage">
                <img src="${data.hinhAnh || 'https://via.placeholder.com/150x150?text=No+Image'}"
                     alt="Hình ảnh" class="rounded shadow-lg mx-auto mb-3"
                     style="width: 150px; height: 150px; object-fit: cover;"
                     onerror="this.src='https://via.placeholder.com/150x150?text=No+Image'">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3 d-flex justify-content-between">
                <span class="fw-medium">Giá:</span>
                <span id="variantPrice" class="fw-bold text-primary"></span>
              </div>
              <div class="mb-3 d-flex justify-content-between">
                <span class="fw-medium">Tồn kho:</span>
                <span id="variantStock" class="fw-bold text-success"></span>
              </div>
              <div class="floating-label">
                <label for="variantQuantity">Số lượng</label>
                <input type="number" id="variantQuantity" min="1" value="1" class="form-control">
              </div>
            </div>
          </div>
        `;
              }

              // Đặt lại combobox về trạng thái mặc định
              const colorSelect = document.getElementById('colorSelect');
              const sizeSelect = document.getElementById('sizeSelect');
              if (colorSelect) colorSelect.value = '';
              if (sizeSelect) sizeSelect.value = '';
              if (variantDetails) variantDetails.classList.add('d-none');

              await fetchProductVariants();

              // Thêm sự kiện sau khi modal đã render
              if (colorSelect && sizeSelect) {
                colorSelect.onchange = () => {
                  filterSizesByColor(); // <== thêm dòng này
                  fetchVariants();
                };
                sizeSelect.onchange = fetchVariants;
              }
            })
            .catch(error => {
              showToast('Lỗi khi lấy thông tin sản phẩm: ' + error.message, 'error');
            });
  }

  function filterSizesByColor() {
    const selectedColorId = document.getElementById("colorSelect").value;
    const sizeSelect = document.getElementById("sizeSelect");

    if (!selectedColorId || !window.productVariants || !sizeSelect) return;

    const filteredVariants = window.productVariants.filter(v => v.colorId === selectedColorId);
    const uniqueSizes = [...new Set(filteredVariants.map(v => JSON.stringify({ id: v.sizeId, ten: v.kichCo })))]
            .map(str => JSON.parse(str));

    sizeSelect.innerHTML = '<option value="">Chọn kích cỡ</option>';
    uniqueSizes.forEach(size => {
      const option = document.createElement("option");
      option.value = size.id;
      option.text = size.ten;
      sizeSelect.appendChild(option);
    });
  }

  async function fetchProductVariants() {
    const variantSpinner = document.getElementById('variantSpinner');
    if (variantSpinner) variantSpinner.style.display = 'block';

    try {
      const response = await fetch(`${BASE_URL}/product/${currentProductId}/variants`);
      if (!response.ok) {
        let errorMessage = "Lỗi khi lấy biến thể sản phẩm.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      window.productVariants = data.variants || [];

      // Lấy danh sách màu sắc và kích cỡ duy nhất từ các biến thể
      const uniqueColors = [...new Set(window.productVariants.map(v => JSON.stringify({ id: v.colorId, tenMau: v.mauSac })))].map(str => JSON.parse(str));
      const uniqueSizes = [...new Set(window.productVariants.map(v => JSON.stringify({ id: v.sizeId, ten: v.kichCo })))].map(str => JSON.parse(str));

      // Khởi tạo combobox màu sắc
      const colorSelect = document.getElementById('colorSelect');
      if (colorSelect) {
        colorSelect.innerHTML = '<option value="">Chọn màu sắc</option>';
        uniqueColors.forEach(color => {
          const option = document.createElement('option');
          option.value = color.id;
          option.text = color.tenMau;
          colorSelect.appendChild(option);
        });
      }

      // Khởi tạo combobox kích cỡ
      const sizeSelect = document.getElementById('sizeSelect');
      if (sizeSelect) {
        sizeSelect.innerHTML = '<option value="">Chọn kích cỡ</option>';
        uniqueSizes.forEach(size => {
          const option = document.createElement('option');
          option.value = size.id;
          option.text = size.ten;
          sizeSelect.appendChild(option);
        });
      }

      const variantDetails = document.getElementById('variantDetails');
      if (variantDetails) variantDetails.classList.add('d-none');
    } catch (error) {
      showToast('Lỗi khi lấy biến thể sản phẩm: ' + error.message, 'error');
    } finally {
      if (variantSpinner) variantSpinner.style.display = 'none';
    }
  }

  async function fetchVariants() {
    const colorSelect = document.getElementById("colorSelect");
    const sizeSelect = document.getElementById("sizeSelect");
    const variantDetails = document.getElementById("variantDetails");
    const variantSpinner = document.getElementById("variantSpinner");
    const variantPrice = document.getElementById("variantPrice");
    const variantStock = document.getElementById("variantStock");
    const variantImage = document.getElementById("variantImage");
    const variantQuantity = document.getElementById("variantQuantity");

    if (!colorSelect || !sizeSelect || !variantDetails || !variantSpinner || !variantPrice || !variantStock || !variantImage || !variantQuantity) {
      showToast("Một số phần tử không được tìm thấy trong DOM.", "error");
      console.error("Missing elements:", { colorSelect, sizeSelect, variantDetails, variantSpinner, variantPrice, variantStock, variantImage, variantQuantity });
      return;
    }

    if (!colorSelect.value || !sizeSelect.value) {
      variantDetails.classList.add("d-none");
      return;
    }

    variantSpinner.style.display = "block";
    variantDetails.classList.add("d-none");

    try {
      const response = await fetch(
              `${BASE_URL}/product/variant?productId=${currentProductId}&colorId=${colorSelect.value}&sizeId=${sizeSelect.value}`
      );
      const data = await response.json();

      if (data.error) {
        showToast(data.error, "error");
        return;
      }

      const price = parseFloat(data.price);
      const discountedPrice = parseFloat(data.discountedPrice);
      const phanTramGiam = parseFloat(data.phanTramGiam);
      const stock = parseInt(data.availableStock);

      if (variantPrice) {
        variantPrice.innerHTML = phanTramGiam > 0
                ? `<span class="text-decoration-line-through">${price.toLocaleString("vi-VN")} VNĐ</span><br>
           <span class="text-primary">${discountedPrice.toLocaleString("vi-VN")} VNĐ</span><br>
           <span class="text-success">Giảm ${phanTramGiam}%</span>`
                : `<span class="text-primary">${price.toLocaleString("vi-VN")} VNĐ</span>`;
      }
      if (variantStock) variantStock.textContent = stock;
      if (variantQuantity) variantQuantity.max = stock;
      if (variantImage) {
        const imgElement = variantImage.querySelector("img");
        if (imgElement) {
          imgElement.src = data.hinhAnh || "https://via.placeholder.com/150x150?text=No+Image";
          imgElement.onerror = () => (imgElement.src = "https://via.placeholder.com/150x150?text=No+Image");
        } else {
          variantImage.innerHTML = `
          <img src="${data.hinhAnh || "https://via.placeholder.com/150x150?text=No+Image"}"
               alt="Hình ảnh"
               class="rounded shadow-sm"
               style="width: 100%; max-width: 150px; height: auto;"
               onerror="this.src='https://via.placeholder.com/150x150?text=No+Image'">
        `;
        }
      }
      if (variantDetails) {
        variantDetails.dataset.productDetailId = data.productDetailId;
        variantDetails.classList.remove("d-none");
      }
    } catch (error) {
      showToast("Lỗi khi lấy thông tin biến thể: " + error.message, "error");
    } finally {
      if (variantSpinner) variantSpinner.style.display = "none";
    }
  }

  function formatCashInput(value) {
    return value.replace(/\D/g, '') // chỉ lấy số
            .replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // thêm dấu chấm
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    // GHN: preload provinces
    ghnLoadProvinces().catch(()=>{});

// Khi đổi dịch vụ → tính lại phí ngay
    const shippingMethodSelect = document.getElementById('shippingMethod');
    if (shippingMethodSelect) {
      shippingMethodSelect.addEventListener('change', () => {
        setupShippingForSelectedAddress({ recalcOnly: true });
      });
    }

// Khi đổi địa chỉ → tính lại GHN
    const addressSelectEl = document.getElementById('addressSelect');
    if (addressSelectEl) {
      addressSelectEl.addEventListener('change', () => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (!tab) return;

        tab.selectedAddress = addressSelectEl.value || '';
        localStorage.setItem('orderTabs', JSON.stringify(tabs));

        if (!tab.selectedAddress) {
          zeroShippingBecauseNoAddress();
          return;
        }
        setupShippingForSelectedAddress();
      });
    }

    const cashInput = document.getElementById('cashAmount');
    if (cashInput) {
      cashInput.addEventListener('input', (e) => {
        const cursorPosition = e.target.selectionStart;
        const rawValue = e.target.value.replace(/\./g, '');
        const formattedValue = formatCashInput(rawValue);
        e.target.value = formattedValue;
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.cashAmount = parseFloat(rawValue) || 0;
          updateSummary(tab);
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
      });
    }

    const customerPhone = document.getElementById('customerPhone');
    if (customerPhone) {
      customerPhone.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          fetchCustomerAddresses();
        }
      });
    }

    const addressSelect = document.getElementById('addressSelect');
    if (addressSelect) {
      addressSelect.addEventListener('change', () => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.selectedAddress = addressSelect.value;
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
      });
    }

    const shippingFee = document.getElementById('shippingFee');
    if (shippingFee) {
      shippingFee.value = formatCurrency(shippingFee.value);
      shippingFee.addEventListener('input', () => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (!tab) return;
        const raw = unformatCurrency(shippingFee.value);
        shippingFee.value = formatCurrency(raw);
        tab.shippingFee = raw;
        updateSummary(tab);
        localStorage.setItem('orderTabs', JSON.stringify(tabs));
        if (tab.voucherId) {
          applyVoucher(tab.voucherId);
        }
      });
    }

    const addTabBtn = document.getElementById('addTabBtn');
    if (addTabBtn) {
      addTabBtn.addEventListener('click', addNewTab);
    }

    const voucherSelect = document.getElementById('voucherSelect');
    if (voucherSelect) {
      voucherSelect.addEventListener('change', (e) => {
        applyVoucher(e.target.value || null);
      });
    }

    const customerSearch = document.getElementById('customerSearch');
    if (customerSearch) {
      customerSearch.addEventListener('input', () => {
        const keyword = customerSearch.value.trim();
        fetchCustomers(keyword);
      });
    }

    const paymentMethodSelect = document.getElementById('paymentMethod');
    if (paymentMethodSelect) {
      paymentMethodSelect.addEventListener('change', (e) => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.paymentMethod = e.target.value;
          toggleCashInput();
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
      });
    }

    // Khởi tạo khi trang load
    initTabs();
  });
</script>
<script th:src="@{/js/notification.js}"></script>

</body>
</html>