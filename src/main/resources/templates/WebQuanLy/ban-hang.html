<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACV Store - B√°n H√†ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/sidebar.js}" defer></script>
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --secondary-color: #64748b;
      --success-color: #10b981;
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
    }

    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
      z-index: 9999;
      opacity: 0;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .tab {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: -1;
    }

    .tab.active::before {
      opacity: 1;
    }

    .tab.active {
      color: white;
      font-weight: 600;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }

    .tab:hover:not(.active) {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      color: var(--primary-color);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .input-field {
      transition: all 0.3s ease;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: white;
    }

    .input-field:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      outline: none;
      transform: translateY(-1px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary-color), #475569);
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(100, 116, 139, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger-color), #dc2626);
      transition: all 0.3s ease;
      border-radius: 12px;
      font-weight: 600;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
    }

    .spinner {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .cart-table {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .cart-table th {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 1.5rem 1rem;
      font-weight: 700;
      color: #334155;
      border: none;
    }

    .cart-table td {
      padding: 1.5rem 1rem;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
    }

    .cart-table tr:hover {
      background: linear-gradient(135deg, #fefefe, #f8fafc);
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    .cart-table img {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f8fafc;
      padding: 0.5rem;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .quantity-controls.loading {
      opacity: 0.5;
      pointer-events: none;
    }

    .quantity-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .quantity-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .quantity-btn:not(:disabled):hover {
      transform: scale(1.1);
    }

    .stock-warning {
      color: #ef4444;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .summary-card {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 20px;
      padding: 2rem;
      border: 2px solid #e2e8f0;
      position: relative;
      overflow: hidden;
    }

    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--success-color), var(--warning-color));
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e2e8f0;
    }

    .section-icon {
      width: 24px;
      height: 24px;
      color: var(--primary-color);
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .cart-table th,
      .cart-table td {
        font-size: 0.875rem;
        padding: 1rem 0.5rem;
      }

      .cart-table img {
        max-width: 40px;
        max-height: 40px;
      }

      .action-buttons {
        grid-template-columns: 1fr;
      }

      .quantity-controls {
        flex-direction: column;
        gap: 0.25rem;
      }
    }

    .customer-info-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      align-items: end;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .floating-label {
      position: relative;
    }

    .floating-label input,
    .floating-label select {
      padding-top: 1.5rem;
    }

    .floating-label label {
      position: absolute;
      left: 1rem;
      top: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--primary-color);
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 font-sans min-h-screen">
<div class="d-flex">
  <!-- Include sidebar fragment -->
  <div th:replace="~{fragments/sidebar :: sidebar}"></div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 justify-content-between fixed-top">
  </nav>

  <!-- N·ªôi dung ch√≠nh b√™n ph·∫£i -->
  <div class="content" id="mainContent">
    <!-- Header Section -->
    <div class="text-center mb-8">
      <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-4">
        ACV Store
      </h1>
      <p class="text-xl text-gray-600 font-medium">H·ªá th·ªëng b√°n h√†ng th√¥ng minh</p>
    </div>

    <!-- Tabs Section -->
    <div class="glass-card rounded-2xl shadow-xl p-6 mb-8">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div id="orderTabs" class="flex space-x-3 flex-wrap"></div>
        <button id="addTabBtn" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl btn-primary disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
          <i class="fas fa-plus"></i>
          Th√™m ƒê∆°n H√†ng
        </button>
      </div>
    </div>

    <div class="glass-card rounded-2xl shadow-xl p-8">
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button onclick="showQrScanner()" class="px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl btn-success flex items-center justify-center gap-3">
          <i class="fas fa-qrcode text-xl"></i>
          <span class="font-semibold">Qu√©t QR s·∫£n ph·∫©m</span>
        </button>
        <button onclick="showProductModal()" class="px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl btn-primary flex items-center justify-center gap-3">
          <i class="fas fa-box text-xl"></i>
          <span class="font-semibold">Ch·ªçn s·∫£n ph·∫©m</span>
        </button>
      </div>

      <!-- Cart Table -->
      <div class="mb-8">
        <div class="section-header">
          <i class="fas fa-shopping-cart section-icon"></i>
          <h3 class="text-xl font-bold text-gray-800">Gi·ªè h√†ng</h3>
        </div>

        <div class="overflow-x-auto">
          <table class="cart-table w-full">
            <thead>
            <tr>
              <th class="text-left">H√¨nh ·∫£nh</th>
              <th class="text-left">T√™n s·∫£n ph·∫©m</th>
              <th class="text-left">M√†u s·∫Øc</th>
              <th class="text-left">K√≠ch c·ª°</th>
              <th class="text-left">Gi√°</th>
              <th class="text-left">S·ªë l∆∞·ª£ng</th>
              <th class="text-left">Th√†nh ti·ªÅn</th>
              <th class="text-left">H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody id="cartItems"></tbody>
          </table>
        </div>
      </div>

      <!-- Customer Information -->
      <div class="mb-8">
        <div class="section-header">
          <i class="fas fa-user section-icon"></i>
          <h3 class="text-xl font-bold text-gray-800">Th√¥ng tin kh√°ch h√†ng</h3>
        </div>

        <div class="customer-info-grid mb-4">
          <div class="floating-label">
            <label for="customerPhone">S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="text" id="customerPhone" class="input-field w-full p-4 border rounded-xl" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng">
          </div>
          <button onclick="showCustomerModal()" class="px-6 py-4 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-xl btn-primary flex items-center gap-2">
            <i class="fas fa-users"></i>
            Ch·ªçn kh√°ch h√†ng
          </button>
        </div>

        <div class="form-grid">
          <div class="floating-label">
            <label for="customerName">T√™n kh√°ch h√†ng</label>
            <input type="text" id="customerName" class="input-field w-full p-4 border rounded-xl" placeholder="T√™n kh√°ch h√†ng" disabled>
          </div>
          <div class="floating-label">
            <label for="customerEmail">Email</label>
            <input type="email" id="customerEmail" class="input-field w-full p-4 border rounded-xl" placeholder="Email kh√°ch h√†ng" disabled>
          </div>
        </div>
      </div>

      <!-- Address Selection -->
      <div id="addressSection" class="mb-8 hidden">
        <div class="section-header">
          <i class="fas fa-map-marker-alt section-icon"></i>
          <h3 class="text-xl font-bold text-gray-800">ƒê·ªãa ch·ªâ giao h√†ng</h3>
        </div>

        <div class="space-y-4">
          <div class="floating-label">
            <label for="addressSelect">Ch·ªçn ƒë·ªãa ch·ªâ</label>
            <select id="addressSelect" class="input-field w-full p-4 border rounded-xl">
              <option value="">Ch·ªçn ƒë·ªãa ch·ªâ</option>
            </select>
          </div>

          <button onclick="showAddAddressForm()" class="px-4 py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl btn-secondary flex items-center gap-2">
            <i class="fas fa-plus"></i>
            Th√™m ƒë·ªãa ch·ªâ m·ªõi
          </button>

          <div id="addAddressForm" class="hidden bg-gray-50 p-6 rounded-xl border-2 border-dashed border-gray-300">
            <h4 class="font-semibold text-gray-800 mb-4">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h4>
            <div class="form-grid">
              <div class="floating-label">
                <label for="addressLine">ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label>
                <input type="text" id="addressLine" class="input-field w-full p-4 border rounded-xl" placeholder="S·ªë nh√†, ƒë∆∞·ªùng,...">
              </div>
              <div class="floating-label">
                <label for="ward">Ph∆∞·ªùng/X√£</label>
                <input type="text" id="ward" class="input-field w-full p-4 border rounded-xl" placeholder="Nh·∫≠p ph∆∞·ªùng/x√£">
              </div>
              <div class="floating-label">
                <label for="district">Qu·∫≠n/Huy·ªán</label>
                <input type="text" id="district" class="input-field w-full p-4 border rounded-xl" placeholder="Nh·∫≠p qu·∫≠n/huy·ªán">
              </div>
              <div class="floating-label">
                <label for="city">T·ªânh/Th√†nh ph·ªë</label>
                <input type="text" id="city" class="input-field w-full p-4 border rounded-xl" placeholder="Nh·∫≠p t·ªânh/th√†nh ph·ªë">
              </div>
            </div>
            <div class="flex gap-3 mt-6">
              <button onclick="addNewAddress()" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl btn-success flex items-center gap-2">
                <i class="fas fa-save"></i>
                L∆∞u ƒë·ªãa ch·ªâ
              </button>
              <button onclick="document.getElementById('addAddressForm').style.display='none'" class="px-6 py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl btn-secondary">
                H·ªßy
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Configuration -->
      <div class="mb-8">
        <div class="section-header">
          <i class="fas fa-cog section-icon"></i>
          <h3 class="text-xl font-bold text-gray-800">C·∫•u h√¨nh ƒë∆°n h√†ng</h3>
        </div>

        <div class="form-grid">
          <div class="floating-label">
            <label for="saleMethod">Ph∆∞∆°ng th·ª©c b√°n h√†ng</label>
            <select id="saleMethod" onchange="toggleAddressSection()" class="input-field w-full p-4 border rounded-xl">
              <option value="T·∫°i qu·∫ßy">üè™ T·∫°i qu·∫ßy</option>
              <option value="Giao h√†ng">üöö Giao h√†ng</option>
            </select>
          </div>

          <div class="floating-label">
            <label for="shippingFee">Ph√≠ v·∫≠n chuy·ªÉn</label>
            <input type="number" id="shippingFee" value="0" class="input-field w-full p-4 border rounded-xl">
          </div>

          <div class="floating-label">
            <label for="voucherSelect">Phi·∫øu gi·∫£m gi√°</label>
            <select id="voucherSelect" onchange="applyVoucher()" class="input-field w-full p-4 border rounded-xl">
              <option value="">üé´ Kh√¥ng s·ª≠ d·ª•ng</option>
            </select>
          </div>

          <div class="floating-label">
            <label for="paymentMethod">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <select id="paymentMethod" onchange="toggleCashInput()" class="input-field w-full p-4 border rounded-xl">
              <option value="550E8400-E29B-41D4-A716-446655440017">üíµ Ti·ªÅn m·∫∑t</option>
              <option value="550E8400-E29B-41D4-A716-446655440018">üè¶ Chuy·ªÉn kho·∫£n</option>
            </select>
          </div>

          <div id="cashInput" class="hidden floating-label">
            <label for="cashAmount">S·ªë ti·ªÅn kh√°ch ƒë∆∞a</label>
            <input type="number" id="cashAmount" value="0" class="input-field w-full p-4 border rounded-xl">
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="summary-card mb-8">
        <div class="section-header">
          <i class="fas fa-calculator section-icon"></i>
          <h3 class="text-xl font-bold text-gray-800">T·ªïng k·∫øt ƒë∆°n h√†ng</h3>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div class="flex justify-between items-center py-2 border-b border-gray-200">
              <span class="font-medium text-gray-600">T·ªïng ti·ªÅn h√†ng:</span>
              <span id="subTotal" class="font-bold text-lg">0 VNƒê</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-200">
              <span class="font-medium text-gray-600">Ph√≠ v·∫≠n chuy·ªÉn:</span>
              <span id="shippingFeeDisplay" class="font-bold text-lg">0 VNƒê</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-200">
              <span class="font-medium text-gray-600">Gi·∫£m gi√°:</span>
              <span id="discount" class="font-bold text-lg text-green-600">0 VNƒê</span>
            </div>
          </div>

          <div class="space-y-4">
            <div class="flex justify-between items-center py-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl px-4">
              <span class="font-bold text-xl text-gray-800">T·ªïng ti·ªÅn:</span>
              <span id="total" class="font-bold text-2xl text-blue-600">0 VNƒê</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-200">
              <span class="font-medium text-gray-600">Ti·ªÅn tr·∫£ l·∫°i:</span>
              <span id="changeAmount" class="font-bold text-lg text-green-600">0 VNƒê</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Create Order Button -->
      <button onclick="createOrder()" class="w-full px-8 py-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl btn-success text-xl font-bold flex items-center justify-center gap-3 shadow-2xl">
        <i class="fas fa-check-circle text-2xl"></i>
        T·∫°o ƒë∆°n h√†ng
      </button>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="modal">
      <div class="modal-content">
        <div class="flex items-center gap-3 mb-6">
          <i class="fas fa-qrcode text-2xl text-blue-600"></i>
          <h3 class="text-2xl font-bold text-gray-800">Qu√©t QR S·∫£n Ph·∫©m</h3>
        </div>
        <video id="video" width="100%" height="300" class="border-2 border-gray-300 rounded-xl mb-4"></video>
        <button onclick="stopQrScanner()" class="w-full px-6 py-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl btn-danger flex items-center justify-center gap-2">
          <i class="fas fa-stop"></i>
          D·ª´ng qu√©t
        </button>
      </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
      <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center gap-3">
            <i class="fas fa-users text-2xl text-blue-600"></i>
            <h3 class="text-2xl font-bold text-gray-800">Danh s√°ch kh√°ch h√†ng</h3>
          </div>
          <button onclick="document.getElementById('customerModal').style.display='none'" class="text-gray-500 hover:text-gray-700 text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Kh√°ch l·∫ª -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <i class="fas fa-user text-blue-500"></i>
            Kh√°ch l·∫ª
          </h4>
          <div id="retailCustomer" class="p-4 border-2 border-dashed border-gray-300 cursor-pointer hover:bg-blue-50 hover:border-blue-300 rounded-xl transition-all duration-200" onclick="selectCustomerFromModal('0999999999', 'Kh√°ch l·∫ª', '')">
            <div class="flex items-center gap-3">
              <i class="fas fa-user-circle text-2xl text-gray-400"></i>
              <span class="font-medium">Kh√°ch l·∫ª</span>
            </div>
          </div>
        </div>

        <!-- Kh√°ch h√†ng kh√°c -->
        <div>
          <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <i class="fas fa-address-book text-green-500"></i>
            Kh√°ch h√†ng kh√°c
          </h4>
          <div id="customerList" class="space-y-2 max-h-60 overflow-y-auto"></div>
        </div>

        <div id="customerSpinner" class="spinner mt-6"></div>
      </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <div class="flex items-center gap-3 mb-6">
          <i class="fas fa-box text-2xl text-blue-600"></i>
          <h3 class="text-2xl font-bold text-gray-800">Danh s√°ch s·∫£n ph·∫©m</h3>
        </div>
        <div id="productList" class="space-y-2 max-h-96 overflow-y-auto"></div>
        <div id="productSpinner" class="spinner mt-6"></div>
        <button onclick="document.getElementById('productModal').style.display='none'" class="mt-6 w-full px-6 py-4 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl btn-secondary">
          ƒê√≥ng
        </button>
      </div>
    </div>

    <!-- Product Variant Modal -->
    <div id="variantModal" class="modal">
      <div class="modal-content">
        <div class="flex items-center gap-3 mb-6">
          <i class="fas fa-palette text-2xl text-blue-600"></i>
          <h3 class="text-2xl font-bold text-gray-800" id="variantModalTitle">Ch·ªçn bi·∫øn th·ªÉ s·∫£n ph·∫©m</h3>
        </div>

        <div class="form-grid mb-6">
          <div class="floating-label">
            <label for="colorSelect">M√†u s·∫Øc</label>
            <select id="colorSelect" class="input-field w-full p-4 border rounded-xl" onchange="fetchVariants()">
              <option value="">Ch·ªçn m√†u s·∫Øc</option>
            </select>
          </div>

          <div class="floating-label">
            <label for="sizeSelect">K√≠ch c·ª°</label>
            <select id="sizeSelect" class="input-field w-full p-4 border rounded-xl" onchange="fetchVariants()">
              <option value="">Ch·ªçn k√≠ch c·ª°</option>
            </select>
          </div>
        </div>

        <div id="variantDetails" class="hidden bg-gray-50 p-6 rounded-xl mb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
            <div id="variantImage"></div>
            <div class="space-y-3">
              <p class="flex justify-between"><span class="font-medium">Gi√°:</span> <span id="variantPrice" class="font-bold text-blue-600"></span></p>
              <p class="flex justify-between"><span class="font-medium">T·ªìn kho:</span> <span id="variantStock" class="font-bold text-green-600"></span></p>
              <div class="floating-label">
                <label for="variantQuantity">S·ªë l∆∞·ª£ng</label>
                <input type="number" id="variantQuantity" min="1" value="1"
                       class="input-field w-full p-4 border rounded-xl">
              </div>
            </div>
          </div>
        </div>

        <div id="variantSpinner" class="spinner mb-6"></div>

        <div class="flex gap-3">
          <button onclick="addVariantToCart()" class="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl btn-success flex items-center justify-center gap-2">
            <i class="fas fa-cart-plus"></i>
            Th√™m v√†o gi·ªè h√†ng
          </button>
          <button onclick="document.getElementById('variantModal').style.display='none'" class="px-6 py-4 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl btn-secondary">
            H·ªßy
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toastContainer" class="fixed top-5 right-5 space-y-2 z-50"></div>

<script>
  const BASE_URL = '/acvstore/ban-hang';
  let tabs = [];
  let currentTabId = null;
  const MAX_TABS = 5;
  let currentProductId = null;
  let isUpdating = false; // Prevent concurrent updates

  // Hi·ªÉn th·ªã th√¥ng b√°o toast v·ªõi animation c·∫£i ti·∫øn
  function showToast(message, type = "info") {
    const container = document.getElementById("toastContainer");
    if (!container) return;

    const toast = document.createElement("div");
    const colors = {
      success: "from-green-500 to-emerald-600",
      error: "from-red-500 to-red-600",
      warning: "from-yellow-500 to-orange-600",
      info: "from-blue-500 to-indigo-600"
    };

    toast.className = `px-6 py-4 rounded-xl shadow-2xl text-white bg-gradient-to-r ${colors[type] || colors.info} transform translate-x-full transition-all duration-300 flex items-center gap-3`;

    const icon = {
      success: "fas fa-check-circle",
      error: "fas fa-exclamation-circle",
      warning: "fas fa-exclamation-triangle",
      info: "fas fa-info-circle"
    };

    toast.innerHTML = `
      <i class="${icon[type] || icon.info}"></i>
      <span class="font-medium">${message}</span>
    `;

    container.appendChild(toast);

    // Trigger animation
    setTimeout(() => {
      toast.classList.remove('translate-x-full');
      toast.classList.add('translate-x-0');
    }, 100);

    // Remove toast
    setTimeout(() => {
      toast.classList.add('translate-x-full', 'opacity-0');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // C·∫£i thi·ªán h√†m renderCart v·ªõi ki·ªÉm tra t·ªìn kho ch√≠nh x√°c
  function renderCart(cart) {
    const tbody = document.getElementById("cartItems");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!cart || cart.length === 0) {
      const emptyRow = document.createElement("tr");
      emptyRow.innerHTML = `
      <td colspan="8" class="text-center py-12">
        <div class="flex flex-col items-center gap-4 text-gray-500">
          <i class="fas fa-shopping-cart text-6xl opacity-30"></i>
          <p class="text-xl font-medium">Gi·ªè h√†ng tr·ªëng</p>
          <p class="text-sm">H√£y th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng</p>
        </div>
      </td>
    `;
      tbody.appendChild(emptyRow);
      return;
    }

    cart.forEach((item, index) => {
      const row = document.createElement("tr");
      row.className = "border-t hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-200";

      const actualStock = parseInt(item.soLuongTonKho || item.stockQuantity || 0);
      const currentQuantity = parseInt(item.soLuong || 0);
      const price = parseFloat(item.gia || 0);
      const totalPrice = parseFloat(item.thanhTien || 0);

      const isMinQuantity = currentQuantity <= 1;
      const isMaxQuantity = currentQuantity >= actualStock;
      const isOverStock = currentQuantity > actualStock;

      const stockWarning = isOverStock
              ? `<div class="stock-warning"><i class="fas fa-exclamation-triangle"></i>V∆∞·ª£t qu√° t·ªìn kho (${actualStock})</div>`
              : "";

      row.innerHTML = `
      <td class="p-4">
        <img src="${item.hinhAnh || "https://via.placeholder.com/60x60?text=No+Image"}"
             alt="H√¨nh ·∫£nh"
             class="w-16 h-16 object-cover rounded-xl shadow-md"
             onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
      </td>
      <td class="p-4">
        <div class="font-semibold text-gray-800">${item.tenSanPham || "N/A"}</div>
        <div class="text-sm text-gray-500">T·ªìn kho: ${actualStock}</div>
      </td>
      <td class="p-4">
        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
          ${item.mauSac || "N/A"}
        </span>
      </td>
      <td class="p-4">
        <span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
          ${item.kichCo || "N/A"}
        </span>
      </td>
      <td class="p-4">
        <span class="font-bold text-gray-800">${price.toLocaleString("vi-VN")} VNƒê</span>
      </td>
      <td class="p-4">
        <div class="quantity-controls" data-index="${index}">
          <button class="quantity-btn bg-red-500 hover:bg-red-600 text-white transition-all duration-200 ${isMinQuantity ? "opacity-50 cursor-not-allowed" : ""}"
                  ${isMinQuantity ? "disabled" : ""}
                  onclick="updateQuantity(${index}, -1, '${item.idChiTietSanPham}', ${actualStock})"
                  title="${isMinQuantity ? "Kh√¥ng th·ªÉ gi·∫£m th√™m" : "Gi·∫£m s·ªë l∆∞·ª£ng"}">
            <i class="fas fa-minus"></i>
          </button>
          <input type="number"
                 min="1"
                 max="${actualStock}"
                 value="${currentQuantity}"
                 class="w-16 text-center border-0 bg-transparent font-bold ${isOverStock ? "text-red-500" : ""}"
                 onchange="updateQuantityFromInput(${index}, this.value, '${item.idChiTietSanPham}', ${actualStock})"
                 onblur="validateQuantityInput(this, ${actualStock}, ${index})">
          <button class="quantity-btn bg-green-500 hover:bg-green-600 text-white transition-all duration-200 ${isMaxQuantity ? "opacity-50 cursor-not-allowed" : ""}"
                  ${isMaxQuantity ? "disabled" : ""}
                  onclick="updateQuantity(${index}, 1, '${item.idChiTietSanPham}', ${actualStock})"
                  title="${isMaxQuantity ? "ƒê√£ ƒë·∫°t t·ªëi ƒëa t·ªìn kho" : "TƒÉng s·ªë l∆∞·ª£ng"}">
            <i class="fas fa-plus"></i>
          </button>
        </div>
        ${stockWarning}
      </td>
      <td class="p-4">
        <span class="font-bold text-lg text-green-600">${totalPrice.toLocaleString("vi-VN")} VNƒê</span>
      </td>
      <td class="p-4">
        <button class="px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl btn-danger flex items-center gap-2 transition-all duration-200"
                onclick="removeItem(${index}, '${item.idChiTietSanPham}')">
          <i class="fas fa-trash"></i>
          <span class="hidden sm:inline">X√≥a</span>
        </button>
      </td>
    `;
      tbody.appendChild(row);
    });
  }

  // C·∫£i thi·ªán h√†m updateQuantity v·ªõi ki·ªÉm tra t·ªìn kho ch·∫∑t ch·∫Ω
  async function updateQuantity(index, delta, productDetailId, maxStock) {
    if (isUpdating) {
      showToast("ƒêang x·ª≠ l√Ω, vui l√≤ng ƒë·ª£i...", "warning");
      return;
    }

    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab || !tab.cart[index]) {
      showToast("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m trong gi·ªè h√†ng.", "error");
      return;
    }

    const currentItem = tab.cart[index];
    const currentQuantity = parseInt(currentItem.soLuong || 0);
    let newQuantity = currentQuantity + delta;

    if (newQuantity < 1) {
      newQuantity = 1;
      showToast("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0.", "warning");
      return;
    }
    if (newQuantity > maxStock) {
      newQuantity = maxStock;
      showToast(`S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${maxStock} (t·ªìn kho).`, "warning");
      return;
    }

    isUpdating = true;

    const quantityControls = document.querySelector(`.quantity-controls[data-index="${index}"]`);
    if (quantityControls) {
      quantityControls.classList.add("loading");
    }

    try {
      const requestData = {
        productDetailId: String(productDetailId),
        quantity: parseInt(newQuantity),
        shippingFee: parseFloat(tab.shippingFee || 0),
        tabId: String(currentTabId),
      };

      const response = await fetch(`${BASE_URL}/cart/update`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestData),
      });

      if (!response.ok) {
        let errorMessage = "L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);

      if (tab.voucherId) {
        await applyVoucher(tab.voucherId);
      }

      showToast("ƒê√£ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng!", "success");
    } catch (error) {
      console.error("L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng:", error);
      showToast("L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng: " + error.message, "error");
      await refreshCartFromServer();
    } finally {
      isUpdating = false;
      if (quantityControls) {
        quantityControls.classList.remove("loading");
      }
    }
  }

  // H√†m m·ªõi ƒë·ªÉ x·ª≠ l√Ω input tr·ª±c ti·∫øp t·ª´ √¥ nh·∫≠p s·ªë l∆∞·ª£ng
  async function updateQuantityFromInput(index, inputValue, productDetailId, maxStock) {
    const quantity = parseInt(inputValue);
    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab || !tab.cart[index]) return;

    const currentQuantity = parseInt(tab.cart[index].soLuong);

    if (isNaN(quantity) || quantity < 1) {
      showToast("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá (‚â• 1).", "warning");
      const input = document.querySelector(`.quantity-controls[data-index="${index}"] input`);
      if (input) input.value = currentQuantity;
      return;
    }

    if (quantity > maxStock) {
      showToast(`S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${maxStock} (t·ªìn kho).`, "warning");
      const input = document.querySelector(`.quantity-controls[data-index="${index}"] input`);
      if (input) input.value = Math.min(currentQuantity, maxStock);
      return;
    }

    const delta = quantity - currentQuantity;
    if (delta !== 0) {
      await updateQuantity(index, delta, productDetailId, maxStock);
    }
  }

  // H√†m validate input khi ng∆∞·ªùi d√πng r·ªùi kh·ªèi √¥ nh·∫≠p
  function validateQuantityInput(inputElement, maxStock, index) {
    const value = parseInt(inputElement.value);
    const tab = tabs.find((t) => t.id === currentTabId);

    if (!tab || !tab.cart[index]) return;

    const currentQuantity = parseInt(tab.cart[index].soLuong);

    if (isNaN(value) || value < 1) {
      inputElement.value = currentQuantity;
      showToast("S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu l√† 1.", "warning");
    } else if (value > maxStock) {
      inputElement.value = Math.min(currentQuantity, maxStock);
      showToast(`S·ªë l∆∞·ª£ng t·ªëi ƒëa l√† ${maxStock} (t·ªìn kho).`, "warning");
    }
  }
  // H√†m l√†m m·ªõi gi·ªè h√†ng t·ª´ server khi c√≥ l·ªói
  async function refreshCartFromServer() {
    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab) return;

    try {
      const response = await fetch(`${BASE_URL}/cart/get?tabId=${currentTabId}&shippingFee=${tab.shippingFee}`);
      if (response.ok) {
        const cartData = await response.json();
        tab.cart = cartData.danhSachSanPham || [];
        tab.subTotal = cartData.tongTienHang || 0;
        tab.discount = cartData.giamGia || 0;
        tab.total = cartData.tong || 0;
        tab.shippingFee = cartData.phiVanChuyen || 0;
        renderCart(tab.cart);
        updateSummary(tab);
        localStorage.setItem("orderTabs", JSON.stringify(tabs));
      }
    } catch (error) {
      console.error("L·ªói khi l√†m m·ªõi gi·ªè h√†ng:", error);
      showToast("Kh√¥ng th·ªÉ l√†m m·ªõi gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.", "error");
    }
  }

  // C·∫£i thi·ªán h√†m th√™m s·∫£n ph·∫©m v·ªõi ki·ªÉm tra t·ªìn kho
  async function addVariantToCart() {
    const productDetailId = document.getElementById("variantDetails").dataset.productDetailId;
    const quantity = parseInt(document.getElementById("variantQuantity").value);
    const maxStock = parseInt(document.getElementById("variantQuantity").max);

    if (!productDetailId) {
      showToast("Vui l√≤ng ch·ªçn bi·∫øn th·ªÉ s·∫£n ph·∫©m.", "warning");
      return;
    }

    if (isNaN(quantity) || quantity < 1) {
      showToast("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá (‚â• 1).", "warning");
      return;
    }

    if (quantity > maxStock) {
      showToast(`S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${maxStock} (t·ªìn kho).`, "warning");
      return;
    }

    try {
      const tab = tabs.find((t) => t.id === currentTabId);
      if (!tab) throw new Error("Kh√¥ng t√¨m th·∫•y tab hi·ªán t·∫°i.");

      const existingIndex = tab.cart.findIndex((item) => item.idChiTietSanPham === productDetailId);
      if (existingIndex >= 0) {
        const currentQuantity = tab.cart[existingIndex].soLuong;
        const newTotalQuantity = currentQuantity + quantity;

        if (newTotalQuantity > maxStock) {
          showToast(`T·ªïng s·ªë l∆∞·ª£ng s·∫Ω v∆∞·ª£t qu√° ${maxStock} (t·ªìn kho).`, "warning");
          return;
        }

        await updateQuantity(existingIndex, quantity, productDetailId, maxStock);
        document.getElementById("variantModal").style.display = "none";
        return;
      }

      const requestData = {
        productDetailId: String(productDetailId),
        quantity: parseInt(quantity),
        shippingFee: parseFloat(tab.shippingFee || 0),
        tabId: String(currentTabId),
      };

      const response = await fetch(`${BASE_URL}/cart/add`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestData),
      });

      if (!response.ok) {
        let errorMessage = "L·ªói khi th√™m s·∫£n ph·∫©m.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      document.getElementById("variantModal").style.display = "none";
      showToast("ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!", "success");
    } catch (error) {
      console.error("L·ªói khi th√™m bi·∫øn th·ªÉ:", error);
      showToast("L·ªói khi th√™m s·∫£n ph·∫©m: " + error.message, "error");
    }
  }

  // C·∫≠p nh·∫≠t h√†m renderTabs v·ªõi styling m·ªõi
  function renderTabs() {
    const tabsContainer = document.getElementById('orderTabs');
    if (!tabsContainer) return;

    tabsContainer.innerHTML = '';

    tabs.sort((a, b) => a.id - b.id).forEach(tab => {
      const tabElement = document.createElement('div');
      tabElement.className = `tab px-6 py-3 border-2 cursor-pointer ${tab.id === currentTabId ? 'active' : 'border-gray-200 hover:border-blue-300'}`;

      const tabContent = document.createElement('div');
      tabContent.className = 'flex items-center gap-3';
      tabContent.innerHTML = `
        <i class="fas fa-receipt"></i>
        <span class="font-semibold">ƒê∆°n ${tab.id}</span>
      `;

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'ml-3 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-xs transition-all duration-200';
      deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteTab(tab.id);
      };

      tabContent.appendChild(deleteBtn);
      tabElement.appendChild(tabContent);
      tabElement.onclick = () => switchTab(tab.id);
      tabsContainer.appendChild(tabElement);
    });

    const addTabBtn = document.getElementById('addTabBtn');
    if (addTabBtn) {
      addTabBtn.disabled = tabs.length >= MAX_TABS;
    }
  }

  // Th√™m s·∫£n ph·∫©m b·∫±ng QR
  async function addProductByQr(productDetailId) {
    try {
      const tab = tabs.find(t => t.id === currentTabId);
      if (!tab) throw new Error('Kh√¥ng t√¨m th·∫•y tab hi·ªán t·∫°i.');

      // Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i
      const existingIndex = tab.cart.findIndex(item => item.idChiTietSanPham === productDetailId);
      if (existingIndex >= 0) {
        const currentQuantity = tab.cart[existingIndex].soLuong;
        const maxStock = tab.cart[existingIndex].soLuongTonKho || tab.cart[existingIndex].stockQuantity || 0;
        await updateQuantity(existingIndex, 1, productDetailId, maxStock);
        return;
      }

      const requestData = {
        productDetailId: String(productDetailId),
        quantity: 1,
        shippingFee: parseFloat(tab.shippingFee || 0),
        tabId: String(currentTabId)
      };

      const response = await fetch(`${BASE_URL}/cart/add`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        let errorMessage = "L·ªói khi th√™m s·∫£n ph·∫©m.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      showToast('ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!', 'success');
    } catch (error) {
      console.error('L·ªói khi th√™m s·∫£n ph·∫©m:', error);
      showToast('L·ªói khi th√™m s·∫£n ph·∫©m: ' + error.message, 'error');
    }
  }

  // C·∫≠p nh·∫≠t gi·ªè h√†ng t·ª´ response
  function updateCartFromResponse(data) {
    const tab = tabs.find((t) => t.id === currentTabId);
    if (!tab) return;

    tab.cart = data.danhSachSanPham || [];
    tab.subTotal = data.tongTienHang || 0;
    tab.discount = data.giamGia || 0;
    tab.total = data.tong || 0;
    tab.shippingFee = data.phiVanChuyen || 0; // ƒê·∫£m b·∫£o ƒë·ªìng b·ªô ph√≠ v·∫≠n chuy·ªÉn

    renderCart(tab.cart);
    updateSummary(tab);
    localStorage.setItem("orderTabs", JSON.stringify(tabs));
    fetchVouchers();
  }

  // Kh·ªüi t·∫°o tabs
  async function initTabs() {
    try {
      const savedTabs = localStorage.getItem('orderTabs');
      const savedTabId = localStorage.getItem('currentTabId');

      if (savedTabs && savedTabId) {
        tabs = JSON.parse(savedTabs);
        currentTabId = parseInt(savedTabId);
        tabs.sort((a, b) => a.id - b.id);
        renderTabs();
        loadTabContent(currentTabId);
        return;
      }

      // T·∫°o tab m·∫∑c ƒë·ªãnh
      await addNewTab();
    } catch (error) {
      console.error('L·ªói khi kh·ªüi t·∫°o tabs:', error);
      showToast('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      await addNewTab();
    }
  }

  function getNextTabId() {
    for (let i = 1; i <= MAX_TABS; i++) {
      if (!tabs.some(tab => tab.id === i)) return i;
    }
    return tabs.length + 1;
  }

  async function addNewTab() {
    if (tabs.length >= MAX_TABS) {
      showToast('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 5 ƒë∆°n h√†ng.', 'warning');
      return;
    }

    try {
      const newTabId = getNextTabId();

      // X√≥a gi·ªè h√†ng c≈© tr∆∞·ªõc khi t·∫°o tab m·ªõi
      await fetch(`${BASE_URL}/cart/clear?tabId=${newTabId}`, { method: 'POST' });

      const newTab = {
        id: newTabId,
        cart: [],
        customerPhone: '',
        customerName: '',
        customerEmail: '',
        saleMethod: 'T·∫°i qu·∫ßy',
        shippingFee: 0,
        voucherId: null,
        paymentMethod: '550E8400-E29B-41D4-A716-446655440017',
        cashAmount: 0,
        subTotal: 0,
        discount: 0,
        total: 0,
        addresses: [],
        selectedAddress: ''
      };

      tabs.push(newTab);
      currentTabId = newTab.id;
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      localStorage.setItem('currentTabId', currentTabId);
      renderTabs();
      loadTabContent(currentTabId);
    } catch (error) {
      showToast('L·ªói khi t·∫°o tab m·ªõi: ' + error.message, 'error');
    }
  }

  function switchTab(tabId) {
    currentTabId = tabId;
    localStorage.setItem('currentTabId', currentTabId);
    renderTabs();
    loadTabContent(tabId);
  }

  async function deleteTab(tabId) {
    if (tabs.length <= 1) {
      showToast('Ph·∫£i gi·ªØ √≠t nh·∫•t m·ªôt tab.', 'warning');
      return;
    }

    // X√≥a gi·ªè h√†ng tr√™n server
    try {
      await fetch(`${BASE_URL}/cart/clear?tabId=${tabId}`, { method: 'POST' });
    } catch (error) {
      console.error('L·ªói khi x√≥a gi·ªè h√†ng:', error);
    }

    tabs = tabs.filter(t => t.id !== tabId);
    if (currentTabId === tabId) {
      currentTabId = tabs.length > 0 ? tabs[tabs.length - 1].id : null;
    }

    localStorage.setItem('orderTabs', JSON.stringify(tabs));
    localStorage.setItem('currentTabId', currentTabId);
    renderTabs();

    if (currentTabId) {
      loadTabContent(currentTabId);
    }
  }

  async function loadTabContent(tabId) {
    const tab = tabs.find(t => t.id === tabId);
    if (!tab) return;

    // Load th√¥ng tin t·ª´ tab
    const elements = {
      customerPhone: document.getElementById('customerPhone'),
      customerName: document.getElementById('customerName'),
      customerEmail: document.getElementById('customerEmail'),
      saleMethod: document.getElementById('saleMethod'),
      shippingFee: document.getElementById('shippingFee'),
      paymentMethod: document.getElementById('paymentMethod'),
      cashAmount: document.getElementById('cashAmount')
    };

    if (elements.customerPhone) elements.customerPhone.value = tab.customerPhone;
    if (elements.customerName) elements.customerName.value = tab.customerName;
    if (elements.customerEmail) elements.customerEmail.value = tab.customerEmail;
    if (elements.saleMethod) elements.saleMethod.value = tab.saleMethod;
    if (elements.shippingFee) elements.shippingFee.value = tab.shippingFee;
    if (elements.paymentMethod) elements.paymentMethod.value = tab.paymentMethod;
    if (elements.cashAmount) elements.cashAmount.value = tab.cashAmount;

    toggleAddressSection();
    toggleCashInput();
    renderCart(tab.cart);
    updateSummary(tab);

    // Load gi·ªè h√†ng t·ª´ server
    try {
      const response = await fetch(`${BASE_URL}/cart/get?tabId=${tabId}&shippingFee=${tab.shippingFee}`);
      if (response.ok) {
        const cartData = await response.json();
        tab.cart = cartData.danhSachSanPham || [];
        tab.subTotal = cartData.tongTienHang || 0;
        tab.discount = cartData.giamGia || 0;
        tab.total = cartData.tong || 0;
        renderCart(tab.cart);
        updateSummary(tab);
      }
    } catch (error) {
      console.error('L·ªói khi load gi·ªè h√†ng:', error);
    }

    if (tab.customerPhone && tab.customerPhone !== '0999999999') {
      await fetchCustomerAddresses();
    }

    await fetchVouchers();
  }

  async function fetchCustomerAddresses() {
    const phoneInput = document.getElementById('customerPhone');
    if (!phoneInput) return;

    const phone = phoneInput.value;
    if (!phone || !/^\d{10}$/.test(phone)) {
      showToast('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p 10 ch·ªØ s·ªë.', 'warning');
      const addressSection = document.getElementById('addressSection');
      if (addressSection) addressSection.style.display = 'none';
      return;
    }

    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    tab.customerPhone = phone;

    try {
      const response = await fetch(`${BASE_URL}/customer/${phone}/addresses`);
      if (!response.ok) {
        let errorMessage = "Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      tab.customerName = data.hoTen || '';
      tab.customerEmail = data.email || '';

      const customerNameInput = document.getElementById('customerName');
      const customerEmailInput = document.getElementById('customerEmail');
      if (customerNameInput) customerNameInput.value = tab.customerName;
      if (customerEmailInput) customerEmailInput.value = tab.customerEmail;

      tab.addresses = data.addresses || [];
      const addressSelect = document.getElementById('addressSelect');
      if (addressSelect) {
        addressSelect.innerHTML = '<option value="">Ch·ªçn ƒë·ªãa ch·ªâ</option>';

        tab.addresses.forEach(address => {
          const option = document.createElement('option');
          option.value = address;
          option.text = address;
          addressSelect.appendChild(option);
        });

        addressSelect.value = tab.selectedAddress || '';
      }

      const addressSection = document.getElementById('addressSection');
      if (addressSection) {
        addressSection.style.display =
                tab.saleMethod === 'Giao h√†ng' && phone !== '0999999999' ? 'block' : 'none';
      }

      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    } catch (error) {
      console.error('L·ªói khi l·∫•y th√¥ng tin kh√°ch h√†ng:', error);
      showToast('L·ªói khi t·∫£i ƒë·ªãa ch·ªâ: ' + error.message, 'error');
    }
  }

  function showAddAddressForm() {
    const addAddressForm = document.getElementById('addAddressForm');
    if (addAddressForm) {
      addAddressForm.style.display = 'block';

      const fields = ['addressLine', 'ward', 'district', 'city'];
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = '';
      });
    }
  }

  async function addNewAddress() {
    const phoneInput = document.getElementById('customerPhone');
    const addressLineInput = document.getElementById('addressLine');
    const wardInput = document.getElementById('ward');
    const districtInput = document.getElementById('district');
    const cityInput = document.getElementById('city');

    if (!phoneInput || !addressLineInput || !wardInput || !districtInput || !cityInput) {
      showToast('Kh√¥ng t√¨m th·∫•y c√°c tr∆∞·ªùng nh·∫≠p li·ªáu.', 'error');
      return;
    }

    const phone = phoneInput.value;
    const addressLine = addressLineInput.value;
    const ward = wardInput.value;
    const district = districtInput.value;
    const city = cityInput.value;

    if (!phone || !addressLine || !ward || !district || !city) {
      showToast('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ch·ªâ v√† s·ªë ƒëi·ªán tho·∫°i.', 'warning');
      return;
    }

    try {
      const response = await fetch(`${BASE_URL}/customer/${phone}/add-address`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          addressLine,
          ward,
          district,
          city
        })
      });

      const data = await response.json();
      if (data.success) {
        const addAddressForm = document.getElementById('addAddressForm');
        if (addAddressForm) addAddressForm.style.display = 'none';
        await fetchCustomerAddresses();
        showToast('ƒê√£ th√™m ƒë·ªãa ch·ªâ th√†nh c√¥ng!', 'success');
      } else {
        showToast(data.error || 'L·ªói khi th√™m ƒë·ªãa ch·ªâ.', 'error');
      }
    } catch (error) {
      showToast('L·ªói khi th√™m ƒë·ªãa ch·ªâ: ' + error.message, 'error');
    }
  }

  function toggleAddressSection() {
    const saleMethodSelect = document.getElementById('saleMethod');
    const phoneInput = document.getElementById('customerPhone');
    const addressSection = document.getElementById('addressSection');

    if (!saleMethodSelect || !phoneInput || !addressSection) return;

    const saleMethod = saleMethodSelect.value;
    const phone = phoneInput.value;
    const tab = tabs.find(t => t.id === currentTabId);

    if (tab) {
      tab.saleMethod = saleMethod;
      addressSection.style.display =
              saleMethod === 'Giao h√†ng' && phone && phone !== '0999999999' ? 'block' : 'none';

      if (saleMethod === 'Giao h√†ng' && phone && phone !== '0999999999') {
        fetchCustomerAddresses();
      }

      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      fetchVouchers();
    }
  }

  function toggleCashInput() {
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const cashInput = document.getElementById('cashInput');

    if (!paymentMethodSelect || !cashInput) return;

    const paymentMethod = paymentMethodSelect.value;
    const tab = tabs.find(t => t.id === currentTabId);

    if (tab) {
      tab.paymentMethod = paymentMethod;
      cashInput.style.display =
              paymentMethod === '550E8400-E29B-41D4-A716-446655440017' ? 'block' : 'none';

      localStorage.setItem('orderTabs', JSON.stringify(tabs));
    }
  }

  // QR Scanner
  let stream = null;

  async function showQrScanner() {
    const qrScannerModal = document.getElementById('qrScannerModal');
    if (qrScannerModal) qrScannerModal.style.display = 'flex';

    const video = document.getElementById('video');
    if (!video) return;

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
      });
      video.srcObject = stream;
      video.play();

      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');

      const scan = () => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.height = video.videoHeight;
          canvas.width = video.videoWidth;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);

          if (code) {
            addProductByQr(code.data);
            stopQrScanner();
            return;
          }
        }
        requestAnimationFrame(scan);
      };

      requestAnimationFrame(scan);
    } catch (error) {
      showToast('L·ªói khi m·ªü camera.', 'error');
    }
  }

  function stopQrScanner() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    const qrScannerModal = document.getElementById('qrScannerModal');
    if (qrScannerModal) qrScannerModal.style.display = 'none';
  }

  async function removeItem(index, productDetailId) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    try {
      const requestData = {
        productDetailId: String(productDetailId),
        shippingFee: String(tab.shippingFee || 0),
        tabId: String(currentTabId)
      };

      const response = await fetch(`${BASE_URL}/cart/remove`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        let errorMessage = "L·ªói khi x√≥a s·∫£n ph·∫©m.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      updateCartFromResponse(data);
      showToast('ƒê√£ x√≥a s·∫£n ph·∫©m!', 'success');
    } catch (error) {
      showToast('L·ªói khi x√≥a s·∫£n ph·∫©m: ' + error.message, 'error');
    }
  }

  async function fetchVouchers() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const subTotal = tab.subTotal || 0;

    try {
      const response = await fetch(`${BASE_URL}/vouchers?subTotal=${subTotal}&tabId=${currentTabId}`);
      if (!response.ok) {
        let errorMessage = "L·ªói khi l·∫•y phi·∫øu gi·∫£m gi√°.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      const voucherSelect = document.getElementById('voucherSelect');
      if (voucherSelect) {
        voucherSelect.innerHTML = '<option value="">üé´ Kh√¥ng s·ª≠ d·ª•ng</option>';

        if (data.vouchers && data.vouchers.length > 0) {
          data.vouchers.forEach(voucher => {
            const option = document.createElement('option');
            option.value = voucher.id;
            option.text = `${voucher.ten} (T·ªëi thi·ªÉu: ${voucher.giaTriGiamToiThieuFormatted || voucher.giaTriGiamToiThieu + ' VNƒê'})`;
            voucherSelect.appendChild(option);
          });
        }

        voucherSelect.value = tab.voucherId || '';
      }
    } catch (error) {
      console.error('L·ªói khi l·∫•y phi·∫øu gi·∫£m gi√°:', error);
    }
  }

  async function applyVoucher(voucherId) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    const voucherSelect = document.getElementById('voucherSelect');
    const selectedVoucherId = voucherId || (voucherSelect ? voucherSelect.value : null);
    const shippingFee = tab.shippingFee || 0;

    if (!selectedVoucherId) {
      tab.voucherId = null;
      tab.discount = 0;
      tab.total = tab.subTotal;
      updateSummary(tab);
      localStorage.setItem('orderTabs', JSON.stringify(tabs));
      return;
    }

    try {
      const response = await fetch(`${BASE_URL}/cart/apply-voucher?voucherId=${selectedVoucherId}&shippingFee=${shippingFee}&tabId=${currentTabId}`);
      if (!response.ok) {
        let errorMessage = "L·ªói khi √°p d·ª•ng voucher.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      tab.voucherId = selectedVoucherId;
      updateCartFromResponse(data);
      showToast('ƒê√£ √°p d·ª•ng phi·∫øu gi·∫£m gi√°!', 'success');
    } catch (error) {
      console.error('L·ªói khi √°p d·ª•ng voucher:', error);
      showToast('L·ªói khi √°p d·ª•ng voucher: ' + error.message, 'error');
    }
  }

  function updateSummary(tab) {
    const subTotal = parseFloat(tab.subTotal) || 0;
    const discount = parseFloat(tab.discount) || 0;
    const shippingFee = parseFloat(tab.shippingFee) || 0;
    const total = subTotal - discount;
    const totalWithShipping = total + shippingFee;

    const cashAmountInput = document.getElementById('cashAmount');
    const cashAmount = parseFloat(cashAmountInput ? cashAmountInput.value : 0) || 0;
    tab.cashAmount = cashAmount;

    const change = Math.max(0, cashAmount - totalWithShipping);

    // Update DOM elements safely
    const elements = {
      subTotal: document.getElementById('subTotal'),
      discount: document.getElementById('discount'),
      shippingFeeDisplay: document.getElementById('shippingFeeDisplay'),
      total: document.getElementById('total'),
      changeAmount: document.getElementById('changeAmount')
    };

    if (elements.subTotal) elements.subTotal.innerText = subTotal.toLocaleString('vi-VN') + ' VNƒê';
    if (elements.discount) elements.discount.innerText = discount.toLocaleString('vi-VN') + ' VNƒê';
    if (elements.shippingFeeDisplay) elements.shippingFeeDisplay.innerText = shippingFee.toLocaleString('vi-VN') + ' VNƒê';
    if (elements.total) elements.total.innerText = totalWithShipping.toLocaleString('vi-VN') + ' VNƒê';
    if (elements.changeAmount) elements.changeAmount.innerText = change.toLocaleString('vi-VN') + ' VNƒê';
  }

  async function createOrder() {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    if (!tab.customerPhone) {
      showToast('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng.', 'warning');
      return;
    }

    if (tab.saleMethod === 'Giao h√†ng' && !tab.selectedAddress && tab.customerPhone !== '0999999999') {
      showToast('Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng.', 'warning');
      return;
    }

    if (tab.cart.length === 0) {
      showToast('Gi·ªè h√†ng tr·ªëng.', 'warning');
      return;
    }

    const cashAmountInput = document.getElementById('cashAmount');
    const orderData = {
      soDienThoaiKhachHang: tab.customerPhone,
      phiVanChuyen: tab.shippingFee,
      phuongThucThanhToan: tab.paymentMethod,
      soTienKhachDua: parseFloat(cashAmountInput ? cashAmountInput.value : 0) || 0,
      phuongThucBanHang: tab.saleMethod,
      idPhieuGiamGia: tab.voucherId || null,
      danhSachSanPham: tab.cart,
      diaChiGiaoHang: tab.selectedAddress,
      tabId: String(currentTabId)
    };

    try {
      if (tab.paymentMethod === '550E8400-E29B-41D4-A716-446655440018') {
        // Thanh to√°n chuy·ªÉn kho·∫£n - chuy·ªÉn h∆∞·ªõng ƒë·∫øn VNPay
        let totalAmount = (tab.total || 0) + (tab.shippingFee || 0);

        if (totalAmount <= 0) {
          showToast('T·ªïng ti·ªÅn ph·∫£i l·ªõn h∆°n 0.', 'warning');
          return;
        }

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/create-payment-link';
        form.style.display = 'none';

        const productNameInput = document.createElement('input');
        productNameInput.type = 'hidden';
        productNameInput.name = 'productName';
        productNameInput.value = tab.cart.map(item => item.tenSanPham).join(', ');
        form.appendChild(productNameInput);

        const priceInput = document.createElement('input');
        priceInput.type = 'hidden';
        priceInput.name = 'price';
        priceInput.value = totalAmount.toString();
        form.appendChild(priceInput);

        const descriptionInput = document.createElement('input');
        descriptionInput.type = 'hidden';
        descriptionInput.name = 'description';
        descriptionInput.value = `Thanh to√°n ƒë∆°n h√†ng ${currentTabId}`;
        form.appendChild(descriptionInput);

        // L∆∞u th√¥ng tin ƒë∆°n h√†ng ƒë·ªÉ x·ª≠ l√Ω sau khi thanh to√°n
        sessionStorage.setItem('pendingOrder', JSON.stringify({ orderData, tabId: currentTabId }));

        document.body.appendChild(form);
        form.submit();
      } else {
        // Thanh to√°n ti·ªÅn m·∫∑t
        const response = await fetch(`${BASE_URL}/create-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(orderData)
        });

        if (!response.ok) {
          let errorMessage = "L·ªói khi t·∫°o ƒë∆°n h√†ng.";
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorData.message || errorMessage;
          } catch (e) {
            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();
        showToast(`ƒê∆°n h√†ng ${data.maDonHang} ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!`, 'success');

        // X√≥a tab hi·ªán t·∫°i v√† t·∫°o tab m·ªõi
        tabs = tabs.filter(t => t.id !== currentTabId);
        if (tabs.length === 0) {
          await addNewTab();
        } else {
          currentTabId = tabs[tabs.length - 1].id;
        }

        localStorage.setItem('orderTabs', JSON.stringify(tabs));
        localStorage.setItem('currentTabId', currentTabId);
        renderTabs();
        loadTabContent(currentTabId);
      }
    } catch (error) {
      showToast('L·ªói khi t·∫°o ƒë∆°n h√†ng: ' + error.message, 'error');
    }
  }

  async function fetchCustomers() {
    const customerSpinner = document.getElementById('customerSpinner');
    if (customerSpinner) customerSpinner.style.display = 'block';

    try {
      const response = await fetch(`${BASE_URL}/customers`);
      if (!response.ok) {
        let errorMessage = "L·ªói khi t·∫£i danh s√°ch kh√°ch h√†ng.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      const customerList = document.getElementById('customerList');
      if (customerList) {
        customerList.innerHTML = '';

        data.customers.filter(customer => customer.soDienThoai !== '0999999999').forEach(customer => {
          const div = document.createElement('div');
          div.className = 'p-4 border-2 border-gray-200 cursor-pointer hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 hover:border-blue-300 rounded-xl transition-all duration-200';
          div.innerHTML = `
            <div class="flex items-center gap-3">
              <i class="fas fa-user-circle text-2xl text-blue-500"></i>
              <div>
                <div class="font-semibold text-gray-800">${customer.hoTen}</div>
                <div class="text-sm text-gray-600">${customer.soDienThoai} ‚Ä¢ ${customer.email}</div>
              </div>
            </div>
          `;
          div.onclick = () => selectCustomerFromModal(customer.soDienThoai, customer.hoTen, customer.email);
          customerList.appendChild(div);
        });
      }
    } catch (error) {
      showToast('L·ªói khi t·∫£i danh s√°ch kh√°ch h√†ng: ' + error.message, 'error');
    } finally {
      if (customerSpinner) customerSpinner.style.display = 'none';
    }
  }

  function showCustomerModal() {
    const customerModal = document.getElementById('customerModal');
    if (customerModal) customerModal.style.display = 'flex';
    fetchCustomers();
  }

  function selectCustomerFromModal(phone, name, email) {
    const tab = tabs.find(t => t.id === currentTabId);
    if (!tab) return;

    tab.customerPhone = phone;
    tab.customerName = name;
    tab.customerEmail = email;

    const elements = {
      customerPhone: document.getElementById('customerPhone'),
      customerName: document.getElementById('customerName'),
      customerEmail: document.getElementById('customerEmail'),
      customerModal: document.getElementById('customerModal')
    };

    if (elements.customerPhone) elements.customerPhone.value = phone;
    if (elements.customerName) elements.customerName.value = name;
    if (elements.customerEmail) elements.customerEmail.value = email;
    if (elements.customerModal) elements.customerModal.style.display = 'none';

    fetchCustomerAddresses();
    toggleAddressSection();
    localStorage.setItem('orderTabs', JSON.stringify(tabs));
  }

  async function fetchProducts() {
    const productSpinner = document.getElementById('productSpinner');
    if (productSpinner) productSpinner.style.display = 'block';

    try {
      const response = await fetch(`${BASE_URL}/products`);
      if (!response.ok) {
        let errorMessage = "L·ªói khi t·∫£i danh s√°ch s·∫£n ph·∫©m.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      const productList = document.getElementById('productList');
      if (productList) {
        productList.innerHTML = '';

        // Nh√≥m s·∫£n ph·∫©m theo t√™n
        const productsByName = data.products.reduce((acc, product) => {
          if (!acc[product.tenSanPham]) {
            acc[product.tenSanPham] = [];
          }
          acc[product.tenSanPham].push(product);
          return acc;
        }, {});

        Object.keys(productsByName).forEach(productName => {
          const div = document.createElement('div');
          div.className = 'p-4 border-2 border-gray-200 cursor-pointer hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 hover:border-blue-300 rounded-xl transition-all duration-200';
          div.innerHTML = `
            <div class="flex items-center gap-3">
              <i class="fas fa-box text-2xl text-green-500"></i>
              <div>
                <div class="font-semibold text-gray-800">${productName}</div>
                <div class="text-sm text-gray-600">Nh·∫•n ƒë·ªÉ ch·ªçn bi·∫øn th·ªÉ</div>
              </div>
            </div>
          `;
          div.onclick = () => showVariantModal(productsByName[productName][0].idChiTietSanPham);
          productList.appendChild(div);
        });
      }
    } catch (error) {
      showToast('L·ªói khi t·∫£i danh s√°ch s·∫£n ph·∫©m: ' + error.message, 'error');
    } finally {
      if (productSpinner) productSpinner.style.display = 'none';
    }
  }

  function showProductModal() {
    const productModal = document.getElementById('productModal');
    if (productModal) productModal.style.display = 'flex';
    fetchProducts();
  }

  function showVariantModal(productDetailId) {
    fetch(`${BASE_URL}/product-detail/${productDetailId}`)
            .then(async res => {
              if (!res.ok) {
                let errorMessage = "L·ªói khi l·∫•y th√¥ng tin s·∫£n ph·∫©m.";
                try {
                  const errorData = await res.json();
                  errorMessage = errorData.error || errorData.message || errorMessage;
                } catch (e) {
                  errorMessage = `HTTP ${res.status}: ${res.statusText}`;
                }
                throw new Error(errorMessage);
              }

              const data = await res.json();
              currentProductId = data.productId;

              const productModal = document.getElementById('productModal');
              const variantModal = document.getElementById('variantModal');
              const variantModalTitle = document.getElementById('variantModalTitle');
              const variantDetails = document.getElementById('variantDetails');

              if (productModal) productModal.style.display = 'none';
              if (variantModal) variantModal.style.display = 'flex';
              if (variantModalTitle) variantModalTitle.innerText = `Ch·ªçn bi·∫øn th·ªÉ: ${data.tenSanPham}`;

              if (variantDetails) {
                variantDetails.innerHTML = `
            <div class="text-center">
              <img src="${data.hinhAnh || 'https://via.placeholder.com/150x150?text=No+Image'}"
                   alt="H√¨nh ·∫£nh" class="w-32 h-32 object-cover rounded-xl shadow-lg mx-auto mb-4"
                   onerror="this.src='https://via.placeholder.com/150x150?text=No+Image'">
            </div>
            <div class="space-y-3">
              <p class="flex justify-between"><span class="font-medium">Gi√°:</span> <span id="variantPrice" class="font-bold text-blue-600"></span></p>
              <p class="flex justify-between"><span class="font-medium">T·ªìn kho:</span> <span id="variantStock" class="font-bold text-green-600"></span></p>
              <div class="floating-label">
                <label for="variantQuantity">S·ªë l∆∞·ª£ng</label>
                <input type="number" id="variantQuantity" min="1" value="1"
                       class="input-field w-full p-4 border rounded-xl">
              </div>
            </div>
          `;
              }

              // ƒê·∫∑t l·∫°i combobox v·ªÅ tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
              const colorSelect = document.getElementById('colorSelect');
              const sizeSelect = document.getElementById('sizeSelect');
              if (colorSelect) colorSelect.value = '';
              if (sizeSelect) sizeSelect.value = '';
              if (variantDetails) variantDetails.style.display = 'none';

              await fetchProductVariants();
            })
            .catch(error => {
              showToast('L·ªói khi l·∫•y th√¥ng tin s·∫£n ph·∫©m: ' + error.message, 'error');
            });
  }

  async function fetchProductVariants() {
    const variantSpinner = document.getElementById('variantSpinner');
    if (variantSpinner) variantSpinner.style.display = 'block';

    try {
      const response = await fetch(`${BASE_URL}/product/${currentProductId}/variants`);
      if (!response.ok) {
        let errorMessage = "L·ªói khi l·∫•y bi·∫øn th·ªÉ s·∫£n ph·∫©m.";
        try {
          const errorData = await response.json();
          errorMessage = errorData.error || errorData.message || errorMessage;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      window.productVariants = data.variants || [];

      // L·∫•y danh s√°ch m√†u s·∫Øc v√† k√≠ch c·ª° duy nh·∫•t t·ª´ c√°c bi·∫øn th·ªÉ
      const uniqueColors = [...new Set(window.productVariants.map(v => JSON.stringify({ id: v.colorId, tenMau: v.mauSac })))].map(str => JSON.parse(str));
      const uniqueSizes = [...new Set(window.productVariants.map(v => JSON.stringify({ id: v.sizeId, ten: v.kichCo })))].map(str => JSON.parse(str));

      // Kh·ªüi t·∫°o combobox m√†u s·∫Øc
      const colorSelect = document.getElementById('colorSelect');
      if (colorSelect) {
        colorSelect.innerHTML = '<option value="">Ch·ªçn m√†u s·∫Øc</option>';
        uniqueColors.forEach(color => {
          const option = document.createElement('option');
          option.value = color.id;
          option.text = color.tenMau;
          colorSelect.appendChild(option);
        });
      }

      // Kh·ªüi t·∫°o combobox k√≠ch c·ª°
      const sizeSelect = document.getElementById('sizeSelect');
      if (sizeSelect) {
        sizeSelect.innerHTML = '<option value="">Ch·ªçn k√≠ch c·ª°</option>';
        uniqueSizes.forEach(size => {
          const option = document.createElement('option');
          option.value = size.id;
          option.text = size.ten;
          sizeSelect.appendChild(option);
        });
      }

      const variantDetails = document.getElementById('variantDetails');
      if (variantDetails) variantDetails.style.display = 'none';
    } catch (error) {
      showToast('L·ªói khi l·∫•y bi·∫øn th·ªÉ s·∫£n ph·∫©m: ' + error.message, 'error');
    } finally {
      if (variantSpinner) variantSpinner.style.display = 'none';
    }
  }

  async function fetchVariants() {
    const colorSelect = document.getElementById('colorSelect');
    const sizeSelect = document.getElementById('sizeSelect');

    if (!colorSelect || !sizeSelect) return;

    const colorId = colorSelect.value;
    const sizeId = sizeSelect.value;

    // N·∫øu kh√¥ng ch·ªçn c·∫£ m√†u s·∫Øc v√† k√≠ch c·ª°, t·∫£i l·∫°i to√†n b·ªô danh s√°ch
    if (!colorId && !sizeId) {
      const uniqueColors = [...new Set(window.productVariants.map(v => JSON.stringify({ id: v.colorId, tenMau: v.mauSac })))].map(str => JSON.parse(str));
      const uniqueSizes = [...new Set(window.productVariants.map(v => JSON.stringify({ id: v.sizeId, ten: v.kichCo })))].map(str => JSON.parse(str));

      // Kh·ªüi t·∫°o l·∫°i combobox m√†u s·∫Øc
      colorSelect.innerHTML = '<option value="">Ch·ªçn m√†u s·∫Øc</option>';
      uniqueColors.forEach(color => {
        const option = document.createElement('option');
        option.value = color.id;
        option.text = color.tenMau;
        colorSelect.appendChild(option);
      });

      // Kh·ªüi t·∫°o l·∫°i combobox k√≠ch c·ª°
      sizeSelect.innerHTML = '<option value="">Ch·ªçn k√≠ch c·ª°</option>';
      uniqueSizes.forEach(size => {
        const option = document.createElement('option');
        option.value = size.id;
        option.text = size.ten;
        sizeSelect.appendChild(option);
      });

      const variantDetails = document.getElementById('variantDetails');
      if (variantDetails) variantDetails.style.display = 'none';
      return;
    }

    // C·∫≠p nh·∫≠t danh s√°ch k√≠ch c·ª° khi ch·ªçn m√†u s·∫Øc
    if (colorId) {
      const selectedSize = sizeSelect.value;
      sizeSelect.innerHTML = '<option value="">Ch·ªçn k√≠ch c·ª°</option>';
      const availableSizes = window.productVariants
              .filter(v => v.colorId === colorId)
              .map(v => ({ id: v.sizeId, ten: v.kichCo }));
      const uniqueSizes = [...new Set(availableSizes.map(s => JSON.stringify(s)))].map(str => JSON.parse(str));
      uniqueSizes.forEach(size => {
        const option = document.createElement('option');
        option.value = size.id;
        option.text = size.ten;
        if (size.id === selectedSize) option.selected = true;
        sizeSelect.appendChild(option);
      });
    }

    // C·∫≠p nh·∫≠t danh s√°ch m√†u s·∫Øc khi ch·ªçn k√≠ch c·ª°
    if (sizeId) {
      const selectedColor = colorSelect.value;
      colorSelect.innerHTML = '<option value="">Ch·ªçn m√†u s·∫Øc</option>';
      const availableColors = window.productVariants
              .filter(v => v.sizeId === sizeId)
              .map(v => ({ id: v.colorId, tenMau: v.mauSac }));
      const uniqueColors = [...new Set(availableColors.map(c => JSON.stringify(c)))].map(str => JSON.parse(str));
      uniqueColors.forEach(color => {
        const option = document.createElement('option');
        option.value = color.id;
        option.text = color.tenMau;
        if (color.id === selectedColor) option.selected = true;
        colorSelect.appendChild(option);
      });
    }

    // N·∫øu c·∫£ m√†u s·∫Øc v√† k√≠ch c·ª° ƒë∆∞·ª£c ch·ªçn, l·∫•y chi ti·∫øt bi·∫øn th·ªÉ
    if (colorId && sizeId) {
      const variantSpinner = document.getElementById('variantSpinner');
      if (variantSpinner) variantSpinner.style.display = 'block';

      try {
        const response = await fetch(`${BASE_URL}/product/variant?productId=${currentProductId}&colorId=${colorId}&sizeId=${sizeId}`);
        if (!response.ok) {
          let errorMessage = "L·ªói khi l·∫•y chi ti·∫øt bi·∫øn th·ªÉ.";
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorData.message || errorMessage;
          } catch (e) {
            errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();
        const variantPrice = document.getElementById('variantPrice');
        const variantStock = document.getElementById('variantStock');
        const variantQuantity = document.getElementById('variantQuantity');
        const variantDetails = document.getElementById('variantDetails');

        if (variantPrice) variantPrice.innerText = data.price.toLocaleString('vi-VN') + ' VNƒê';
        if (variantStock) variantStock.innerText = data.stockQuantity;
        if (variantQuantity) {
          variantQuantity.max = data.stockQuantity; // S·ª≠ d·ª•ng 100% stockQuantity
          variantQuantity.value = 1;
        }
        if (variantDetails) {
          variantDetails.style.display = 'block';
          variantDetails.dataset.productDetailId = data.productDetailId;
        }
      } catch (error) {
        showToast('L·ªói khi l·∫•y chi ti·∫øt bi·∫øn th·ªÉ: ' + error.message, 'error');
        const variantDetails = document.getElementById('variantDetails');
        if (variantDetails) variantDetails.style.display = 'none';
      } finally {
        if (variantSpinner) variantSpinner.style.display = 'none';
      }
    } else {
      const variantDetails = document.getElementById('variantDetails');
      if (variantDetails) variantDetails.style.display = 'none';
    }
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    const cashInput = document.getElementById('cashAmount');
    if (cashInput) {
      cashInput.addEventListener('input', () => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.cashAmount = parseFloat(cashInput.value) || 0;
          updateSummary(tab);
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
      });
    }

    const customerPhone = document.getElementById('customerPhone');
    if (customerPhone) {
      customerPhone.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          fetchCustomerAddresses();
        }
      });
    }

    const addressSelect = document.getElementById('addressSelect');
    if (addressSelect) {
      addressSelect.addEventListener('change', () => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          tab.selectedAddress = addressSelect.value;
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
        }
      });
    }

    const shippingFee = document.getElementById('shippingFee');
    if (shippingFee) {
      shippingFee.addEventListener('input', () => {
        const tab = tabs.find(t => t.id === currentTabId);
        if (tab) {
          let value = parseFloat(shippingFee.value) || 0;
          if (value < 0) value = 0;
          shippingFee.value = value;
          tab.shippingFee = value;
          updateSummary(tab);
          localStorage.setItem('orderTabs', JSON.stringify(tabs));
          if (tab.voucherId) {
            applyVoucher(tab.voucherId);
          }
        }
      });
    }

    const addTabBtn = document.getElementById('addTabBtn');
    if (addTabBtn) {
      addTabBtn.addEventListener('click', addNewTab);
    }

    const voucherSelect = document.getElementById('voucherSelect');
    if (voucherSelect) {
      voucherSelect.addEventListener('change', (e) => {
        applyVoucher(e.target.value || null);
      });
    }

    // Kh·ªüi t·∫°o khi trang load
    initTabs();
  });
</script>
</body>
</html>
