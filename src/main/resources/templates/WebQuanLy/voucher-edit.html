<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chỉnh Sửa Phiếu Giảm Giá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <style>
        .form-label {
            font-weight: 500;
            color: #333;
        }
        .form-control, .form-select {
            border-radius: 0.375rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .btn-primary, .btn-secondary {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 0.375rem;
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .table-responsive {
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .input-group-text {
            background-color: #f8f9fa;
            border-radius: 0 0.375rem 0.375rem 0;
        }
        .form-check-label {
            cursor: pointer;
        }
        .content {
            padding: 2rem;
            margin-left: 256px;
            margin-top: 70px;
        }
        .sticky-header {
            position: sticky;
            top: 60px; /* Sát lên trên hơn so với 70px */
            z-index: 1000;
            background-color: #fff;
            padding: 0.75rem 2rem; /* Giảm padding trên/dưới để sát hơn */
            margin: -2rem -2rem 1rem -2rem; /* Bù padding của .content */
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: center; /* Căn giữa tiêu đề */
            align-items: center;
        }
        .sticky-header h2 {
            font-weight: bold; /* Tô đậm tiêu đề */
            margin: 0;
        }
    </style>
    <script th:src="@{/js/sidebar.js}" defer></script>
</head>
<body class="bg-light">
<div class="d-flex">
    <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>

    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
        <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </nav>

    <div class="content" id="content">
        <!-- Toasts -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
            <div class="toast align-items-center text-bg-success border-0" role="alert" id="successToast" aria-live="assertive" aria-atomic="true" th:if="${successMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        <span th:text="${successMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-danger border-0" role="alert" id="errorToast" aria-live="assertive" aria-atomic="true" th:if="${errorMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span th:text="${errorMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-info border-0" role="alert" id="infoToast" aria-live="assertive" aria-atomic="true" th:if="${mailMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-info-circle me-2"></i>
                        <span th:text="${mailMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="sticky-header">
            <h2><i class="fas fa-ticket-alt me-2"></i>Chỉnh Sửa Phiếu Giảm Giá</h2>
        </div>

        <!-- Form -->
        <div class="bg-white p-4 rounded shadow-sm">
            <form id="editVoucherForm" th:action="@{'/acvstore/phieu-giam-gia/edit/' + ${voucher.id}}" th:object="${voucher}" method="post">
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-barcode me-2"></i>Mã phiếu:</label>
                    <input type="text" th:field="*{ma}" class="form-control" readonly/>
                </div>

                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-tag me-2"></i>Tên phiếu:</label>
                    <input type="text" th:field="*{ten}" class="form-control" required placeholder="Tên phiếu giảm giá"/>
                </div>

                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-percentage me-2"></i>Kiểu giảm:</label>
                    <div>
                        <label class="form-check-label me-3">
                            <input type="radio" th:field="*{loai}" value="PERCENT" onchange="toggleDiscountFields()"> Giảm theo %
                        </label>
                        <label class="form-check-label">
                            <input type="radio" th:field="*{loai}" value="CASH" onchange="toggleDiscountFields()"> Giảm theo tiền mặt
                        </label>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Giá trị giảm:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="giaTriGiam" name="giaTriGiam"
                                   th:value="${giaTriGiamStr}" oninput="this.value=this.value.replace(/[^0-9,]/g,'')" placeholder="0">
                            <span class="input-group-text" id="discountUnit">%</span>
                        </div>
                    </div>
                    <div class="col-md-6" id="maxDiscountGroup">
                        <label class="form-label">Giá trị giảm tối đa:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="giaTriGiamToiDa" name="giaTriGiamToiDa"
                                   th:value="${giaTriGiamToiDaStr}" oninput="this.value=this.value.replace(/[^0-9,]/g,'')" placeholder="0">
                            <span class="input-group-text">₫</span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-users me-2"></i>Loại phiếu:</label>
                    <div>
                        <label class="form-check-label me-3">
                            <input type="radio" th:field="*{kieuPhieu}" value="cong_khai" onclick="toggleUsageCount()"> Công khai
                        </label>
                        <label class="form-check-label">
                            <input type="radio" th:field="*{kieuPhieu}" value="ca_nhan" onclick="toggleUsageCount()"> Cá nhân
                        </label>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Lượt sử dụng:</label>
                        <input type="text" class="form-control" id="gioiHanSuDung" name="gioiHanSuDung"
                               th:value="${gioiHanSuDungStr}" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,'')" placeholder="Số lượt sử dụng">
                        <small class="text-muted" id="caNhanNote" style="display: none;">* Phiếu cá nhân chỉ áp dụng 1 lượt sử dụng</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Đơn tối thiểu áp dụng:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="giaTriGiamToiThieu" name="giaTriGiamToiThieu"
                                   th:value="${giaTriGiamToiThieuStr}" oninput="this.value=this.value.replace(/[^0-9,]/g,'')" placeholder="0">
                            <span class="input-group-text">₫</span>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>Ngày bắt đầu:</label>
                        <input type="date" th:field="*{ngayBatDau}" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-calendar-check me-2"></i>Ngày kết thúc:</label>
                        <input type="date" th:field="*{ngayKetThuc}" class="form-control">
                    </div>
                </div>

                <div id="customerSelection" class="mb-3">
                    <label class="form-label"><i class="fas fa-user-check me-2"></i>Chọn khách hàng áp dụng:</label>
                    <input type="text" class="form-control mb-2" id="searchCustomerInput" placeholder="Tìm kiếm theo tên, email, SĐT...">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                        <label class="form-check-label" for="selectAllCheckbox">Chọn tất cả</label>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover align-middle bg-white">
                            <thead class="table-light">
                            <tr>
                                <th>Chọn</th>
                                <th>Họ tên</th>
                                <th>Email</th>
                                <th>SĐT</th>
                            </tr>
                            </thead>
                            <tbody id="customerTableBody">
                            <tr th:each="customer : ${customers}" th:if="${customer != null}">
                                <td><input type="checkbox" name="selectedCustomerIds" th:value="${customer.id}"
                                           th:checked="${selectedCustomerIds != null and selectedCustomerIds.contains(customer.id)}"/></td>
                                <td th:text="${customer.hoTen}"></td>
                                <td th:text="${customer.email}"></td>
                                <td th:text="${customer.soDienThoai}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-end mt-2">
                        <nav>
                            <ul class="pagination">
                                <li class="page-item" th:classappend="${currentCustomerPage == 0} ? 'disabled'">
                                    <a class="page-link"
                                       th:href="@{'/acvstore/phieu-giam-gia/edit/' + ${voucher.id} + '?page=' + ${currentCustomerPage - 1} + '&search=' + ${search}}"
                                       aria-label="Previous"><span aria-hidden="true">«</span></a>
                                </li>
                                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalCustomerPages - 1)}"
                                    th:classappend="${i == currentCustomerPage} ? 'active'">
                                    <a class="page-link"
                                       th:href="@{'/acvstore/phieu-giam-gia/edit/' + ${voucher.id} + '?page=' + ${i} + '&search=' + ${search}}"
                                       th:text="${i + 1}"></a>
                                </li>
                                <li class="page-item" th:classappend="${currentCustomerPage + 1 >= totalCustomerPages} ? 'disabled'">
                                    <a class="page-link"
                                       th:href="@{'/acvstore/phieu-giam-gia/edit/' + ${voucher.id} + '?page=' + ${currentCustomerPage + 1} + '&search=' + ${search}}"
                                       aria-label="Next"><span aria-hidden="true">»</span></a>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="sendMail" name="sendMail">
                        <label class="form-check-label" for="sendMail">Gửi Email cho khách hàng</label>
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary me-2"><i class="fas fa-save me-2"></i>Lưu thay đổi</button>
                    <a th:href="@{/acvstore/phieu-giam-gia}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Quay lại</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function formatNumberVN(value, allowDecimal) {
        if (!value) return '';
        value = value.replace(/[^\d,]/g, '').replace(/\./g, '').replace(/,/g, '.');
        let number = parseFloat(value);
        if (isNaN(number)) return '';
        return number.toLocaleString('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: allowDecimal ? 2 : 0
        });
    }

    function parseNumber(value) {
        return value.replace(/[.,]/g, '');
    }

    $(document).ready(function () {
        toggleDiscountFields();
        toggleUsageCount();

        $('input[name="loai"]').on('change', toggleDiscountFields);
        $('input[name="kieuPhieu"]').on('change', toggleUsageCount);

        $('#searchCustomerInput').on('keyup', function () {
            const keyword = $(this).val().toLowerCase();
            $('#customerTableBody tr').each(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(keyword) > -1);
            });
        });

        const fields = [
            { id: '#giaTriGiam', allowDecimal: true },
            { id: '#giaTriGiamToiDa', allowDecimal: true },
            { id: '#giaTriGiamToiThieu', allowDecimal: true },
            { id: '#gioiHanSuDung', allowDecimal: false }
        ];

        fields.forEach(function (field) {
            $(field.id).on('blur', function () {
                const formatted = formatNumberVN($(this).val(), field.allowDecimal);
                $(this).val(formatted);
            });
        });

        $('form').on('submit', function (e) {
            if (!confirm('Bạn có chắc chắn muốn lưu thay đổi không?')) {
                e.preventDefault();
                return false;
            }
            fields.forEach(function (field) {
                const $el = $(field.id);
                $el.val(parseNumber($el.val()));
            });
        });

        $('#selectAllCheckbox').on('change', function () {
            const checked = $(this).is(':checked');
            $('#customerTableBody input[type="checkbox"]').prop('checked', checked);
        });

        // Hiển thị toast nếu có
        const toastEl = document.getElementById('successToast');
        if (toastEl) new bootstrap.Toast(toastEl).show();
        const errorToastEl = document.getElementById('errorToast');
        if (errorToastEl) new bootstrap.Toast(errorToastEl).show();
        const infoToastEl = document.getElementById('infoToast');
        if (infoToastEl) new bootstrap.Toast(infoToastEl).show();
    });

    function toggleDiscountFields() {
        const type = $('input[name="loai"]:checked').val();
        const isPercent = type === 'PERCENT';
        $('#discountUnit').text(isPercent ? '%' : '₫');
        $('#maxDiscountGroup').toggle(isPercent);
        $('#giaTriGiamToiDa').prop('readonly', !isPercent);
        if (!isPercent) $('#giaTriGiamToiDa').val('');
    }

    function toggleUsageCount() {
        const isCaNhan = $('input[name="kieuPhieu"]:checked').val() === 'ca_nhan';
        $('#customerSelection').toggle(isCaNhan);
        $('#caNhanNote').toggle(isCaNhan);
        const $luot = $('#gioiHanSuDung');

        if (isCaNhan) {
            $luot.val('1').prop('readonly', true);
        } else {
            $luot.prop('readonly', false);
        }
    }
</script>
</body>
</html>