<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <!-- Tiêu đề động theo trạng thái -->
    <title th:text="${(getStatus != null and voucher != null and getStatus.apply(voucher) == 'Sắp diễn ra') ? 'Chỉnh Sửa Phiếu Giảm Giá' : 'Xem Chi Tiết Phiếu Giảm Giá'}">Chỉnh Sửa Phiếu Giảm Giá</title>

    <!-- Libs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

    <!-- Style -->
    <style>
        :root{
            --primary:#153054;
            --secondary:#9FD5F7;
            --text:#263238;
            --line:#e9ecef;
        }
        body{background:#f6f9fb;color:var(--text)}
        .content{padding:2rem;margin-left:256px;margin-top:70px}
        .sticky-header{position:sticky;top:70px;z-index:1000;background:#fff;padding:1rem 2rem;margin:-2rem -2rem 1rem -2rem;border-bottom:1px solid var(--line);display:flex;justify-content:center;align-items:center}
        .sticky-header h2{font-weight:700;margin:0;color:var(--primary)}
        .alert-warning{border:1px solid #ffe69c}
        .card-section{border:1px solid var(--line);border-radius:.75rem;background:#fff;overflow:hidden}
        .card-section .card-header{background:rgba(159,213,247,.25);border-bottom:1px solid var(--line);font-weight:600;color:var(--primary);display:flex;align-items:center;gap:.5rem}
        .card-section .card-body{padding:1rem 1.25rem}
        .form-label{font-weight:600;color:#334155}
        .form-control,.form-select{border-radius:.5rem;border:1px solid #dfe3e8;transition:border-color .2s,box-shadow .2s}
        .form-control:focus,.form-select:focus{border-color:var(--secondary);box-shadow:0 0 0 .25rem rgba(159,213,247,.45)}
        .input-group-text{background:#f8fbfe;border-color:#dfe3e8}
        .btn-primary{--bs-btn-bg:var(--primary);--bs-btn-border-color:var(--primary);--bs-btn-hover-bg:#102845;--bs-btn-hover-border-color:#102845}
        .btn-secondary{--bs-btn-bg:var(--secondary);--bs-btn-border-color:var(--secondary);--bs-btn-color:#0b2a45;--bs-btn-hover-bg:#8bcdf5;--bs-btn-hover-border-color:#8bcdf5}
        .table-responsive{border-radius:.5rem;overflow:hidden}
        .table th,.table td{vertical-align:middle}
        .invalid-feedback{display:none;color:#dc3545;font-size:.875rem}
        .is-invalid ~ .invalid-feedback{display:block}
        .select2-container--default .select2-selection--multiple{
            border:1px solid #dfe3e8;border-radius:.5rem;min-height:42px;padding:2px 6px;display:flex;align-items:center;gap:4px
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice{
            background:var(--secondary)!important;color:#0b2a45;border:0;border-radius:999px;padding:2px 8px;font-weight:600
        }
        .select2-container--default .select2-results__option--highlighted{background:var(--secondary)!important;color:#0b2a45!important}
        input[type="radio"],input[type="checkbox"]{accent-color:var(--primary)}
        .badge-state{font-size:.85rem}

        /* ---- Border đỏ cho Select2 khi lỗi PTTT ---- */
        .select2-container--default .select2-selection--multiple.is-invalid-s2{
            border-color:#dc3545 !important;
            box-shadow:0 0 0 .25rem rgba(220,53,69,.25) !important;
        }
    </style>

    <!-- JS libs -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script th:src="@{/js/sidebar.js}" defer></script>
    <script th:src="@{/js/notification.js}"></script>
</head>
<body class="bg-light">
<!-- Tính trạng thái 1 lần từ SERVER (voucher hiện có) -->
<div class="d-flex" th:with="st=${(getStatus != null and voucher != null) ? getStatus.apply(voucher) : 'Không xác định'}" th:attr="data-st=${st}">

    <!-- Sidebar + Navbar -->
    <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>
    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
        <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </nav>

    <div class="content" id="content">
        <!-- Toasts -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080">
            <div class="toast align-items-center text-bg-success border-0" role="alert" id="successToast" aria-live="assertive" aria-atomic="true" th:if="${successMessage}">
                <div class="d-flex">
                    <div class="toast-body"><i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-danger border-0" role="alert" id="errorToast" aria-live="assertive" aria-atomic="true" th:if="${errorMessage}">
                <div class="d-flex">
                    <div class="toast-body"><i class="fas fa-exclamation-triangle me-2"></i><span th:utext="${errorMessage}"></span></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-info border-0" role="alert" id="infoToast" aria-live="assertive" aria-atomic="true" th:if="${mailMessage}">
                <div class="d-flex">
                    <div class="toast-body"><i class="fas fa-info-circle me-2"></i><span th:text="${mailMessage}"></span></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="sticky-header d-flex align-items-center justify-content-between">
            <h2 class="mb-0">
                <i class="fas fa-ticket-alt me-2"></i>
                <span th:text="${st == 'Sắp diễn ra'} ? 'Chỉnh Sửa Phiếu Giảm Giá' : 'Xem Chi Tiết Phiếu Giảm Giá'">Chỉnh Sửa Phiếu Giảm Giá</span>
            </h2>
            <span class="badge badge-state"
                  th:classappend="${st=='Sắp diễn ra'} ? ' text-bg-warning' : (${st=='Đang diễn ra'} ? ' text-bg-success' : (${st=='Đã kết thúc'} ? ' text-bg-secondary' : ' text-bg-light'))"
                  th:text="${st}">Trạng thái</span>
        </div>

        <!-- Cảnh báo khi không ở trạng thái cho phép -->
        <div th:if="${st != 'Sắp diễn ra'}" class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <div>Phiếu đang ở trạng thái <strong th:text="${st}">Không xác định</strong> — không thể chỉnh sửa.</div>
        </div>

        <!-- Form chỉnh sửa -->
        <div class="bg-white p-4 rounded shadow-sm">
            <form id="editVoucherForm"
                  th:action="@{'/acvstore/phieu-giam-gia/edit/' + ${voucher.id}}"
                  th:object="${voucher}"
                  method="post" novalidate>

                <div class="row g-4">
                    <!-- 1) THÔNG TIN CƠ BẢN -->
                    <div class="col-12">
                        <div class="card-section mb-2">
                            <div class="card-header">
                                <i class="fa-regular fa-rectangle-list"></i>
                                <span>Thông tin cơ bản</span>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="fas fa-barcode me-2"></i>Mã phiếu:</label>
                                        <input type="text" th:field="*{ma}" id="ma" class="form-control" readonly/>
                                        <div class="invalid-feedback" id="maError"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="fas fa-tag me-2"></i>Tên phiếu:</label>
                                        <input type="text" th:field="*{ten}" id="ten" class="form-control"
                                               th:readonly="${st != 'Sắp diễn ra'}" required placeholder="Tên phiếu giảm giá"/>
                                        <div class="invalid-feedback" id="tenError"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>Ngày bắt đầu:</label>
                                        <input type="datetime-local" th:field="*{ngayBatDau}" class="form-control" id="ngayBatDau"
                                               th:readonly="${st != 'Sắp diễn ra'}" required/>
                                        <div class="invalid-feedback" id="ngayBatDauError"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>Ngày kết thúc:</label>
                                        <input type="datetime-local" th:field="*{ngayKetThuc}" class="form-control" id="ngayKetThuc"
                                               th:readonly="${st != 'Sắp diễn ra'}" required/>
                                        <div class="invalid-feedback" id="ngayKetThucError"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2) PHẠM VI & KIỂU GIẢM -->
                    <div class="col-12">
                        <div class="card-section">
                            <div class="card-header">
                                <i class="fa-solid fa-sliders"></i>
                                <span>Phạm vi áp dụng & Kiểu giảm</span>
                            </div>
                            <div class="card-body">
                                <!-- Phạm vi (LOCKED) -->
                                <div class="mb-3" id="scopeGroup" data-locked="true">
                                    <!-- giữ giá trị để submit vì radio disabled -->
                                    <input type="hidden" name="phamViApDung" th:value="*{phamViApDung}" id="scopeLockedVal"/>
                                    <label class="form-label"><i class="fas fa-truck me-2"></i>Phạm vi áp dụng:</label>
                                    <div class="d-flex flex-wrap gap-4">
                                        <label class="form-check-label">
                                            <input type="radio" th:field="*{phamViApDung}" value="ORDER"
                                                   onchange="toggleScopeFields()" disabled> Giảm giá đơn hàng
                                        </label>
                                        <label class="form-check-label">
                                            <input type="radio" th:field="*{phamViApDung}" value="SHIPPING"
                                                   onchange="toggleScopeFields()" disabled> Giảm phí vận chuyển
                                        </label>
                                    </div>
                                </div>

                                <!-- Kiểu freeship (SHIPPING) -->
                                <div class="mb-3" id="shipTypeGroup"
                                     th:style="${voucher.phamViApDung == 'SHIPPING' ? 'display:block' : 'display:none'}">
                                    <label class="form-label"><i class="fas fa-truck-fast me-2"></i>Kiểu freeship:</label>
                                    <div class="d-flex flex-wrap gap-4">
                                        <label class="form-check-label">
                                            <input type="radio" th:field="*{loai}" value="FREESHIP_FULL"
                                                   onchange="toggleDiscountFields()"
                                                   th:disabled="${st != 'Sắp diễn ra'}"> Miễn phí ship toàn phần
                                        </label>
                                        <label class="form-check-label">
                                            <input type="radio" th:field="*{loai}" value="FREESHIP_CAP"
                                                   onchange="toggleDiscountFields()"
                                                   th:disabled="${st != 'Sắp diễn ra'}"> Miễn phí ship tối đa X VND
                                        </label>
                                    </div>
                                </div>

                                <!-- Kiểu giảm (ORDER) -->
                                <div class="mb-3" id="discountTypeGroup"
                                     th:style="${voucher.phamViApDung == 'ORDER' ? 'display:block' : 'display:none'}">
                                    <label class="form-label"><i class="fas fa-percentage me-2"></i>Kiểu giảm:</label>
                                    <div class="d-flex flex-wrap gap-4">
                                        <label class="form-check-label" id="percentOption">
                                            <input type="radio" th:field="*{loai}" value="PERCENT"
                                                   onchange="toggleDiscountFields()"
                                                   th:disabled="${st != 'Sắp diễn ra'}"> Giảm theo %
                                        </label>
                                        <label class="form-check-label" id="cashOption">
                                            <input type="radio" th:field="*{loai}" value="CASH"
                                                   onchange="toggleDiscountFields()"
                                                   th:disabled="${st != 'Sắp diễn ra'}"> Giảm theo tiền mặt
                                        </label>
                                    </div>
                                </div>

                                <!-- Giá trị giảm -->
                                <div class="row g-3">
                                    <div class="col-md-6" id="discountValueGroup"
                                         th:style="${voucher.loai == 'FREESHIP_FULL' ? 'display:none' : 'display:block'}">
                                        <label class="form-label">Giá trị giảm:</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="giaTriGiam" name="giaTriGiam"
                                                   th:value="${voucher.loai == 'FREESHIP_FULL' ? '0' : (giaTriGiamStr)}"
                                                   th:readonly="${st != 'Sắp diễn ra' || voucher.loai == 'FREESHIP_CAP'}"
                                                   inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9,]/g,'')" placeholder="0">
                                            <span class="input-group-text" id="discountUnit"
                                                  th:text="${voucher.loai == 'PERCENT' ? '%' : (voucher.loai == 'FREESHIP_FULL' ? '' : 'VND')}">%</span>
                                        </div>
                                        <div class="invalid-feedback" id="giaTriGiamError"></div>
                                    </div>

                                    <div class="col-md-6" id="maxDiscountGroup"
                                         th:style="${(voucher.loai == 'PERCENT' or voucher.loai == 'FREESHIP_CAP') ? 'display:block' : 'display:none'}">
                                        <label class="form-label">Giá trị giảm tối đa:</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="giaTriGiamToiDa" name="giaTriGiamToiDa"
                                                   th:value="${giaTriGiamToiDaStr}"
                                                   th:readonly="${st != 'Sắp diễn ra'}"
                                                   inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9,]/g,'')" placeholder="0">
                                            <span class="input-group-text">VND</span>
                                        </div>
                                        <div class="invalid-feedback" id="giaTriGiamToiDaError"></div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Đơn tối thiểu áp dụng:</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="giaTriGiamToiThieu" name="giaTriGiamToiThieu"
                                                   th:value="${giaTriGiamToiThieuStr}"
                                                   th:readonly="${st != 'Sắp diễn ra'}"
                                                   inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9,]/g,'')" placeholder="0">
                                            <span class="input-group-text">VND</span>
                                        </div>
                                        <div class="invalid-feedback" id="giaTriGiamToiThieuError"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3) LOẠI PHIẾU & LƯỢT SỬ DỤNG -->
                    <div class="col-12">
                        <div class="card-section">
                            <div class="card-header">
                                <i class="fa-solid fa-id-badge"></i>
                                <span>Loại phiếu & Lượt sử dụng</span>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-lg-6">
                                        <label class="form-label"><i class="fas fa-users me-2"></i>Loại phiếu:</label>
                                        <div class="d-flex flex-wrap gap-4">
                                            <label class="form-check-label">
                                                <input type="radio" th:field="*{kieuPhieu}" value="cong_khai"
                                                       onchange="toggleUsageCount('cong_khai', true)"
                                                       th:disabled="${st != 'Sắp diễn ra'}"> Công khai
                                            </label>
                                            <label class="form-check-label">
                                                <input type="radio" th:field="*{kieuPhieu}" value="ca_nhan"
                                                       onchange="toggleUsageCount('ca_nhan', true)"
                                                       th:disabled="${st != 'Sắp diễn ra'}"> Cá nhân
                                            </label>

                                        </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <label class="form-label">Lượt sử dụng:</label>
                                        <input type="text" th:field="*{gioiHanSuDung}" class="form-control" id="gioiHanSuDung"
                                               th:readonly="${(st != 'Sắp diễn ra') or (voucher.kieuPhieu != 'cong_khai')}"
                                               inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,'')" placeholder="Số lượt sử dụng">
                                        <small class="text-muted" id="caNhanNote" th:style="${voucher.kieuPhieu == 'ca_nhan' ? 'display:block' : 'display:none'}">* Phiếu cá nhân chỉ áp dụng 1 lượt sử dụng</small>
                                        <div class="invalid-feedback" id="gioiHanSuDungError"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4) PHƯƠNG THỨC THANH TOÁN ÁP DỤNG -->
                    <div class="col-12">
                        <div class="card-section">
                            <div class="card-header">
                                <i class="fas fa-credit-card"></i>
                                <span>Phương thức thanh toán áp dụng</span>
                            </div>
                            <div class="card-body">
                                <select id="paymentMethodSelect" class="form-select" name="selectedPtttIds" multiple
                                        th:disabled="${st != 'Sắp diễn ra'}">
                                    <option value="all">Tất cả</option>
                                    <option th:each="pt : ${phuongThucList}"
                                            th:value="${pt.id}"
                                            th:text="${pt.tenPhuongThuc}"
                                            th:selected="${selectedPtttIds != null and selectedPtttIds.contains(pt.id)}">
                                    </option>
                                </select>
                                <!-- Thông báo lỗi PTTT bắt buộc -->
                                <div id="ptttError" class="text-danger small mt-1 d-none">
                                    vui lòng chọn ít nhất 1 pttt khi chưa chọn
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5) KHÁCH HÀNG (chỉ hiện khi phiếu cá nhân) -->
                    <div class="col-12" th:if="${voucher.kieuPhieu == 'ca_nhan'}">
                        <div class="card-section" id="customerSection">
                            <div class="card-header">
                                <i class="fa-solid fa-user-check"></i>
                                <span>Khách hàng áp dụng & Thông báo</span>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="searchCustomerInput"
                                               placeholder="Tìm kiếm theo tên, email, SĐT..."
                                               th:disabled="${st != 'Sắp diễn ra'}">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-center">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllCustomers"
                                                   th:disabled="${st != 'Sắp diễn ra'}">
                                            <label class="form-check-label" for="selectAllCustomers">Chọn tất cả</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive mt-3">
                                    <table class="table table-bordered table-hover align-middle bg-white table-sm">
                                        <thead class="table-light">
                                        <tr>
                                            <th style="width:80px">Chọn</th>
                                            <th>Họ tên</th>
                                            <th>Email</th>
                                            <th>SĐT</th>
                                        </tr>
                                        </thead>
                                        <tbody id="customerTableBody">
                                        <tr th:each="customer : ${customers}" th:if="${customer != null}">
                                            <td>
                                                <input type="checkbox" name="selectedCustomerIds" th:value="${customer.id}"
                                                       class="customerCheckbox"
                                                       th:checked="${selectedCustomerIds != null and selectedCustomerIds.contains(customer.id)}"
                                                       th:disabled="${st != 'Sắp diễn ra'}"/>
                                            </td>
                                            <td th:text="${customer.hoTen}"></td>
                                            <td th:text="${customer.email}"></td>
                                            <td th:text="${customer.soDienThoai}"></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        Trang <strong th:text="${currentCustomerPage + 1}"></strong>/<strong th:text="${totalCustomerPages}"></strong>
                                    </small>
                                    <nav>
                                        <ul class="pagination pagination-sm mb-0">
                                            <li class="page-item" th:classappend="${currentCustomerPage == 0} ? 'disabled'">
                                                <a class="page-link"
                                                   th:href="@{'/acvstore/phieu-giam-gia/edit/' + ${voucher.id} + '?page=' + ${currentCustomerPage - 1} + '&search=' + ${search}}"
                                                   aria-label="Previous"><i class="fas fa-chevron-left"></i></a>
                                            </li>
                                            <li class="page-item"
                                                th:each="i : ${#numbers.sequence(0, totalCustomerPages - 1)}"
                                                th:classappend="${i == currentCustomerPage} ? 'active'">
                                                <a class="page-link"
                                                   th:href="@{'/acvstore/phieu-giam-gia/edit/' + ${voucher.id} + '?page=' + ${i} + '&search=' + ${search}}"
                                                   th:text="${i + 1}"></a>
                                            </li>
                                            <li class="page-item" th:classappend="${currentCustomerPage + 1 >= totalCustomerPages} ? 'disabled'">
                                                <a class="page-link"
                                                   th:href="@{'/acvstore/phieu-giam-gia/edit/' + ${voucher.id} + '?page=' + ${currentCustomerPage + 1} + '&search=' + ${search}}"
                                                   aria-label="Next"><i class="fas fa-chevron-right"></i></a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>

                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="sendMail" name="sendMail"
                                           th:disabled="${st != 'Sắp diễn ra'}">
                                    <label class="form-check-label" for="sendMail">Gửi Email cho khách hàng</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-primary me-2" th:if="${st == 'Sắp diễn ra'}" onclick="validateForm()">
                        <i class="fas fa-save me-2"></i>Lưu thay đổi
                    </button>
                    <a th:href="@{/acvstore/phieu-giam-gia}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Quay lại</a>
                </div>
            </form>
        </div>

        <!-- Modal xác nhận -->
<!--        <div class="modal fade" id="confirmEditModal" tabindex="-1" aria-labelledby="confirmEditModalLabel" aria-hidden="true">-->
<!--            <div class="modal-dialog modal-dialog-centered">-->
<!--                <div class="modal-content">-->
<!--                    <div class="modal-header">-->
<!--                        <h5 class="modal-title" id="confirmEditModalLabel">Xác nhận lưu thay đổi</h5>-->
<!--                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--                    </div>-->
<!--                    <div class="modal-body">Bạn có chắc chắn muốn lưu các thay đổi của phiếu này không?</div>-->
<!--                    <div class="modal-footer">-->
<!--                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>-->
<!--                        <button type="button" class="btn btn-primary" id="confirmSubmit">Xác nhận</button>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

    </div> <!-- /content -->
</div> <!-- /with st -->

<!-- Scripts -->
<script>
    /* ===== Helpers ===== */
    function formatNumber(value, allowDecimal) {
        if (!value) return '';
        value = value.replace(/[^\d,]/g, '').replace(/\./g, '').replace(/,/g, '.');
        let number = parseFloat(value);
        if (isNaN(number)) return '';
        return new Intl.NumberFormat('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: allowDecimal ? 2 : 0
        }).format(number);
    }
    function parseNumber(v){ return (v || '').replace(/[.,]/g,''); }
    function showToast(id){
        const el = document.getElementById(id);
        if (el){ new bootstrap.Toast(el, { delay: 5000 }).show(); }
    }
    function updateSelectAllCheckbox() {
        const all = $('.customerCheckbox:visible').length;
        const checked = $('.customerCheckbox:visible:checked').length;
        $('#selectAllCustomers').prop('checked', all>0 && all===checked);
    }
    function setMinNowForDatetimeInputs(){
        // set min theo giờ local (tránh nhập quá khứ)
        const now = new Date();
        const tzOffsetMs = now.getTimezoneOffset()*60000;
        const localISO = new Date(now - tzOffsetMs).toISOString().slice(0,16); // yyyy-MM-ddTHH:mm
        ['#ngayBatDau','#ngayKetThuc'].forEach(sel=>{
            const el = document.querySelector(sel);
            if (el && !el.readOnly) el.setAttribute('min', localISO);
        });
    }

    /* ===== Chuẩn hoá & validate tên ===== */
    function normalizeNameOnce(str){
        if (typeof str !== 'string') return '';
        const trimmed = str.trim();
        return trimmed.replace(/\s+/g,' ');
    }
    function validateNameValue(name){
        if (!name) return 'Tên phiếu không được để trống.';
        if (name !== name.trim()) return 'Không cho phép khoảng trắng ở đầu hoặc cuối.';
        if (/\s{2,}/.test(name)) return 'Giữa các từ chỉ được 1 khoảng trắng.';
        if (!/^[\p{L}]+(?: [\p{L}]+)*$/u.test(name)) return 'Tên chỉ gồm chữ (có dấu), giữa các từ cách đúng 1 khoảng, không số/ký tự đặc biệt.';
        const nonSpaceLen = name.replace(/\s+/g,'').length;
        if (nonSpaceLen < 6) return 'Tên phải có ít nhất 6 ký tự (không tính khoảng trắng).';
        return null;
    }

    /* ===== Toggles ===== */
    function toggleScopeFields() {
        if ($('#scopeGroup').data('locked') === true) return;
        const scope = $('input[name="phamViApDung"]:checked').val();
        const isShipping = scope === 'SHIPPING';
        $('#shipTypeGroup').toggle(isShipping);
        $('#discountTypeGroup').toggle(!isShipping);

        if (isShipping && !$('input[name="loai"]:checked').length) {
            $('input[name="loai"][value="FREESHIP_FULL"]').prop('checked', true);
        }
        if (!isShipping && !$('input[name="loai"]:checked').length) {
            $('input[name="loai"][value="CASH"]').prop('checked', true);
        }
        toggleDiscountFields();
    }

    function toggleDiscountFields() {
        const type = $('input[name="loai"]:checked').val();
        const isPercent = type === 'PERCENT';
        const isFreeshipFull = type === 'FREESHIP_FULL';
        const isFreeshipCap  = type === 'FREESHIP_CAP';

        $('#discountUnit').text(isPercent ? '%' : 'VND');

        if (isFreeshipFull){
            $('#discountValueGroup').addClass('d-none');
            $('#giaTriGiam').val('0').prop('readonly', true);
            $('#maxDiscountGroup').addClass('d-none');
            $('#giaTriGiamToiDa').val('').prop('readonly', true);
        } else if (isFreeshipCap){
            $('#discountValueGroup').addClass('d-none');
            $('#giaTriGiam').val('0').prop('readonly', true);
            $('#maxDiscountGroup').removeClass('d-none');
            $('#giaTriGiamToiDa').prop('readonly', false);
        } else if (isPercent){
            $('#discountValueGroup').removeClass('d-none');
            $('#giaTriGiam').prop('readonly', false);
            $('#maxDiscountGroup').removeClass('d-none');
            $('#giaTriGiamToiDa').prop('readonly', false);
        } else { // CASH
            $('#discountValueGroup').removeClass('d-none');
            $('#giaTriGiam').prop('readonly', false);
            $('#maxDiscountGroup').addClass('d-none');
            $('#giaTriGiamToiDa').val('').prop('readonly', true);
        }
    }

    function toggleUsageCount(kieu, fromSwitch) {
        const checked = kieu ? kieu : ($('input[name="kieuPhieu"]:checked').val() || '');
        const isCaNhan = checked === 'ca_nhan';

        $('#customerSection').toggle(isCaNhan);

        const $luot = $('#gioiHanSuDung');

        if (isCaNhan) {
            $luot.val('1').prop('readonly', true).trigger('input');
            $('#caNhanNote').show();
        } else {
            $('#caNhanNote').hide();
            $luot.prop('readonly', false);
            if (fromSwitch === true) {
                $luot.val('').trigger('input');
            }
        }
    }

    /* ===== Validation (FE) ===== */
    function validateForm() {
        let isValid = true;
        $('.invalid-feedback').text('').hide();
        $('.form-control').removeClass('is-invalid');

        // reset lỗi PTTT
        $('#ptttError').addClass('d-none').text('');
        $('#paymentMethodSelect').next('.select2').find('.select2-selection').removeClass('is-invalid-s2');

        const ngayBatDauVal = $('#ngayBatDau').val();
        const ngayKetThucVal = $('#ngayKetThuc').val();

        const start = ngayBatDauVal ? new Date(ngayBatDauVal) : null;
        const end = ngayKetThucVal ? new Date(ngayKetThucVal) : null;
        const now = new Date();

        if (!start) {
            $('#ngayBatDau').addClass('is-invalid');
            $('#ngayBatDauError').text('Ngày bắt đầu không được để trống.').show();
            isValid = false;
        } else if (start < now) {
            $('#ngayBatDau').addClass('is-invalid');
            $('#ngayBatDauError').text('Ngày bắt đầu không được trước thời điểm hiện tại.').show();
            isValid = false;
        }

        if (!end) {
            $('#ngayKetThuc').addClass('is-invalid');
            $('#ngayKetThucError').text('Ngày kết thúc không được để trống.').show();
            isValid = false;
        } else if (end < now) {
            $('#ngayKetThuc').addClass('is-invalid');
            $('#ngayKetThucError').text('Ngày kết thúc không được trong quá khứ.').show();
            isValid = false;
        }

        if (start && end && start > end) {
            $('#ngayBatDau').addClass('is-invalid');
            $('#ngayBatDauError').text('Ngày bắt đầu phải trước hoặc bằng ngày kết thúc.').show();
            isValid = false;
        }

        // Validate TÊN
        const rawName = $('#ten').val() || '';
        const normalizedName = normalizeNameOnce(rawName);
        if (rawName !== normalizedName) {
            $('#ten').addClass('is-invalid');
            if (rawName !== rawName.trim()) {
                $('#tenError').text('Không cho phép khoảng trắng ở đầu hoặc cuối.').show();
            } else {
                $('#tenError').text('Giữa các từ chỉ được 1 khoảng trắng.').show();
            }
            isValid = false;
        } else {
            const msg = validateNameValue(normalizedName);
            if (msg) {
                $('#ten').addClass('is-invalid');
                $('#tenError').text(msg).show();
                isValid = false;
            }
        }

        const scope = $('#scopeLockedVal').val();
        const type = $('input[name="loai"]:checked').val();

        if (scope === 'ORDER' && !['PERCENT', 'CASH'].includes(type)) {
            $('#discountTypeGroup').find('input[type=radio]').addClass('is-invalid');
            alert('Phạm vi đang là GIẢM GIÁ ĐƠN HÀNG – chỉ được chọn kiểu PERCENT hoặc CASH.');
            isValid = false;
        }
        if (scope === 'SHIPPING' && !['FREESHIP_FULL', 'FREESHIP_CAP'].includes(type)) {
            $('#shipTypeGroup').find('input[type=radio]').addClass('is-invalid');
            alert('Phạm vi đang là GIẢM PHÍ VẬN CHUYỂN – chỉ được chọn FREESHIP_FULL hoặc FREESHIP_CAP.');
            isValid = false;
        }

        const giaTriGiam = parseFloat(parseNumber($('#giaTriGiam').val() || '0')) || 0;
        const giaTriGiamToiDa = parseFloat(parseNumber($('#giaTriGiamToiDa').val() || '0')) || 0;
        const giaTriGiamToiThieu = parseFloat(parseNumber($('#giaTriGiamToiThieu').val() || '0')) || 0;

        if (giaTriGiamToiThieu < 0) {
            $('#giaTriGiamToiThieu').addClass('is-invalid');
            $('#giaTriGiamToiThieuError').text('Đơn tối thiểu không được âm.').show();
            isValid = false;
        }

        if (scope === 'ORDER') {
            if (type === 'PERCENT' || type === 'CASH') {
                if (giaTriGiam <= 0) {
                    $('#giaTriGiam').addClass('is-invalid');
                    $('#giaTriGiamError').text('Giá trị giảm phải lớn hơn 0.').show();
                    isValid = false;
                }
                if (type === 'PERCENT') {
                    const raw = ($('#giaTriGiam').val() || '').trim();
                    if (/[.,]/.test(raw)) {
                        $('#giaTriGiam').addClass('is-invalid');
                        $('#giaTriGiamError').text('Giảm theo % phải là số nguyên.').show();
                        isValid = false;
                    }
                    if (giaTriGiam > 100) {
                        $('#giaTriGiam').addClass('is-invalid');
                        $('#giaTriGiamError').text('Giảm theo % không được vượt quá 100.').show();
                        isValid = false;
                    }
                    if (giaTriGiamToiDa <= 0) {
                        $('#giaTriGiamToiDa').addClass('is-invalid');
                        $('#giaTriGiamToiDaError').text('Giá trị giảm tối đa phải > 0 khi giảm theo %.').show();
                        isValid = false;
                    }
                    if (giaTriGiamToiThieu > 0 && giaTriGiamToiDa >= giaTriGiamToiThieu) {
                        $('#giaTriGiamToiDa').addClass('is-invalid');
                        $('#giaTriGiamToiDaError').text('Giá trị giảm tối đa phải nhỏ hơn Đơn tối thiểu áp dụng.').show();
                        isValid = false;
                    }
                } else { // CASH
                    if (giaTriGiamToiThieu > 0 && giaTriGiam >= giaTriGiamToiThieu) {
                        $('#giaTriGiam').addClass('is-invalid');
                        $('#giaTriGiamError').text('Giá trị giảm (tiền mặt) phải nhỏ hơn Đơn tối thiểu áp dụng.').show();
                        isValid = false;
                    }
                }
            }
        } else if (scope === 'SHIPPING') {
            if (type === 'FREESHIP_CAP') {
                if (giaTriGiamToiDa <= 0) {
                    $('#giaTriGiamToiDa').addClass('is-invalid');
                    $('#giaTriGiamToiDaError').text('Giá trị giảm tối đa phải > 0 cho FREESHIP_CAP.').show();
                    isValid = false;
                }
                if (giaTriGiamToiThieu > 0 && giaTriGiamToiDa >= giaTriGiamToiThieu) {
                    $('#giaTriGiamToiDa').addClass('is-invalid');
                    $('#giaTriGiamToiDaError').text('Giảm phí ship tối đa phải nhỏ hơn Đơn tối thiểu áp dụng.').show();
                    isValid = false;
                }
            }
        }

        // PTTT bắt buộc (bỏ 'all')
        const ptttChosen = ($('#paymentMethodSelect').val() || []).filter(v => v !== 'all');
        if (ptttChosen.length === 0) {
            $('#ptttError').text('vui lòng chọn ít nhất 1 pttt khi chưa chọn').removeClass('d-none');
            $('#paymentMethodSelect').next('.select2').find('.select2-selection').addClass('is-invalid-s2');
            isValid = false;
        }

        if (isValid) {
            Swal.fire({
                title: 'Xác nhận lưu thay đổi',
                text: 'Bạn có chắc chắn muốn lưu các thay đổi của phiếu này không?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Xác nhận',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#153054', // primary
                cancelButtonColor: '#9FD5F7',  // secondary
                reverseButtons: true,
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    // Chuẩn hoá số trước khi submit
                    ['#giaTriGiam', '#giaTriGiamToiDa', '#giaTriGiamToiThieu', '#gioiHanSuDung']
                        .forEach(sel => $(sel).val(parseNumber($(sel).val())));

                    // Bỏ 'all' trước khi submit
                    const selected = $('#paymentMethodSelect').val();
                    if (selected && selected.includes('all')) {
                        const allOptions = $('#paymentMethodSelect option').map(function () {
                            return $(this).val();
                        }).get().filter(v => v !== 'all');
                        $('#paymentMethodSelect').val(allOptions).trigger('change');
                    }

                    $('#editVoucherForm').trigger('submit');
                }
            });
        }
        return isValid;
    }

        /* ===== READY ===== */
    $(document).ready(function () {
        // Select2 + xử lý "all"
        $('#paymentMethodSelect').select2({
            placeholder: 'Chọn phương thức...',
            allowClear: true,
            closeOnSelect: false,
            width: '100%'
        }).on('change', function () {
            const selectedValues = $(this).val() || [];
            const allOptions = $('#paymentMethodSelect option').map(function(){return $(this).val();}).get().filter(v => v !== 'all');
            if (selectedValues.includes('all')) {
                $(this).val(allOptions).trigger('change.select2');
            } else if (selectedValues.length === allOptions.length) {
                $(this).val(['all'].concat(allOptions)).trigger('change.select2');
            }

            // clear lỗi PTTT khi hợp lệ
            const realChosen = ($(this).val() || []).filter(v => v !== 'all');
            if (realChosen.length > 0){
                $('#ptttError').addClass('d-none').text('');
                $('#paymentMethodSelect').next('.select2').find('.select2-selection').removeClass('is-invalid-s2');
            }
        });

        // Định dạng số khi blur (động theo kiểu giảm)
        const formatGiaTriGiam = () => {
            const type = $('input[name="loai"]:checked').val();
            const allowDecimal = (type !== 'PERCENT'); // % phải là số nguyên
            const $el = $('#giaTriGiam');
            $el.val(formatNumber($el.val(), allowDecimal));
        };

        [
            { selector: '#giaTriGiamToiDa', allowDecimal: true },
            { selector: '#giaTriGiamToiThieu', allowDecimal: true },
            { selector: '#gioiHanSuDung', allowDecimal: false }
        ].forEach(cfg => {
            const $el = $(cfg.selector);
            if ($el.length && $el.val()){
                $el.val(formatNumber($el.val(), cfg.allowDecimal));
            }
            $el.on('blur', function () {
                $(this).val(formatNumber($(this).val(), cfg.allowDecimal));
            });
        });

        if ($('#giaTriGiam').val()){
            formatGiaTriGiam();
        }
        $('#giaTriGiam').on('blur', formatGiaTriGiam);
        $(document).on('change','input[name="loai"]', formatGiaTriGiam);

        // Tìm kiếm KH + chọn tất cả
        $('#searchCustomerInput').on('keyup', function () {
            const keyword = $(this).val().toLowerCase();
            $('#customerTableBody').find('tr').each(function () {
                const visible = $(this).text().toLowerCase().indexOf(keyword) > -1;
                $(this).toggle(visible);
            });
            updateSelectAllCheckbox();
        });
        $('#selectAllCustomers').on('change', function () {
            const checked = $(this).is(':checked');
            $('.customerCheckbox:visible').prop('checked', checked);
        });
        $(document).on('change', '.customerCheckbox', function () {
            updateSelectAllCheckbox();
        });

        // Đồng bộ UI ban đầu
        toggleScopeFields();
        toggleDiscountFields();
        toggleUsageCount(null, false);
        setMinNowForDatetimeInputs();

        // Nút xác nhận submit
        // $('#confirmSubmit').on('click', function () {
        //     ['#giaTriGiam','#giaTriGiamToiDa','#giaTriGiamToiThieu','#gioiHanSuDung']
        //         .forEach(sel => $(sel).val(parseNumber($(sel).val())));
        //
        //     const selected = $('#paymentMethodSelect').val();
        //     if (selected && selected.includes('all')) {
        //         const allOptions = $('#paymentMethodSelect option').map(function(){return $(this).val();}).get().filter(v => v !== 'all');
        //         $('#paymentMethodSelect').val(allOptions).trigger('change');
        //     }
        //
        //     $('#editVoucherForm').submit();
        // });

        // Toasts
        showToast('successToast');
        showToast('errorToast');
        showToast('infoToast');
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>
</html>
