<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh sách Phiếu Giảm Giá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <script th:src="@{/js/sidebar.js}" defer></script>

    <style>
        /* ========= THEME ========= */
        :root{
            --primary:#153054;
            --primary-600:#132a49;
            --primary-700:#10243e;
            --secondary:#9FD5F7;
            --ink:#1b2430;
            --muted:#5b6777;
            --line:#e6eef5;
            --soft:#f6f9fc;
            --white:#ffffff;

            --nav-h: 56px;      /* cao navbar (fallback) */
            --header-gap: 0px;  /* sát navbar */
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color:var(--ink);
            background:var(--white);
            line-height:1.6;
            -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
        }

        /* ========= LAYOUT ========= */
        .content{
            margin-left:250px;
            padding:32px;
            padding-top: calc(var(--nav-h) + var(--header-gap));  /* sát navbar */
            min-height:100vh;
            transition:all .3s ease;
        }
        .content.full-width{ margin-left:0; padding-top: calc(var(--nav-h) + var(--header-gap)); }

        .custom-navbar{
            border-bottom:1px solid var(--line);
            backdrop-filter:saturate(140%) blur(6px);
        }

        /* ========= PAGE HEADER ========= */
        .sticky-header{
            display:flex;justify-content:center;align-items:center;
            background:linear-gradient(135deg,var(--white),#f9fbfe);
            border:1px solid var(--line);
            border-radius:16px;
            padding:18px 22px;
            margin:0 0 20px 0; /* sát navbar */
            text-align:center;
            box-shadow:0 6px 20px rgba(21,48,84,.06);
        }
        .sticky-header h2{
            position: relative; margin:0;
            display:inline-flex;align-items:center;gap:12px;
            font-size:1.7rem;font-weight:800;color:var(--primary-700);letter-spacing:-.02em;
            padding-bottom:10px;
        }
        .sticky-header h2::after{
            content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-6px;
            width:180px;height:4px;border-radius:999px;
            background:linear-gradient(90deg,var(--secondary),var(--primary));
            box-shadow:0 6px 16px rgba(21,48,84,.18);
        }
        .sticky-header h2 i{
            background:linear-gradient(135deg,var(--primary),var(--primary-600));
            color:#fff;border-radius:12px;padding:10px;font-size:1.05rem
        }

        /* ========= CARDS ========= */
        .card{
            background:var(--white);
            border:1px solid var(--line);
            border-radius:16px;
            box-shadow:0 6px 22px rgba(21,48,84,.06);
            transition:transform .2s ease, box-shadow .2s ease;
            overflow:hidden;
        }
        .card:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(21,48,84,.12)}
        .search-card{background:linear-gradient(180deg,#fbfdff, var(--soft))}
        .card-body{padding:24px}

        /* ========= FILTER FORM ========= */
        #filterForm{
            display:flex;align-items:flex-end;gap:12px;flex-wrap:nowrap;
            border:1px solid var(--line);border-radius:16px;padding:16px;
            background:linear-gradient(180deg,#fbfdff, var(--soft));margin-bottom:20px;
        }
        #filterForm > .col-md-3,#filterForm > .col-md-2{flex:1 1 0; max-width:100%}
        .form-label{font-size:.8rem;font-weight:700;color:var(--primary-700);letter-spacing:.02em;text-transform:uppercase;margin-bottom:6px}
        .form-control,.form-select{background:#fff;border:2px solid var(--line);border-radius:12px;padding:9px 12px;font-size:.95rem;transition:all .15s ease;height:42px}
        .form-control:focus,.form-select:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(21,48,84,.14)}

        /* ========= BUTTONS ========= */
        .btn{border-radius:12px;font-weight:700;letter-spacing:.02em;border:none}
        .btn i{margin-right:.4rem}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;box-shadow:0 8px 22px rgba(21,48,84,.25)}
        .btn-primary:hover{background:linear-gradient(135deg,var(--primary-600),var(--primary));transform:translateY(-1px)}
        .btn-danger{background:linear-gradient(135deg,#ef4444,#b91c1c);color:#fff;box-shadow:0 8px 22px rgba(239,68,68,.25)}
        .btn-danger:hover{background:linear-gradient(135deg,#dc2626,#991b1b)}

        /* Outline (brand tone) */
        .btn-outline-info,.btn-outline-success,.btn-outline-primary,.btn-outline-danger{
            background:#fff;border:2px solid var(--line);color:var(--primary-700)
        }
        .btn-outline-info:hover,.btn-outline-success:hover,.btn-outline-primary:hover{
            border-color:var(--primary);color:var(--primary);background:#f3f7fe
        }
        .btn-outline-danger{border-color:#f1c3c3;color:#b91c1c}
        .btn-outline-danger:hover{border-color:#dc2626;color:#991b1b;background:#fff5f5}
        .btn-sm{padding:8px 12px;font-size:.85rem;height:40px;display:inline-flex;align-items:center}
        .btn.disabled,.btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none!important;transform:none!important}

        /* ========= TABLE ========= */
        .table-responsive{
            border:1px solid var(--line);border-radius:16px;background:#fff;
            box-shadow:0 8px 24px rgba(21,48,84,.06);
            overflow-x:auto;overflow-y:visible;
        }
        .table{margin-bottom:0;width:auto;min-width:1900px;table-layout:auto}
        .table thead th{
            position:sticky;top:0;z-index:5;
            background:linear-gradient(90deg, rgba(21,48,84,.12), rgba(21,48,84,.06));
            color:var(--primary-700);font-weight:800;border-bottom:2px solid var(--line);
            text-transform:uppercase;font-size:.80rem;letter-spacing:.05em;padding:14px;white-space:nowrap;text-align:center;
        }
        .table td{padding:14px;vertical-align:middle;border-bottom:1px solid #f0f4f9;color:#263341;white-space:nowrap;text-align:center}
        .table tbody tr:hover{background:linear-gradient(90deg,#fbfdff,#f4f9ff)}
        .table th.text-center,.table td.text-center{text-align:center}
        .table-responsive::-webkit-scrollbar{height:12px}
        .table-responsive::-webkit-scrollbar-track{background:#eef6ff;border-radius:8px}
        .table-responsive::-webkit-scrollbar-thumb{background:linear-gradient(90deg,#cfe7fb,#9FD5F7);border-radius:8px;border:2px solid #eef6ff}
        @media (min-width:1400px){ .table{min-width:2100px} }

        /* ========= BADGES ========= */
        .badge{border-radius:999px;padding:.5rem .75rem;font-weight:800;letter-spacing:.04em}
        .badge.bg-warning{background:linear-gradient(135deg,#ffe9b0,#ffd277)!important;color:#6b4600!important}
        .badge.bg-success{background:linear-gradient(135deg,#b7f0c6,#6be49a)!important;color:#064e3b!important}
        .badge.bg-secondary{background:linear-gradient(135deg,#e6eef5,#c9d7e6)!important;color:#364152!important}
        .badge.bg-light{background:#eef4fb!important;color:#334155!important}

        /* ========= PAGINATION ========= */
        .pagination{gap:12px;margin-top:18px;justify-content:center}
        .page-link{
            border-radius:14px;border:2px solid var(--line);background:#fff;color:var(--primary-700);
            font-weight:700;padding:10px 16px;
        }
        .page-link:hover{border-color:var(--primary);color:var(--primary)}
        .page-item.active .page-link{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:0 10px 22px rgba(21,48,84,.25)}
        .page-item.disabled .page-link{background:#f3f6fb;color:#9aa6b2}

        /* ========= TOAST (fixed top-right) ========= */
        .toast-container{
            position:fixed; top:14px; right:14px; z-index:1080; width:auto; max-width:380px;
            display:flex; flex-direction:column; gap:10px;
        }
        .toast{border-radius:14px; box-shadow:0 12px 28px rgba(21,48,84,.15)}
        .text-bg-success{background:linear-gradient(135deg,#2bb673,#28a745)!important}
        .text-bg-danger{background:linear-gradient(135deg,#e35b6b,#dc3545)!important}
        .text-bg-info{background:linear-gradient(135deg,#8ec5ff,#6aa8ff)!important}

        /* ========= RESPONSIVE ========= */
        @media (max-width: 1200px){
            #filterForm{flex-wrap:wrap}
            #filterForm > .col-md-3, #filterForm > .col-md-2{flex:1 1 calc(50% - 12px)}
        }
        @media (max-width: 768px){
            .content{margin-left:0;padding:18px;padding-top: calc(var(--nav-h) + var(--header-gap))}
            .sticky-header{padding:16px;border-radius:14px}
            .sticky-header h2{font-size:1.4rem}
            #filterForm > .col-md-3, #filterForm > .col-md-2{flex:1 1 100%}
            .table{min-width:1100px}
            .btn-sm{font-size:.8rem;padding:7px 10px;height:38px}
        }

        /* ===== Hiệu ứng khi cập nhật ajax ===== */
        .flash-update{animation:flashBg .8s ease}
        @keyframes flashBg{
            0%{background:#fff9c4}
            100%{background:transparent}
        }

        @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
        .sticky-header,.table-responsive,.card{animation:fadeIn .45s ease}
        .table thead tr.acv-head > th{
            background:#153054 !important;   /* tắt gradient, dùng màu brand */
            color:#fff !important;
            border-bottom:2px solid #153054 !important;
        }
        .table thead tr.acv-head > th i,
        .table thead tr.acv-head > th a{
            color:inherit !important;         /* icon/link cũng trắng */
        }

    </style>
</head>
<body>
<div class="d-flex">
    <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>

    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
        <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </nav>

    <div class="content" id="content">
        <!-- Toasts (fixed, góc phải) -->
        <div class="toast-container" id="toastContainer">
            <div class="toast align-items-center text-bg-success border-0" role="alert" id="successToast" aria-live="assertive" aria-atomic="true" th:if="${successMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        <span th:text="${successMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-danger border-0" role="alert" id="errorToast" aria-live="assertive" aria-atomic="true" th:if="${errorMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span th:text="${errorMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-info border-0" role="alert" id="infoToast" aria-live="assertive" aria-atomic="true" th:if="${mailMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-info-circle me-2"></i>
                        <span th:text="${mailMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="sticky-header">
            <h2><i class="fas fa-ticket-alt"></i> Phiếu Giảm Giá</h2>
        </div>

        <!-- Filter -->
        <form method="get" th:action="@{/acvstore/phieu-giam-gia}" id="filterForm" class="row g-3 search-card">
            <div class="col-md-3">
                <label class="form-label">Tìm kiếm</label>
                <input type="text" name="search" class="form-control" placeholder="Tìm theo mã hoặc tên..." th:value="${search}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Từ ngày</label>
                <input type="datetime-local" name="fromDate" class="form-control" th:value="${fromDate}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Đến ngày</label>
                <input type="datetime-local" name="toDate" class="form-control" th:value="${toDate}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Kiểu</label>
                <select name="type" class="form-select">
                    <option value="">-- Kiểu --</option>
                    <option value="PERCENT" th:selected="${type == 'PERCENT'}">%</option>
                    <option value="CASH" th:selected="${type == 'CASH'}">Tiền mặt</option>
                    <option value="FREESHIP_FULL" th:selected="${type == 'FREESHIP_FULL'}">Freeship toàn phần</option>
                    <option value="FREESHIP_CAP" th:selected="${type == 'FREESHIP_CAP'}">Freeship một phần</option>
                </select>

            </div>
            <div class="col-md-2">
                <label class="form-label">Trạng thái</label>
                <select name="status" class="form-select">
                    <option value="">-- Trạng thái --</option>
                    <option value="upcoming" th:selected="${status == 'upcoming'}">Sắp diễn ra</option>
                    <option value="active" th:selected="${status == 'active'}">Đang diễn ra</option>
                    <option value="expired" th:selected="${status == 'expired'}">Đã kết thúc</option>
                </select>
            </div>
        </form>

        <!-- Add -->
        <div class="d-flex justify-content-end align-items-center mb-3" th:if="${isAdmin}">
            <a href="/acvstore/phieu-giam-gia/create" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Tạo Mới
            </a>
        </div>

        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                <tr class="acv-head">
                    <th><i class="fas fa-hashtag me-2"></i>STT</th>
                    <th><i class="fas fa-barcode me-2"></i>MÃ</th>
                    <th><i class="fas fa-tag me-2"></i>TÊN</th>
                    <th><i class="fas fa-percent me-2"></i>KIỂU</th>
                    <th><i class="fas fa-layer-group me-2"></i>LOẠI</th>
                    <th><i class="fas fa-coins me-2"></i>GIÁ TRỊ</th>
                    <th><i class="fas fa-arrow-up me-2"></i>GIÁ TRỊ TỐI ĐA</th>
                    <th><i class="fas fa-arrow-down me-2"></i>ĐIỀU KIỆN</th>
                    <th><i class="fas fa-users me-2"></i>LƯỢT DÙNG</th>
                    <th><i class="fas fa-boxes-stacked me-2"></i>SỐ LƯỢNG</th>
                    <th><i class="fas fa-calendar-plus me-2"></i>NGÀY BẮT ĐẦU</th>
                    <th><i class="fas fa-calendar-minus me-2"></i>NGÀY KẾT THÚC</th>
                    <th><i class="fas fa-info-circle me-2"></i>TRẠNG THÁI</th>
                    <th class="text-center"><i class="fas fa-cogs me-2"></i>HÀNH ĐỘNG</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${vouchers.isEmpty()}">
                    <td colspan="14" class="text-center text-muted py-4">Không có phiếu giảm giá nào.</td>
                </tr>

                <tr th:each="v, stat : ${vouchers}" th:attr="data-voucher-id=${v.id}">
                    <!-- STT liên tục qua trang -->
                    <td><strong th:text="${currentPage * pageSize + stat.index + 1}">1</strong></td>

                    <td th:text="${v.ma}"></td>
                    <td th:text="${v.ten}"></td>
                    <td th:text="${v.loai == 'PERCENT' ? '%' : (v.loai == 'CASH' ? 'Tiền mặt' : v.loai)}"></td>
                    <td th:text="${v.kieuPhieu == 'cong_khai' ? 'Công Khai' : 'Cá Nhân'}"></td>
                    <td th:text="${formats[v.id]['giaTriGiam']}"></td>
                    <td th:text="${formats[v.id]['giaTriGiamToiDa']}"></td>
                    <td th:text="${formats[v.id]['giaTriGiamToiThieu']}"></td>
                    <td th:text="${v.gioiHanSuDung}"></td>

                    <!-- SỐ LƯỢNG (AJAX cập nhật) -->
                    <td>
                        <span class="voucher-qty" th:attr="data-id=${v.id}"
                              th:text="${v.soLuong != null ? v.soLuong : '-'}">-</span>
                    </td>

                    <td th:text="${#temporals.format(v.ngayBatDau, 'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${#temporals.format(v.ngayKetThuc, 'dd/MM/yyyy HH:mm')}"></td>
                    <td>
                        <!-- TRẠNG THÁI (AJAX cập nhật) -->
                        <span class="voucher-status" th:attr="data-id=${v.id}">
                            <span th:switch="${getStatus.apply(v)}">
                                <span th:case="'Sắp diễn ra'" class="badge bg-warning text-dark">Sắp diễn ra</span>
                                <span th:case="'Đang diễn ra'" class="badge bg-success">Đang diễn ra</span>
                                <span th:case="'Đã kết thúc'" class="badge bg-secondary">Đã kết thúc</span>
                                <span th:case="'Không xác định'" class="badge bg-light text-dark border">Không xác định</span>
                            </span>
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <!-- View -->
                            <a th:href="@{'/acvstore/phieu-giam-gia/view/' + ${v.id}}"
                               class="btn btn-sm btn-outline-success"
                               title="Xem chi tiết phiếu giảm giá">
                                <i class="fas fa-eye"></i>
                            </a>

                            <!-- Edit (chỉ khi Sắp diễn ra) -->
                            <a th:if="${isAdmin and getStatus.apply(v) == 'Sắp diễn ra'}"
                               th:href="@{'/acvstore/phieu-giam-gia/edit/' + ${v.id}}"
                               class="btn btn-sm btn-outline-info"
                               title="Chỉnh sửa phiếu giảm giá">
                                <i class="fas fa-edit"></i>
                            </a>

                            <!-- Delete -->
                            <button th:if="${isAdmin}"
                                    type="button"
                                    class="btn btn-sm btn-outline-danger delete-btn"
                                    th:classappend="${getStatus.apply(v) != 'Sắp diễn ra'} ? ' disabled'"
                                    th:attr="data-voucher-id=${v.id},
                                             data-bs-toggle=${getStatus.apply(v) == 'Sắp diễn ra'} ? 'modal' : '',
                                             data-bs-target=${getStatus.apply(v) == 'Sắp diễn ra'} ? '#deleteModal' : '',
                                             title=${getStatus.apply(v) == 'Sắp diễn ra'} ? 'Xóa phiếu giảm giá' : 'Chỉ được xóa khi trạng thái Sắp diễn ra'">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination (center, no page-size select) -->
        <nav aria-label="Pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/acvstore/phieu-giam-gia(page=${currentPage - 1}, size=${pageSize}, search=${search}, fromDate=${fromDate}, toDate=${toDate}, type=${type}, status=${status})}">
                        <i class="fa-solid fa-chevron-left me-1"></i> Trước
                    </a>
                </li>
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link"
                       th:href="@{/acvstore/phieu-giam-gia(page=${i}, size=${pageSize}, search=${search}, fromDate=${fromDate}, toDate=${toDate}, type=${type}, status=${status})}"
                       th:text="${i + 1}">1</a>
                </li>
                <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
                    <a class="page-link"
                       th:href="@{/acvstore/phieu-giam-gia(page=${currentPage + 1}, size=${pageSize}, search=${search}, fromDate=${fromDate}, toDate=${toDate}, type=${type}, status=${status})}">
                        Sau <i class="fa-solid fa-chevron-right ms-1"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!--&lt;!&ndash; Delete Modal &ndash;&gt;-->
<!--<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" th:if="${isAdmin}">-->
<!--    <div class="modal-dialog modal-dialog-centered">-->
<!--        <div class="modal-content">-->
<!--            <div class="modal-header">-->
<!--                <h5 class="modal-title" id="deleteModalLabel">-->
<!--                    <i class="fas fa-exclamation-triangle me-2"></i> Xác nhận xóa phiếu giảm giá-->
<!--                </h5>-->
<!--                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>-->
<!--            </div>-->
<!--            <div class="modal-body">-->
<!--                <div class="text-center py-2">-->
<!--                    <div class="mb-3">-->
<!--                        <i class="fa-solid fa-exclamation-triangle" style="font-size:58px;color:#f59e0b;"></i>-->
<!--                    </div>-->
<!--                    <h5 class="mb-3" style="color:var(&#45;&#45;primary-700)">Bạn có chắc chắn muốn xóa?</h5>-->
<!--                    <div class="p-3 rounded mb-3" style="background:#f5f9ff;border:1px dashed var(&#45;&#45;secondary)">-->
<!--                        <p class="mb-0"><strong>Phiếu:</strong> <span id="voucherCode" class="text-danger fw-bold"></span></p>-->
<!--                    </div>-->
<!--                    <div class="alert alert-warning mb-0">-->
<!--                        <i class="fa-solid fa-warning me-2"></i>-->
<!--                        <strong>Cảnh báo:</strong> Hành động này không thể hoàn tác!-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--            <div class="modal-footer">-->
<!--                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">-->
<!--                    <i class="fas fa-times me-2"></i>Hủy-->
<!--                </button>-->
<!--                <form id="deleteForm" method="post" action="/acvstore/phieu-giam-gia/delete" style="display: inline;">-->
<!--                    <input type="hidden" name="id" id="deleteIdInput">-->
<!--                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" th:if="${_csrf}"/>-->
<!--                    <button type="submit" class="btn btn-danger" id="confirmDelete">-->
<!--                        <i class="fas fa-trash-alt me-2"></i>Xác nhận xóa-->
<!--                    </button>-->
<!--                </form>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
<script th:inline="javascript">
    // Đo chiều cao navbar để content sát tuyệt đối
    function setNavHeightVar(){
        const nav = document.querySelector('.custom-navbar');
        const h = nav ? nav.offsetHeight : 56;
        document.documentElement.style.setProperty('--nav-h', h + 'px');
    }
    document.addEventListener('DOMContentLoaded', setNavHeightVar);
    window.addEventListener('resize', setNavHeightVar);

    function showConnectionErrorNotification() {
        let notification = document.getElementById('connectionErrorNotification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'connectionErrorNotification';
            notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 80px; left: 50%; transform: translateX(-50%); z-index: 1050; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Không thể kết nối real-time
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(notification);
        }
    }

    function hideConnectionErrorNotification() {
        const notification = document.getElementById('connectionErrorNotification');
        if (notification) {
            notification.remove();
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Toasts server-side
        const ok = document.getElementById('successToast'); if (ok) new bootstrap.Toast(ok).show();
        const err = document.getElementById('errorToast'); if (err) new bootstrap.Toast(err).show();
        const info = document.getElementById('infoToast'); if (info) new bootstrap.Toast(info).show();

        // Helper toast (fixed top-right)
        function showToast(message, type = 'danger'){
            const container = document.getElementById('toastContainer') || document.body;
            const iconMap = { danger: 'fa-ban', info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-triangle-exclamation' };
            const bgMap = { danger: 'text-bg-danger', info: 'text-bg-info', success: 'text-bg-success', warning: 'text-bg-warning' };
            const toastEl = document.createElement('div');
            toastEl.className = `toast align-items-center ${bgMap[type]||bgMap.danger} border-0`;
            toastEl.setAttribute('role','alert'); toastEl.setAttribute('aria-live','assertive'); toastEl.setAttribute('aria-atomic','true');
            toastEl.innerHTML = ``
                + `<div class="d-flex">`
                + `    <div class="toast-body">`
                + `        <i class="fas ${iconMap[type]||iconMap.danger} me-2"></i>${message}`
                + `    </div>`
                + `    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>`
                + `</div>`;
            container.appendChild(toastEl);
            const t = new bootstrap.Toast(toastEl, { delay: 2500 });
            toastEl.addEventListener('hidden.bs.toast', ()=> toastEl.remove());
            t.show();
        }

        // Auto-submit filter
        const form = document.getElementById("filterForm");
        form.querySelectorAll("select, input[type='datetime-local']").forEach(el => {
            el.addEventListener("change", () => form.submit());
        });

        // Debounce search
        const searchInput = form.querySelector("input[name='search']");
        let typingTimer;
        if (searchInput) {
            searchInput.addEventListener("input", function () {
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => form.submit(), 500);
            });
        }

        // ===== Delete flow =====
        // const isAdmin = /*[[${isAdmin}]]*/ false;
        // if (isAdmin) {
        //     const deleteIdInput = document.getElementById('deleteIdInput');
        //     const deleteForm = document.getElementById('deleteForm');
        //
        //     document.querySelectorAll('.delete-btn').forEach(btn => {
        //         btn.addEventListener('click', function (e) {
        //             if (this.classList.contains('disabled')) {
        //                 showToast('Chỉ được xóa khi trạng thái "Sắp diễn ra".', 'warning');
        //                 e.preventDefault(); return false;
        //             }
        //             const id = this.getAttribute('data-voucher-id');
        //             const codeCell = this.closest('tr').querySelector('td:nth-child(2)');
        //             const code = codeCell ? codeCell.textContent.trim() : '';
        //             document.getElementById('voucherCode').textContent = code;
        //             deleteIdInput.value = id;
        //         });
        //     });
        //
        //     deleteForm.addEventListener('submit', function (e) {
        //         if (!deleteIdInput.value) { e.preventDefault(); showToast('Thiếu mã phiếu cần xóa', 'danger'); }
        //     });
        // }
// ===== Delete flow (SweetAlert2) =====
        const isAdmin = /*[[${isAdmin}]]*/ false;

// Lấy CSRF (nếu có). Có fallback an toàn.
        let csrfParam = '_csrf', csrfToken = '';
        try {
            csrfParam = /*[['${_csrf.parameterName}']]*/ '_csrf';
            csrfToken = /*[['${_csrf.token}']]*/ '';
        } catch(e) { /* ignore */ }

        if (isAdmin) {
            // Gỡ data-bs-* để tránh kích hoạt modal Bootstrap cũ (nếu còn attribute trong HTML)
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.removeAttribute('data-bs-toggle');
                btn.removeAttribute('data-bs-target');
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    if (this.classList.contains('disabled')) {
                        showToast('Chỉ được xóa khi trạng thái "Sắp diễn ra".', 'warning');
                        return;
                    }

                    const id = this.getAttribute('data-voucher-id') || '';
                    const codeCell = this.closest('tr').querySelector('td:nth-child(2)');
                    const code = codeCell ? codeCell.textContent.trim() : '';

                    await Swal.fire({
                        title: 'Xác nhận xóa phiếu giảm giá',
                        html: `
          <div class="text-start">
            <div class="p-3 rounded mb-3" style="background:#f5f9ff;border:1px dashed var(--secondary)">
              <p class="mb-0"><strong>Phiếu:</strong> <span class="text-danger fw-bold">${code}</span></p>
            </div>
            <div class="alert alert-warning mb-0">
              <i class="fa-solid fa-triangle-exclamation me-2"></i>
              Hành động này không thể hoàn tác!
            </div>
          </div>
        `,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Xác nhận xóa',
                        cancelButtonText: 'Hủy',
                        buttonsStyling: false,
                        customClass: {
                            confirmButton: 'btn btn-danger',
                            cancelButton: 'btn btn-secondary ms-2'
                        },
                        reverseButtons: true,
                        focusCancel: true,
                        showLoaderOnConfirm: true,                // Hiển thị "đang xử lý"
                        allowOutsideClick: () => !Swal.isLoading(),
                        preConfirm: async () => {
                            try {
                                const params = new URLSearchParams();
                                params.append('id', id);
                                if (csrfToken) params.append(csrfParam, csrfToken);

                                const res = await fetch('/acvstore/phieu-giam-gia/delete', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: params.toString(),
                                });

                                if (!res.ok) throw new Error('HTTP ' + res.status);
                                // Trường hợp server redirect hoặc trả text – chỉ cần OK là coi như xóa thành công
                                return true;
                            } catch (err) {
                                Swal.showValidationMessage('Lỗi khi xóa: ' + (err?.message || 'Không xác định'));
                                return false;
                            }
                        }
                    }).then(result => {
                        if (result.isConfirmed) {
                            // Thông báo và xóa hàng trên bảng (animation)
                            Swal.fire({
                                icon: 'success',
                                title: 'Đã xóa',
                                text: `Đã xóa: ${code}`,
                                timer: 1500,
                                showConfirmButton: false
                            });

                            const row = btn.closest('tr');
                            if (row) {
                                row.style.transition = 'opacity .5s ease';
                                row.style.opacity = '0';
                                setTimeout(() => row.remove(), 500);
                            }
                        }
                    });
                });
            });
        }

        // ===== AJAX cập nhật SỐ LƯỢNG & TRẠNG THÁI =====
        function collectVisibleVoucherIds(){
            return Array.from(document.querySelectorAll('tr[data-voucher-id]'))
                .map(tr => tr.getAttribute('data-voucher-id'));
        }

        function renderStatusBadge(status){
            if(status === 'Sắp diễn ra'){
                return '<span class="badge bg-warning text-dark">Sắp diễn ra</span>';
            } else if(status === 'Đang diễn ra'){
                return '<span class="badge bg-success">Đang diễn ra</span>';
            } else if(status === 'Đã kết thúc'){
                return '<span class="badge bg-secondary">Đã kết thúc</span>';
            } else {
                return '<span class="badge bg-light text-dark border">Không xác định</span>';
            }
        }

        async function refreshVoucherSummary(){
            const ids = collectVisibleVoucherIds();
            if (!ids.length) return;

            const url = `/acvstore/phieu-giam-gia/api/summary?ids=${encodeURIComponent(ids.join(','))}&ts=${Date.now()}`;
            try{
                const res = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' }});
                if(!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json(); // [{id, soLuong, status}]
                data.forEach(item => {
                    // Update qty
                    const qtyEl = document.querySelector(`.voucher-qty[data-id="${item.id}"]`);
                    if (qtyEl){
                        const old = qtyEl.textContent.trim();
                        const nextVal = (item.soLuong !== null && item.soLuong !== undefined) ? item.soLuong : '-';
                        if (old !== String(nextVal)){
                            qtyEl.textContent = nextVal;
                            qtyEl.classList.add('flash-update');
                            setTimeout(()=> qtyEl.classList.remove('flash-update'), 1000);
                        }
                    }
                    // Update status badge
                    const stEl = document.querySelector(`.voucher-status[data-id="${item.id}"]`);
                    if (stEl){
                        const newHtml = renderStatusBadge(item.status || 'Không xác định');
                        if (stEl.innerHTML.trim() !== newHtml.trim()){
                            stEl.innerHTML = newHtml;
                            stEl.classList.add('flash-update');
                            setTimeout(()=> stEl.classList.remove('flash-update'), 1000);
                        }
                    }
                });
            }catch(e){
                console.warn('Refresh voucher summary failed:', e);
            }
        }

        let stompClient = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            try {
                const socket = new SockJS('/ws');
                stompClient = new window.StompJs.Client({
                    webSocketFactory: () => socket,
                    debug: (str) => console.log('[WebSocket Debug]', str),
                    reconnectDelay: 5000,
                    heartbeatIncoming: 4000,
                    heartbeatOutgoing: 4000,
                });

                stompClient.onConnect = (frame) => {
                    console.log('[WebSocket] Connected to voucher updates');
                    reconnectAttempts = 0;
                    hideConnectionErrorNotification();

                    // Subscribe to voucher updates
                    stompClient.subscribe('/topic/vouchers', (message) => {
                        try {
                            const update = JSON.parse(message.body);
                            handleVoucherUpdate(update);
                        } catch (e) {
                            console.error('[WebSocket] Error parsing voucher update:', e);
                        }
                    });

                    showToast('Kết nối real-time thành công', 'success');
                };

                stompClient.onStompError = (frame) => {
                    console.error('[WebSocket] STOMP error:', frame);
                    showConnectionErrorNotification();

                    if (reconnectAttempts < maxReconnectAttempts) {
                        setTimeout(() => {
                            reconnectAttempts++;
                            console.log(`[WebSocket] Reconnecting after STOMP error... (${reconnectAttempts}/${maxReconnectAttempts})`);
                            connectWebSocket();
                        }, 2000);
                    }
                };

                stompClient.onWebSocketClose = () => {
                    console.log('[WebSocket] Connection closed');
                    showConnectionErrorNotification();
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        setTimeout(() => {
                            console.log(`[WebSocket] Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
                            connectWebSocket();
                        }, 3000 * reconnectAttempts);
                    }
                };

                stompClient.onWebSocketError = (error) => {
                    console.error('[WebSocket] Connection error:', error);
                    showConnectionErrorNotification();
                };

                stompClient.activate();
            } catch (error) {
                console.error('[WebSocket] Connection failed:', error);
                showConnectionErrorNotification();

                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(() => {
                        reconnectAttempts++;
                        console.log(`[WebSocket] Retrying connection... (${reconnectAttempts}/${maxReconnectAttempts})`);
                        connectWebSocket();
                    }, 5000);
                }
            }
        }

        function handleVoucherUpdate(update) {
            console.log('[WebSocket] Voucher update received:', update);

            const { action, voucherId, voucherCode, newStatus, quantity, message } = update;

            // Update quantity display
            const qtyEl = document.querySelector(`.voucher-qty[data-id="${voucherId}"]`);
            if (qtyEl && quantity !== undefined) {
                const oldQty = qtyEl.textContent.trim();
                const newQty = (quantity !== null && quantity !== undefined) ? quantity : '-';
                if (oldQty !== String(newQty)) {
                    qtyEl.textContent = newQty;
                    qtyEl.classList.add('flash-update');
                    setTimeout(() => qtyEl.classList.remove('flash-update'), 1000);
                }
            }

            // Update status display
            const statusEl = document.querySelector(`.voucher-status[data-id="${voucherId}"]`);
            if (statusEl && newStatus) {
                const newHtml = renderStatusBadge(newStatus);
                if (statusEl.innerHTML.trim() !== newHtml.trim()) {
                    statusEl.innerHTML = newHtml;
                    statusEl.classList.add('flash-update');
                    setTimeout(() => statusEl.classList.remove('flash-update'), 1000);
                }
            }

            // Show notification for different actions
            let toastType = 'info';
            let toastMessage = message || 'Cập nhật phiếu giảm giá';

            switch (action) {
                case 'CREATED':
                    toastType = 'success';
                    toastMessage = `Phiếu mới: ${voucherCode}`;
                    // Refresh page to show new voucher
                    setTimeout(() => window.location.reload(), 1500);
                    break;
                case 'UPDATED':
                    toastType = 'info';
                    toastMessage = `Cập nhật: ${voucherCode}`;
                    break;
                case 'DELETED':
                    toastType = 'success';
                    toastMessage = `Đã xóa: ${voucherCode}`;
                    // Remove the row from table
                    const row = document.querySelector(`tr[data-voucher-id="${voucherId}"]`);
                    if (row) {
                        row.style.transition = 'opacity 0.5s ease';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 500);
                    }
                    break;
                case 'STATUS_CHANGED':
                    toastType = 'info';
                    toastMessage = `${voucherCode}: ${update.oldStatus} → ${newStatus}`;
                    break;
            }

            showToast(toastMessage, toastType);
        }

        // Connect to WebSocket
        connectWebSocket();

        const POLL_MS = 60000; // Increased to 60 seconds as fallback
        let pollTimer = setInterval(refreshVoucherSummary, POLL_MS);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (stompClient && stompClient.connected) {
                stompClient.deactivate();
            }
            clearInterval(pollTimer);
        });
    });

    // ---- Đổi ký hiệu ₫/đ sang VND trong bảng ----
    function replaceCurrencyUnitsInTable(){
        // Các cột: 6=Giá trị, 7=Giá trị tối đa, 8=Điều kiện
        document.querySelectorAll('table.table tbody tr').forEach(tr=>{
            [6,7,8].forEach(idx=>{
                const td = tr.querySelector(`td:nth-child(${idx})`);
                if(!td) return;
                const before = td.textContent;
                // 1) ₫ -> VND
                let after = before.replace(/₫/g, 'VND');
                // 2) Số + (khoảng trắng optional) + 'đ' ở cuối -> VND
                //    (tránh đụng chữ "đ" trong tiếng Việt như "Điều kiện")
                after = after.replace(/(\d[\d.\s,]*)\s?đ\b/gi, '$1 VND');
                if (after !== before) td.textContent = after;
            });
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        replaceCurrencyUnitsInTable();
    });
</script>
<script th:if="${successMessage}">
    try { sessionStorage.removeItem('voucherCreateFormState'); } catch(e){}
</script>

<script th:src="@{/js/notification.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>
