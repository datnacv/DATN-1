<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tạo Phiếu Giảm Giá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .form-label {
            font-weight: 500;
            color: #333;
        }
        .form-control, .form-select {
            border-radius: 0.375rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .btn-primary, .btn-secondary {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 0.375rem;
        }
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .table-responsive {
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .input-group-text {
            background-color: #f8f9fa;
            border-radius: 0 0.375rem 0.375rem 0;
        }
        .form-check-label {
            cursor: pointer;
        }
        .content {
            padding: 2rem;
            margin-left: 256px;
            margin-top: 70px;
        }
        .sticky-header {
            position: sticky;
            top: 70px;
            z-index: 1000;
            background-color: #fff;
            padding: 1rem 2rem;
            margin: -2rem -2rem 1rem -2rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .sticky-header h2 {
            font-weight: bold;
            margin: 0;
        }
        .modal-content {
            border-radius: 0.5rem;
        }
        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .invalid-feedback {
            display: none;
            color: #dc3545;
            font-size: 0.875rem;
        }
        .is-invalid ~ .invalid-feedback {
            display: block;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script th:src="@{/js/sidebar.js}" defer></script>
    <script th:src="@{/js/notification.js}"></script>
</head>
<body class="bg-light">
<div class="d-flex">
    <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>
    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
        <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </nav>
    <div class="content" id="content">
        <!-- Toasts -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
            <div class="toast align-items-center text-bg-success border-0" role="alert" id="successToast" aria-live="assertive" aria-atomic="true" th:if="${successMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        <span th:text="${successMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-danger border-0" role="alert" id="errorToast" aria-live="assertive" aria-atomic="true" th:if="${errorMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span th:utext="${errorMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
            <div class="toast align-items-center text-bg-info border-0" role="alert" id="infoToast" aria-live="assertive" aria-atomic="true" th:if="${mailMessage}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-info-circle me-2"></i>
                        <span th:text="${mailMessage}"></span>
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="sticky-header">
            <h2><i class="fas fa-ticket-alt me-2"></i>Tạo Phiếu Giảm Giá</h2>
        </div>

        <!-- Form -->
        <div class="bg-white p-4 rounded shadow-sm">
            <form id="createVoucherForm" th:action="@{/acvstore/phieu-giam-gia/create}" th:object="${voucher}" method="post">
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-barcode me-2"></i>Mã phiếu:</label>
                    <input type="text" th:field="*{ma}" class="form-control" placeholder="Nh CMV + số (VD: CMV123)"/>
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-tag me-2"></i>Tên phiếu:</label>
                    <input type="text" th:field="*{ten}" class="form-control" required placeholder="Tên phiếu giảm giá"/>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>Ngày bắt đầu:</label>
                        <input type="datetime-local" th:field="*{ngayBatDau}" class="form-control" id="ngayBatDau" required/>
                        <div class="invalid-feedback" id="ngayBatDauError"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>Ngày kết thúc:</label>
                        <input type="datetime-local" th:field="*{ngayKetThuc}" class="form-control" id="ngayKetThuc" required/>
                        <div class="invalid-feedback" id="ngayKetThucError"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-truck me-2"></i>Phạm vi áp dụng:</label>
                    <div>
                        <label class="form-check-label me-3">
                            <input type="radio" th:field="*{phamViApDung}" value="ORDER" required onchange="toggleScopeFields()"> Giảm giá đơn hàng
                        </label>
                        <label class="form-check-label">
                            <input type="radio" th:field="*{phamViApDung}" value="SHIPPING" onchange="toggleScopeFields()"> Giảm phí vận chuyển
                        </label>
                    </div>
                </div>

                <!-- Kiểu freeship (chỉ hiện khi chọn SHIPPING) -->
                <div class="mb-3" id="shipTypeGroup" style="display: none;">
                    <label class="form-label"><i class="fas fa-truck-fast me-2"></i>Kiểu freeship:</label>
                    <div>
                        <label class="form-check-label me-3">
                            <input type="radio" th:field="*{loai}" value="FREESHIP_FULL" onchange="toggleDiscountFields()"> Miễn phí ship toàn phần
                        </label>
                        <label class="form-check-label">
                            <input type="radio" th:field="*{loai}" value="FREESHIP_CAP" onchange="toggleDiscountFields()"> Miễn phí ship tối đa X₫
                        </label>
                    </div>
                </div>

                <!-- Kiểu giảm (ẩn PERCENT khi chọn SHIPPING) -->
                <div class="mb-3" id="discountTypeGroup">
                    <label class="form-label"><i class="fas fa-percentage me-2"></i>Kiểu giảm:</label>
                    <div>
                        <label class="form-check-label me-3" id="percentOption">
                            <input type="radio" th:field="*{loai}" value="PERCENT" onchange="toggleDiscountFields()"> Giảm theo %
                        </label>
                        <label class="form-check-label" id="cashOption">
                            <input type="radio" th:field="*{loai}" value="CASH" onchange="toggleDiscountFields()"> Giảm theo tiền mặt
                        </label>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6" id="discountValueGroup">
                        <label class="form-label">Giá trị giảm:</label>
                        <div class="input-group">
                            <input type="text" th:field="*{giaTriGiam}" class="form-control" id="giaTriGiam" inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9,]/g,'')" placeholder="0">
                            <span class="input-group-text" id="discountUnit">%</span>
                        </div>
                        <div class="invalid-feedback" id="giaTriGiamError"></div>
                    </div>
                    <div class="col-md-6" id="maxDiscountGroup">
                        <label class="form-label">Giá trị giảm tối đa:</label>
                        <div class="input-group">
                            <input type="text" th:field="*{giaTriGiamToiDa}" class="form-control" id="giaTriGiamToiDa" inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9,]/g,'')" placeholder="0">
                            <span class="input-group-text">₫</span>
                        </div>
                        <div class="invalid-feedback" id="giaTriGiamToiDaError"></div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Lượt sử dụng:</label>
                        <input type="text" th:field="*{gioiHanSuDung}" class="form-control" id="gioiHanSuDung" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,'')" placeholder="Số lượt sử dụng">
                        <small class="text-muted" id="caNhanNote" style="display:none;">* Phiếu cá nhân chỉ áp dụng 1 lượt sử dụng</small>
                        <div class="invalid-feedback" id="gioiHanSuDungError"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Đơn tối thiểu áp dụng:</label>
                        <div class="input-group">
                            <input type="text" th:field="*{giaTriGiamToiThieu}" class="form-control" id="giaTriGiamToiThieu" inputmode="decimal" oninput="this.value=this.value.replace(/[^0-9,]/g,'')" placeholder="0">
                            <span class="input-group-text">₫</span>
                        </div>
                        <div class="invalid-feedback" id="giaTriGiamToiThieuError"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-users me-2"></i>Loại phiếu:</label>
                    <div>
                        <label class="form-check-label me-3">
                            <input type="radio" th:field="*{kieuPhieu}" value="cong_khai" onclick="toggleUsageCount()"> Công khai
                        </label>
                        <label class="form-check-label">
                            <input type="radio" th:field="*{kieuPhieu}" value="ca_nhan" onclick="toggleUsageCount()"> Cá nhân
                        </label>
                    </div>
                </div>

                <div class="col-md-4 col-lg-4 mb-3">
                    <div class="floating-label">
                        <label for="paymentMethodSelect"><i class="fas fa-credit-card me-2"></i>Phương thức thanh toán áp dụng</label>
                        <select id="paymentMethodSelect" class="form-select" name="selectedPtttIds" multiple>
                            <option value="all">Tất cả</option>
                            <option th:each="pt : ${phuongThucList}" th:value="${pt.id}" th:text="${pt.tenPhuongThuc}" th:selected="${selectedPtttIds != null and selectedPtttIds.contains(pt.id)}"></option>
                        </select>
                    </div>
                </div>

                <div id="emailOptions" class="mb-3" style="display:none">
                    <label class="form-label"><i class="fas fa-user-check me-2"></i>Chọn khách hàng áp dụng:</label>
                    <input type="text" class="form-control mb-2" id="searchCustomerInput" placeholder="Tìm kiếm theo tên, email, SĐT...">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="selectAllCustomers">
                        <label class="form-check-label" for="selectAllCustomers">Chọn tất cả</label>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover align-middle bg-white">
                            <thead class="table-light">
                            <tr>
                                <th>Chọn</th>
                                <th>Họ tên</th>
                                <th>Email</th>
                                <th>SĐT</th>
                            </tr>
                            </thead>
                            <tbody id="customerTableBody">
                            <tr th:each="customer : ${customers}">
                                <td><input type="checkbox" name="selectedCustomerIds" th:value="${customer.id}" class="customerCheckbox" th:checked="${selectedCustomerIds != null and selectedCustomerIds.contains(customer.id)}"/></td>
                                <td th:text="${customer.hoTen}"></td>
                                <td th:text="${customer.email}"></td>
                                <td th:text="${customer.soDienThoai}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="sendMail" name="sendMail">
                        <label class="form-check-label" for="sendMail">Gửi Email cho khách hàng</label>
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-primary me-2" onclick="validateForm()"><i class="fas fa-save me-2"></i>Lưu</button>
                    <a th:href="@{/acvstore/phieu-giam-gia}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Quay lại</a>
                </div>
            </form>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmModalLabel">Xác nhận lưu</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Bạn có chắc chắn muốn lưu phiếu giảm giá này không?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-primary" id="confirmSubmit">Xác nhận</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function formatNumber(value, allowDecimal) {
        value = value.replace(/[^\d,]/g, '').replace(/\./g, '').replace(/,/g, '.');
        let number = parseFloat(value);
        if (isNaN(number)) return '';
        return new Intl.NumberFormat('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: allowDecimal ? 2 : 0
        }).format(number);
    }

    function parseNumber(value) {
        return value.replace(/[.,]/g, '');
    }

    function updateSelectAllCheckbox() {
        const all = $('.customerCheckbox:visible').length;
        const checked = $('.customerCheckbox:visible:checked').length;
        $('#selectAllCustomers').prop('checked', all > 0 && all === checked);
    }

    function showToast(toastId) {
        const toastEl = document.getElementById(toastId);
        if (toastEl) {
            const toast = new bootstrap.Toast(toastEl, {
                autohide: true,
                delay: 5000
            });
            toast.show();
        }
    }

    function toggleScopeFields() {
        const scope = $('input[name="phamViApDung"]:checked').val();
        console.log('toggleScopeFields: scope=', scope);
        const isShipping = scope === 'SHIPPING';
        $('#shipTypeGroup').toggle(isShipping);
        $('#discountTypeGroup').toggle(!isShipping);
        $('#percentOption').toggle(!isShipping);
        $('#cashOption').toggle(true);

        if (isShipping) {
            if (!$('input[name="loai"]:checked').length) {
                $('input[name="loai"][value="FREESHIP_FULL"]').prop('checked', true);
            }
            $('#discountValueGroup').addClass('d-none');
            $('#maxDiscountGroup').addClass('d-none');
        } else {
            if (!$('input[name="loai"]:checked').length) {
                $('input[name="loai"][value="CASH"]').prop('checked', true);
            }
            $('#discountValueGroup').removeClass('d-none');
            $('#maxDiscountGroup').removeClass('d-none');
        }
        toggleDiscountFields();
    }

    function toggleDiscountFields() {
        const type = $('input[name="loai"]:checked').val();
        console.log('toggleDiscountFields: type=', type);
        const isPercent = type === 'PERCENT';
        const isFreeshipFull = type === 'FREESHIP_FULL';
        const isFreeshipCap = type === 'FREESHIP_CAP';

        $('#discountUnit').text(isPercent ? '%' : '₫');
        if (isFreeshipFull) {
            $('#discountValueGroup').addClass('d-none');
            $('#giaTriGiam').val('0').prop('readonly', true);
            $('#maxDiscountGroup').addClass('d-none');
            $('#giaTriGiamToiDa').val('').prop('readonly', true);
        } else if (isFreeshipCap) {
            $('#discountValueGroup').addClass('d-none');
            $('#giaTriGiam').val('0').prop('readonly', true);
            $('#maxDiscountGroup').removeClass('d-none');
            $('#giaTriGiamToiDa').prop('readonly', false);
        } else if (isPercent) {
            $('#discountValueGroup').removeClass('d-none');
            $('#giaTriGiam').prop('readonly', false);
            $('#maxDiscountGroup').removeClass('d-none');
            $('#giaTriGiamToiDa').prop('readonly', false);
        } else { // CASH
            $('#discountValueGroup').removeClass('d-none');
            $('#giaTriGiam').prop('readonly', false);
            $('#maxDiscountGroup').addClass('d-none');
            $('#giaTriGiamToiDa').val('').prop('readonly', true);
        }
    }

    function toggleUsageCount() {
        const isCaNhan = $('input[name="kieuPhieu"]:checked').val() === 'ca_nhan';
        console.log('toggleUsageCount: isCaNhan=', isCaNhan);
        $('#emailOptions').toggle(isCaNhan);
        if (isCaNhan) {
            $('#gioiHanSuDung').val('1').prop('readonly', true);
            $('#caNhanNote').show();
        } else {
            $('#gioiHanSuDung').val('').prop('readonly', false);
            $('#caNhanNote').hide();
        }
    }

    function validateForm() {
        let isValid = true;
        $('.invalid-feedback').text('').hide();
        $('.form-control').removeClass('is-invalid');

        // Validate ngày bắt đầu
        const ngayBatDau = $('#ngayBatDau').val();
        const ngayKetThuc = $('#ngayKetThuc').val();
        const now = new Date('2025-08-15T01:03:00+07:00'); // Current time: 15/08/2025 01:03 +07

        if (!ngayBatDau) {
            $('#ngayBatDau').addClass('is-invalid');
            $('#ngayBatDauError').text('Ngày bắt đầu không được để trống.').show();
            isValid = false;
        } else if (new Date(ngayBatDau) < now) {
            $('#ngayBatDau').addClass('is-invalid');
            $('#ngayBatDauError').text('Ngày bắt đầu không được trong quá khứ.').show();
            isValid = false;
        }

        // Validate ngày kết thúc
        if (!ngayKetThuc) {
            $('#ngayKetThuc').addClass('is-invalid');
            $('#ngayKetThucError').text('Ngày kết thúc không được để trống.').show();
            isValid = false;
        } else if (new Date(ngayKetThuc) < now) {
            $('#ngayKetThuc').addClass('is-invalid');
            $('#ngayKetThucError').text('Ngày kết thúc không được trong quá khứ.').show();
            isValid = false;
        }

        // Validate ngày bắt đầu <= ngày kết thúc
        if (ngayBatDau && ngayKetThuc && new Date(ngayBatDau) > new Date(ngayKetThuc)) {
            $('#ngayBatDau').addClass('is-invalid');
            $('#ngayBatDauError').text('Ngày bắt đầu phải trước hoặc bằng ngày kết thúc.').show();
            isValid = false;
        }

        // Validate giá trị giảm
        const type = $('input[name="loai"]:checked').val();
        const giaTriGiam = parseNumber($('#giaTriGiam').val() || '0');
        const giaTriGiamToiDa = parseNumber($('#giaTriGiamToiDa').val() || '0');
        const giaTriGiamToiThieu = parseNumber($('#giaTriGiamToiThieu').val() || '0');

        if (type === 'PERCENT' || type === 'CASH') {
            if (!giaTriGiam || parseFloat(giaTriGiam) <= 0) {
                $('#giaTriGiam').addClass('is-invalid');
                $('#giaTriGiamError').text('Giá trị giảm phải lớn hơn 0.').show();
                isValid = false;
            }
            if (type === 'PERCENT' && parseFloat(giaTriGiam) > 100) {
                $('#giaTriGiam').addClass('is-invalid');
                $('#giaTriGiamError').text('Giảm theo % không được vượt quá 100.').show();
                isValid = false;
            }
            if (type === 'PERCENT' && (!giaTriGiamToiDa || parseFloat(giaTriGiamToiDa) <= 0)) {
                $('#giaTriGiamToiDa').addClass('is-invalid');
                $('#giaTriGiamToiDaError').text('Giá trị giảm tối đa phải lớn hơn 0 khi giảm theo %.').show();
                isValid = false;
            }
            if (type === 'CASH' && giaTriGiamToiThieu && parseFloat(giaTriGiam) > parseFloat(giaTriGiamToiThieu)) {
                $('#giaTriGiam').addClass('is-invalid');
                $('#giaTriGiamError').text('Giá trị giảm không được lớn hơn đơn tối thiểu.').show();
                isValid = false;
            }
        } else if (type === 'FREESHIP_CAP') {
            if (!giaTriGiamToiDa || parseFloat(giaTriGiamToiDa) <= 0) {
                $('#giaTriGiamToiDa').addClass('is-invalid');
                $('#giaTriGiamToiDaError').text('Giá trị giảm tối đa phải lớn hơn 0 cho FREESHIP_CAP.').show();
                isValid = false;
            }
            // Thêm validation: giaTriGiamToiDa <= 150% giaTriGiamToiThieu
            if (giaTriGiamToiThieu && parseFloat(giaTriGiamToiThieu) > 0) {
                const maxAllowedDiscount = parseFloat(giaTriGiamToiThieu) * 1.5;
                if (parseFloat(giaTriGiamToiDa) > maxAllowedDiscount) {
                    $('#giaTriGiamToiDa').addClass('is-invalid');
                    $('#giaTriGiamToiDaError').text('Phí giảm tối đa không được vượt quá 150% giá trị đơn hàng tối thiểu.').show();
                    isValid = false;
                }
            }
        } else if (type === 'FREESHIP_FULL') {
            // Không cần giaTriGiam hoặc giaTriGiamToiDa
        }

        // Validate đơn tối thiểu
        if (giaTriGiamToiThieu && parseFloat(giaTriGiamToiThieu) < 0) {
            $('#giaTriGiamToiThieu').addClass('is-invalid');
            $('#giaTriGiamToiThieuError').text('Đơn tối thiểu không được âm.').show();
            isValid = false;
        }

        // Validate mã phiếu
        const ma = $('#ma').val();
        if (!ma || ma.trim() === '') {
            $('#ma').addClass('is-invalid');
            $('#maError').text('Mã phiếu không được để trống.').show();
            isValid = false;
        }

        // Validate tên phiếu
        const ten = $('#ten').val();
        if (!ten || ten.trim() === '') {
            $('#ten').addClass('is-invalid');
            $('#tenError').text('Tên phiếu không được để trống.').show();
            isValid = false;
        }

        // Validate lượt sử dụng
        const isCaNhan = $('input[name="kieuPhieu"]:checked').val() === 'ca_nhan';
        const gioiHanSuDung = $('#gioiHanSuDung').val();
        if (!isCaNhan && (!gioiHanSuDung || parseInt(gioiHanSuDung) <= 0)) {
            $('#gioiHanSuDung').addClass('is-invalid');
            $('#gioiHanSuDungError').text('Lượt sử dụng phải lớn hơn 0 cho phiếu công khai.').show();
            isValid = false;
        }

        // Validate khách hàng cho phiếu cá nhân
        if (isCaNhan && $('.customerCheckbox:checked').length === 0) {
            $('#emailOptions').prepend('<div class="alert alert-danger">Vui lòng chọn ít nhất một khách hàng cho phiếu cá nhân.</div>');
            isValid = false;
        }

        if (isValid) {
            $('#confirmModal').modal('show');
        }

        return isValid;
    }

    $(document).ready(function () {
        const inputs = [
            { selector: '#giaTriGiam', allowDecimal: true },
            { selector: '#giaTriGiamToiDa', allowDecimal: true },
            { selector: '#giaTriGiamToiThieu', allowDecimal: true },
            { selector: '#gioiHanSuDung', allowDecimal: false }
        ];

        inputs.forEach(input => {
            const $el = $(input.selector);
            $el.on('blur', function () {
                const formatted = formatNumber($(this).val(), input.allowDecimal);
                $el.val(formatted);
            });
            if ($el.val()) {
                const formatted = formatNumber($el.val(), input.allowDecimal);
                $el.val(formatted);
            }
        });

        $('#confirmSubmit').on('click', function () {
            inputs.forEach(input => {
                const $el = $(input.selector);
                $el.val(parseNumber($el.val()));
            });
            // Loại bỏ giá trị 'all' khỏi selectedPtttIds trước khi submit
            const selectedValues = $('#paymentMethodSelect').val();
            if (selectedValues && selectedValues.includes('all')) {
                const allOptions = $('#paymentMethodSelect option').map(function() {
                    return $(this).val();
                }).get().filter(val => val !== 'all');
                $('#paymentMethodSelect').val(allOptions).trigger('change');
            }
            $('#createVoucherForm').submit();
        });

        $('#searchCustomerInput').on('keyup', function () {
            console.log('searchCustomerInput: value=', $(this).val());
            const keyword = $(this).val().toLowerCase();
            $('#customerTableBody tr').each(function () {
                const isVisible = $(this).text().toLowerCase().indexOf(keyword) > -1;
                $(this).toggle(isVisible);
            });
            updateSelectAllCheckbox();
        });

        $('#selectAllCustomers').on('change', function () {
            console.log('selectAllCustomers: checked=', $(this).is(':checked'));
            const checked = $(this).is(':checked');
            $('.customerCheckbox:visible').prop('checked', checked);
        });

        $(document).on('change', '.customerCheckbox', function () {
            console.log('customerCheckbox: changed');
            updateSelectAllCheckbox();
        });

        $('#paymentMethodSelect').select2({
            placeholder: 'Chọn phương thức...',
            allowClear: true,
            closeOnSelect: false,
            width: '100%'
        }).on('change', function () {
            console.log('paymentMethodSelect: selected=', $(this).val());
            const selectedValues = $(this).val() || [];
            const allOptions = $('#paymentMethodSelect option').map(function() {
                return $(this).val();
            }).get().filter(val => val !== 'all');
            if (selectedValues.includes('all')) {
                $(this).val(allOptions).trigger('change.select2');
            } else if (selectedValues.length === allOptions.length) {
                $(this).val(['all'].concat(allOptions)).trigger('change.select2');
            }
        });

        // Format datetime-local inputs
        const now = new Date('2025-08-15T00:30:00+07:00');
        const formatDateTime = (date) => {
            return date.toISOString().slice(0, 16);
        };

        $('#ngayBatDau, #ngayKetThuc').on('blur', function () {
            const val = $(this).val();
            if (val) {
                $(this).val(val); // Keep format yyyy-MM-ddTHH:mm
            }
        });

        toggleScopeFields();
        toggleDiscountFields();
        toggleUsageCount();
        showToast('successToast');
        showToast('errorToast');
        showToast('infoToast');
    });
</script>
</body>
</html>