<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tạo chiến dịch giảm giá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/sidebar.js}" defer></script>
    <style>
        :root{ --primary:#153054; --secondary:#9FD5F7; --text:#263238; --line:#e9ecef; }
        body{background:#f6f9fb;color:var(--text)}
        .content{padding:2rem;margin-left:256px;margin-top:70px}
        .page-header{background:#fff;padding:1.5rem 2rem;margin:-2rem -2rem 2rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .page-header h2{font-weight:700;color:#1f2937;margin:0}
        .btn-primary{background:var(--primary);border-color:var(--primary)}
        .btn-primary:hover{filter:brightness(1.08)}
        .btn-outline-secondary{border-color:var(--primary);color:var(--primary)}
        .btn-outline-secondary:hover{background:var(--primary);color:#fff}
        .btn-success{background:#19a974;border-color:#19a974}
        .card-header{background:linear-gradient(90deg,var(--primary),#1e4066);color:#fff;font-weight:600}
        .role-badge{background:linear-gradient(135deg,var(--primary),#1e4066);color:#fff;padding:.5rem 1rem;border-radius:20px;font-size:.875rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;box-shadow:0 4px 15px rgba(21,48,84,.25);position:fixed;top:20px;right:20px;z-index:1000}
        .role-badge.employee{background:linear-gradient(135deg,#1f7a8c,var(--secondary));color:#0b2239}
        .form-control:focus,.form-select:focus{border-color:var(--secondary);box-shadow:0 0 0 .2rem rgba(159,213,247,.35)}
        .input-group-text{border-right:0}
        .table th,.table td{vertical-align:middle}
        .pagination{margin-bottom:0}
        .search-container{margin-bottom:15px}
        .loading-spinner{display:none;text-align:center;padding:20px}
        .form-check-input:checked{background-color:var(--primary);border-color:var(--primary)}
        a{color:var(--primary)} a:hover{color:#0f223f}
    </style>
</head>
<body>
<div class="d-flex">
    <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>

    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
        <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </nav>

    <div class="role-badge" th:classappend="${isAdmin != null && isAdmin} ? '' : ' employee'">
        <i class="fas fa-user-shield me-1" th:if="${isAdmin != null && isAdmin}"></i>
        <i class="fas fa-user me-1" th:unless="${isAdmin != null && isAdmin}"></i>
        <span th:text="${isAdmin != null && isAdmin} ? 'ADMIN' : 'EMPLOYEE'"></span>
    </div>

    <div class="content" id="content">
        <div class="page-header">
            <div class="d-flex align-items-center">
                <a th:href="@{/acvstore/chien-dich-giam-gia}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </a>
                <h2><i class="fas fa-plus me-2"></i>Tạo chiến dịch giảm giá</h2>
            </div>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>

        <form th:action="@{/acvstore/chien-dich-giam-gia/create}"
              th:object="${chienDich}"
              method="post"
              id="discountForm">

            <div class="row g-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">Thông tin chiến dịch giảm giá</div>
                        <div class="card-body row g-3">
                            <!-- MÃ: 6..50, chữ & số, viết liền -->
                            <div class="col-md-4">
                                <label class="form-label">Mã chiến dịch</label>
                                <input type="text" class="form-control"
                                       th:field="*{ma}"
                                       required minlength="6" maxlength="50"
                                       pattern="[A-Za-z0-9]+"
                                       oninput="this.setCustomValidity('')"
                                       onblur="normalizeMa(this); validateMa(this)"
                                       oninvalid="this.setCustomValidity('Mã phải từ 6–50 ký tự, chỉ gồm chữ và số, viết liền, không ký tự đặc biệt.')">
                            </div>

                            <!-- TÊN: cho chữ (có dấu), số, '-', '/'; giữa các nhóm 1 khoảng; >=6 ký tự (không tính khoảng) -->
                            <div class="col-md-4">
                                <label class="form-label">Tên chiến dịch</label>
                                <input type="text" class="form-control"
                                       th:field="*{ten}"
                                       required minlength="6" maxlength="100"
                                       oninput="this.setCustomValidity('')"
                                       onblur="validateTen(this); if(this.checkValidity()) normalizeTen(this);"
                                       oninvalid="this.setCustomValidity('Tên phải có ít nhất 6 ký tự (không tính khoảng trắng), chỉ gồm chữ (có dấu), số, dấu gạch ngang (-) và dấu gạch chéo (/), giữa các nhóm cách 1 khoảng trắng, và không có khoảng trắng ở đầu/cuối.')">
                            </div>

                            <!-- PHẦN TRĂM: số nguyên 1..99 -->
                            <div class="col-md-4">
                                <label class="form-label">% Giảm</label>
                                <input type="number" class="form-control" th:field="*{phanTramGiam}" required
                                       min="1" max="99" step="1"
                                       oninput="validatePercentInt(this)"
                                       oninvalid="this.setCustomValidity('Phần trăm giảm phải là số nguyên từ 1 đến 99.')">
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Ngày bắt đầu</label>
                                <input type="datetime-local" class="form-control" th:field="*{ngayBatDau}" required
                                       oninvalid="this.setCustomValidity(this.validity.valueMissing ? 'Vui lòng chọn ngày bắt đầu.' : '')"
                                       oninput="this.setCustomValidity('')">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ngày kết thúc</label>
                                <input type="datetime-local" class="form-control" th:field="*{ngayKetThuc}" required
                                       oninvalid="this.setCustomValidity(this.validity.valueMissing ? 'Vui lòng chọn ngày kết thúc.' : '')"
                                       oninput="this.setCustomValidity('')">
                            </div>
                            <div class="col-md-12 d-flex justify-content-end">
                                <button type="reset" class="btn btn-outline-secondary me-2">Làm mới</button>
                                <button type="button" class="btn btn-primary" id="openConfirmModalBtn">
                                    Tạo chiến dịch
                                </button>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danh sách SP + Chi tiết SP -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Danh sách sản phẩm</div>
                        <div class="card-body">
                            <div class="search-container">
                                <div class="input-group mb-3">
                                    <span class="input-group-text bg-white">
                                        <i class="fas fa-search text-secondary"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0" id="productSearchInput" placeholder="Nhập tên sản phẩm...">
                                </div>
                            </div>
                            <div class="loading-spinner" id="productsLoading">
                                <div class="spinner-border" role="status" style="color:var(--primary)">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <p class="mt-2">Đang tải dữ liệu...</p>
                            </div>
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllProducts" class="form-check-input"></th>
                                    <th>Mã</th>
                                    <th>Tên sản phẩm</th>
                                </tr>
                                </thead>
                                <tbody id="productTableBody"><!-- JS sẽ render kết quả ở đây --></tbody>
                            </table>

                            <nav id="productPagination"><!-- JS sẽ render phân trang ở đây --></nav>


                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Chi tiết sản phẩm</div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllDetails" class="form-check-input"></th>
                                    <th>Tên SP</th>
                                    <th>Màu</th>
                                    <th>Size</th>
                                    <th>Giá</th>
                                    <th>Tồn</th>
                                </tr>
                                </thead>
                                <tbody id="productDetailTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <input type="hidden" id="selectedProductDetailIdsInput" name="selectedProductDetailIds" value="">
        </form>
    </div>
</div>

<!-- Modal xác nhận tạo chiến dịch -->
<div class="modal fade" id="confirmCreateModal" tabindex="-1" aria-labelledby="confirmCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background:var(--primary);color:#fff">
                <h5 class="modal-title" id="confirmCreateModalLabel">Xác nhận tạo chiến dịch</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">Bạn có chắc chắn muốn tạo chiến dịch giảm giá với các thông tin đã nhập không?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmSubmitBtn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ===== Helper chuẩn hoá + validate MA/TEN/% =====
    function normalizeMa(el){
        if(!el) return;
        // .trim() và loại toàn bộ whitespace bên trong -> viết liền
        el.value = (el.value || '').trim().replace(/\s+/g,'');
    }
    function validateMa(el){
        if(!el) return;
        const v = (el.value || '');
        const lenOk = v.length >= 6 && v.length <= 50;
        const formatOk = /^[A-Za-z0-9]+$/.test(v);
        const ok = (!v || (lenOk && formatOk));
        el.setCustomValidity(ok ? '' : (!lenOk
            ? 'Mã phải từ 6 đến 50 ký tự.'
            : 'Mã chỉ gồm chữ và số, viết liền, không ký tự đặc biệt.'));
    }

    // KHÔNG normalize ngay – chỉ normalize SAU KHI hợp lệ
    function normalizeTen(el){
        if(!el) return;
        // trim + gộp nhiều khoảng thành 1 (sau khi đã pass validate)
        el.value = (el.value || '').trim().replace(/\s+/g,' ');
    }

    function validateTen(el){
        if(!el) return;
        const raw = el.value || '';

        if (raw === '') { el.setCustomValidity(''); return; } // required xử lý riêng

        // Lấy nội dung để kiểm tra: cắt đầu/cuối CHỈ để kiểm tra (KHÔNG gán ngược)
        const trimmed = raw.trim();

        // 1) Không cho 2+ khoảng trắng liên tiếp ở GIỮA
        if (/\s{2,}/.test(trimmed)) {
            el.setCustomValidity('Giữa các từ chỉ được 1 khoảng trắng.');
            return;
        }

        // 2) Cho phép: chữ (có dấu), số, '-', '/'; các nhóm cách nhau đúng 1 khoảng trắng
        //    Dùng Unicode property cho \\p{L} với cờ 'u'
        const allowed = /^[\p{L}\d\-\/]+(?: [\p{L}\d\-\/]+)*$/u;
        if (!allowed.test(trimmed)) {
            el.setCustomValidity('Tên chỉ được dùng chữ (có dấu), số, dấu gạch ngang (-) và dấu gạch chéo (/), giữa các nhóm cách 1 khoảng trắng.');
            return;
        }

        // 3) Độ dài không tính khoảng trắng ≥ 6
        const nonSpaceLen = trimmed.replace(/\s+/g,'').length;
        if (nonSpaceLen < 6) {
            el.setCustomValidity('Tên phải có ít nhất 6 ký tự (không tính khoảng trắng).');
            return;
        }

        // 4) Tối đa 100 ký tự tổng thể
        if (trimmed.length > 100) {
            el.setCustomValidity('Tên tối đa 100 ký tự.');
            return;
        }

        el.setCustomValidity('');
    }

    function validatePercentInt(el){
        if(!el) return;
        const v = el.value;
        const intOk = /^\d+$/.test(v);
        const num = Number(v);
        const ok = intOk && num >= 1 && num <= 99;
        el.setCustomValidity(ok || v==='' ? '' : 'Phần trăm giảm phải là số nguyên từ 1 đến 99.');
    }

    // ======= (giữ nguyên) các biến & hàm chọn SP/CTSP, pagination... =======
    const STORAGE_KEYS = { selectedProducts:'selectedProductIds', selectedDetails:'selectedDetailIds' };
    const selectedProductIds = new Set(JSON.parse(localStorage.getItem(STORAGE_KEYS.selectedProducts) || '[]'));
    const selectedDetailIds  = new Set(JSON.parse(localStorage.getItem(STORAGE_KEYS.selectedDetails) || '[]'));
    let currentSearchPage = 0; const pageSize = 5;

    function saveSelections(){
        localStorage.setItem(STORAGE_KEYS.selectedProducts, JSON.stringify([...selectedProductIds]));
        localStorage.setItem(STORAGE_KEYS.selectedDetails, JSON.stringify([...selectedDetailIds]));
        document.getElementById("selectedProductDetailIdsInput").value = [...selectedDetailIds].join(',');
    }
    function clearSelections(){
        localStorage.removeItem(STORAGE_KEYS.selectedProducts);
        localStorage.removeItem(STORAGE_KEYS.selectedDetails);
        selectedProductIds.clear(); selectedDetailIds.clear();
    }
    function restoreSelectedProducts(){
        document.querySelectorAll(".product-checkbox").forEach(cb => { cb.checked = selectedProductIds.has(cb.value); });
        updateSelectAll("#selectAllProducts", ".product-checkbox");
        loadProductDetails();
    }
    function updateSelectAll(masterSelector,itemSelector){
        const all = document.querySelectorAll(itemSelector);
        const master = document.querySelector(masterSelector);
        if(all.length>0){ master.checked = Array.from(all).every(cb=>cb.checked); }
    }
    function loadProductDetails(){
        const body=document.getElementById("productDetailTableBody");
        if(selectedProductIds.size===0) return body.innerHTML="";
        saveSelections();
        fetch(`/acvstore/chien-dich-giam-gia/multiple-product-details?productIds=${[...selectedProductIds].join(',')}`)
            .then(res=>res.json())
            .then(data=>{
                body.innerHTML = data.map(detail=>`
                    <tr>
                        <td><input type="checkbox" class="detail-checkbox form-check-input" value="${detail.id}" ${selectedDetailIds.has(detail.id)?'checked':''}></td>
                        <td>${detail.sanPham.tenSanPham}</td>
                        <td>${detail.mauSac?.tenMau ?? 'N/A'}</td>
                        <td>${detail.kichCo?.ten ?? 'N/A'}</td>
                        <td>${formatPrice(detail.gia)}</td>
                        <td>${detail.soLuongTonKho}</td>
                    </tr>`).join('');
                attachCheckboxEvents(".detail-checkbox", selectedDetailIds);
                updateSelectAll("#selectAllDetails",".detail-checkbox");
            });
    }
    function formatPrice(price){ if(price==null) return 'Không có giá'; return new Intl.NumberFormat('vi-VN',{minimumFractionDigits:0,maximumFractionDigits:0}).format(price)+' VNĐ'; }
    function attachCheckboxEvents(selector, storeSet){
        document.querySelectorAll(selector).forEach(cb=>{
            cb.addEventListener("change", ()=>{
                const id=cb.value; cb.checked?storeSet.add(id):storeSet.delete(id);
                saveSelections();
                if(selector===".product-checkbox") loadProductDetails();
            });
        });
    }
    function attachMasterCheckboxEvents(){
        document.getElementById("selectAllProducts")?.addEventListener("change", function(){
            document.querySelectorAll(".product-checkbox").forEach(cb=>{ cb.checked=this.checked; this.checked?selectedProductIds.add(cb.value):selectedProductIds.delete(cb.value); });
            saveSelections(); loadProductDetails();
        });
        document.getElementById("selectAllDetails")?.addEventListener("change", function(){
            document.querySelectorAll(".detail-checkbox").forEach(cb=>{ cb.checked=this.checked; this.checked?selectedDetailIds.add(cb.value):selectedDetailIds.delete(cb.value); });
            saveSelections();
        });
    }
    function searchProducts(query, page = 0){
        document.getElementById("productsLoading").style.display = "block";
        const selectedIdsParam = [...selectedProductIds].join(',');
        fetch(`/acvstore/chien-dich-giam-gia/search-products?keyword=${encodeURIComponent(query)}&page=${page}&size=${pageSize}&selectedIds=${selectedIdsParam}`)
            .then(res => res.json())
            .then(data => {
                renderSearchResults(data.content);
                renderPagination(data.totalPages, data.number, query);
                document.getElementById("productsLoading").style.display = "none";
            });
    }

    function renderSearchResults(products){
        const tbody = document.getElementById("productTableBody");
        tbody.innerHTML = products.length===0
            ? `<tr><td colspan="3" class="text-center">Không tìm thấy sản phẩm nào</td></tr>`
            : products.map(p => `
      <tr class="product-row" data-id="${p.id}">
        <td><input type="checkbox" class="product-checkbox form-check-input" value="${p.id}" ${selectedProductIds.has(p.id)?'checked':''}></td>
        <td>${p.maSanPham}</td>
        <td>${p.tenSanPham}</td>
      </tr>`).join('');

        attachCheckboxEvents(".product-checkbox", selectedProductIds);
        updateSelectAll("#selectAllProducts", ".product-checkbox");
        loadProductDetails(); // đảm bảo panel chi tiết khớp selection
    }

    function renderPagination(totalPages, currentPage, keyword){
        const pagination = document.getElementById("productPagination");

        // Luôn hiển thị ít nhất 1 trang
        const pages = Math.max(Number(totalPages) || 0, 1);
        const page = Math.min(Math.max(Number(currentPage) || 0, 0), pages - 1);
        const kw = (keyword ?? "");

        let html = `<ul class="pagination justify-content-center">`;

        // Prev
        const prevDisabled = page <= 0 ? " disabled" : "";
        const prevPage = page > 0 ? page - 1 : 0;
        html += `
      <li class="page-item${prevDisabled}">
        <a class="page-link pagination-link" data-page="${prevPage}" data-keyword="${kw}" href="#">Trước</a>
      </li>`;

        // Numbers
        for (let i = 0; i < pages; i++) {
            html += `
          <li class="page-item ${i === page ? "active" : ""}">
            <a class="page-link pagination-link" data-page="${i}" data-keyword="${kw}" href="#">${i + 1}</a>
          </li>`;
        }

        // Next
        const nextDisabled = page >= pages - 1 ? " disabled" : "";
        const nextPage = page < pages - 1 ? page + 1 : pages - 1;
        html += `
      <li class="page-item${nextDisabled}">
        <a class="page-link pagination-link" data-page="${nextPage}" data-keyword="${kw}" href="#">Sau</a>
      </li>`;

        html += `</ul>`;
        pagination.innerHTML = html;

        // Gán sự kiện (bỏ qua nút disabled)
        document.querySelectorAll("#productPagination .pagination-link").forEach(link=>{
            link.addEventListener("click", function(e){
                e.preventDefault();
                if (this.closest(".page-item")?.classList.contains("disabled")) return;
                const p = parseInt(this.getAttribute("data-page"), 10);
                const q = this.getAttribute("data-keyword") ?? "";
                currentSearchPage = p;
                searchProducts(q, p);
            });
        });
    }


    function initEvents(){
        document.querySelector("button[type='reset']")?.addEventListener("click", ()=>{
            clearSelections();
            document.querySelectorAll(".product-checkbox, .detail-checkbox").forEach(cb=>cb.checked=false);
            document.getElementById("selectAllProducts").checked=false;
            document.getElementById("selectAllDetails").checked=false;
            document.getElementById("productDetailTableBody").innerHTML="";
            document.getElementById("selectedProductDetailIdsInput").value="";
            document.getElementById("productSearchInput").value="";
            document.getElementById("productPagination").innerHTML="";
        });
        document.getElementById("productSearchInput").addEventListener("input", function(){
            clearTimeout(this._searchTimer);
            const query=this.value.trim();
            this._searchTimer=setTimeout(()=>{ searchProducts(query,0); },300);
        });
        document.getElementById("discountForm").addEventListener("submit", saveSelections);
    }
    function setupDatetimeValidation(){
        const form=document.getElementById('discountForm');
        const startInput=form.querySelector('input[name="ngayBatDau"]');
        const endInput=form.querySelector('input[name="ngayKetThuc"]');
        const percent=form.querySelector('input[name="phanTramGiam"]');
        const maInput=form.querySelector('input[name="ma"]');
        const tenInput=form.querySelector('input[name="ten"]');

        const pad=n=>String(n).padStart(2,'0');
        const toLocal=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

        if(startInput){ const now=new Date(); now.setSeconds(0,0); startInput.min=toLocal(now); }

        if(startInput){
            startInput.addEventListener('invalid', function(){
                this.setCustomValidity(this.validity.valueMissing ? 'Vui lòng chọn ngày bắt đầu.' : '');
            });
            startInput.addEventListener('input', function(){ this.setCustomValidity(''); syncRange(); });
            startInput.addEventListener('change', syncRange);
        }
        if(endInput){
            endInput.addEventListener('invalid', function(){
                if(this.validity.valueMissing){
                    this.setCustomValidity('Vui lòng chọn ngày kết thúc.');
                }else if(startInput && this.value && startInput.value && this.value < startInput.value){
                    this.setCustomValidity('Ngày kết thúc phải sau hoặc bằng ngày bắt đầu.');
                }else this.setCustomValidity('');
            });
            endInput.addEventListener('input', function(){ this.setCustomValidity(''); syncRange(); });
            endInput.addEventListener('change', syncRange);
        }
        function syncRange(){
            if(startInput && endInput){
                if(startInput.value) endInput.min = startInput.value;
                if(endInput.value && startInput.value && endInput.value < startInput.value){
                    endInput.setCustomValidity('Ngày kết thúc phải sau hoặc bằng ngày bắt đầu.');
                }else endInput.setCustomValidity('');
            }
        }
        if(percent){
            percent.addEventListener('input', function(){ validatePercentInt(percent); });
        }
        // Cho phép gõ thoải mái lúc nhập, validate khi blur
        if(maInput){
            maInput.addEventListener('input', ()=> maInput.setCustomValidity(''));
            maInput.addEventListener('blur', ()=>{ normalizeMa(maInput); validateMa(maInput); });
        }
        if(tenInput){
            tenInput.addEventListener('input', ()=> tenInput.setCustomValidity(''));
            // VALIDATE trước, nếu hợp lệ mới normalize
            tenInput.addEventListener('blur',  ()=>{
                validateTen(tenInput);
                if (tenInput.checkValidity()) normalizeTen(tenInput);
            });
        }
    }

    function initFormState(){
        const hasError = !!document.querySelector(".alert.alert-danger");
        if (window.location.pathname.includes("/acvstore/chien-dich-giam-gia/create") && !hasError) {
            clearSelections();
        }
        attachMasterCheckboxEvents();
        initEvents();
        saveSelections();
        setupDatetimeValidation(); // 👈 sửa lại
        searchProducts('', 0);     // load luôn sản phẩm trang đầu
    }


    document.addEventListener("DOMContentLoaded", initFormState);

    document.getElementById("confirmSubmitBtn").addEventListener("click", function(){
        const form=document.getElementById("discountForm");
        const maInput=form.querySelector('input[name="ma"]');
        const tenInput=form.querySelector('input[name="ten"]');
        const percent=form.querySelector('input[name="phanTramGiam"]');

        if(maInput){ normalizeMa(maInput); validateMa(maInput); }
        if(tenInput){
            validateTen(tenInput);
            if (tenInput.checkValidity()) normalizeTen(tenInput);
        }
        if(percent){ validatePercentInt(percent); }

        saveSelections();
        if(form.checkValidity()){
            form.requestSubmit();
        }else{
            const modalEl=document.getElementById('confirmCreateModal');
            const modal=bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            setTimeout(()=>{
                form.reportValidity();
                const firstInvalid=form.querySelector(':invalid');
                if(firstInvalid) firstInvalid.focus({preventScroll:false});
            },200);
        }
    });
    let submitting = false;

    function showConfirmThenSubmit(){
        const form=document.getElementById("discountForm");
        const maInput=form.querySelector('input[name="ma"]');
        const tenInput=form.querySelector('input[name="ten"]');
        const percent=form.querySelector('input[name="phanTramGiam"]');

        if(maInput){ normalizeMa(maInput); validateMa(maInput); }
        if(tenInput){
            validateTen(tenInput);
            if (tenInput.checkValidity()) normalizeTen(tenInput);
        }
        if(percent){ validatePercentInt(percent); }

        saveSelections();

        if(!form.checkValidity()){
            form.reportValidity();
            form.querySelector(':invalid')?.focus({preventScroll:false});
            return;
        }

        Swal.fire({
            title: 'Tạo chiến dịch?',
            html: 'Bạn có chắc chắn muốn tạo chiến dịch giảm giá với các thông tin đã nhập không?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Xác nhận',
            cancelButtonText: 'Hủy',
            reverseButtons: true,
            focusCancel: true
        }).then(res=>{
            if(res.isConfirmed){
                submitting = true;
                Swal.fire({
                    title: 'Đang xử lý...',
                    html: 'Vui lòng đợi trong giây lát',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                        form.requestSubmit();
                    }
                });
            }
        });
    }

    document.addEventListener("DOMContentLoaded", ()=>{
        document.getElementById("openConfirmModalBtn")?.addEventListener("click", showConfirmThenSubmit);
        document.getElementById("discountForm")?.addEventListener("submit", function(e){
            if(!submitting){
                e.preventDefault();
                showConfirmThenSubmit();
            }
        });
    });

</script>

<script th:src="@{/js/notification.js}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>
</html>
