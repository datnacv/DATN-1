<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Tạo chiến dịch giảm giá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/sidebar.js}" defer></script>
    <style>
        .table th, .table td { vertical-align: middle; }
        .card-header { font-weight: bold; }
        .pagination { margin-bottom: 0; }
        .search-container { margin-bottom: 15px; }
        .search-container h5 { margin-bottom: 10px; font-weight: 500; }
        .input-group-text { border-right: 0; }
        .loading-spinner { display: none; text-align: center; padding: 20px; }
        .role-badge {
            background: linear-gradient(135deg, #6f42c1, #8b5cf6);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .role-badge.employee {
            background: linear-gradient(135deg, #28a745, #34ce57);
        }
        .content {
            padding: 2rem;
            margin-left: 256px;
            margin-top: 70px;
        }
        .page-header {
            background-color: #fff;
            padding: 1.5rem 2rem;
            margin: -2rem -2rem 2rem -2rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-header h2 {
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }
    </style>
</head>
<body>
<div class="d-flex">
    <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>

    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
        <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </nav>

    <!-- Role Badge -->
    <div class="role-badge" th:classappend="${isAdmin != null && isAdmin} ? '' : 'employee'">
        <i class="fas fa-user-shield me-1" th:if="${isAdmin != null && isAdmin}"></i>
        <i class="fas fa-user me-1" th:unless="${isAdmin != null && isAdmin}"></i>
        <span th:text="${isAdmin != null && isAdmin} ? 'ADMIN' : 'EMPLOYEE'"></span>
    </div>

    <!-- Nội dung chính bên phải -->
    <div class="content" id="content">
        <div class="page-header">
            <div class="d-flex align-items-center">
                <a th:href="@{/acvstore/chien-dich-giam-gia}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </a>
                <h2><i class="fas fa-plus me-2"></i>Tạo chiến dịch giảm giá</h2>
            </div>
        </div>

        <form th:action="@{/acvstore/chien-dich-giam-gia/create}" method="post" id="discountForm">
            <div class="row g-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">Thông tin chiến dịch giảm giá</div>
                        <div class="card-body row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Mã chiến dịch</label>
                                <input type="text" class="form-control" name="ma" required
                                       oninvalid="this.setCustomValidity('Vui lòng nhập mã chiến dịch hợp lệ.')"
                                       oninput="this.setCustomValidity('')">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tên chiến dịch</label>
                                <input type="text" class="form-control" name="ten" required maxlength="100"
                                       oninvalid="this.setCustomValidity('Vui lòng nhập tên chiến dịch.')"
                                       oninput="this.setCustomValidity('')">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">% Giảm</label>
                                <input type="number" step="0.01" class="form-control" name="phanTramGiam" required min="0.1" max="100"
                                       oninvalid="this.setCustomValidity('Nhập phần trăm giảm từ 0.1 đến 100%.')"
                                       oninput="this.setCustomValidity('')">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Số lượng</label>
                                <input type="number" class="form-control" name="soLuong" required min="1"
                                       oninvalid="this.setCustomValidity('Vui lòng nhập số lượng lớn hơn 0.')"
                                       oninput="this.setCustomValidity('')">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ngày bắt đầu</label>
                                <input type="datetime-local" class="form-control" name="ngayBatDau"
                                       th:value="${chienDich.ngayBatDau != null ? #temporals.format(chienDich.ngayBatDau, 'yyyy-MM-dd''T''HH:mm') : ''}"
                                       required oninvalid="this.setCustomValidity('Vui lòng chọn ngày bắt đầu.')"
                                       oninput="this.setCustomValidity('')">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ngày kết thúc</label>
                                <input type="datetime-local" class="form-control" name="ngayKetThuc"
                                       th:value="${chienDich.ngayKetThuc != null ? #temporals.format(chienDich.ngayKetThuc, 'yyyy-MM-dd''T''HH:mm') : ''}"
                                       required oninvalid="this.setCustomValidity('Vui lòng chọn ngày kết thúc.')"
                                       oninput="this.setCustomValidity('')">
                            </div>
                            <div class="col-md-12 d-flex justify-content-end">
                                <button type="reset" class="btn btn-outline-secondary me-2">Làm mới</button>
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmCreateModal">
                                    Tạo chiến dịch
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- CHỌN SẢN PHẨM VÀ CHI TIẾT -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Danh sách sản phẩm</div>
                        <div class="card-body">
                            <div class="search-container">
                                <div class="input-group mb-3">
                                    <span class="input-group-text bg-white">
                                        <i class="fas fa-search text-secondary"></i>
                                    </span>
                                    <input type="text" class="form-control border-start-0" id="productSearchInput" placeholder="Nhập tên sản phẩm...">
                                </div>
                            </div>
                            <div class="loading-spinner" id="productsLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                                <p class="mt-2">Đang tải dữ liệu...</p>
                            </div>
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllProducts"></th>
                                    <th>Mã</th>
                                    <th>Tên sản phẩm</th>
                                </tr>
                                </thead>
                                <tbody id="productTableBody">
                                <tr th:each="product : ${productPage.content}" th:data-id="${product.id}" class="product-row">
                                    <td><input type="checkbox" class="product-checkbox" th:value="${product.id}"></td>
                                    <td th:text="${product.maSanPham}"></td>
                                    <td th:text="${product.tenSanPham}"></td>
                                </tr>
                                </tbody>
                            </table>
                            <nav id="productPagination">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" th:classappend="${currentProductPage == 0} ? 'disabled'">
                                        <a class="page-link pagination-link" th:data-page="${currentProductPage - 1}" href="javascript:void(0)">Trước</a>
                                    </li>
                                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalProductPages - 1)}"
                                        th:classappend="${i == currentProductPage} ? 'active'">
                                        <a class="page-link pagination-link" th:data-page="${i}" href="javascript:void(0)" th:text="${i + 1}"></a>
                                    </li>
                                    <li class="page-item" th:classappend="${currentProductPage + 1 == totalProductPages} ? 'disabled'">
                                        <a class="page-link pagination-link" th:data-page="${currentProductPage + 1}" href="javascript:void(0)">Sau</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Chi tiết sản phẩm</div>
                        <div class="card-body">
                            <table class="table table-bordered">
                                <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllDetails"></th>
                                    <th>Tên SP</th>
                                    <th>Màu</th>
                                    <th>Size</th>
                                    <th>Giá</th>
                                    <th>Tồn</th>
                                </tr>
                                </thead>
                                <tbody id="productDetailTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <input type="hidden" id="selectedProductDetailIdsInput" name="selectedProductDetailIds" value="">
        </form>
    </div>
</div>

<!-- Modal xác nhận tạo chiến dịch -->
<div class="modal fade" id="confirmCreateModal" tabindex="-1" aria-labelledby="confirmCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="confirmCreateModalLabel">Xác nhận tạo chiến dịch</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn tạo chiến dịch giảm giá với các thông tin đã nhập không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-success" id="confirmSubmitBtn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEYS = {
        selectedProducts: 'selectedProductIds',
        selectedDetails: 'selectedDetailIds'
    };

    const selectedProductIds = new Set(JSON.parse(localStorage.getItem(STORAGE_KEYS.selectedProducts) || '[]'));
    const selectedDetailIds = new Set(JSON.parse(localStorage.getItem(STORAGE_KEYS.selectedDetails) || '[]'));

    let currentSearchPage = 0;
    const pageSize = 5;

    function saveSelections() {
        localStorage.setItem(STORAGE_KEYS.selectedProducts, JSON.stringify([...selectedProductIds]));
        localStorage.setItem(STORAGE_KEYS.selectedDetails, JSON.stringify([...selectedDetailIds]));
        document.getElementById("selectedProductDetailIdsInput").value = [...selectedDetailIds].join(',');
    }

    function clearSelections() {
        localStorage.removeItem(STORAGE_KEYS.selectedProducts);
        localStorage.removeItem(STORAGE_KEYS.selectedDetails);
        selectedProductIds.clear();
        selectedDetailIds.clear();
    }

    function restoreSelectedProducts() {
        document.querySelectorAll(".product-checkbox").forEach(cb => {
            cb.checked = selectedProductIds.has(cb.value);
        });
        updateSelectAll("#selectAllProducts", ".product-checkbox");
        loadProductDetails();
    }

    function updateSelectAll(masterSelector, itemSelector) {
        const all = document.querySelectorAll(itemSelector);
        const master = document.querySelector(masterSelector);
        if (all.length > 0) {
            master.checked = Array.from(all).every(cb => cb.checked);
        }
    }

    function loadProductDetails() {
        const body = document.getElementById("productDetailTableBody");
        if (selectedProductIds.size === 0) return body.innerHTML = "";

        saveSelections();
        fetch(`/acvstore/chien-dich-giam-gia/multiple-product-details?productIds=${[...selectedProductIds].join(',')}`)
            .then(res => res.json())
            .then(data => {
                body.innerHTML = data.map(detail => `
                    <tr>
                        <td><input type="checkbox" class="detail-checkbox" value="${detail.id}"></td>
                        <td>${detail.sanPham.tenSanPham}</td>
                        <td>${detail.mauSac?.tenMau ?? 'N/A'}</td>
                        <td>${detail.kichCo?.ten ?? 'N/A'}</td>
                        <td>${formatPrice(detail.gia)}</td>
                        <td>${detail.soLuongTonKho}</td>
                    </tr>
                `).join('');
                attachCheckboxEvents(".detail-checkbox", selectedDetailIds);
                updateSelectAll("#selectAllDetails", ".detail-checkbox");
            });
    }

    function formatPrice(price) {
        if (price == null) return 'Không có giá';
        return new Intl.NumberFormat('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(price) + ' VNĐ';
    }

    function attachCheckboxEvents(selector, storeSet) {
        document.querySelectorAll(selector).forEach(cb => {
            cb.addEventListener("change", () => {
                const id = cb.value;
                cb.checked ? storeSet.add(id) : storeSet.delete(id);
                saveSelections();
                if (selector === ".product-checkbox") loadProductDetails();
            });
        });
    }

    function attachMasterCheckboxEvents() {
        document.getElementById("selectAllProducts")?.addEventListener("change", function () {
            document.querySelectorAll(".product-checkbox").forEach(cb => {
                cb.checked = this.checked;
                this.checked ? selectedProductIds.add(cb.value) : selectedProductIds.delete(cb.value);
            });
            saveSelections();
            loadProductDetails();
        });

        document.getElementById("selectAllDetails")?.addEventListener("change", function () {
            document.querySelectorAll(".detail-checkbox").forEach(cb => {
                cb.checked = this.checked;
                this.checked ? selectedDetailIds.add(cb.value) : selectedDetailIds.delete(cb.value);
            });
            saveSelections();
        });
    }

    function searchProducts(query, page = 0) {
        document.getElementById("productsLoading").style.display = "block";

        fetch(`/acvstore/chien-dich-giam-gia/search-products?keyword=${encodeURIComponent(query)}&page=${page}&size=${pageSize}`)
            .then(res => res.json())
            .then(data => {
                renderSearchResults(data.content);
                renderPagination(data.totalPages, data.number, query);
                document.getElementById("productsLoading").style.display = "none";
            });
    }

    function renderSearchResults(products) {
        const tbody = document.getElementById("productTableBody");
        tbody.innerHTML = products.length === 0
            ? `<tr><td colspan="3" class="text-center">Không tìm thấy sản phẩm nào</td></tr>`
            : products.map(p => `
                <tr class="product-row" data-id="${p.id}">
                    <td><input type="checkbox" class="product-checkbox" value="${p.id}" ${selectedProductIds.has(p.id) ? 'checked' : ''}></td>
                    <td>${p.maSanPham}</td>
                    <td>${p.tenSanPham}</td>
                </tr>
            `).join('');
        attachCheckboxEvents(".product-checkbox", selectedProductIds);
    }

    function renderPagination(totalPages, currentPage, keyword) {
        const pagination = document.getElementById("productPagination");
        if (totalPages <= 1) {
            pagination.innerHTML = "";
            return;
        }

        let html = '';
        for (let i = 0; i < totalPages; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link pagination-link" href="#" data-page="${i}" data-keyword="${keyword}">${i + 1}</a>
                </li>
            `;
        }

        pagination.innerHTML = `<ul class="pagination justify-content-center">${html}</ul>`;

        document.querySelectorAll(".pagination-link").forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute("data-page"));
                const keyword = this.getAttribute("data-keyword");
                currentSearchPage = page;
                searchProducts(keyword, page);
            });
        });
    }

    function initEvents() {
        document.querySelector("button[type='reset']")?.addEventListener("click", () => {
            clearSelections();
            document.querySelectorAll(".product-checkbox, .detail-checkbox").forEach(cb => cb.checked = false);
            document.getElementById("selectAllProducts").checked = false;
            document.getElementById("selectAllDetails").checked = false;
            document.getElementById("productDetailTableBody").innerHTML = "";
            document.getElementById("selectedProductDetailIdsInput").value = "";
            document.getElementById("productSearchInput").value = "";
            document.getElementById("productPagination").innerHTML = "";
        });

        document.getElementById("productSearchInput").addEventListener("input", function () {
            clearTimeout(this._searchTimer);
            const query = this.value.trim();
            this._searchTimer = setTimeout(() => {
                searchProducts(query, 0);
            }, 300);
        });

        document.getElementById("discountForm").addEventListener("submit", saveSelections);
    }

    function initFormState() {
        if (window.location.pathname.includes("/acvstore/chien-dich-giam-gia/create")) {
            clearSelections();
        }
        restoreSelectedProducts();
        attachCheckboxEvents(".product-checkbox", selectedProductIds);
        attachMasterCheckboxEvents();
        initEvents();
        saveSelections();
    }

    document.addEventListener("DOMContentLoaded", initFormState);
    document.getElementById("confirmSubmitBtn").addEventListener("click", function () {
        document.getElementById("discountForm").submit();
    });
</script>
<script th:src="@{/js/notification.js}"></script>

</body>
</html>
