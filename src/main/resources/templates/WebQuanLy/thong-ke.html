<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thống kê tổng quan</title>

  <!-- Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/sidebar.js}" defer></script>

  <style>
    :root{
      --primary:#153054;
      --primary-600:#132a49;
      --primary-700:#10243e;
      --accent:#9FD5F7;
      --ink:#1b2430;
      --muted:#5b6777;
      --surface:#f5f8fc;
      --line:#dbe7f3;
    }

    /* ====== GLOBAL FONT ====== */
    html, body, .content, .card, .table, .btn, .form-control, .navbar {
      font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
      font-weight: 500;
      color: var(--ink);
    }

    /* ====== TITLE ====== */
    .page-title-wrap{
      display:flex;justify-content:center;align-items:center;margin:18px 0 28px 0;
    }
    .page-title{
      font-weight: 800;
      letter-spacing:.3px;
      color: var(--primary);
      display:inline-flex;align-items:center;gap:10px;
      position:relative;padding-bottom:8px;text-transform:uppercase;
    }
    .page-title::after{
      content:""; position:absolute; left:50%; transform:translateX(-50%);
      bottom:-6px; height:4px; width:140px; background:var(--primary); border-radius:4px;
    }
    .page-title i{ color: var(--primary); }

    /* ====== CARDS ====== */
    .card-box {
      background: var(--surface);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--line);
      box-shadow: 0 6px 18px rgba(21,48,84,.06);
    }
    .stat-card {
      background-color:#fff;border-radius:12px;padding:12px 20px;margin:10px 0;
      text-align:center;font-weight:700;border:1px solid var(--line); color: var(--ink);
    }

    /* ====== GROWTH BOX ====== */
    .growth-box {
      background: var(--primary);
      color: #fff;
      border-radius: 12px;
      padding: 10px 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .growth-box i { color:#fff; }
    .growth-percent { color:#2ecc71; font-weight:800; }

    .chart-title {
      font-weight:800; font-size:18px; margin:10px 0; color:var(--primary);
    }

    /* ====== BUTTONS ====== */
    .btn-primary, .btn-warning{
      background-color: var(--primary)!important;
      border-color: var(--primary)!important;
      color:#fff!important;
    }
    .btn-primary:hover, .btn-warning:hover{
      background-color: var(--primary-600)!important;
      border-color: var(--primary-600)!important;
    }
    .btn-outline-secondary{
      border-color: var(--primary);
      color: var(--primary);
    }
    .btn-outline-secondary:hover{
      background-color:#ecf6fd;
      border-color: var(--primary);
      color: var(--primary-700);
    }
    .filter-btn{ transition: all .25s ease; }

    /* ====== LIST & PAGINATION ====== */
    .status-list{ list-style:none; padding:0; }
    .status-list li{ margin-bottom:6px; }
    .pagination .page-item.active .page-link {
      background-color: var(--primary); border-color: var(--primary); color: #fff;
    }
    .pagination .page-item .page-link { color: var(--primary); }
    .pagination .page-item.disabled .page-link { color: #6c757d; }
  </style>
</head>
<body>
<div class="d-flex">
  <div th:replace="~{fragments/sidebar :: sidebar}" class="fixed top-0 left-0 h-full bg-gray-800 text-white w-64"></div>

  <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 fixed top-0 right-0 w-[calc(100%-256px)] d-flex">
    <div class="ms-auto" th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
  </nav>

  <div class="content" id="content">
    <div class="page-title-wrap">
      <h1 class="page-title">
        <i class="fa-solid fa-chart-line"></i>
        Thống kê
      </h1>
    </div>

    <div th:if="${error != null}" class="alert alert-danger" th:text="${error}"></div>
    <div id="filterStatus" class="alert alert-info" th:text="${filterStatus}" th:if="${filterStatus != null}"></div>

    <div class="row text-center mb-4">
      <div class="col-md-4 stat-card">Doanh thu tháng này<br><span class="text-primary" th:with="locale='vi_VN'" th:text="${#numbers.formatInteger(stats.doanhThuThang, 0, 'POINT')} + ' VND'"></span></div>
      <div class="col-md-4 stat-card">Doanh thu hôm nay<br><span class="text-primary" th:with="locale='vi_VN'" th:text="${#numbers.formatInteger(stats.doanhThuNgay, 0, 'POINT')} + ' VND'"></span></div>
      <div class="col-md-4 stat-card">Sản phẩm bán được tháng này<br><span class="text-primary" th:text="${stats.soSanPhamThang}"></span></div>
    </div>
    <div class="row text-center mb-4">
      <div class="col-md-4 stat-card">Tại quầy<br><span class="text-primary" th:text="${tongDonTheoPhuongThuc['Tại quầy'] ?: 0} + ' đơn'"></span></div>
      <div class="col-md-4 stat-card">Giao hàng<br><span class="text-primary" th:text="${tongDonTheoPhuongThuc['Giao hàng'] ?: 0} + ' đơn'"></span></div>
      <div class="col-md-4 stat-card">Online<br><span class="text-primary" th:text="${tongDonTheoPhuongThuc['Online'] ?: 0} + ' đơn'"></span></div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card-box">
          <h5 class="fw-bold mb-3" style="color:var(--primary)">Tốc độ tăng trưởng ✨</h5>
          <div class="growth-box"><span>📅</span> Doanh thu ngày: <span th:with="locale='vi_VN'" th:text="${#numbers.formatInteger(stats.doanhThuNgay, 0, 'POINT')} + ' VND'"></span> <span class="growth-percent"><i class="fa fa-arrow-up"></i> <span th:with="locale='vi_VN'" th:text="${stats.tangTruongNgay % 1 == 0 ? #numbers.formatInteger(stats.tangTruongNgay, 0, 'POINT') + '%' : #numbers.formatDecimal(stats.tangTruongNgay, 1, 'POINT', 1, 'COMMA') + '%'}"></span></span></div>
          <div class="growth-box"><span>📅</span> Doanh thu tháng: <span th:with="locale='vi_VN'" th:text="${#numbers.formatInteger(stats.doanhThuThang, 0, 'POINT')} + ' VND'"></span> <span class="growth-percent"><i class="fa fa-arrow-up"></i> <span th:with="locale='vi_VN'" th:text="${stats.tangTruongThang % 1 == 0 ? #numbers.formatInteger(stats.tangTruongThang, 0, 'POINT') + '%' : #numbers.formatDecimal(stats.tangTruongThang, 1, 'POINT', 1, 'COMMA') + '%'}"></span></span></div>
          <div class="growth-box"><span>📅</span> Doanh thu năm: <span th:with="locale='vi_VN'" th:text="${#numbers.formatInteger(stats.doanhThuNam, 0, 'POINT')} + ' VND'"></span> <span class="growth-percent"><i class="fa fa-arrow-up"></i> <span th:with="locale='vi_VN'" th:text="${stats.tangTruongNam % 1 == 0 ? #numbers.formatInteger(stats.tangTruongNam, 0, 'POINT') + '%' : #numbers.formatDecimal(stats.tangTruongNam, 1, 'POINT', 1, 'COMMA') + '%'}"></span></span></div>
          <div class="growth-box"><span>📦</span> Sản phẩm tháng: <span th:text="${stats.soSanPhamThang}"></span> <span class="growth-percent"><i class="fa fa-arrow-up"></i> <span th:with="locale='vi_VN'" th:text="${stats.tangTruongSanPhamThang % 1 == 0 ? #numbers.formatInteger(stats.tangTruongSanPhamThang, 0, 'POINT') + '%' : #numbers.formatDecimal(stats.tangTruongSanPhamThang, 1, 'POINT', 1, 'COMMA') + '%'}"></span></span></div>
          <div class="growth-box"><span>🧾</span> Hóa đơn ngày: <span th:text="${stats.soDonHangNgay}"></span> <span class="growth-percent"><i class="fa fa-arrow-up"></i> <span th:with="locale='vi_VN'" th:text="${stats.tangTruongNgay % 1 == 0 ? #numbers.formatInteger(stats.tangTruongNgay, 0, 'POINT') + '%' : #numbers.formatDecimal(stats.tangTruongNgay, 1, 'POINT', 1, 'COMMA') + '%'}"></span></span></div>
          <div class="growth-box"><span>🧾</span> Hóa đơn tháng: <span th:text="${stats.soDonHangThang}"></span> <span class="growth-percent"><i class="fa fa-arrow-up"></i> <span th:with="locale='vi_VN'" th:text="${stats.tangTruongThang % 1 == 0 ? #numbers.formatInteger(stats.tangTruongThang, 0, 'POINT') + '%' : #numbers.formatDecimal(stats.tangTruongThang, 1, 'POINT', 1, 'COMMA') + '%'}"></span></span></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card-box">
          <h5 class="fw-bold mb-3" style="color:var(--primary)">Trạng thái đơn hàng</h5>
          <div class="row">
            <div class="col-md-6">
              <ul class="status-list">
                <li th:each="entry : ${trangThaiPercentMap}">
                  <span th:text="${entry.key} + ': '"></span>
                  <span th:text="${entry.value % 1 == 0 ? #numbers.formatInteger(entry.value, 0, 'POINT') + '%' : #numbers.formatDecimal(entry.value, 1, 'POINT', 1, 'COMMA') + '%'}"></span>
                </li>
              </ul>
            </div>
            <div class="col-md-6">
              <canvas id="pieChart" height="230"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <button class="btn btn-outline-secondary" onclick="exportExcel()">📥 Excel</button>
          <button class="btn btn-outline-secondary">Bộ lọc</button>
        </div>
        <div>
          <button class="btn btn-outline-secondary filter-btn" data-filter="day" onclick="submitFilter('day')">Ngày</button>
          <button class="btn btn-outline-secondary filter-btn" data-filter="7days" onclick="submitFilter('7days')">7 Ngày</button>
          <button class="btn btn-outline-secondary filter-btn" data-filter="month" onclick="submitFilter('month')">Tháng</button>
          <button class="btn btn-outline-secondary filter-btn" data-filter="year" onclick="submitFilter('year')">Năm</button>
          <button class="btn btn-outline-secondary filter-btn" data-filter="custom_range" onclick="showCustomRange()">Tuỳ chỉnh</button>
        </div>
      </div>

      <div id="customRange" style="display: none;">
        <div class="row">
          <div class="col-md-6">
            <label for="startDatePicker" class="form-label">Ngày bắt đầu:</label>
            <input type="text" id="startDatePicker" class="form-control" placeholder="Chọn ngày bắt đầu">
          </div>
          <div class="col-md-6">
            <label for="endDatePicker" class="form-label">Ngày kết thúc:</label>
            <input type="text" id="endDatePicker" class="form-control" placeholder="Chọn ngày kết thúc">
          </div>
        </div>
        <button class="btn btn-primary mt-3" onclick="applyCustomRange()">Áp dụng</button>
        <button class="btn btn-outline-secondary mt-3" onclick="document.getElementById('customRange').style.display='none'">Hủy</button>
      </div>

      <div class="chart-title">Biểu đồ Doanh thu & Số hóa đơn</div>
      <canvas id="chart" height="150"></canvas>
    </div>

    <div class="row">
      <!-- Sắp Hết Hàng -->
      <div class="col-md-6">
        <div class="card-box">
          <h5 class="fw-bold mb-3" style="color:var(--primary)">Sản Phẩm Sắp Hết Hàng</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-hover text-center">
              <thead style="background-color:#ffe9e9;">
              <tr><th>STT</th><th>Ảnh</th><th>Tên Sản Phẩm</th><th>Giá Bán</th><th>Tồn Kho</th></tr>
              </thead>
              <tbody>
              <tr th:each="item, stat : ${lowStockProducts.content}">
                <td th:text="${stat.index + 1 + lowStockProducts.number * lowStockProducts.size}">1</td>
                <td>
                  <img th:if="${item.imageUrl != null}"
                       th:src="${item.imageUrl}"
                       style="height: 60px;"
                       alt="ảnh"/>
                </td>
                <td><div th:text="${item.tenSanPham}"></div><small th:text="'Màu: ' + ${item.mauSac} + ', Size: ' + ${item.kichCo}"></small></td>
                <td th:with="locale='vi_VN'" th:text="${#numbers.formatInteger(item.gia, 0, 'POINT')} + ' VND'"></td>
                <td th:text="${item.soLuongTonKho}"></td>
              </tr>
              <tr th:if="${lowStockProducts == null or lowStockProducts.isEmpty()}">
                <td colspan="5">Không có sản phẩm sắp hết hàng.</td>
              </tr>
              </tbody>
            </table>
          </div>

          <!-- LUÔN hiển thị pagination nếu có dữ liệu -->
          <nav aria-label="Low Stock Products navigation"
               th:if="${lowStockProducts != null and not #lists.isEmpty(lowStockProducts.content)}">
            <ul class="pagination justify-content-center">
              <li class="page-item" th:classappend="${lowStockProducts.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     topSellingPage=${topSellingPage},
                     lowStockPage=${0}
                   )}">«</a>
              </li>
              <li class="page-item" th:classappend="${lowStockProducts.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     topSellingPage=${topSellingPage},
                     lowStockPage=${lowStockProducts.number - 1}
                   )}">Trước</a>
              </li>
              <li th:each="i : ${#numbers.sequence(0, lowStockProducts.totalPages - 1)}"
                  class="page-item" th:classappend="${i == lowStockProducts.number} ? 'active'">
                <a class="page-link"
                   th:text="${i + 1}"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     topSellingPage=${topSellingPage},
                     lowStockPage=${i}
                   )}"></a>
              </li>
              <li class="page-item" th:classappend="${lowStockProducts.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     topSellingPage=${topSellingPage},
                     lowStockPage=${lowStockProducts.number + 1}
                   )}">Sau</a>
              </li>
              <li class="page-item" th:classappend="${lowStockProducts.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     topSellingPage=${topSellingPage},
                     lowStockPage=${lowStockProducts.totalPages - 1}
                   )}">»</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>

      <!-- Top Bán Chạy -->
      <div class="col-md-6">
        <div class="card-box">
          <h5 class="fw-bold mb-3" style="color:var(--primary)">Top Sản Phẩm Bán Chạy</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-hover text-center">
              <thead style="background-color:#fef6dd;">
              <tr><th>STT</th><th>Ảnh</th><th>Tên Sản Phẩm</th><th>Giá Bán</th><th>Số lượng đã bán</th></tr>
              </thead>
              <tbody>
              <tr th:each="item, stat : ${topSellingProducts.content}">
                <td th:text="${stat.index + 1 + topSellingProducts.number * topSellingProducts.size}">1</td>
                <td>
                  <img th:if="${item.imageUrl != null}"
                       th:src="${item.imageUrl}"
                       style="height: 60px;"
                       alt="ảnh"/>
                </td>
                <td><div th:text="${item.tenSanPham}"></div><small th:text="'Màu: ' + ${item.mauSac} + ', Size: ' + ${item.kichCo}"></small></td>
                <td th:with="locale='vi_VN'" th:text="${#numbers.formatInteger(item.gia, 0, 'POINT')} + ' VND'"></td>
                <td th:text="${item.soLuongDaBan}"></td>
              </tr>
              <tr th:if="${topSellingProducts == null or topSellingProducts.isEmpty()}">
                <td colspan="5">Không có dữ liệu.</td>
              </tr>
              </tbody>
            </table>
          </div>

          <!-- LUÔN hiển thị pagination nếu có dữ liệu -->
          <nav aria-label="Top Selling Products navigation"
               th:if="${topSellingProducts != null and not #lists.isEmpty(topSellingProducts.content)}">
            <ul class="pagination justify-content-center">
              <li class="page-item" th:classappend="${topSellingProducts.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     lowStockPage=${lowStockPage},
                     topSellingPage=${0}
                   )}">«</a>
              </li>
              <li class="page-item" th:classappend="${topSellingProducts.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     lowStockPage=${lowStockPage},
                     topSellingPage=${topSellingProducts.number - 1}
                   )}">Trước</a>
              </li>
              <li th:each="i : ${#numbers.sequence(0, topSellingProducts.totalPages - 1)}"
                  class="page-item" th:classappend="${i == topSellingProducts.number} ? 'active'">
                <a class="page-link"
                   th:text="${i + 1}"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     lowStockPage=${lowStockPage},
                     topSellingPage=${i}
                   )}"></a>
              </li>
              <li class="page-item" th:classappend="${topSellingProducts.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     lowStockPage=${lowStockPage},
                     topSellingPage=${topSellingProducts.number + 1}
                   )}">Sau</a>
              </li>
              <li class="page-item" th:classappend="${topSellingProducts.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/acvstore/thong-ke(
                     boLoc=${boLoc},
                     ngayBatDau=${ngayBatDau},
                     ngayKetThuc=${ngayKetThuc},
                     lowStockPage=${lowStockPage},
                     topSellingPage=${topSellingProducts.totalPages - 1}
                   )}">»</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  const labels = /*[[${chartLabels}]]*/ [];
  const chartOrders = /*[[${chartOrders}]]*/ [];
  const chartRevenue = /*[[${chartRevenue}]]*/ [];

  const fmtVND = (v) => (v ?? 0).toLocaleString('vi-VN');

  const ctx = document.getElementById('chart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Doanh thu (VND)',
          data: chartRevenue,
          yAxisID: 'yRevenue',
          tension: 0.35,
          borderColor: '#153054',
          backgroundColor: 'rgba(153, 64, 84, 0)', /* no fill override */
          fill: true,
          pointRadius: 3
        },
        {
          label: 'Số hóa đơn',
          data: chartOrders,
          yAxisID: 'yCount',
          tension: 0.35,
          borderColor: '#9FD5F7',
          backgroundColor: 'rgba(159,213,247,0.15)',
          fill: false,
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 14, font: { size: 12 } } },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const v = ctx.parsed.y;
              return ctx.dataset.yAxisID === 'yRevenue'
                      ? `${ctx.dataset.label}: ${fmtVND(v)} VND`
                      : `${ctx.dataset.label}: ${v}`;
            }
          }
        }
      },
      scales: {
        x: { title: { display: true, text: 'Thời gian' } },
        yCount: { type: 'linear', position: 'left', beginAtZero: true, title: { display: true, text: 'Số hóa đơn' } },
        yRevenue: {
          type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false },
          title: { display: true, text: 'Doanh thu (VND)' },
          ticks: { callback: (value) => fmtVND(value) }
        }
      }
    }
  });
</script>

<script th:inline="javascript">
  const pieCtx = document.getElementById('pieChart').getContext('2d');

  const pieLabels = [[${trangThaiPercentMap.keySet()}]];
  const pieValues = [[${trangThaiPercentMap.values()}]];

  const backgroundColors = [
    '#153054','#1b426d','#225387','#2b66a4',
    '#377cc9','#4695e9','#6ab0f0','#8bc2f4',
    '#a9d4f8','#cbe6fb'
  ];

  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: pieLabels,
      datasets: [{
        data: pieValues,
        backgroundColor: backgroundColors.slice(0, pieLabels.length),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'Tỷ lệ trạng thái đơn hàng', font: { size: 16 } },
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12, padding: 10,
            generateLabels: function(chart) {
              const data = chart.data;
              return data.labels.map((label, i) => ({
                text: label + ': ' + ((data.datasets[0].data[i] ?? 0).toFixed ? (data.datasets[0].data[i] ?? 0).toFixed(1) : data.datasets[0].data[i] + '%'),
                fillStyle: data.datasets[0].backgroundColor[i],
                hidden: isNaN(data.datasets[0].data[i]) || data.datasets[0].data[i] === null,
                index: i
              }));
            }
          }
        }
      }
    }
  });
</script>

<form id="filterForm" method="get" th:action="@{/acvstore/thong-ke}" style="display: none;">
  <input type="hidden" name="boLoc" id="filterInput">
  <input type="hidden" name="ngayBatDau" id="startDateInput">
  <input type="hidden" name="ngayKetThuc" id="endDateInput">
  <input type="hidden" name="topSellingPage" id="topSellingPageInput" th:value="${topSellingPage}">
  <input type="hidden" name="lowStockPage" id="lowStockPageInput" th:value="${lowStockPage}">
</form>

<script>
  flatpickr("#startDatePicker", { dateFormat: "Y-m-d", defaultDate: new Date() });
  flatpickr("#endDatePicker", { dateFormat: "Y-m-d", defaultDate: new Date() });

  function highlightFilterButton(selectedFilter) {
    const buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(button => {
      if (button.getAttribute('data-filter') === selectedFilter) {
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-warning'); // dùng màu chủ đạo
      } else {
        button.classList.remove('btn-warning');
        button.classList.add('btn-outline-secondary');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const currentFilter = urlParams.get('boLoc');
    if (currentFilter) highlightFilterButton(currentFilter);
  });

  function showCustomRange() {
    document.getElementById('customRange').style.display = 'block';
  }

  function applyCustomRange() {
    const startDate = document.getElementById('startDatePicker').value;
    const endDate = document.getElementById('endDatePicker').value;
    if (!startDate || !endDate) { alert("Vui lòng chọn cả ngày bắt đầu và ngày kết thúc."); return; }
    if (startDate > endDate) { alert("Ngày bắt đầu phải nhỏ hơn hoặc bằng ngày kết thúc."); return; }
    document.getElementById('startDateInput').value = startDate;
    document.getElementById('endDateInput').value = endDate;
    document.getElementById('filterInput').value = 'custom_range';
    document.getElementById('customRange').style.display = 'none';
    highlightFilterButton('custom_range');
    document.getElementById('filterForm').submit();
  }

  function submitFilter(type) {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();

    document.getElementById('filterInput').value = type;
    document.getElementById('startDateInput').value = '';
    document.getElementById('endDateInput').value = '';

    if (type === 'day') {
      const dateStr = `${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
      document.getElementById('startDateInput').value = dateStr;
      document.getElementById('endDateInput').value = dateStr;
    } else if (type === '7days') {
      const startDate = new Date(today); startDate.setDate(today.getDate() - 6);
      const startDateStr = `${startDate.getFullYear()}-${(startDate.getMonth()+1).toString().padStart(2,'0')}-${startDate.getDate().toString().padStart(2,'0')}`;
      const endDateStr = `${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
      document.getElementById('startDateInput').value = startDateStr;
      document.getElementById('endDateInput').value = endDateStr;
    } else if (type === 'month') {
      const startDateStr = `${year}-${month.toString().padStart(2,'0')}-01`;
      const endDateStr = `${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
      document.getElementById('startDateInput').value = startDateStr;
      document.getElementById('endDateInput').value = endDateStr;
    } else if (type === 'year') {
      const startDateStr = `${year}-01-01`;
      const endDateStr = `${year}-${month.toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
      document.getElementById('startDateInput').value = startDateStr;
      document.getElementById('endDateInput').value = endDateStr;
    }

    highlightFilterButton(type);
    document.getElementById('filterForm').submit();
  }

  function exportExcel() {
    window.location.href = '/acvstore/thong-ke/export?' + new URLSearchParams(new FormData(document.getElementById('filterForm'))).toString();
  }
</script>

<script th:src="@{/js/notification.js}"></script>
</body>
</html>
